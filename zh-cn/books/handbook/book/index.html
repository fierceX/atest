<!DOCTYPE html>
<html class="theme-light" lang="zh-cn">
  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="A constantly evolving, comprehensive resource for FreeBSD users"/>
  <meta name="keywords" content="91, 34, 70, 114, 101, 101, 66, 83, 68, 32, 72, 97, 110, 100, 98, 111, 111, 107, 34, 44, 32, 34, 72, 97, 110, 100, 98, 111, 111, 107, 34, 93"/>
  <meta name="copyright" content="1995-2023 The FreeBSD Foundation" />
  <link rel="canonical" href="https://free.bsd-doc.org/zh-cn/books/handbook/book/" />

  <title>FreeBSD Handbook |  FreeBSD Documentation Portal</title>

  <meta name="theme-color" content="#790000">
  <meta name="color-scheme" content="system light dark high-contrast">

    <link rel="shortcut icon" href="https://free.bsd-doc.org/favicon.ico">
    <link rel="stylesheet" href="/styles/main.min.css">
    <link rel="stylesheet" href="https://free.bsd-doc.org/css/font-awesome-min.css">
    <script defer src="/js/theme-chooser.min.js"></script>
    <script defer src="/js/copy-clipboard.min.js"></script>
    <script defer src="/js/search.min.js"></script>

  
  
    <meta name="twitter:card" content="summary"/>
    <meta name="twitter:domain" content="docs.FreeBSD.org"/>
    <meta name="twitter:site" content="@freebsd"/>
    <meta name="twitter:url" content="https://twitter.com/freebsd"/>
    <meta property="og:title" content="FreeBSD Handbook" />
    <meta property="og:description" content="A constantly evolving, comprehensive resource for FreeBSD users" />
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="https://free.bsd-doc.orgfavicon.ico"/>
    <meta property="og:image:alt" content="FreeBSD Logo">
    <meta property="og:locale" content="zh-cn" />
    <meta property="og:url" content="https://free.bsd-doc.org/zh-cn/books/handbook/book/" />
    <meta property="og:site_name" content="FreeBSD Documentation Portal" />
    <script type="application/ld+json">
      {
        "@context": "http://schema.org",
        "@type": "Article",
        "url": "https:\/\/free.bsd-doc.org\/zh-cn\/books\/handbook\/book\/",
        "name": "FreeBSD Documentation Portal",
        "headline": "FreeBSD Documentation Portal",
        "description": "FreeBSD Documentation Portal"
      }
    </script>
    

  
</head>


  <body>
    <header>
  <div class="header-container">
    <div class="logo-menu-bars-container">
      <a href="https://free.bsd-doc.org" class="logo">
        <img src="https://free.bsd-doc.org/images/FreeBSD-monochromatic.svg" width="160" height="50" alt="FreeBSD logo" />
      </a>
      <label class="menu-bars" for="menu-bars">
        <i class="fa fa-bars" aria-hidden="true"></i>
      </label>
    </div>
    <input id="menu-bars" type="checkbox" />
    
    <div class="search-donate-container">
      
      <div class="donate">
        <a href="https://github.com/fierceX/freebsd-doc-cn" target="_blank">
          <span class="heart">♥</span>
          GitHub
        </a>
      </div>
    </div>
  </div>
</header>

    
<input type="checkbox" class="hidden toggle" id="menu-control">
<main class="main-wrapper-book">
  <a id="top"></a>
  
  <div class="book">
    
    <h1 class="title">FreeBSD Handbook</h1>
    
    
      <div class="admonitionblock note">
        <p>
          <i class="fa fa-exclamation-circle" aria-hidden="true"></i>
          如果发现翻译错误，请直接 <a href="https://github.com/fierceX/freebsd-doc-cn/pulls" target="_blank">发起PR修改</a>。
        </p>
      </div>
    
    
      <div class="copyright">
        Copyright © 1995-2023 The FreeBSD Documentation Project
      </div>
    
    
      <div class="legalnotice">
  <a id="trademarks"></a>
  <details>
    <summary>trademarks</summary>
    

    
      <p>FreeBSD 是 FreeBSD 基金会的注册商标</p>
    

    

    

    
      <p>IBM、 AIX、 OS/2、 PowerPC、 PS/2、 S/390 以及 ThinkPad 是国际商用机器公司在美国和其他国家的注册商标或商标。</p>
    

    
      <p>IEEE, POSIX, 和 802 是 Institute of Electrical and Electronics Engineers, Inc. 在美国的注册商标。</p>
    

    
      <p>Red Hat, RPM, 是 Red Hat, Inc. 在美国和其他国家的注册商标。</p>
    

    
      <p>3Com 和 HomeConnect 是 3Com Corporation 的注册商标。</p>
    

    

    
      <p>Adobe、 Acrobat、 Acrobat Reader、 Flash， 以及 PostScript 是 Adobe Systems Incorporated 在美国和/或其他国家的商标或注册商标。</p>
    

    
      <p>Apple, AirPort, FireWire, iMac, iPhone, iPad, Mac, Macintosh, Mac OS, Quicktime, 以及 TrueType 是 Apple Inc. 在美国以及其他国家的注册商标。</p>
    

    

    

    

    
      <p>Intel, Celeron, Centrino, Core, EtherExpress, i386, i486, Itanium, Pentium, 和 Xeon 是 Intel Corporation 及其分支机构在美国和其他国家的商标或注册商标。</p>
    

    
      <p>Linux 是 Linus Torvalds 的注册商标。</p>
    

    
      <p>Microsoft, IntelliMouse, MS-DOS, Outlook, Windows, Windows Media, 和 Windows NT 是 Microsoft Corporation 在美国和/或其他国家的商标或注册商标。</p>
    

    

    

    
      <p>Motif, OSF/1, 和 UNIX 是 The Open Group 在美国和其他国家的注册商标； IT DialTone 和 The Open Group 是其商标。</p>
    

    

    

    
      <p>Sun、 Sun Microsystems、 Java、 Java Virtual Machine、 JDK、 JRE、 JSP、 JVM、 Netra、 OpenJDK、 Solaris、 StarOffice、 SunOS 以及 VirtualBox 是 Sun Microsystems, Inc. 在美国和其他国家的商标或注册商标。</p>
    

    

    

    
      <p>RealNetworks, RealPlayer, 和 RealAudio 是 RealNetworks, Inc. 的注册商标。</p>
    

    
      <p>Oracle 是 Oracle Corporation 的注册商标。</p>
    

    
      <p>3ware 是 3ware Inc 的注册商标。</p>
    

    
      <p>ARM 是 ARM Limited. 的注册商标。</p>
    

    
      <p>Adaptec 是 Adaptec, Inc. 的注册商标。</p>
    

    
      <p>Android 是 Google Inc 的注册商标。</p>
    

    
      <p>Heidelberg、 Helvetica、 Palatino 以及 Times Roman 是 Heidelberger Druckmaschinen AG 在美国和其他国家的商标或注册商标。</p>
    

    
      <p>Intuit 和 Quicken 是 Intuit Inc., 或其子公司在美国和其他国家的商标或注册商标。</p>
    

    
      <p>LSI Logic, AcceleRAID, eXtremeRAID, MegaRAID 和 Mylex 是 LSI Logic Corp 的商标或注册商标。</p>
    

    
      <p>MATLAB 是 The MathWorks, Inc. 的注册商标。</p>
    

    
      <p>SpeedTouch 是 Thomson 的商标。</p>
    

    
      <p>VMware 是 VMware, Inc. 的商标</p>
    

    
      <p>Mathematica 是 Wolfram Research, Inc 的注册商标。</p>
    

    
      <p>Ogg Vorbis 和 Xiph.Org 是 Xiph.Org 的商标。</p>
    

    
      <p>XFree86 是 The XFree86 Project, Inc 的商标。.</p>
    

    

    
      <p>许多制造商和经销商使用一些称为商标的图案或文字设计来彰显自己的产品。 本文档中出现的， 为 FreeBSD Project 所知晓的商标，后面将以 “™” 或 “®” 符号来标注。</p>
    
  </details>
</div>


    
    <div class="toc-mobile">
      <h3>Table of Contents</h3>
      <nav id="TableOfContents">
  <ul>
    <li><a href="#book-preface">Preface</a>
      <ul>
        <li><a href="#preface-audience">Intended Audience</a></li>
        <li><a href="#preface-changes-from4">Fourth Edition</a></li>
        <li><a href="#preface-changes-from3">Third Edition</a></li>
        <li><a href="#preface-changes-from2">Second Edition (2004)</a></li>
        <li><a href="#preface-changes">First Edition (2001)</a></li>
        <li><a href="#preface-overview">Organization of This Book</a></li>
        <li><a href="#preface-conv">Conventions used in this book</a></li>
        <li><a href="#preface-acknowledgements">Acknowledgments</a></li>
      </ul>
    </li>
    <li><a href="#getting-started">Part I: 入门指南</a>
      <ul>
        <li><a href="#introduction">Chapter 1. 介绍</a></li>
        <li><a href="#bsdinstall">Chapter 2. 安装 FreeBSD</a></li>
        <li><a href="#basics">Chapter 3. FreeBSD 基础知识</a></li>
        <li><a href="#ports">Chapter 4. 安装应用程序：软件包和 Ports</a></li>
        <li><a href="#x11">Chapter 5. The X Window System</a></li>
        <li><a href="#wayland">Chapter 6. Wayland on FreeBSD</a></li>
        <li><a href="#network">Chapter 7. Network</a></li>
      </ul>
    </li>
    <li><a href="#common-tasks">Part II: 常见任务</a>
      <ul>
        <li><a href="#desktop">Chapter 8. Desktop Environments</a></li>
        <li><a href="#multimedia">Chapter 9. Multimedia</a></li>
        <li><a href="#kernelconfig">Chapter 10. Configuring the FreeBSD Kernel</a></li>
        <li><a href="#printing">Chapter 11. Printing</a></li>
        <li><a href="#linuxemu">Chapter 12. Linux Binary Compatibility</a></li>
        <li><a href="#wine">Chapter 13. WINE</a></li>
      </ul>
    </li>
    <li><a href="#system-administration">Part III: 系统管理</a>
      <ul>
        <li><a href="#config-tuning">Chapter 14. Configuration, Services, Logging and Power Management</a></li>
        <li><a href="#boot">Chapter 15. The FreeBSD Booting Process</a></li>
        <li><a href="#security">Chapter 16. Security</a></li>
        <li><a href="#jails">Chapter 17. Jails and Containers</a></li>
        <li><a href="#mac">Chapter 18. Mandatory Access Control</a></li>
        <li><a href="#audit">Chapter 19. Security Event Auditing</a></li>
        <li><a href="#disks">Chapter 20. Storage</a></li>
        <li><a href="#geom">Chapter 21. GEOM: Modular Disk Transformation Framework</a></li>
        <li><a href="#zfs">Chapter 22. The Z File System (ZFS)</a></li>
        <li><a href="#filesystems">Chapter 23. Other File Systems</a></li>
        <li><a href="#virtualization">Chapter 24. Virtualization</a></li>
        <li><a href="#l10n">Chapter 25. Localization - i18n/L10n Usage and Setup</a></li>
        <li><a href="#updating-upgrading">Chapter 26. Updating and Upgrading FreeBSD</a></li>
        <li><a href="#dtrace">Chapter 27. DTrace</a></li>
        <li><a href="#usb-device-mode">Chapter 28. USB Device Mode / USB OTG</a></li>
      </ul>
    </li>
    <li><a href="#network-communication">Part IV: 网络通信</a>
      <ul>
        <li><a href="#serialcomms">Chapter 29. Serial Communications</a></li>
        <li><a href="#ppp-and-slip">Chapter 30. PPP</a></li>
        <li><a href="#mail">Chapter 31. Electronic Mail</a></li>
        <li><a href="#network-servers">Chapter 32. Network Servers</a></li>
        <li><a href="#firewalls">Chapter 33. Firewalls</a></li>
        <li><a href="#advanced-networking">Chapter 34. Advanced Networking</a></li>
      </ul>
    </li>
    <li><a href="#appendices">Part V: 附录</a>
      <ul>
        <li><a href="#_obtaining_freebsd">附录 A: Obtaining FreeBSD</a></li>
        <li><a href="#bibliography">附录 B: Bibliography</a></li>
        <li><a href="#eresources">附录 C: Resources on the Internet</a></li>
        <li><a href="#pgpkeys">附录 D: OpenPGP Keys</a></li>
        <li><a href="#freebsd-glossary">FreeBSD Glossary</a></li>
        <li><a href="#colophon">Colophon</a></li>
      </ul>
    </li>
  </ul>
</nav>
    </div>
    
      
      <div>
        [ <a href="../">Split HTML</a> / Single HTML ]
      </div>
      
      
    
    <div class="book-content">
      <div id="preamble">
<div class="sectionbody">
<div class="paragraph abstract-title">
<p>Abstract</p>
</div>
<div class="paragraph">
<p>Welcome to FreeBSD! This handbook covers the installation and day to day use of <em>FreeBSD 14.0-RELEASE, 13.2-RELEASE</em> and <em>FreeBSD 12.4-RELEASE</em>. This book is the result of ongoing work by many individuals. Some sections might be outdated. Those interested in helping to update and expand this document should send email to the {freebsd-doc}.</p>
</div>
<div class="paragraph">
<p>The latest version of this book is available from the <a href="https://www.FreeBSD.org/">FreeBSD web site</a>. Previous versions can be obtained from <a href="https://docs.FreeBSD.org/doc/">https://docs.FreeBSD.org/doc/</a>. The book can be downloaded in a variety of formats and compression options from the <a href="https://download.freebsd.org/doc/">FreeBSD download server</a> or one of the numerous <a href="./mirrors#mirrors">mirror sites</a>. Searches can be performed on the handbook and other documents on the <a href="https://www.FreeBSD.org/search/">search page</a>.</p>
</div>
<hr/>

</div>
</div>
<div class="sect1">
<h2 id="book-preface">Preface<a class="anchor" href="#book-preface"></a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="preface-audience">Intended Audience<a class="anchor" href="#preface-audience"></a></h3>
<div class="paragraph">
<p>The FreeBSD newcomer will find that the first section of this book guides the user through the FreeBSD installation process and gently introduces the concepts and conventions that underpin UNIX®. Working through this section requires little more than the desire to explore, and the ability to take on board new concepts as they are introduced.</p>
</div>
<div class="paragraph">
<p>Once you have traveled this far, the second, far larger, section of the Handbook is a comprehensive reference to all manner of topics of interest to FreeBSD system administrators. Some of these chapters may recommend that you do some prior reading, and this is noted in the synopsis at the beginning of each chapter.</p>
</div>
<div class="paragraph">
<p>For a list of additional sources of information, please see <a href="./#bibliography">Bibliography</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="preface-changes-from4">Fourth Edition<a class="anchor" href="#preface-changes-from4"></a></h3>
<div class="paragraph">
<p>The current version of the Handbook represents the cumulative effort of a working group that has been reviewing and updating all Handbook content. These are the major updates since the fourth edition of the Handbook.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The Handbook has been converted from <a href="https://docbook.org/">Docbook</a> to <a href="https://gohugo.io/">Hugo</a> and <a href="https://asciidoctor.org/">AsciiDoctor</a></p>
</li>
<li>
<p>The <a href="https://docs.FreeBSD.org">FreeBSD Documentation Portal</a> has been created.</p>
</li>
<li>
<p><a href="./#wayland">Wayland</a> has been added with information about installing and configuring Wayland under FreeBSD.</p>
</li>
<li>
<p>The <a href="./#bibliography">Bibliography</a> has been extensively updated.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="preface-changes-from3">Third Edition<a class="anchor" href="#preface-changes-from3"></a></h3>
<div class="paragraph">
<p>The current online version of the Handbook represents the cumulative effort of many hundreds of contributors over the past 10 years. The following are some of the significant changes since the two volume third edition was published in 2004:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="./#wine">WINE</a> has been added with information about how to run Windows® applications on FreeBSD.</p>
</li>
<li>
<p><a href="./#dtrace">DTrace</a> has been added with information about the powerful DTrace performance analysis tool.</p>
</li>
<li>
<p><a href="./#filesystems">Other File Systems</a> have been added with information about non-native file systems in FreeBSD, such as ZFS from Sun™.</p>
</li>
<li>
<p><a href="./#audit">Security Event Auditing</a> has been added to cover the new auditing capabilities in FreeBSD and explain its use.</p>
</li>
<li>
<p><a href="./#virtualization">Virtualization</a> has been added with information about installing FreeBSD on virtualization software.</p>
</li>
<li>
<p><a href="./#bsdinstall">Installing FreeBSD</a> has been added to cover installation of FreeBSD using the new installation utility, bsdinstall.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="preface-changes-from2">Second Edition (2004)<a class="anchor" href="#preface-changes-from2"></a></h3>
<div class="paragraph">
<p>The third edition was the culmination of over two years of work by the dedicated members of the FreeBSD Documentation Project. The printed edition grew to such a size that it was necessary to publish as two separate volumes. The following are the major changes in this new edition:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="./#config-tuning">Configuration and Tuning</a> has been expanded with new information about the ACPI power and resource management, the <code>cron</code> system utility, and more kernel tuning options.</p>
</li>
<li>
<p><a href="./#security">Security</a> has been expanded with new information about virtual private networks (VPNs), file system access control lists (ACLs), and security advisories.</p>
</li>
<li>
<p><a href="./#mac">Mandatory Access Control</a> is a new chapter with this edition. It explains what MAC is and how this mechanism can be used to secure a FreeBSD system.</p>
</li>
<li>
<p><a href="./#disks">Storage</a> has been expanded with new information about USB storage devices, file system snapshots, file system quotas, file and network backed filesystems, and encrypted disk partitions.</p>
</li>
<li>
<p>A troubleshooting section has been added to <a href="./#ppp-and-slip">PPP</a>.</p>
</li>
<li>
<p><a href="./#mail">Electronic Mail</a> has been expanded with new information about using alternative transport agents, SMTP authentication, UUCP, fetchmail, procmail, and other advanced topics.</p>
</li>
<li>
<p><a href="./#network-servers">Network Servers</a> is all new with this edition. This chapter includes information about setting up the Apache HTTP Server, ftpd, and setting up a server for Microsoft® Windows® clients with Samba. Some sections from <a href="./#advanced-networking">Advanced Networking</a> were moved here to improve the presentation.</p>
</li>
<li>
<p><a href="./#advanced-networking">Advanced Networking</a> has been expanded with new information about using Bluetooth® devices with FreeBSD, setting up wireless networks, and Asynchronous Transfer Mode (ATM) networking.</p>
</li>
<li>
<p>A glossary has been added to provide a central location for the definitions of technical terms used throughout the book.</p>
</li>
<li>
<p>A number of aesthetic improvements have been made to the tables and figures throughout the book.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="preface-changes">First Edition (2001)<a class="anchor" href="#preface-changes"></a></h3>
<div class="paragraph">
<p>The second edition was the culmination of over two years of work by the dedicated members of the FreeBSD Documentation Project. The following were the major changes in this edition:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A complete Index has been added.</p>
</li>
<li>
<p>All ASCII figures have been replaced by graphical diagrams.</p>
</li>
<li>
<p>A standard synopsis has been added to each chapter to give a quick summary of what information the chapter contains, and what the reader is expected to know.</p>
</li>
<li>
<p>The content has been logically reorganized into three parts: &#34;Getting Started&#34;, &#34;System Administration&#34;, and &#34;Appendices&#34;.</p>
</li>
<li>
<p><a href="./#basics">FreeBSD Basics</a> has been expanded to contain additional information about processes, daemons, and signals.</p>
</li>
<li>
<p><a href="./#ports">Installing Applications: Packages and Ports</a> has been expanded to contain additional information about binary package management.</p>
</li>
<li>
<p><a href="./#x11">The X Window System</a> has been completely rewritten with an emphasis on using modern desktop technologies such as KDE and GNOME on XFree86™ 4.X.</p>
</li>
<li>
<p><a href="./#boot">The FreeBSD Booting Process</a> has been expanded.</p>
</li>
<li>
<p><a href="./#disks">Storage</a> has been written from what used to be two separate chapters on &#34;Disks&#34; and &#34;Backups&#34;. We feel that the topics are easier to comprehend when presented as a single chapter. A section on RAID (both hardware and software) has also been added.</p>
</li>
<li>
<p><a href="./#serialcomms">Serial Communications</a> has been completely reorganized and updated for FreeBSD 4.X/5.X.</p>
</li>
<li>
<p><a href="./#ppp-and-slip">PPP</a> has been substantially updated.</p>
</li>
<li>
<p>Many new sections have been added to <a href="./#advanced-networking">Advanced Networking</a>.</p>
</li>
<li>
<p><a href="./#mail">Electronic Mail</a> has been expanded to include more information about configuring sendmail.</p>
</li>
<li>
<p><a href="./#linuxemu">Linux® Binary Compatibility</a> has been expanded to include information about installing Oracle® and SAP® R/3®.</p>
</li>
<li>
<p>The following new topics are covered in this second edition:</p>
<div class="ulist">
<ul>
<li>
<p><a href="./#config-tuning">Configuration and Tuning</a>.</p>
</li>
<li>
<p><a href="./#multimedia">Multimedia</a>.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="preface-overview">Organization of This Book<a class="anchor" href="#preface-overview"></a></h3>
<div class="paragraph">
<p>This book is split into five logically distinct sections. The first section, <em>Getting Started</em>, covers the installation and basic usage of FreeBSD. It is expected that the reader will follow these chapters in sequence, possibly skipping chapters covering familiar topics. The second section, <em>Common Tasks</em>, covers some frequently used features of FreeBSD. This section, and all subsequent sections, can be read out of order. Each chapter begins with a succinct synopsis that describes what the chapter covers and what the reader is expected to already know. This is meant to allow the casual reader to skip around to find chapters of interest. The third section, <em>System Administration</em>, covers administration topics. The fourth section, <em>Network Communication</em>, covers networking and server topics. The fifth section contains appendices of reference information.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><em><a href="./#introduction">Introduction</a></em></dt>
<dd>
<p>Introduces FreeBSD to a new user. It describes the history of the FreeBSD Project, its goals and development model.</p>
</dd>
<dt class="hdlist1"><em><a href="./#bsdinstall">Installing FreeBSD</a></em></dt>
<dd>
<p>Walks a user through the entire installation process of FreeBSD 9.<em>x</em> and later using bsdinstall.</p>
</dd>
<dt class="hdlist1"><em><a href="./#basics">FreeBSD Basics</a></em></dt>
<dd>
<p>Covers the basic commands and functionality of the FreeBSD operating system. If you are familiar with Linux® or another flavor of UNIX® then you can probably skip this chapter.</p>
</dd>
<dt class="hdlist1"><em><a href="./#ports">Installing Applications: Packages and Ports</a></em></dt>
<dd>
<p>Covers the installation of third-party software with both FreeBSD’s innovative &#34;Ports Collection&#34; and standard binary packages.</p>
</dd>
<dt class="hdlist1"><em><a href="./#x11">The X Window System</a></em></dt>
<dd>
<p>Describes the X Window System in general and using X11 on FreeBSD in particular. Also describes common desktop environments such as KDE and GNOME.</p>
</dd>
<dt class="hdlist1"><em><a href="./#wayland">Wayland</a></em></dt>
<dd>
<p>Describes the Wayland display server in general and using Wayland on FreeBSD in particular. Also describes common compositors such as Wayfire, Hikari and Sway.</p>
</dd>
<dt class="hdlist1"><em><a href="./#desktop">Desktop Applications</a></em></dt>
<dd>
<p>Lists some common desktop applications, such as web browsers and productivity suites, and describes how to install them on FreeBSD.</p>
</dd>
<dt class="hdlist1"><em><a href="./#multimedia">Multimedia</a></em></dt>
<dd>
<p>Shows how to set up sound and video playback support for your system. Also describes some sample audio and video applications.</p>
</dd>
<dt class="hdlist1"><em><a href="./#kernelconfig">Configuring the FreeBSD Kernel</a></em></dt>
<dd>
<p>Explains why you might need to configure a new kernel and provides detailed instructions for configuring, building, and installing a custom kernel.</p>
</dd>
<dt class="hdlist1"><em><a href="./#printing">Printing</a></em></dt>
<dd>
<p>Describes managing printers on FreeBSD, including information about banner pages, printer accounting, and initial setup.</p>
</dd>
<dt class="hdlist1"><em><a href="./#linuxemu">Linux® Binary Compatibility</a></em></dt>
<dd>
<p>Describes the Linux® compatibility features of FreeBSD. Also provides detailed installation instructions for many popular Linux® applications such as Oracle® and Mathematica®.</p>
</dd>
<dt class="hdlist1"><em><a href="./#wine">WINE</a></em></dt>
<dd>
<p>Describes WINE and provides detailed installation instructions. Also describes how WINE operates, how to install a GUI helper, how to run Windows® applications on FreeBSD, and offers other tips and solutions.</p>
</dd>
<dt class="hdlist1"><em><a href="./#config-tuning">Configuration and Tuning</a></em></dt>
<dd>
<p>Describes the parameters available for system administrators to tune a FreeBSD system for optimum performance. Also describes the various configuration files used in FreeBSD and where to find them.</p>
</dd>
<dt class="hdlist1"><em><a href="./#boot">The FreeBSD Booting Process</a></em></dt>
<dd>
<p>Describes the FreeBSD boot process and explains how to control this process with configuration options.</p>
</dd>
<dt class="hdlist1"><em><a href="./#security">Security</a></em></dt>
<dd>
<p>Describes many different tools available to help keep your FreeBSD system secure, including Kerberos, IPsec and OpenSSH.</p>
</dd>
<dt class="hdlist1"><em><a href="./#jails">Jails</a></em></dt>
<dd>
<p>Describes the jails framework, and the improvements of jails over the traditional chroot support of FreeBSD.</p>
</dd>
<dt class="hdlist1"><em><a href="./#mac">Mandatory Access Control</a></em></dt>
<dd>
<p>Explains what Mandatory Access Control (MAC) is and how this mechanism can be used to secure a FreeBSD system.</p>
</dd>
<dt class="hdlist1"><em><a href="./#audit">Security Event Auditing</a></em></dt>
<dd>
<p>Describes what FreeBSD Event Auditing is, how it can be installed, configured, and how audit trails can be inspected or monitored.</p>
</dd>
<dt class="hdlist1"><em><a href="./#disks">Storage</a></em></dt>
<dd>
<p>Describes how to manage storage media and filesystems with FreeBSD. This includes physical disks, RAID arrays, optical and tape media, memory-backed disks, and network filesystems.</p>
</dd>
<dt class="hdlist1"><em><a href="./#geom">GEOM: Modular Disk Transformation Framework</a></em></dt>
<dd>
<p>Describes what the GEOM framework in FreeBSD is and how to configure various supported RAID levels.</p>
</dd>
<dt class="hdlist1"><em><a href="./#zfs">The OpenZFS storage platform</a></em></dt>
<dd>
<p>Describes the OpenZFS storage platform and provides a quick-start guide and information about advanced topics running OpenZFS under FreeBSD.</p>
</dd>
<dt class="hdlist1"><em><a href="./#filesystems">Other File Systems</a></em></dt>
<dd>
<p>Examines support for non-native file systems under FreeBSD like ext2, ext3 and ext4.</p>
</dd>
<dt class="hdlist1"><em><a href="./#virtualization">Virtualization</a></em></dt>
<dd>
<p>Describes what virtualization systems offer, and how they can be used with FreeBSD.</p>
</dd>
<dt class="hdlist1"><em><a href="./#l10n">Localization - i18n/L10n Usage and Setup</a></em></dt>
<dd>
<p>Describes how to use FreeBSD in languages other than English. Covers both system and application level localization.</p>
</dd>
<dt class="hdlist1"><em><a href="./#updating-upgrading">Updating and Upgrading FreeBSD</a></em></dt>
<dd>
<p>Explains the differences between FreeBSD-STABLE, FreeBSD-CURRENT, and FreeBSD releases. Describes which users would benefit from tracking a development system and outlines that process. Covers the methods users may take to update their system to the latest security release.</p>
</dd>
<dt class="hdlist1"><em><a href="./#dtrace">DTrace</a></em></dt>
<dd>
<p>Describes how to configure and use the DTrace tool from Sun™ on FreeBSD. Dynamic tracing can help locate performance issues, by performing real time system analysis.</p>
</dd>
<dt class="hdlist1"><em><a href="./#usb-device-mode">USB Device Mode / USB OTG</a></em></dt>
<dd>
<p>Explains the use of USB Device Mode and USB On The Go (USB OTG) on FreeBSD.</p>
</dd>
<dt class="hdlist1"><em><a href="./#ppp-and-slip">PPP</a></em></dt>
<dd>
<p>Describes how to use PPP to connect to remote systems in FreeBSD.</p>
</dd>
<dt class="hdlist1"><em><a href="./#mail">Electronic Mail</a></em></dt>
<dd>
<p>Explains the different components of an email server and dives into simple configuration topics for the most popular mail server software: sendmail.</p>
</dd>
<dt class="hdlist1"><em><a href="./#network-servers">Network Servers</a></em></dt>
<dd>
<p>Provides detailed instructions and example configuration files to set up your FreeBSD machine as a network filesystem server, domain name server, network information system server, or time synchronization server.</p>
</dd>
<dt class="hdlist1"><em><a href="./#firewalls">Firewalls</a></em></dt>
<dd>
<p>Explains the philosophy behind software-based firewalls and provides detailed information about the configuration of the different firewalls available for FreeBSD.</p>
</dd>
<dt class="hdlist1"><em><a href="./#advanced-networking">Advanced Networking</a></em></dt>
<dd>
<p>Describes many networking topics, including sharing an Internet connection with other computers on your LAN, advanced routing topics, wireless networking, Bluetooth®, ATM, IPv6, and much more.</p>
</dd>
<dt class="hdlist1"><em><a href="./#mirrors">Obtaining FreeBSD</a></em></dt>
<dd>
<p>Lists different sources for obtaining FreeBSD media on CDROM or DVD as well as different sites on the Internet that allow you to download and install FreeBSD.</p>
</dd>
<dt class="hdlist1"><em><a href="./#bibliography">Bibliography</a></em></dt>
<dd>
<p>This book touches on many different subjects that may leave you hungry for a more detailed explanation. The bibliography lists many excellent books that are referenced in the text.</p>
</dd>
<dt class="hdlist1"><em><a href="./#eresources">Resources on the Internet</a></em></dt>
<dd>
<p>Describes the many forums available for FreeBSD users to post questions and engage in technical conversations about FreeBSD.</p>
</dd>
<dt class="hdlist1"><em><a href="./#pgpkeys">OpenPGP Keys</a></em></dt>
<dd>
<p>Lists the PGP fingerprints of several FreeBSD Developers.</p>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="preface-conv">Conventions used in this book<a class="anchor" href="#preface-conv"></a></h3>
<div class="paragraph">
<p>To provide a consistent and easy to read text, several conventions are followed throughout the book.</p>
</div>
<div class="sect3">
<h4 id="preface-conv-typographic">Typographic Conventions<a class="anchor" href="#preface-conv-typographic"></a></h4>
<div class="dlist">
<dl>
<dt class="hdlist1"><em>Italic</em></dt>
<dd>
<p>An <em>italic</em> font is used for filenames, URLs, emphasized text, and the first usage of technical terms.</p>
</dd>
<dt class="hdlist1"><code>Monospace</code></dt>
<dd>
<p>A <code>monospaced</code> font is used for error messages, commands, environment variables, names of ports, hostnames, user names, group names, device names, variables, and code fragments.</p>
</dd>
<dt class="hdlist1">Bold</dt>
<dd>
<p>A <strong>bold</strong> font is used for applications, commands, and keys.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="preface-conv-commands">User Input<a class="anchor" href="#preface-conv-commands"></a></h4>
<div class="paragraph">
<p>Keys are shown in <strong>bold</strong> to stand out from other text. Key combinations that are meant to be typed simultaneously are shown with <code>+</code> between the keys, such as:</p>
</div>
<div class="paragraph">
<p><span class="keyseq"><kbd>Ctrl</kbd>+<kbd>Alt</kbd>+<kbd>Del</kbd></span></p>
</div>
<div class="paragraph">
<p>Meaning the user should type the <kbd>Ctrl</kbd>, <kbd>Alt</kbd>, and <kbd>Del</kbd> keys at the same time.</p>
</div>
<div class="paragraph">
<p>Keys that are meant to be typed in sequence will be separated with commas, for example:</p>
</div>
<div class="paragraph">
<p><span class="keyseq"><kbd>Ctrl</kbd>+<kbd>X</kbd></span>, <span class="keyseq"><kbd>Ctrl</kbd>+<kbd>S</kbd></span></p>
</div>
<div class="paragraph">
<p>Would mean that the user is expected to type the <kbd>Ctrl</kbd> and <kbd>X</kbd> keys simultaneously and then to type the <kbd>Ctrl</kbd> and <kbd>S</kbd> keys simultaneously.</p>
</div>
</div>
<div class="sect3">
<h4 id="preface-conv-examples">Examples<a class="anchor" href="#preface-conv-examples"></a></h4>
<div class="paragraph">
<p>Examples starting with <span class="filename">C:\&gt;</span> indicate a MS-DOS® command. Unless otherwise noted, these commands may be executed from a &#34;Command Prompt&#34; window in a modern Microsoft® Windows® environment.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">C:\&gt; </span>tools<span class="se">\f</span>dimage floppies<span class="se">\k</span>ern.flp A:</code></pre>
</div>
</div>
<div class="paragraph">
<p>Examples starting with # indicate a command that must be invoked as the superuser in FreeBSD. You can login as <code>root</code> to type the command, or login as your normal account and use <a href="https://man.freebsd.org/cgi/man.cgi?query=su&amp;sektion=1&amp;format=html">su(1)</a> to gain superuser privileges.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># dd if=kern.flp of=/dev/fd0</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Examples starting with % indicate a command that should be invoked from a normal user account. Unless otherwise noted, C-shell syntax is used for setting environment variables and other shell commands.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>top</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="preface-acknowledgements">Acknowledgments<a class="anchor" href="#preface-acknowledgements"></a></h3>
<div class="paragraph">
<p>The book you are holding represents the efforts of many hundreds of people around the world. Whether they sent in fixes for typos, or submitted complete chapters, all the contributions have been useful.</p>
</div>
<div class="paragraph">
<p>Several companies have supported the development of this document by paying authors to work on it full-time, paying for publication, etc. In particular, BSDi (subsequently acquired by <a href="http://www.windriver.com">Wind River Systems</a>) paid members of the FreeBSD Documentation Project to work on improving this book full time leading up to the publication of the first printed edition in March 2000 (ISBN 1-57176-241-8). Wind River Systems then paid several additional authors to make a number of improvements to the print-output infrastructure and to add additional chapters to the text. This work culminated in the publication of the second printed edition in November 2001 (ISBN 1-57176-303-1). In 2003-2004, <a href="http://www.freebsdmall.com">FreeBSD Mall, Inc</a>, paid several contributors to improve the Handbook in preparation for the third printed edition. The third printed edition has been split into two volumes. Both volumes have been published as The FreeBSD Handbook 3rd Edition Volume 1: User Guide (ISBN 1-57176-327-9) and The FreeBSD Handbook 3rd Edition Volume 2: Administrators Guide (ISBN 1-57176-328-7).</p>
</div>
</div>
</div>
</div>
<h1 id="getting-started" class="sect0">Part I: 入门指南<a class="anchor" href="#getting-started"></a></h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>本手册的这部分是为那些对FreeBSD新手用户和管理员准备的。这些章节包括：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>介绍 FreeBSD。</p>
</li>
<li>
<p>引导读者完成安装过程。</p>
</li>
<li>
<p>教授 UNIX® 的基础知识和基本原理。</p>
</li>
<li>
<p>展示如何安装适用于 FreeBSD 的丰富第三方应用程序。</p>
</li>
<li>
<p>介绍 UNIX® 窗口系统 X，并详细说明如何配置一个能提高用户生产力的桌面环境。</p>
</li>
<li>
<p>介绍 Wayland，一种新的 UNIX® 显示服务器。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>文本中的正向引用数量被尽量减少，以便这一部分可以从头到尾地阅读，最大程度地减少翻页。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="introduction">Chapter 1. 介绍<a class="anchor" href="#introduction"></a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="introduction-synopsis">1.1. 简介<a class="anchor" href="#introduction-synopsis"></a></h3>
<div class="paragraph">
<p>感谢你对 FreeBSD 有所兴趣！ 下面这一章涉及到了 FreeBSD 项目的各个方面，例如它的历史、目标、开发模式等等。</p>
</div>
<div class="paragraph">
<p>阅读本章后，您将了解：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>FreeBSD 与其他计算机操作系统的关系。</p>
</li>
<li>
<p>FreeBSD 项目的历史。</p>
</li>
<li>
<p>FreeBSD 项目的目标。</p>
</li>
<li>
<p>FreeBSD 开源开发模型的基础知识。</p>
</li>
<li>
<p>当然，还有一个问题： FreeBSD 这个名字的由来。</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="nutshell">1.2. 欢迎来到 FreeBSD ！<a class="anchor" href="#nutshell"></a></h3>
<div class="paragraph">
<p>FreeBSD 是一个开源的、符合标准的类 Unix 操作系统，适用于 x86（32 位和 64 位）、ARM、AArch64、RISC-V、POWER 和 PowerPC 计算机。它提供了现在被视为理所当然的所有功能，如抢占式多任务处理、内存保护、虚拟内存、多用户设施、 SMP 支持、各种语言和框架的开源开发工具，以及以 X Window System、KDE 或 GNOME 为中心的桌面功能。它的特点有：</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>自由开源许可证（ Liberal Open Source license ）</em> 赋予您自由修改和扩展其源代码的权利，并将其纳入开源项目和闭源产品中，而不会施加典型的强制共享许可证所具有的限制，同时避免潜在的许可证不兼容问题。</p>
</li>
<li>
<p><em>强大的 TCP/IP 网络</em> - FreeBSD 采用行业标准协议，具有越来越高的性能和可扩展性。这使得它在服务器和路由 / 防火墙角色中都能很好地匹配 - 实际上，许多公司和供应商正是出于这个目的使用它。</p>
</li>
<li>
<p><em>完全集成的 OpenZFS 支持</em>，包括 root-on-ZFS 、 ZFS 引导环境、故障管理、管理委派、支持 jails 、 FreeBSD 特定文档和系统安装程序支持。</p>
</li>
<li>
<p><em>广泛的安全功能</em>，从强制访问控制框架到 Capsicum 能力和沙盒机制。</p>
</li>
<li>
<p><em>超过30 , 000 个预构建软件包</em> 支持所有架构，以及 Ports Collection ，使得构建自己定制的软件包变得容易。</p>
</li>
<li>
<p><em>文档</em> - 除了手册和涵盖从系统管理到内核内部的各种主题的不同作者的书籍之外，还有 <a href="https://man.freebsd.org/cgi/man.cgi?query=man&amp;sektion=1&amp;format=html">man(1)</a> 页面，不仅适用于用户空间的守护进程、实用程序和配置文件，还适用于内核驱动程序 API （第 9 节）和单个驱动程序（第 4 节）。</p>
</li>
<li>
<p><em>简单而一致的存储库结构和构建系统</em> - FreeBSD 使用一个存储库来管理所有组件，包括内核和用户空间。这个特点，加上统一且易于定制的构建系统以及经过深思熟虑的开发流程，使得将 FreeBSD 与自己产品的构建基础设施集成变得容易。</p>
</li>
<li>
<p><em>秉承 Unix 哲学</em>，更倾向于可组合性，而不是硬编码行为的单体化“一体化”守护程序。</p>
</li>
<li>
<p><em>与 Linux 的二进制兼容性</em>，使得在不需要虚拟化的情况下可以运行许多 Linux 二进制文件。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>FreeBSD 基于加利福尼亚大学伯克利分校计算机系统研究组（ CSRG ）的 4.4BSD-Lite 发布版，并延续了 BSD 系统开发的卓越传统。除了 CSRG 提供的出色工作外， FreeBSD 项目还投入了数千小时的工作，扩展了功能并对系统进行了精细调整，以在实际负载情况下实现最大性能和可靠性。 FreeBSD 提供与其他开源和商业产品相当的性能和可靠性，同时结合了其他地方无法获得的尖端功能。</p>
</div>
<div class="sect3">
<h4 id="os-overview">1.2.1. FreeBSD 可以做什么？<a class="anchor" href="#os-overview"></a></h4>
<div class="paragraph">
<p>FreeBSD 的应用范围几乎只受你的想象力限制。从软件开发到工厂自动化，从库存控制到远程卫星天线的方位校正；如果可以用商业 UNIX® 产品完成，那么很有可能你也可以用 FreeBSD 来实现！ FreeBSD 还受益于全球研究中心和大学开发的成千上万个高质量应用程序，通常可以以很低的或者零成本获得。</p>
</div>
<div class="paragraph">
<p>由于 FreeBSD 本身的源代码是免费提供的，因此该系统可以根据特定应用或项目的需求进行几乎无与伦比的定制，而这在大多数主要商业供应商的操作系统中通常是不可能的。以下是一些人们目前正在使用 FreeBSD 的应用程序的示例：</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>互联网服务</em>：FreeBSD 内置的强大的 TCP/IP 网络使其成为各种互联网服务的理想平台，例如：</p>
<div class="ulist">
<ul>
<li>
<p>Web 服务器</p>
</li>
<li>
<p>IPv4 和 IPv6 路由</p>
</li>
<li>
<p>防火墙和 NAT （&#34;IP 伪装&#34;）网关</p>
</li>
<li>
<p>FTP 服务器</p>
</li>
<li>
<p>电子邮件服务器</p>
</li>
<li>
<p>存储服务器</p>
</li>
<li>
<p>虚拟化服务器</p>
</li>
<li>
<p>还有更多 …​</p>
</li>
</ul>
</div>
</li>
<li>
<p><em>教育：</em> 你是计算机科学或相关工程领域的学生吗？没有比 FreeBSD 提供的亲身实践、深入了解操作系统、计算机架构和网络更好的学习方式了。还有一些免费的 CAD 、数学和图形设计软件包，对于那些主要关注计算机用于完成其他工作的人来说，它们也非常有用！</p>
</li>
<li>
<p><em>研究：</em> 由于整个系统的源代码可用， FreeBSD 是操作系统以及计算机科学其他领域研究的优秀平台。 FreeBSD 的自由可用性也使得远程团队能够在想法或共享开发上进行合作，而无需担心特殊许可协议或在公开论坛上讨论的限制。</p>
</li>
<li>
<p><em>网络：</em> 需要一个新的路由器吗？一个域名服务器（ DNS ）？一个防火墙来阻止人们进入您的内部网络？ FreeBSD 可以轻松地将闲置在角落的个人电脑转变为具有复杂数据包过滤功能的高级路由器。</p>
</li>
<li>
<p><em>嵌入式：</em> FreeBSD 是构建嵌入式系统的优秀平台。它支持 ARM 、 AArch64 和 PowerPC 平台，配备强大的网络堆栈、尖端功能和宽松的 <a href="{faq}#bsd-license-restrictions">BSD 许可证</a>，使 FreeBSD 成为构建嵌入式路由器、防火墙和其他设备的理想基础。</p>
</li>
<li>
<p><em>桌面：</em> FreeBSD 是一个使用免费的 X11 服务器和 Wayland 显示服务器的廉价桌面解决方案的不错选择。 FreeBSD 提供了许多开源桌面环境的选择，包括标准的 GNOME 和 KDE 图形用户界面。 FreeBSD 甚至可以从中央服务器“无盘启动”，使得个人工作站更加便宜和易于管理。</p>
</li>
<li>
<p><em>软件开发：</em> 基本的 FreeBSD 系统配备了一套完整的开发工具，包括完整的 C/C ++编译器和调试器套件。通过端口和软件包集合，还可以支持许多其他编程语言。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>FreeBSD 可以免费下载，也可以通过 CD-ROM 或 DVD 获取。有关获取 FreeBSD 的更多信息，请参阅 <a href="./#mirrors">Obtaining FreeBSD</a> 。</p>
</div>
</div>
<div class="sect3">
<h4 id="introduction-nutshell-users">1.2.2. 谁使用 FreeBSD ？<a class="anchor" href="#introduction-nutshell-users"></a></h4>
<div class="paragraph">
<p>FreeBSD 以其 Web 服务器功能而闻名。可以在 FreeBSD 基金会的网站上找到一份 <a href="https://freebsdfoundation.org/about-us/testimonials/">基于 FreeBSD 的产品和服务的公司的 testimonials 列表</a> 。维基百科还维护着一个 <a href="https://en.wikipedia.org/wiki/List_of_products_based_on_FreeBSD">基于 FreeBSD 的产品列表</a> 。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="history">1.3. 关于 FreeBSD 项目<a class="anchor" href="#history"></a></h3>
<div class="paragraph">
<p>下面的部分提供了关于项目的一些背景信息，包括简要历史、项目目标以及项目 <a href="{dev-model}#development model">开发模型</a>。</p>
</div>
<div class="sect3">
<h4 id="intro-history">1.3.1. FreeBSD 的简要历史<a class="anchor" href="#intro-history"></a></h4>
<div class="paragraph">
<p>FreeBSD 项目诞生于 1993 年初，部分是由非官方的 386BSDPatchkit 的最后三位协调员 Nate Williams 、 Rod Grimes 和 Jordan Hubbard 共同构思而成。</p>
</div>
<div class="paragraph">
<p>最初的目标是生成 386BSD 的中间快照，以解决一些无法通过补丁机制解决的问题。该项目的早期工作标题是 386BSD 0.5 或 386BSD Interim ，以此为参考。</p>
</div>
<div class="paragraph">
<p>386BSD 是 Bill Jolitz 的操作系统，到那时为止，它已经遭受了将近一年的严重忽视。随着每一天过去，补丁包变得越来越不舒服，他们决定通过提供这个临时的“清理”快照来帮助 Bill 。然而，当 Bill Jolitz 突然决定撤回对该项目的支持，并没有明确表示将采取什么替代措施时，这些计划被粗暴地中止了。</p>
</div>
<div class="paragraph">
<p>即使没有 Bill 的支持，三人组仍然认为目标仍然值得追求，因此他们采用了 David Greenman 提出的“ FreeBSD ”这个名字。在与系统当前用户咨询后，确定了最初的目标。一旦清楚该项目可能成为现实， Jordan 便联系了 Walnut Creek CDROM ，以改善 FreeBSD 的发行渠道，以便那些没有便捷访问互联网的人。 Walnut Creek CDROM 不仅支持在光盘上分发 FreeBSD ，还提供了一台用于开发工作的机器和快速的互联网连接。如果没有 Walnut Creek CDROM 对当时一个完全未知的项目的几乎前所未有的信任， FreeBSD 很可能不会像今天这样迅速取得如此大的进展。</p>
</div>
<div class="paragraph">
<p>第一张 CD-ROM （以及整个网络范围内的）发行版是 FreeBSD 1.0 ，于 1993 年 12 月发布。它基于来自加州大学伯克利分校的 4.3BSD-Lite （“Net/2”）磁带，同时还借鉴了 386BSD 和自由软件基金会提供的许多组件。作为首次发布，它取得了相当不错的成功，并在 1994 年 5 月发布了备受好评的 FreeBSD 1.1 版本。</p>
</div>
<div class="paragraph">
<p>在这个时候，Novell 和加州大学伯克利分校（ U.C. Berkeley ）就有关伯克利 Net/2 磁带的法律地位的长期诉讼达成了意外的和解。和解的条件是 U.C. Berkeley 承认 Net/2 的三个文件是“受限制”的代码，必须予以删除，因为它们是诺维尔的财产，而 Novell 则是之前从 AT&amp;T 收购的。作为回报，伯克利获得了 Novell 的“祝福”，即当 4.4BSD-Lite 版本最终发布时，将被宣布为无限制的，并强烈鼓励所有现有的 Net/2 用户切换过来。这包括 FreeBSD ，该项目被给予截止到 1994 年 7 月底停止发布基于 Net/2 的产品的时间。根据协议的条款，该项目在最后期限之前被允许发布最后一个版本，即 FreeBSD 1.1.5.1 。</p>
</div>
<div class="paragraph">
<p>FreeBSD 随后开始了一项艰巨的任务，从一个全新且相当不完整的 4.4BSD-Lite 代码库中重新塑造自己。虽然只有与 System V 共享内存和信号量相关的三个文件被删除，但在 BSD 发行版中进行了许多其他的更改和错误修复，因此将所有 FreeBSD 的开发工作合并到 4.4BSD-Lite 中是一项巨大的任务。该项目直到 1994 年 11 月才完成了这一过渡，并在 12 月向世界发布了 FreeBSD 2.0 版本。尽管在某种程度上仍然存在一些问题，但这个版本取得了重大的成功，并在 1995 年 6 月发布了更稳定、更易安装的 FreeBSD 2.0.5 版本。</p>
</div>
<div class="paragraph">
<p>从那时起，FreeBSD 发布了一系列版本，每次都会在前一版本的稳定性、速度和功能集上进行改进。</p>
</div>
<div class="paragraph">
<p>目前，长期发展项目仍在15.0-CURRENT (main) 分支中进行，并且随着工作的进行，15.0 的快照版本将持续从 <a href="https://download.freebsd.org/snapshots/">快照服务器</a> 发布。</p>
</div>
</div>
<div class="sect3">
<h4 id="goals">1.3.2. FreeBSD 项目的目标<a class="anchor" href="#goals"></a></h4>
<div class="paragraph">
<p>FreeBSD 项目的目标是提供可用于任何目的且无附加条件的软件。我们中的许多人在代码（和项目）上投入了大量资源，偶尔获得一些财务补偿并不介意，但我们绝对不会坚持要求。我们相信我们的首要任务是向任何人提供代码，无论出于何种目的，以便代码得到最广泛的使用并提供最广泛的利益。我们认为这是自由软件的最基本目标之一，我们对此表示热情支持。</p>
</div>
<div class="paragraph">
<p>我们源代码树中受 GNU 通用公共许可证（ GPL ）或库通用公共许可证（ LGPL ）约束的代码，附带了稍微更多的限制，尽管至少是在强制访问方面，而不是通常的相反情况。由于商业使用 GPL 软件可能出现的额外复杂性，我们更喜欢在合理的情况下选择以更宽松的 BSD 许可证提交的软件。</p>
</div>
</div>
<div class="sect3">
<h4 id="development">1.3.3. FreeBSD 开发模型<a class="anchor" href="#development"></a></h4>
<div class="paragraph">
<p>FreeBSD 的开发是一个<a href="{dev-model}#very open and flexible process">非常开放和灵活的过程</a>，从世界各地成千上万的人的贡献中构建而成，这一点可以从我们的 <a href="{contributors}#list of contributors">贡献者列表</a> 中看出来。 FreeBSD 的开发基础设施允许这些成千上万的贡献者在互联网上进行合作。我们一直在寻找新的志愿者，有兴趣更深入参与的人应该参考有关 <a href="{contributing}#Contributing to FreeBSD">贡献 FreeBSD</a> 的文章。</p>
</div>
<div class="paragraph">
<p>无论是独立工作还是密切合作，以下是关于 FreeBSD 项目及其开发过程的一些有用信息：</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Git 仓库 <a id="development-cvs-repository"></a></dt>
<dd>
<p>多年来， FreeBSD 的中央源代码树由免费可用的源代码控制工具 <a href="https://www.nongnu.org/cvs/">CVS</a> （ Concurrent Versions System ）维护。 2008 年 6 月，该项目转而使用 <a href="https://subversion.apache.org/">SVN</a> （ Subversion ）。由于源代码树的迅速扩展和已存储的历史记录量， CVS 所施加的技术限制变得明显，因此这次转换被认为是必要的。文档项目和 Ports 集合存储库也分别于 2012 年 5 月和 2012 年 7 月从 CVS 迁移到了 SVN 。 2020 年 12 月，该项目将源代码和文档存储库迁移到了 <a href="https://git-scm.com/">Git</a> ，而 Ports 集合则在 2021 年 4 月跟随。有关获取 FreeBSD <code>src/</code> 存储库的更多信息，请参阅 <a href="./#synching">Obtaining the Source</a> 部分，有关获取 FreeBSD Ports 集合的详细信息，请参阅 <a href="./#ports-using">Using the Ports Collection</a> 。</p>
</dd>
<dt class="hdlist1">贡献者列表 <a id="development-committers"></a></dt>
<dd>
<p><em>committers</em> 是那些具有对 Git 仓库的 <em>push</em> 访问权限的人，他们被授权对 FreeBSD 源代码进行修改（术语“committer”来自于 <code>commit</code> ，这是用于将新更改引入仓库的源代码控制命令）。任何人都可以提交一个 bug 到 <a href="https://bugs.FreeBSD.org/submit/">Bug Database</a> 。在提交 bug 报告之前，可以使用 FreeBSD 邮件列表、 IRC 频道或论坛来帮助验证一个问题是否真的是一个 bug 。</p>
</dd>
<dt class="hdlist1">FreeBSD 核心团队 <a id="development-core"></a></dt>
<dd>
<p>如果 FreeBSD 项目是一家公司，那么 <em>FreeBSD 核心团队</em> 将相当于董事会。核心团队的主要任务是确保整个项目处于良好状态并朝着正确的方向发展。邀请专注和负责任的开发人员加入我们的提交者团队是核心团队的职责之一，招募新的核心团队成员也是核心团队的职责之一。当前的核心团队是在 2022 年 5 月从提交者候选人中选举产生的。选举每 2 年举行一次。</p>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>和大多数开发者一样， FreeBSD 核心团队的大多数成员在 FreeBSD 开发方面也是志愿者，并且没有从项目中获得经济利益，所以“承诺”也不应被误解为“有保证的支持”。上面提到的“董事会”类比并不十分准确，更适合说这些人是在违背自己更好判断的情况下选择了 FreeBSD 而放弃了自己的生活！</p>
</div>
</td>
</tr>
</tbody></table>
</div>
</dd>
<dt class="hdlist1">FreeBSD 基金会 <a id="开发基金会"></a></dt>
<dd>
<p><a href="https://freebsdfoundation.org/">FreeBSD 基金会</a> 是一个位于美国的 501(c)(3) 非营利组织，致力于支持和推广全球的 FreeBSD 项目和社区。基金会通过项目拨款资助软件开发，并提供员工立即响应紧急问题并实施新的特性和功能。基金会购买硬件以改善和维护 FreeBSD 基础设施，并资助人员提高测试覆盖率、持续集成和自动化。基金会通过在世界各地的技术会议和活动上推广 FreeBSD 来支持 FreeBSD 。基金会还提供研讨会、教育材料和演示，以吸引更多的 FreeBSD 用户和贡献者。基金会还代表 FreeBSD 项目执行合同、许可协议和其他需要认可法律实体的法律安排。</p>
</dd>
<dt class="hdlist1">外部贡献者</dt>
<dd>
<p>最后，但绝对不是最不重要的，最大的开发者群体是用户自己，他们几乎一直向我们提供反馈和错误修复。与 FreeBSD 基本系统的开发保持联系的主要方式是订阅 {freebsd-hackers} ，在这里讨论这些事情。对于移植第三方应用程序，可以使用 {freebsd-ports} 。对于文档，可以使用 {freebsd-doc} 。有关各种 FreeBSD 邮件列表的更多信息，请参见 <a href="./#eresources">互联网资源</a>。</p>
<div class="paragraph">
<p><a href="{contributors}#The FreeBSD Contributors List">The FreeBSD 贡献者列表</a> 是一个长期而不断增长的列表，为什么不通过 <a href="{contributing}#contributing something back to FreeBSD">为 FreeBSD 做出贡献</a> 加入其中呢？提供代码并不是唯一的方式！</p>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>总之，我们的开发模型是以一组松散的同心圆组织起来的。中心化模型是为了方便 FreeBSD 的用户，他们可以通过追踪一个中央代码库来获得便利，而不是为了排斥潜在的贡献者！我们的愿望是提供一个稳定的操作系统，配备一套大量的一致的应用程序，用户可以轻松安装和使用 - 这个模型在实现这一目标方面非常成功。</p>
</div>
<div class="paragraph">
<p>我们对那些希望加入我们成为 FreeBSD 开发者的人只有一个要求，那就是拥有与现有成员一样对其持续成功的奉献精神！</p>
</div>
</div>
<div class="sect3">
<h4 id="third-party-programs">1.3.4. 第三方程序<a class="anchor" href="#third-party-programs"></a></h4>
<div class="paragraph">
<p>除了基本发行版之外， FreeBSD 还提供了一个可移植软件集合，其中包含数千个常见的程序。ports 列表涵盖了从 HTTP 服务器到游戏、编程语言、编辑器等几乎所有领域的程序。大约有 36000 个 ports；整个 Ports 集合需要大约 3 GB 的空间。要编译一个 ports，只需切换到您想要安装的程序的目录，输入 <code>make install</code>，然后让系统完成剩下的工作。每个构建的 ports 都会动态地检索完整的原始发行版，因此您只需要足够的磁盘空间来构建所需的 ports。</p>
</div>
<div class="paragraph">
<p>几乎每个 ports 也都提供了预编译的“软件包”，不希望从源代码编译自己的 ports 的用户可以使用简单的命令（ <code>pkg install</code> ）进行安装。有关软件包和 ports 的更多信息，请参阅 <a href="./#ports">安装应用程序：软件包和 ports</a> 。</p>
</div>
</div>
<div class="sect3">
<h4 id="_附加文档">1.3.5. 附加文档<a class="anchor" href="#_附加文档"></a></h4>
<div class="paragraph">
<p>所有支持的 FreeBSD 版本在安装程序中提供了一个选项，在初始系统设置期间可以安装附加文档到 <span class="filename">/usr/local/share/doc/freebsd</span>。文档也可以在之后使用软件包进行安装：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install en-freebsd-doc</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>对于本地化版本，请将“en”替换为所选语言的语言前缀。请注意，一些本地化版本可能已过时，可能包含不再正确或相关的信息。您可以使用以下 URL 在 Web 浏览器中查看本地安装的手册：</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">FreeBSD 手册</dt>
<dd>
<p><code>/usr/local/share/doc/freebsd/en/books/handbook/handbook_en.pdf</code></p>
</dd>
<dt class="hdlist1">FreeBSD 常见问题解答</dt>
<dd>
<p><code>/usr/local/share/doc/freebsd/en/books/faq/faq_en.pdf</code></p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>您可以随时在 <a href="https://docs.FreeBSD.org/">文档门户</a> 找到最新的文档。</p>
</div>
<div class="paragraph">
<p>所有商标均为其各自所有者的财产。</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="bsdinstall">Chapter 2. 安装 FreeBSD<a class="anchor" href="#bsdinstall"></a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="bsdinstall-synopsis">2.1. 简介<a class="anchor" href="#bsdinstall-synopsis"></a></h3>
<div class="paragraph">
<p>FreeBSD 支持多种架构，包括 amd64 、 ARM® 、 RISC-V® 和 PowerPC® 。根据不同的架构和平台，可以 <a href="https://www.freebsd.org/where/">下载</a> 不同的镜像来安装或直接运行 FreeBSD 。</p>
</div>
<div class="paragraph">
<p>镜像类型有：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>虚拟机磁盘镜像，例如 <code>qcow2</code>、<code>vmdk</code>、<code>vhd</code> 和原始设备镜像。这些不是安装镜像，而是已经预装了 FreeBSD 并准备好进行后安装任务的镜像。虚拟机镜像在云环境中也被广泛使用。</p>
</li>
<li>
<p>SD 卡镜像，用于树莓派等嵌入式系统。这些文件必须解压缩并以原始镜像的形式写入 SD 卡，主板将从 SD 卡启动。</p>
</li>
<li>
<p>安装镜像用于从 ISO 或 USB 设备引导，以在常见的台式机、笔记本电脑或服务器系统上安装 FreeBSD 到驱动器。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>本章的其余部分描述了第三种情况，解释了如何使用名为 bsdinstall 的基于文本的安装程序安装 FreeBSD 。安装程序与此处显示的内容可能存在细微差异，因此请将本章作为一份通用指南，而不是一组字面指令。</p>
</div>
<div class="paragraph">
<p>阅读完本章后，您将了解：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>如何获取 FreeBSD 镜像并创建 FreeBSD 安装介质。</p>
</li>
<li>
<p>如何启动 bsdinstall 。</p>
</li>
<li>
<p>bsdinstall 将会询问的问题，它们的含义以及如何回答。</p>
</li>
<li>
<p>如何排除安装失败的问题。</p>
</li>
<li>
<p>在进行安装之前，如何访问 FreeBSD 的活动版本。</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="bsdinstall-hardware">2.2. 最低硬件要求<a class="anchor" href="#bsdinstall-hardware"></a></h3>
<div class="paragraph">
<p>安装 FreeBSD 的硬件要求因架构和版本而异。支持 FreeBSD 发布的硬件架构和设备可以在 <a href="https://www.FreeBSD.org/releases/">FreeBSD 发布信息</a> 页面上找到。<a href="https://www.FreeBSD.org/where/">FreeBSD 下载页面</a> 还提供了选择不同架构的正确镜像的建议。</p>
</div>
</div>
<div class="sect2">
<h3 id="bsdinstall-pre">2.3. 安装前的任务<a class="anchor" href="#bsdinstall-pre"></a></h3>
<div class="paragraph">
<p>一旦确定系统满足安装 FreeBSD 的最低硬件要求，就应该下载安装文件并准备安装介质。在此之前，请通过验证以下清单中的项目，确保系统已准备好进行安装：</p>
</div>
<div class="exampleblock procedure">
<div class="content">
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>备份重要数据</strong></p>
<div class="paragraph">
<p>在安装任何操作系统之前， <strong>一定要</strong> 首先备份所有重要数据。不要将备份存储在正在安装的系统上。而是将数据保存到可移动的磁盘，如 USB 驱动器、网络上的另一个系统或在线备份服务中。在开始安装之前，测试备份以确保它包含所有所需的文件。一旦安装程序格式化了系统的磁盘，该磁盘上存储的所有数据都将丢失。</p>
</div>
</li>
<li>
<p><strong>决定在哪里安装 FreeBSD</strong></p>
<div class="paragraph">
<p>如果只安装 FreeBSD 作为唯一的操作系统，可以跳过这一步。但如果 FreeBSD 将与其他操作系统共享磁盘，则需要决定哪个磁盘或分区将用于 FreeBSD 。</p>
</div>
<div class="paragraph">
<p>在 i386 和 amd64 架构中，可以使用两种分区方案将磁盘分成多个分区。传统的 <em>主引导记录（MBR）</em> 保存了一个包含最多四个 <em>主分区</em> 的分区表。出于历史原因，FreeBSD 将这些主分区称为 <em>slices</em>。其中一个主分区可以成为包含多个 <em>逻辑分区</em> 的 <em>扩展分区</em>。 <em>GUID 分区表（GPT）</em> 是一种较新且更简单的磁盘分区方法。常见的 GPT 实现允许每个磁盘最多有 128 个分区，消除了逻辑分区的需要。</p>
</div>
<div class="paragraph">
<p>FreeBSD 引导加载程序需要一个主分区或 GPT 分区。如果所有的主分区或 GPT 分区已经被使用，就必须释放一个分区给 FreeBSD 使用。为了在不删除现有数据的情况下创建一个分区，可以使用分区调整工具来缩小一个现有分区，并使用释放出的空间创建一个新的分区。</p>
</div>
<div class="paragraph">
<p>在 <a href="https://en.wikipedia.org/wiki/List_of_disk_partitioning_software">磁盘分区软件维基百科条目</a> 中列出了各种免费和商业的分区调整工具。<a href="https://gparted.org/livecd.php">GParted Live</a> 是一个免费的 Live CD，其中包含了 GParted 分区编辑器。</p>
</div>
<div class="admonitionblock warning">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>当正确使用时，磁盘收缩工具可以安全地为创建新分区腾出空间。由于选择错误分区的可能性存在，一定要在修改磁盘分区之前备份任何重要数据并验证备份的完整性。</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>包含不同操作系统的磁盘分区使得在一台计算机上安装多个操作系统成为可能。另一种选择是使用虚拟化技术，它允许多个操作系统同时运行，而无需修改任何磁盘分区。</p>
</div>
</li>
<li>
<p><strong>收集网络信息</strong></p>
<div class="paragraph">
<p>一些 FreeBSD 安装方法需要网络连接才能下载安装文件。在任何安装之后，安装程序将提供设置系统网络接口的选项。</p>
</div>
<div class="paragraph">
<p>如果网络有 DHCP 服务器，可以使用它来提供自动网络配置。如果没有 DHCP 可用，必须从本地网络管理员或互联网服务提供商获取系统的以下网络信息：</p>
</div>
<div id="bsdinstall-collect-network-information" class="paragraph">
<p>所需网络信息</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>IP 地址</p>
</li>
<li>
<p>子网掩码</p>
</li>
<li>
<p>默认网关的 IP 地址</p>
</li>
<li>
<p>网络的域名</p>
</li>
<li>
<p>网络的 DNS 服务器的 IP 地址</p>
</li>
</ol>
</div>
</li>
<li>
<p><strong>检查 FreeBSD 勘误表</strong></p>
<div class="paragraph">
<p>尽管 FreeBSD 项目努力确保每个 FreeBSD 版本尽可能稳定，但偶尔会出现一些错误。在非常罕见的情况下，这些错误会影响安装过程。当这些问题被发现并修复时，它们会在每个版本的 FreeBSD 勘误页面中进行记录。在安装之前，请检查勘误页面，以确保没有可能影响安装的问题。</p>
</div>
<div class="paragraph">
<p>所有发布版本的信息和勘误表都可以在 <a href="https://www.FreeBSD.org/releases/">FreeBSD Release Information</a> 页面上找到。</p>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect3">
<h4 id="bsdinstall-installation-media">2.3.1. 准备安装介质<a class="anchor" href="#bsdinstall-installation-media"></a></h4>
<div class="paragraph">
<p>FreeBSD 安装程序不是可以在另一个操作系统中运行的应用程序。相反，您需要下载一个 FreeBSD 安装文件，将其刻录到与其文件类型和大小（CD、DVD 或 USB）相关联的介质上，并从插入的介质启动系统以进行安装。</p>
</div>
<div class="paragraph">
<p>FreeBSD 安装文件可以在 <a href="https://www.FreeBSD.org/where/">FreeBSD 下载页面</a> 上找到。每个安装文件的名称包括 FreeBSD 的发布版本、架构和文件类型。</p>
</div>
<div class="paragraph">
<p>安装文件有多种格式可供选择，可以使用 <a href="https://man.freebsd.org/cgi/man.cgi?query=xz&amp;sektion=1&amp;format=html">xz(1)</a> 进行压缩或者不压缩。这些格式根据计算机架构和媒体类型而有所不同。</p>
</div>
<div class="paragraph">
<p>安装文件类型：</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code><strong>-bootonly.iso</strong></code>：这是最小的安装文件，只包含安装程序。在安装过程中需要一个可用的互联网连接，因为安装程序将下载完成 FreeBSD 安装所需的文件。这个文件应该被刻录到光盘介质上。</p>
</li>
<li>
<p><code><strong>-disc1.iso</strong></code>：这个文件包含了安装 FreeBSD 所需的所有文件，包括其源代码和 Ports 集合。这个文件应该被刻录到光盘介质上。</p>
</li>
<li>
<p><code><strong>-dvd1.iso</strong></code> ：该文件包含安装 FreeBSD 所需的所有文件，包括其源代码和 Ports 集合。它还包含一组流行的二进制软件包，用于安装窗口管理器和一些应用程序，以便可以在没有连接到互联网的情况下从介质上安装完整的系统。该文件应该被刻录到光盘介质上。</p>
</li>
<li>
<p><code><strong>-memstick.img</strong></code>：该文件包含安装 FreeBSD 所需的所有文件，包括其源代码和 Ports 集合。按照 <a href="#bsdinstall-usb">将镜像文件写入 USB</a> 中所示的方法将该文件写入 USB 存储设备。</p>
</li>
<li>
<p><code><strong>-mini-memstick.img</strong></code>：与 <code><strong>-bootonly.iso</strong></code> 类似，不包含安装文件，但会在需要时进行下载。在安装过程中需要一个可用的互联网连接。请按照 <a href="#bsdinstall-usb">将镜像文件写入 USB</a> 中所示的方式将其写入 USB 存储设备。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>在下载镜像文件后，从相同目录下载至少一个 <em>checksum</em> 文件。有两个 <em>checksum</em> 文件可用，分别以发布版本号和架构名称命名。例如：<code>CHECKSUM.SHA256-FreeBSD-13.1-RELEASE-amd64</code> 和 <code>CHECKSUM.SHA512-FreeBSD-13.1-RELEASE-amd64</code>。</p>
</div>
<div class="paragraph">
<p>在下载其中一个文件（或两个文件）之后，计算镜像文件的 <em>校验和（checksum）</em> 并将其与 <em>checksum</em> 文件中显示的 <em>校验和</em> 进行比较。请注意，您需要将计算出的 <em>校验和</em> 与正确的文件进行比较，因为它们对应于两种不同的算法： SHA256 和 SHA512。 FreeBSD 提供了可以用于计算 <em>校验和</em> 的 <a href="https://man.freebsd.org/cgi/man.cgi?query=sha256&amp;sektion=1&amp;format=html">sha256(1)</a> 和 <a href="https://man.freebsd.org/cgi/man.cgi?query=sha512&amp;sektion=1&amp;format=html">sha512(1)</a>。其他操作系统也有类似的程序。</p>
</div>
<div class="paragraph">
<p>在 FreeBSD 中，可以通过执行 <a href="https://man.freebsd.org/cgi/man.cgi?query=sha256sum&amp;sektion=1&amp;format=html">sha256sum(1)</a>（和 <a href="https://man.freebsd.org/cgi/man.cgi?query=sha512sum&amp;sektion=1&amp;format=html">sha512sum(1)</a>）来自动验证 <em>校验和</em>。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>sha256sum -c CHECKSUM.SHA256-FreeBSD-13.1-RELEASE-amd64 FreeBSD-13.1-RELEASE-amd64-dvd1.iso
FreeBSD-13.1-RELEASE-amd64-dvd1.iso: OK</code></pre>
</div>
</div>
<div class="paragraph">
<p>校验和必须完全匹配。如果校验和不匹配，则图像文件损坏，必须重新下载。</p>
</div>
<div class="sect4">
<h5 id="bsdinstall-usb">2.3.1.1. 将镜像文件写入 USB<a class="anchor" href="#bsdinstall-usb"></a></h5>
<div class="paragraph">
<p><code>*memstick.img</code> 文件是一个内存棒的完整内容的 <code>镜像</code>。它不能作为文件复制到目标设备上。有几个应用程序可用于将 <code>*.img</code> 写入 USB 内存棒。本节介绍其中两个实用程序。</p>
</div>
<div class="admonitionblock important">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>在继续之前，请备份 U 盘上的任何重要数据。此操作将擦除 U 盘上的现有数据。</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div id="bsdinstall-usb-dd" class="exampleblock procedure">
<div class="content">
<div class="paragraph">
<p><strong>步骤 使用 <code>dd</code> 命令写入镜像</strong><br/></p>
</div>
<div class="admonitionblock warning">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>这个例子使用 <code>/dev/da0</code> 作为目标设备，镜像将被写入其中。请 <strong>非常小心</strong> 确保使用正确的设备，因为这个命令会破坏指定目标设备上的现有数据。</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>命令行实用程序可在 BSD、Linux® 和 Mac OS® 系统上使用。要使用 <code>dd</code> 烧录镜像，请插入 USB 闪存并确定其设备名称。然后，指定下载的安装文件的名称和 USB 闪存的设备名称。此示例将 amd64 安装镜像烧录到现有的 FreeBSD 系统上的第一个 USB 设备。</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># dd if=FreeBSD-13.1-RELEASE-amd64-memstick.img of=/dev/da0 bs=1M conv=sync</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>如果此命令失败，请验证 USB 存储设备是否挂载，并且设备名称是磁盘而不是分区。</p>
</div>
<div class="paragraph">
<p>某些操作系统可能需要使用 <a href="https://man.freebsd.org/cgi/man.cgi?query=sudo&amp;sektion=8&amp;format=html">sudo(8)</a> 命令来运行此命令。<a href="https://man.freebsd.org/cgi/man.cgi?query=dd&amp;sektion=1&amp;format=html">dd(1)</a> 的语法在不同的平台上略有不同；例如，Mac OS® 需要使用小写的 <code>bs = 1m</code>。像 Linux® 这样的系统可能会缓冲写入操作。要强制完成所有写入操作，请使用 <a href="https://man.freebsd.org/cgi/man.cgi?query=sync&amp;sektion=8&amp;format=html">sync(8)</a> 命令。</p>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="exampleblock procedure">
<div class="content">
<div class="ulist">
<ul>
<li>
<p>步骤。使用 Windows® 写入镜像 *<br/></p>
</li>
</ul>
</div>
<div class="admonitionblock warning">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>请务必提供正确的驱动器字母，因为指定驱动器上的现有数据将被覆盖和销毁。</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>获取 Windows® 的图像写入器</strong></p>
<div class="paragraph">
<p>Image Writer for Windows® 是一个免费的应用程序，可以正确地将图像文件写入存储卡。从 <a href="https://sourceforge.net/projects/win32diskimager/">win32diskimager 主页</a> 下载并将其解压到一个文件夹中。</p>
</div>
</li>
<li>
<p><strong>使用 Writing the Image 写入镜像</strong></p>
<div class="paragraph">
<p>双击 Win32DiskImager 图标启动程序。确保在 <code>Device</code> 下显示的驱动器字母是存储器的驱动器。点击文件夹图标并选择要写入存储器的镜像。点击 <b class="button">Save</b> 接受镜像文件名。确认一切正确，并且存储器上没有其他窗口中打开的文件夹。当一切准备就绪时，点击 <b class="button">Write</b> 将镜像文件写入存储器。</p>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="bsdinstall-start">2.4. 开始安装<a class="anchor" href="#bsdinstall-start"></a></h3>
<div class="admonitionblock important">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>默认情况下，在以下消息之前，安装程序不会对磁盘进行任何更改：</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>Your changes will now be written to disk. If you
have chosen to overwrite existing data, it will
be PERMANENTLY ERASED. Are you sure you want to
commit your changes?</pre>
</div>
</div>
<div class="paragraph">
<p>在出现此警告之前，可以随时退出安装。如果担心某些配置不正确，只需在此之前关闭计算机，系统磁盘将不会进行任何更改。</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>本节描述了如何从使用 <a href="#bsdinstall-installation-media">准备安装介质</a> 中的说明准备的安装介质引导系统。使用可启动的 USB 闪存驱动器时，在打开计算机之前插入 USB 闪存驱动器。从 CD 或 DVD 引导时，应在第一时间打开计算机并插入介质。如何配置系统以从插入的介质引导取决于体系结构。</p>
</div>
<div class="sect3">
<h4 id="bsdinstall-view-probe">2.4.1. FreeBSD 启动菜单<a class="anchor" href="#bsdinstall-view-probe"></a></h4>
<div class="paragraph">
<p>一旦系统从安装介质启动，将显示类似以下的菜单：</p>
</div>
<div id="bsdinstall-newboot-loader-menu" class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/bsdinstall/bsdinstall-newboot-loader-menu.png" alt="FreeBSD 引导加载程序菜单"/>
</div>
<div class="title">图 1. FreeBSD 引导加载程序菜单</div>
</div>
<div class="paragraph">
<p>默认情况下，菜单将在启动 FreeBSD 安装程序之前等待十秒钟以等待用户输入，或者如果 FreeBSD 已经安装，则在启动 FreeBSD 之前等待十秒钟。要暂停启动计时器以查看选择项，请按下空格键。要选择一个选项，请按下其突出显示的数字、字符或键。以下选项可用。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>启动多用户模式（Boot Multi User）</code>：这将继续 FreeBSD 的启动过程。如果启动计时器已经暂停，请按下 <kbd>1</kbd>、大写或小写的 <kbd>B</kbd> 或 <kbd>Enter</kbd> 键。</p>
</li>
<li>
<p><code>单用户启动（Boot Single User）</code>: 这种模式可以用于修复已有的 FreeBSD 安装，如 <a href="./#boot-singleuser">”单用户模式“</a> 中所述。按下键盘上的 <kbd>2</kbd> 或大写或小写的 <kbd>S</kbd> 进入此模式。</p>
</li>
<li>
<p><code>进入加载器提示符（Escape to loader prompt）</code>: 这将使系统启动到一个包含有限数量低级命令的修复提示符。该提示符在 <a href="./#boot-loader">“Stage Three”</a> 中有描述。按下 <kbd>3</kbd> 或 <kbd>Esc</kbd> 键进入该提示符。</p>
</li>
<li>
<p><code>Reboot</code>：重新启动系统。</p>
</li>
<li>
<p><code>Cons</code>: 允许通过 <code>视频（video）</code>、<code>串口（serial）</code>、<code>双串口（串口为主）</code> 或 <code>双视频（视频为主）</code> 继续安装。</p>
</li>
<li>
<p><code>Kernel</code>: 加载一个不同的内核。</p>
</li>
<li>
<p><code>引导选项（Boot Options）</code> ：打开菜单，该菜单在 <a href="#bsdinstall-boot-options-menu">FreeBSD 启动选项菜单</a> 中显示并描述。</p>
</li>
</ul>
</div>
<div id="bsdinstall-boot-options-menu" class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/bsdinstall/bsdinstall-boot-options-menu.png" alt="显示支持的不同启动选项的菜单"/>
</div>
<div class="title">图 2. FreeBSD 启动选项菜单</div>
</div>
<div class="paragraph">
<p>启动选项菜单分为两个部分。第一部分可以用于返回主启动菜单或将任何切换选项重置为默认值。</p>
</div>
<div class="paragraph">
<p>下一节用于通过按下选项的突出显示的数字或字符来切换可用选项的状态为 <code>On</code> 或 <code>Off</code>。系统将始终使用这些选项的设置进行引导，直到它们被修改。可以使用此菜单切换多个选项的状态。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>ACPI 支持（ACPI Support）</code>: 如果系统在启动过程中出现卡死的情况，请尝试将此选项切换为 <code>Off</code>。</p>
</li>
<li>
<p><code>安全模式（Safe Mode）</code>：如果系统在启动时即使将 <code>ACPI Support</code> 设置为 <code>Off</code> 仍然出现卡顿的情况，请尝试将此选项设置为 <code>On</code>。</p>
</li>
<li>
<p><code>单用户模式（Single User）</code>：将此选项切换为 <code>On</code>，以修复现有的 FreeBSD 安装，如 <a href="./#boot-singleuser">“单用户模式”</a> 中所述。一旦问题解决，将其设置为 <code>Off</code>。</p>
</li>
<li>
<p><code>Verbose</code>：将此选项切换为 <code>On</code> 以在启动过程中显示更详细的消息。在排除硬件问题时，这可能会很有用。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>在进行所需的选择后，按下 <kbd>1</kbd> 或 <kbd>Backspace</kbd> 返回到主引导菜单，然后按下 <kbd>Enter</kbd> 继续引导进入 FreeBSD。FreeBSD 将执行其硬件设备探测和加载安装程序时，一系列引导消息将出现。引导完成后，将显示在 <a href="#bsdinstall-choose-mode">欢迎菜单</a> 中显示的欢迎菜单。</p>
</div>
<div id="bsdinstall-choose-mode" class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/bsdinstall/bsdinstall-choose-mode.png" alt="FreeBSD 安装欢迎菜单"/>
</div>
<div class="title">图 3. 欢迎菜单</div>
</div>
<div class="paragraph">
<p>按下 <kbd>Enter</kbd> 键选择默认的 <b class="button">Install</b> 按钮进入安装程序。本章的其余部分将描述如何使用此安装程序。否则，使用右箭头、左箭头或带颜色的字母选择所需的菜单项。<b class="button">Shell</b> 可用于访问 FreeBSD shell，以便在安装之前使用命令行实用程序准备磁盘。<b class="button">Live CD</b> 选项可用于在安装之前尝试 FreeBSD。有关 live 版本的详细信息，请参阅 <a href="#using-live-cd">使用 Live CD</a> 。</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>要查看启动消息，包括硬件设备探测，请按下大写或小写的 <kbd>S</kbd>，然后按下 <kbd>Enter</kbd> 以访问 shell。在 shell 提示符下，键入 <code>more /var/run/dmesg.boot</code>，使用空格键滚动浏览消息。完成后，键入 <code>exit</code> 返回欢迎菜单。</p>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="using-bsdinstall">2.5. 使用 bsdinstall<a class="anchor" href="#using-bsdinstall"></a></h3>
<div class="paragraph">
<p>本节展示了 bsdinstall 菜单的顺序以及在系统安装之前将要询问的信息类型。使用箭头键来突出显示菜单选项，然后使用 <kbd>Space</kbd> 来选择或取消选择该菜单项。完成后，按下 <kbd>Enter</kbd> 保存选择并进入下一个屏幕。</p>
</div>
<div class="sect3">
<h4 id="bsdinstall-keymap">2.5.1. 选择键映射菜单<a class="anchor" href="#bsdinstall-keymap"></a></h4>
<div class="paragraph">
<p>在开始过程之前， bsdinstall 将加载键盘映射文件，如 <a href="#bsdinstall-keymap-loading">按键映射加载中</a> 所示。</p>
</div>
<div id="bsdinstall-keymap-loading" class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/bsdinstall/bsdinstall-keymap-loading.png" alt="键位映射加载中"/>
</div>
<div class="title">图 4. 按键映射加载中</div>
</div>
<div class="paragraph">
<p>在加载了键位映射之后， bsdinstall 会显示如 <a href="#bsdinstall-keymap-10">按键映射选择菜单</a> 所示的菜单。使用上下箭头选择最接近系统连接的键盘映射的键位映射。按下 <kbd>Enter</kbd> 保存选择。</p>
</div>
<div id="bsdinstall-keymap-10" class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/bsdinstall/bsdinstall-keymap-10.png" alt="显示所有支持的键盘的按键映射选择菜单"/>
</div>
<div class="title">图 5. 按键映射选择菜单</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>按下 <kbd>Esc</kbd> 将退出此菜单并使用默认键映射。如果键映射的选择不明确，<span class="guimenuitem">United States of America ISO-8859-1</span> 也是一个安全的选项。</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>此外，在选择不同的键盘映射时，用户可以在继续之前尝试并确保它是正确的，如 <a href="#bsdinstall-keymap-testing">按键映射测试菜单</a> 所示。</p>
</div>
<div id="bsdinstall-keymap-testing" class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/bsdinstall/bsdinstall-keymap-testing.png" alt="按键映射测试菜单"/>
</div>
<div class="title">图 6. 按键映射测试菜单</div>
</div>
</div>
<div class="sect3">
<h4 id="bsdinstall-hostname">2.5.2. 设置主机名<a class="anchor" href="#bsdinstall-hostname"></a></h4>
<div class="paragraph">
<p>下一个 bsdinstall 菜单用于设置新安装系统的主机名。</p>
</div>
<div id="bsdinstall-config-hostname" class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/bsdinstall/bsdinstall-config-hostname.png" alt="设置主机名"/>
</div>
<div class="title">图 7. 设置主机名</div>
</div>
<div class="paragraph">
<p>输入一个在网络中唯一的主机名。它应该是一个完全合格的主机名，例如 <code>machine3.example.com</code> 。</p>
</div>
</div>
<div class="sect3">
<h4 id="bsdinstall-components">2.5.3. 选择要安装的组件<a class="anchor" href="#bsdinstall-components"></a></h4>
<div class="paragraph">
<p>接下来， bsdinstall 将提示选择要安装的可选组件。</p>
</div>
<div id="bsdinstall-config-components" class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/bsdinstall/bsdinstall-config-components.png" alt="可以安装的不同组件。示例：base-dbg" width="lib32" height="ports"/>
</div>
<div class="title">图 8. 选择要安装的组件</div>
</div>
<div class="paragraph">
<p>决定安装哪些组件将主要取决于系统的预期用途和可用的磁盘空间。 FreeBSD 内核和用户空间，统称为“基本系统”，始终会被安装。根据架构的不同，其中一些组件可能不会出现：</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>base-dbg</code> - 基本工具，如 cat 和 ls 等，其中包含启用了调试符号的工具。</p>
</li>
<li>
<p><code>kernel-dbg</code> - 启用了调试符号的内核和模块。</p>
</li>
<li>
<p><code>lib32-dbg</code> - 在启用调试符号的 64 位 FreeBSD 版本上运行 32 位应用程序的兼容库。</p>
</li>
<li>
<p><code>lib32</code> - 在 64 位版本的 FreeBSD 上运行 32 位应用程序的兼容性库。</p>
</li>
<li>
<p><code>ports</code> - FreeBSD Ports Collection 是一组文件，用于自动下载、编译和安装第三方软件包。 <a href="./#ports">安装应用程序：软件包和 Ports</a> 讨论了如何使用 Ports Collection。</p>
<div class="admonitionblock warning">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>安装程序不会检查磁盘空间是否足够。只有在有足够的硬盘空间时才选择此选项。 FreeBSD Ports 集合大约占用 3 GB 的磁盘空间。</p>
</div>
</td>
</tr>
</tbody></table>
</div>
</li>
<li>
<p><code>src</code> - 包含 FreeBSD 内核和用户空间的完整源代码。虽然大多数应用程序不需要它，但在构建设备驱动程序、内核模块或从 Ports Collection 中构建某些应用程序时可能需要它。它还用于开发 FreeBSD 本身。完整的源代码树需要 1 GB 的磁盘空间，重新编译整个 FreeBSD 系统需要额外的 5 GB 空间。</p>
</li>
<li>
<p><code>tests</code> - FreeBSD 测试套件。</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="bsdinstall-netinstall">2.5.4. 从网络安装<a class="anchor" href="#bsdinstall-netinstall"></a></h4>
<div class="paragraph">
<p>在 <a href="#bsdinstall-netinstall-notify">从网络安装</a> 中显示的菜单只会在从 <code>-bootonly.iso</code> 或 <code>-mini-memstick.img</code> 进行安装时出现，因为这种安装介质不保存安装文件的副本。由于安装文件必须通过网络连接获取，所以该菜单表示必须先配置网络接口。如果在过程的任何步骤中显示了该菜单，请记住按照 <a href="#bsdinstall-config-network-dev">配置网络接口</a> 中的说明进行操作。</p>
</div>
<div id="bsdinstall-netinstall-notify" class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/bsdinstall/bsdinstall-netinstall-files.png" alt="表示某些组件未找到，并将使用网络进行下载。"/>
</div>
<div class="title">图 9. 从网络安装</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="bsdinstall-partitioning">2.6. 分配磁盘空间<a class="anchor" href="#bsdinstall-partitioning"></a></h3>
<div class="paragraph">
<p>下一个菜单用于确定分配磁盘空间的方法。</p>
</div>
<div id="bsdinstall-zfs-partmenu" class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/bsdinstall/bsdinstall-zfs-partmenu.png" alt="显示不同的分区选项。示例：Manual" width="Shell" height="etc."/>
</div>
<div class="title">图 10. 分区选择</div>
</div>
<div class="paragraph">
<p>bsdinstall 为用户提供了四种分配磁盘空间的方法：</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Auto (ZFS)</code> 分区创建一个基于 ZFS 的系统，可选择支持 GELI 加密用于 <em>引导环境</em>。</p>
</li>
<li>
<p><code>Auto (UFS)</code> 分区是使用 <code>UFS</code> 文件系统自动设置磁盘分区的功能。</p>
</li>
<li>
<p><code>Manual</code> 分区允许高级用户通过菜单选项创建自定义分区。</p>
</li>
<li>
<p><code>Shell</code> 打开一个 shell 提示符，高级用户可以使用命令行工具（如 <a href="https://man.freebsd.org/cgi/man.cgi?query=gpart&amp;sektion=8&amp;format=html">gpart(8)</a>、<a href="https://man.freebsd.org/cgi/man.cgi?query=fdisk&amp;sektion=8&amp;format=html">fdisk(8)</a> 和 <a href="https://man.freebsd.org/cgi/man.cgi?query=bsdlabel&amp;sektion=8&amp;format=html">bsdlabel(8)</a>）创建自定义分区。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>本节描述了在布置磁盘分区时需要考虑的事项。然后演示了如何使用不同的分区方法。</p>
</div>
<div class="sect3">
<h4 id="configtuning-initial">2.6.1. 设计分区布局<a class="anchor" href="#configtuning-initial"></a></h4>
<div class="paragraph">
<p>文件系统的默认分区布局包括一个用于整个系统的文件系统。当使用 <code>UFS</code> 时，如果您有足够的磁盘空间或多个磁盘，考虑使用多个文件系统可能是值得的。在布置文件系统时，请记住硬盘从外部轨道到内部传输数据速度更快。因此，较小且访问频率较高的文件系统应该靠近驱动器的外部，而像 <code>/usr</code> 这样的较大分区应该放置在磁盘的内部部分。按照类似的顺序创建分区是一个好主意： <code>/</code> 、交换空间、<code>/var</code> 和 <code>/usr</code>。</p>
</div>
<div class="paragraph">
<p><code>/var</code> 分区的大小反映了预期机器的使用情况。该分区用于存储邮箱、日志文件和打印机队列。根据用户数量和日志文件保留时间的长短，邮箱和日志文件的大小可能会出乎意料地增长。通常情况下，大多数用户在 <code>/var</code> 分区中很少需要超过 1GB 的可用磁盘空间。</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>有时，在 <code>/var/tmp</code> 目录下需要大量的磁盘空间。当安装新软件时，打包工具会在 <code>/var/tmp</code> 目录下提取软件包的临时副本。如果 <code>/var/tmp</code> 目录下的磁盘空间不足，安装大型软件包（如 Firefox 或 LibreOffice ）可能会变得棘手。</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p><code>/usr</code> 分区存放着许多支持系统的文件，包括 FreeBSD Ports Collection 和系统源代码。建议为这个分区提供至少 2GB 的空间。此外，请注意，默认情况下，用户的家目录位于 <code>/usr/home</code> ，但也可以放在另一个分区上。默认情况下， <code>/home</code> 是指向 <code>/usr/home</code> 的符号链接。</p>
</div>
<div class="paragraph">
<p>在选择分区大小时，请考虑空间需求。在一个分区中空间不足，而另一个分区几乎未使用可能会带来麻烦。</p>
</div>
<div class="paragraph">
<p>作为一个经验法则，交换分区的大小应该是物理内存（RAM）的两倍左右。具有较小内存的系统（对于较大内存配置来说更少）可能在有更多交换空间时性能更好。配置过少的交换空间可能导致虚拟内存页面扫描代码的低效，并且如果添加更多内存后可能会引发问题。</p>
</div>
<div class="paragraph">
<p>在具有多个 SCSI 磁盘或多个在不同控制器上运行的 IDE 磁盘的较大系统上，建议在每个驱动器上配置交换空间，最多四个驱动器。交换分区的大小应该大致相同。内核可以处理任意大小，但内部数据结构会按照最大交换分区的 4 倍进行扩展。保持交换分区的大小接近相同，可以让内核以最佳方式在不同磁盘间条带化交换空间。较大的交换大小可能会引发有关总配置交换的内核警告消息。通过增加用于跟踪交换分配的内存量来提高限制，如警告消息所指示的那样。在被迫重新启动之前，从失控的程序中恢复可能更容易。</p>
</div>
<div class="paragraph">
<p>通过正确地分区系统，较小的写入密集分区引入的碎片不会波及到主要读取分区。将写入负载较重的分区保持在磁盘边缘附近，将提高在这些分区中发生的 I/O 性能。虽然可能需要较大分区的 I/O 性能，但将它们更靠近磁盘边缘不会比将 <code>/var</code> 移动到边缘带来显著的性能改善。</p>
</div>
</div>
<div class="sect3">
<h4 id="bsdinstall-part-guided">2.6.2. 使用 UFS 进行引导分区<a class="anchor" href="#bsdinstall-part-guided"></a></h4>
<div class="paragraph">
<p>当选择此方法时，菜单将显示可用的磁盘。如果连接了多个磁盘，请选择要安装 FreeBSD 的磁盘。</p>
</div>
<div id="bsdinstall-part-guided-disk" class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/bsdinstall/bsdinstall-part-guided-disk.png" alt="显示可以安装 FreeBSD 的磁盘列表"/>
</div>
<div class="title">图 11. 从多个磁盘中进行选择</div>
</div>
<div class="paragraph">
<p>选择磁盘后，下一个菜单会提示选择是将整个磁盘安装，还是使用可用空间创建分区。如果选择 <b class="button">Entire Disk</b> ，将自动创建一个填满整个磁盘的通用分区布局。选择 <b class="button">Partition</b> 将从磁盘上未使用的空间创建一个分区布局。</p>
</div>
<div id="bsdinstall-part-entire-part" class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/bsdinstall/bsdinstall-part-entire-part.png" alt="菜单询问用户是否想要使用磁盘上的所有可用空间，还是想要进行分区。"/>
</div>
<div class="title">图 12. 选择整个磁盘或分区</div>
</div>
<div class="paragraph">
<p>选择 <b class="button">Entire Disk</b> 选项后，bsdinstall 会显示一个对话框，指示将擦除磁盘。</p>
</div>
<div id="bsdinstall-ufs-warning" class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/bsdinstall/bsdinstall-ufs-warning.png" alt="菜单提示用户所有磁盘上的数据将被删除，并要求确认。"/>
</div>
<div class="title">图 13. 确认</div>
</div>
<div class="paragraph">
<p>下一个菜单显示了可用的分区方案类型列表。对于 amd64 计算机来说， GPT 通常是最合适的选择。不兼容 GPT 的旧计算机应该使用 MBR。其他分区方案通常用于不常见或较旧的计算机。有关更多信息，请参阅 <a href="#partition-schemes">分区方案</a> 。</p>
</div>
<div id="bsdinstall-ufs-scheme" class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/bsdinstall/bsdinstall-part-manual-partscheme.png" alt="菜单显示用户存在的不同类型的分区，并要求选择其中之一"/>
</div>
<div class="title">图 14. 选择分区方案</div>
</div>
<div class="paragraph">
<p>在创建分区布局之后，请进行审核以确保它满足安装的需求。选择 <b class="button">Revert</b> 将重置分区为其原始值。按下 <b class="button">Auto</b> 将重新创建自动的 FreeBSD 分区。分区也可以手动创建、修改或删除。当分区设置正确时，请选择 <b class="button">Finish</b> 继续进行安装。</p>
</div>
<div id="bsdinstall-part-review" class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/bsdinstall/bsdinstall-part-review.png" alt="显示已创建分区的菜单"/>
</div>
<div class="title">图 15. 审查已创建的分区</div>
</div>
<div class="paragraph">
<p>一旦磁盘配置完成，下一个菜单提供了在选择的驱动器格式化之前进行更改的最后机会。如果需要进行更改，请选择 <b class="button">返回</b> 返回到主分区菜单。 <b class="button">还原和退出</b> 退出安装程序，不对驱动器进行任何更改。否则，选择 <b class="button">提交</b> 开始安装过程。</p>
</div>
<div id="bsdinstall-ufs-final-confirmation" class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/bsdinstall/bsdinstall-final-confirmation.png" alt="菜单向用户指示所有更改将被写入磁盘，并告知如果用户决定继续，现有数据将被永久删除。"/>
</div>
<div class="title">图 16. 最终确认</div>
</div>
<div class="paragraph">
<p>要继续安装过程，请转到 <a href="#bsdinstall-fetching-distribution">获取分发文件</a> 。</p>
</div>
</div>
<div class="sect3">
<h4 id="bsdinstall-part-manual">2.6.3. 手动分区<a class="anchor" href="#bsdinstall-part-manual"></a></h4>
<div class="paragraph">
<p>选择此方法将打开分区编辑器：</p>
</div>
<div id="bsdinstall-part-manual-create" class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/bsdinstall/bsdinstall-part-manual-create.png" alt="显示分区编辑器的菜单。"/>
</div>
<div class="title">图 17. 手动创建分区</div>
</div>
<div class="paragraph">
<p>高亮显示安装驱动器（在此示例中为 <code>ada0</code>），然后选择 <b class="button">Create</b> 以显示可用分区方案的菜单：</p>
</div>
<div id="bsdinstall-part-manual-partscheme" class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/bsdinstall/bsdinstall-part-manual-partscheme.png" alt="菜单显示了不同类型的分区方案"/>
</div>
<div class="title">图 18. 手动创建分区</div>
</div>
<div class="paragraph">
<p>GPT 通常是 amd64 计算机的最合适选择。不兼容 GPT 的旧计算机应使用 MBR。其他分区方案通常用于不常见或较旧的计算机。</p>
</div>
<table id="partition-schemes" class="tableblock frame-none grid-all stretch">
<caption class="title">表 1. 分区方案</caption>
<colgroup>
<col style="width: 25%;"/>
<col/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">缩写</th>
<th class="tableblock halign-left valign-top">描述</th>
</tr>
</thead>
<tbody>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">APM</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">Apple Partition Map，由 PowerPC® 使用。</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">BSD</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">没有 MBR 的 BSD 标签，有时被称为 <em>危险专用模式</em>，因为非 BSD 磁盘工具可能无法识别它。</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">GPT</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://en.wikipedia.org/wiki/GUID_Partition_Table">GUID 分区表</a> 。</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">MBR</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://en.wikipedia.org/wiki/Master_boot_record">主引导记录</a> 。</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>在选择和创建分区方案之后，再次选择 <b class="button">Create</b> 来创建分区。使用 <kbd>Tab</kbd> 键将焦点放在字段上（在循环通过 <b class="button">&lt;OK&gt;</b> 、 <b class="button">&lt;Options&gt;</b> 和 <b class="button">&lt;Cancel&gt;</b> 之后）。</p>
</div>
<div id="bsdinstall-part-manual-addpart" class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/bsdinstall/bsdinstall-part-manual-addpart.png" alt="请求类型菜单" width="size" height="mountpoint and label for the new partition."/>
</div>
<div class="title">图 19. 手动创建分区</div>
</div>
<div class="paragraph">
<p>标准的 FreeBSD GPT 安装至少使用三个分区，其中包括 UFS 或 ZFS 之一：</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>freebsd-boot</code> 或 <code>efi</code> - 存放着 FreeBSD 的引导代码。</p>
</li>
<li>
<p><code>freebsd-ufs</code> - 一个 FreeBSD UFS 文件系统。</p>
</li>
<li>
<p><code>freebsd-zfs</code> - 一个 FreeBSD 的 ZFS 文件系统。有关 ZFS 的更多信息，请参阅 <a href="./#zfs">Z 文件系统（ZFS）</a> 。</p>
</li>
<li>
<p><code>freebsd-swap</code> - FreeBSD 交换空间。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>请参考 <a href="https://man.freebsd.org/cgi/man.cgi?query=gpart&amp;sektion=8&amp;format=html">gpart(8)</a>，了解可用的 GPT 分区类型的描述。</p>
</div>
<div class="paragraph">
<p>可以创建多个文件系统分区。有些人喜欢传统的布局，将 <code>/</code>、<code>/var</code>、<code>/tmp</code> 和 <code>/usr</code> 分别放在不同的分区中。</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>请注意，在具有足够内存的系统上，可以将 <code>/tmp</code> 作为基于内存的文件系统（<a href="https://man.freebsd.org/cgi/man.cgi?query=tmpfs&amp;sektion=5&amp;format=html">tmpfs(5)</a>）添加。</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>请参考 <a href="#bsdinstall-part-manual-splitfs">创建传统的分割文件系统分区</a> 中的示例。</p>
</div>
<div class="paragraph">
<p><code>Size</code> 可以使用常见的缩写进行输入：<em>K</em> 表示千字节，<em>M</em> 表示兆字节，<em>G</em> 表示吉字节。</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>正确的扇区对齐可以提供最佳性能，将分区大小设置为 4K 字节的倍数有助于确保在具有 512 字节或 4K 字节扇区的驱动器上进行对齐。通常，使用 1M 或 1G 的倍数作为分区大小是确保每个分区从 4K 的倍数开始的最简单方法。有一个例外：由于当前引导代码的限制，<em>freebsd-boot</em> 分区的大小不应超过 512K 。</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>如果分区将包含文件系统，则需要一个 <code>Mountpoint</code> 。如果只创建一个 UFS 分区，则挂载点应为 <code>/</code>。</p>
</div>
<div class="paragraph">
<p><code>Label</code> 是分区的名称。如果驱动器连接到不同的控制器或端口，驱动器名称或编号可能会发生变化，但分区标签不会改变。在像 <code>/etc/fstab</code> 这样的文件中使用标签而不是驱动器名称和分区编号，可以使系统更容忍硬件变化。当连接了磁盘时，GPT 标签会出现在 <code>/dev/gpt/</code> 中。其他分区方案具有不同的标签功能，它们的标签会出现在 <code>/dev/</code> 中的不同目录中。</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>在每个分区上使用唯一的标签，以避免相同标签引起的冲突。可以在标签中添加计算机名称、用途或位置的几个字母。例如，对于名为 <code>lab</code> 的计算机上的 UFS 根分区，可以使用 <code>labroot</code> 或 <code>rootfslab</code> 作为标签。</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div id="bsdinstall-part-manual-splitfs" class="exampleblock">
<div class="title">例 1. 创建传统的分割文件系统分区</div>
<div class="content">
<div class="paragraph">
<p>对于传统的分区布局，其中 <code>/</code>、<code>/var</code>、<code>/tmp</code> 和 <code>/usr</code> 目录是各自独立的文件系统，创建一个 GPT 分区方案，然后按照所示创建分区。所示的分区大小适用于 20G 目标磁盘。如果目标磁盘上有更多的空间，可以考虑使用更大的交换空间或 <code>/var</code> 分区。这里显示的标签以 <code>ex</code> 为前缀，表示&#34;示例&#34;，但读者应根据上述说明使用其他唯一的标签值。</p>
</div>
<div class="paragraph">
<p>默认情况下，FreeBSD 的 <code>gptboot</code> 期望第一个 UFS 分区是 <code>/</code> 分区。</p>
</div>
<table class="tableblock frame-none grid-all stretch informaltable">
<colgroup>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">分区类型</th>
<th class="tableblock halign-left valign-top">大小</th>
<th class="tableblock halign-left valign-top">挂载点</th>
<th class="tableblock halign-left valign-top">标签</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>freebsd-boot</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>512K</code></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>freebsd-ufs</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>2G</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>exrootfs</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>freebsd-swap</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>4G</code></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">`</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>freebsd-ufs</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>2G</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/var</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>exvarfs</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>freebsd-ufs</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>1G</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/tmp</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>extmpfs</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>freebsd-ufs</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">接受默认选项（使用磁盘的剩余空间）。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/usr</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>exusrfs</code></p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="paragraph">
<p>在创建自定义分区后，选择 <b class="button">Finish</b> 继续安装并转到 <a href="#bsdinstall-fetching-distribution">获取分发文件</a> 。</p>
</div>
</div>
<div class="sect3">
<h4 id="bsdinstall-part-zfs">2.6.4. 使用 Root-on-ZFS 进行引导分区<a class="anchor" href="#bsdinstall-part-zfs"></a></h4>
<div class="paragraph">
<p>这种分区模式只适用于整个磁盘，并且会擦除整个磁盘的内容。主要的 ZFS 配置菜单提供了一些选项来控制池的创建。</p>
</div>
<div id="bsdinstall-zfs-menu" class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/bsdinstall/bsdinstall-zfs-menu.png" alt="显示配置 ZFS 池的不同选项的菜单"/>
</div>
<div class="title">图 20. ZFS 分区菜单</div>
</div>
<div class="paragraph">
<p>这是该菜单中选项的摘要：</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>安装（Install）</code> - 使用所选选项继续安装。</p>
</li>
<li>
<p>` 池类型及磁盘（Pool Type/Disks）` - 配置 <code>池类型</code> 和组成池的磁盘。自动 ZFS 安装程序目前只支持创建单个顶级 vdev，除非是 stripe 模式。要创建更复杂的池，请使用 <a href="#bsdinstall-part-shell">Shell 模式分区</a> 中的说明来创建池。</p>
</li>
<li>
<p><code>重新扫描设备（Rescan Devices）</code> - 重新填充可用磁盘列表。</p>
</li>
<li>
<p><code>磁盘信息（Disk Info）</code> - 此菜单可用于检查每个磁盘，包括其分区表和其他各种信息，如设备型号和序列号（如果可用）。</p>
</li>
<li>
<p><code>池名称（Pool Name）</code> - 设置池的名称。默认名称为 <em>zroot</em>。</p>
</li>
<li>
<p><code>强制使用 4K 扇区（Force 4K Sectors）？</code> - 强制使用 4K 扇区。默认情况下，安装程序将自动创建与 4K 边界对齐的分区，并强制 ZFS 使用 4K 扇区。即使是 512 字节扇区的磁盘，这也是安全的，并且还有一个额外的好处，即确保在将来可以将 4K 扇区磁盘添加到在 512 字节磁盘上创建的池中，无论是作为额外的存储空间还是作为替换失败的磁盘。按下 <kbd>Enter</kbd> 键选择是否激活它。</p>
</li>
<li>
<p><code>加密磁盘（Encrypt Disks）？</code> - 加密磁盘允许用户使用 GELI 对磁盘进行加密。有关磁盘加密的更多信息，请参阅 <a href="./#disks-encrypting-geli">“使用 geli 进行磁盘加密”</a>。按下 <kbd>Enter</kbd> 键选择是否激活它。</p>
</li>
<li>
<p><code>分区方案（Partition Scheme）</code> - 选择分区方案。在大多数情况下，GPT 是推荐的选项。按下 <kbd>Enter</kbd> 键来在不同选项之间进行选择。</p>
</li>
<li>
<p><code>交换空间大小（Swap Size）</code> - 设置交换空间的大小。</p>
</li>
<li>
<p><code>镜像交换分区（Mirror Swap）？</code> - 是否在磁盘之间进行交换分区的镜像。请注意，启用镜像交换分区将会破坏崩溃转储。按下 <kbd>Enter</kbd> 键来激活或不激活。</p>
</li>
<li>
<p><code>加密交换空间（Encrypt Swap）？</code> - 是否加密交换空间。这将在每次系统启动时使用临时密钥加密交换空间，并在重新启动时丢弃它。按下 <kbd>Enter</kbd> 键选择是否激活。有关加密交换空间的更多信息，请参阅 <a href="./#swap-encrypting">“加密交换空间”</a> 。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>选择 <kbd>T</kbd> 来配置 <code>池类型</code> 和组成池的磁盘。</p>
</div>
<div id="bsdinstall-zfs-vdev_type" class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/bsdinstall/bsdinstall-zfs-vdev_type.png" alt="请求虚拟设备类型的菜单。例如：stripe" width="mirror" height="raidz1"/>
</div>
<div class="title">图 21. ZFS 池类型</div>
</div>
<div class="paragraph">
<p>这是一个关于此菜单中可选择的 <code>池类型</code> 的摘要：</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>stripe</code> - 条带化提供了最大的存储空间，但没有冗余。如果只有一个磁盘故障，池中的数据将无法恢复。</p>
</li>
<li>
<p><code>镜像（mirror）</code> - 镜像将所有数据完整地存储在每个磁盘上。镜像提供良好的读取性能，因为数据可以并行从所有磁盘中读取。写入性能较慢，因为数据必须写入池中的所有磁盘。允许除一个磁盘外的所有磁盘故障。此选项至少需要两个磁盘。</p>
</li>
<li>
<p><code>raid10</code> - 镜像条带化。提供最佳性能，但存储空间最少。此选项至少需要偶数个磁盘和至少四个磁盘。</p>
</li>
<li>
<p><code>raidz1</code> - 单冗余 RAID 。允许同时故障一个磁盘。此选项至少需要三个磁盘。</p>
</li>
<li>
<p><code>raidz2</code> - 双冗余 RAID 。允许同时故障两个磁盘。此选项至少需要四个磁盘。</p>
</li>
<li>
<p><code>raidz3</code> - 三重冗余 RAID 。允许同时故障三个磁盘。此选项至少需要五个磁盘。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>一旦选择了 <code>池类型</code>，将显示可用磁盘列表，并提示用户选择一个或多个磁盘来组成池。然后，将验证配置以确保选择了足够的磁盘。如果验证失败，请选择 <b class="button">&lt;Change Selection&gt;</b> 返回到磁盘列表，或选择 <b class="button">&lt;Back&gt;</b> 更改 <code>池类型</code>。</p>
</div>
<div id="bsdinstall-zfs-disk_select" class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/bsdinstall/bsdinstall-zfs-disk_select.png" alt="菜单请求添加多少个磁盘到池中"/>
</div>
<div class="title">图 22. 磁盘选择</div>
</div>
<div id="bsdinstall-zfs-vdev_invalid" class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/bsdinstall/bsdinstall-zfs-vdev_invalid.png" alt="菜单指示未选择足够的磁盘。"/>
</div>
<div class="title">图 23. 无效选择</div>
</div>
<div class="paragraph">
<p>如果列表中缺少一个或多个磁盘，或者在启动安装程序后附加了磁盘，请选择 <b class="button">- Rescan Devices</b> 以重新填充可用磁盘列表。</p>
</div>
<div id="bsdinstall-zfs-rescan-devices" class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/bsdinstall/bsdinstall-zfs-rescan-devices.png" alt="设备重新扫描"/>
</div>
<div class="title">图 24. 重新扫描设备</div>
</div>
<div class="paragraph">
<p>为了避免意外擦除错误的磁盘，可以使用 <b class="button">- Disk Info</b> 菜单来检查每个磁盘，包括其分区表和其他各种信息，如设备型号和序列号（如果有）。</p>
</div>
<div id="bsdinstall-zfs-disk_info" class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/bsdinstall/bsdinstall-zfs-disk_info.png" alt="显示分区信息的菜单。"/>
</div>
<div class="title">图 25. 分析磁盘</div>
</div>
<div class="paragraph">
<p>选择 <kbd>N</kbd> 来配置 <code>池名称</code>。输入所需的名称，然后选择 <b class="button">&lt;OK&gt;</b> 来确认，或选择 <b class="button">&lt;Cancel&gt;</b> 返回主菜单并保留默认名称。</p>
</div>
<div id="bsdinstall-zfs-pool-name" class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/bsdinstall/bsdinstall-zfs-pool-name.png" alt="请求输入池的名称的菜单。"/>
</div>
<div class="title">图 26. 池名称</div>
</div>
<div class="paragraph">
<p>选择 <kbd>S</kbd> 来设置交换空间的大小。输入所需的交换空间大小，然后选择 <b class="button">&lt;OK&gt;</b> 来确认设置，或选择 <b class="button">&lt;Cancel&gt;</b> 返回主菜单并使用默认大小。</p>
</div>
<div id="bsdinstall-zfs-swap-amount" class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/bsdinstall/bsdinstall-zfs-swap-amount.png" alt="请求交换内存的数量的菜单"/>
</div>
<div class="title">图 27. 交换空间大小</div>
</div>
<div class="paragraph">
<p>一旦所有选项都设置为所需的值，选择菜单顶部的 <b class="button">&gt;&gt;&gt; Install</b> 选项。然后安装程序会在销毁所选驱动器的内容以创建 ZFS 池之前，提供最后一次取消的机会。</p>
</div>
<div id="bsdinstall-zfs-warning" class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/bsdinstall/bsdinstall-zfs-warning.png" alt="菜单提示用户数据将会丢失。"/>
</div>
<div class="title">图 28. 最后机会</div>
</div>
<div class="paragraph">
<p>如果启用了 GELI 磁盘加密，安装程序将会两次提示输入用于加密磁盘的密码短语。然后，加密的初始化过程开始。</p>
</div>
<div id="bsdinstall-zfs-geli_password" class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/bsdinstall/bsdinstall-zfs-geli_password.png" alt="要求输入密码以加密设备的菜单。"/>
</div>
<div class="title">图 29. 磁盘加密密码</div>
</div>
<div id="bsdinstall-zfs-init-encription" class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/bsdinstall/bsdinstall-zfs-init-encription.png" alt="菜单显示加密正在初始化。"/>
</div>
<div class="title">图 30. 初始化加密</div>
</div>
<div class="paragraph">
<p>安装然后正常进行。要继续安装，请转到 <a href="#bsdinstall-fetching-distribution">获取分发文件</a> 。</p>
</div>
</div>
<div class="sect3">
<h4 id="bsdinstall-part-shell">2.6.5. Shell 模式分区<a class="anchor" href="#bsdinstall-part-shell"></a></h4>
<div class="paragraph">
<p>在创建高级安装时，bsdinstall 分区菜单可能无法提供所需的灵活性水平。高级用户可以从分区菜单中选择 <b class="button">Shell</b> 选项，以手动分区驱动器，创建文件系统，填充 <code>/tmp/bsdinstall_etc/fstab</code> ，并将文件系统挂载到 <code>/mnt</code> 下。完成后，输入 <code>exit</code> 返回到 bsdinstall 并继续安装。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="bsdinstall-fetching-distribution">2.7. 获取分发文件<a class="anchor" href="#bsdinstall-fetching-distribution"></a></h3>
<div class="paragraph">
<p>安装时间将根据所选择的发行版、安装介质和计算机速度而有所不同。一系列的消息将指示安装的进度。</p>
</div>
<div class="paragraph">
<p>首先，安装程序会格式化所选磁盘并初始化分区。接下来，在选择了 <code>仅引导媒体</code> 或 <code>迷你内存棒</code> 的情况下，它会下载所选组件：</p>
</div>
<div id="bsdinstall-distfile-fetching" class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/bsdinstall/bsdinstall-distfile-fetching.png" alt="菜单显示了不同组件的下载。"/>
</div>
<div class="title">图 31. 获取分发文件</div>
</div>
<div class="paragraph">
<p>接下来，将验证分发文件的完整性，以确保在下载过程中没有损坏或在安装介质中读取错误：</p>
</div>
<div id="bsdinstall-distfile-verify" class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/bsdinstall/bsdinstall-distfile-verifying.png" alt="显示不同组件的验证菜单。"/>
</div>
<div class="title">图 32. 验证分发文件</div>
</div>
<div class="paragraph">
<p>最后，验证过的分发文件被解压到磁盘上：</p>
</div>
<div id="bsdinstall-distfile-extract" class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/bsdinstall/bsdinstall-distfile-extracting.png" alt="菜单显示了不同组件的提取过程。"/>
</div>
<div class="title">图 33. 提取分发文件</div>
</div>
<div class="paragraph">
<p>一旦提取了所有请求的分发文件， bsdinstall 将显示第一个安装后配置屏幕。下一节将介绍可用的后配置选项。</p>
</div>
</div>
<div class="sect2">
<h3 id="bsdinstall-post">2.8. 网络接口，账户，时区，服务和加固<a class="anchor" href="#bsdinstall-post"></a></h3>
<div class="sect3">
<h4 id="bsdinstall-post-root">2.8.1. 设置 <code>root</code> 密码<a class="anchor" href="#bsdinstall-post-root"></a></h4>
<div class="paragraph">
<p>首先，必须设置 <code>root</code> 密码。在输入密码时，屏幕上不会显示正在输入的字符。为了防止输入错误，密码必须输入两次。</p>
</div>
<div id="bsdinstall-post-set-root-passwd" class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/bsdinstall/bsdinstall-post-root-passwd.png" alt="显示要求输入 root 用户密码的菜单。"/>
</div>
<div class="title">图 34. 设置 <code>root</code> 密码</div>
</div>
</div>
<div class="sect3">
<h4 id="bsdinstall-config-network-dev">2.8.2. 配置网络接口<a class="anchor" href="#bsdinstall-config-network-dev"></a></h4>
<div class="paragraph">
<p>接下来，将显示计算机上找到的网络接口列表。请选择要配置的接口。</p>
</div>
<div id="bsdinstall-configure-net-interface" class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/bsdinstall/bsdinstall-configure-network-interface.png" alt="显示不同网络接口以进行配置的菜单。"/>
</div>
<div class="title">图 35. 选择一个网络接口</div>
</div>
<div class="paragraph">
<p>如果选择了以太网接口，安装程序将直接跳转到 <a href="#bsdinstall-configure-net-ipv4">选择 IPv4 网络</a> 中显示的菜单。如果选择了无线网络接口，系统将会扫描无线接入点：</p>
</div>
<div id="bsdinstall-wireless-scan" class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/bsdinstall/bsdinstall-configure-wireless-scan.png" alt="显示无线网络扫描的菜单。"/>
</div>
<div class="title">图 36. 扫描无线接入点</div>
</div>
<div class="paragraph">
<p>无线网络通过服务集标识符（SSID）进行识别，每个网络都有一个短而独特的名称。扫描期间找到的 SSID 将列出，然后是该网络可用的加密类型的描述。如果所需的 SSID 在列表中未出现，请选择 <b class="button">Rescan</b> 进行再次扫描。如果所需的网络仍未出现，请检查天线连接是否有问题，或尝试将计算机移动到接入点附近。每次更改后都要重新扫描。</p>
</div>
<div id="bsdinstall-wireless-accesspoints" class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/bsdinstall/bsdinstall-configure-wireless-accesspoints.png" alt="显示可连接的不同无线网络的菜单。"/>
</div>
<div class="title">图 37. 选择无线网络</div>
</div>
<div class="paragraph">
<p>接下来，请输入连接到所选无线网络的加密信息。强烈建议使用 WPA2 加密，而不是较旧的加密类型，如 WEP ，因为 WEP 提供的安全性很低。如果网络使用 WPA2，请输入密码，也称为预共享密钥（PSK）。出于安全原因，输入框中键入的字符将显示为星号。</p>
</div>
<div id="bsdinstall-wireless-wpa2" class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/bsdinstall/bsdinstall-configure-wireless-wpa2setup.png" alt="请求无线网络密码的菜单。"/>
</div>
<div class="title">图 38. WPA2 设置</div>
</div>
<div class="paragraph">
<p>接下来，选择是否在以太网或无线接口上配置 IPv4 地址：</p>
</div>
<div id="bsdinstall-configure-net-ipv4" class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/bsdinstall/bsdinstall-configure-network-interface-ipv4.png" alt="菜单指示是否要为所选接口配置 IPv4 。"/>
</div>
<div class="title">图 39. 选择 IPv4 网络</div>
</div>
<div class="paragraph">
<p>IPv4 配置有两种方法。如果网络提供了 DHCP 服务器，DHCP 将自动正确配置网络接口，并且应该使用 DHCP。否则，需要手动输入地址信息作为静态配置。</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>请不要输入随机的网络信息，因为它不会起作用。如果没有 DHCP 服务器可用，请向网络管理员或互联网服务提供商获取 <a href="#bsdinstall-collect-network-information">所需网络信息</a> 中列出的信息。</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>如果有 DHCP 服务器可用，请在下一个菜单中选择 <b class="button">Yes</b> 以自动配置网络接口。安装程序将会暂停一分钟左右，以便找到 DHCP 服务器并获取系统的地址信息。</p>
</div>
<div id="bsdinstall-net-ipv4-dhcp" class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/bsdinstall/bsdinstall-configure-network-interface-ipv4-dhcp.png" alt="菜单指示是否要为所选接口配置 DHCP 。"/>
</div>
<div class="title">图 40. 选择 IPv4 DHCP 配置</div>
</div>
<div class="paragraph">
<p>如果没有可用的 DHCP 服务器，请选择 <b class="button">No</b>，并在此菜单中输入以下寻址信息：</p>
</div>
<div id="bsdinstall-net-ipv4-static" class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/bsdinstall/bsdinstall-configure-network-interface-ipv4-static.png" alt="请求配置 IPv4 网络的菜单。"/>
</div>
<div class="title">图 41. IPv4 静态配置</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>IP 地址（IP Address）</code> - 分配给此计算机的 IPv4 地址。该地址必须是唯一的，并且在本地网络上没有被其他设备使用。</p>
</li>
<li>
<p><code>子网掩码（Subnet Mask）</code> - 网络的子网掩码。</p>
</li>
<li>
<p><code>默认路由器（Default Router）</code> - 网络的默认网关的 IP 地址。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>下一个屏幕将询问是否应该为 IPv6 配置接口。如果 IPv6 可用且需要，请选择 <b class="button">Yes</b> 来选择它。</p>
</div>
<div id="bsdinstall-net-ipv6" class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/bsdinstall/bsdinstall-configure-network-interface-ipv6.png" alt="菜单指示是否要为所选接口配置 IPv6 。"/>
</div>
<div class="title">图 42. 选择 IPv6 网络</div>
</div>
<div class="paragraph">
<p>IPv6 还有两种配置方法。无状态地址自动配置（SLAAC）将自动从本地路由器请求正确的配置信息。有关更多信息，请参阅 <a href="http://tools.ietf.org/html/rfc4862">rfc4862</a>。静态配置需要手动输入网络信息。</p>
</div>
<div class="paragraph">
<p>如果有 IPv6 路由器可用，请在下一个菜单中选择 <b class="button">Yes</b> 以自动配置网络接口。安装程序将会暂停一分钟左右，以查找路由器并获取系统的寻址信息。</p>
</div>
<div id="bsdinstall-net-ipv6-slaac" class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/bsdinstall/bsdinstall-configure-network-interface-slaac.png" alt="菜单指示是否要为所选接口配置 SLAAC 。"/>
</div>
<div class="title">图 43. 选择 IPv6 SLAAC 配置</div>
</div>
<div class="paragraph">
<p>如果没有可用的 IPv6 路由器，请选择 <b class="button">No</b> 并在此菜单中输入以下寻址信息：</p>
</div>
<div id="bsdinstall-net-ipv6-static" class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/bsdinstall/bsdinstall-configure-network-interface-ipv6-static.png" alt="菜单请求配置 IPv6 网络的数据。"/>
</div>
<div class="title">图 44. IPv6 静态配置</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>IPv6 地址（IPv6 Address）</code> - 分配给此计算机的 IPv6 地址。该地址必须是唯一的，并且在本地网络中没有被其他设备使用。</p>
</li>
<li>
<p><code>默认路由器（Default Router）</code> - 网络的默认网关的 IPv6 地址。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>最后一个网络配置菜单用于配置域名系统（DNS）解析器，该解析器将主机名转换为网络地址，并且可以将网络地址转换为主机名。如果使用 DHCP 或 SLAAC 自动配置网络接口，则 <code>解析器配置（Resolver Configuration）</code> 值可能已经填写。否则，请在 <code>搜索（Search）</code> 字段中输入本地网络的域名。<code>DNS #1</code> 和 <code>DNS #2</code> 是 DNS 服务器的 IPv4 和 / 或 IPv6 地址。至少需要一个 DNS 服务器。</p>
</div>
<div id="bsdinstall-net-dns-config" class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/bsdinstall/bsdinstall-configure-network-ipv4-dns.png" alt="菜单请求数据以配置网络的 DNS 。"/>
</div>
<div class="title">图 45. DNS 配置</div>
</div>
<div class="paragraph">
<p>一旦配置了接口，选择一个位于与安装 FreeBSD 的计算机相同地区的镜像站点。当镜像站点靠近目标计算机时，可以更快地检索文件，从而减少安装时间。</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>选择 <code><a href="ftp://ftp.freebsd.org" class="bare">ftp://ftp.freebsd.org</a> (Main Site)</code> 将自动将您路由到最近的镜像站点。</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div id="bsdinstall-netinstall-mirror" class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/bsdinstall/bsdinstall-netinstall-mirrorselect.png" alt="请求网络镜像的菜单。"/>
</div>
<div class="title">图 46. 选择镜像源</div>
</div>
</div>
<div class="sect3">
<h4 id="bsdinstall-timezone">2.8.3. 设置时区<a class="anchor" href="#bsdinstall-timezone"></a></h4>
<div class="paragraph">
<p>下一系列菜单用于通过选择地理区域、国家和时区来确定正确的本地时间。设置时区允许系统自动校正区域时间变化，如夏令时，并正确执行其他与时区相关的功能。</p>
</div>
<div class="paragraph">
<p>这里展示的示例适用于位于西班牙欧洲大陆时区的机器。根据地理位置的不同，选择项会有所变化。</p>
</div>
<div id="bsdinstall-timezone-region" class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/bsdinstall/bsdinstall-timezone-region.png" alt="请求时区地区的菜单。"/>
</div>
<div class="title">图 47. 选择一个地区</div>
</div>
<div class="paragraph">
<p>使用箭头键选择适当的区域，然后按下 <kbd>Enter</kbd> 键。</p>
</div>
<div id="bsdinstall-timezone-country" class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/bsdinstall/bsdinstall-timezone-country.png" alt="请求时区国家的菜单。"/>
</div>
<div class="title">图 48. 选择一个国家</div>
</div>
<div class="paragraph">
<p>使用箭头键选择适当的国家，然后按下键盘上的 [Enter] 键。</p>
</div>
<div id="bsdinstall-timezone-zone" class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/bsdinstall/bsdinstall-timezone-zone.png" alt="请求时区的菜单。"/>
</div>
<div class="title">图 49. 选择一个时区</div>
</div>
<div class="paragraph">
<p>使用箭头键选择适当的时区，然后按下 <kbd>Enter</kbd> 键确认。</p>
</div>
<div id="bsdinstall-timezone-confirmation" class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/bsdinstall/bsdinstall-timezone-confirm.png" alt="菜单请求确认所选时区。"/>
</div>
<div class="title">图 50. 确认时区</div>
</div>
<div class="paragraph">
<p>请确认时区的缩写是否正确。</p>
</div>
<div id="bsdinstall-timezone-date" class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/bsdinstall/bsdinstall-timezone-date.png" alt="请求系统日期的菜单。"/>
</div>
<div class="title">图 51. 选择日期</div>
</div>
<div class="paragraph">
<p>使用箭头键选择适当的日期，然后按下 <b class="button">Set Date</b> 。否则，可以通过按下 <b class="button">Skip</b> 来跳过日期选择。</p>
</div>
<div id="bsdinstall-timezone-time" class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/bsdinstall/bsdinstall-timezone-time.png" alt="请求系统时间的菜单。"/>
</div>
<div class="title">图 52. 选择时间</div>
</div>
<div class="paragraph">
<p>使用箭头键选择适当的时间，然后按下 <b class="button">Set Time</b> 。否则，可以通过按下 <b class="button">Skip</b> 来跳过时间选择。</p>
</div>
</div>
<div class="sect3">
<h4 id="bsdinstall-sysconf">2.8.4. 启用服务<a class="anchor" href="#bsdinstall-sysconf"></a></h4>
<div class="paragraph">
<p>下一个菜单用于配置系统启动时将启动哪些系统服务。所有这些服务都是可选的。只启动系统运行所需的服务。</p>
</div>
<div id="bsdinstall-config-serv" class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/bsdinstall/bsdinstall-config-services.png" alt="显示不同服务的菜单。"/>
</div>
<div class="title">图 53. 选择启用附加服务</div>
</div>
<div class="paragraph">
<p>这里是可以在此菜单中启用的服务的摘要：</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>local_unbound</code> - 启用本地 DNS 解析器 unbound 。需要注意的是，这个配置只适用于作为本地缓存转发解析器使用。如果目标是为整个网络设置解析器，请安装 <code>dns/unbound</code> 软件包。</p>
</li>
<li>
<p><code>sshd</code> - 安全 Shell（SSH）守护进程用于通过加密连接远程访问系统。只有在系统需要提供远程登录时才启用此服务。</p>
</li>
<li>
<p><code>moused</code> - 如果希望从命令行系统控制台使用鼠标，请启用此服务。</p>
</li>
<li>
<p><code>ntpdate</code> - 在启动时启用自动时钟同步。请注意，该程序的功能现在已经整合到 <code><a href="https://man.freebsd.org/cgi/man.cgi?query=ntpd&amp;sektion=8&amp;format=html">ntpd(8)</a></code> 守护进程中， <code><a href="https://man.freebsd.org/cgi/man.cgi?query=ntpdate&amp;sektion=8&amp;format=html">ntpdate(8)</a></code> 实用程序将很快被弃用。</p>
</li>
<li>
<p><code>ntpd</code> - 自动时钟同步的网络时间协议（NTP）守护进程。如果您希望将系统时钟与远程时间服务器或时间池同步，请启用此服务。</p>
</li>
<li>
<p><code>powerd</code> - 用于系统电源控制和节能的实用程序。</p>
</li>
<li>
<p><code>dumpdev</code> - 崩溃转储在调试系统问题时非常有用，因此鼓励用户启用它们。</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="bsdinstall-hardening">2.8.5. 启用强化安全选项<a class="anchor" href="#bsdinstall-hardening"></a></h4>
<div class="paragraph">
<p>下一个菜单用于配置启用的安全选项。所有这些选项都是可选的，但建议使用它们。</p>
</div>
<div id="bsdinstall-hardening-options" class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/bsdinstall/bsdinstall-hardening.png" alt="显示不同的加固安全选项的菜单。"/>
</div>
<div class="title">图 54. 选择加固安全选项</div>
</div>
<div class="paragraph">
<p>这里是可以在此菜单中启用的选项摘要：</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>hide_uids</code> - 隐藏以其他用户（UID）身份运行的进程。这可以防止非特权用户看到其他用户正在运行的进程。</p>
</li>
<li>
<p><code>hide_gids</code> - 隐藏以其他组（GID）身份运行的进程。这可以防止非特权用户看到来自其他组的运行进程。</p>
</li>
<li>
<p><code>hide_jail</code> - 隐藏在 jail 中运行的进程。这可以防止非特权用户看到在 jail 内部运行的进程。</p>
</li>
<li>
<p><code>read_msgbuf</code> - 禁止非特权用户读取内核消息缓冲区。防止非特权用户使用 <a href="https://man.freebsd.org/cgi/man.cgi?query=dmesg&amp;sektion=8&amp;format=html">dmesg(8)</a> 命令查看内核日志缓冲区中的消息。</p>
</li>
<li>
<p><code>proc_debug</code> - 禁用非特权用户的进程调试功能。禁用了各种非特权进程间调试服务，包括一些 procfs 功能，<code>ptrace()</code> 和 <code>ktrace()</code>。请注意，这也会阻止调试工具如 <a href="https://man.freebsd.org/cgi/man.cgi?query=lldb&amp;sektion=1&amp;format=html">lldb(1)</a>、<a href="https://man.freebsd.org/cgi/man.cgi?query=truss&amp;sektion=1&amp;format=html">truss(1)</a> 和 <a href="https://man.freebsd.org/cgi/man.cgi?query=procstat&amp;sektion=1&amp;format=html">procstat(1)</a>，以及某些脚本语言（如 PHP）中的一些内置调试功能。</p>
</li>
<li>
<p><code>random_pid</code> - 随机化进程的 PID 。</p>
</li>
<li>
<p><code>clear_tmp</code> - 在系统启动时清理 <code>/tmp</code> 目录。</p>
</li>
<li>
<p><code>disable_syslogd</code> - 禁用打开 syslogd 网络套接字。默认情况下，FreeBSD 以安全方式运行 syslogd ，使用 <code>-s</code> 选项。这样可以防止守护进程在 514 端口上监听传入的 UDP 请求。启用此选项后， syslogd 将改为使用 <code>-ss</code> 运行，这将阻止 syslogd 打开任何端口。有关更多信息，请参阅 <a href="https://man.freebsd.org/cgi/man.cgi?query=syslogd&amp;sektion=8&amp;format=html">syslogd(8)</a> 。</p>
</li>
<li>
<p><code>disable_sendmail</code> - 禁用 sendmail 邮件传输代理。</p>
</li>
<li>
<p><code>secure_console</code> - 在进入单用户模式时，使命令提示符要求输入 <code>root</code> 密码。</p>
</li>
<li>
<p><code>disable_ddtrace</code> - DTrace 可以以影响运行中的内核的模式运行。除非显式启用，否则不得使用破坏性操作。在使用 DTrace 时，使用 <code>-w</code> 来启用此选项。有关更多信息，请参阅 <a href="https://man.freebsd.org/cgi/man.cgi?query=dtrace&amp;sektion=1&amp;format=html">dtrace(1)</a> 。</p>
</li>
<li>
<p><code>enable_aslr</code> - 启用地址空间布局随机化。有关地址空间布局随机化的更多信息，请参考 <a href="https://en.wikipedia.org/wiki/Address_space_layout_randomization">维基百科文章</a> 。</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="bsdinstall-addusers">2.8.6. 添加用户<a class="anchor" href="#bsdinstall-addusers"></a></h4>
<div class="paragraph">
<p>下一个菜单提示您创建至少一个用户帐户。建议使用用户帐户登录系统，而不是使用“ root ”用户。以 <code>root</code> 用户身份登录时，基本上没有限制或保护，可以做任何事情。以普通用户身份登录更安全、更可靠。</p>
</div>
<div class="paragraph">
<p>选择 <b class="button">Yes</b> 来添加新用户。</p>
</div>
<div id="bsdinstall-add-user1" class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/bsdinstall/bsdinstall-adduser1.png" alt="菜单询问用户是否要添加到系统中。"/>
</div>
<div class="title">图 55. 添加用户账户</div>
</div>
<div class="paragraph">
<p>按照提示输入用户账户所需的信息。在 <a href="#bsdinstall-add-user2">输入用户信息</a> 中的示例创建了 <code>asample</code> 用户账户。</p>
</div>
<div id="bsdinstall-add-user2" class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/bsdinstall/bsdinstall-adduser2.png" alt="菜单请求新用户的不同信息。"/>
</div>
<div class="title">图 56. 输入用户信息</div>
</div>
<div class="paragraph">
<p>这是输入信息的摘要：</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>用户名（Username）</code> - 用户登录时输入的名称。常见的约定是使用名字的首字母与姓氏结合，只要每个用户名在系统中是唯一的。用户名区分大小写，不应包含任何空格。</p>
</li>
<li>
<p><code>Full name</code> - 用户的全名。可以包含空格，并且用作用户账户的描述。</p>
</li>
<li>
<p><code>Uid</code> - 用户 ID 。通常留空，系统会自动分配一个值。</p>
</li>
<li>
<p><code>登录组（Login group）</code> - 用户所属的组。通常留空以接受默认值。</p>
</li>
<li>
<p>将 <code>用户</code> 邀请加入其他群组（Invite <em>user</em> into other groups）？ - 用户将作为成员添加到其他群组。如果用户需要管理员访问权限，请在此处输入 <code>wheel</code> 。</p>
</li>
<li>
<p><code>登录类（Login class）</code> - 通常留空以使用默认值。</p>
</li>
<li>
<p><code>Shell</code> - 输入列表中的一个值来设置用户的交互式 shell 。有关 shell 的更多信息，请参考 <a href="./#shells">Shells</a> 。</p>
</li>
<li>
<p><code>Home directory</code> - 用户的主目录。通常情况下，默认值是正确的。</p>
</li>
<li>
<p><code>主目录权限（Home directory permissions）</code> - 用户主目录的权限。通常情况下，默认设置是正确的。</p>
</li>
<li>
<p><code>使用基于密码的身份验证（se password-based authentication）？</code> - 通常选择 <code>yes</code>，这样用户在登录时会被提示输入密码。</p>
</li>
<li>
<p><code>使用空密码（Use an empty password）？</code> - 通常情况下，不建议使用空密码，因为空密码或空白密码是不安全的。</p>
</li>
<li>
<p><code>使用随机密码（Use a random password）？</code> - 通常是 <code>no</code>，这样用户可以在下一个提示中设置自己的密码。</p>
</li>
<li>
<p><code>输入密码（Enter password）</code> - 此用户的密码。输入的字符不会显示在屏幕上。</p>
</li>
<li>
<p><code>再次输入密码（Enter password again）</code> - 为了验证，必须再次输入密码。</p>
</li>
<li>
<p><code>创建后锁定账户（Lock out the account after creation）？</code> - 通常是 <code>no</code>，以便用户可以登录。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>输入完所有细节后，会显示一个摘要供审核。如果有错误，请输入 <code>no</code> 进行更正。一切都正确无误后，请输入 <code>yes</code> 创建新用户。</p>
</div>
<div id="bsdinstall-add-user3" class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/bsdinstall/bsdinstall-adduser3.png" alt="菜单显示新用户的信息，并询问是否一切正确。"/>
</div>
<div class="title">图 57. 退出用户和组管理</div>
</div>
<div class="paragraph">
<p>如果还有更多用户需要添加，请用 <code>yes</code> 回答“是否添加另一个用户？”的问题。输入 <code>no</code> 以完成添加用户并继续安装。</p>
</div>
<div class="paragraph">
<p>有关添加用户和用户管理的更多信息，请参阅 <a href="./#users-synopsis">用户和基本帐户管理</a> 一节。</p>
</div>
</div>
<div class="sect3">
<h4 id="bsdinstall-final-conf">2.8.7. 最终配置<a class="anchor" href="#bsdinstall-final-conf"></a></h4>
<div class="paragraph">
<p>在安装和配置完成之后，提供了最后一次修改设置的机会。</p>
</div>
<div id="bsdinstall-final-config" class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/bsdinstall/bsdinstall-finalconfiguration.png" alt="在完成安装之前显示不同选项的菜单。例如：添加用户" width="Time Zone" height="etc."/>
</div>
<div class="title">图 58. 最终配置</div>
</div>
<div class="paragraph">
<p>在完成安装之前，使用此菜单进行任何更改或进行任何额外的配置。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Add User</code> - 在 <a href="#bsdinstall-addusers">添加用户</a> 中描述。</p>
</li>
<li>
<p><code>Root Password</code> - 在 <a href="#bsdinstall-post-root">设置 <code>root</code> 密码</a> 中有详细描述。</p>
</li>
<li>
<p><code>Hostname</code> - 在 <a href="#bsdinstall-hostname">设置主机名</a> 中有详细描述。</p>
</li>
<li>
<p><code>Network</code> - 在 <a href="#bsdinstall-config-network-dev">配置网络接口</a> 中进行了描述。</p>
</li>
<li>
<p><code>Services</code> - 在 <a href="#bsdinstall-sysconf">启用服务</a> 中进行了描述。</p>
</li>
<li>
<p><code>System Hardening</code> - 在 <a href="#bsdinstall-hardening">启用强化安全选项</a> 中进行了描述。</p>
</li>
<li>
<p><code>Time Zone</code> - 在 <a href="#bsdinstall-timezone">设置时区</a> 中描述。</p>
</li>
<li>
<p><code>Handbook</code> - 下载并安装 FreeBSD 手册。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>配置完成后，选择 <b class="button">Exit</b>。</p>
</div>
<div id="bsdinstall-final-modification-shell" class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/bsdinstall/bsdinstall-final-modification-shell.png" alt="菜单显示安装已完成，并询问是否要打开一个 shell 来进行手动更改。"/>
</div>
<div class="title">图 59. 手动配置</div>
</div>
<div class="paragraph">
<p>bsdinstall 将提示进行任何在重启进入新系统之前需要完成的额外配置。选择 <b class="button">Yes</b> 退出到新系统中的 shell ，或选择 <b class="button">No</b> 继续进行安装的最后一步。</p>
</div>
<div id="bsdinstall-final-main" class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/bsdinstall/bsdinstall-mainexit.png" alt="菜单显示安装已完成，并询问是否重新启动系统或访问 Live CD 。"/>
</div>
<div class="title">图 60. 完成安装</div>
</div>
<div class="paragraph">
<p>如果需要进一步配置或特殊设置，请选择 <b class="button">Live CD</b> 以将安装介质引导到 Live CD 模式。</p>
</div>
<div class="paragraph">
<p>如果安装完成，请选择 <b class="button">Reboot</b> 来重新启动计算机并启动新的 FreeBSD 系统。不要忘记移除 FreeBSD 安装介质，否则计算机可能会再次从它启动。</p>
</div>
<div class="paragraph">
<p>FreeBSD 启动时会显示信息性的消息。系统完成启动后，会显示一个登录提示符。在 <code>login:</code> 提示符下，输入在安装过程中添加的用户名。避免使用 <code>root</code> 登录。如需进行管理访问时，参考 <a href="./#users-superuser">超级用户账户</a> 中的说明，了解如何成为超级用户。</p>
</div>
<div class="paragraph">
<p>按下 <kbd>Scroll-Lock</kbd> 键可以查看启动过程中出现的消息，以打开滚动缓冲区。使用 <kbd>PgUp</kbd>、<kbd>PgDn</kbd> 和箭头键可以向后滚动查看消息。完成后，再次按下 <kbd>Scroll-Lock</kbd> 键以解锁显示并返回到控制台。要在系统运行一段时间后查看这些消息，请在命令提示符下输入 <code>less /var/run/dmesg.boot</code>。查看完毕后，按下 <kbd>q</kbd> 键返回到命令行。</p>
</div>
<div class="paragraph">
<p>如果在 <a href="#bsdinstall-config-serv">选择启用附加服务</a> 中启用了 sshd，系统在第一次启动时可能会慢一些，因为系统会生成 SSH 主机密钥。随后的启动将会更快。然后，密钥的指纹将会显示如下示例：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">Generating public/private rsa1 key pair.
Your identification has been saved <span class="k">in</span> /etc/ssh/ssh_host_key.
Your public key has been saved <span class="k">in</span> /etc/ssh/ssh_host_key.pub.
The key fingerprint is:
10:a0:f5:af:93:ae:a3:1a:b2:bb:3c:35:d9:5a:b3:f3 root@machine3.example.com
The key<span class="s1">&#39;s randomart image is:
+--[RSA1 1024]----+
|    o..          |
|   o . .         |
|  .   o          |
|       o         |
|    o   S        |
|   + + o         |
|o . + *          |
|o+ ..+ .         |
|==o..o+E         |
+-----------------+
Generating public/private dsa key pair.
Your identification has been saved in /etc/ssh/ssh_host_dsa_key.
Your public key has been saved in /etc/ssh/ssh_host_dsa_key.pub.
The key fingerprint is:
7e:1c:ce:dc:8a:3a:18:13:5b:34:b5:cf:d9:d1:47:b2 root@machine3.example.com
The key&#39;</span>s randomart image is:
+--[ DSA 1024]----+
|       ..     . .|
|      o  .   . + |
|     . ..   . E .|
|    . .  o o . . |
|     +  S <span class="o">=</span> .    |
|    +  . <span class="o">=</span> o     |
|     +  . <span class="k">*</span> .    |
|    . .  o .     |
|      .o. .      |
+-----------------+
Starting sshd.</code></pre>
</div>
</div>
<div class="paragraph">
<p>有关指纹和 SSH 的更多信息，请参考 <a href="./#openssh">OpenSSH</a> 。</p>
</div>
<div class="paragraph">
<p>默认情况下，FreeBSD 不安装图形化环境。有关安装和配置图形窗口管理器的更多信息，请参考 <a href="./#x11">X Window 系统</a> 。</p>
</div>
<div class="paragraph">
<p>正确关闭 FreeBSD 计算机有助于保护数据和硬件免受损坏。在系统正确关闭之前，请不要关闭电源！如果用户是 <code>wheel</code> 组的成员，请在命令行中输入 <code>su</code> 并输入 <code>root</code> 密码以成为超级用户。然后，输入 <code>shutdown -p now</code>，系统将会干净地关闭，并且如果硬件支持的话，会自动关闭电源。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="bsdinstall-install-trouble">2.9. 故障排除<a class="anchor" href="#bsdinstall-install-trouble"></a></h3>
<div class="paragraph">
<p>本节介绍基本的安装故障排除，例如人们常见的问题。</p>
</div>
<div class="paragraph">
<p>请查看 <a href="https://www.FreeBSD.org/releases/">FreeBSD Release Information</a> 页面上列出的硬件说明，以确保硬件得到支持。</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>通过更新各种硬件组件的固件，尤其是主板的固件，可以避免或减轻一些安装问题。主板固件通常被称为 BIOS。大多数主板和计算机制造商都有升级和升级信息的网站。</p>
</div>
<div class="paragraph">
<p>除非有充分的理由，如关键更新，否则制造商通常建议不要升级主板 BIOS。升级过程可能会出错，导致 BIOS 不完整，使计算机无法正常运行。</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>如果系统在启动过程中探测硬件时卡住或在安装过程中表现异常，ACPI 可能是罪魁祸首。FreeBSD 在 i386 和 amd64 平台上在启动过程中检测到 ACPI 后会广泛使用系统 ACPI 服务来帮助系统配置。不幸的是，ACPI 驱动程序和系统主板以及 BIOS 固件中仍然存在一些错误。可以通过在第三阶段引导加载程序中设置 <code>hint.acpi.0.disabled</code> 提示来禁用 ACPI。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nb">set </span>hint.acpi.0.disabled<span class="o">=</span><span class="s2">&#34;1&#34;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>每次系统启动时都会重置这个设置，因此需要将 <code>hint.acpi.0.disabled =&#34;1&#34;</code> 添加到文件 <code>/boot/loader.conf</code> 中。有关引导加载程序的更多信息可以在 <a href="./#boot-synopsis">“Synopsis”</a> 中找到。</p>
</div>
</div>
<div class="sect2">
<h3 id="using-live-cd">2.10. 使用 Live CD<a class="anchor" href="#using-live-cd"></a></h3>
<div class="paragraph">
<p>bsdinstall 的欢迎菜单在 <a href="#bsdinstall-choose-mode">欢迎菜单</a> 中显示，提供了 <b class="button">Live CD</b> 选项。对于那些仍然在犹豫是否选择 FreeBSD 作为他们的操作系统，并且想在安装之前测试一些功能的人来说，这是非常有用的。</p>
</div>
<div class="paragraph">
<p>在使用 <b class="button">Live CD</b> 之前，应注意以下几点：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>要访问系统，需要进行身份验证。用户名为 <code>root</code>，密码为空。</p>
</li>
<li>
<p>由于系统直接从安装介质运行，因此性能将明显低于安装在硬盘上的系统。</p>
</li>
<li>
<p>该选项只提供命令提示符，而不提供图形界面。</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="basics">Chapter 3. FreeBSD 基础知识<a class="anchor" href="#basics"></a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="basics-synopsis">3.1. 概要<a class="anchor" href="#basics-synopsis"></a></h3>
<div class="paragraph">
<p>本章介绍了 FreeBSD 操作系统的基本命令和功能。其中很多内容对于任何类 UNIX 操作系统都是相关的。鼓励新的 FreeBSD 用户仔细阅读本章。</p>
</div>
<div class="paragraph">
<p>阅读完本章后，您将了解：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>如何使用和配置虚拟控制台。</p>
</li>
<li>
<p>如何在 FreeBSD 上创建和管理用户和组。</p>
</li>
<li>
<p>UNIX® 文件权限和 FreeBSD 文件标志的工作原理。</p>
</li>
<li>
<p>默认的 FreeBSD 文件系统布局。</p>
</li>
<li>
<p>FreeBSD 磁盘组织。</p>
</li>
<li>
<p>如何挂载和卸载文件系统。</p>
</li>
<li>
<p>进程、守护进程和信号是什么。</p>
</li>
<li>
<p>什么是 shell ，以及如何更改默认的登录环境。</p>
</li>
<li>
<p>如何使用基本文本编辑器。</p>
</li>
<li>
<p>设备和设备节点是什么。</p>
</li>
<li>
<p>如何阅读手册页以获取更多信息。</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="consoles">3.2. 虚拟控制台和终端<a class="anchor" href="#consoles"></a></h3>
<div class="paragraph">
<p>除非 FreeBSD 已经配置为在启动时自动启动图形环境，否则系统将启动到一个命令行登录提示符，如下面的示例所示：</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>FreeBSD/amd64 (pc3.example.org) (ttyv0)

login:</pre>
</div>
</div>
<div class="paragraph">
<p>第一行包含了关于系统的一些信息。 <code>amd64</code> 表示 FreeBSD 运行在一个 64 位的 x86 系统上。主机名是 <code>pc3.example.org</code> ，而 <code>ttyv0</code> 表示这是“系统控制台”。第二行是登录提示符。</p>
</div>
<div class="paragraph">
<p>由于 FreeBSD 是一个多用户系统，它需要一种区分不同用户的方式。这通过要求每个用户在访问系统上的程序之前先登录系统来实现。每个用户都有一个唯一的“用户名”和个人的“密码”。</p>
</div>
<div class="paragraph">
<p>要登录系统控制台，请输入在系统安装过程中配置的用户名，如 <a href="./#bsdinstall-addusers">Add Users</a> 中所述，并按下 <kbd>Enter</kbd> 键。然后输入与用户名关联的密码并按下 <kbd>Enter</kbd> 键。出于安全原因，密码不会显示出来。</p>
</div>
<div class="paragraph">
<p>一旦输入正确的密码，将显示当天的消息（ MOTD ），然后显示命令提示符。根据创建用户时选择的 shell 不同，该提示符可能是 <code>#</code> 、 <code>$</code> 或 <code>%</code> 字符。提示符表示用户已成功登录到 FreeBSD 系统控制台，并准备尝试可用的命令。</p>
</div>
<div class="sect3">
<h4 id="consoles-virtual">3.2.1. 虚拟控制台<a class="anchor" href="#consoles-virtual"></a></h4>
<div class="paragraph">
<p>虽然系统控制台可以用于与系统进行交互，但在 FreeBSD 系统的键盘命令行上工作的用户通常会登录到虚拟控制台。这是因为系统消息默认配置为显示在系统控制台上。这些消息会出现在用户正在操作的命令或文件上，使得集中注意力于手头的工作变得困难。</p>
</div>
<div class="paragraph">
<p>默认情况下，FreeBSD 配置了多个虚拟控制台用于输入命令。每个虚拟控制台都有自己的登录提示符和 Shell ，并且可以轻松地在虚拟控制台之间切换。这基本上提供了在图形环境中同时打开多个窗口的命令行等效功能。</p>
</div>
<div class="paragraph">
<p>组合键 <span class="keyseq"><kbd>Alt</kbd>+<kbd>F1</kbd></span> 到 <span class="keyseq"><kbd>Alt</kbd>+<kbd>F8</kbd></span> 已被 FreeBSD 保留用于在虚拟控制台之间切换。使用 <span class="keyseq"><kbd>Alt</kbd>+<kbd>F1</kbd></span> 切换到系统控制台（ <code>ttyv0</code> ），使用 <span class="keyseq"><kbd>Alt</kbd>+<kbd>F2</kbd></span> 访问第一个虚拟控制台（ <code>ttyv1</code> ），使用 <span class="keyseq"><kbd>Alt</kbd>+<kbd>F3</kbd></span> 访问第二个虚拟控制台（ <code>ttyv2</code> ），依此类推。当使用 Xorg 作为图形控制台时，组合键变为 <span class="keyseq"><kbd>Ctrl</kbd>+<kbd>Alt</kbd>+<kbd>F1</kbd></span> 以返回到基于文本的虚拟控制台。</p>
</div>
<div class="paragraph">
<p>当从一个控制台切换到下一个控制台时，FreeBSD 会管理屏幕输出。结果是有多个虚拟屏幕和键盘可以用来键入命令以供 FreeBSD 运行。当用户切换到不同的虚拟控制台时，在一个虚拟控制台中启动的程序不会停止运行</p>
</div>
<div class="paragraph">
<p>请参考 <a href="https://man.freebsd.org/cgi/man.cgi?query=kbdcontrol&amp;sektion=1&amp;format=html">kbdcontrol(1)</a> 、 <a href="https://man.freebsd.org/cgi/man.cgi?query=vidcontrol&amp;sektion=1&amp;format=html">vidcontrol(1)</a> 、 <a href="https://man.freebsd.org/cgi/man.cgi?query=atkbd&amp;sektion=4&amp;format=html">atkbd(4)</a> 、 <a href="https://man.freebsd.org/cgi/man.cgi?query=syscons&amp;sektion=4&amp;format=html">syscons(4)</a> 和 <a href="https://man.freebsd.org/cgi/man.cgi?query=vt&amp;sektion=4&amp;format=html">vt(4)</a> ，以获取更详细的 FreeBSD 控制台及其键盘驱动程序的技术描述。</p>
</div>
<div class="paragraph">
<p>在 FreeBSD 中，可用的虚拟控制台数量是在 <code>/etc/ttys</code> 文件的这个部分进行配置的：</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre># name    getty                         type  status comments
#
ttyv0   &#34;/usr/libexec/getty Pc&#34;         xterm   on  secure
# Virtual terminals
ttyv1   &#34;/usr/libexec/getty Pc&#34;         xterm   on  secure
ttyv2   &#34;/usr/libexec/getty Pc&#34;         xterm   on  secure
ttyv3   &#34;/usr/libexec/getty Pc&#34;         xterm   on  secure
ttyv4   &#34;/usr/libexec/getty Pc&#34;         xterm   on  secure
ttyv5   &#34;/usr/libexec/getty Pc&#34;         xterm   on  secure
ttyv6   &#34;/usr/libexec/getty Pc&#34;         xterm   on  secure
ttyv7   &#34;/usr/libexec/getty Pc&#34;         xterm   on  secure
ttyv8   &#34;/usr/X11R6/bin/xdm -nodaemon&#34;  xterm   off secure</pre>
</div>
</div>
<div class="paragraph">
<p>要禁用虚拟控制台，请在表示该虚拟控制台的行的开头放置一个注释符号（ <code>#</code> ）。例如，要将可用虚拟控制台的数量从八个减少到四个，请在表示虚拟控制台 <code>ttyv5</code> 到 <code>ttyv8</code> 的最后四行前面放置一个 <code>#</code> 。 <strong>不要</strong> 注释掉系统控制台 <code>ttyv0</code> 的行。请注意，如果已经安装并配置了 Xorg （如 <a href="./#x11">X Window 系统</a> 中所述），则最后一个虚拟控制台（ <code>ttyv8</code> ）用于访问图形环境。</p>
</div>
<div class="paragraph">
<p>有关此文件中每个列的详细描述以及虚拟控制台的可用选项，请参阅 <a href="https://man.freebsd.org/cgi/man.cgi?query=ttys&amp;sektion=5&amp;format=html">ttys(5)</a> 。</p>
</div>
</div>
<div class="sect3">
<h4 id="consoles-singleuser">3.2.2. 单用户模式<a class="anchor" href="#consoles-singleuser"></a></h4>
<div class="paragraph">
<p>FreeBSD 引导菜单提供了一个标有“单用户启动”的选项。如果选择了这个选项，系统将启动到一个称为“单用户模式”的特殊模式。通常情况下，这个模式用于修复无法启动的系统或者在不知道 <code>root</code> 密码时重置密码。在单用户模式下，网络和其他虚拟控制台是不可用的。然而，系统完全支持 <code>root</code> 访问，并且默认情况下不需要 <code>root</code> 密码。因此，需要有对键盘的物理访问权限才能进入该模式，确定谁对键盘有物理访问权是保护 FreeBSD 系统安全时需要考虑的问题</p>
</div>
<div class="paragraph">
<p>控制单用户模式的设置位于 <code>/etc/ttys</code> 文件的这个部分。</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre># name  getty                           type  status  comments
#
# If console is marked &#34;insecure&#34;, then init will ask for the root password
# when going to single-user mode.
console none                            unknown  off  secure</pre>
</div>
</div>
<div class="paragraph">
<p>默认情况下，状态被设置为 <code>secure</code>。这意味着对键盘具有物理访问权限的人要么不重要，要么受到物理安全策略的控制。如果将此设置更改为 <code>insecure</code>，则假设环境本身是不安全的，因为任何人都可以访问键盘。当将此行更改为 <code>insecure</code> 时， FreeBSD 将在用户选择进入单用户模式时提示输入 <code>root</code> 密码。</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>在更改此设置为 <code>insecure</code> 时要小心！如果忘记了 <code>root</code> 密码，仍然可以启动到单用户模式，但对于不熟悉 FreeBSD 启动过程的人来说可能会有困难。</p>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect3">
<h4 id="consoles-vidcontrol">3.2.3. 更改控制台视频模式<a class="anchor" href="#consoles-vidcontrol"></a></h4>
<div class="paragraph">
<p>FreeBSD 控制台的默认视频模式可以调整为 1024x768 、 1280x1024 或其他由图形芯片和显示器支持的尺寸。要使用不同的视频模式，请加载 <code>VESA</code> 模块：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># kldload vesa</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>要确定硬件支持哪些视频模式，请使用 <a href="https://man.freebsd.org/cgi/man.cgi?query=vidcontrol&amp;sektion=1&amp;format=html">vidcontrol(1)</a> 。要获取支持的视频模式列表，请执行以下操作：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># vidcontrol -i mode</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>该命令的输出列出了硬件支持的视频模式。要选择一个新的视频模式，请使用 <a href="https://man.freebsd.org/cgi/man.cgi?query=vidcontrol&amp;sektion=1&amp;format=html">vidcontrol(1)</a> 作为 <code>root</code> 用户指定该模式：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># vidcontrol MODE_279</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>如果新的视频模式可接受，可以通过将其添加到 <code>/etc/rc.conf</code> 来在启动时永久设置。</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>allscreens_flags=&#34;MODE_279&#34;</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="users-synopsis">3.3. 用户和基本账户管理<a class="anchor" href="#users-synopsis"></a></h3>
<div class="paragraph">
<p>FreeBSD 允许多个用户同时使用计算机。虽然一次只能有一个用户坐在屏幕前使用键盘，但任意数量的用户可以通过网络登录系统。为了使用系统，每个用户都应该有自己的用户账户。</p>
</div>
<div class="paragraph">
<p>本章描述了：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>FreeBSD 系统上的不同类型的用户账户。</p>
</li>
<li>
<p>如何添加、删除和修改用户账户。</p>
</li>
<li>
<p>如何设置限制以控制用户和组可以访问的资源。</p>
</li>
<li>
<p>如何创建组并将用户添加为组的成员。</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="users-introduction">3.3.1. 账户类型<a class="anchor" href="#users-introduction"></a></h4>
<div class="paragraph">
<p>由于所有对 FreeBSD 系统的访问都是通过账户实现的，并且所有进程都是由用户运行的，因此用户和账户管理非常重要。</p>
</div>
<div class="paragraph">
<p>有三种主要类型的账户：系统账户、用户账户和超级用户账户。</p>
</div>
<div class="sect4">
<h5 id="users-system">3.3.1.1. 系统账户<a class="anchor" href="#users-system"></a></h5>
<div class="paragraph">
<p>系统账户用于运行诸如 DNS、邮件和 Web 服务器等服务。这样做的原因是出于安全考虑；如果所有服务都以超级用户身份运行，它们就可以无限制地执行操作。</p>
</div>
<div class="paragraph">
<p>系统账户的例子包括 <code>daemon</code>、<code>operator</code>、<code>bind</code>、<code>news</code> 和 <code>www</code>。</p>
</div>
<div class="paragraph">
<p><code>nobody</code> 是一个通用的非特权系统账户。然而，使用 <code>nobody</code> 的服务越多，与该用户相关联的文件和进程也就越多，因此该用户的特权也就越高。</p>
</div>
</div>
<div class="sect4">
<h5 id="users-user">3.3.1.2. 用户账户<a class="anchor" href="#users-user"></a></h5>
<div class="paragraph">
<p>用户账户分配给真实的人，并用于登录和使用系统。每个访问系统的人都应该拥有一个唯一的用户账户。这使管理员能够查明谁在做什么，并防止用户破坏其他用户的设置。</p>
</div>
<div class="paragraph">
<p>每个用户都可以设置自己的环境以适应他们对系统的使用，通过配置他们的默认 shell 、编辑器、键绑定和语言设置。</p>
</div>
<div class="paragraph">
<p>在 FreeBSD 系统上，每个用户账户都有与之关联的特定信息：</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">User name</dt>
<dd>
<p>用户名称是在 <code>login:</code> 提示处输入的。每个用户必须有一个唯一的用户名。有一些创建有效用户名的规则，这些规则在 <a href="https://man.freebsd.org/cgi/man.cgi?query=passwd&amp;sektion=5&amp;format=html">passwd(5)</a> 中有详细说明。建议使用由八个或更少个小写字符组成的用户名，以保持与应用程序的向后兼容性。</p>
</dd>
<dt class="hdlist1">Password</dt>
<dd>
<p>每个账户都有一个关联的密码。</p>
</dd>
<dt class="hdlist1">User ID (UID)</dt>
<dd>
<p>用户 ID (UID) 是一个用于在 FreeBSD 系统中唯一标识用户的数字。允许指定用户名的命令将首先将其转换为 UID 。建议使用小于 65535 的 UID ，因为较高的值可能会导致某些软件的兼容性问题。</p>
</dd>
<dt class="hdlist1">Group ID (GID)</dt>
<dd>
<p>组 ID (GID) 是一个用于唯一标识用户所属的主要组的数字。组是一种基于用户的 GID 而不是 UID 来控制对资源访问的机制。这可以显著减小某些配置文件的大小，并允许用户成为多个组的成员。建议使用 65535 或更低的 GID ，因为较高的 GID 可能会破坏某些软件。</p>
</dd>
<dt class="hdlist1">Login class</dt>
<dd>
<p>登录分级是组机制的扩展，为定制系统以适应不同用户提供了额外的灵活性。有关登录类的详细讨论，请参阅 <a href="./#users-limiting">配置登录分级</a> 。</p>
</dd>
<dt class="hdlist1">Password change time</dt>
<dd>
<p>默认情况下，密码不会过期。然而，可以根据每个用户的情况启用密码过期功能，强制一些或所有用户在一定时间后更改他们的密码。</p>
</dd>
<dt class="hdlist1">Account expiration time</dt>
<dd>
<p>默认情况下， FreeBSD 不会使账户过期。当创建需要有限生命周期的账户时，比如学校的学生账户，可以使用 <a href="https://man.freebsd.org/cgi/man.cgi?query=pw&amp;sektion=8&amp;format=html">pw(8)</a> 命令指定账户的过期日期。在过期时间到达后，该账户将无法用于登录系统，但账户的目录和文件将保留。</p>
</dd>
<dt class="hdlist1">User’s full name</dt>
<dd>
<p>用户名在 FreeBSD 中唯一标识账户，但不一定反映用户的真实姓名。与注释类似，此信息可以包含空格、大写字符，并且可以超过 8 个字符的长度。</p>
</dd>
<dt class="hdlist1">Home directory</dt>
<dd>
<p>主目录是系统上一个目录的完整路径。这是用户登录时的起始目录。一个常见的约定是将所有用户的主目录放在 <code>/home/username</code> 或 <code>/usr/home/username</code> 下。每个用户在自己的主目录中存储个人文件和子目录。</p>
</dd>
<dt class="hdlist1">User shell</dt>
<dd>
<p>Shell 提供了用户与系统进行交互的默认环境。有许多不同类型的 shell ，有经验的用户会根据自己的偏好进行设置，这些设置可以反映在他们的账户设置中。</p>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="users-superuser">3.3.1.3. 超级用户账户<a class="anchor" href="#users-superuser"></a></h5>
<div class="paragraph">
<p>超级用户账户通常被称为 <code>root</code> ，用于无限制地管理系统。因此，不应将其用于日常任务，如发送和接收邮件、系统的一般探索或编程。</p>
</div>
<div class="paragraph">
<p>与其他用户账户不同，超级用户可以无限制地操作，滥用超级用户账户可能导致灾难性后果。用户账户无法通过错误操作销毁操作系统，因此建议以用户账户登录，并且只在需要额外权限的命令时切换为超级用户。</p>
</div>
<div class="paragraph">
<p>作为超级用户，始终要仔细检查任何发出的命令，因为额外的空格或缺失的字符可能导致无法修复的数据丢失。</p>
</div>
<div class="paragraph">
<p>有几种方法可以获得超级用户权限。虽然可以使用 <code>root</code> 账户登录，但这是极不推荐的。</p>
</div>
<div class="paragraph">
<p>相反，使用 <a href="https://man.freebsd.org/cgi/man.cgi?query=su&amp;sektion=1&amp;format=html">su(1)</a> 命令成为超级用户。如果在运行此命令时指定了 <code>-</code> ，用户还将继承 root 用户的环境。运行此命令的用户必须属于 <code>wheel</code> 组，否则命令将失败。用户还必须知道 <code>root</code> 用户账户的密码。</p>
</div>
<div class="paragraph">
<p>在这个例子中，用户只是为了运行 <code>make install</code> 这个步骤需要超级用户权限，才成为超级用户。一旦命令完成，用户输入 <code>exit</code> 来退出超级用户账户，返回到他们的用户账户的权限。</p>
</div>
<div class="exampleblock">
<div class="title">例 2. 以超级用户身份安装程序</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>configure
<span class="gp">% </span>make
<span class="gp">% </span>su -
Password:
<span class="c"># make install</span>
<span class="c"># exit</span>
%</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>内置的 <a href="https://man.freebsd.org/cgi/man.cgi?query=su&amp;sektion=1&amp;format=html">su(1)</a> 框架适用于单个系统或只有一个系统管理员的小型网络。另一种选择是安装 <a class="package" href="https://cgit.freebsd.org/ports/tree/security/sudo/">security/sudo</a> 软件包或 port。该软件提供活动日志记录，并允许管理员配置哪些用户可以以超级用户身份运行哪些命令。</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="users-modifying">3.3.2. 管理账户<a class="anchor" href="#users-modifying"></a></h4>
<div class="paragraph">
<p>FreeBSD 提供了多种不同的命令来管理用户账户。最常见的命令在 <a href="#users-modifying-utilities">管理用户账户的实用工具</a> 中进行了总结，并附有一些使用示例。有关每个实用程序的更多详细信息和使用示例，请参阅其手册页面。</p>
</div>
<table id="users-modifying-utilities" class="tableblock frame-all grid-all stretch">
<caption class="title">表 2. 管理用户账户的实用工具</caption>
<colgroup>
<col style="width: 25%;"/>
<col/>
</colgroup>
<tbody>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">命令</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">摘要</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://man.freebsd.org/cgi/man.cgi?query=adduser&amp;sektion=8&amp;format=html">adduser(8)</a></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">用于添加新用户的推荐命令行应用程序。</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://man.freebsd.org/cgi/man.cgi?query=rmuser&amp;sektion=8&amp;format=html">rmuser(8)</a></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">用于删除用户的推荐命令行应用程序。</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://man.freebsd.org/cgi/man.cgi?query=chpass&amp;sektion=1&amp;format=html">chpass(1)</a></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">用于更改用户数据库信息的灵活工具。</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://man.freebsd.org/cgi/man.cgi?query=passwd&amp;sektion=1&amp;format=html">passwd(1)</a></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">用于更改用户密码的命令行工具。</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://man.freebsd.org/cgi/man.cgi?query=pw&amp;sektion=8&amp;format=html">pw(8)</a></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">功能强大而灵活的工具，可对用户账户进行全方位修改。</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://man.freebsd.org/cgi/man.cgi?query=bsdconfig&amp;sektion=8&amp;format=html">bsdconfig(8)</a></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">具有账户管理支持的系统配置工具。</p></td>
</tr>
</tbody>
</table>
<div class="sect4">
<h5 id="users-adduser">3.3.2.1. 添加用户<a class="anchor" href="#users-adduser"></a></h5>
<div class="paragraph">
<p>添加新用户的推荐程序是 <a href="https://man.freebsd.org/cgi/man.cgi?query=adduser&amp;sektion=8&amp;format=html">adduser(8)</a> 。当添加新用户时，该程序会自动更新 <code>/etc/passwd</code> 和 <code>/etc/group</code> 文件。它还会为新用户创建一个家目录，并从 <code>/usr/share/skel</code> 目录中复制默认配置文件，并可选择向新用户发送欢迎消息。此实用程序必须以超级用户身份运行。</p>
</div>
<div class="paragraph">
<p><a href="https://man.freebsd.org/cgi/man.cgi?query=adduser&amp;sektion=8&amp;format=html">adduser(8)</a> 实用程序是交互式的，并且会引导用户完成创建新用户账户的步骤。如在 <a href="#users-modifying-adduser">在 FreeBSD 上添加用户</a> 中所示，可以输入所需信息，或按 <kbd>Return</kbd> 键接受方括号中显示的默认值。在本示例中，用户已被邀请加入 <code>wheel</code> 组，允许他们通过 <a href="https://man.freebsd.org/cgi/man.cgi?query=su&amp;sektion=1&amp;format=html">su(1)</a> 成为超级用户。完成后，实用程序将提示是否创建另一个用户或退出。</p>
</div>
<div id="users-modifying-adduser" class="exampleblock">
<div class="title">例 3. 在 FreeBSD 上添加用户</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># adduser</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>输出应该类似于以下内容：</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>Username: jru
Full name: J. Random User
Uid (Leave empty for default):
Login group [jru]:
Login group is jru. Invite jru into other groups? []: wheel
Login class [default]:
Shell (sh csh tcsh zsh nologin) [sh]: zsh
Home directory [/home/jru]:
Home directory permissions (Leave empty for default):
Use password-based authentication? [yes]:
Use an empty password? (yes/no) [no]:
Use a random password? (yes/no) [no]:
Enter password:
Enter password again:
Lock out the account after creation? [no]:
Username   : jru
Password   : ****
Full Name  : J. Random User
Uid        : 1001
Class      :
Groups     : jru wheel
Home       : /home/jru
Shell      : /usr/local/bin/zsh
Locked     : no
OK? (yes/no): yes
adduser: INFO: Successfully added (jru) to the user database.
Add another user? (yes/no): no
Goodbye!</pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>由于密码在输入时不会显示出来，请在创建用户账户时小心不要输入错误的密码。</p>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect4">
<h5 id="users-rmuser">3.3.2.2. 删除用户<a class="anchor" href="#users-rmuser"></a></h5>
<div class="paragraph">
<p>要完全从系统中删除用户，请以超级用户身份运行 <a href="https://man.freebsd.org/cgi/man.cgi?query=rmuser&amp;sektion=8&amp;format=html">rmuser(8)</a> 。该命令执行以下步骤：</p>
</div>
<div class="exampleblock procedure">
<div class="content">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>如果存在用户的 <a href="https://man.freebsd.org/cgi/man.cgi?query=crontab&amp;sektion=1&amp;format=html">crontab(1)</a> 条目，则删除它。</p>
</li>
<li>
<p>删除用户拥有的所有 <a href="https://man.freebsd.org/cgi/man.cgi?query=at&amp;sektion=1&amp;format=html">at(1)</a> 作业。</p>
</li>
<li>
<p>向用户拥有的所有进程发送 SIGKILL 信号。</p>
</li>
<li>
<p>从系统的本地密码文件中删除用户。</p>
</li>
<li>
<p>删除用户的主目录（如果该目录属于该用户），包括处理路径中符号链接指向实际主目录的情况。</p>
</li>
<li>
<p>从 <code>/var/mail</code> 目录中删除属于用户的传入邮件文件。</p>
</li>
<li>
<p>从 <code>/tmp</code>、<code>/var/tmp</code> 和 <code>/var/tmp/vi.recover</code> 中删除用户所有拥有的文件。</p>
</li>
<li>
<p>将用户名从 <code>/etc/group</code> 中所属的所有组中删除。（如果一个组变为空，并且组名与用户名相同，则删除该组；这与 <a href="https://man.freebsd.org/cgi/man.cgi?query=adduser&amp;sektion=8&amp;format=html">adduser(8)</a> 的每个用户唯一组相对应。）</p>
</li>
<li>
<p>删除用户拥有的所有消息队列、共享内存段和信号量。</p>
</li>
</ol>
</div>
</div>
</div>
<div class="paragraph">
<p><a href="https://man.freebsd.org/cgi/man.cgi?query=rmuser&amp;sektion=8&amp;format=html">rmuser(8)</a> 不能用于删除超级用户账户，因为这几乎总是意味着大规模破坏的迹象。</p>
</div>
<div class="paragraph">
<p>默认情况下，使用交互模式，如下例所示。</p>
</div>
<div class="exampleblock">
<div class="title">例 4. <code>rmuser</code> 交互式账户删除</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># rmuser jru</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>输出应该类似于以下内容：</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>Matching password entry:
jru:*:1001:1001::0:0:J. Random User:/home/jru:/usr/local/bin/zsh
Is this the entry you wish to remove? y
Remove user&#39;s home directory (/home/jru)? y
Removing user (jru): mailspool home passwd.</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="users-chpass">3.3.2.3. 更改用户信息<a class="anchor" href="#users-chpass"></a></h5>
<div class="paragraph">
<p>任何用户都可以使用 <a href="https://man.freebsd.org/cgi/man.cgi?query=chpass&amp;sektion=1&amp;format=html">chpass(1)</a> 命令来更改其默认 shell 和与其用户账户关联的个人信息。超级用户可以使用此实用程序来更改任何用户的其他账户信息。</p>
</div>
<div class="paragraph">
<p>当没有传递任何选项时，除了可选的用户名外， <a href="https://man.freebsd.org/cgi/man.cgi?query=chpass&amp;sektion=1&amp;format=html">chpass(1)</a> 会显示一个包含用户信息的编辑器。当用户从编辑器退出时，用户数据库将会更新为新的信息。</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>该实用程序在退出编辑器时会提示用户输入密码，除非以超级用户身份运行该实用程序。</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>在 <a href="#users-modifying-chpass-su">以超级用户身份使用 <code>chpass</code> 命令</a> 中，超级用户输入了 <code>chpass jru</code> ，现在正在查看可以更改该用户的字段。如果 <code>jru</code> 运行此命令，只有最后六个字段将被显示并可供编辑。这在 <a href="#users-modifying-chpass-ru">以普通用户身份使用 <code>chpass</code> 命令</a> 中显示。</p>
</div>
<div id="users-modifying-chpass-su" class="exampleblock">
<div class="title">例 5. 以超级用户身份使用 <code>chpass</code> 命令</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># chpass</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>输出应该类似于以下内容：</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre># Changing user database information for jru.
Login: jru
Password: *
Uid [#]: 1001
Gid [# or name]: 1001
Change [month day year]:
Expire [month day year]:
Class:
Home directory: /home/jru
Shell: /usr/local/bin/zsh
Full Name: J. Random User
Office Location:
Office Phone:
Home Phone:
Other information:</pre>
</div>
</div>
</div>
</div>
<div id="users-modifying-chpass-ru" class="exampleblock">
<div class="title">例 6. 以普通用户身份使用 <code>chpass</code> 命令</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c">#Changing user database information for jru.</span>
Shell: /usr/local/bin/zsh
Full Name: J. Random User
Office Location:
Office Phone:
Home Phone:
Other information:</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>命令 <a href="https://man.freebsd.org/cgi/man.cgi?query=chfn&amp;sektion=1&amp;format=html">chfn(1)</a> 和 <a href="https://man.freebsd.org/cgi/man.cgi?query=chsh&amp;sektion=1&amp;format=html">chsh(1)</a> 是指向 <a href="https://man.freebsd.org/cgi/man.cgi?query=chpass&amp;sektion=1&amp;format=html">chpass(1)</a> 的链接，同样 <a href="https://man.freebsd.org/cgi/man.cgi?query=ypchpass&amp;sektion=1&amp;format=html">ypchpass(1)</a> 、 <a href="https://man.freebsd.org/cgi/man.cgi?query=ypchfn&amp;sektion=1&amp;format=html">ypchfn(1)</a> 和 <a href="https://man.freebsd.org/cgi/man.cgi?query=ypchsh&amp;sektion=1&amp;format=html">ypchsh(1)</a> 也是。由于 NIS 支持是自动的，所以在命令之前指定 <code>yp</code> 是不必要的。如何配置 NIS 在 <a href="./#network-servers">网络服务器</a> 中有介绍。</p>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect4">
<h5 id="users-passwd">3.3.2.4. 更改用户密码<a class="anchor" href="#users-passwd"></a></h5>
<div class="paragraph">
<p>任何用户都可以使用 <a href="https://man.freebsd.org/cgi/man.cgi?query=passwd&amp;sektion=1&amp;format=html">passwd(1)</a> 轻松更改他们的密码。为了防止意外或未经授权的更改，在设置新密码之前，该命令会提示用户输入原始密码：</p>
</div>
<div class="exampleblock">
<div class="title">例 7. 更改密码</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>passwd</code></pre>
</div>
</div>
<div class="paragraph">
<p>输出应该类似于以下内容：</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>Changing local password for jru.
Old password:
New password:
Retype new password:
passwd: updating the database...
passwd: done</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>超级用户可以通过在运行 <a href="https://man.freebsd.org/cgi/man.cgi?query=passwd&amp;sektion=1&amp;format=html">passwd(1)</a> 时指定用户名来更改任何用户的密码。当以超级用户身份运行此实用程序时，它不会提示用户输入当前密码。这允许在用户无法记住原始密码时更改密码。</p>
</div>
<div class="exampleblock">
<div class="title">例 8. 以超级用户身份更改另一个用户的密码</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># passwd jru</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>输出应该类似于以下内容：</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>Changing local password for jru.
New password:
Retype new password:
passwd: updating the database...
passwd: done</pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>与 <a href="https://man.freebsd.org/cgi/man.cgi?query=chpass&amp;sektion=1&amp;format=html">chpass(1)</a> 一样， <a href="https://man.freebsd.org/cgi/man.cgi?query=yppasswd&amp;sektion=1&amp;format=html">yppasswd(1)</a> 是指向 <a href="https://man.freebsd.org/cgi/man.cgi?query=passwd&amp;sektion=1&amp;format=html">passwd(1)</a> 的链接，因此 NIS 可以与任一命令一起使用。</p>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect4">
<h5 id="users-pw">3.3.2.5. 创建、删除、修改和显示系统用户和组<a class="anchor" href="#users-pw"></a></h5>
<div class="paragraph">
<p><a href="https://man.freebsd.org/cgi/man.cgi?query=pw&amp;sektion=8&amp;format=html">pw(8)</a> 实用程序可以创建、删除、修改和显示用户和组。它作为系统用户和组文件的前端工具。 <a href="https://man.freebsd.org/cgi/man.cgi?query=pw&amp;sektion=8&amp;format=html">pw(8)</a> 具有一套非常强大的命令行选项，使其适用于在 shell 脚本中使用，但新用户可能会发现它比本节中介绍的其他命令更复杂。</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="users-groups">3.3.3. 管理群组<a class="anchor" href="#users-groups"></a></h4>
<div class="paragraph">
<p>组是一个用户列表。组由组名称和 GID 标识。在 FreeBSD 中，内核使用进程的 UID 和其所属的组列表来确定该进程被允许做什么。大多数情况下，用户或进程的 GID 通常表示列表中的第一个组。</p>
</div>
<div class="paragraph">
<p>组名到 GID 的映射在 <code>/etc/group</code> 中列出。这是一个纯文本文件，包含四个由冒号分隔的字段。第一个字段是组名，第二个字段是加密密码，第三个字段是 GID ，第四个字段是逗号分隔的成员列表。有关语法的更完整描述，请参阅 <a href="https://man.freebsd.org/cgi/man.cgi?query=group&amp;sektion=5&amp;format=html">group(5)</a> 。</p>
</div>
<div class="paragraph">
<p>超级用户可以使用文本编辑器修改 <code>/etc/group</code> 文件，尽管使用 <a href="https://man.freebsd.org/cgi/man.cgi?query=vigr&amp;sektion=8&amp;format=html">vigr(8)</a> 编辑组文件更为推荐，因为它可以捕捉一些常见的错误。另外，也可以使用 <a href="https://man.freebsd.org/cgi/man.cgi?query=pw&amp;sektion=8&amp;format=html">pw(8)</a> 来添加和编辑组。例如，要添加一个名为 <code>teamtwo</code> 的组，并确认它是否存在：</p>
</div>
<div class="admonitionblock warning">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>在使用操作员组时必须小心，因为可能会授予意外的类似超级用户的访问权限，包括但不限于关闭、重启以及访问组中 <code>/dev</code> 中的所有项目。</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="exampleblock">
<div class="title">例 9. 使用 <a href="https://man.freebsd.org/cgi/man.cgi?query=pw&amp;sektion=8&amp;format=html">pw(8)</a> 添加一个组</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pw groupadd teamtwo</span>
<span class="c"># pw groupshow teamtwo</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>输出应该类似于以下内容：</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>teamtwo:*:1100:</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>在这个例子中，<code>1100</code> 是 <code>teamtwo</code> 的 GID 。目前，<code>teamtwo</code> 没有成员。这个命令将会把 <code>jru</code> 添加为 <code>teamtwo</code> 的成员。</p>
</div>
<div class="exampleblock">
<div class="title">例 10. 使用 <a href="https://man.freebsd.org/cgi/man.cgi?query=pw&amp;sektion=8&amp;format=html">pw(8)</a> 将用户账户添加到新组中</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pw groupmod teamtwo -M jru</span>
<span class="c"># pw groupshow teamtwo</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>输出应该类似于以下内容：</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>teamtwo:*:1100:jru</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p><code>-M</code> 参数后面是一个逗号分隔的用户列表，用于将这些用户添加到一个新的（空的）组中，或者替换现有组的成员。对于用户来说，这个组成员身份与密码文件中列出的用户的主组不同，而且是额外的。这意味着当使用 <code>groupshow</code> 和 <a href="https://man.freebsd.org/cgi/man.cgi?query=pw&amp;sektion=8&amp;format=html">pw(8)</a> 一起查看用户时，用户不会显示为组成员，但是当使用 <a href="https://man.freebsd.org/cgi/man.cgi?query=id&amp;sektion=1&amp;format=html">id(1)</a> 或类似的工具查询信息时，用户会显示为组成员。当使用 <a href="https://man.freebsd.org/cgi/man.cgi?query=pw&amp;sektion=8&amp;format=html">pw(8)</a> 将用户添加到组时，它只操作 <code>/etc/group</code> 文件，并不尝试从 <code>/etc/passwd</code> 中读取额外的数据。</p>
</div>
<div class="exampleblock">
<div class="title">例 11. 使用 <a href="https://man.freebsd.org/cgi/man.cgi?query=pw&amp;sektion=8&amp;format=html">pw(8)</a> 添加新成员到一个组中</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pw groupmod teamtwo -m db</span>
<span class="c"># pw groupshow teamtwo</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>输出应该类似于以下内容：</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>teamtwo:*:1100:jru,db</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>在这个例子中， <code>-m</code> 参数后面是一个逗号分隔的用户列表，这些用户将被添加到该组中。与前一个例子不同的是，这些用户会被追加到该组中，而不会替换掉组中已有的用户。</p>
</div>
<div class="exampleblock">
<div class="title">例 12. 使用 <a href="https://man.freebsd.org/cgi/man.cgi?query=id&amp;sektion=1&amp;format=html">id(1)</a> 来确定组成员身份</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>id jru</code></pre>
</div>
</div>
<div class="paragraph">
<p>输出应该类似于以下内容：</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>uid=1001(jru) gid=1001(jru) groups=1001(jru), 1100(teamtwo)</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>在这个例子中，<code>jru</code> 是 <code>jru</code> 和 <code>teamtwo</code> 组的成员。</p>
</div>
<div class="paragraph">
<p>有关此命令和 <code>/etc/group</code> 文件的格式的更多信息，请参阅 <a href="https://man.freebsd.org/cgi/man.cgi?query=pw&amp;sektion=8&amp;format=html">pw(8)</a> 和 <a href="https://man.freebsd.org/cgi/man.cgi?query=group&amp;sektion=5&amp;format=html">group(5)</a> 。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="permissions">3.4. 权限<a class="anchor" href="#permissions"></a></h3>
<div class="paragraph">
<p>在 FreeBSD 中，每个文件和目录都有一组关联的权限，并且有几个实用程序可用于查看和修改这些权限。要确保用户能够访问所需的文件，并且不能不正当地访问操作系统使用的文件或其他用户拥有的文件，就必须了解权限的工作原理。</p>
</div>
<div class="paragraph">
<p>本节讨论了在 FreeBSD 中使用的传统 UNIX® 权限。要进行更精细的文件系统访问控制，请参考 <a href="./#fs-acl">访问控制列表</a> 。</p>
</div>
<div class="paragraph">
<p>在 UNIX® 中，基本权限使用三种类型的访问进行分配：读取、写入和执行。这些访问类型用于确定文件的所有者、组和其他人（其他所有人）对文件的访问。读取、写入和执行权限可以用字母 <code>r</code>、<code>w</code> 和 <code>x</code> 表示。它们也可以表示为二进制数字，因为每个权限都是打开或关闭的（<code>0</code>）。当表示为数字时，顺序总是按照 <code>rwx</code> 读取，其中 <code>r</code> 的打开值为 <code>4</code> ， <code>w</code> 的打开值为 <code>2</code> ， <code>x</code> 的打开值为 <code>1</code> 。</p>
</div>
<div class="paragraph">
<p>表 4.1 总结了可能的数字和字母组合。在阅读“目录列表”列时，使用 <code>-</code> 表示权限关闭。</p>
</div>
<table class="tableblock frame-none grid-all stretch">
<caption class="title">表 3. UNIX® 权限</caption>
<colgroup>
<col style="width: 33.3333%;"/>
<col style="width: 33.3333%;"/>
<col style="width: 33.3334%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">值</th>
<th class="tableblock halign-left valign-top">权限</th>
<th class="tableblock halign-left valign-top">目录列表</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">禁止读取，禁止写入，禁止执行</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>---</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">禁止读取，禁止写入，可执行</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--x</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">禁止读取，可写入，禁止执行</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>-w-</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">禁止读取，可写入，可执行</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>-wx</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">可读取，禁止写入，禁止执行</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>r--</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">可读取，禁止写入，可执行</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>r-x</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">6</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">可读取、可写入，禁止执行</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>rw-</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">可读取，可写入，可执行</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>rwx</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>使用 <code>-l</code> 参数与 <code><a href="https://man.freebsd.org/cgi/man.cgi?query=ls&amp;sektion=1&amp;format=html">ls(1)</a></code> 一起，可以查看一个包含有关文件所有者、组和其他人权限的列的长目录列表。例如，在任意目录中使用 <code>ls -l</code> 可能会显示：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>ls -l</code></pre>
</div>
</div>
<div class="paragraph">
<p>输出应该类似于以下内容：</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>total 530
-rw-r--r--  1 root  wheel     512 Sep  5 12:31 myfile
-rw-r--r--  1 root  wheel     512 Sep  5 12:31 otherfile
-rw-r--r--  1 root  wheel    7680 Sep  5 12:31 email.txt</pre>
</div>
</div>
<div class="paragraph">
<p>关注 <code>myfile</code> 这一行，第一个（最左边的）字符表示该文件是普通文件、目录、特殊字符设备、套接字还是其他特殊伪文件设备。在这个例子中， <code>-</code> 表示普通文件。接下来的三个字符 <code>rw-</code> 表示文件所有者的权限。再接下来的三个字符 <code>r--</code> 表示文件所属组的权限。最后三个字符 <code>r--</code> 表示其他用户的权限。破折号表示权限被关闭。在这个例子中，权限被设置为文件所有者可以读写文件，文件所属组可以读取文件，其他用户只能读取文件。根据上面的表格，该文件的权限将是 <code>644</code> ，其中每个数字代表文件权限的三个部分。</p>
</div>
<div class="paragraph">
<p>系统如何控制设备的权限？ FreeBSD 将大多数硬件设备视为程序可以打开、读取和写入数据的文件。这些特殊设备文件存储在 <code>/dev/</code> 目录中。</p>
</div>
<div class="paragraph">
<p>目录也被视为文件。它们具有读取、写入和执行权限。目录的可执行位与文件的可执行位略有不同。当一个目录被标记为可执行时，意味着可以使用 <a href="https://man.freebsd.org/cgi/man.cgi?query=cd&amp;sektion=1&amp;format=html">cd(1)</a> 命令进入该目录。这也意味着可以访问该目录中的文件，但受文件本身权限的限制。</p>
</div>
<div class="paragraph">
<p>为了执行目录列表，必须在目录上设置读取权限。为了删除一个已知文件名的文件，必须对包含该文件的目录具有写入和执行权限。</p>
</div>
<div class="paragraph">
<p>还有更多的权限位，但它们主要用于特殊情况，比如 setuid 二进制文件和粘滞目录。有关文件权限及如何设置它们的更多信息，请参考 <a href="https://man.freebsd.org/cgi/man.cgi?query=chmod&amp;sektion=1&amp;format=html">chmod(1)</a> 。</p>
</div>
<div class="sect3">
<h4 id="_符号权限">3.4.1. 符号权限<a class="anchor" href="#_符号权限"></a></h4>
<div class="paragraph">
<p>符号权限使用字符而不是八进制值来为文件或目录分配权限。符号权限使用以下语法： (用户) (动作) (权限) ，可用的值如下：</p>
</div>
<table class="tableblock frame-none grid-all stretch informaltable">
<colgroup>
<col style="width: 33.3333%;"/>
<col style="width: 33.3333%;"/>
<col style="width: 33.3334%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">选项</th>
<th class="tableblock halign-left valign-top">参数</th>
<th class="tableblock halign-left valign-top">意义</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">（用户）</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">u</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">用户</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">（用户）</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">g</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">组所有者</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">（用户）</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">o</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">其他</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">（用户）</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">a</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">所有（&#34;全部&#34;）</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">（动作）</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">+</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">添加权限</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">（动作）</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">移除权限</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">（动作）</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">=</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">指定权限</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">（权限）</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">r</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">读</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">（权限）</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">w</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">写</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">（权限）</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">x</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">执行</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">（权限）</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">t</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">粘性位</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">（权限）</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">s</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">设置用户 ID 或组 ID</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>这些值与 <a href="https://man.freebsd.org/cgi/man.cgi?query=chmod&amp;sektion=1&amp;format=html">chmod(1)</a> 一起使用，但使用字母而不是数字。例如，以下命令将阻止与 <em>FILE</em> 关联的组的所有成员以及所有其他用户访问 <em>FILE</em>。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>chmod <span class="nv">go</span><span class="o">=</span> FILE</code></pre>
</div>
</div>
<div class="paragraph">
<p>当需要对文件进行多组更改时，可以提供逗号分隔的列表。例如，以下命令会移除文件 <em>FILE</em> 的组和 &#34;world&#34; 的写权限，并为所有人添加执行权限：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>chmod go-w,a+x FILE</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_freebsd_文件标志">3.4.2. FreeBSD 文件标志<a class="anchor" href="#_freebsd_文件标志"></a></h4>
<div class="paragraph">
<p>除了文件权限之外，FreeBSD 还支持使用“文件标志”。这些标志为文件提供了额外的安全性和控制，但不适用于目录。通过文件标志，即使是 <code>root</code> 也可以被阻止删除或更改文件。</p>
</div>
<div class="paragraph">
<p>使用 <a href="https://man.freebsd.org/cgi/man.cgi?query=chflags&amp;sektion=1&amp;format=html">chflags(1)</a> 命令可以修改文件标志。例如，要在文件 <code>file1</code> 上启用系统不可删除标志，执行以下命令：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># chflags sunlink file1</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>要禁用系统不可删除标志，请在 <code>sunlink</code> 前面加上 &#34;no&#34; ：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># chflags nosunlink file1</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>要查看文件的标志，可以使用 <code>-lo</code> 与 <a href="https://man.freebsd.org/cgi/man.cgi?query=ls&amp;sektion=1&amp;format=html">ls(1)</a> 一起使用：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ls -lo file1</span></code></pre>
</div>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>-rw-r--r--  1 trhodes  trhodes  sunlnk 0 Mar  1 05:54 file1</pre>
</div>
</div>
<div class="paragraph">
<p>只有 <code>root</code> 用户才能添加或删除一些文件标志。在其他情况下，文件所有者可以设置其文件标志。有关更多信息，请参阅 <a href="https://man.freebsd.org/cgi/man.cgi?query=chflags&amp;sektion=1&amp;format=html">chflags(1)</a> 和 <a href="https://man.freebsd.org/cgi/man.cgi?query=chflags&amp;sektion=2&amp;format=html">chflags(2)</a>。</p>
</div>
</div>
<div class="sect3">
<h4 id="_setuid_setgid_和_sticky_权限">3.4.3. setuid 、setgid 和 sticky 权限<a class="anchor" href="#_setuid_setgid_和_sticky_权限"></a></h4>
<div class="paragraph">
<p>除了已经讨论过的权限之外，还有三个其他特定的设置，所有管理员都应该了解。它们是 <code>setuid</code>、<code>setgid</code> 和 <code>sticky</code> 权限。</p>
</div>
<div class="paragraph">
<p>这些设置对于某些 UNIX® 操作非常重要，因为它们提供了通常不授予普通用户的功能。要理解它们，必须注意实际用户 ID 和有效用户 ID 之间的区别。</p>
</div>
<div class="paragraph">
<p>真实用户 ID 是拥有或启动进程的 UID 。有效 UID 是进程运行的用户 ID 。例如，当用户更改密码时， <a href="https://man.freebsd.org/cgi/man.cgi?query=passwd&amp;sektion=1&amp;format=html">passwd(1)</a> 以真实用户 ID 运行。然而，为了更新密码数据库，该命令以 <code>root</code> 用户的有效 ID 运行。这使得用户可以在不看到 <code>权限被拒绝</code> 错误的情况下更改密码。</p>
</div>
<div class="paragraph">
<p>可以通过为用户添加 <code>s</code> 权限来以符号方式添加 setuid 权限，示例如下：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># chmod u+s suidexample.sh</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>在下面的示例中，也可以通过在权限集前加上数字四（4）来设置 setuid 权限：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># chmod 4755 suidexample.sh</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>suidexample.sh</code> 的权限现在如下所示：</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>-rwsr-xr-x   1 trhodes  trhodes    63 Aug 29 06:36 suidexample.sh</pre>
</div>
</div>
<div class="paragraph">
<p>请注意，现在文件所有者的权限集中包含了一个 <code>s</code>，取代了可执行位。这允许使用需要提升权限的实用程序，例如 <a href="https://man.freebsd.org/cgi/man.cgi?query=passwd&amp;sektion=1&amp;format=html">passwd(1)</a> 。</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>nosuid</code> 选项是 <code>mount[8]</code> 命令中的一个选项，它会导致这些二进制文件在不通知用户的情况下静默失败。然而，这个选项并不完全可靠，因为一个 <code>nosuid</code> 包装器可能会绕过它。</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>要实时查看此内容，请打开两个终端。在其中一个终端上，以普通用户身份输入 <code>passwd</code> 。在等待新密码时，检查进程表并查看 <a href="https://man.freebsd.org/cgi/man.cgi?query=passwd&amp;sektion=1&amp;format=html">passwd(1)</a> 的用户信息。</p>
</div>
<div class="paragraph">
<p>在终端 A 中：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">Changing <span class="nb">local </span>password <span class="k">for </span>trhodes
Old Password:</code></pre>
</div>
</div>
<div class="paragraph">
<p>在终端 B 中：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ps aux | grep passwd</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">trhodes  5232  0.0  0.2  3420  1608   0  R+    2:10AM   0:00.00 grep passwd
root     5211  0.0  0.2  3620  1724   2  I+    2:09AM   0:00.01 passwd</code></pre>
</div>
</div>
<div class="paragraph">
<p>尽管 <a href="https://man.freebsd.org/cgi/man.cgi?query=passwd&amp;sektion=1&amp;format=html">passwd(1)</a> 以普通用户身份运行，但它使用的是 <code>root</code> 的有效 UID 。</p>
</div>
<div class="paragraph">
<p><code>setgid</code> 权限与 <code>setuid</code> 权限执行相同的功能，只是它改变的是组的设置。当一个应用程序或实用工具以此设置运行时，它将根据拥有文件的组而不是启动进程的用户被授予权限。</p>
</div>
<div class="paragraph">
<p>要在文件上以符号方式设置 <code>setgid</code> 权限，请使用 <a href="https://man.freebsd.org/cgi/man.cgi?query=chmod&amp;sektion=1&amp;format=html">chmod(1)</a> 命令为组添加 <code>s</code> 权限。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># chmod g+s sgidexample.sh</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>或者，给 <a href="https://man.freebsd.org/cgi/man.cgi?query=chmod&amp;sektion=1&amp;format=html">chmod(1)</a> 命令提供一个前缀的数字 2 ：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># chmod 2755 sgidexample.sh</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>在下面的清单中，请注意 <code>s</code> 现在位于用于组权限设置的字段中：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">-rwxr-sr-x   1 trhodes  trhodes    44 Aug 31 01:49 sgidexample.sh</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>在这些示例中，尽管所讨论的 shell 脚本是一个可执行文件，但它不会以不同的 EUID 或有效用户 ID 运行。这是因为 shell 脚本可能无法访问 <a href="https://man.freebsd.org/cgi/man.cgi?query=setuid&amp;sektion=2&amp;format=html">setuid(2)</a> 系统调用。</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p><code>setuid</code> 和 <code>setgid</code> 权限位可能会降低系统安全性，因为它们允许提升权限。而第三个特殊权限位，即 <code>sticky bit</code> ，可以增强系统的安全性。</p>
</div>
<div class="paragraph">
<p>当目录上设置了 <code>粘着位（sticky bit）</code> 时，只允许文件所有者删除文件。这对于防止非文件所有者在公共目录（如 <code>/tmp</code>）中删除文件非常有用。要使用此权限，请将 <code>t</code> 模式添加到文件中：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># chmod +t /tmp</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>或者，将权限集以数字 1 作为前缀：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># chmod 1777 /tmp</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>sticky bit</code> 权限将显示为权限集的最后一个字符 <code>t</code> 。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ls -al / | grep tmp</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">drwxrwxrwt  10 root  wheel         512 Aug 31 01:49 tmp</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="dirstructure">3.5. 目录结构<a class="anchor" href="#dirstructure"></a></h3>
<div class="paragraph">
<p>FreeBSD 目录层次结构对于全面了解系统至关重要。最重要的目录是根目录或者“/”。这个目录是在启动时首先挂载的，它包含了准备操作系统进行多用户操作所需的基本系统。根目录还包含其他文件系统的挂载点，在切换到多用户操作时会挂载这些文件系统。</p>
</div>
<div class="paragraph">
<p>挂载点是一个目录，可以将额外的文件系统嵌入到父文件系统（通常是根文件系统）上。这在 <a href="#disk-organization">磁盘组织</a> 中有进一步描述。标准的挂载点包括 <code>/usr/</code>、<code>/var/</code>、<code>/tmp/</code>、<code>/mnt/</code> 和 <code>/cdrom/</code> 。这些目录通常在 <code>/etc/fstab</code> 中引用。这个文件是一个包含各种文件系统和挂载点的表格，并由系统读取。除非它们的条目包含 <code>noauto</code>，否则 <code>/etc/fstab</code> 中的大多数文件系统会在启动时自动从脚本 <a href="https://man.freebsd.org/cgi/man.cgi?query=rc&amp;sektion=8&amp;format=html">rc(8)</a> 挂载。详细信息可以在 <a href="#disks-fstab">fstab 文件</a> 中找到。</p>
</div>
<div class="paragraph">
<p>文件系统层次结构的完整描述可以在 <a href="https://man.freebsd.org/cgi/man.cgi?query=hier&amp;sektion=7&amp;format=html">hier(7)</a> 中找到。下表提供了最常见目录的简要概述。</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;"/>
<col/>
</colgroup>
<tbody>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">目录</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">描述</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock"><code>/</code></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">文件系统的根目录。</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock"><code>/bin/</code></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">单用户和多用户环境的基本用户实用程序。</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock"><code>/boot/</code></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">操作系统引导过程中使用的程序和配置文件。</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock"><code>/boot/defaults/</code></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">默认的启动配置文件。有关详细信息，请参阅 <a href="https://man.freebsd.org/cgi/man.cgi?query=loader.conf&amp;sektion=5&amp;format=html">loader.conf(5)</a> 。</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock"><code>/dev/</code></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">由 <a href="https://man.freebsd.org/cgi/man.cgi?query=devfs&amp;sektion=5&amp;format=html">devfs(5)</a> 管理的设备特殊文件。</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock"><code>/etc/</code></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">系统配置文件和脚本。</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock"><code>/etc/defaults/</code></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">默认系统配置文件。有关详细信息，请参阅 <a href="https://man.freebsd.org/cgi/man.cgi?query=rc&amp;sektion=8&amp;format=html">rc(8)</a> 。</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock"><code>/etc/periodic/</code></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">通过 <a href="https://man.freebsd.org/cgi/man.cgi?query=cron&amp;sektion=8&amp;format=html">cron(8)</a> 每天、每周和每月运行的脚本。有关详细信息，请参阅 <a href="https://man.freebsd.org/cgi/man.cgi?query=periodic&amp;sektion=8&amp;format=html">periodic(8)</a> 。</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock"><code>/lib/</code></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/bin</code> 和 <code>/sbin</code> 目录中的二进制文件所需的关键系统库。</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock"><code>/libexec/</code></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">关键系统文件</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock"><code>/media/</code></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">包含用作可移动介质（如 CD、USB 驱动器和软盘）的挂载点的子目录。</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock"><code>/mnt/</code></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">空目录通常被系统管理员用作临时挂载点。</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock"><code>/net/</code></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">自动挂载的 NFS 共享；请参阅 <a href="https://man.freebsd.org/cgi/man.cgi?query=auto_master&amp;sektion=5&amp;format=html">auto_master(5)</a> 。</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock"><code>/proc/</code></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">进程文件系统。有关详细信息，请参阅 <a href="https://man.freebsd.org/cgi/man.cgi?query=procfs&amp;sektion=5&amp;format=html">procfs(5)</a> 和 <a href="https://man.freebsd.org/cgi/man.cgi?query=mount_procfs&amp;sektion=8&amp;format=html">mount_procfs(8)</a> 。</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock"><code>/rescue/</code></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">用于紧急恢复的静态链接程序，如 <a href="https://man.freebsd.org/cgi/man.cgi?query=rescue&amp;sektion=8&amp;format=html">rescue(8)</a> 中所述。</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock"><code>/root/</code></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>root</code> 账户的主目录。</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock"><code>/sbin/</code></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">单用户和多用户环境的基本系统程序和管理工具。</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock"><code>/tmp/</code></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">通常在系统重新启动后不会保留的临时文件。基于内存的文件系统通常会挂载在 <code>/tmp</code> 目录下。可以使用 <a href="https://man.freebsd.org/cgi/man.cgi?query=rc.conf&amp;sektion=5&amp;format=html">rc.conf(5)</a> 中与 tmpmfs 相关的变量或在 <code>/etc/fstab</code> 中添加条目来自动化此过程；有关详细信息，请参阅 <a href="https://man.freebsd.org/cgi/man.cgi?query=mdmfs&amp;sektion=8&amp;format=html">mdmfs(8)</a> 。</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock"><code>/usr/</code></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">大多数用户工具和应用程序。</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock"><code>/usr/bin/</code></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">常用工具、编程工具和应用程序。</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock"><code>/usr/include/</code></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">标准的 C 头文件。</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock"><code>/usr/lib/</code></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">库文件</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock"><code>/usr/libdata/</code></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">杂项实用数据文件。</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock"><code>/usr/libexec/</code></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">系统守护进程和由其他程序执行的系统实用工具。</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock"><code>/usr/local/</code></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">本地可执行文件和库。也被用作 FreeBSD ports 框架的默认目的地。在 <code>/usr/local</code> 中，应使用 <a href="https://man.freebsd.org/cgi/man.cgi?query=hier&amp;sektion=7&amp;format=html">hier(7)</a> 为 <code>/usr</code> 预设的一般布局。man 目录例外，它直接位于 <code>/usr/local</code> 而不是 <code>/usr/local/share</code> 下，而 ports 文档位于 <code>share/doc/port</code> 中。</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock"><code>/usr/ports/</code></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">FreeBSD Ports 集合（可选）。</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock"><code>/usr/sbin/</code></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">系统守护进程和由用户执行的系统实用程序。</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock"><code>/usr/share/</code></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">与体系结构无关的文件。</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock"><code>/usr/src/</code></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">BSD 或本地源文件。</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock"><code>/var/</code></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">多用途日志、临时、暂存和溢出文件。</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock"><code>/var/log/</code></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">杂项系统日志文件。</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock"><code>/var/tmp/</code></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">通常在系统重启后保留的临时文件。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="disk-organization">3.6. 磁盘组织<a class="anchor" href="#disk-organization"></a></h3>
<div class="paragraph">
<p>FreeBSD 使用的最小组织单位是文件名。文件名区分大小写，这意味着 <code>readme.txt</code> 和 <code>README.TXT</code> 是两个不同的文件。 FreeBSD 不使用文件的扩展名来确定文件是程序、文档还是其他形式的数据。</p>
</div>
<div class="paragraph">
<p>文件存储在目录中。一个目录可以不包含任何文件，也可以包含数百个文件。一个目录还可以包含其他目录，从而允许在彼此之间建立目录层次结构以组织数据。</p>
</div>
<div class="paragraph">
<p>文件和目录的引用是通过给出文件或目录名称，后跟一个斜杠 <code>/</code> ，再跟上其他必要的目录名称来完成的。例如，如果目录 <code>foo</code> 包含一个目录 <code>bar</code>，该目录又包含文件 <code>readme.txt</code> ，那么文件的完整名称，或者路径，就是 <code>foo/bar/readme.txt</code>。请注意，这与 Windows® 不同，Windows 使用反斜杠 <code>\</code> 来分隔文件和目录名称。 FreeBSD 在路径中不使用驱动器号或其他驱动器名称。例如，在 FreeBSD 上，不会输入 <code>c:\foo\bar\readme.txt</code>。</p>
</div>
<div class="sect3">
<h4 id="disks-file-systems">3.6.1. 文件系统<a class="anchor" href="#disks-file-systems"></a></h4>
<div class="paragraph">
<p>目录和文件存储在文件系统中。每个文件系统在最顶层都包含一个目录，称为该文件系统的根目录。这个根目录可以包含其他目录。一个文件系统被指定为根文件系统或 <code>/</code> 。其他所有文件系统都被挂载在根文件系统下。无论 FreeBSD 系统上有多少个磁盘，每个目录都看起来是同一个磁盘的一部分。</p>
</div>
<div class="paragraph">
<p>考虑三个文件系统，分别称为 <code>A</code>、<code>B</code> 和 <code>C</code>。每个文件系统都有一个根目录，其中包含两个其他目录，分别称为 <code>A1</code>、<code>A2</code> （同样也有 <code>B1</code>、<code>B2</code> 和 <code>C1</code>、<code>C2</code>）。</p>
</div>
<div class="paragraph">
<p>将 <code>A</code> 称为根文件系统。如果使用 <a href="https://man.freebsd.org/cgi/man.cgi?query=ls&amp;sektion=1&amp;format=html">ls(1)</a> 命令查看该目录的内容，将显示两个子目录，<code>A1</code> 和 <code>A2</code>。目录树如下所示：</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/basics/example-dir1.png" alt="带有根目录和两个子目录的目录树" width="A1 and A2"/>
</div>
</div>
<div class="paragraph">
<p>一个文件系统必须被挂载到另一个文件系统的目录上。当将文件系统 <code>B</code> 挂载到目录 <code>A1</code> 上时，<code>B</code> 的根目录将替换 <code>A1</code>，并且 <code>B</code> 中的目录会相应地显示出来：</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/basics/example-dir2.png" alt="带有根目录和两个子目录的目录树" width="A1 and A2. And more subdirectories" height="B1 and B2 hanging from A1"/>
</div>
</div>
<div class="paragraph">
<p>任何位于 <code>B1</code> 或 <code>B2</code> 目录中的文件可以通过路径 <code>/A1/B1</code> 或 <code>/A1/B2</code> 访问。任何位于 <code>/A1</code> 中的文件都被临时隐藏了。如果从 <code>A</code> 卸载 <code>B</code>，它们将重新出现。</p>
</div>
<div class="paragraph">
<p>如果 <code>B</code> 被安装在 <code>A2</code> 上，那么图表将如下所示：</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/basics/example-dir3.png" alt="带有根目录和两个子目录的目录树" width="A1 and A2. And more subdirectories" height="B1 and B2 hanging from A2"/>
</div>
</div>
<div class="paragraph">
<p>路径分别为 <code>/A2/B1</code> 和 <code>/A2/B2</code>。</p>
</div>
<div class="paragraph">
<p>文件系统可以相互叠加挂载。继续上一个例子，<code>C</code> 文件系统可以被挂载在 <code>B</code> 文件系统中的 <code>B1</code> 目录上方，形成以下的安排：</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/basics/example-dir4.png" alt="一个复杂的目录树。根目录下有不同的子目录。"/>
</div>
</div>
<div class="paragraph">
<p>或者 <code>C</code> 可以直接挂载到 <code>A</code> 文件系统下的 <code>A1</code> 目录中：</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/basics/example-dir5.png" alt="一个复杂的目录树。根目录下有不同的子目录。"/>
</div>
</div>
<div class="paragraph">
<p>完全可以只有一个大的根文件系统，而不需要创建其他文件系统。这种方法有一些缺点和一个优点。</p>
</div>
<div class="ulist">
<div class="title">多个文件系统的好处</div>
<ul>
<li>
<p>不同的文件系统可以有不同的挂载选项。例如，根文件系统可以以只读方式挂载，这样用户就无法意外删除或编辑关键文件。将可由用户写入的文件系统（如 <code>/home</code>）与其他文件系统分离，可以将它们挂载为 <em>nosuid</em> 。此选项可以防止文件系统上存储的可执行文件的_ suid_/<em>guid</em> 位生效，从而可能提高安全性。</p>
</li>
<li>
<p>FreeBSD 会根据文件系统的使用情况自动优化文件的布局。因此，包含许多频繁写入的小文件的文件系统将与包含较少且较大的文件的文件系统有所不同的优化方式。如果只有一个大文件系统，这种优化将失效。</p>
</li>
<li>
<p>如果断电，FreeBSD 的文件系统是健壮的。然而，在关键时刻断电仍然可能损坏文件系统的结构。通过将数据分散在多个文件系统上，系统更有可能重新启动，从而更容易根据需要进行备份恢复。</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">单一文件系统的好处</div>
<ul>
<li>
<p>文件系统是固定大小的。如果在安装 FreeBSD 时创建了一个文件系统并指定了特定的大小，您可能会发现以后需要扩大分区的大小。这不容易实现，需要先备份数据，然后使用新的大小重新创建文件系统，最后恢复备份的数据。</p>
<div class="admonitionblock important">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>FreeBSD 具有 <a href="https://man.freebsd.org/cgi/man.cgi?query=growfs&amp;sektion=8&amp;format=html">growfs(8)</a> 命令，可以在运行时增加文件系统的大小，从而消除了这一限制。文件系统只能扩展到所在分区的可用空间中。如果分区后面有空间，可以使用 <a href="https://man.freebsd.org/cgi/man.cgi?query=gpart&amp;sektion=8&amp;format=html">gpart(8)</a> 来扩展分区。如果分区是虚拟磁盘上的最后一个分区，并且磁盘被扩展了，那么可以扩展该分区。</p>
</div>
</td>
</tr>
</tbody></table>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="disks-partitions">3.6.2. 磁盘分区<a class="anchor" href="#disks-partitions"></a></h4>
<div class="paragraph">
<p>文件系统包含在 <em>分区</em> 中。使用多种分区方案将磁盘划分为分区；参见 <a href="#bsdinstall-part-manual">手动分区</a>。较新的方案是 GPT ；旧的基于 BIOS 的计算机使用 MBR。GPT 支持将磁盘划分为具有大小、偏移和类型的分区。它支持大量的分区和分区类型，并且在可能的情况下推荐使用。GPT 分区使用磁盘名称加后缀，后缀为 <code>p1</code> 表示第一个分区，<code>p2</code> 表示第二个分区，依此类推。然而，MBR 仅支持少量的分区。在 FreeBSD 中，MBR 分区被称为 <code>slices</code>。 Slices 可以用于不同的操作系统。 FreeBSD slices 使用 BSD 标签进行分区细分（参见 <a href="https://man.freebsd.org/cgi/man.cgi?query=bsdlabel&amp;sektion=8&amp;format=html">bsdlabel(8)</a>）。</p>
</div>
<div class="paragraph">
<p>Slice 号码遵循设备名称，以 <code>s</code> 为前缀，从 1 开始。因此，“da0<em>s1</em>”是第一个 SCSI 驱动器上的第一个 slice。一个磁盘上只能有四个物理 slice，但是在适当类型的物理切片内可以有逻辑 slice。这些扩展 slice 从 5 开始编号，因此“ada0<em>s5</em>”是第一个 SATA 磁盘上的第一个扩展 slice。这些设备由希望占用一个 slice 的文件系统使用。</p>
</div>
<div class="paragraph">
<p>每个 GPT 或 BSD 分区只能包含一个文件系统，这意味着文件系统通常通过其在文件系统层次结构中的典型挂载点或它们所包含的分区的名称来描述。</p>
</div>
<div class="paragraph">
<p>FreeBSD 还使用磁盘空间作为 <em>交换空间</em> 来提供 <em>虚拟内存</em>。这使得您的计算机可以表现得好像它拥有比实际更多的内存。当 FreeBSD 内存不足时，它将一些当前未使用的数据移动到交换空间，并在需要时将其移回（将其他数据移出）。这被称为 <em>分页</em>。</p>
</div>
<div class="paragraph">
<p>一些 BSD 分区与特定的约定相关联。</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;"/>
<col/>
</colgroup>
<tbody>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">分区</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">惯例</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock"><code>a</code></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">通常包含根文件系统。</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock"><code>b</code></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">通常包含交换空间。</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock"><code>c</code></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">通常与包含的 slice 大小相同。这样可以使需要在整个 slice 上工作的实用程序（例如坏块扫描器）能够在 <code>c</code> 分区上工作。通常不会在此分区上创建文件系统。</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock"><code>d</code></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">分区 <code>d</code> 曾经有一个特殊的含义，但现在已经消失了，<code>d</code> 可以像任何普通分区一样工作。</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Slices 和“危险专用”物理驱动器包含 BSD 分区，这些分区用字母 <code>a</code> 到 <code>h</code> 表示。这个字母被附加到设备名称上，所以“ da0<em>a</em>”是第一个 <code>da</code> 驱动器上的 <code>a</code> 分区，该驱动器是“危险专用”的。“ada1s3<em>e</em>”是第二个 SATA 磁盘驱动器的第三个 slice 中的第五个分区。</p>
</div>
<div class="paragraph">
<p>最后，系统上的每个磁盘都有一个标识。磁盘名称以表示磁盘类型的代码开头，然后是一个数字，表示它是第几个磁盘。与分区和切片不同，磁盘编号从 0 开始。常见的代码列在 <a href="#disks-naming">磁盘设备名称</a> 中。</p>
</div>
<div class="paragraph">
<p>在引用 slice 中的分区时，请包括磁盘名称、<code>s</code> 、切片编号，然后是分区字母。示例见 <a href="#basics-disk-slice-part">示例磁盘、Slice 和分区名称</a> 。 GPT 分区包括磁盘名称、<code>p</code>，然后是分区编号。</p>
</div>
<div class="paragraph">
<p><a href="#basics-concept-disk-model">磁盘的概念模型</a> 展示了使用 MBR 分区的磁盘布局的概念模型。</p>
</div>
<div class="paragraph">
<p>在安装 FreeBSD 时，如果使用 MBR，请配置磁盘 slice，并在 slice 内创建用于 FreeBSD 的分区。如果使用 GPT ，请为每个文件系统配置分区。无论哪种情况，都要在每个分区中创建文件系统或交换空间，并决定每个文件系统将被挂载到哪里。有关操作分区的信息，请参阅 <a href="https://man.freebsd.org/cgi/man.cgi?query=gpart&amp;sektion=8&amp;format=html">gpart(8)</a> 。</p>
</div>
<table id="disks-naming" class="tableblock frame-none grid-all stretch">
<caption class="title">表 4. 磁盘设备名称</caption>
<colgroup>
<col style="width: 50%;"/>
<col style="width: 50%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">驱动类型</th>
<th class="tableblock halign-left valign-top">驱动设备名称</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SATA 和 IDE 硬盘</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ada</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SCSI 硬盘和 USB 存储设备</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>da</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">NVMe 存储</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>nvd</code> or <code>nda</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SATA 和 IDE CD-ROM 驱动器</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>cd</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SCSI CD-ROM 驱动器</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>cd</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">软盘驱动器</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>fd</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SCSI 磁带驱动器</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sa</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">RAID 驱动器</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">例如，Adaptec® AdvancedRAID 的 <code>aacd</code>、Mylex® 的 <code>mlxd</code> 和 <code>mlyd</code>、AMI MegaRAID® 的 <code>amrd</code>、Compaq Smart RAID 的 <code>idad</code>、3ware® RAID 的 <code>twed</code>。</p></td>
</tr>
</tbody>
</table>
<div class="exampleblock">
<div class="content">
<table id="basics-disk-slice-part" class="tableblock frame-none grid-all stretch informaltable">
<caption class="title">表 5. 示例磁盘、Slice 和分区名称</caption>
<colgroup>
<col style="width: 50%;"/>
<col style="width: 50%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">名称</th>
<th class="tableblock halign-left valign-top">意义</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ada0s1a</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">第一个 SATA 磁盘（<code>ada0</code>）上的第一个 slice（<code>s1</code>）上第一个分区（<code>a</code>）。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>da1s2e</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">第二个 SCSI 磁盘（<code>da1</code>）上第二个 slice（<code>s2</code>）上的第五个分区（<code>e</code>）。</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="basics-concept-disk-model" class="exampleblock">
<div class="title">例 13. 磁盘的概念模型</div>
<div class="content">
<div class="paragraph">
<p>这个图示展示了 FreeBSD 对系统上连接的第一个 SATA 硬盘的视图。假设该硬盘的容量为 250GB ，包含一个 80GB 的分区和一个 170GB 的分区（MS-DOS® 分区）。第一个分区包含一个 Windows® NTFS 文件系统，即 <code>C:</code>，而第二个分区包含一个 FreeBSD 安装。这个示例的 FreeBSD 安装有四个数据分区和一个交换分区。</p>
</div>
<div class="paragraph">
<p>四个分区分别持有一个文件系统。分区 <code>a</code> 用于根文件系统，<code>d</code> 用于 <code>/var/</code>，<code>e</code> 用于 <code>/tmp/</code>，<code>f</code> 用于 <code>/usr/</code>。分区字母 <code>c</code> 指的是整个 slice，因此不用于普通分区。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/basics/disk-layout.png" alt="Windows 和 FreeBSD 之间共享驱动器的布局"/>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mount-unmount">3.7. 挂载和卸载文件系统<a class="anchor" href="#mount-unmount"></a></h3>
<div class="paragraph">
<p>文件系统最好被视为一棵树，以 <code>/</code> 作为根节点。根目录中的 <code>/dev</code>、<code>/usr</code> 和其他目录是分支，它们可能有自己的分支，比如 <code>/usr/local</code> 等等。</p>
</div>
<div class="paragraph">
<p>将一些目录放在单独的文件系统上有各种原因。<code>/var</code> 包含了 <code>log/</code>、<code>spool/</code> 以及各种类型的临时文件，因此可能会被填满。填满根文件系统是不明智的，所以将 <code>/var</code> 与 <code>/</code> 分离通常是可取的。</p>
</div>
<div class="paragraph">
<p>将某些目录树包含在其他文件系统中的另一个常见原因是它们将被放置在单独的物理磁盘上，或者是单独的虚拟磁盘，例如网络文件系统挂载，如 <a href="./#network-nfs">“网络文件系统（ NFS ）”</a> 描述的，或者 CDROM 驱动器。</p>
</div>
<div class="sect3">
<h4 id="disks-fstab">3.7.1. fstab 文件<a class="anchor" href="#disks-fstab"></a></h4>
<div class="paragraph">
<p>在引导过程中（<a href="./#boot">FreeBSD 引导过程</a>），除了包含 <code>noauto</code> 条目的条目外，<code>/etc/fstab</code> 中列出的文件系统会自动挂载。该文件以以下格式包含条目：</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>device       /mount-point fstype     options      dumpfreq     passno</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>device</code></dt>
<dd>
<p>如 <a href="#disks-naming">磁盘设备名称</a> 中所解释的，现有设备名称。</p>
</dd>
<dt class="hdlist1"><code>mount-point</code></dt>
<dd>
<p>一个现有的目录，用于挂载文件系统。</p>
</dd>
<dt class="hdlist1"><code>fstype</code></dt>
<dd>
<p>传递给 <a href="https://man.freebsd.org/cgi/man.cgi?query=mount&amp;sektion=8&amp;format=html">mount(8)</a> 的文件系统类型。默认的 FreeBSD 文件系统是 <code>ufs</code>。</p>
</dd>
<dt class="hdlist1"><code>options</code></dt>
<dd>
<p>可以选择 <code>rw</code> 表示读写文件系统，或者 <code>ro</code> 表示只读文件系统，后面可以添加其他可能需要的选项。常见的选项是 <code>noauto</code> ，用于在启动序列期间通常不挂载的文件系统。其他选项可以在 <a href="https://man.freebsd.org/cgi/man.cgi?query=mount&amp;sektion=8&amp;format=html">mount(8)</a> 中找到。</p>
</dd>
<dt class="hdlist1"><code>dumpfreq</code></dt>
<dd>
<p><a href="https://man.freebsd.org/cgi/man.cgi?query=dump&amp;sektion=8&amp;format=html">dump(8)</a> 使用此字段来确定哪些文件系统需要进行备份。如果该字段缺失，则默认为零值。</p>
</dd>
<dt class="hdlist1"><code>passno</code></dt>
<dd>
<p>确定在重新启动后，<a href="https://man.freebsd.org/cgi/man.cgi?query=fsck&amp;sektion=8&amp;format=html">fsck(8)</a> 应该按照什么顺序检查 UFS 文件系统。应该跳过的文件系统应该将其 <code>passno</code> 设置为零。根文件系统需要在其他所有文件系统之前进行检查，并且其 <code>passno</code> 应该设置为一。其他文件系统的 <code>passno</code> 应该设置为大于一的值。如果有多个文件系统具有相同的 <code>passno</code>，<a href="https://man.freebsd.org/cgi/man.cgi?query=fsck&amp;sektion=8&amp;format=html">fsck(8)</a> 将尝试在可能的情况下并行检查文件系统。</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>请参考 <a href="https://man.freebsd.org/cgi/man.cgi?query=fstab&amp;sektion=5&amp;format=html">fstab(5)</a> 以获取有关 <code>/etc/fstab</code> 格式及其选项的更多信息。</p>
</div>
</div>
<div class="sect3">
<h4 id="disks-mount">3.7.2. 使用 <a href="https://man.freebsd.org/cgi/man.cgi?query=mount&amp;sektion=8&amp;format=html">mount(8)</a><a class="anchor" href="#disks-mount"></a></h4>
<div class="paragraph">
<p>文件系统使用 <a href="https://man.freebsd.org/cgi/man.cgi?query=mount&amp;sektion=8&amp;format=html">mount(8)</a> 进行挂载。最基本的语法如下：</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># mount device mountpoint</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>在 <code>/etc/fstab</code> 中列出的文件系统也可以通过提供挂载点来挂载。</p>
</div>
<div class="paragraph">
<p>该命令提供了许多选项，这些选项在 <a href="https://man.freebsd.org/cgi/man.cgi?query=mount&amp;sektion=8&amp;format=html">mount(8)</a> 中有描述。最常用的选项包括：</p>
</div>
<div class="dlist">
<div class="title">挂载选项</div>
<dl>
<dt class="hdlist1"><code>-a</code></dt>
<dd>
<p>挂载 <code>/etc/fstab</code> 中列出的所有文件系统，除了那些标记为“noauto”、被 <code>-t</code> 标志排除的文件系统，以及已经挂载的文件系统。</p>
</dd>
<dt class="hdlist1"><code>-d</code></dt>
<dd>
<p>执行除实际挂载系统调用之外的所有操作。这个选项与 <code>-v</code> 标志一起使用非常有用，可以确定 <a href="https://man.freebsd.org/cgi/man.cgi?query=mount&amp;sektion=8&amp;format=html">mount(8)</a> 实际上正在尝试做什么。</p>
</dd>
<dt class="hdlist1"><code>-f</code></dt>
<dd>
<p>强制挂载一个不干净的文件系统（危险操作），或者在将文件系统的挂载状态从读写改为只读时，撤销写访问权限。</p>
</dd>
<dt class="hdlist1"><code>-r</code></dt>
<dd>
<p>将文件系统挂载为只读模式。这与使用 <code>-o ro</code> 参数完全相同。</p>
</dd>
<dt class="hdlist1"><code>-t <em>fstype</em></code></dt>
<dd>
<p>如果包含 <code>-a</code> 选项，则挂载指定的文件系统类型或仅挂载给定类型的文件系统。“ufs”是默认的文件系统类型。</p>
</dd>
<dt class="hdlist1"><code>-u</code></dt>
<dd>
<p>更新文件系统的挂载选项。</p>
</dd>
<dt class="hdlist1"><code>-v</code></dt>
<dd>
<p>提供详细信息。</p>
</dd>
<dt class="hdlist1"><code>-w</code></dt>
<dd>
<p>将文件系统挂载为读写模式。</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>可以将以下选项作为逗号分隔的列表传递给 <code>-o</code>：</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">nosuid</dt>
<dd>
<p>不要读取文件系统上的 <code>setuid</code> 或 <code>setgid</code> 标志。这也是一个有用的安全选项。</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="disks-umount">3.7.3. 使用 <a href="https://man.freebsd.org/cgi/man.cgi?query=umount&amp;sektion=8&amp;format=html">umount(8)</a><a class="anchor" href="#disks-umount"></a></h4>
<div class="paragraph">
<p>要卸载文件系统，请使用 <a href="https://man.freebsd.org/cgi/man.cgi?query=umount&amp;sektion=8&amp;format=html">umount(8)</a> 命令。该命令接受一个参数，可以是挂载点、设备名称、<code>-a</code> 或 <code>-A</code>。</p>
</div>
<div class="paragraph">
<p>所有的表单都可以使用 <code>-f</code> 来强制卸载，并且使用 <code>-v</code> 来显示详细信息。请注意，一般情况下不建议使用 <code>-f</code>，因为它可能会导致计算机崩溃或者损坏文件系统上的数据。</p>
</div>
<div class="paragraph">
<p>要卸载所有已挂载的文件系统，或者只卸载在 <code>-t</code> 后面列出的文件系统类型，请使用 <code>-a</code> 或 <code>-A</code> 选项。请注意，<code>-A</code> 选项不会尝试卸载根文件系统。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="basics-processes">3.8. 进程和守护进程<a class="anchor" href="#basics-processes"></a></h3>
<div class="paragraph">
<p>FreeBSD 是一个多任务操作系统。每个同时运行的程序被称为一个 <em>进程</em>。每个正在运行的命令都会启动至少一个新的进程，并且 FreeBSD 还会运行一些系统进程。</p>
</div>
<div class="paragraph">
<p>每个进程都由一个称为 <em>进程 ID</em>（PID）的数字唯一标识。与文件类似，每个进程都有一个所有者和组，并且所有者和组权限用于确定进程可以打开哪些文件和设备。大多数进程还有一个启动它们的父进程。例如，shell 是一个进程，shell 中启动的任何命令都是一个进程，其父进程是 shell 。例外情况是一个特殊的进程，称为 <a href="https://man.freebsd.org/cgi/man.cgi?query=init&amp;sektion=8&amp;format=html">init(8)</a>，它始终是在启动时第一个启动的进程，其 PID 始终为 <code>1</code>。</p>
</div>
<div class="paragraph">
<p>有些程序并不是设计成需要连续的用户输入，也不能在第一时间与终端断开连接。例如，Web 服务器响应 Web 请求，而不是用户输入。邮件服务器是另一种这种类型的应用程序。这些类型的程序被称为 <em>守护进程（daemon）</em>。术语 daemon 来自希腊神话，代表着一个既不善良也不邪恶的实体，它在不可见的情况下执行有用的任务。这就是为什么 BSD 吉祥物是一个看起来开心的带着运动鞋和叉子的 daemon。</p>
</div>
<div class="paragraph">
<p>有一个约定，即通常作为守护进程运行的程序的命名方式是以字母&#34;d&#34;结尾的。例如，BIND 是 Berkeley Internet Name Domain 的缩写，但实际执行的程序是 <code>named</code>。Apache Web 服务器程序是 <code>httpd</code> ，线打印机排队守护进程是 <code>lpd</code>。这只是一种命名约定。例如，Sendmail 应用程序的主邮件守护进程是 <code>sendmail</code>，而不是 <code>maild</code>。</p>
</div>
<div class="sect3">
<h4 id="_查看进程">3.8.1. 查看进程<a class="anchor" href="#_查看进程"></a></h4>
<div class="paragraph">
<p>要查看系统上运行的进程，请使用 <a href="https://man.freebsd.org/cgi/man.cgi?query=ps&amp;sektion=1&amp;format=html">ps(1)</a> 或 <a href="https://man.freebsd.org/cgi/man.cgi?query=top&amp;sektion=1&amp;format=html">top(1)</a>。要显示当前正在运行的进程的静态列表，包括它们的进程 ID 、使用的内存量以及启动它们的命令，请使用 <a href="https://man.freebsd.org/cgi/man.cgi?query=ps&amp;sektion=1&amp;format=html">ps(1)</a> 。要显示所有正在运行的进程，并每隔几秒更新一次显示，以便交互式地查看计算机正在做什么，请使用 <a href="https://man.freebsd.org/cgi/man.cgi?query=top&amp;sektion=1&amp;format=html">top(1)</a>。</p>
</div>
<div class="paragraph">
<p>默认情况下，<a href="https://man.freebsd.org/cgi/man.cgi?query=ps&amp;sektion=1&amp;format=html">ps(1)</a> 只显示正在运行且由用户拥有的命令。例如：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>ps</code></pre>
</div>
</div>
<div class="paragraph">
<p>输出应该类似于以下内容：</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre> PID TT  STAT    TIME COMMAND
8203  0  Ss   0:00.59 /bin/csh
8895  0  R+   0:00.00 ps</pre>
</div>
</div>
<div class="paragraph">
<p><a href="https://man.freebsd.org/cgi/man.cgi?query=ps&amp;sektion=1&amp;format=html">ps(1)</a> 的输出被组织成多列。<code>PID</code> 列显示进程 ID。PID 从 1 开始分配，最大为 99999 ，然后重新从头开始分配。然而，如果 PID 已经被使用，它不会被重新分配。<code>TT</code> 列显示程序所在的 tty，<code>STAT</code> 列显示程序的状态。 <code>TIME</code> 是程序在 CPU 上运行的时间。这通常不是程序启动后经过的时间，因为大多数程序在需要在 CPU 上花费时间之前会花费很多时间等待事件发生。最后，<code>COMMAND</code> 是用于启动程序的命令。</p>
</div>
<div class="paragraph">
<p>有多种不同的选项可用于更改显示的信息。其中最有用的一组是 <code>auxww</code>，其中 <code>a</code> 显示有关所有用户的所有运行进程的信息，<code>u</code> 显示进程所有者的用户名和内存使用情况，<code>x</code> 显示有关守护进程的信息，<code>ww</code> 使 <a href="https://man.freebsd.org/cgi/man.cgi?query=ps&amp;sektion=1&amp;format=html">ps(1)</a> 显示每个进程的完整命令行，而不是在屏幕上显示过长时截断它。</p>
</div>
<div class="paragraph">
<p><a href="https://man.freebsd.org/cgi/man.cgi?query=top&amp;sektion=1&amp;format=html">top(1)</a> 的输出类似：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>top</code></pre>
</div>
</div>
<div class="paragraph">
<p>输出应该类似于以下内容：</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>last pid:  9609;  load averages:  0.56,  0.45,  0.36              up 0+00:20:03  10:21:46
107 processes: 2 running, 104 sleeping, 1 zombie
CPU:  6.2% user,  0.1% nice,  8.2% system,  0.4% interrupt, 85.1% idle
Mem: 541M Active, 450M Inact, 1333M Wired, 4064K Cache, 1498M Free
ARC: 992M Total, 377M MFU, 589M MRU, 250K Anon, 5280K Header, 21M Other
Swap: 2048M Total, 2048M Free

  PID USERNAME    THR PRI NICE   SIZE    RES STATE   C   TIME   WCPU COMMAND
  557 root          1 -21  r31   136M 42296K select  0   2:20  9.96% Xorg
 8198 dru           2  52    0   449M 82736K select  3   0:08  5.96% kdeinit4
 8311 dru          27  30    0  1150M   187M uwait   1   1:37  0.98% firefox
  431 root          1  20    0 14268K  1728K select  0   0:06  0.98% moused
 9551 dru           1  21    0 16600K  2660K CPU3    3   0:01  0.98% top
 2357 dru           4  37    0   718M   141M select  0   0:21  0.00% kdeinit4
 8705 dru           4  35    0   480M    98M select  2   0:20  0.00% kdeinit4
 8076 dru           6  20    0   552M   113M uwait   0   0:12  0.00% soffice.bin
 2623 root          1  30   10 12088K  1636K select  3   0:09  0.00% powerd
 2338 dru           1  20    0   440M 84532K select  1   0:06  0.00% kwin
 1427 dru           5  22    0   605M 86412K select  1   0:05  0.00% kdeinit4</pre>
</div>
</div>
<div class="paragraph">
<p>输出分为两个部分。标题部分（前五或六行）显示了最后一个运行的进程的 PID ，系统负载平均值（衡量系统繁忙程度的指标），系统运行时间（自上次重启以来的时间）和当前时间。标题中的其他数字与正在运行的进程数量、已使用的内存和交换空间以及系统在不同 CPU 状态下花费的时间有关。如果加载了 ZFS 文件系统模块，<code>ARC</code> 行将显示有多少数据是从内存缓存中读取而不是从磁盘中读取的。</p>
</div>
<div class="paragraph">
<p>在标题下面是一系列列，其中包含与 <a href="https://man.freebsd.org/cgi/man.cgi?query=ps&amp;sektion=1&amp;format=html">ps(1)</a> 输出类似的信息，例如 PID、用户名、CPU 时间和启动进程的命令。默认情况下，<a href="https://man.freebsd.org/cgi/man.cgi?query=top&amp;sektion=1&amp;format=html">top(1)</a> 还会显示进程占用的内存空间。这被分为两列：总大小和常驻大小。总大小是应用程序所需的内存量，常驻大小是它当前实际使用的内存量。</p>
</div>
<div class="paragraph">
<p><a href="https://man.freebsd.org/cgi/man.cgi?query=top&amp;sektion=1&amp;format=html">top(1)</a> 每两秒自动更新显示。可以使用 <code>-s</code> 指定不同的间隔。</p>
</div>
</div>
<div class="sect3">
<h4 id="basics-daemons">3.8.2. 杀死进程<a class="anchor" href="#basics-daemons"></a></h4>
<div class="paragraph">
<p>与任何正在运行的进程或守护进程进行通信的一种方法是使用 <a href="https://man.freebsd.org/cgi/man.cgi?query=kill&amp;sektion=1&amp;format=html">kill(1)</a> 发送一个 <em>信号（signal）</em>。有许多不同的信号；一些具有特定的含义，而其他信号在应用程序的文档中有描述。用户只能向自己拥有的进程发送信号，向他人的进程发送信号将导致权限被拒绝的错误。例外情况是 <code>root</code> 用户，他可以向任何进程发送信号。</p>
</div>
<div class="paragraph">
<p>操作系统也可以向进程发送信号。如果一个应用程序编写得很糟糕，试图访问它不应该访问的内存， FreeBSD 将向该进程发送“分段违规（Segmentation Violation）”信号（<code>SIGSEGV</code>）。如果一个应用程序被编写成使用 <a href="https://man.freebsd.org/cgi/man.cgi?query=alarm&amp;sektion=3&amp;format=html">alarm(3)</a> 系统调用，在经过一段时间后被提醒，它将收到“闹钟（Alarm）”信号（<code>SIGALRM</code>）。</p>
</div>
<div class="paragraph">
<p>有两个信号可以用来停止一个进程：<code>SIGTERM</code> 和 <code>SIGKILL</code>。<code>SIGTERM</code> 是一种礼貌的方式来终止一个进程，因为进程可以读取该信号，关闭可能打开的任何日志文件，并尝试在关闭之前完成正在进行的操作。在某些情况下，如果进程正在执行无法中断的任务，它可能会忽略 <code>SIGTERM</code> 信号。</p>
</div>
<div class="paragraph">
<p><code>SIGKILL</code> 无法被进程忽略。向一个进程发送 <code>SIGKILL</code> 通常会立即停止该进程。<sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup> 。</p>
</div>
<div class="paragraph">
<p>其他常用的信号包括 <code>SIGHUP</code>、<code>SIGUSR1</code> 和 <code>SIGUSR2</code>。由于这些是通用的信号，不同的应用程序会有不同的响应。</p>
</div>
<div class="paragraph">
<p>例如，在更改 Web 服务器的配置文件后，需要告诉 Web 服务器重新读取其配置。重新启动 <code>httpd</code> 将导致 Web 服务器短暂的停机时间。相反，发送 <code>SIGHUP</code> 信号给守护进程。请注意，不同的守护进程会有不同的行为，因此请参考守护进程的文档以确定是否使用 <code>SIGHUP</code> 可以达到所需的结果。</p>
</div>
<div class="admonitionblock important">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>在系统上随机杀死一个进程是一个坏主意。特别是，<a href="https://man.freebsd.org/cgi/man.cgi?query=init&amp;sektion=8&amp;format=html">init(8)</a>，PID 1 ，是特殊的。运行 <code>/bin/kill -s KILL 1</code> 是一个快速但不推荐的关闭系统的方法。在按下 <kbd>Return</kbd> 之前，<em>始终</em> 仔细检查 <a href="https://man.freebsd.org/cgi/man.cgi?query=kill&amp;sektion=1&amp;format=html">kill(1)</a> 的参数。</p>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="shells">3.9. Shells<a class="anchor" href="#shells"></a></h3>
<div class="paragraph">
<p>一个 <em>shell</em> 提供了一个命令行界面，用于与操作系统进行交互。 Shell 从输入通道接收命令并执行它们。许多 shell 提供了内置函数来帮助处理日常任务，如文件管理、文件通配符、命令行编辑、命令宏和环境变量。 FreeBSD 提供了几个 shell，包括 Bourne shell（<a href="https://man.freebsd.org/cgi/man.cgi?query=sh&amp;sektion=1&amp;format=html">sh(1)</a>）和扩展的 C shell（<a href="https://man.freebsd.org/cgi/man.cgi?query=tcsh&amp;sektion=1&amp;format=html">tcsh(1)</a>）。FreeBSD Ports Collection 中还提供了其他 shell，如 <code>zsh</code> 和 <code>bash</code>。</p>
</div>
<div class="paragraph">
<p>使用的 shell 实际上是个人口味的问题。 C 程序员可能更喜欢类似 C 的 shell ，比如 <a href="https://man.freebsd.org/cgi/man.cgi?query=tcsh&amp;sektion=1&amp;format=html">tcsh(1)</a> 。 Linux® 用户可能更喜欢 <code>bash</code>。每个 shell 都有独特的特性，可能适用或不适用于用户首选的工作环境，这就是为什么可以选择使用哪个 shell 的原因。</p>
</div>
<div class="paragraph">
<p>一个常见的 shell 功能是文件名补全。当用户输入命令或文件名的前几个字母并按下 <kbd>Tab</kbd> 键时， shell 会自动完成命令或文件名的剩余部分。假设有两个文件名分别为 <code>foobar</code> 和 <code>football</code>。要删除 <code>foobar</code>，用户可以输入 <code>rm foo</code> 并按下 <kbd>Tab</kbd> 键来完成文件名的补全。</p>
</div>
<div class="paragraph">
<p>但是 Shell 只显示 <code>rm foo</code> 。由于 <code>foobar</code> 和 <code>football</code> 都以 <code>foo</code> 开头，它无法完成文件名。一些 Shell 会发出哔哔声或显示所有匹配的选项。用户必须输入更多字符来识别所需的文件名。输入一个 <code>t</code> 并再次按下 <kbd>Tab</kbd> 就足够让 Shell 确定所需的文件名并填充剩下的部分。</p>
</div>
<div class="paragraph">
<p>shell 的另一个特性是使用环境变量。环境变量是存储在 shell 环境中的键值对。任何由 shell 调用的程序都可以读取这个环境，并因此包含了许多程序配置。 <a href="#shell-env-vars">常见的环境变量</a> 提供了常见环境变量及其含义的列表。请注意，环境变量的名称始终为大写。</p>
</div>
<table id="shell-env-vars" class="tableblock frame-all grid-all stretch">
<caption class="title">表 6. 常见的环境变量</caption>
<colgroup>
<col style="width: 25%;"/>
<col/>
</colgroup>
<tbody>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">变量</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">描述</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock"><code>USER</code></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">当前登录用户的名称。</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock"><code>PATH</code></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">以冒号分隔的目录列表，用于搜索二进制文件。</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock"><code>DISPLAY</code></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">如果可用，连接到的 Xorg 显示器的网络名称。</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock"><code>SHELL</code></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">当前的 Shell 。</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock"><code>TERM</code></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">用户终端的类型名称。用于确定终端的功能。</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock"><code>TERMCAP</code></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">终端转义码的数据库条目，用于执行各种终端功能。</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock"><code>OSTYPE</code></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">操作系统的类型。</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock"><code>MACHTYPE</code></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">系统的 CPU 架构。</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock"><code>EDITOR</code></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">用户首选的文本编辑器。</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock"><code>PAGER</code></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">用户首选的逐页查看文本的实用工具。</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock"><code>MANPATH</code></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">以冒号分隔的目录列表，用于搜索手册页。</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>在不同的 shell 中设置环境变量的方法是不同的。在 <a href="https://man.freebsd.org/cgi/man.cgi?query=tcsh&amp;sektion=1&amp;format=html">tcsh(1)</a> 和 <a href="https://man.freebsd.org/cgi/man.cgi?query=csh&amp;sektion=1&amp;format=html">csh(1)</a> 中，使用 <code>setenv</code> 来设置环境变量。在 <a href="https://man.freebsd.org/cgi/man.cgi?query=sh&amp;sektion=1&amp;format=html">sh(1)</a> 和 <code>bash</code> 中，使用 <code>export</code> 来设置当前的环境变量。以下示例将默认的 <code>EDITOR</code> 设置为 <code>/usr/local/bin/emacs</code>，适用于 <a href="https://man.freebsd.org/cgi/man.cgi?query=tcsh&amp;sektion=1&amp;format=html">tcsh(1)</a> shell。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>setenv EDITOR /usr/local/bin/emacs</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>bash</code> 的等效命令是：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span><span class="nb">export </span><span class="nv">EDITOR</span><span class="o">=</span><span class="s2">&#34;/usr/local/bin/emacs&#34;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>为了展开环境变量以查看其当前设置，在命令行中在其名称前面键入 <code>$</code> 字符。例如，<code>echo $TERM</code> 会显示当前的 <code>$TERM</code> 设置。</p>
</div>
<div class="paragraph">
<p>Shell 将特殊字符，称为元字符，视为数据的特殊表示。最常见的元字符是 <code>*</code> ，它表示文件名中的任意数量的字符。元字符可以用于执行文件名通配符匹配。例如，<code>echo *</code> 等同于 <code>ls</code> ，因为 shell 会将与 <code>*</code> 匹配的所有文件取出，并在命令行上列出它们。</p>
</div>
<div class="paragraph">
<p>为了防止 shell 解释特殊字符，可以通过在特殊字符前加上反斜杠（<code>\</code>）来将其从 shell 中转义。例如， <code>echo $TERM</code> 会打印终端设置，而 <code>echo \$TERM</code> 会直接打印字符串 <code>$TERM</code>。</p>
</div>
<div class="sect3">
<h4 id="changing-shells">3.9.1. 更改 Shell<a class="anchor" href="#changing-shells"></a></h4>
<div class="paragraph">
<p>永久更改默认 shell 的最简单方法是使用 <code>chsh</code> 命令。运行此命令将打开在 <code>EDITOR</code> 环境变量中配置的编辑器，默认设置为 <a href="https://man.freebsd.org/cgi/man.cgi?query=vi&amp;sektion=1&amp;format=html">vi(1)</a>。将 <code>Shell:</code> 行更改为新 shell 的完整路径。</p>
</div>
<div class="paragraph">
<p>或者，使用 <code>chsh -s</code> 命令可以在不打开编辑器的情况下设置指定的 shell。例如，要将 shell 更改为 <code>bash</code>：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>chsh -s /usr/local/bin/bash</code></pre>
</div>
</div>
<div class="paragraph">
<p>在提示符处输入您的密码，然后按下 <kbd>Return</kbd> 键来更改您的 shell。注销并重新登录以开始使用新的 shell。</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>新的 shell 必须存在于 <code>/etc/shells</code> 中。如果 shell 是按照 <a href="./#ports">安装应用程序：软件包和 Ports</a> 中描述的方式从 FreeBSD Ports Collection 安装的，则应自动将其添加到此文件中。如果缺少，则使用以下命令添加，将路径替换为 shell 的路径：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># echo /usr/local/bin/bash &gt;&gt; /etc/shells</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>然后，重新运行 <a href="https://man.freebsd.org/cgi/man.cgi?query=chsh&amp;sektion=1&amp;format=html">chsh(1)</a>。</p>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect3">
<h4 id="_高级_shell_技巧">3.9.2. 高级 Shell 技巧<a class="anchor" href="#_高级_shell_技巧"></a></h4>
<div class="paragraph">
<p>UNIX® shell 不仅仅是一个命令解释器，它还是一个强大的工具，允许用户执行命令、重定向输出、重定向输入以及链式组合命令，以提高最终命令的输出。当这种功能与内置命令结合使用时，用户可以获得一个可以最大化效率的环境。</p>
</div>
<div class="paragraph">
<p>Shell 重定向是将命令的输出或输入发送到另一个命令或文件的操作。例如，要将 <a href="https://man.freebsd.org/cgi/man.cgi?query=ls&amp;sektion=1&amp;format=html">ls(1)</a> 命令的输出捕获到文件中，可以使用重定向操作：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>ls &gt; directory_listing.txt</code></pre>
</div>
</div>
<div class="paragraph">
<p>目录内容现在将会列在 <code>directory_listing.txt</code> 中。一些命令可以用来读取输入，比如 <a href="https://man.freebsd.org/cgi/man.cgi?query=sort&amp;sektion=1&amp;format=html">sort(1)</a> 。要对这个列表进行排序，可以重定向输入：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>sort &lt; directory_listing.txt</code></pre>
</div>
</div>
<div class="paragraph">
<p>输入将被排序并显示在屏幕上。要将该输入重定向到另一个文件，可以通过混合方向来重定向 <a href="https://man.freebsd.org/cgi/man.cgi?query=sort&amp;sektion=1&amp;format=html">sort(1)</a> 的输出。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>sort &lt; directory_listing.txt &gt; sorted.txt</code></pre>
</div>
</div>
<div class="paragraph">
<p>在所有之前的示例中，命令都是使用文件描述符进行重定向。每个 UNIX® 系统都有文件描述符，包括标准输入 (stdin)、标准输出 (stdout) 和标准错误 (stderr)。每个文件描述符都有其用途，其中输入可以是键盘或鼠标，提供输入的设备。输出可以是屏幕或打印机上的纸张。而错误则是用于诊断或错误消息的任何内容。这三个都被视为基于 I/O 的文件描述符，有时也被称为流。</p>
</div>
<div class="paragraph">
<p>通过使用这些描述符， Shell 允许输出和输入在各个命令之间传递，并可以重定向到文件或从文件中读取。另一种重定向的方法是管道操作符。</p>
</div>
<div class="paragraph">
<p>UNIX® 管道操作符“|”允许将一个命令的输出直接传递或定向到另一个程序。基本上，管道允许将一个命令的标准输出作为另一个命令的标准输入传递，例如：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>cat directory_listing.txt | sort | less</code></pre>
</div>
</div>
<div class="paragraph">
<p>在这个例子中，<code>directory_listing.txt</code> 的内容将被排序，并且输出将传递给 <a href="https://man.freebsd.org/cgi/man.cgi?query=less&amp;sektion=1&amp;format=html">less(1)</a> 。这使得用户可以按照自己的节奏滚动输出，并防止其滚动到屏幕外。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="editors">3.10. 文本编辑器<a class="anchor" href="#editors"></a></h3>
<div class="paragraph">
<p>大多数 FreeBSD 的配置是通过编辑文本文件来完成的，因此熟悉文本编辑器是一个好主意。FreeBSD 自带了一些基本系统的文本编辑器，还有更多的编辑器可以在 Ports Collection 中找到。</p>
</div>
<div class="paragraph">
<p>一个简单的学习编辑器是 <a href="https://man.freebsd.org/cgi/man.cgi?query=ee&amp;sektion=1&amp;format=html">ee(1)</a> ，它代表着 easy editor（简易编辑器）。要启动这个编辑器，输入 <code>ee <em>filename</em></code>，其中 <em>filename</em> 是要编辑的文件名。一旦进入编辑器，所有用于操作编辑器功能的命令都列在显示屏的顶部。插入符号（<code>^</code>）代表 <kbd>Ctrl</kbd>，所以 <code>^e</code> 扩展为 <span class="keyseq"><kbd>Ctrl</kbd>+<kbd>e</kbd></span>。要离开 <a href="https://man.freebsd.org/cgi/man.cgi?query=ee&amp;sektion=1&amp;format=html">ee(1)</a>，按下 <kbd>Esc</kbd>，然后从主菜单中选择“离开编辑器”选项。如果文件已被修改，编辑器将提示保存任何更改。</p>
</div>
<div class="paragraph">
<p>FreeBSD 还配备了更强大的文本编辑器，例如 <a href="https://man.freebsd.org/cgi/man.cgi?query=vi&amp;sektion=1&amp;format=html">vi(1)</a>，作为基本系统的一部分。其他编辑器，如 <a class="package" href="https://cgit.freebsd.org/ports/tree/editors/emacs/">editors/emacs</a> 和 <a class="package" href="https://cgit.freebsd.org/ports/tree/editors/vim/">editors/vim</a>，是 FreeBSD Ports Collection 的一部分。这些编辑器提供了更多的功能，但学习起来更加复杂。学习使用像 vim 或 Emacs 这样更强大的编辑器可以在长期来看节省更多的时间。</p>
</div>
<div class="paragraph">
<p>许多修改文件或需要输入文本的应用程序会自动打开一个文本编辑器。要更改默认的编辑器，请按照 <a href="#shells">Shells</a> 中描述的方式设置 <code>EDITOR</code> 环境变量。</p>
</div>
</div>
<div class="sect2">
<h3 id="basics-devices">3.11. 设备和设备节点<a class="anchor" href="#basics-devices"></a></h3>
<div class="paragraph">
<p>设备是系统中主要用于硬件相关活动的术语，包括磁盘、打印机、显卡和键盘等。当 FreeBSD 启动时，大部分引导消息都是关于检测到的设备。引导消息的副本保存在 <code>/var/run/dmesg.boot</code> 中。</p>
</div>
<div class="paragraph">
<p>每个设备都有一个设备名称和编号。例如， <code>ada0</code> 表示第一个 SATA 硬盘，而 <code>kbd0</code> 表示键盘。</p>
</div>
<div class="paragraph">
<p>在 FreeBSD 中，大多数设备必须通过称为设备节点的特殊文件进行访问，这些文件位于 <code>/dev</code> 目录中。</p>
</div>
</div>
<div class="sect2">
<h3 id="basics-more-information">3.12. 手册页<a class="anchor" href="#basics-more-information"></a></h3>
<div class="paragraph">
<p>FreeBSD 上最全面的文档是以手册页的形式存在的。系统上几乎每个程序都附带有一个简短的参考手册，解释其基本操作和可用参数。可以使用 <code>man</code> 命令查看这些手册。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>man <span class="nb">command</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>其中 <em>command</em> 是要了解的命令的名称。例如，要了解有关 <a href="https://man.freebsd.org/cgi/man.cgi?query=ls&amp;sektion=1&amp;format=html">ls(1)</a> 的更多信息，请输入：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>man ls</code></pre>
</div>
</div>
<div class="paragraph">
<p>手册页被分为不同的章节，代表不同的主题类型。在 FreeBSD 中，有以下几个章节可用：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>用户命令。</p>
</li>
<li>
<p>系统调用和错误编号。</p>
</li>
<li>
<p>C 库中的函数。</p>
</li>
<li>
<p>设备驱动程序。</p>
</li>
<li>
<p>文件格式。</p>
</li>
<li>
<p>游戏和其他娱乐活动。</p>
</li>
<li>
<p>杂项信息。</p>
</li>
<li>
<p>系统维护和操作命令。</p>
</li>
<li>
<p>系统内核接口。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>在某些情况下，同一个主题可能会出现在在线手册的多个部分中。例如，有一个 <code>chmod</code> 用户命令和一个 <code>chmod()</code> 系统调用。要告诉 <a href="https://man.freebsd.org/cgi/man.cgi?query=man&amp;sektion=1&amp;format=html">man(1)</a> 显示哪个部分，需要指定部分号码：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>man 1 chmod</code></pre>
</div>
</div>
<div class="paragraph">
<p>这将显示用户命令 <a href="https://man.freebsd.org/cgi/man.cgi?query=chmod&amp;sektion=1&amp;format=html">chmod(1)</a> 的手册页面。在书面文档中，对在线手册的特定部分的引用通常放在括号中，因此 <a href="https://man.freebsd.org/cgi/man.cgi?query=chmod&amp;sektion=1&amp;format=html">chmod(1)</a> 指的是用户命令，<a href="https://man.freebsd.org/cgi/man.cgi?query=chmod&amp;sektion=2&amp;format=html">chmod(2)</a> 指的是系统调用。</p>
</div>
<div class="paragraph">
<p>如果不知道手册页的名称，请使用 <code>man -k</code> 在手册页描述中搜索关键字：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>man -k mail</code></pre>
</div>
</div>
<div class="paragraph">
<p>该命令显示具有关键字“mail”在其描述中的命令列表。这相当于使用 <a href="https://man.freebsd.org/cgi/man.cgi?query=apropos&amp;sektion=1&amp;format=html">apropos(1)</a> 命令。</p>
</div>
<div class="paragraph">
<p>要阅读 <code>/usr/sbin</code> 目录下所有命令的描述，请输入：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span><span class="nb">cd</span> /usr/sbin
<span class="gp">% </span>man -f <span class="k">*</span> | more</code></pre>
</div>
</div>
<div class="paragraph">
<p>或者</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span><span class="nb">cd</span> /usr/sbin
<span class="gp">% </span>whatis <span class="k">*</span> |more</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="basics-info">3.12.1. GNU Info 文件<a class="anchor" href="#basics-info"></a></h4>
<div class="paragraph">
<p>FreeBSD 包含了由自由软件基金会（FSF）制作的多个应用程序和实用工具。除了手册页，这些程序还可能包括称为 <code>info</code> 文件的超文本文档。可以使用 <a href="https://man.freebsd.org/cgi/man.cgi?query=info&amp;sektion=1&amp;format=html">info(1)</a> 命令或者如果安装了 <a class="package" href="https://cgit.freebsd.org/ports/tree/editors/emacs/">editors/emacs</a> ，可以使用 emacs 的 info 模式来查看这些文件。</p>
</div>
<div class="paragraph">
<p>要使用 <a href="https://man.freebsd.org/cgi/man.cgi?query=info&amp;sektion=1&amp;format=html">info(1)</a>，请输入：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>info</code></pre>
</div>
</div>
<div class="paragraph">
<p>要进行简要介绍，请输入 <code>h</code>。要查看快速命令参考，请输入 <code>?</code>。</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ports">Chapter 4. 安装应用程序：软件包和 Ports<a class="anchor" href="#ports"></a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="ports-synopsis">4.1. 简介<a class="anchor" href="#ports-synopsis"></a></h3>
<div class="paragraph">
<p>FreeBSD 捆绑了丰富的系统工具作为基本系统的一部分。此外，FreeBSD 还提供了两种互补的技术来安装第三方软件：FreeBSD Ports Collection 用于从源代码安装，而软件包则用于从预编译的二进制文件安装。可以使用任一方法从本地媒体或网络安装软件。</p>
</div>
<div class="paragraph">
<p>阅读完本章后，您将了解：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>二进制包和 ports 之间的区别。</p>
</li>
<li>
<p>如何找到已经移植到 FreeBSD 的第三方软件。</p>
</li>
<li>
<p>如何使用 pkg 管理二进制软件包。</p>
</li>
<li>
<p>如何使用 Ports Collection 从源代码构建第三方软件。</p>
</li>
<li>
<p>如何找到应用程序安装后的文件，以进行后续配置。</p>
</li>
<li>
<p>如果软件安装失败，应该怎么办。</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="ports-overview">4.2. 软件安装概述<a class="anchor" href="#ports-overview"></a></h3>
<div class="paragraph">
<p>FreeBSD 的 <code>ports</code> 是一组文件，旨在自动化从源代码编译应用程序的过程。组成 ports 的文件包含了自动下载、提取、打补丁、编译和安装应用程序所需的所有必要信息。</p>
</div>
<div class="paragraph">
<p>如果软件尚未在 FreeBSD 上进行适配和测试，源代码可能需要进行编辑，以便正确安装和运行。</p>
</div>
<div class="paragraph">
<p>然而，在 <a href="https://www.FreeBSD.org/ports/">36000</a> 上已经有许多第三方应用程序被移植到了 FreeBSD。在可行的情况下，这些应用程序会以预编译的软件包形式提供下载。</p>
</div>
<div class="paragraph">
<p>可以使用 FreeBSD 软件包管理命令来操作软件包。</p>
</div>
<div class="paragraph">
<p>包和 ports 都能理解依赖关系。如果使用包或 ports 来安装一个应用程序，并且所依赖的库尚未安装，那么该库将会自动被先安装。</p>
</div>
<div class="paragraph">
<p>一个 FreeBSD 软件包包含了一个应用程序的预编译副本，以及任何配置文件和文档。可以使用 <a href="https://man.freebsd.org/cgi/man.cgi?query=pkg&amp;sektion=8&amp;format=html">pkg(8)</a> 命令来操作软件包，例如 <code>pkg install</code>。</p>
</div>
<div class="paragraph">
<p>虽然这两种技术相似，但软件包和 ports 各有各的优势。选择符合您安装特定应用程序需求的技术。</p>
</div>
<div class="ulist">
<div class="title">包的好处</div>
<ul>
<li>
<p>通常，压缩的软件包 tarball 比包含应用程序源代码的压缩 tarball 要小。</p>
</li>
<li>
<p>包不需要编译时间。对于大型应用程序，如 Firefox 、KDE Plasma 或 GNOME，在慢速系统上这一点可能很重要。</p>
</li>
<li>
<p>在 FreeBSD 上编译软件的过程中，包不需要任何理解。</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Port 的好处</div>
<ul>
<li>
<p>通常情况下，软件包会使用保守的选项进行编译，因为它们需要在尽可能多的系统上运行。通过从 ports 进行编译，可以更改编译选项。</p>
</li>
<li>
<p>一些应用程序具有与安装的功能相关的编译时选项。例如，NGINX® 可以配置多种不同的内置选项。</p>
<div class="paragraph">
<p>在某些情况下，为了指定特定的设置，同一个应用程序可能会存在多个软件包。例如，NGINX® 有一个 <code>nginx</code> 软件包和一个 <code>nginx-lite</code> 软件包，取决于是否安装了 Xorg。如果一个应用程序有超过一两个不同的编译选项，创建多个软件包将很快变得不可能。</p>
</div>
</li>
<li>
<p>一些软件的许可条件禁止二进制分发。这类软件必须以源代码的形式分发，并由最终用户进行编译。</p>
</li>
<li>
<p>有些人不信任二进制发行版，或者更喜欢阅读源代码以寻找潜在问题。</p>
</li>
<li>
<p>为了应用自定义补丁，需要提供源代码。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>要跟踪更新的 ports ，请订阅 {freebsd-ports} 和 {freebsd-ports-bugs} 。</p>
</div>
<div class="admonitionblock warning">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>在安装应用程序之前，请检查 <a href="https://vuxml.freebsd.org/" class="bare">https://vuxml.freebsd.org/</a> 是否存在相关的安全问题。</p>
</div>
<div class="paragraph">
<p>要对已安装的软件包进行已知漏洞的审计，请运行 <code>pkg audit -F</code>。</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>本章的其余部分将解释如何使用软件包和 ports 在 FreeBSD 上安装和管理第三方软件。</p>
</div>
</div>
<div class="sect2">
<h3 id="ports-finding-applications">4.3. 寻找软件<a class="anchor" href="#ports-finding-applications"></a></h3>
<div class="paragraph">
<p>FreeBSD 的可用应用程序列表不断增长。有多种方法可以找到要安装的软件：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>FreeBSD 网站维护着一个最新的可搜索的应用程序列表，位于 <a href="https://www.FreeBSD.org/ports/">Ports Portal</a>。可以通过应用程序名称或软件类别来搜索 ports。</p>
</li>
<li>
<p>Dan Langille 维护着 <a href="https://www.freshports.org/">FreshPorts</a>，该网站提供了一个全面的搜索工具，并跟踪 Ports Collection 中应用程序的变化。注册用户可以创建一个定制的监视列表，以便在所监视的 ports 更新时收到自动邮件通知。</p>
</li>
<li>
<p>如果找到一个特定的应用程序变得困难，可以尝试在 <a href="https://sourceforge.net/">SourceForge</a> 或者 <a href="https://github.com/">GitHub</a> 这样的网站上进行搜索，然后再回到 <a href="https://www.FreeBSD.org/ports/">Ports Portal</a> 查看该应用程序是否已经被移植。</p>
</li>
<li>
<p>使用 <a href="https://man.freebsd.org/cgi/man.cgi?query=pkg&amp;sektion=8&amp;format=html">pkg(8)</a> 命令在二进制软件包仓库中搜索一个应用程序</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="pkgng-intro">4.4. 使用 pkg 进行二进制包管理<a class="anchor" href="#pkgng-intro"></a></h3>
<div class="paragraph">
<p><a href="https://man.freebsd.org/cgi/man.cgi?query=pkg&amp;sektion=8&amp;format=html">pkg(8)</a> 提供了一个用于操作软件包的接口：注册、添加、删除和升级软件包。</p>
</div>
<div class="paragraph">
<p>对于只希望使用 FreeBSD 镜像站点提供的预编译二进制包的网站，使用 <a href="https://man.freebsd.org/cgi/man.cgi?query=pkg&amp;sektion=8&amp;format=html">pkg(8)</a> 来管理软件包可能已经足够了。</p>
</div>
<div class="paragraph">
<p>然而，对于那些从源代码构建网站的用户，将需要使用单独的 ports 管理工具。</p>
</div>
<div class="paragraph">
<p>由于 <a href="https://man.freebsd.org/cgi/man.cgi?query=pkg&amp;sektion=8&amp;format=html">pkg(8)</a> 只能用于二进制软件包，它并不能替代这些工具。这些工具可以用于安装来自二进制软件包和 Ports Collection 的软件，而 <a href="https://man.freebsd.org/cgi/man.cgi?query=pkg&amp;sektion=8&amp;format=html">pkg(8)</a> 只能安装二进制软件包。</p>
</div>
<div class="sect3">
<h4 id="pkgng-initial-setup">4.4.1. 开始使用 pkg<a class="anchor" href="#pkgng-initial-setup"></a></h4>
<div class="paragraph">
<p>所有支持的 FreeBSD 版本现在都包含 <code>/usr/sbin/pkg</code>，也被称为 <a href="https://man.freebsd.org/cgi/man.cgi?query=pkg&amp;sektion=7&amp;format=html">pkg(7)</a> 。这是一个小的占位符，只包含安装真正的 <a href="https://man.freebsd.org/cgi/man.cgi?query=pkg&amp;sektion=8&amp;format=html">pkg(8)</a> 所需的最小功能。</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>在引导过程中，需要一个互联网连接才能成功。</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>运行 <a href="https://man.freebsd.org/cgi/man.cgi?query=pkg&amp;sektion=8&amp;format=html">pkg(8)</a> 命令行：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>输出应该类似于以下内容：</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>The package management tool is not yet installed on your system.
Do you want to fetch and install it now? [y/N]</pre>
</div>
</div>
<div class="paragraph">
<p><a href="https://man.freebsd.org/cgi/man.cgi?query=pkg&amp;sektion=7&amp;format=html">pkg(7)</a> 将拦截该命令，如果您确认这是您的意图，将下载 <a href="https://man.freebsd.org/cgi/man.cgi?query=pkg&amp;sektion=8&amp;format=html">pkg(8)</a> tarball ，并从中安装 <a href="https://man.freebsd.org/cgi/man.cgi?query=pkg&amp;sektion=8&amp;format=html">pkg(8)</a>，引导本地软件包数据库，然后继续运行您最初请求的命令。</p>
</div>
<div class="paragraph">
<p>较新版本的 <a href="https://man.freebsd.org/cgi/man.cgi?query=pkg&amp;sektion=7&amp;format=html">pkg(7)</a> 可以理解 <code>pkg -N</code> 作为一种测试，用于检查是否安装了 <a href="https://man.freebsd.org/cgi/man.cgi?query=pkg&amp;sektion=8&amp;format=html">pkg(8)</a>，而不触发安装操作。相反，pkg bootstrap[-f] 用于安装 <a href="https://man.freebsd.org/cgi/man.cgi?query=pkg&amp;sektion=8&amp;format=html">pkg(8)</a>（或强制重新安装），而不执行任何其他操作。</p>
</div>
<div class="paragraph">
<p>可以通过查看 <a href="https://man.freebsd.org/cgi/man.cgi?query=pkg&amp;sektion=8&amp;format=html">pkg(8)</a> 手册页面或者在运行 <code>pkg</code> 命令时不添加额外参数来获取 pkg 的使用信息。有关其他 pkg 配置选项的描述，请参阅 <a href="https://man.freebsd.org/cgi/man.cgi?query=pkg.conf&amp;sektion=5&amp;format=html">pkg.conf(5)</a> 。</p>
</div>
<div class="paragraph">
<p>每个 pkg 命令参数都在特定命令的手册页中有详细说明。</p>
</div>
<div class="paragraph">
<p>例如，要阅读 <code>pkg install</code> 的手册页，请运行以下命令：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg help install</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>本节的其余部分演示了使用 <a href="https://man.freebsd.org/cgi/man.cgi?query=pkg&amp;sektion=8&amp;format=html">pkg(8)</a> 执行的常见二进制包管理任务。每个演示的命令都提供了许多开关来自定义其使用方式。有关详细信息和更多示例，请参阅命令的帮助或 man 页面。</p>
</div>
</div>
<div class="sect3">
<h4 id="quarterly-latest-branch">4.4.2. 季度和最新的 ports 分支<a class="anchor" href="#quarterly-latest-branch"></a></h4>
<div class="paragraph">
<p><code>Quarterly</code> 分支为用户提供了更可预测和稳定的 ports 和软件包安装和升级体验。这主要通过只允许非功能性更新来实现。季度分支旨在接收安全修复（可能是版本更新或提交的回溯）、错误修复和 ports 合规性或框架更改。季度分支在每年的一月、四月、七月和十月的季度初从 HEAD 中切出。分支的命名方式根据它们创建的年份（YYYY）和季度（Q1-4）。例如， 2023 年 1 月创建的季度分支被命名为 2023Q1。而 <code>Latest</code> 分支为用户提供了软件包的最新版本。</p>
</div>
<div class="paragraph">
<p>要将 <a href="https://man.freebsd.org/cgi/man.cgi?query=pkg&amp;sektion=8&amp;format=html">pkg(8)</a> 从季度版切换到最新版，请运行以下命令：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># mkdir -p /usr/local/etc/pkg/repos</span>
<span class="c"># echo &#39;FreeBSD: { url: &#34;pkg+http://pkg.FreeBSD.org/${ABI}/latest&#34; }&#39; &gt; /usr/local/etc/pkg/repos/FreeBSD.conf</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>然后运行以下命令来更新本地软件包仓库目录，以获取最新分支的内容：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg update -f</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="pkg-configuration">4.4.3. 配置 pkg<a class="anchor" href="#pkg-configuration"></a></h4>
<div class="paragraph">
<p><a href="https://man.freebsd.org/cgi/man.cgi?query=pkg.conf&amp;sektion=5&amp;format=html">pkg.conf(5)</a> 是 <a href="https://man.freebsd.org/cgi/man.cgi?query=pkg&amp;sektion=8&amp;format=html">pkg(8)</a> 工具使用的系统级配置文件。该文件的默认位置是 <code>/usr/local/etc/pkg.conf</code>。</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>FreeBSD 不需要有 <code>pkg.conf</code> 文件。许多安装可以在没有任何 <code>pkg.conf</code> 文件或只有空的 <code>pkg.conf</code> 文件（除了注释行）的情况下正常工作。</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>以&#34;#&#34;开头的行是注释，会被忽略。</p>
</div>
<div class="paragraph">
<p>该文件采用 UCL 格式。有关 <a href="https://man.freebsd.org/cgi/man.cgi?query=libucl&amp;sektion=3&amp;format=html">libucl(3)</a> 语法的更多信息，请访问 <a href="https://github.com/vstakhov/libucl">official UCL website</a> 。</p>
</div>
<div class="paragraph">
<p>识别以下类型的选项 - 布尔型、字符串型和列表型选项。</p>
</div>
<div class="paragraph">
<p>如果在配置文件中指定了以下值之一 - YES 、TRUE 和 ON，则将布尔选项标记为已启用。</p>
</div>
</div>
<div class="sect3">
<h4 id="pkg-search">4.4.4. 搜索软件包<a class="anchor" href="#pkg-search"></a></h4>
<div class="paragraph">
<p>要搜索一个软件包，可以使用 <a href="https://man.freebsd.org/cgi/man.cgi?query=pkg-search&amp;sektion=8&amp;format=html">pkg-search(8)</a> 命令：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg search nginx</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>输出应该类似于以下内容：</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>modsecurity3-nginx-1.0.3       Instruction detection and prevention engine / nginx Wrapper
nginx-1.22.1_2,3               Robust and small WWW server
nginx-devel-1.23.2_4           Robust and small WWW server
nginx-full-1.22.1_1,3          Robust and small WWW server (full package)
nginx-lite-1.22.1,3            Robust and small WWW server (lite package)
nginx-naxsi-1.22.1,3           Robust and small WWW server (plus NAXSI)
nginx-prometheus-exporter-0.10.0_7 Prometheus exporter for NGINX and NGINX Plus stats
nginx-ultimate-bad-bot-blocker-4.2020.03.2005_1 Nginx bad bot and other things blocker
nginx-vts-exporter-0.10.7_7    Server that scraps NGINX vts stats and export them via HTTP
p5-Nginx-ReadBody-0.07_1       Nginx embeded perl module to read and evaluate a request body
p5-Nginx-Simple-0.07_1         Perl 5 module for easy to use interface for Nginx Perl Module
p5-Test-Nginx-0.30             Testing modules for Nginx C module development
py39-certbot-nginx-2.0.0       NGINX plugin for Certbot
rubygem-passenger-nginx-6.0.15 Modules for running Ruby on Rails and Rack applications</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="pkg-installing-fetching">4.4.5. 安装和获取软件包<a class="anchor" href="#pkg-installing-fetching"></a></h4>
<div class="paragraph">
<p>要安装一个二进制软件包，可以使用 <a href="https://man.freebsd.org/cgi/man.cgi?query=pkg-install&amp;sektion=8&amp;format=html">pkg-install(8)</a> 命令。该命令使用存储库数据来确定要安装的软件的版本以及是否有未安装的依赖项。例如，要安装 curl ：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install curl</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>输出应该类似于以下内容：</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>Updating FreeBSD repository catalogue...
FreeBSD repository is up to date.
All repositories are up to date.
The following 9 package(s) will be affected (of 0 checked):

New packages to be INSTALLED:
        ca_root_nss: 3.83
        curl: 7.86.0
        gettext-runtime: 0.21
        indexinfo: 0.3.1
        libidn2: 2.3.3
        libnghttp2: 1.48.0
        libpsl: 0.21.1_4
        libssh2: 1.10.0.3
        libunistring: 1.0

Number of packages to be installed: 9

The process will require 11 MiB more space.
3 MiB to be downloaded

Proceed with this action? [y/N]</pre>
</div>
</div>
<div class="paragraph">
<p>新的软件包以及作为依赖项安装的任何其他软件包都可以在已安装软件包列表中看到：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg info</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>输出应该类似于以下内容：</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>ca_root_nss-3.83               Root certificate bundle from the Mozilla Project
curl-7.86.0                    Command line tool and library for transferring data with URLs
gettext-runtime-0.21.1         GNU gettext runtime libraries and programs
indexinfo-0.3.1                Utility to regenerate the GNU info page index
libidn2-2.3.3                  Implementation of IDNA2008 internationalized domain names
libnghttp2-1.48.0              HTTP/2.0 C Library
libpsl-0.21.1_6                C library to handle the Public Suffix List
libssh2-1.10.0.3               Library implementing the SSH2 protocol
libunistring-1.0               Unicode string library
pkg-1.18.4                     Package manager</pre>
</div>
</div>
<div class="paragraph">
<p>要获取一个软件包并稍后安装它或在另一个地方安装，请使用 <a href="https://man.freebsd.org/cgi/man.cgi?query=pkg-fetch&amp;sektion=8&amp;format=html">pkg-fetch(8)</a>。例如，要下载 <code>nginx-lite</code>：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg fetch -d -o /usr/home/user/packages/ nginx-lite</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>-d</code>：用于获取所有的依赖项</p>
</li>
<li>
<p><code>-o</code>：用于指定下载目录</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>输出应该类似于以下内容：</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>Updating FreeBSD repository catalogue...
FreeBSD repository is up to date.
All repositories are up to date.
The following packages will be fetched:

New packages to be FETCHED:
        nginx-lite: 1.22.1,3 (342 KiB: 22.20% of the 2 MiB to download)
        pcre: 8.45_3 (1 MiB: 77.80% of the 2 MiB to download)

Number of packages to be fetched: 2

The process will require 2 MiB more space.
2 MiB to be downloaded.

Proceed with fetching packages? [y/N]:</pre>
</div>
</div>
<div class="paragraph">
<p>要安装下载的软件包，可以使用 <a href="https://man.freebsd.org/cgi/man.cgi?query=pkg-install&amp;sektion=8&amp;format=html">pkg-install(8)</a> 命令，具体操作如下：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># cd /usr/home/user/packages/</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install nginx-lite-1.22.1,3.pkg</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="pkgng-pkg-info">4.4.6. 获取已安装软件包的信息<a class="anchor" href="#pkgng-pkg-info"></a></h4>
<div class="paragraph">
<p>可以通过运行 <a href="https://man.freebsd.org/cgi/man.cgi?query=pkg-info&amp;sektion=8&amp;format=html">pkg-info(8)</a> 来查看系统上安装的软件包的信息。当不带任何开关运行时，它将列出所有已安装软件包或指定软件包的版本信息。</p>
</div>
<div class="paragraph">
<p>例如，要查看已安装的 pkg 版本，请运行：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg info pkg</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>输出应该类似于以下内容：</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>pkg-1.19.0
Name           : pkg
Version        : 1.19.0
Installed on   : Sat Dec 17 11:05:28 2022 CET
Origin         : ports-mgmt/pkg
Architecture   : FreeBSD:13:amd64
Prefix         : /usr/local
Categories     : ports-mgmt
Licenses       : BSD2CLAUSE
Maintainer     : pkg@FreeBSD.org
WWW            : https://github.com/freebsd/pkg
Comment        : Package manager
Options        :
        DOCS           : on
Shared Libs provided:
        libpkg.so.4
Annotations    :
        FreeBSD_version: 1301000
        repo_type      : binary
        repository     : FreeBSD
Flat size      : 33.2MiB
Description    :
Package management tool

WWW: https://github.com/freebsd/pkg</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="pkgng-upgrading">4.4.7. 升级已安装的软件包<a class="anchor" href="#pkgng-upgrading"></a></h4>
<div class="paragraph">
<p>已安装的软件包可以使用 <a href="https://man.freebsd.org/cgi/man.cgi?query=pkg-upgrade&amp;sektion=8&amp;format=html">pkg-upgrade(8)</a> 命令升级到最新版本。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg upgrade</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>该命令将比较已安装的版本与存储库目录中可用的版本，并从存储库中升级它们。</p>
</div>
</div>
<div class="sect3">
<h4 id="pkgng-auditing">4.4.8. 审核已安装的软件包<a class="anchor" href="#pkgng-auditing"></a></h4>
<div class="paragraph">
<p>第三方应用程序经常会发现软件漏洞。为了解决这个问题，pkg 包含了一个内置的审计机制。要确定系统上安装的软件是否存在已知的漏洞，请使用 <a href="https://man.freebsd.org/cgi/man.cgi?query=pkg-audit&amp;sektion=8&amp;format=html">pkg-audit(8)</a> 命令。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg audit -F</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>输出应该类似于以下内容：</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>Fetching vuln.xml.xz: 100%  976 KiB 499.5kB/s    00:02
chromium-108.0.5359.98 is vulnerable:
  chromium -- multiple vulnerabilities
  CVE: CVE-2022-4440
  CVE: CVE-2022-4439
  CVE: CVE-2022-4438
  CVE: CVE-2022-4437
  CVE: CVE-2022-4436
  WWW: https://vuxml.FreeBSD.org/freebsd/83eb9374-7b97-11ed-be8f-3065ec8fd3ec.html</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="pkg-delete">4.4.9. 移除软件包<a class="anchor" href="#pkg-delete"></a></h4>
<div class="paragraph">
<p>不再需要的软件包可以使用 <a href="https://man.freebsd.org/cgi/man.cgi?query=pkg-delete&amp;sektion=8&amp;format=html">pkg-delete(8)</a> 命令进行删除。</p>
</div>
<div class="paragraph">
<p>例如：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg delete curl</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>输出应该类似于以下内容：</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>Checking integrity... done (0 conflicting)
Deinstallation has been requested for the following 1 packages (of 0 packages in the universe):

Installed packages to be REMOVED:
        curl :7.86.0

Number of packages to be removed: 1

The operation will free 4 MiB.

Proceed with deinstallation packages? [y/N]: y
[1/1] Deinstalling curl-7.86.0...
[1/1] Deleting files for curl-7.86.0: 100%</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="pkgng-autoremove">4.4.10. 自动删除未使用的软件包<a class="anchor" href="#pkgng-autoremove"></a></h4>
<div class="paragraph">
<p>删除一个软件包可能会留下不再需要的依赖项。可以使用 <a href="https://man.freebsd.org/cgi/man.cgi?query=pkg-autoremove&amp;sektion=8&amp;format=html">pkg-autoremove(8)</a> 自动检测和删除作为依赖项安装的不需要的软件包（叶子软件包）。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg autoremove</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>输出应该类似于以下内容：</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>Checking integrity... done (0 conflicting)
Deinstallation has been requested for the following 1 packages:

Installed packages to be REMOVED:
        ca_root_nss-3.83

Number of packages to be removed: 1

The operation will free 723 KiB.

Proceed with deinstalling packages? [y/N]:</pre>
</div>
</div>
<div class="paragraph">
<p>作为依赖安装的软件包被称为 <em>自动</em> 软件包。非自动软件包，即明确安装而不是作为其他软件包的依赖项安装的软件包，可以使用以下命令列出：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg prime-list</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>输出应该类似于以下内容：</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>nginx
openvpn
sudo</pre>
</div>
</div>
<div class="paragraph">
<p><code>pkg prime-list</code> 是在 <code>/usr/local/etc/pkg.conf</code> 中声明的一个别名命令。系统中还有许多其他命令可以用来查询软件包数据库。例如，命令 <code>pkg prime-origins</code> 可以用来获取上述列表的源 ports 目录。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg prime-origins</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>输出应该类似于以下内容：</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>www/nginx
security/openvpn
security/sudo</pre>
</div>
</div>
<div class="paragraph">
<p>这个列表可以用于使用构建工具（如 <a class="package" href="https://cgit.freebsd.org/ports/tree/ports-mgmt/poudriere/">ports-mgmt/poudriere</a> 或 <a class="package" href="https://cgit.freebsd.org/ports/tree/ports-mgmt/synth/">ports-mgmt/synth</a>）重新构建系统上安装的所有软件包。</p>
</div>
<div class="paragraph">
<p>将已安装的软件包标记为自动安装可以使用以下方法：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg set -A 1 devel/cmake</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>一旦一个包是一个叶子包并且被标记为自动安装，它将被 <code>pkg autoremove</code> 命令选择删除。</p>
</div>
<div class="paragraph">
<p>将已安装的软件包标记为 <em>非</em> 自动安装可以使用以下方法：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg set -A 0 devel/cmake</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="pkgng-clean">4.4.11. 移除过期的软件包<a class="anchor" href="#pkgng-clean"></a></h4>
<div class="paragraph">
<p>默认情况下，pkg 将二进制软件包存储在由 <a href="https://man.freebsd.org/cgi/man.cgi?query=pkg.conf&amp;sektion=5&amp;format=html">pkg.conf(5)</a> 中的 <code>PKG_CACHEDIR</code> 定义的缓存目录中。只保留最新安装的软件包的副本。旧版本的 pkg 会保留所有先前的软件包。要删除这些过时的二进制软件包，请运行：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg clean</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>可以通过运行以下命令来清除整个缓存：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg clean -a</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="pkg-locking-unlocking">4.4.12. 锁定和解锁软件包<a class="anchor" href="#pkg-locking-unlocking"></a></h4>
<div class="paragraph">
<p><a href="https://man.freebsd.org/cgi/man.cgi?query=pkg-lock&amp;sektion=8&amp;format=html">pkg-lock(8)</a> 用于锁定包，防止重新安装、修改或删除。<a href="https://man.freebsd.org/cgi/man.cgi?query=pkg-unlock&amp;sektion=8&amp;format=html">pkg-unlock(8)</a> 用于解锁指定的包。无论哪种变体，都只对当前已安装的包产生影响。因此，除非安装新包意味着更新已锁定的包，否则无法通过此机制阻止新包的安装。</p>
</div>
<div class="paragraph">
<p>例如，要锁定 <code>nginx-lite</code>：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg lock nginx-lite</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>要解锁 <code>nginx-lite</code>：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg unlock nginx-lite</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="pkgng-set">4.4.13. 修改软件包元数据<a class="anchor" href="#pkgng-set"></a></h4>
<div class="paragraph">
<p>FreeBSD Ports Collection 中的软件可能会经历主版本号的更改。为了解决这个问题，pkg 有一个内置命令来更新软件包的来源。这在某些情况下非常有用，例如，如果 <a class="package" href="https://cgit.freebsd.org/ports/tree/lang/python3/">lang/python3</a> 被重命名为 <a class="package" href="https://cgit.freebsd.org/ports/tree/lang/python311/">lang/python311</a> ，那么 <a class="package" href="https://cgit.freebsd.org/ports/tree/lang/python3/">lang/python3</a> 现在可以表示版本 <code>3.11</code>。</p>
</div>
<div class="paragraph">
<p>要更改上面示例的软件包来源，请运行以下命令：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg set -o lang/python3:lang/python311</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>另一个例子是，要将 <a class="package" href="https://cgit.freebsd.org/ports/tree/lang/ruby31/">lang/ruby31</a> 更新为 <a class="package" href="https://cgit.freebsd.org/ports/tree/lang/ruby32/">lang/ruby32</a>，运行以下命令：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg set -o lang/ruby31:lang/ruby32</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>在更改软件包来源时，重要的是重新安装依赖于已修改来源的软件包。要强制重新安装依赖软件包，请运行：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install -Rf lang/ruby32</span></code></pre>
</div>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="ports-using">4.5. 使用 Ports 集合<a class="anchor" href="#ports-using"></a></h3>
<div class="paragraph">
<p>Ports Collection 是一组 <code>Makefiles</code>、补丁和描述文件。每组这些文件用于在 FreeBSD 上编译和安装单个应用程序，被称为一个 <em>ports</em>。</p>
</div>
<div class="paragraph">
<p>默认情况下，Ports Collection 本身存储在 <code>/usr/ports</code> 的子目录中。</p>
</div>
<div class="admonitionblock warning">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>在安装和使用 Ports Collection 之前，请注意通常不建议使用 Ports Collection 与通过 pkg 提供的二进制软件包一起安装软件。 pkg 默认跟踪 ports 树的季度分支发布，而不是 HEAD 。与季度分支发布中的对应 ports 相比， HEAD 中的 ports 的依赖关系可能不同，这可能导致 pkg 安装的依赖关系与 Ports Collection 中的依赖关系发生冲突。如果必须同时使用 Ports Collection 和 pkg ，请确保您的 Ports Collection 和 pkg 位于相同的 ports 树分支发布上。</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Ports 集合包含了软件类别的目录。每个类别中都有针对个别应用程序的子目录。每个应用程序子目录包含一组文件，告诉 FreeBSD 如何编译和安装该程序，称为 <em>ports skeleton</em>。每个 ports 骨架包括以下文件和目录：</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Makefile</strong>：包含指定应用程序如何编译以及其组件应安装在何处的语句。</p>
</li>
<li>
<p><strong>distinfo</strong>：包含构建 ports 所需下载的文件的名称和校验和。</p>
</li>
<li>
<p><strong>files/</strong>：这个目录包含了在 FreeBSD 上编译和安装程序所需的补丁文件。这个目录也可能包含其他用于构建 ports 的文件。</p>
</li>
<li>
<p><strong>pkg-descr</strong>：提供程序的更详细描述。</p>
</li>
<li>
<p><strong>pkg-plist</strong>：一个包含所有将由 ports 安装的文件的列表。它还告诉 ports 系统在卸载时要删除哪些文件。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>一些 ports 包括 <code>pkg-message</code> 或其他文件来处理特殊情况。有关这些文件以及 ports 的更多详细信息，请参考 <a href="{porters-handbook}">FreeBSD Porter’s Handbook</a>。</p>
</div>
<div class="literalblock">
<div class="content">
<pre>ports 不包含实际的源代码，也称为 `distfile` 。构建 ports 的提取部分将自动将下载的源代码保存到 `/usr/ports/distfiles`。</pre>
</div>
</div>
<div class="sect3">
<h4 id="ports-using-installation-methods">4.5.1. 安装 Ports 集合<a class="anchor" href="#ports-using-installation-methods"></a></h4>
<div class="paragraph">
<p>在使用 ports 编译应用程序之前，必须先安装 ports 集合。如果在安装 FreeBSD 时没有安装它，请使用以下方法之一进行安装：</p>
</div>
<div id="ports-using-git-method" class="sidebarblock procedure">
<div class="content">
<div class="paragraph">
<p><strong>过程：Git 方法</strong></p>
</div>
<div class="paragraph">
<p>如果需要对 ports 树进行更多的控制，或者需要维护本地更改，或者正在运行 FreeBSD-CURRENT，可以使用 Git 来获取 Ports Collection。有关 Git 的详细描述，请参阅 <a href="{committers-guide}#git-primer">Git Primer</a>。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>在使用 Git 检出 ports 树之前，必须先安装 Git 。如果已经存在一个 ports 树的副本，请按照以下方式安装 Git ：</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># cd /usr/ports/devel/git</span>
<span class="c"># make install clean</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>如果 ports 树不可用，或者正在使用 pkg 来管理软件包，可以将 Git 作为一个软件包安装：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install git</span></code></pre>
</div>
</div>
</li>
<li>
<p>检出 ports 树的 HEAD 分支的副本：</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># git clone https://git.FreeBSD.org/ports.git /usr/ports</span></code></pre>
</div>
</div>
</li>
<li>
<p>或者，检出一个季度分支的副本：</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># git clone https://git.FreeBSD.org/ports.git -b 2023Q1 /usr/ports</span></code></pre>
</div>
</div>
</li>
<li>
<p>在初始的 Git 检出之后，根据需要更新 <code>/usr/ports</code>。</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># git -C /usr/ports pull</span></code></pre>
</div>
</div>
</li>
<li>
<p>根据需要，将 <code>/usr/ports</code> 切换到不同的季度分支：</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># git -C /usr/ports switch 2023Q1</span></code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_安装_ports">4.5.2. 安装 Ports<a class="anchor" href="#_安装_ports"></a></h4>
<div class="paragraph">
<p>本节提供了使用 Ports Collection 安装或删除软件的基本说明。有关可用的 <code>make</code> 目标和环境变量的详细描述，请参阅 <a href="https://man.freebsd.org/cgi/man.cgi?query=ports&amp;sektion=7&amp;format=html">ports(7)</a>。</p>
</div>
<div class="admonitionblock warning">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>在编译任何 ports 之前，请确保按照前一节中的描述更新 Ports Collection。由于安装任何第三方软件都可能引入安全漏洞，建议首先在 <a href="https://vuxml.freebsd.org/" class="bare">https://vuxml.freebsd.org/</a> 上检查与该 ports 相关的已知安全问题。或者，在安装新 ports 之前运行 <code>pkg audit -F</code>。此命令可以配置为在每日安全系统检查期间自动执行安全审计和漏洞数据库的更新。有关更多信息，请参阅 <a href="https://man.freebsd.org/cgi/man.cgi?query=pkg-audit&amp;sektion=8&amp;format=html">pkg-audit(8)</a> 和 <a href="https://man.freebsd.org/cgi/man.cgi?query=periodic&amp;sektion=8&amp;format=html">periodic(8)</a>。</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>使用 Ports 集合需要一个正常的互联网连接。它还需要超级用户权限。</p>
</div>
<div class="paragraph">
<p>要编译和安装 ports，请切换到要安装的 ports 的目录，然后在提示符下键入 <code>make install</code>。消息将指示进度：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># cd /usr/ports/sysutils/lsof</span>
<span class="c"># make install</span>
<span class="gp">&gt;&gt; </span>lsof_4.88D.freebsd.tar.gz doesn<span class="s1">&#39;t seem to exist in /usr/ports/distfiles/.
&gt;&gt; Attempting to fetch from ftp://lsof.itap.purdue.edu/pub/tools/unix/lsof/.
===&gt;  Extracting for lsof-4.88
...
[extraction output snipped]
...
&gt;&gt; Checksum OK for lsof_4.88D.freebsd.tar.gz.
===&gt;  Patching for lsof-4.88.d,8
===&gt;  Applying FreeBSD patches for lsof-4.88.d,8
===&gt;  Configuring for lsof-4.88.d,8
...
[configure output snipped]
...
===&gt;  Building for lsof-4.88.d,8
...
[compilation output snipped]
...

===&gt;  Installing for lsof-4.88.d,8
...
[installation output snipped]
...
===&gt;   Generating temporary packing list
===&gt;   Compressing manual pages for lsof-4.88.d,8
===&gt;   Registering installation for lsof-4.88.d,8
===&gt;  SECURITY NOTE:
      This port has installed the following binaries which execute with
      increased privileges.
/usr/local/sbin/lsof
#</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>由于 <code>lsof</code> 是一个以增加权限运行的程序，因此在安装时会显示一个安全警告。安装完成后，提示符将会返回。</p>
</div>
<div class="paragraph">
<p>一些 shell 会在 <code>PATH</code> 环境变量所列目录中保留一个命令缓存，以加快对这些命令可执行文件的查找操作。使用 <code>tcsh</code> shell 的用户应该输入 <code>rehash</code> 命令，以便可以在不指定完整路径的情况下使用新安装的命令。对于 <code>sh</code> shell，请使用 <code>hash -r</code> 命令。有关更多信息，请参阅 shell 的文档。</p>
</div>
<div class="paragraph">
<p>在安装过程中，会创建一个工作子目录，其中包含编译过程中使用的所有临时文件。删除此目录可以节省磁盘空间，并在以后升级到新版本的 ports 时最大程度地减少问题的可能性。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># make clean</span>
<span class="gp">===&gt;  </span>Cleaning <span class="k">for </span>lsof-88.d,8
<span class="c">#</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>为了避免这个额外的步骤，编译 ports 时可以使用 <code>make install clean</code>。</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="sect4">
<h5 id="_自定义_ports_安装">4.5.2.1. 自定义 ports 安装<a class="anchor" href="#_自定义_ports_安装"></a></h5>
<div class="paragraph">
<p>一些 ports 提供构建选项，可以用于启用或禁用应用程序组件，提供安全选项或允许其他自定义。示例包括 <a class="package" href="https://cgit.freebsd.org/ports/tree/www/firefox/">www/firefox</a> 和 <a class="package" href="https://cgit.freebsd.org/ports/tree/security/gpgme/">security/gpgme</a>。如果该 ports 依赖于具有可配置选项的其他 ports，则默认行为是提示用户从菜单中选择选项，因此可能会多次暂停以进行用户交互。为了避免这种情况，并在一个批处理中进行所有配置，请在 ports 骨架中运行 <code>make config-recursive</code>。然后，运行 <code>make install [clean]</code> 来编译和安装该 ports。</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>当使用 <code>config-recursive</code> 时，要配置的 ports 列表是通过 <code>all-depends-list</code> 目标收集的。建议运行 <code>make config-recursive</code> 直到所有依赖 ports 选项都被定义，并且 ports 选项屏幕不再出现，以确保所有依赖选项都已配置。</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>在构建 ports 后，有几种方法可以重新访问 ports 的构建选项菜单，以添加、删除或更改这些选项。一种方法是进入包含 ports 的目录，然后输入 <code>make config</code> 命令。另一种选择是使用 <code>make showconfig</code> 命令。还可以执行 <code>make rmconfig</code> 命令，该命令将删除所有已选择的选项，并允许您重新开始。所有这些选项以及其他选项都在 <a href="https://man.freebsd.org/cgi/man.cgi?query=ports&amp;sektion=7&amp;format=html">ports(7)</a> 中详细解释。</p>
</div>
<div class="paragraph">
<p>ports 系统使用 <a href="https://man.freebsd.org/cgi/man.cgi?query=fetch&amp;sektion=1&amp;format=html">fetch(1)</a> 来下载源文件，该工具支持各种环境变量。如果 FreeBSD 系统位于防火墙或 FTP/HTTP 代理后面，可能需要设置 <code>FTP_PASSIVE_MODE</code>、<code>FTP_PROXY</code> 和 <code>FTP_PASSWORD</code> 变量。有关支持的变量的完整列表，请参阅 <a href="https://man.freebsd.org/cgi/man.cgi?query=fetch&amp;sektion=3&amp;format=html">fetch(3)</a>。</p>
</div>
<div class="paragraph">
<p>对于不能始终连接到互联网的用户，可以在 <code>/usr/ports</code> 目录下运行 <code>make fetch</code> 命令，以获取所有的 distfiles，或者在某个分类目录（例如 <code>/usr/ports/net</code>）或特定的 ports 骨架中运行。请注意，如果一个 ports 有任何依赖项，那么在分类目录或 ports 骨架中运行此命令将不会获取来自其他分类的 ports 的 distfiles。相反，使用 <code>make fetch-recursive</code> 命令也可以获取 ports 的所有依赖项的 distfiles。</p>
</div>
<div class="paragraph">
<p>在极少数情况下，例如当组织拥有本地的 distfiles 仓库时，<code>MASTER_SITES</code> 变量可以用于覆盖 <code>Makefile</code> 中指定的下载位置。在使用时，请指定替代位置：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># cd /usr/ports/directory</span>
<span class="c"># make MASTER_SITE_OVERRIDE= \</span>
ftp://ftp.organization.org/pub/FreeBSD/ports/distfiles/ fetch</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>WRKDIRPREFIX</code> 和 <code>PREFIX</code> 变量可以覆盖默认的工作目录和目标目录。例如：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># make WRKDIRPREFIX=/usr/home/example/ports install</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>将 ports 编译在 <code>/usr/home/example/ports</code> 目录下，并将所有内容安装在 <code>/usr/local</code> 目录下。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># make PREFIX=/usr/home/example/local install</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>将 ports 编译在 <code>/usr/ports</code> 中，并将其安装在 <code>/usr/home/example/local</code> 中。并且：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># make WRKDIRPREFIX=../ports PREFIX=../local install</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>将两者合并。</p>
</div>
<div class="paragraph">
<p>这些也可以设置为环境变量。请参考您所使用的 shell 的手册页面，了解如何设置环境变量的指令。</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="ports-removing">4.5.3. 移除已安装的 ports<a class="anchor" href="#ports-removing"></a></h4>
<div class="paragraph">
<p>使用 <code>pkg delete</code> 命令可以卸载已安装的 ports。有关使用此命令的示例，请参阅 <a href="https://man.freebsd.org/cgi/man.cgi?query=pkg-delete&amp;sektion=8&amp;format=html">pkg-delete(8)</a> 手册页。</p>
</div>
<div class="paragraph">
<p>或者，可以在 ports 的目录中运行 <code>make deinstall</code> 命令：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># cd /usr/ports/sysutils/lsof</span>
<span class="c"># make deinstall</span>
<span class="gp">===&gt;  </span>Deinstalling <span class="k">for </span>sysutils/lsof
<span class="gp">===&gt;   </span>Deinstalling
Deinstallation has been requested <span class="k">for </span>the following 1 packages:

	lsof-4.88.d,8

The deinstallation will free 229 kB
<span class="o">[</span>1/1] Deleting lsof-4.88.d,8... <span class="k">done</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>建议在卸载 ports 之前阅读消息。如果该 ports 有任何依赖于它的应用程序，这些信息将被显示，但卸载将继续进行。在这种情况下，重新安装应用程序可能更好，以防止依赖关系破裂。</p>
</div>
</div>
<div class="sect3">
<h4 id="ports-upgrading">4.5.4. 升级 ports<a class="anchor" href="#ports-upgrading"></a></h4>
<div class="paragraph">
<p>随着时间的推移，Ports Collection 中会有更新版本的软件可用。本节介绍了如何确定可以升级的软件以及如何执行升级操作。</p>
</div>
<div class="paragraph">
<p>要确定已安装的 ports 是否有更新版本可用，请确保安装了最新版本的 ports 树，使用在 <a href="#ports-using-git-method">&#34;Git Method&#34;</a> 中描述的更新命令。以下命令将列出已过时的已安装 ports：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg version -l &#34;&lt;&#34;</span></code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>在尝试升级之前，请从文件顶部开始阅读 <code>/usr/ports/UPDATING</code>，直到最接近上次升级 ports 或安装系统的日期。该文件描述了在更新 ports 时用户可能遇到的各种问题和需要执行的额外步骤，包括文件格式更改、配置文件位置更改或与先前版本不兼容的任何问题。请注意任何与需要升级的 ports 匹配的说明，并在执行升级时遵循这些说明。</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="sect4">
<h5 id="ports-upgrading-tools">4.5.4.1. 升级和管理 ports 的工具<a class="anchor" href="#ports-upgrading-tools"></a></h5>
<div class="paragraph">
<p>Ports Collection 包含多个实际执行升级的实用工具。每个工具都有其优点和缺点。</p>
</div>
<div class="paragraph">
<p>从历史上看，大多数安装使用的是 Portmaster 或 Portupgrade 。Synth 是一种较新的替代方案。</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>选择哪种工具最适合特定系统是由系统管理员决定的。在使用这些工具之前，建议先备份数据。</p>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect4">
<h5 id="portmaster">4.5.4.2. 使用 Portmaster 升级 Ports<a class="anchor" href="#portmaster"></a></h5>
<div class="paragraph">
<p><a class="package" href="https://cgit.freebsd.org/ports/tree/ports-mgmt/portmaster/">ports-mgmt/portmaster</a> 是一个非常小的工具，用于升级已安装的 ports。它旨在使用安装在 FreeBSD 基本系统中的工具，而不依赖其他 ports 或数据库。要将此实用程序安装为一个 ports：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># cd /usr/ports/ports-mgmt/portmaster</span>
<span class="c"># make install clean</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Portmaster 定义了四个 ports 的分类：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Root ports：没有依赖项，也不是任何其他 ports 的依赖项。</p>
</li>
<li>
<p>Trunk ports：没有依赖项，但其他 ports 依赖于它。</p>
</li>
<li>
<p>Branch ports：具有依赖关系，其他 ports 依赖于它。</p>
</li>
<li>
<p>Leaf ports：具有依赖关系，但没有其他 ports 依赖于它。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>要列出这些类别并搜索更新：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># portmaster -L</span>
<span class="gp">===&gt;&gt;&gt; </span>Root ports <span class="o">(</span>No dependencies, not depended on<span class="o">)</span>
<span class="gp">===&gt;&gt;&gt; </span>ispell-3.2.06_18
<span class="gp">===&gt;&gt;&gt; </span>screen-4.0.3
        <span class="o">===</span>&gt;&gt;&gt; New version available: screen-4.0.3_1
<span class="gp">===&gt;&gt;&gt; </span>tcpflow-0.21_1
<span class="gp">===&gt;&gt;&gt; </span>7 root ports
...
<span class="gp">===&gt;&gt;&gt; </span>Branch ports <span class="o">(</span>Have dependencies, are depended on<span class="o">)</span>
<span class="gp">===&gt;&gt;&gt; </span>apache22-2.2.3
        <span class="o">===</span>&gt;&gt;&gt; New version available: apache22-2.2.8
...
<span class="gp">===&gt;&gt;&gt; </span>Leaf ports <span class="o">(</span>Have dependencies, not depended on<span class="o">)</span>
<span class="gp">===&gt;&gt;&gt; </span>automake-1.9.6_2
<span class="gp">===&gt;&gt;&gt; </span>bash-3.1.17
        <span class="o">===</span>&gt;&gt;&gt; New version available: bash-3.2.33
...
<span class="gp">===&gt;&gt;&gt; </span>32 leaf ports

<span class="gp">===&gt;&gt;&gt; </span>137 total installed ports
        <span class="o">===</span>&gt;&gt;&gt; 83 have new versions available</code></pre>
</div>
</div>
<div class="paragraph">
<p>这个命令用于升级所有过时的 ports：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># portmaster -a</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>默认情况下，Portmaster 在删除现有 ports 之前会创建一个备份包。如果新版本的安装成功，Portmaster 会删除备份。使用 <code>-b</code> 指令可以让 Portmaster 不自动删除备份。添加 <code>-i</code> 可以启动 Portmaster 的交互模式，在升级每个 ports 之前提示确认。还有许多其他选项可用。请阅读 <a href="https://man.freebsd.org/cgi/man.cgi?query=portmaster&amp;sektion=8&amp;format=html">portmaster(8)</a> 的手册页面，了解有关它们使用的详细信息。</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>如果在升级过程中遇到错误，请在升级和重建所有 ports 时添加 <code>-f</code>。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># portmaster -af</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Portmaster 还可以用于在系统上安装新的 ports，在构建和安装新的 ports 之前升级所有依赖项。要使用此功能，请指定 Ports Collection 中 ports 的位置：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># portmaster shells/bash</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>有关 <a class="package" href="https://cgit.freebsd.org/ports/tree/ports-mgmt/portmaster/">ports-mgmt/portmaster</a> 的更多信息可以在其 <code>pkg-descr</code> 中找到。</p>
</div>
</div>
<div class="sect4">
<h5 id="portupgrade">4.5.4.3. 使用 Portupgrade 升级 ports<a class="anchor" href="#portupgrade"></a></h5>
<div class="paragraph">
<p><a class="package" href="https://cgit.freebsd.org/ports/tree/ports-mgmt/portupgrade/">ports-mgmt/portupgrade</a> 是另一个可以用来升级 ports 的实用工具。它安装了一套可以用来管理 ports 的应用程序。然而，它依赖于 Ruby。要安装该 ports：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># cd /usr/ports/ports-mgmt/portupgrade</span>
<span class="c"># make install clean</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>在使用此工具进行升级之前，建议使用 <code>pkgdb -F</code> 扫描已安装的 ports 列表，并修复它报告的所有不一致性。</p>
</div>
<div class="paragraph">
<p>要升级系统上安装的所有过时 ports，请使用 <code>portupgrade -a</code>。或者，加入 <code>-i</code> 以便在每次单独升级时要求确认：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># portupgrade -ai</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>要升级指定的应用程序而不是所有可用的 ports，请使用 <code>portupgrade <em>pkgname</em></code>。非常重要的是要包括 <code>-R</code> 选项，以先升级给定应用程序所需的所有 ports：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># portupgrade -R firefox</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>如果包含了 <code>-P</code> 选项，Portupgrade 会在 <code>PKG_PATH</code> 列出的本地目录中搜索可用的软件包。如果本地没有可用的软件包，它会从远程站点获取软件包。如果无法在本地或远程获取软件包，Portupgrade 将使用 ports。为了完全避免使用 ports，可以指定 <code>-PP</code> 选项。最后一组选项告诉 Portupgrade 如果没有可用的软件包则中止操作。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># portupgrade -PP gnome3</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>如果指定了 <code>-P</code>，只需获取 ports distfiles 或软件包，而不需要构建或安装任何内容，请使用 <code>-F 。有关所有可用开关的更多信息，请参阅 `portupgrade</code> 的手册页。</p>
</div>
<div class="paragraph">
<p>有关 <a class="package" href="https://cgit.freebsd.org/ports/tree/ports-mgmt/portupgrade/">ports-mgmt/portupgrade</a> 的更多信息可以在其 <code>pkg-descr</code> 中找到。</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="ports-disk-space">4.5.5. ports 和磁盘空间<a class="anchor" href="#ports-disk-space"></a></h4>
<div class="paragraph">
<p>使用 Ports Collection 会随着时间的推移占用磁盘空间。在构建和安装 ports 之后，在 ports 骨架中运行 <code>make clean</code> 将清理临时的 <code>work</code> 目录。如果使用 Portmaster 安装 ports，它会自动删除此目录，除非指定了 <code>-K</code> 选项。如果安装了 Portupgrade，此命令将删除在本地 Ports Collection 副本中找到的所有 <code>work</code> 目录：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># portsclean -C</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>此外，随着时间的推移，过时的源代码分发文件会在 <code>/usr/ports/distfiles</code> 中累积。要使用 Portupgrade 删除所有不再被任何 ports 引用的分发文件：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># portsclean -D</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Portupgrade 可以删除系统上当前未安装任何 ports 引用的所有 distfiles 文件。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># portsclean -DD</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>如果已安装 Portmaster，请使用：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># portmaster --clean-distfiles</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>默认情况下，该命令是交互式的，并提示用户确认是否删除 distfile。</p>
</div>
<div class="paragraph">
<p>除了这些命令之外，<a class="package" href="https://cgit.freebsd.org/ports/tree/ports-mgmt/pkg_cutleaves/">ports-mgmt/pkg_cutleaves</a> 还可以自动化删除不再需要的已安装 ports 的任务。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="ports-poudriere">4.6. 使用 poudriere 构建软件包<a class="anchor" href="#ports-poudriere"></a></h3>
<div class="paragraph">
<p>poudriere 是一个使用 BSD 许可证的实用工具，用于创建和测试 FreeBSD 软件包。它使用 FreeBSD jails 来设置隔离的编译环境。这些 jails 可以用于为与安装它的系统不同的 FreeBSD 版本构建软件包，也可以用于在主机是 amd64 系统的情况下构建 i386 的软件包。一旦软件包构建完成，它们的布局与官方镜像完全相同。这些软件包可以被 <a href="https://man.freebsd.org/cgi/man.cgi?query=pkg&amp;sektion=8&amp;format=html">pkg(8)</a> 和其他软件包管理工具使用。</p>
</div>
<div class="paragraph">
<p>poudriere 是使用 <a class="package" href="https://cgit.freebsd.org/ports/tree/ports-mgmt/poudriere/">ports-mgmt/poudriere</a> 包或 ports 进行安装的。安装过程中包含一个示例配置文件 <code>/usr/local/etc/poudriere.conf.sample</code>。将此文件复制到 <code>/usr/local/etc/poudriere.conf</code>。编辑复制的文件以适应本地配置。</p>
</div>
<div class="paragraph">
<p>虽然在运行 poudriere 的系统上不需要 <code>ZFS</code>，但它是有益的。当使用 <code>ZFS</code> 时，必须在 <code>/usr/local/etc/poudriere.conf</code> 中指定 <code>ZPOOL</code>，并将 <code>FREEBSD_HOST</code> 设置为附近的镜像。定义 <code>CCACHE_DIR</code> 可以启用 <code><a class="package" href="https://cgit.freebsd.org/ports/tree/devel/ccache/">devel/ccache</a></code> 来缓存编译并减少频繁编译代码的构建时间。将 poudriere 数据集放在挂载在 <code>/poudriere</code> 的隔离树中可能很方便。其他配置值的默认设置是足够的。</p>
</div>
<div class="paragraph">
<p>检测到的处理器核心数量用于定义并行运行的构建数量。请提供足够的虚拟内存，可以是 RAM 或者交换空间。如果虚拟内存耗尽，编译环境将停止并被销毁，导致出现奇怪的错误信息。</p>
</div>
<div class="sect3">
<h4 id="poudriere-initialization">4.6.1. 初始化 Jails 和 Port Trees<a class="anchor" href="#poudriere-initialization"></a></h4>
<div class="paragraph">
<p>配置完成后，初始化 poudriere，以便安装一个包含所需 FreeBSD 树和 ports 树的 jail。使用 <code>-j</code> 指定 jail 的名称，并使用 <code>-v</code> 指定 FreeBSD 版本。在运行 FreeBSD/amd64 的系统上，可以使用 <code>-a</code> 将架构设置为 <code>i386</code> 或 <code>amd64</code>。默认架构为 <code>uname</code> 显示的架构。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># poudriere jail -c -j 13amd64 -v 13.1-RELEASE</span>
<span class="o">[</span>00:00:00] Creating 13amd64 fs at /poudriere/jails/13amd64... <span class="k">done</span>
<span class="o">[</span>00:00:00] Using pre-distributed MANIFEST <span class="k">for </span>FreeBSD 13.1-RELEASE amd64
<span class="o">[</span>00:00:00] Fetching base <span class="k">for </span>FreeBSD 13.1-RELEASE amd64
/poudriere/jails/13amd64/fromftp/base.txz              125 MB 4110 kBps    31s
<span class="o">[</span>00:00:33] Extracting base... <span class="k">done</span>
<span class="o">[</span>00:00:54] Fetching src <span class="k">for </span>FreeBSD 13.1-RELEASE amd64
/poudriere/jails/13amd64/fromftp/src.txz               154 MB 4178 kBps    38s
<span class="o">[</span>00:01:33] Extracting src... <span class="k">done</span>
<span class="o">[</span>00:02:31] Fetching lib32 <span class="k">for </span>FreeBSD 13.1-RELEASE amd64
/poudriere/jails/13amd64/fromftp/lib32.txz              24 MB 3969 kBps    06s
<span class="o">[</span>00:02:38] Extracting lib32... <span class="k">done</span>
<span class="o">[</span>00:02:42] Cleaning up... <span class="k">done</span>
<span class="o">[</span>00:02:42] Recording filesystem state <span class="k">for </span>clean... <span class="k">done</span>
<span class="o">[</span>00:02:42] Upgrading using ftp
/etc/resolv.conf -&gt; /poudriere/jails/13amd64/etc/resolv.conf
Looking up update.FreeBSD.org mirrors... 3 mirrors found.
Fetching public key from update4.freebsd.org... <span class="k">done</span>.
Fetching metadata signature <span class="k">for </span>13.1-RELEASE from update4.freebsd.org... <span class="k">done</span>.
Fetching metadata index... <span class="k">done</span>.
Fetching 2 metadata files... <span class="k">done</span>.
Inspecting system... <span class="k">done</span>.
Preparing to download files... <span class="k">done</span>.
Fetching 124 patches.....10....20....30....40....50....60....70....80....90....100....110....120.. <span class="k">done</span>.
Applying patches... <span class="k">done</span>.
Fetching 6 files... <span class="k">done</span>.
The following files will be added as part of updating to
13.1-RELEASE-p1:
/usr/src/contrib/unbound/.github
/usr/src/contrib/unbound/.github/FUNDING.yml
/usr/src/contrib/unbound/contrib/drop2rpz
/usr/src/contrib/unbound/contrib/unbound_portable.service.in
/usr/src/contrib/unbound/services/rpz.c
/usr/src/contrib/unbound/services/rpz.h
/usr/src/lib/libc/tests/gen/spawnp_enoexec.sh
The following files will be updated as part of updating to
13.1-RELEASE-p1:
<span class="o">[</span>…]
Installing updates...Scanning //usr/share/certs/blacklisted <span class="k">for </span>certificates...
Scanning //usr/share/certs/trusted <span class="k">for </span>certificates...
 <span class="k">done</span>.
13.1-RELEASE-p1
<span class="o">[</span>00:04:06] Recording filesystem state <span class="k">for </span>clean... <span class="k">done</span>
<span class="o">[</span>00:04:07] Jail 13amd64 13.1-RELEASE-p1 amd64 is ready to be used</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># poudriere ports -c -p local -m git+https</span>
<span class="o">[</span>00:00:00] Creating <span class="nb">local </span>fs at /poudriere/ports/local... <span class="k">done</span>
<span class="o">[</span>00:00:00] Checking out the ports tree... <span class="k">done</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>在一台计算机上，poudriere 可以使用多个配置，在多个 jail 中，从不同的 ports 树构建 ports。这些组合的自定义配置被称为 <em>集合</em>。在安装了 <a class="package" href="https://cgit.freebsd.org/ports/tree/ports-mgmt/poudriere/">ports-mgmt/poudriere</a> 或 <a class="package" href="https://cgit.freebsd.org/ports/tree/ports-mgmt/poudriere-devel/">ports-mgmt/poudriere-devel</a> 之后，可以查看 <a href="https://man.freebsd.org/cgi/man.cgi?query=poudriere&amp;sektion=8&amp;format=html">poudriere(8)</a> 的 CUSTOMIZATION 部分获取详细信息。</p>
</div>
<div class="paragraph">
<p>这里显示的基本配置将一个单独的 jail、 port 和 set 特定的 <code>make.conf</code> 放置在 <code>/usr/local/etc/poudriere.d</code> 目录下。在这个示例中，文件名是通过组合 jail 名称、 port 名称和 set 名称创建的：<code>13amd64-local-workstation-make.conf</code>。系统的 <code>make.conf</code> 和这个新文件在构建时会合并，以创建构建 jail 使用的 <code>make.conf</code> 文件。</p>
</div>
<div class="paragraph">
<p>要构建的软件包应该在 <code>13amd64-local-workstation-pkglist</code> 文件中输入（具有 @FLAVOR 的 <a href="{porters-handbook}flavors">FLAVORS</a> 的 ports 可以定义）。</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>editors/emacs
devel/git
devel/php-composer2@php82
ports-mgmt/pkg
...</pre>
</div>
</div>
<div class="paragraph">
<p>已配置指定 ports 的选项和依赖项：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># poudriere options -j 13amd64 -p local -z workstation -f 13amd64-local-workstation-pkglist</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>最后，构建软件包并创建软件包仓库：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># poudriere bulk -j 13amd64 -p local -z workstation -f 13amd64-local-workstation-pkglist</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>在运行过程中，按下 <span class="keyseq"><kbd>Ctrl</kbd>+<kbd>t</kbd></span> 键可以显示构建的当前状态。poudriere 还会在 <code>/poudriere/logs/bulk/jailname</code> 目录中构建文件，可以与 Web 服务器一起使用以显示构建信息。</p>
</div>
<div class="paragraph">
<p>完成后，新的软件包现在可以从 poudriere 仓库进行安装。</p>
</div>
<div class="paragraph">
<p>有关使用 poudriere 的更多信息，请参阅 <a href="https://man.freebsd.org/cgi/man.cgi?query=poudriere&amp;sektion=8&amp;format=html">poudriere(8)</a> 和主要网站 <a href="https://github.com/freebsd/poudriere/wiki" class="bare">https://github.com/freebsd/poudriere/wiki</a>。</p>
</div>
</div>
<div class="sect3">
<h4 id="_配置_pkg_客户端以使用_poudriere_仓库">4.6.2. 配置 pkg 客户端以使用 poudriere 仓库<a class="anchor" href="#_配置_pkg_客户端以使用_poudriere_仓库"></a></h4>
<div class="paragraph">
<p>虽然可以同时使用自定义仓库和官方仓库，但有时禁用官方仓库是有用的。这可以通过创建一个配置文件来覆盖和禁用官方配置文件来实现。创建 <code>/usr/local/etc/pkg/repos/FreeBSD.conf</code> 文件，其中包含以下内容：</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>FreeBSD: {
	enabled: no
}</pre>
</div>
</div>
<div class="paragraph">
<p>通常，通过 HTTP 将 poudriere 仓库提供给客户机最为简单。设置一个 web 服务器来提供软件包目录，例如： <code>/usr/local/poudriere/data/packages/13amd64</code>，其中 <code>13amd64</code> 是构建的名称。</p>
</div>
<div class="paragraph">
<p>如果软件包仓库的 URL 是：<code><a href="http://pkg.example.com/13amd64" class="bare">http://pkg.example.com/13amd64</a></code>，那么位于 <code>/usr/local/etc/pkg/repos/custom.conf</code> 的仓库配置文件将如下所示：</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>custom: {
	url: &#34;http://pkg.example.com/13amd64&#34;,
	enabled: yes,
}</pre>
</div>
</div>
<div class="paragraph">
<p>如果不希望将软件包仓库暴露在互联网上，可以使用 <code>file://</code> 协议直接指向仓库：</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>custom: {
	url: &#34;file:///usr/local/poudriere/data/packages/11amd64&#34;,
	enabled: yes,
}</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="ports-nextsteps">4.7. 安装后的考虑事项<a class="anchor" href="#ports-nextsteps"></a></h3>
<div class="paragraph">
<p>无论软件是从二进制包还是 ports 安装的，大多数第三方应用程序在安装后都需要进行一定程度的配置。以下命令和位置可用于帮助确定应用程序安装了什么。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>大多数应用程序都会在 <code>/usr/local/etc</code> 目录下安装至少一个默认配置文件。在应用程序有大量配置文件的情况下，会创建一个子目录来存放它们。通常，会安装一些以 <code>.sample</code> 后缀结尾的示例配置文件。应该审查并可能编辑这些配置文件以满足系统的需求。要编辑示例文件，首先将其复制并去掉 <code>.sample</code> 扩展名。</p>
</li>
<li>
<p>提供文档的应用程序会将文档安装到 <code>/usr/local/share/doc</code> 目录下，许多应用程序还会安装手册页。在继续之前，应该先查阅这些文档。</p>
</li>
<li>
<p>一些应用程序运行的服务在启动应用程序之前必须添加到 <code>/etc/rc.conf</code> 中。这些应用程序通常会在 <code>/usr/local/etc/rc.d</code> 中安装一个启动脚本。有关更多信息，请参阅 <a href="./#configtuning-starting-services">启动服务</a>。</p>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>根据设计，应用程序在安装时不会运行启动脚本，也不会在卸载或升级时运行停止脚本。这个决定留给了个别系统管理员来决定。</p>
</div>
</td>
</tr>
</tbody></table>
</div>
</li>
<li>
<p>使用 <a href="https://man.freebsd.org/cgi/man.cgi?query=csh&amp;sektion=1&amp;format=html">csh(1)</a> 的用户应该运行 <code>rehash</code> 命令来重新构建 shell 的 <code>PATH</code> 中已知的二进制文件列表。</p>
</li>
<li>
<p>使用 <code>pkg info</code> 命令来确定应用程序安装了哪些文件、man 页面和二进制文件。</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="ports-broken">4.8. 处理损坏的 ports<a class="anchor" href="#ports-broken"></a></h3>
<div class="paragraph">
<p>当 ports 无法构建或安装时，请尝试以下操作：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>搜索一下 <a href="https://www.FreeBSD.org/support/">Problem Report database</a> 中的 ports 是否有待修复的问题报告。如果有的话，实施建议的修复可能会解决这个问题。</p>
</li>
<li>
<p>向 ports 的维护者寻求帮助。在 ports 骨架中键入 <code>make maintainer</code>，或者阅读 ports 的 <code>Makefile</code> 以找到维护者的电子邮件地址。记得在发送给维护者的电子邮件中包含错误之前的输出。</p>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>一些 ports 不是由个人维护，而是由一个由邮件列表表示的团队维护者维护。其中许多（但不是全部）地址看起来像 <a href="mailto:freebsd-listname@FreeBSD.org">freebsd-listname@FreeBSD.org</a>。在发送电子邮件时，请考虑这一点。</p>
</div>
<div class="paragraph">
<p>特别是，由 <a href="mailto:ports@FreeBSD.org">ports@FreeBSD.org</a> 维护的 ports 不由特定个人维护。相反，任何修复和支持都来自订阅该邮件列表的广大社区。我们始终需要更多的志愿者！</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>如果没有收到邮件回复，请按照 <a href="{problem-reports}#编写 FreeBSD 问题报告">Writing FreeBSD Problem Reports</a> 中的说明，使用 Bugzilla 提交错误报告。</p>
</div>
</li>
<li>
<p>修复它！ <a href="{porters-handbook}">Porter’s Handbook</a> 包含了有关 ports 基础设施的详细信息，以便您可以修复偶尔出现的损坏 ports，甚至提交您自己的 ports！</p>
</li>
<li>
<p>按照 <a href="#pkgng-intro">使用 pkg 进行二进制包管理</a> 中的说明安装软件包，而不是使用 ports。</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="x11">Chapter 5. The X Window System<a class="anchor" href="#x11"></a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="x11-synopsis">5.1. Synopsis<a class="anchor" href="#x11-synopsis"></a></h3>
<div class="paragraph">
<p>An installation of FreeBSD using bsdinstall does not automatically install a graphical user interface. This chapter describes how to install and configure Xorg, which provides the open source X Window System used to provide a graphical environment. It then describes how to find and install a desktop environment or window manager.</p>
</div>
<div class="paragraph">
<p>Before reading this chapter, you should:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Know how to install additional third-party software as described in <a href="./#ports">Installing Applications: Packages and Ports</a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>After reading this chapter, you will know:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The various components of the X Window System, and how they interoperate.</p>
</li>
<li>
<p>How to install and configure Xorg.</p>
</li>
<li>
<p>How to use TrueType® fonts in Xorg.</p>
</li>
<li>
<p>How to set up your system for graphical logins (XDM).</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="x-install">5.2. Installing Xorg<a class="anchor" href="#x-install"></a></h3>
<div class="paragraph">
<p>On FreeBSD, Xorg can be installed as a package or port.</p>
</div>
<div class="paragraph">
<p>The binary meta package can be installed quickly but with fewer options for customization:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install xorg</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Either of these installations results in the complete Xorg system being installed.</p>
</div>
<div class="paragraph">
<p>The current user must be a member of the <code>video</code> group. To add a user to <code>video</code> group, execute the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pw groupmod video -m username</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A smaller version of the X system suitable for experienced users is available in <a class="package" href="https://cgit.freebsd.org/ports/tree/x11/xorg-minimal/">x11/xorg-minimal</a>. Most of the documents, libraries, and applications will not be installed. Some applications require these additional components to function.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Video cards, monitors, and input devices are automatically detected and do not require any manual configuration. Do not create <code>xorg.conf</code> or run a <code>-configure</code> step unless automatic configuration fails.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect2">
<h3 id="x-graphic-card-drivers">5.3. Graphic card drivers<a class="anchor" href="#x-graphic-card-drivers"></a></h3>
<div class="paragraph">
<p>The following table shows the different graphics cards supported by FreeBSD, which package should be installed and its corresponding module.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">表 7. Graphic card packages</caption>
<colgroup>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Brand</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Package</th>
<th class="tableblock halign-left valign-top">Module</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Intel®</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Open Source</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">drm-kmod</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>i915kms</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">AMD®</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Open Source</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">drm-kmod</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>amdgpu</code> and <code>radeonkms</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">NVIDIA®</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Proprietary</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">nvidia-driver</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>nvidia</code> or <code>nvidia-modeset</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">VESA</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Open Source</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">xf86-video-vesa</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">vesa</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SCFB</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Open Source</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">xf86-video-scfb</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">scfb</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">VirtualBox®</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Open Source</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">virtualbox-ose-additions</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">VirtualBox® OSE additions include the <code>vboxvideo</code> driver.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">VMware®</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Open Source</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">xf86-video-vmware</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">vmwgfx</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The following command can be used to identify which graphics card is installed in the system:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>pciconf -lv|grep -B4 VGA</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should be similar to the following:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>vgapci0@pci0:0:2:0:     class=0x030000 rev=0x07 hdr=0x00 vendor=0x8086 device=0x2a42 subvendor=0x17aa subdevice=0x20e4
    vendor     = &#39;Intel Corporation&#39;
    device     = &#39;Mobile 4 Series Chipset Integrated Graphics Controller&#39;
    class      = display
    subclass   = VGA</pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If the graphics card is not supported by Intel®, AMD® or NVIDIA® drivers, then VESA or SCFB modules should be used. VESA module must be used when booting in BIOS mode and SCFB module must be used when booting in UEFI mode.</p>
</div>
<div class="paragraph">
<p>This command can be used to check the booting mode:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>sysctl machdep.bootmethod</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should be similar to the following:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>machdep.bootmethod: BIOS</pre>
</div>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="sect3">
<h4 id="x-configuration-intel">5.3.1. Intel®<a class="anchor" href="#x-configuration-intel"></a></h4>
<div class="paragraph">
<p>Intel® Graphics refers to the class of graphics chips that are integrated on the same die as an Intel® CPU. Wikipedia offers <a href="https://en.wikipedia.org/wiki/List_of_Intel_graphics_processing_units">a good overview of the variations and names used for generations of Intel HD Graphics</a>.</p>
</div>
<div class="paragraph">
<p>The <a class="package" href="https://cgit.freebsd.org/ports/tree/graphics/drm-kmod/">graphics/drm-kmod</a> package indirectly provides a range of kernel modules for use with Intel® Graphics cards. The Intel® driver can be installed by executing the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install drm-kmod</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then add the module to <code>/etc/rc.conf</code> file, executing the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysrc kld_list+=i915kms</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If a high CPU usage is noticed or excessive tearing with HD video, the installation of <a class="package" href="https://cgit.freebsd.org/ports/tree/multimedia/libva-intel-driver/">multimedia/libva-intel-driver</a> may help. To install the package execute the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install libva-intel-driver mesa-libs mesa-dri</span></code></pre>
</div>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect3">
<h4 id="x-configuration-amd">5.3.2. AMD®<a class="anchor" href="#x-configuration-amd"></a></h4>
<div class="paragraph">
<p>The <a class="package" href="https://cgit.freebsd.org/ports/tree/graphics/drm-kmod/">graphics/drm-kmod</a> package indirectly provides a range of kernel modules for use with AMD® Graphics cards. The modules <code>amdgpu</code> and <code>radeonkms</code> can be used depending the generation of the hardware. The FreeBSD project maintains an <a href="https://wiki.freebsd.org/Graphics/AMD-GPU-Matrix">AMD graphics support matrix to determine which driver must be used</a>.</p>
</div>
<div class="paragraph">
<p>AMD® driver can be installed by executing the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install drm-kmod</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For post-HD7000 or Tahiti graphic cards add the module to <code>/etc/rc.conf</code> file, executing the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysrc kld_list+=amdgpu</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For older graphic cards (pre-HD7000 or pre-Tahiti) add the module to <code>/etc/rc.conf</code> file, executing the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysrc kld_list+=radeonkms</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="x-configuration-nvidia">5.3.3. NVIDIA®<a class="anchor" href="#x-configuration-nvidia"></a></h4>
<div class="paragraph">
<p>FreeBSD supports different versions of the proprietary NVIDIA® driver. Users of newer graphics cards should install the <a class="package" href="https://cgit.freebsd.org/ports/tree/x11/nvidia-driver/">x11/nvidia-driver</a> package. Those with older cards will have to check below which version supports them.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">表 8. Supported versions of NVIDIA® drivers</caption>
<colgroup>
<col style="width: 50%;"/>
<col style="width: 50%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Package</th>
<th class="tableblock halign-left valign-top">Supported hardware</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">x11/nvidia-driver-304</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.nvidia.com/Download/driverResults.aspx/123712/en-us/">supported hardware</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">x11/nvidia-driver-340</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.nvidia.com/Download/driverResults.aspx/156167/en-us/">supported hardware</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">x11/nvidia-driver-390</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.nvidia.com/Download/driverResults.aspx/191122/en-us/">supported hardware</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">x11/nvidia-driver-470</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.nvidia.com/Download/driverResults.aspx/194639/en-us/">supported hardware</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">x11/nvidia-driver</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.nvidia.com/Download/driverResults.aspx/210651/en-us/">supported hardware</a></p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock warning">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Version 304 of the NVIDIA® graphics driver (nvidia-driver-304) does not support xorg-server 1.20 or later.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>The latest NVIDIA® driver can be installed by running the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install nvidia-driver</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then add the module to <code>/etc/rc.conf</code> file, executing the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysrc kld_list+=nvidia-modeset</span></code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>nvidia</code> driver must be used if the packages x11/nvidia-driver-304 or x11/nvidia-driver-340 have been installed.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysrc kld_list+=nvidia</span></code></pre>
</div>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="x-config">5.4. Xorg Configuration<a class="anchor" href="#x-config"></a></h3>
<div class="paragraph">
<p>Xorg supports most common video cards, keyboards, and pointing devices.</p>
</div>
<div class="admonitionblock warning">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Video cards, monitors, and input devices are automatically detected and do not require any manual configuration. Do not create <span class="filename">xorg.conf</span> or run a <code>Xorg -configure</code> step unless automatic configuration fails.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="sect3">
<h4 id="x-config-files">5.4.1. Configuration Files<a class="anchor" href="#x-config-files"></a></h4>
<div class="paragraph">
<p>Xorg looks in several directories for configuration files. <span class="filename">/usr/local/etc/X11/</span> is the <strong>recommended</strong> directory for these files on FreeBSD. Using this directory helps keep application files separate from operating system files.</p>
</div>
</div>
<div class="sect3">
<h4 id="x-config-files-single-or-multi">5.4.2. Single or Multiple Files<a class="anchor" href="#x-config-files-single-or-multi"></a></h4>
<div class="paragraph">
<p>It is easier to use multiple files that each configure a specific setting than the traditional single <span class="filename">xorg.conf</span>. These files are stored in the <span class="filename">/usr/local/etc/X11/xorg.conf.d/</span> subdirectory.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The traditional single <span class="filename">xorg.conf</span> still works, but is neither as clear nor as flexible as multiple files in the <span class="filename">/usr/local/etc/X11/xorg.conf.d/</span> subdirectory.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect3">
<h4 id="x-config-video-cards">5.4.3. Video Cards<a class="anchor" href="#x-config-video-cards"></a></h4>
<div class="paragraph">
<p>The driver for the graphics card can be specified in the <span class="filename">/usr/local/etc/X11/xorg.conf.d/</span> directory.</p>
</div>
<div class="paragraph">
<p>To configure the Intel® driver in a configuration file:</p>
</div>
<div id="x-config-video-cards-file-intel" class="exampleblock">
<div class="title">例 14. Select Intel® Video Driver in a File</div>
<div class="content">
<div class="paragraph">
<p><span class="filename">/usr/local/etc/X11/xorg.conf.d/20-intel.conf</span></p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>Section &#34;Device&#34;
	Identifier &#34;Card0&#34;
	Driver     &#34;intel&#34;
EndSection</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>To configure the AMD® driver in a configuration file:</p>
</div>
<div id="x-config-video-cards-file-amd" class="exampleblock">
<div class="title">例 15. Select AMD® Video Driver in a File</div>
<div class="content">
<div class="paragraph">
<p><span class="filename">/usr/local/etc/X11/xorg.conf.d/20-radeon.conf</span></p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>Section &#34;Device&#34;
	Identifier &#34;Card0&#34;
	Driver     &#34;radeon&#34;
EndSection</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>To configure the NVIDIA® driver in a configuration file:</p>
</div>
<div id="x-config-video-cards-file-nvidia" class="exampleblock">
<div class="title">例 16. Select NVIDIA® Video Driver in a File</div>
<div class="content">
<div class="paragraph">
<p><span class="filename">/usr/local/etc/X11/xorg.conf.d/20-nvidia.conf</span></p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>Section &#34;Device&#34;
	Identifier &#34;Card0&#34;
	Driver     &#34;nvidia&#34;
EndSection</pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p><a class="package" href="https://cgit.freebsd.org/ports/tree/x11/nvidia-xconfig/">x11/nvidia-xconfig</a> can also be used to perform basic control over configuration options available in the NVIDIA driver.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>To configure the VESA driver in a configuration file:</p>
</div>
<div id="x-config-video-cards-file-vesa" class="exampleblock">
<div class="title">例 17. Select VESA Video Driver in a File</div>
<div class="content">
<div class="paragraph">
<p><span class="filename">/usr/local/etc/X11/xorg.conf.d/20-vesa.conf</span></p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>Section &#34;Device&#34;
	Identifier &#34;Card0&#34;
	Driver     &#34;vesa&#34;
EndSection</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>To configure the SCFB driver in a configuration file:</p>
</div>
<div id="x-config-video-cards-file-sfcb" class="exampleblock">
<div class="title">例 18. Select SCFB Video Driver in a File</div>
<div class="content">
<div class="paragraph">
<p><span class="filename">/usr/local/etc/X11/xorg.conf.d/20-scfb.conf</span></p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>Section &#34;Device&#34;
	Identifier &#34;Card0&#34;
	Driver     &#34;scfb&#34;
EndSection</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>To configure multiple video cards, the <code>BusID</code> can be added. A list of video card bus <code>ID</code>s can be displayed by executing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>pciconf -lv | grep -B3 display</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should be similar to the following:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>vgapci0@pci0:0:2:0:     class=0x030000 rev=0x07 hdr=0x00 vendor=0x8086 device=0x2a42 subvendor=0x17aa subdevice=0x20e4
    vendor     = &#39;Intel Corporation&#39;
    device     = &#39;Mobile 4 Series Chipset Integrated Graphics Controller&#39;
    class      = display
--
vgapci1@pci0:0:2:1:     class=0x038000 rev=0x07 hdr=0x00 vendor=0x8086 device=0x2a43 subvendor=0x17aa subdevice=0x20e4
    vendor     = &#39;Intel Corporation&#39;
    device     = &#39;Mobile 4 Series Chipset Integrated Graphics Controller&#39;
    class      = display</pre>
</div>
</div>
<div id="x-config-video-cards-file-multiple" class="exampleblock">
<div class="title">例 19. Select Intel® Video Driver and NVIDIA® Video Driver in a File</div>
<div class="content">
<div class="paragraph">
<p><span class="filename">/usr/local/etc/X11/xorg.conf.d/20-drivers.conf</span></p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>Section &#34;Device&#34;
	Identifier &#34;Card0&#34;
	Driver     &#34;intel&#34;
	BusID     &#34;pci0:0:2:0&#34;
EndSection

Section &#34;Device&#34;
	Identifier &#34;Card0&#34;
	Driver     &#34;nvidia&#34;
	BusID     &#34;pci0:0:2:1&#34;
EndSection</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="x-config-monitors">5.4.4. Monitors<a class="anchor" href="#x-config-monitors"></a></h4>
<div class="paragraph">
<p>Almost all monitors support the Extended Display Identification Data standard (<code>EDID</code>). Xorg uses <code>EDID</code> to communicate with the monitor and detect the supported resolutions and refresh rates. Then it selects the most appropriate combination of settings to use with that monitor.</p>
</div>
<div class="paragraph">
<p>Other resolutions supported by the monitor can be chosen by setting the desired resolution in configuration files, or after the X server has been started with <a href="https://man.freebsd.org/cgi/man.cgi?query=xrandr&amp;sektion=1&amp;format=html">xrandr(1)</a>.</p>
</div>
<div class="sect4">
<h5 id="x-config-monitors-xrandr">5.4.4.1. Using RandR (Resize and Rotate)<a class="anchor" href="#x-config-monitors-xrandr"></a></h5>
<div class="paragraph">
<p>Run <a href="https://man.freebsd.org/cgi/man.cgi?query=xrandr&amp;sektion=1&amp;format=html">xrandr(1)</a> without any parameters to see a list of video outputs and detected monitor modes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>xrandr</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should be similar to the following:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>Screen 0: minimum 320 x 200, current 2560 x 960, maximum 8192 x 8192
LVDS-1 connected 1280x800+0+0 (normal left inverted right x axis y axis) 261mm x 163mm
   1280x800      59.99*+  59.81    59.91    50.00
   1280x720      59.86    59.74
   1024x768      60.00
   1024x576      59.90    59.82
   960x540       59.63    59.82
   800x600       60.32    56.25
   864x486       59.92    59.57
   640x480       59.94
   720x405       59.51    58.99
   640x360       59.84    59.32
VGA-1 connected primary 1280x960+1280+0 (normal left inverted right x axis y axis) 410mm x 257mm
   1280x1024     75.02    60.02
   1440x900      74.98    60.07
   1280x960      60.00*
   1280x800      74.93    59.81
   1152x864      75.00
   1024x768      75.03    70.07    60.00
   832x624       74.55
   800x600       72.19    75.00    60.32    56.25
   640x480       75.00    72.81    66.67    59.94
   720x400       70.08
HDMI-1 disconnected (normal left inverted right x axis y axis)
DP-1 disconnected (normal left inverted right x axis y axis)
HDMI-2 disconnected (normal left inverted right x axis y axis)
DP-2 disconnected (normal left inverted right x axis y axis)
DP-3 disconnected (normal left inverted right x axis y axis)</pre>
</div>
</div>
<div class="paragraph">
<p>This shows that the <code>VGA-1</code> output is being used to display a screen resolution of 1280x960 pixels at a refresh rate of about 60 Hz. The <code>LVDS-1</code> is being used as a secondary monitor to display a screen resolution of 1280x800 pixels at a refresh rate of about 60 Hz. Monitors are not attached to the <code>HDMI-1</code>, <code>HDMI-2</code>, <code>DP-1</code>, <code>DP-2</code> and <code>DP-3</code> connectors.</p>
</div>
<div class="paragraph">
<p>Any of the other display modes can be selected with <a href="https://man.freebsd.org/cgi/man.cgi?query=xrandr&amp;sektion=1&amp;format=html">xrandr(1)</a>. For example, to switch to 1280x1024 at 60 Hz:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>xrandr --output LVDS-1 --mode 1280x720 --rate 60</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="x-config-monitors-files">5.4.4.2. Using the Xorg configuration file<a class="anchor" href="#x-config-monitors-files"></a></h5>
<div class="paragraph">
<p>The monitor configuration can also be set in a configuration file.</p>
</div>
<div class="paragraph">
<p>To set a screen resolution of 1024x768 in a configuration file:</p>
</div>
<div class="exampleblock">
<div class="title">例 20. Set Screen Resolution in a File</div>
<div class="content">
<div class="paragraph">
<p><span class="filename">/usr/local/etc/X11/xorg.conf.d/10-monitor.conf</span></p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>Section &#34;Screen&#34;
	Identifier &#34;Screen0&#34;
	Device     &#34;Card0&#34;
	SubSection &#34;Display&#34;
	Modes      &#34;1024x768&#34;
	EndSubSection
EndSection</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="x-config-input">5.4.5. Input Devices<a class="anchor" href="#x-config-input"></a></h4>
<div class="paragraph">
<p>Xorg supports the vast majority of input devices via <a class="package" href="https://cgit.freebsd.org/ports/tree/x11/libinput/">x11/libinput</a>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Some desktop environments (such as KDE Plasma) provide a graphical UI for setting these parameters. Check if this is the case before resorting to manual configuration editing.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div id="x-config-input-keyboard-layout" class="paragraph">
<p>For example, to configure the keyboard layout:</p>
</div>
<div class="exampleblock">
<div class="title">例 21. Setting a Keyboard Layout</div>
<div class="content">
<div class="paragraph">
<p><span class="filename">/usr/local/etc/X11/xorg.conf.d/00-keyboard.conf</span></p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>Section &#34;InputClass&#34;
        Identifier &#34;Keyboard1&#34;
        MatchIsKeyboard &#34;on&#34;
        Option &#34;XkbLayout&#34; &#34;es, fr&#34;
        Option &#34;XkbModel&#34; &#34;pc104&#34;
        Option &#34;XkbVariant&#34; &#34;,qwerty&#34;
        Option &#34;XkbOptions&#34; &#34;grp:win_space_toggle&#34;
EndSection</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="x-fonts">5.5. Using Fonts in Xorg<a class="anchor" href="#x-fonts"></a></h3>
<div class="paragraph">
<p>The default fonts that ship with Xorg are less than ideal for typical desktop publishing applications. Large presentation fonts show up jagged and unprofessional looking, and small fonts are almost completely unintelligible. However, there are several free, high quality Type1 (PostScript®) fonts available which can be readily used with Xorg.</p>
</div>
<div class="sect3">
<h4 id="type1">5.5.1. Type1 Fonts<a class="anchor" href="#type1"></a></h4>
<div class="paragraph">
<p>The URW font collection (<a class="package" href="https://cgit.freebsd.org/ports/tree/x11-fonts/urwfonts/">x11-fonts/urwfonts</a>) includes high quality versions of standard type1 fonts (Times Roman™, Helvetica™, Palatino™ and others). The Freefonts collection (<a class="package" href="https://cgit.freebsd.org/ports/tree/x11-fonts/freefonts/">x11-fonts/freefonts</a>) includes many more fonts, but most of them are intended for use in graphics software such as the Gimp, and are not complete enough to serve as screen fonts. In addition, Xorg can be configured to use TrueType® fonts with a minimum of effort. For more details on this, see the <a href="https://man.freebsd.org/cgi/man.cgi?query=X&amp;sektion=7&amp;format=html">X(7)</a> manual page or <a href="#truetype">TrueType® Fonts</a>.</p>
</div>
<div class="paragraph">
<p>To install the above Type1 font collections from binary packages, run the following commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install urwfonts</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And likewise with the freefont or other collections. To have the X server detect these fonts, add an appropriate line to the X server configuration file (<span class="filename">/usr/local/etc/X11/xorg.conf.d/90-fonts.conf</span>), which reads:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>Section &#34;Files&#34;
  FontPath &#34;/usr/local/share/fonts/urwfonts/&#34;
EndSection</pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, at the command line in the X session run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>xset fp+ /usr/local/share/fonts/urwfonts
<span class="gp">% </span>xset fp rehash</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will work but will be lost when the X session is closed, unless it is added to the startup file (<span class="filename">~/.xinitrc</span> for a normal <code>startx</code> session, or <span class="filename">~/.xsession</span> when logging in through a graphical login manager like XDM). A third way is to use the new <span class="filename">/usr/local/etc/fonts/local.conf</span> as demonstrated in <a href="#antialias">Anti-Aliased Fonts</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="truetype">5.5.2. TrueType® Fonts<a class="anchor" href="#truetype"></a></h4>
<div class="paragraph">
<p>Xorg has built in support for rendering TrueType® fonts. There are two different modules that can enable this functionality. The freetype module is used in this example because it is more consistent with the other font rendering back-ends. To enable the freetype module just add the following line to the <code>&#34;Module&#34;</code> section of <span class="filename">/usr/local/etc/X11/xorg.conf.d/90-fonts.conf</span>.</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>Load  &#34;freetype&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>Now make a directory for the TrueType® fonts (for example, <span class="filename">/usr/local/share/fonts/TrueType</span>) and copy all of the TrueType® fonts into this directory. Keep in mind that TrueType® fonts cannot be directly taken from an Apple® Mac®; they must be in UNIX®/MS-DOS®/Windows® format for use by Xorg. Once the files have been copied into this directory, use mkfontscale to create a <span class="filename">fonts.dir</span>, so that the X font renderer knows that these new files have been installed. <code>mkfontscale</code> can be installed as a package:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install mkfontscale</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then create an index of X font files in a directory:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># cd /usr/local/share/fonts/TrueType</span>
<span class="c"># mkfontscale</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now add the TrueType® directory to the font path. This is just the same as described in <a href="#type1">Type1 Fonts</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>xset fp+ /usr/local/share/fonts/TrueType
<span class="gp">% </span>xset fp rehash</code></pre>
</div>
</div>
<div class="paragraph">
<p>or add a <code>FontPath</code> line to <span class="filename">xorg.conf</span>.</p>
</div>
<div class="paragraph">
<p>Now Gimp, LibreOffice, and all of the other X applications should now recognize the installed TrueType® fonts. Extremely small fonts (as with text in a high resolution display on a web page) and extremely large fonts (within LibreOffice) will look much better now.</p>
</div>
</div>
<div class="sect3">
<h4 id="antialias">5.5.3. Anti-Aliased Fonts<a class="anchor" href="#antialias"></a></h4>
<div class="paragraph">
<p>All fonts in Xorg that are found in <span class="filename">/usr/local/share/fonts/</span> and <span class="filename">~/.fonts/</span> are automatically made available for anti-aliasing to Xft-aware applications. Most recent applications are Xft-aware, including KDE, GNOME, and Firefox.</p>
</div>
<div class="paragraph">
<p>To control which fonts are anti-aliased, or to configure anti-aliasing properties, create (or edit, if it already exists) the file <span class="filename">/usr/local/etc/fonts/local.conf</span>. Several advanced features of the Xft font system can be tuned using this file; this section describes only some simple possibilities. For more details, please see <a href="https://man.freebsd.org/cgi/man.cgi?query=fonts-conf&amp;sektion=5&amp;format=html">fonts-conf(5)</a>.</p>
</div>
<div class="paragraph">
<p>This file must be in XML format. Pay careful attention to case, and make sure all tags are properly closed. The file begins with the usual XML header followed by a DOCTYPE definition, and then the <code>&lt;fontconfig&gt;</code> tag:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>&lt;?xml version=&#34;1.0&#34;?&gt;
      &lt;!DOCTYPE fontconfig SYSTEM &#34;fonts.dtd&#34;&gt;
      &lt;fontconfig&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>As previously stated, all fonts in <span class="filename">/usr/local/share/fonts/</span> as well as <span class="filename">~/.fonts/</span> are already made available to Xft-aware applications. To add another directory outside of these two directory trees, add a line like this to <span class="filename">/usr/local/etc/fonts/local.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>&lt;dir&gt;/path/to/my/fonts&lt;/dir&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>After adding new fonts, and especially new font directories, rebuild the font caches:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># fc-cache -f</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Anti-aliasing makes borders slightly fuzzy, which makes very small text more readable and removes &#34;staircases&#34; from large text, but can cause eyestrain if applied to normal text. To exclude font sizes smaller than 14 point from anti-aliasing, include these lines:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>	&lt;match target=&#34;font&#34;&gt;
	    &lt;test name=&#34;size&#34; compare=&#34;less&#34;&gt;
		&lt;double&gt;14&lt;/double&gt;
	    &lt;/test&gt;
	    &lt;edit name=&#34;antialias&#34; mode=&#34;assign&#34;&gt;
		&lt;bool&gt;false&lt;/bool&gt;
	    &lt;/edit&gt;
	&lt;/match&gt;
	&lt;match target=&#34;font&#34;&gt;
	    &lt;test name=&#34;pixelsize&#34; compare=&#34;less&#34; qual=&#34;any&#34;&gt;
		&lt;double&gt;14&lt;/double&gt;
	    &lt;/test&gt;
	    &lt;edit mode=&#34;assign&#34; name=&#34;antialias&#34;&gt;
		&lt;bool&gt;false&lt;/bool&gt;
	    &lt;/edit&gt;
	&lt;/match&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>Spacing for some monospaced fonts might also be inappropriate with anti-aliasing. This seems to be an issue with KDE, in particular. One possible fix is to force the spacing for such fonts to be 100. Add these lines:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>	&lt;match target=&#34;pattern&#34; name=&#34;family&#34;&gt;
	   &lt;test qual=&#34;any&#34; name=&#34;family&#34;&gt;
	       &lt;string&gt;fixed&lt;/string&gt;
	   &lt;/test&gt;
	   &lt;edit name=&#34;family&#34; mode=&#34;assign&#34;&gt;
	       &lt;string&gt;mono&lt;/string&gt;
	   &lt;/edit&gt;
	&lt;/match&gt;
	&lt;match target=&#34;pattern&#34; name=&#34;family&#34;&gt;
	    &lt;test qual=&#34;any&#34; name=&#34;family&#34;&gt;
		&lt;string&gt;console&lt;/string&gt;
	    &lt;/test&gt;
	    &lt;edit name=&#34;family&#34; mode=&#34;assign&#34;&gt;
		&lt;string&gt;mono&lt;/string&gt;
	    &lt;/edit&gt;
	&lt;/match&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>(this aliases the other common names for fixed fonts as <code>&#34;mono&#34;</code>), and then add:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>	&lt;match target=&#34;pattern&#34; name=&#34;family&#34;&gt;
	     &lt;test qual=&#34;any&#34; name=&#34;family&#34;&gt;
		 &lt;string&gt;mono&lt;/string&gt;
	     &lt;/test&gt;
	     &lt;edit name=&#34;spacing&#34; mode=&#34;assign&#34;&gt;
		 &lt;int&gt;100&lt;/int&gt;
	     &lt;/edit&gt;
	 &lt;/match&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>Certain fonts, such as Helvetica, may have a problem when anti-aliased. Usually this manifests itself as a font that seems cut in half vertically. At worst, it may cause applications to crash. To avoid this, consider adding the following to <span class="filename">local.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>	&lt;match target=&#34;pattern&#34; name=&#34;family&#34;&gt;
	     &lt;test qual=&#34;any&#34; name=&#34;family&#34;&gt;
		 &lt;string&gt;Helvetica&lt;/string&gt;
	     &lt;/test&gt;
	     &lt;edit name=&#34;family&#34; mode=&#34;assign&#34;&gt;
		 &lt;string&gt;sans-serif&lt;/string&gt;
	     &lt;/edit&gt;
	 &lt;/match&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>After editing <span class="filename">local.conf</span>, make certain to end the file with the <code>&lt;/fontconfig&gt;</code> tag. Not doing this will cause changes to be ignored.</p>
</div>
<div class="paragraph">
<p>Users can add personalized settings by creating their own <span class="filename">~/.config/fontconfig/fonts.conf</span>. This file uses the same <code>XML</code> format described above.</p>
</div>
<div class="paragraph">
<p>One last point: with an LCD screen, sub-pixel sampling may be desired. This basically treats the (horizontally separated) red, green and blue components separately to improve the horizontal resolution; the results can be dramatic. To enable this, add the line somewhere in <span class="filename">local.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>	 &lt;match target=&#34;font&#34;&gt;
	     &lt;test qual=&#34;all&#34; name=&#34;rgba&#34;&gt;
		 &lt;const&gt;unknown&lt;/const&gt;
	     &lt;/test&gt;
	     &lt;edit name=&#34;rgba&#34; mode=&#34;assign&#34;&gt;
		 &lt;const&gt;rgb&lt;/const&gt;
	     &lt;/edit&gt;
	 &lt;/match&gt;</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Depending on the sort of display, <code>rgb</code> may need to be changed to <code>bgr</code>, <code>vrgb</code> or <code>vbgr</code>: experiment and see which works best.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>For more information about how to install and configure fonts on FreeBSD, please read the article <a href="{fonts}">Fonts and FreeBSD</a>.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="wayland">Chapter 6. Wayland on FreeBSD<a class="anchor" href="#wayland"></a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="wayland-synopsis">6.1. Wayland Synopsis<a class="anchor" href="#wayland-synopsis"></a></h3>
<div class="paragraph">
<p>Wayland is a new display server, but it differs from Xorg in several important ways. First, Wayland is only a protocol that acts as an intermediary between clients using a different mechanism which removes the dependency on an X server. Xorg includes both the X11 protocol, used to run remote displays and the X server will accept connections and display windows. Under Wayland, the compositor or window manager provides the display server instead of a traditional X server.</p>
</div>
<div class="paragraph">
<p>Since Wayland is not an X server, traditional X screen connections will need to utilize other methods such as VNC or RDP for remote desktop management. Second, Wayland can manage composite communications between clients and a compositor as a separate entity which does not need to support the X protocols.</p>
</div>
<div class="paragraph">
<p>Wayland is relatively new, and not all software has been updated to run natively without <code>Xwayland</code> support. Because Wayland does not provide the X server, and expects compositors to provide that support, X11 window managers that do not yet support Wayland will require that <code>Xwayland</code> is not started with the <code>-rootless</code> parameter. The <code>-rootless</code> parameter, when removed, will restore X11 window manager support.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The current NVIDIA® driver should work with most wlroots compositors, but it may be a little unstable and not support all features at this time. Volunteers to help work on the NVIDIA® DRM are requested.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Currently, a lot of software will function with minimal issues on Wayland, including Firefox. And a few desktops are also available, such as the Compiz Fusion replacement, known as Wayfire, and the i3 window manager replacement, Sway.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>As of May, 2021, plasma5-kwin does support Wayland on FreeBSD. To use Plasma under Wayland, use the <code>startplasma-wayland</code> parameter to <code>ck-launch-session</code> and tie in dbus with: <code>ck-launch-session dbus-run-session startplasma-wayland</code> to get it working.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>For compositors, a kernel supporting the <a href="https://man.freebsd.org/cgi/man.cgi?query=evdev&amp;sektion=4&amp;format=html">evdev(4)</a> driver must exist to utilize the keybinding functionality. This is built into the <span class="filename">GENERIC</span> kernel by default; however, if it has been customized and <a href="https://man.freebsd.org/cgi/man.cgi?query=evdev&amp;sektion=4&amp;format=html">evdev(4)</a> support was stripped out, the <a href="https://man.freebsd.org/cgi/man.cgi?query=evdev&amp;sektion=4&amp;format=html">evdev(4)</a> module will need to be loaded. In addition, users of <code>Wayland</code> will need to be members of the <code>video</code> group. To quickly make this change, use the <code>pw</code> command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">pw groupmod video -m user</code></pre>
</div>
</div>
<div class="paragraph">
<p>Installing Wayland is simple; there is not a great deal of configuration for the protocol itself. Most of the composition will depend on the chosen compositor. By installing <code>seatd</code> now, a step is skipped as part of the compositor installation and configuration as <code>seatd</code> is needed to provide non-root access to certain devices.</p>
</div>
<div class="paragraph">
<p>All of the compositors described here should work with <a class="package" href="https://cgit.freebsd.org/ports/tree/graphics/drm-kmod/">graphics/drm-kmod</a> open source drivers; however, the NVIDIA® graphics cards may have issues when using the proprietary drivers. Begin by installing the following packages:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install wayland seatd</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Once the protocol and supporting packages have been installed, a compositor must create the user interface. Several compositors will be covered in the following sections. All compositors using Wayland will need a runtime directory defined in the environment, which can be achieved with the following command in the bourne shell:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span><span class="nb">export </span><span class="nv">XDG_RUNTIME_DIR</span><span class="o">=</span>/var/run/user/<span class="sb">`</span>id -u<span class="sb">`</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>It is important to note that most compositors will search the XDG_RUNTIME_DIR directory for the configuration files. In the examples included here, a parameter will be used to specify a configuration file in <span class="filename">~/.config</span> to keep temporary files and configuration files separate. It is recommended that an alias be configured for each compositor to load the designated configuration file.</p>
</div>
<div class="admonitionblock warning">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>It has been reported that ZFS users may experience issues with some Wayland clients because they need access to <code>posix_fallocate()</code> in the runtime directory. While the author could not reproduce this issue on their ZFS system, a recommended workaround is not to use ZFS for the runtime directory and instead use <code>tmpfs</code> for the <span class="filename">/var/run</span> directory. In this case, the <code>tmpfs</code> file system is used for <span class="filename">/var/run</span> and mounted through the command <code>mount -t tmpfs tmpfs /var/run</code> command and then make this change persist across reboots through <span class="filename">/etc/fstab</span>. The XDG_RUNTIME_DIR environment variable could be configured to use <span class="filename">/var/run/user/$UID</span> and avoid potential pitfalls with ZFS. Consider that scenario when reviewing the configuration examples in the following sections.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>The seatd daemon helps manage access to shared system devices for non-root users in compositors; this includes graphics cards. For traditional X11 managers, <code>seatd</code> is not needed, such as both Plasma and GNOME, but for the Wayland compositors discussed here, it will need enabled on the system and be running before starting a compositor environment. To enable and start the <code>seatd</code> daemon now, and on system initialization:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysrc seatd_enable=”YES”</span>
<span class="c"># service seatd start</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Afterward, a compositor, which is similar to an X11 desktop, will need to be installed for the GUI environment. Three are discussed here, including basic configuration options, setting up a screen lock, and recommendations for more information.</p>
</div>
</div>
<div class="sect2">
<h3 id="wayland-wayfire">6.2. The Wayfire Compositor<a class="anchor" href="#wayland-wayfire"></a></h3>
<div class="paragraph">
<p>Wayfire is a compositor that aims to be lightweight and customizable. Several features are available, and it brings back several elements from the previously released Compiz Fusion desktop. All of the parts look beautiful on modern hardware. To get Wayfire up and running, begin by installing the required packages:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install wayfire wf-shell alacritty swaylock-effects swayidle wlogout kanshi mako wlsunset</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>alacritty</code> package provides a terminal emulator. Still, it is not completely required as other terminal emulators such as <code>kitty</code>, and XFCE-4 <code>Terminal</code> have been tested and verified to work under the Wayfire compositor. Wayfire configuration is relatively simple; it uses a file that should be reviewed for any customizations. To begin, copy the example file over to the runtime environment configuration directory and then edit the file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>mkdir ~/.config/wayfire
<span class="gp">% </span>cp /usr/local/share/examples/wayfire/wayfire.ini ~/.config/wayfire</code></pre>
</div>
</div>
<div class="paragraph">
<p>The defaults for most users should be fine. Within the configuration file, items like the famous <code>cube</code> are pre-configured, and there are instructions to help with the available settings. A few primary settings of note include:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>[output]
mode = 1920x1080@60000
position = 0,0
transform = normal
scale = 1.000000</pre>
</div>
</div>
<div class="paragraph">
<p>In this example, from the configuration file, the screen’s output should be the listed mode at the listed hertz. For example, the mode should be set to <code>widthxheight@refresh_rate</code>. The position places the output at a specific pixel location specified. The default should be fine for most users. Finally, transform sets a background transform, and scale will scale the output to the specified scale factor. The defaults for these options are generally acceptable; for more information, see the documentation.</p>
</div>
<div class="paragraph">
<p>As mentioned, Wayland is new, and not all applications work with the protocol yet. At this time, <code>sddm</code> does not appear to support starting and managing compositors in Wayland. The <code>swaylock</code> utility has been used instead in these examples. The configuration file contains options to run <code>swayidle</code> and <code>swaylock</code> for idle and locking of the screen.</p>
</div>
<div class="paragraph">
<p>This option to define the action to take when the system is idle is listed as:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>idle = swaylock</pre>
</div>
</div>
<div class="paragraph">
<p>And the lock timeout is configured using the following lines:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>[idle]
toggle = &lt;super&gt; KEY_Z
screensaver_timeout = 300
dpms_timeout = 600</pre>
</div>
</div>
<div class="paragraph">
<p>The first option will lock the screen after 300 seconds, and after another 300, the screen will shut off through the <code>dpms_timeout</code> option.</p>
</div>
<div class="paragraph">
<p>One final thing to note is the &lt;super&gt; key. Most of the configuration mentions this key, and it is the traditional <code>Windows</code> key on the keyboard. Most keyboards have this super key available; however, it should be remapped within this configuration file if it is not available. For example, to lock the screen, press and hold the super key, the <kbd>shift</kbd> key, and press the <kbd>escape</kbd> key. nless the mappings have changed, this will execute the swaylock application. The default configuration for <code>swaylock</code> will show a grey screen; however, the application is highly customizable and well documented. In addition, since the swaylock-effects is the version that was installed, there are several options available such as the blur effect, which can be seen using the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>swaylock --effect-blur 7x5</code></pre>
</div>
</div>
<div class="paragraph">
<p>There is also the <code>--clock</code> parameter which will display a clock with the date and time on the lock screen. When <a class="package" href="https://cgit.freebsd.org/ports/tree/x11/swaylock-effects/">x11/swaylock-effects</a> was installed, a default <span class="filename">pam.d</span> configuration was included. It provides the default options that should be fine for most users. More advanced options are available; see the PAM documentation for more information.</p>
</div>
<div class="paragraph">
<p>At this point, it is time to test Wayfire and see if it can start up on the system. Just type the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>wayfire -c ~/.config/wayfire/wayfire.ini</code></pre>
</div>
</div>
<div class="paragraph">
<p>The compositor should now start and display a background image along with a menu bar at the top of the screen. Wayfire will attempt to list installed compatible applications for the desktop and present them in this drop-down menu; for example, if the XFCE-4 file manager is installed, it will show up in this drop-down menu. If a specific application is compatible and valuable enough for a keyboard shortcut, it may be mapped to a keyboard sequence using the <span class="filename">wayfire.ini</span> configuration file. Wayfire also has a configuration tool named Wayfire Config Manager. It is located in the drop-down menu bar but may also be started through a terminal by issuing the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>wcm</code></pre>
</div>
</div>
<div class="paragraph">
<p>Various Wayfire configuration options, including the composite special effects, maybe enabled, disabled, or configured through this application. In addition, for a more user-friendly experience, a background manager, panel, and docking application may be enabled in the configuration file:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>panel = wf-panel
dock = wf-dock
background = wf-background</pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Changes made through <code>wcm</code> will overwrite custom changes in the <span class="filename">wayfire.ini</span> configuration file. The <span class="filename">wayfire.ini</span> file is highly recommended to be backed up so any essential changes may be restored.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Finally, the default launcher listed in the <span class="filename">wayfire.ini</span> is <a class="package" href="https://cgit.freebsd.org/ports/tree/x11/wf-shell/">x11/wf-shell</a> which may be replaced with other panels if desired by the user.</p>
</div>
</div>
<div class="sect2">
<h3 id="wayland-hikari">6.3. The Hikari Compositor<a class="anchor" href="#wayland-hikari"></a></h3>
<div class="paragraph">
<p>The Hikari compositor uses several concepts centered around productivity, such as sheets, workspaces, and more. In that way, it resembles a tiling window manager. Breaking this down, the compositor starts with a single workspace, which is similar to virtual desktops. Hikari uses a single workspace or virtual desktop for user interaction. The workspace is made up of several views, which are the working windows in the compositor grouped as either sheets or groups. Both sheets and groups are made up of a collection of views; again, the windows that are grouped together. When switching between sheets or groups, the active sheet or group will become known collectively as the workspace. The manual page will break this down into more information on the functions of each but for this document, just consider a single workspace utilizing a single sheet. Hikari installation will comprise of a single package, <a class="package" href="https://cgit.freebsd.org/ports/tree/x11-wm/hikari/">x11-wm/hikari</a>, and a terminal emulator <code>alacritty</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install hikari alacritty</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Other shells, such as <code>kitty</code> or the Plasma <code>Terminal</code>, will function under Wayland. Users should experiment with their favorite terminal editor to validate compatibility.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Hikari uses a configuration file, <span class="filename">hikari.conf</span>, which could either be placed in the XDG_RUNTIME_DIR or specified on startup using the <code>-c</code> parameter. An autostart configuration file is not required but may make the migration to this compositor a little easier. Beginning the configuration is to create the Hikari configuration directory and copy over the configuration file for editing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>mkdir ~/.config/hikari
<span class="gp">% </span>cp /usr/local/etc/hikari/hikari.conf ~/.config/hikari</code></pre>
</div>
</div>
<div class="paragraph">
<p>The configuration is broken out into various stanzas such as ui, outputs, layouts, and more. For most users, the defaults will function fine; however, some important changes should be made. For example, the $TERMINAL variable is normally not set within the user’s environment. Changing this variable or altering the <span class="filename">hikari.conf</span> file to read:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>terminal = &#34;/usr/local/bin/alacritty&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>Will launch the <code>alacritty</code> terminal using the bound key press. While going through the configuration file, it should be noted that the capital letters are used to map keys out for the user. For example, the <kbd>L</kbd> key for starting the terminal <span class="keyseq"><kbd>L</kbd>+<kbd>Return</kbd></span> is actually the previously discussed super key or Windows logo key. Therefore, holding the <kbd>L/super/Windows</kbd> key and pressing <kbd>Enter</kbd> will open the specified terminal emulator with the default configuration. Mapping other keys to applications require an action definition to be created. For this, the action item should be listed in the actions stanza, for example:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>actions {
  terminal = &#34;/usr/local/bin/alacritty&#34;
  browser = &#34;/usr/local/bin/firefox&#34;
}</pre>
</div>
</div>
<div class="paragraph">
<p>Then an action may be mapped under the keyboard stanza, which is defined within the bindings stanza:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>bindings {
  keyboard {
SNIP
    &#34;L+Return&#34; = action-terminal
    &#34;L+b&#34; = action-browser
SNIP</pre>
</div>
</div>
<div class="paragraph">
<p>After Hikari is restarted, holding the Windows logo button and pressing the <kbd>b</kbd> key on the keyboard will start the web browser. The compositor does not have a menu bar, and it is recommended the user set up, at minimal, a terminal emulator before migration. The manual page contains a great deal of documentation it should be read before performing a full migration. Another positive aspect about Hikari is that, while migrating to the compositor, Hikari can be started in the Plasma and GNOME desktop environments, allowing for a test-drive before completely migrating.</p>
</div>
<div class="paragraph">
<p>Locking the screen in Hikari is easy because a default <span class="filename">pam.d</span> configuration file and unlock utility are bundled with the package. The key binding for locking the screen is <kbd>L</kbd> (Windows logo key)+ <kbd>Shift</kbd> + <kbd>Backspace</kbd>. It should be noted that all views not marked public will be hidden. These views will never accept input when locked but beware of sensitive information being visible. For some users, it may be easier to migrate to a different screen locking utility such as swaylock-effects, discussed in this section. To start Hikari, use the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>hikari -c ~/.config/hikari/hikari.conf</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="wayland-sway">6.4. The Sway Compositor<a class="anchor" href="#wayland-sway"></a></h3>
<div class="paragraph">
<p>The Sway compositor is a tiling compositor that attempts to replace the i3 windows manager. It should work with the user’s current i3 configuration; however, new features may require some additional setup. In the forthcoming examples, a fresh installation without migrating any i3 configuration will be assumed. To install Sway and valuable components, issue the following command as the root user:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install sway swayidle swaylock-effects alacritty dmenu-wayland dmenu</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For a basic configuration file, issue the following commands and then edit the configuration file after it is copied:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>mkdir ~/.config/sway
<span class="gp">% </span>cp /usr/local/etc/sway/config ~/.config/sway</code></pre>
</div>
</div>
<div class="paragraph">
<p>The base configuration file has many defaults, which will be fine for most users. Several important changes should be made like the following:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre># Logo key. Use Mod1 for Alt.
input * xkb_rules evdev
set $mod Mod4
# Your preferred terminal emulator
set $term alacritty
set $lock swaylock -f -c 000000
output &#34;My Workstation&#34; mode 1366x786@60Hz position 1366 0
output * bg ~/wallpapers/mywallpaper.png stretch
### Idle configuration
exec swayidle -w \
          timeout 300 &#39;swaylock -f -c 000000&#39; \
          timeout 600 &#39;swaymsg &#34;output * dpms off&#34;&#39; resume &#39;swaymsg &#34;output * dpms on&#34;&#39; \
          before-sleep &#39;swaylock -f -c 000000&#39;</pre>
</div>
</div>
<div class="paragraph">
<p>In the previous example, the <code>xkb</code> rules for <a href="https://man.freebsd.org/cgi/man.cgi?query=evdev&amp;sektion=4&amp;format=html">evdev(4)</a> events are loaded, and the $mod key is set to the Windows logo key for the key bindings. Next, the terminal emulator was set to be <code>alacritty</code>, and a screen lock command was defined; more on this later. The output keyword, the mode, the position, a background wallpaper, and Sway is also told to stretch this wallpaper to fill out the screen. Finally, <code>swaylock</code> is set to daemonize and lock the screen after a timeout of 300 seconds, placing the screen or monitor into sleep mode after 600 seconds. The locked background color of 000000, which is black, is also defined here. Using swaylock-effects, a clock may also be displayed with the <code>--clock</code> parameter. See the manual page for more options. The <a href="https://man.freebsd.org/cgi/man.cgi?query=sway-output&amp;sektion=5&amp;format=html">sway-output(5)</a> manual page should also be reviewed; it includes a great deal of information on customing the output options available.</p>
</div>
<div class="paragraph">
<p>While in Sway, to bring up a menu of applications, hold the Windows logo key (mod) and press the <kbd>d</kbd> key. The menu may be navigated using the arrow keys on the keyboard. There is also a method to manipulate the layout of the bar and add a tray; read the <a href="https://man.freebsd.org/cgi/man.cgi?query=sway-bar&amp;sektion=5&amp;format=html">sway-bar(5)</a> manual page for more information. The default configuration adds a date and time to the upper right-hand corner. See the <code>Bar</code> stanza in the configuration file for an example. By default, the configuration does not include locking the screen outside of the example above, enabling a lockout timer. Creating a lock key binding requires the following line to the <code>Key bindings</code> section:</p>
</div>
<div class="literalblock programlising">
<div class="content">
<pre># Lock the screen manually
bindsym $mod+Shift+Return exec $lock</pre>
</div>
</div>
<div class="paragraph">
<p>Now the screen may be locked using the combination of holding the Windows logo key, pressing and holding shift, and finally pressing return. When Sway is installed, whether from a package or the FreeBSD Ports Collection, a default file for <span class="filename">pam.d</span> was installed. The default configuration should be acceptable for most users, but more advanced options are available. Read through the PAM documentation for more information.</p>
</div>
<div class="paragraph">
<p>Finally, to exit Sway and return to the shell, hold the Windows logo key, the shift key, and press the <kbd>e</kbd> key. A prompt will be displayed with an option to exit Sway. During migration, Sway can be started through a terminal emulator on an X11 desktop such as Plasma. This makes testing different changes and key bindings a little easier prior to fully migrating to this compositor. To start Sway, issue the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>sway -c ~/.config/sway/config</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="wayland-xwayland">6.5. Using Xwayland<a class="anchor" href="#wayland-xwayland"></a></h3>
<div class="paragraph">
<p>When installing Wayland, the <code>Xwayland</code> binary should have been installed unless Wayland was built without X11 support. If the <span class="filename">/usr/local/bin/Xwayland</span> file does not exist, install it using the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install xwayland-devel</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The development version of Xwayland is recommended and was most likely installed with the Wayland package. Each compositor has a method of enabling or disabling this feature.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Once <code>Xwayland</code> has been installed, configure it within the chosen compositor. For Wayfire, the following line is required in the <span class="filename">wayfire.ini</span> file:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>xwayland = true</pre>
</div>
</div>
<div class="paragraph">
<p>For the Sway compositor, <code>Xwayland</code> should be enabled by default. Even so, it is recommened to manually add a configuration line in the <span class="filename">~/.config/sway/config</span> like the following:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>xwayland enable</pre>
</div>
</div>
<div class="paragraph">
<p>Finally, for Hikari, no changes are needed. Support for <code>Xwayland</code> is build in by default. To disable that support, rebuild the package from the ports collection and disable Xwayland support at that time.</p>
</div>
<div class="paragraph">
<p>After these changes are made, start the compositor at the command line and execute a terminal from the key bindings. Within this terminal, issue the <code>env</code> command and search for the <code>DISPLAY</code> variables. If the compositor was able to properly start the Xwayland X server, these environment variables should look similar to the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>env | grep DISPLAY</code></pre>
</div>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>WAYLAND_DISPLAY=wayland-1
DISPLAY=:0</pre>
</div>
</div>
<div class="paragraph">
<p>In this output, there is a default Wayland display and a display set for the Xwayland server. Another method to verify that <code>Xwayland</code> is functioning properly is to use install and test the small package:[x11/eyes] and check the output. If the <code>xeyes</code> application starts and the eyes follow the mouse pointer, Xwayland is functioning properly. If an error such as the following is displayed, something happened during the <code>Xwayland</code> intitialization and it may need reinstalled:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>Error: Cannot open display wayland-0</pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A security feature of Wayland is that, without running an X server, there is not another network listener. Once <code>Xwayland</code> is enabled, this security feature is no longer applicable to the system.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>For some compositors, such as Wayfire, <code>Xwayland</code> may not start properly. As such, <code>env</code> will show the following information for the <code>DISPLAY</code> environment variables:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>env | grep DISPLAY</code></pre>
</div>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>DISPLAY=wayland-1
WAYLAND_DISPLAY=wayland-1</pre>
</div>
</div>
<div class="paragraph">
<p>Even though <code>Xwayfire</code> was installed and configured, X11 applications will not start giving a display issue. To work around this, verify that there is already an instance of <code>Xwayland</code> using a UNIX socket through these two methods. First, check the output from <code>sockstat</code> and search for X11-unix:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>sockstat | grep x11</code></pre>
</div>
</div>
<div class="paragraph">
<p>There should be something similar to the following information:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>trhodes  Xwayland   2734  8  stream /tmp/.X11-unix/X0
trhodes  Xwayland   2734  9  stream /tmp/.X11-unix/X0
trhodes  Xwayland   2734  10 stream /tmp/.X11-unix/X0
trhodes  Xwayland   2734  27 stream /tmp/.X11-unix/X0_
trhodes  Xwayland   2734  28 stream /tmp/.X11-unix/X0</pre>
</div>
</div>
<div class="paragraph">
<p>This suggests the existence of an X11 socket. This can be further verified by attempting to execute <code>Xwayland</code> manually within a terminal emulator running under the compositor:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>Xwayland</code></pre>
</div>
</div>
<div class="paragraph">
<p>If an X11 socket is already available, the following error should be presented to the user:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>(EE)
Fatal server error:
(EE) Server is already active for display 0
	If this server is no longer running, remove /tmp/.X0-lock
	and start again.
(EE)</pre>
</div>
</div>
<div class="paragraph">
<p>Since there is an active X display available using display zero, the environment variable was just set improperly, to fix this, change the <code>DISPLAY</code> environment variable to <code>:0</code> and attempt to execute the application again. The following example uses <a class="package" href="https://cgit.freebsd.org/ports/tree/mail/claws-mail/">mail/claws-mail</a> as the application which needs the <code>Xwayland</code> service:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nb">export </span><span class="nv">DISPLAY</span><span class="o">=</span>:0</code></pre>
</div>
</div>
<div class="paragraph">
<p>After this change, the <a class="package" href="https://cgit.freebsd.org/ports/tree/mail/claws-mail/">mail/claws-mail</a> application should now start using <code>Xwayland</code> and function as expected.</p>
</div>
</div>
<div class="sect2">
<h3 id="wayland-remotedesktop">6.6. Remote Desktop Using VNC<a class="anchor" href="#wayland-remotedesktop"></a></h3>
<div class="paragraph">
<p>Earlier in this document it was noted that Wayland does not provide the same X server style access as Xorg provides. Instead, users are free to pick and choose a remote desktop protocol such as RDP or VNC. The FreeBSD Ports collection includes the <code>wayvnc</code>, which will support wlroots based compositors such as the ones discussed here. This application may be installed using:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install wayvnc</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Unlike some other packages, <code>wayvnc</code> does not come with a configuration file. Thankfully, the manual page documents the important options and they may be extrapolated into a simple configuration file:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>address=0.0.0.0
enable_auth=true
username=username
password=password
private_key_file=/path/to/key.pem
certificate_file=/path/to/cert.pem</pre>
</div>
</div>
<div class="paragraph">
<p>The key files will need to be generated, and it is highly recommended they be used for increased security of the connection. When invoked, wayvnc will search for the configuration file in <span class="filename">~/.config/wayvnc/config</span>. This could be overwritten using the <code>-C configuration_file</code> option when starting the server. Thus, to start the <code>wayvnc</code> server, issue the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>wayvnc -C ~/.config/wayvnc/config</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>At the time of this writing, there is no rc.d script to start <code>wayvnc</code> on system initialization. If that functionality is desired, a local startup file will need to be created. This is probably a feature request for the port maintainer.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect2">
<h3 id="wayland-ly">6.7. Wayland Login Manager<a class="anchor" href="#wayland-ly"></a></h3>
<div class="paragraph">
<p>While several login managers exist and are slowly migrating to Wayland, one option is the <a class="package" href="https://cgit.freebsd.org/ports/tree/x11/ly/">x11/ly</a> text user interface (TUI) manager. Needing minimal configuration, <code>ly</code> will start Sway, Wayfire, and others by presenting a login window on system initialization. To install <code>ly</code>, issue the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install ly</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>There will be some configuration hints presented, the import steps are to add the following lines to <span class="filename">/etc/gettytab</span>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Ly:\
  :lo=/usr/local/bin/ly:\
  :al=root:</pre>
</div>
</div>
<div class="paragraph">
<p>And then modify the ttyv1 line in <span class="filename">/etc/ttys</span> to match the following line:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>ttyv1 &#34;/usr/libexec/getty Ly&#34; xterm onifexists secure</pre>
</div>
</div>
<div class="paragraph">
<p>After a system reboot, a login should appear. To configure specific settings, such as language and edit <span class="filename">/usr/local/etc/ly/config.ini</span>. At minimal, this file should have the designated tty that was previously specified in <span class="filename">/etc/ttys</span>.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If setting ttyv0 up as the login terminal, it may be required to press the <kbd>alt</kbd> and <kbd>F1</kbd> keys to properly see the login window.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>When the login window appears, using the left and right arrows will swap through different, supported, window managers.</p>
</div>
</div>
<div class="sect2">
<h3 id="wayland-utilities">6.8. Useful Utilities<a class="anchor" href="#wayland-utilities"></a></h3>
<div class="paragraph">
<p>One useful Wayland utility which all compositors can make use of is the waybar. While Wayfire does come with a launch menu, an easy-to-use and fast taskbar is a good accessory for any compositor or desktop manager. A Wayland compatible taskbar that is fast and easy to configure is waybar. To install the package and a supporting audio control utility, issue the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install pavucontrol waybar</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To create the configuration directory and copy over a default configuration file, execute the following commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>mkdir ~/.config/waybar
<span class="gp">% </span>cp /usr/local/etc/xdg/waybar/config ~/.config/waybar</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>lavalauncher</code> utility provides a launch bar for various applications. There is no example configuration file provided with the package, so the following actions must be taken:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">mkdir ~/.config/lavalauncher</code></pre>
</div>
</div>
<div class="paragraph">
<p>An example configuration file that only includes Firefox, and is placed on the right, is below:</p>
</div>
<div class="literalblock programlising">
<div class="content">
<pre>global-settings {
	watch-config-file = true;
}

bar {
	output            = eDP-1;
	position          = bottom;
	background-colour = &#34;#202020&#34;;

	# Condition for the default configuration set.
	condition-resolution = wider-than-high;

	config {
		position = right;
	}

	button {
		image-path          =     /usr/local/lib/firefox/browser/chrome/icons/default/default48.png;
		command[mouse-left] =     /usr/local/bin/firefox;
	}
	button {
	  image-path           =   /usr/local/share/pixmaps/thunderbird.png;
	  command[mouse-left]  =   /usr/local/bin/thunderbird;
}</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="network">Chapter 7. Network<a class="anchor" href="#network"></a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="network-synopsis">7.1. Synopsis<a class="anchor" href="#network-synopsis"></a></h3>
<div class="paragraph">
<p>This chapter delves into the topic of network configuration and performance, showcasing the robust networking capabilities of the FreeBSD operating system. Whether working with wired or wireless networks, this chapter provides a comprehensive guide to configuring and optimizing network connectivity in FreeBSD.</p>
</div>
<div class="paragraph">
<p>Before diving into the details, it is beneficial for readers to have a basic understanding of networking concepts such as protocols, network interfaces, and addressing.</p>
</div>
<div class="paragraph">
<p>This chapter covers:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The ability to configure wired networks in FreeBSD, including network interface setup, addressing, and customization options.</p>
</li>
<li>
<p>The skills to configure wireless networks in FreeBSD, encompassing wireless network interface setup, security protocols, and troubleshooting techniques.</p>
</li>
<li>
<p>FreeBSD’s networking capabilities and its reputation for excellent network performance.</p>
</li>
<li>
<p>An understanding of various network services and protocols supported by FreeBSD, with configuration instructions for DNS, DHCP and more.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>More information about how to make advanced network configurations in <a href="./#advanced-networking">Advanced Networking</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="config-network-setup">7.2. Setting up the Network<a class="anchor" href="#config-network-setup"></a></h3>
<div class="paragraph">
<p>Setting up a wired or wireless connection is a common task for a FreeBSD user. This section will show how to identify the wired and wireless network adapters and how to configure them.</p>
</div>
<div class="paragraph">
<p>Before starting with the configuration it is necessary to know the following network data:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If the network has DHCP</p>
</li>
<li>
<p>If the network does not have DHCP, the static IP to be used</p>
</li>
<li>
<p>The netmask</p>
</li>
<li>
<p>The IP address of the default gateway</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The network connection may have been configured at installation time by <a href="https://man.freebsd.org/cgi/man.cgi?query=bsdinstall&amp;sektion=8&amp;format=html">bsdinstall(8)</a>.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="sect3">
<h4 id="config-identify-network-adapter">7.2.1. Identify Network Adapters<a class="anchor" href="#config-identify-network-adapter"></a></h4>
<div class="paragraph">
<p>FreeBSD supports a wide variety of network adapters for both wired and wireless networks. Check the Hardware Compatibility List for the used <a href="https://www.freebsd.org/releases/">FreeBSD release</a> to see if the network adapter is supported.</p>
</div>
<div class="paragraph">
<p>To get the network adapters used by our system execute the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>pciconf -lv | grep -A1 -B3 network</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should be similar to the following:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>em0@pci0:0:25:0:        class=0x020000 rev=0x03 hdr=0x00 vendor=0x8086 device=0x10f5 subvendor=0x17aa subdevice=0x20ee
    vendor     = &#39;Intel Corporation&#39; <i class="conum" data-value="1"></i><b>(1)</b>
    device     = &#39;82567LM Gigabit Network Connection&#39; <i class="conum" data-value="2"></i><b>(2)</b>
    class      = network
    subclass   = ethernet
--
iwn0@pci0:3:0:0:        class=0x028000 rev=0x00 hdr=0x00 vendor=0x8086 device=0x4237 subvendor=0x8086 subdevice=0x1211
    vendor     = &#39;Intel Corporation&#39; <i class="conum" data-value="1"></i><b>(1)</b>
    device     = &#39;PRO/Wireless 5100 AGN [Shiloh] Network Connection&#39; <i class="conum" data-value="2"></i><b>(2)</b>
    class      = networ</pre>
</div>
</div>
<div class="paragraph">
<p>The text before the &#39;@&#39; symbol is the name of the driver controlling the device. In this case these are <a href="https://man.freebsd.org/cgi/man.cgi?query=em&amp;sektion=4&amp;format=html">em(4)</a> and <a href="https://man.freebsd.org/cgi/man.cgi?query=iwn&amp;sektion=4&amp;format=html">iwn(4)</a>.</p>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Shows the name of the vendor</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Shows the name of the device</td>
</tr>
</tbody></table>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>It is only necessary to load the network interface card module if FreeBSD has not detected it correctly.</p>
</div>
<div class="paragraph">
<p>For example, to load the <a href="https://man.freebsd.org/cgi/man.cgi?query=alc&amp;sektion=4&amp;format=html">alc(4)</a> module, execute the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># kldload if_alc</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, to load the driver as a module at boot time, place the following line in <span class="filename">/boot/loader.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>if_alc_load=&#34;YES&#34;</pre>
</div>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="config-network-connection">7.3. Wired Networks<a class="anchor" href="#config-network-connection"></a></h3>
<div class="paragraph">
<p>Once the right driver is loaded the network adapter needs to be configured. FreeBSD uses the driver name followed by a unit number to name the network interface adapter. The unit number represents the order in which the adapter is detected at boot time, or is later discovered.</p>
</div>
<div class="paragraph">
<p>For example, <code>em0</code> is the first network interface card (NIC) on the system using the <a href="https://man.freebsd.org/cgi/man.cgi?query=em&amp;sektion=4&amp;format=html">em(4)</a> driver.</p>
</div>
<div class="paragraph">
<p>To display the network interface configuration, enter the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>ifconfig</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should be similar to the following:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>em0: flags=8863&lt;UP,BROADCAST,RUNNING,SIMPLEX,MULTICAST&gt; metric 0 mtu 1500
        options=481249b&lt;RXCSUM,TXCSUM,VLAN_MTU,VLAN_HWTAGGING,VLAN_HWCSUM,LRO,WOL_MAGIC,VLAN_HWFILTER,NOMAP&gt;
        ether 00:1f:16:0f:27:5a
        inet6 fe80::21f:16ff:fe0f:275a%em0 prefixlen 64 scopeid 0x1
        inet 192.168.1.19 netmask 0xffffff00 broadcast 192.168.1.255
        media: Ethernet autoselect (1000baseT &lt;full-duplex&gt;)
        status: active
        nd6 options=23&lt;PERFORMNUD,ACCEPT_RTADV,AUTO_LINKLOCAL&gt;
lo0: flags=8049&lt;UP,LOOPBACK,RUNNING,MULTICAST&gt; metric 0 mtu 16384
        options=680003&lt;RXCSUM,TXCSUM,LINKSTATE,RXCSUM_IPV6,TXCSUM_IPV6&gt;
        inet6 ::1 prefixlen 128
        inet6 fe80::1%lo0 prefixlen 64 scopeid 0x2
        inet 127.0.0.1 netmask 0xff000000
        groups: lo
        nd6 options=21&lt;PERFORMNUD,AUTO_LINKLOCAL&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>In this example, the following devices were displayed:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>em0</code>: The Ethernet interface.</p>
</li>
<li>
<p><code>lo0</code>: The loop interface is a software loopback mechanism which may be used for performance analysis, software testing, and/or local communication. More information in <a href="https://man.freebsd.org/cgi/man.cgi?query=lo&amp;sektion=4&amp;format=html">lo(4)</a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The example shows that <code>em0</code> is up and running.</p>
</div>
<div class="paragraph">
<p>The key indicators are:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>UP</code> means that the interface is configured and ready.</p>
</li>
<li>
<p>The interface has an IPv4 Internet (<code>inet</code>) address, <code>192.168.1.19</code>.</p>
</li>
<li>
<p>The interface has an IPv6 Internet (<code>inet6</code>) address, <code>fe80::21f:16ff:fe0f:275a%em0</code>.</p>
</li>
<li>
<p>It has a valid subnet mask (<code>netmask</code>), where <code>0xffffff00</code> is the same as <code>255.255.255.0</code>.</p>
</li>
<li>
<p>It has a valid broadcast address, <code>192.168.1.255</code>.</p>
</li>
<li>
<p>The MAC address of the interface (<code>ether</code>) is <code>00:1f:16:0f:27:5a</code>.</p>
</li>
<li>
<p>The physical media selection is on autoselection mode (<code>media: Ethernet autoselect (1000baseT &lt;full-duplex&gt;)</code>).</p>
</li>
<li>
<p>The status of the link (<code>status</code>) is <code>active</code>, indicating that the carrier signal is detected. For <code>em0</code>, the <code>status: no carrier</code> status is normal when an Ethernet cable is not plugged into the interface.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>If the <a href="https://man.freebsd.org/cgi/man.cgi?query=ifconfig&amp;sektion=8&amp;format=html">ifconfig(8)</a> output had shown something similar to the next output it would indicate the interface has not been configured:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>em0: flags=8822&lt;BROADCAST,SIMPLEX,MULTICAST&gt; metric 0 mtu 1500
        options=481249b&lt;RXCSUM,TXCSUM,VLAN_MTU,VLAN_HWTAGGING,VLAN_HWCSUM,LRO,WOL_MAGIC,VLAN_HWFILTER,NOMAP&gt;
        ether 00:1f:16:0f:27:5a
        media: Ethernet autoselect
        status: no carrier
        nd6 options=29&lt;PERFORMNUD,IFDISABLED,AUTO_LINKLOCAL&gt;</pre>
</div>
</div>
<div class="sect3">
<h4 id="config-static-ip-v4">7.3.1. Configuring Static IPv4 Address<a class="anchor" href="#config-static-ip-v4"></a></h4>
<div class="paragraph">
<p>This section provides a guide to configuring a static IPv4 address on a FreeBSD system.</p>
</div>
<div class="paragraph">
<p>The network interface card configuration can be performed from the command line with <a href="https://man.freebsd.org/cgi/man.cgi?query=ifconfig&amp;sektion=8&amp;format=html">ifconfig(8)</a> but will not persist after a reboot unless the configuration is also added to <span class="filename">/etc/rc.conf</span>.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If the network was configured during installation by <a href="https://man.freebsd.org/cgi/man.cgi?query=bsdinstall&amp;sektion=8&amp;format=html">bsdinstall(8)</a>, some entries for the network interface card (NICs) may be already present. Double check <span class="filename">/etc/rc.conf</span> before executing <a href="https://man.freebsd.org/cgi/man.cgi?query=sysrc&amp;sektion=8&amp;format=html">sysrc(8)</a>.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>The IP address can be set executing the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ifconfig em0 inet 192.168.1.150/24</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To make the change persist across reboots execute the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysrc ifconfig_em0=&#34;inet 192.168.1.150 netmask 255.255.255.0&#34;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Add the default router executing the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysrc defaultrouter=&#34;192.168.1.1&#34;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Add the DNS records to <span class="filename">/etc/resolv.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>nameserver 8.8.8.8
nameserver 8.8.4.4</pre>
</div>
</div>
<div class="paragraph">
<p>Then restart <code>netif</code> and <code>routing</code> executing the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># service netif restart &amp;&amp; service routing restart</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The connection can be tested using <a href="https://man.freebsd.org/cgi/man.cgi?query=ping&amp;sektion=8&amp;format=html">ping(8)</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>ping -c2 www.FreeBSD.org</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should be similar to the following:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>PING web.geo.FreeBSD.org (147.28.184.45): 56 data bytes
64 bytes from 147.28.184.45: icmp_seq=0 ttl=51 time=55.173 ms
64 bytes from 147.28.184.45: icmp_seq=1 ttl=51 time=53.093 ms

--- web.geo.FreeBSD.org ping statistics ---
2 packets transmitted, 2 packets received, 0.0% packet loss
round-trip min/avg/max/stddev = 53.093/54.133/55.173/1.040 ms</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="config-dynamic-ip-v4">7.3.2. Configuring Dynamic IPv4 Address<a class="anchor" href="#config-dynamic-ip-v4"></a></h4>
<div class="paragraph">
<p>If the network has a DHCP server, it is very easy to configure the network interface to use DHCP. FreeBSD uses <a href="https://man.freebsd.org/cgi/man.cgi?query=dhclient&amp;sektion=8&amp;format=html">dhclient(8)</a> as the DHCP client. <a href="https://man.freebsd.org/cgi/man.cgi?query=dhclient&amp;sektion=8&amp;format=html">dhclient(8)</a> will automatically provide the IP, the netmask and the default router.</p>
</div>
<div class="paragraph">
<p>To make the interface work with DHCP execute the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysrc ifconfig_em0=&#34;DHCP&#34;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><a href="https://man.freebsd.org/cgi/man.cgi?query=dhclient&amp;sektion=8&amp;format=html">dhclient(8)</a> can be used manually by running the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># dhclient em0</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should be similar to the following:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>DHCPREQUEST on em0 to 255.255.255.255 port 67
DHCPACK from 192.168.1.1
unknown dhcp option value 0x7d
bound to 192.168.1.19 -- renewal in 43200 seconds.</pre>
</div>
</div>
<div class="paragraph">
<p>In this way it can be verified that the address assignment using DHCP works correctly.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p><a href="https://man.freebsd.org/cgi/man.cgi?query=dhclient&amp;sektion=8&amp;format=html">dhclient(8)</a> client can be started in background. This can cause trouble with applications depending on a working network, but it will provide a faster startup in many cases.</p>
</div>
<div class="paragraph">
<p>To execute <a href="https://man.freebsd.org/cgi/man.cgi?query=dhclient&amp;sektion=8&amp;format=html">dhclient(8)</a> in background execute the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysrc background_dhclient=&#34;YES&#34;</span></code></pre>
</div>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Then restart <code>netif</code> executing the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># service netif restart</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The connection can be tested using <a href="https://man.freebsd.org/cgi/man.cgi?query=ping&amp;sektion=8&amp;format=html">ping(8)</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>ping -c2 www.FreeBSD.org</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should be similar to the following:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>PING web.geo.FreeBSD.org (147.28.184.45): 56 data bytes
64 bytes from 147.28.184.45: icmp_seq=0 ttl=51 time=55.173 ms
64 bytes from 147.28.184.45: icmp_seq=1 ttl=51 time=53.093 ms

--- web.geo.FreeBSD.org ping statistics ---
2 packets transmitted, 2 packets received, 0.0% packet loss
round-trip min/avg/max/stddev = 53.093/54.133/55.173/1.040 ms</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="network-ipv6">7.3.3. IPv6<a class="anchor" href="#network-ipv6"></a></h4>
<div class="paragraph">
<p>IPv6 is the new version of the well-known IP protocol, also known as IPv4.</p>
</div>
<div class="paragraph">
<p>IPv6 provides several advantages over IPv4 as well as many new features:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Its 128-bit address space allows for 340,282,366,920,938,463,463,374,607,431,768,211,456 addresses. This addresses the IPv4 address shortage and eventual IPv4 address exhaustion.</p>
</li>
<li>
<p>Routers only store network aggregation addresses in their routing tables, thus reducing the average space of a routing table to 8192 entries. This addresses the scalability issues associated with IPv4, which required every allocated block of IPv4 addresses to be exchanged between Internet routers, causing their routing tables to become too large to allow efficient routing.</p>
</li>
<li>
<p>Address autoconfiguration (<a href="http://www.ietf.org/rfc/rfc2462.txt">RFC2462</a>).</p>
</li>
<li>
<p>Mandatory multicast addresses.</p>
</li>
<li>
<p>Built-in IPsec (IP security).</p>
</li>
<li>
<p>Simplified header structure.</p>
</li>
<li>
<p>Support for mobile IP.</p>
</li>
<li>
<p>IPv6-to-IPv4 transition mechanisms.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>FreeBSD includes the <a href="http://www.kame.net/">KAME project</a> IPv6 reference implementation and comes with everything needed to use IPv6.</p>
</div>
<div class="paragraph">
<p>This section focuses on getting IPv6 configured and running.</p>
</div>
<div class="paragraph">
<p>There are three different types of IPv6 addresses:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Unicast</dt>
<dd>
<p>A packet sent to a unicast address arrives at the interface belonging to the address.</p>
</dd>
<dt class="hdlist1">Anycast</dt>
<dd>
<p>These addresses are syntactically indistinguishable from unicast addresses but they address a group of interfaces. The packet destined for an anycast address will arrive at the nearest router interface. Anycast addresses are only used by routers.</p>
</dd>
<dt class="hdlist1">Multicast</dt>
<dd>
<p>These addresses identify a group of interfaces. A packet destined for a multicast address will arrive at all interfaces belonging to the multicast group. The IPv4 broadcast address, usually <code>xxx.xxx.xxx.255</code>, is expressed by multicast addresses in IPv6.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>When reading an IPv6 address, the canonical form is represented as <code>x:x:x:x:x:x:x:x</code>, where each <code>x</code> represents a 16 bit hex value. An example is <code>FEBC:A574:382B:23C1:AA49:4592:4EFE:9982</code>.</p>
</div>
<div class="paragraph">
<p>Often, an address will have long substrings of all zeros. A <code>::</code> (double colon) can be used to replace one substring per address. Also, up to three leading <code>0</code>s per hex value can be omitted. For example, <code>fe80::1</code> corresponds to the canonical form <code>fe80:0000:0000:0000:0000:0000:0000:0001</code>.</p>
</div>
<div class="paragraph">
<p>A third form is to write the last 32 bits using the well known IPv4 notation. For example, <code>2002::10.0.0.1</code> corresponds to the hexadecimal canonical representation <code>2002:0000:0000:0000:0000:0000:0a00:0001</code>, which in turn is equivalent to <code>2002::a00:1</code>.</p>
</div>
<div class="paragraph">
<p>To view a FreeBSD system’s IPv6 address execute the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ifconfig</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should be similar to the following:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>em0: flags=8863&lt;UP,BROADCAST,RUNNING,SIMPLEX,MULTICAST&gt; metric 0 mtu 1500
        options=481249b&lt;RXCSUM,TXCSUM,VLAN_MTU,VLAN_HWTAGGING,VLAN_HWCSUM,LRO,WOL_MAGIC,VLAN_HWFILTER,NOMAP&gt;
        ether 00:1f:16:0f:27:5a
        inet 192.168.1.150 netmask 0xffffff00 broadcast 192.168.1.255
        inet6 fe80::21f:16ff:fe0f:275a%em0 prefixlen 64 scopeid 0x1
        media: Ethernet autoselect (1000baseT &lt;full-duplex&gt;)
        status: active
        nd6 options=23&lt;PERFORMNUD,ACCEPT_RTADV,AUTO_LINKLOCAL&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>In this example, the <code>em0</code> interface is using <code>fe80::21f:16ff:fe0f:275a%em0</code>, an auto-configured link-local address which was automatically generated from the MAC address.</p>
</div>
<div class="paragraph">
<p>Some IPv6 addresses are reserved. A list of reserved addresses can be checked in the following table:</p>
</div>
<table id="reservedip6" class="tableblock frame-none grid-all stretch">
<caption class="title">表 9. Example IPv6 Reserved Addresses</caption>
<colgroup>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">IPv6 address</th>
<th class="tableblock halign-left valign-top">Prefixlength (Bits)</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>::</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">128 bits</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">unspecified</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Equivalent to <code>0.0.0.0</code> in IPv4.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>::1</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">128 bits</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">loopback address</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Equivalent to <code>127.0.0.1</code> in IPv4.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>::00:xx:xx:xx:xx</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">96 bits</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">embedded IPv4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The lower 32 bits are the compatible IPv4 address.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>::ff:xx:xx:xx:xx</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">96 bits</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">IPv4 mapped IPv6 address</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The lower 32 bits are the IPv4 address for hosts which do not support IPv6.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>fe80::/10</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10 bits</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">link-local</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Equivalent to 169.254.0.0/16 in IPv4.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>fc00::/7</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">7 bits</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">unique-local</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unique local addresses are intended for local communication and are only routable within a set of cooperating sites.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ff00::</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">8 bits</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">multicast</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>2000::-3fff::</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3 bits</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">global unicast</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">All global unicast addresses are assigned from this pool. The first 3 bits are <code>001</code>.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>For further information on the structure of IPv6 addresses, refer to <a href="http://www.ietf.org/rfc/rfc3513.txt">RFC3513</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="config-static-ip-v6">7.3.4. Configuring Static IPv6 Address<a class="anchor" href="#config-static-ip-v6"></a></h4>
<div class="paragraph">
<p>To configure a FreeBSD system as an IPv6 client with a static IPv6 address it is necessary to set the IPv6 address.</p>
</div>
<div class="paragraph">
<p>Execute the following commands to meet the requirements:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysrc ifconfig_em0_ipv6=&#34;inet6 2001:db8:4672:6565:2026:5043:2d42:5344 prefixlen 64&#34;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To assign a default router, specify its address executing the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysrc ipv6_defaultrouter=&#34;2001:db8:4672:6565::1&#34;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="config-dynamic-ip-v6">7.3.5. Configuring Dynamic IPv6 Address<a class="anchor" href="#config-dynamic-ip-v6"></a></h4>
<div class="paragraph">
<p>If the network has a DHCP server, it is very easy to configure the network interface to use DHCP. <a href="https://man.freebsd.org/cgi/man.cgi?query=dhclient&amp;sektion=8&amp;format=html">dhclient(8)</a> will provide automatically the IP, the netmask and the default router.</p>
</div>
<div class="paragraph">
<p>To make the interface work with DHCP execute the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysrc ifconfig_em0_ipv6=&#34;inet6 accept_rtadv&#34;</span>
<span class="c"># sysrc rtsold_enable=&#34;YES&#34;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_router_advertisement_and_host_auto_configuration">7.3.6. Router Advertisement and Host Auto Configuration<a class="anchor" href="#_router_advertisement_and_host_auto_configuration"></a></h4>
<div class="paragraph">
<p>This section demonstrates how to setup <a href="https://man.freebsd.org/cgi/man.cgi?query=rtadvd&amp;sektion=8&amp;format=html">rtadvd(8)</a> on an IPv6 router to advertise the IPv6 network prefix and default route.</p>
</div>
<div class="paragraph">
<p>To enable <a href="https://man.freebsd.org/cgi/man.cgi?query=rtadvd&amp;sektion=8&amp;format=html">rtadvd(8)</a>, execute the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysrc rtadvd_enable=&#34;YES&#34;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>It is important to specify the interface on which to do IPv6 router advertisement. For example, to tell <a href="https://man.freebsd.org/cgi/man.cgi?query=rtadvd&amp;sektion=8&amp;format=html">rtadvd(8)</a> to use <code>em0</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysrc rtadvd_interfaces=&#34;em0&#34;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Next, create the configuration file, <span class="filename">/etc/rtadvd.conf</span> as seen in this example:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>em0:\
	:addrs#1:addr=&#34;2001:db8:1f11:246::&#34;:prefixlen#64:tc=ether:</pre>
</div>
</div>
<div class="paragraph">
<p>Replace <code>em0</code> with the interface to be used and <code>2001:db8:1f11:246::</code> with the prefix of the allocation.</p>
</div>
<div class="paragraph">
<p>For a dedicated <code>/64</code> subnet, nothing else needs to be changed. Otherwise, change the <code>prefixlen#</code> to the correct value.</p>
</div>
</div>
<div class="sect3">
<h4 id="_ipv6_and_ipv4_address_mapping">7.3.7. IPv6 and IPv4 Address mapping<a class="anchor" href="#_ipv6_and_ipv4_address_mapping"></a></h4>
<div class="paragraph">
<p>When IPv6 is enabled on a server, there may be a need to enable IPv4 mapped IPv6 address communication. This compatibility option allows for IPv4 addresses to be represented as IPv6 addresses. Permitting IPv6 applications to communicate with IPv4 and vice versa may be a security issue.</p>
</div>
<div class="paragraph">
<p>This option may not be required in most cases and is available only for compatibility. This option will allow IPv6-only applications to work with IPv4 in a dual stack environment. This is most useful for third party applications which may not support an IPv6-only environment.</p>
</div>
<div class="paragraph">
<p>To enable this feature execute the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysrc ipv6_ipv4mapping=&#34;YES&#34;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="network-wireless">7.4. Wireless Networks<a class="anchor" href="#network-wireless"></a></h3>
<div class="paragraph">
<p>Most wireless networks are based on the <a href="https://en.wikipedia.org/wiki/IEEE_802.11">IEEE® 802.11 standards</a>.</p>
</div>
<div class="paragraph">
<p>FreeBSD supports networks that operate using <a href="https://en.wikipedia.org/wiki/IEEE_802.11a-1999">802.11a</a>, <a href="https://en.wikipedia.org/wiki/IEEE_802.11b-1999">802.11b</a>, <a href="https://en.wikipedia.org/wiki/IEEE_802.11g-2003">802.11g</a> and <a href="https://en.wikipedia.org/wiki/IEEE_802.11n-2009">802.11n</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><a href="https://en.wikipedia.org/wiki/IEEE_802.11ac-2013">802.11ac</a> support on FreeBSD is currently under development.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>A basic wireless network consists of multiple stations communicating with radios that broadcast in either the 2.4GHz or 5GHz band, though this varies according to the locale and is also changing to enable communication in the 2.3GHz and 4.9GHz ranges.</p>
</div>
<div class="paragraph">
<p>There are three basic steps to configure a wireless network:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Scan and select an access point</p>
</li>
<li>
<p>Authenticate the station</p>
</li>
<li>
<p>Configure an IP address or use DHCP.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The following sections discuss each step.</p>
</div>
<div class="sect3">
<h4 id="network-wireless-quick-start">7.4.1. Quick Start to Connect to a Wireless Network<a class="anchor" href="#network-wireless-quick-start"></a></h4>
<div class="paragraph">
<p>Connecting FreeBSD to an existing wireless network is a very common situation.</p>
</div>
<div class="paragraph">
<p>This procedure shows the steps required:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The first step will be to obtain the SSID (Service Set Identifier) and PSK (Pre-Shared Key) for the wireless network from the network administrator.</p>
</li>
<li>
<p>The second step will be to add an entry for this network to <span class="filename">/etc/wpa_supplicant.conf</span>. If the file does not exist, create it:</p>
</li>
</ul>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>network={
 ssid=&#34;myssid&#34; <i class="conum" data-value="1"></i><b>(1)</b>
 psk=&#34;mypsk&#34; <i class="conum" data-value="2"></i><b>(2)</b>
}</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Is the SSID of the wireless network. Replace it with the name of the wireless network. &lt;.&gt; Is the PSK of the wireless network. Replace it with the password of the wireless network.
<div class="ulist">
<ul>
<li>
<p>The third step will be to add the network entry to configure the network on startup:</p>
</li>
</ul>
</div></td>
</tr>
</tbody></table>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysrc wlans_iwn0=&#34;wlan0&#34;</span>
<span class="c"># sysrc ifconfig_wlan0=&#34;WPA DHCP&#34;</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>And the last step will be the restart <code>netif</code> service executing the following command:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># service netif restart</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="basic-wireless-configuration">7.4.2. Basic Wireless Configuration<a class="anchor" href="#basic-wireless-configuration"></a></h4>
<div class="paragraph">
<p>The first step will be to configure the wireless network card to an interface. To find out what wireless network cards are in the system check the section <a href="#config-identify-network-adapter">Identify Network Adapters</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ifconfig wlan0 create wlandevice iwm0</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To make the change persist across reboots execute the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysrc wlans_iwn0=&#34;wlan0&#34;</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Since the regulatory situation is different in various parts of the world, it is necessary to correctly set the domains that apply to your location to have the correct information about what channels can be used.</p>
</div>
<div class="paragraph">
<p>The available region definitions can be found in <span class="filename">/etc/regdomain.xml</span>. To set the data at runtime, use <code>ifconfig</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ifconfig wlan0 regdomain etsi2 country AT</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To persist the settings, add it to <span class="filename">/etc/rc.conf</span>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysrc create_args_wlan0=&#34;country AT regdomain etsi2&#34;</span></code></pre>
</div>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect3">
<h4 id="scan-wireless-networks">7.4.3. Scan Wireless Networks<a class="anchor" href="#scan-wireless-networks"></a></h4>
<div class="paragraph">
<p>Available wireless networks can be scanned using <a href="https://man.freebsd.org/cgi/man.cgi?query=ifconfig&amp;sektion=8&amp;format=html">ifconfig(8)</a>.</p>
</div>
<div class="paragraph">
<p>To list the wireless networks execute the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ifconfig wlan0 up list scan</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should be similar to the following:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>SSID/MESH ID                      BSSID              CHAN RATE    S:N     INT CAPS
FreeBSD                           e8:d1:1b:1b:58:ae    1   54M  -47:-96   100 EP   RSN BSSLOAD HTCAP WPS WME
NetBSD                            d4:b9:2f:35:fe:08    1   54M  -80:-96   100 EP   RSN BSSLOAD HTCAP WPS WME
OpenBSD                           fc:40:09:c6:31:bd   36   54M  -94:-96   100 EPS  VHTPWRENV APCHANREP RSN WPS BSSLOAD HTCAP VHTCAP VHTOPMODE WME
GNU-Linux                         dc:f8:b9:a0:a8:e0   44   54M  -95:-96   100 EP   WPA RSN WPS HTCAP VHTCAP VHTOPMODE WME VHTPWRENV
Windows                           44:48:b9:b3:c3:ff   44   54M  -84:-96   100 EP   BSSLOAD VHTPWRENV HTCAP WME RSN VHTCAP VHTOPMODE WPS
MacOS                             46:48:b9:b3:c3:ff   44   54M  -84:-96   100 EP   BSSLOAD VHTPWRENV HTCAP WME RSN VHTCAP VHTOPMODE WPS</pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>SSID/MESH ID identifies the name of the network.</p>
</li>
<li>
<p>BSSID identifies the MAC address of the access point.</p>
</li>
<li>
<p>CAPS field identifies the type of each network and the capabilities of the stations operating there (see the definition of <code>list scan</code> in <a href="https://man.freebsd.org/cgi/man.cgi?query=ifconfig&amp;sektion=8&amp;format=html">ifconfig(8)</a> for more details).</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="wireless-authentication">7.4.4. Connection and Authentication to a Wireless Network<a class="anchor" href="#wireless-authentication"></a></h4>
<div class="paragraph">
<p>Once a wireless network has been selected from the list of scanned networks, it is necessary to perform the connection and the authentication. In the vast majority of wireless networks, authentication is done with a password configured in the router. Other schemes require cryptographic handshakes to be completed before data traffic can flow, either using pre-shared keys or secrets, or more complex schemes that involve backend services such as RADIUS.</p>
</div>
<div class="sect4">
<h5 id="authenticate-wpa2-wpa-personal">7.4.4.1. Authenticate with WPA2/WPA/Personal<a class="anchor" href="#authenticate-wpa2-wpa-personal"></a></h5>
<div class="paragraph">
<p>The authentication process in a wireless network is managed by <a href="https://man.freebsd.org/cgi/man.cgi?query=wpa_supplicant&amp;sektion=8&amp;format=html">wpa_supplicant(8)</a>.</p>
</div>
<div class="paragraph">
<p>The <a href="https://man.freebsd.org/cgi/man.cgi?query=wpa_supplicant&amp;sektion=8&amp;format=html">wpa_supplicant(8)</a> configuration will be made in the <span class="filename">/etc/wpa_supplicant.conf</span> file. For more information, see <a href="https://man.freebsd.org/cgi/man.cgi?query=wpa_supplicant.conf&amp;sektion=5&amp;format=html">wpa_supplicant.conf(5)</a>.</p>
</div>
<div class="paragraph">
<p>Once the scanning of the wireless networks has been carried out, a network has been chosen and have the password (PSK), that information will be added to the file <span class="filename">/etc/wpa_supplicant.conf</span> as in the following example:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>network={
        scan_ssid=1 <i class="conum" data-value="1"></i><b>(1)</b>
        ssid=&#34;FreeBSD&#34; <i class="conum" data-value="2"></i><b>(2)</b>
        psk=&#34;12345678&#34; <i class="conum" data-value="3"></i><b>(3)</b>
}</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>SSID scan technique. Only need to use this option if the network is hidden. &lt;.&gt; Network name. &lt;.&gt; Passwork of the wireless network.</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>The next step will be to configure the wireless connection in the file <span class="filename">/etc/rc.conf</span>.</p>
</div>
<div class="paragraph">
<p>To use a static address it will be necessary to execute the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysrc ifconfig_wlan0=&#34;inet 192.168.1.20 netmask 255.255.255.0&#34;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To use a dynamic address it will be necessary to execute the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ifconfig_wlan0=&#34;WPA DHCP&#34;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then restart the network executing the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># service netif restart</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>More information on how to perform more advanced methods of authentication can be obtained at <a href="./#network-advanced-wireless">Wireless Advanced Authentication</a>.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect4">
<h5 id="authenticate-open-networks">7.4.4.2. Authenticate with Open Networks<a class="anchor" href="#authenticate-open-networks"></a></h5>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>It is important that the user is <strong>very</strong> careful when connecting to open networks without any kind of authentication.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Once the wireless network scan is done and the SSID of the wireless network is selected, execute the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ifconfig wlan0 ssid SSID</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And then execute <a href="https://man.freebsd.org/cgi/man.cgi?query=dhclient&amp;sektion=8&amp;format=html">dhclient(8)</a> to get the address configured:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># dhclient wlan0</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_using_both_wired_and_wireless_connections">7.4.5. Using Both Wired and Wireless Connections<a class="anchor" href="#_using_both_wired_and_wireless_connections"></a></h4>
<div class="paragraph">
<p>A wired connection provides better performance and reliability, while a wireless connection provides flexibility and mobility. Laptop users typically want to roam seamlessly between the two types of connections.</p>
</div>
<div class="paragraph">
<p>On FreeBSD, it is possible to combine two or even more network interfaces together in a &#34;failover&#34; fashion. This type of configuration uses the most preferred and available connection from a group of network interfaces, and the operating system switches automatically when the link state changes.</p>
</div>
<div class="paragraph">
<p>Link aggregation and failover is covered in <a href="./#network-aggregation">Link Aggregation and Failover</a> and an example for using both wired and wireless connections is provided at <a href="./#networking-lagg-wired-and-wireless">Failover Mode Between Ethernet and Wireless Interfaces</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="hostname">7.5. Hostname<a class="anchor" href="#hostname"></a></h3>
<div class="paragraph">
<p>The hostname represents the fully qualified domain name (FQDN) of the host on the network.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If no hostname has been set for the host FreeBSD will assign the value <code>Amnesiac</code>.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="sect3">
<h4 id="get-hostname">7.5.1. Check The Current Hostname<a class="anchor" href="#get-hostname"></a></h4>
<div class="paragraph">
<p><a href="https://man.freebsd.org/cgi/man.cgi?query=hostname&amp;sektion=1&amp;format=html">hostname(1)</a> can be used to check the current hostname:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">$ </span>hostname</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should be similar to the following:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>freebsdhostname.example.com</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="change-hostname">7.5.2. Change Hostname<a class="anchor" href="#change-hostname"></a></h4>
<div class="paragraph">
<p>To change the hostname of the host and persist it across reboots execute the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysrc hostname=&#34;freebsdhostname.example.com&#34;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="dns">7.6. DNS<a class="anchor" href="#dns"></a></h3>
<div class="paragraph">
<p>The DNS could be understanded as a <a href="https://en.wikipedia.org/wiki/Telephone_directory">telephone directory</a> in which an IP is identified to a hostname and vice versa.</p>
</div>
<div class="paragraph">
<p>There are three files that handle how a FreeBSD system interact with the DNS. These three files are <a href="https://man.freebsd.org/cgi/man.cgi?query=hosts&amp;sektion=5&amp;format=html">hosts(5)</a>, <a href="https://man.freebsd.org/cgi/man.cgi?query=resolv.conf&amp;sektion=5&amp;format=html">resolv.conf(5)</a> and <a href="https://man.freebsd.org/cgi/man.cgi?query=nsswitch.conf&amp;sektion=5&amp;format=html">nsswitch.conf(5)</a></p>
</div>
<div class="paragraph">
<p>Unless otherwise stated in the <span class="filename">/etc/nsswitch.conf</span> file, FreeBSD will look at the addresses in the <span class="filename">/etc/hosts</span> file and then the DNS information in the <span class="filename">/etc/resolv.conf</span> file.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <a href="https://man.freebsd.org/cgi/man.cgi?query=nsswitch.conf&amp;sektion=5&amp;format=html">nsswitch.conf(5)</a> file specifies how the nsdispatch (name-service switch dispatcher) should operate.</p>
</div>
<div class="paragraph">
<p>By default, the hosts section of the <span class="filename">/etc/nsswitch.conf</span> file will be as follows:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>hosts: files dns</pre>
</div>
</div>
<div class="paragraph">
<p>For example, in case of using the <a href="https://man.freebsd.org/cgi/man.cgi?query=nscd&amp;sektion=8&amp;format=html">nscd(8)</a> service. The order of preference could be changed by leaving the line as follows:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>hosts: files cache dns</pre>
</div>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="sect3">
<h4 id="local-addresses">7.6.1. Local addresses<a class="anchor" href="#local-addresses"></a></h4>
<div class="paragraph">
<p>The <span class="filename">/etc/hosts</span> file is a simple text database who provide host name to IP address mappings. Entries for local computers connected via a LAN can be added to this file for simplistic naming purposes instead of setting up a DNS server. Additionally, <span class="filename">/etc/hosts</span> can be used to provide a local record of Internet names, reducing the need to query external DNS servers for commonly accessed names.</p>
</div>
<div class="paragraph">
<p>For example, in the case of having a local instance of <a class="package" href="https://cgit.freebsd.org/ports/tree/www/gitlab-ce/">www/gitlab-ce</a> in a local environment, it could be added as follows to the file <span class="filename">/etc/hosts</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>192.168.1.150 git.example.com git</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="configuring-nameserver">7.6.2. Configuring the Nameserver<a class="anchor" href="#configuring-nameserver"></a></h4>
<div class="paragraph">
<p>How a FreeBSD system accesses the Internet Domain Name System (DNS) is controlled by <a href="https://man.freebsd.org/cgi/man.cgi?query=resolv.conf&amp;sektion=5&amp;format=html">resolv.conf(5)</a>.</p>
</div>
<div class="paragraph">
<p>The most common entries to <span class="filename">/etc/resolv.conf</span> are:</p>
</div>
<table class="tableblock frame-none grid-all stretch informaltable">
<colgroup>
<col style="width: 50%;"/>
<col style="width: 50%;"/>
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>nameserver</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The IP address of a name server the resolver should query. The servers are queried in the order listed with a maximum of three.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>search</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Search list for hostname lookup. This is normally determined by the domain of the local hostname.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>domain</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The local domain name.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>A typical <span class="filename">/etc/resolv.conf</span> looks like this:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>search example.com
nameserver 147.11.1.11
nameserver 147.11.100.30</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Only one of the <code>search</code> and <code>domain</code> options should be used.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>When using DHCP, <a href="https://man.freebsd.org/cgi/man.cgi?query=dhclient&amp;sektion=8&amp;format=html">dhclient(8)</a> usually rewrites <span class="filename">/etc/resolv.conf</span> with information received from the DHCP server.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If the machine in which the configuration is being made is <strong>not</strong> a DNS server, <a href="https://man.freebsd.org/cgi/man.cgi?query=local-unbound&amp;sektion=8&amp;format=html">local-unbound(8)</a> can be used to improve DNS lookup performance.</p>
</div>
<div class="paragraph">
<p>To enable it at boot time execute the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysrc local_unbound_enable=&#34;YES&#34;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To start the <a href="https://man.freebsd.org/cgi/man.cgi?query=local-unbound&amp;sektion=8&amp;format=html">local-unbound(8)</a> service execute the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># service local_unbound start</span></code></pre>
</div>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="troubleshooting">7.7. Troubleshooting<a class="anchor" href="#troubleshooting"></a></h3>
<div class="paragraph">
<p>When troubleshooting hardware and software configurations, check the simple things first.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Is the network cable plugged in?</p>
</li>
<li>
<p>Are the network services properly configured?</p>
</li>
<li>
<p>Is the firewall configured correctly?</p>
</li>
<li>
<p>Is the NIC supported by FreeBSD?</p>
</li>
<li>
<p>Is the router working correctly?</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Before sending a bug report, always check the Hardware Notes in the <a href="https://www.freebsd.org/releases/">FreeBSD release page</a>, update the version of FreeBSD to the latest STABLE version, check the mailing list archives, and search the Internet.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="sect3">
<h4 id="wired-troubleshooting">7.7.1. Troubleshooting in Wired Networks<a class="anchor" href="#wired-troubleshooting"></a></h4>
<div class="paragraph">
<p>If the card works, yet performance is poor, read through <a href="https://man.freebsd.org/cgi/man.cgi?query=tuning&amp;sektion=7&amp;format=html">tuning(7)</a>. Also, check the network configuration as incorrect network settings can cause slow connections.</p>
</div>
<div class="paragraph">
<p><code>No route to host</code> messages occur if the system is unable to route a packet to the destination host. This can happen if no default route is specified or if a cable is unplugged. Check the output of <code>netstat -rn</code> and make sure there is a valid route to the host. If there is not, read <a href="./#network-routing">Gateways and Routes</a>.</p>
</div>
<div class="paragraph">
<p><code>ping: sendto: Permission denied</code> error messages are often caused by a misconfigured firewall. If a firewall is enabled on FreeBSD but no rules have been defined, the default policy is to deny all traffic, even <a href="https://man.freebsd.org/cgi/man.cgi?query=ping&amp;sektion=8&amp;format=html">ping(8)</a>. Refer to <a href="./#firewalls">Firewalls</a> for more information.</p>
</div>
</div>
<div class="sect3">
<h4 id="wireless-troubleshooting">7.7.2. Troubleshooting in Wireless Networks<a class="anchor" href="#wireless-troubleshooting"></a></h4>
<div class="paragraph">
<p>This section describes a number of steps to help troubleshoot common wireless networking problems.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If the access point is not listed when scanning, check that the configuration has not limited the wireless device to a limited set of channels.</p>
</li>
<li>
<p>If the device cannot associate with an access point, verify that the configuration matches the settings on the access point. This includes the authentication scheme and any security protocols. Simplify the configuration as much as possible. If using a security protocol such as WPA2 or WPA, configure the access point for open authentication and no security to see if traffic will pass.</p>
</li>
<li>
<p>Once the system can associate with the access point, diagnose the network configuration using tools like <a href="https://man.freebsd.org/cgi/man.cgi?query=ping&amp;sektion=8&amp;format=html">ping(8)</a>.</p>
</li>
<li>
<p>There are many lower-level debugging tools. Debugging messages can be enabled in the 802.11 protocol support layer using <a href="https://man.freebsd.org/cgi/man.cgi?query=wlandebug&amp;sektion=8&amp;format=html">wlandebug(8)</a>.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<h1 id="common-tasks" class="sect0">Part II: 常见任务<a class="anchor" href="#common-tasks"></a></h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>现在基础知识已经介绍完毕，本书的这一部分将讨论 FreeBSD 的一些常用功能。这些章节包括：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>介绍流行且实用的桌面应用程序：浏览器、办公工具、文档查看器等等。</p>
</li>
<li>
<p>介绍一些适用于 FreeBSD 的多媒体工具。</p>
</li>
<li>
<p>解释构建自定义 FreeBSD 内核以启用额外功能的过程。</p>
</li>
<li>
<p>详细描述桌面和网络连接打印机设置中的打印系统。</p>
</li>
<li>
<p>展示如何在 FreeBSD 系统上运行 Linux 应用程序。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>其中一些章节建议先阅读，这在每个章节开头的简介中有注明。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="desktop">Chapter 8. Desktop Environments<a class="anchor" href="#desktop"></a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="desktop-synopsis">8.1. Synopsis<a class="anchor" href="#desktop-synopsis"></a></h3>
<div class="paragraph">
<p>While FreeBSD is popular as a server for its performance and stability, it is also well suited for day-to-day use as a desktop. With over 36000 applications available in the FreeBSD ports tree, it is straightforward to build a customized desktop that can run a wide variety of desktop applications. This chapter demonstrates how to install popular desktop environments as well as desktop applications such as web browsers, productivity software, document viewers, and financial software.</p>
</div>
<div class="paragraph">
<p>Prerequisites:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Readers of this chapter should already understand how to install either the <a href="./#x11">X Window System</a> or <a href="./#wayland">Wayland</a> on FreeBSD.</p>
</li>
<li>
<p>Readers are instructed throughout this chapter to install official packages. Refer to the section on <a href="./#ports-using">using the ports collection</a> to build customized packages from ports.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="desktop-environments">8.2. Desktop Environments<a class="anchor" href="#desktop-environments"></a></h3>
<div class="paragraph">
<p>This section describes how to install and configure some popular desktop environments on a FreeBSD system. A desktop environment can range from a simple window manager to a complete suite of desktop applications.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">表 10. Supported desktop environments</caption>
<colgroup>
<col style="width: 33.3333%;"/>
<col style="width: 33.3333%;"/>
<col style="width: 33.3334%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">License</th>
<th class="tableblock halign-left valign-top">Package</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">KDE Plasma</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">GPL 2.0 or later</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">x11/kde5</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GNOME</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">GPL 2.0 or later</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">x11/gnome</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">XFCE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">GPL, LGPL, BSD</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">x11-wm/xfce4</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MATE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">GPL 2.0, LGPL 2.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">x11/mate</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cinnamon</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">GPL 2.0 or later</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">x11/cinnamon</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">LXQT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">GPL, LGPL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">x11-wm/lxqt</p></td>
</tr>
</tbody>
</table>
<div class="sect3">
<h4 id="kde-environment">8.2.1. KDE Plasma<a class="anchor" href="#kde-environment"></a></h4>
<div class="paragraph">
<p>KDE Plasma is an easy-to-use desktop environment. This desktop provides a suite of applications with a consistent look and feel, a standardized menu and toolbars, keybindings, color-schemes, internationalization, and a centralized, dialog-driven desktop configuration. More information on KDE can be found at the <a href="https://kde.org/">KDE homepage</a>. For FreeBSD-specific information, consult the <a href="https://freebsd.kde.org/">FreeBSD homepage at KDE</a>.</p>
</div>
<div class="sect4">
<h5 id="kde-meta-install">8.2.1.1. Install KDE Plasma meta package<a class="anchor" href="#kde-meta-install"></a></h5>
<div class="paragraph">
<p>To install the KDE Plasma meta package with KDE Frameworks, Plasma Desktop and Applications execute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install kde5</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="kde-minimal-install">8.2.1.2. Minimal KDE Plasma installation<a class="anchor" href="#kde-minimal-install"></a></h5>
<div class="paragraph">
<p>To install a minimal KDE Plasma execute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install plasma5-plasma</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This installation is <strong>really</strong> minimal. Konsole must be installed separately executing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install konsole</span></code></pre>
</div>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect4">
<h5 id="kde-configuration">8.2.1.3. Configure KDE Plasma<a class="anchor" href="#kde-configuration"></a></h5>
<div class="paragraph">
<p>KDE Plasma uses <a href="https://man.freebsd.org/cgi/man.cgi?query=dbus-daemon&amp;sektion=1&amp;format=html">dbus-daemon(1)</a> for a message bus and hardware abstraction. This application is automatically installed as a dependency of KDE Plasma.</p>
</div>
<div class="paragraph">
<p>Enable D-BUS service in <code>/etc/rc.conf</code> to start at system boot:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysrc dbus_enable=&#34;YES&#34;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To increase messages size execute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">sysctl net.local.stream.recvspace<span class="o">=</span>65536
sysctl net.local.stream.sendspace<span class="o">=</span>65536</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="kde-start">8.2.1.4. Start KDE Plasma<a class="anchor" href="#kde-start"></a></h5>
<div class="paragraph">
<p>The preferred KDE Plasma display manager is <a class="package" href="https://cgit.freebsd.org/ports/tree/x11/sddm/">x11/sddm</a>. To install <a class="package" href="https://cgit.freebsd.org/ports/tree/x11/sddm/">x11/sddm</a>, execute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install sddm</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Enable SDDM service in <code>/etc/rc.conf</code> to start at system boot:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysrc sddm_enable=&#34;YES&#34;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The keyboard language can be set in SDDM by running the following command (for Spanish, for example):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysrc sddm_lang=&#34;es_ES&#34;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A second method to start KDE Plasma is by manually invoking <a href="https://man.freebsd.org/cgi/man.cgi?query=startx&amp;sektion=1&amp;format=html">startx(1)</a>. For this to work, the following line is needed in ~/.xinitrc:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span><span class="nb">echo</span> <span class="s2">&#34;exec ck-launch-session startplasma-x11&#34;</span> &gt; ~/.xinitrc</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="gnome-environment">8.2.2. GNOME<a class="anchor" href="#gnome-environment"></a></h4>
<div class="paragraph">
<p>GNOME is a user-friendly desktop environment. It includes a panel for starting applications and displaying status, a desktop, a set of tools and applications, and a set of conventions that make it easy for applications to cooperate and be consistent with each other.</p>
</div>
<div class="sect4">
<h5 id="gnome-meta-install">8.2.2.1. Install GNOME meta package<a class="anchor" href="#gnome-meta-install"></a></h5>
<div class="paragraph">
<p>To install the GNOME meta package with GNOME Desktop and Applications, execute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install gnome</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="gnome-minimal-install">8.2.2.2. Minimal GNOME installation<a class="anchor" href="#gnome-minimal-install"></a></h5>
<div class="paragraph">
<p>To install the GNOME-lite meta package with a GNOME desktop slimmed down for only the basics, execute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install gnome-lite</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="gnome-configuration">8.2.2.3. Configure GNOME<a class="anchor" href="#gnome-configuration"></a></h5>
<div class="paragraph">
<p>GNOME requires <code>/proc</code> to be mounted. Add this line to <code>/etc/fstab</code> to mount this file system automatically during system startup:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre># Device                Mountpoint      FStype  Options         Dump    Pass#
proc                    /proc           procfs  rw              0       0</pre>
</div>
</div>
<div class="paragraph">
<p>GNOME uses <a href="https://man.freebsd.org/cgi/man.cgi?query=dbus-daemon&amp;sektion=1&amp;format=html">dbus-daemon(1)</a> for a message bus and hardware abstraction. This application is automatically installed as a dependency of GNOME.</p>
</div>
<div class="paragraph">
<p>Enable D-BUS service in <code>/etc/rc.conf</code> to start at system boot:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysrc dbus_enable=&#34;YES&#34;</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="gnome-start">8.2.2.4. Start GNOME<a class="anchor" href="#gnome-start"></a></h5>
<div class="paragraph">
<p>GNOME Display Manager is the preferred display manager for GNOME. GDM is installed as part of the GNOME package.</p>
</div>
<div class="paragraph">
<p>Enable GDM in <code>/etc/rc.conf</code> to start at system boot:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysrc gdm_enable=&#34;YES&#34;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A second method to start GNOME is by manually invoking <a href="https://man.freebsd.org/cgi/man.cgi?query=startx&amp;sektion=1&amp;format=html">startx(1)</a>. For this to work, the following line is needed in <code>~/.xinitrc</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span><span class="nb">echo</span> <span class="s2">&#34;exec gnome-session&#34;</span> &gt; ~/.xinitrc</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="xfce-environment">8.2.3. XFCE<a class="anchor" href="#xfce-environment"></a></h4>
<div class="paragraph">
<p>XFCE is a desktop environment based on the GTK+, lightweight and provides a simple, efficient, easy-to-use desktop. It is fully configurable, has a main panel with menus, applets, and application launchers, provides a file manager and sound manager, and is themeable. Since it is fast, light, and efficient, it is ideal for older or slower machines with memory limitations.</p>
</div>
<div class="sect4">
<h5 id="xfce-install">8.2.3.1. Install XFCE<a class="anchor" href="#xfce-install"></a></h5>
<div class="paragraph">
<p>To install the XFCE meta package, execute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install xfce</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="xfce-configuration">8.2.3.2. Configure XFCE<a class="anchor" href="#xfce-configuration"></a></h5>
<div class="paragraph">
<p>XFCE requires <code>/proc</code> to be mounted. Add this line to <code>/etc/fstab</code> to mount this file system automatically during system startup:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre># Device                Mountpoint      FStype  Options         Dump    Pass#
proc                    /proc           procfs  rw              0       0</pre>
</div>
</div>
<div class="paragraph">
<p>XFCE uses <a href="https://man.freebsd.org/cgi/man.cgi?query=dbus-daemon&amp;sektion=1&amp;format=html">dbus-daemon(1)</a> for a message bus and hardware abstraction. This application is automatically installed as a dependency of XFCE.</p>
</div>
<div class="paragraph">
<p>Enable D-BUS in <code>/etc/rc.conf</code> to start at system boot:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysrc dbus_enable=&#34;YES&#34;</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="xfce-start">8.2.3.3. Start XFCE<a class="anchor" href="#xfce-start"></a></h5>
<div class="paragraph">
<p><a class="package" href="https://cgit.freebsd.org/ports/tree/x11/lightdm/">x11/lightdm</a> is a display manager that supports different display technologies and is a good choice as it is very lightweight, requires little memory usage, and has fast performance.</p>
</div>
<div class="paragraph">
<p>To install it, execute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install lightdm lightdm-gtk-greeter</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Enable lightdm in <code>/etc/rc.conf</code> to start at system boot:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysrc lightdm_enable=&#34;YES&#34;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A second method to start XFCE is by manually invoking <a href="https://man.freebsd.org/cgi/man.cgi?query=startx&amp;sektion=1&amp;format=html">startx(1)</a>. For this to work, the following line is needed in <code>~/.xinitrc</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span><span class="nb">echo</span> <span class="s1">&#39;. /usr/local/etc/xdg/xfce4/xinitrc&#39;</span> &gt; ~/.xinitrc</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mate-environment">8.2.4. MATE<a class="anchor" href="#mate-environment"></a></h4>
<div class="paragraph">
<p>The MATE Desktop Environment is the continuation of GNOME 2. It provides an intuitive and attractive desktop environment using traditional metaphors.</p>
</div>
<div class="sect4">
<h5 id="mate-meta-install">8.2.4.1. Install MATE meta package<a class="anchor" href="#mate-meta-install"></a></h5>
<div class="paragraph">
<p>To install the MATE meta package that includes the MATE Desktop with some extra applications such as text editor, archiver manager, etc., execute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install mate</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="mate-minimal-install">8.2.4.2. Minimal MATE installation<a class="anchor" href="#mate-minimal-install"></a></h5>
<div class="paragraph">
<p>To install the MATE lite meta package with MATE desktop slimmed down for only the basics, execute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install mate-base</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="mate-configuration">8.2.4.3. Configure MATE<a class="anchor" href="#mate-configuration"></a></h5>
<div class="paragraph">
<p>MATE requires <code>/proc</code> to be mounted. Add this line to <code>/etc/fstab</code> to mount this file system automatically during system startup:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre># Device                Mountpoint      FStype  Options         Dump    Pass#
proc                    /proc           procfs  rw              0       0</pre>
</div>
</div>
<div class="paragraph">
<p>MATE uses <a href="https://man.freebsd.org/cgi/man.cgi?query=dbus-daemon&amp;sektion=1&amp;format=html">dbus-daemon(1)</a> for a message bus and hardware abstraction. This application is automatically installed as a dependency of MATE. Enable D-BUS in <code>/etc/rc.conf</code> to start at system boot:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysrc dbus_enable=&#34;YES&#34;</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="mate-start">8.2.4.4. Start MATE<a class="anchor" href="#mate-start"></a></h5>
<div class="paragraph">
<p><a class="package" href="https://cgit.freebsd.org/ports/tree/x11/lightdm/">x11/lightdm</a> is a display manager that supports different display technologies and is a good choice as it is very lightweight, requires little memory usage, and has fast performance.</p>
</div>
<div class="paragraph">
<p>To install it, execute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install lightdm lightdm-gtk-greeter</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Enable lightdm in <code>/etc/rc.conf</code> to start at system boot:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysrc lightdm_enable=&#34;YES&#34;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A second method to start MATE is by manually invoking <a href="https://man.freebsd.org/cgi/man.cgi?query=startx&amp;sektion=1&amp;format=html">startx(1)</a>. For this to work, the following line is needed in <code>~/.xinitrc</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span><span class="nb">echo</span> <span class="s2">&#34;exec ck-launch-session mate-session&#34;</span> &gt; ~/.xinitrc</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="cinnamon-environment">8.2.5. Cinnamon<a class="anchor" href="#cinnamon-environment"></a></h4>
<div class="paragraph">
<p>Cinnamon is a UNIX® desktop which provides advanced innovative features and a traditional user experience. The desktop layout is similar to Gnome 2. The underlying technology is forked from Gnome Shell. The emphasis is put on making users feel at home and providing them with an easy to use and comfortable desktop experience.</p>
</div>
<div class="sect4">
<h5 id="cinnamon-install">8.2.5.1. Install Cinnamon<a class="anchor" href="#cinnamon-install"></a></h5>
<div class="paragraph">
<p>To install the Cinnamon package, execute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install cinnamon</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="cinnamon-configuration">8.2.5.2. Configure Cinnamon<a class="anchor" href="#cinnamon-configuration"></a></h5>
<div class="paragraph">
<p>Cinnamon requires <code>/proc</code> to be mounted. Add this line to <code>/etc/fstab</code> to mount this file system automatically during system startup:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre># Device                Mountpoint      FStype  Options         Dump    Pass#
proc                    /proc           procfs  rw              0       0</pre>
</div>
</div>
<div class="paragraph">
<p>Cinnamon uses <a href="https://man.freebsd.org/cgi/man.cgi?query=dbus-daemon&amp;sektion=1&amp;format=html">dbus-daemon(1)</a> for a message bus and hardware abstraction. This application is automatically installed as a dependency of Cinnamon. Enable D-BUS in <code>/etc/rc.conf</code> to start at system boot:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysrc dbus_enable=&#34;YES&#34;</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="cinnamon-start">8.2.5.3. Start Cinnamon<a class="anchor" href="#cinnamon-start"></a></h5>
<div class="paragraph">
<p><a class="package" href="https://cgit.freebsd.org/ports/tree/x11/lightdm/">x11/lightdm</a> is a display manager that supports different display technologies and is a good choice as it is very lightweight, requires little memory usage, and has fast performance.</p>
</div>
<div class="paragraph">
<p>To install it execute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install lightdm lightdm-gtk-greeter</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Enable lightdm in <code>/etc/rc.conf</code> to start at system boot:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysrc lightdm_enable=&#34;YES&#34;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A second method to start Cinnamon is by manually invoking <a href="https://man.freebsd.org/cgi/man.cgi?query=startx&amp;sektion=1&amp;format=html">startx(1)</a>. For this to work, the following line is needed in <code>~/.xinitrc</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span><span class="nb">echo</span> <span class="s2">&#34;exec ck-launch-session cinnamon-session&#34;</span> &gt; ~/.xinitrc</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="lxqt-environment">8.2.6. LXQT<a class="anchor" href="#lxqt-environment"></a></h4>
<div class="paragraph">
<p>LXQt is an advanced, easy-to-use, and fast desktop environment based on Qt technologies. It has been tailored for users who value simplicity, speed, and an intuitive interface. Unlike most desktop environments, LXQt also works fine with less powerful machines.</p>
</div>
<div class="sect4">
<h5 id="lxqt-install">8.2.6.1. Install LXQT<a class="anchor" href="#lxqt-install"></a></h5>
<div class="paragraph">
<p>To install the LXQT meta package, execute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install lxqt</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="lxqt-configuration">8.2.6.2. Configure LXQT<a class="anchor" href="#lxqt-configuration"></a></h5>
<div class="paragraph">
<p>LXQT requires <code>/proc</code> to be mounted. Add this line to <code>/etc/fstab</code> to mount this file system automatically during system startup:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre># Device                Mountpoint      FStype  Options         Dump    Pass#
proc                    /proc           procfs  rw              0       0</pre>
</div>
</div>
<div class="paragraph">
<p>LXQT uses <a href="https://man.freebsd.org/cgi/man.cgi?query=dbus-daemon&amp;sektion=1&amp;format=html">dbus-daemon(1)</a> for a message bus and hardware abstraction. This application is automatically installed as a dependency of LXQT.</p>
</div>
<div class="paragraph">
<p>Enable D-BUS in <code>/etc/rc.conf</code> to start at system boot:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysrc dbus_enable=&#34;YES&#34;</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="lxqt-start">8.2.6.3. Start LXQT<a class="anchor" href="#lxqt-start"></a></h5>
<div class="paragraph">
<p>The preferred LXQT display manager is <a class="package" href="https://cgit.freebsd.org/ports/tree/x11/sddm/">x11/sddm</a>. To install <a class="package" href="https://cgit.freebsd.org/ports/tree/x11/sddm/">x11/sddm</a>, execute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install sddm</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Enable SDDM service in <code>/etc/rc.conf</code> to start at system boot:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysrc sddm_enable=&#34;YES&#34;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The keyboard language can be set in SDDM by running the following command (for example, for Spanish):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysrc sddm_lang=&#34;es_ES&#34;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A second method to start LXQT is by manually invoking <a href="https://man.freebsd.org/cgi/man.cgi?query=startx&amp;sektion=1&amp;format=html">startx(1)</a>. For this to work, the following line is needed in <code>~/.xinitrc</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span><span class="nb">echo</span> <span class="s2">&#34;exec ck-launch-session startlxqt&#34;</span> &gt; ~/.xinitrc</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="desktop-browsers">8.3. Browsers<a class="anchor" href="#desktop-browsers"></a></h3>
<div class="paragraph">
<p>This section describes how to install and configure some popular web browsers on a FreeBSD system, from full web browsers with high resource consumption to command line web browsers with reduced resource usage.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">表 11. Supported browsers</caption>
<colgroup>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">License</th>
<th class="tableblock halign-left valign-top">Package</th>
<th class="tableblock halign-left valign-top">Resources Needed</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Firefox</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MPL 2.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a class="package" href="https://cgit.freebsd.org/ports/tree/www/firefox/">www/firefox</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Heavy</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Chromium</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BSD-3 and others</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a class="package" href="https://cgit.freebsd.org/ports/tree/www/chromium/">www/chromium</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Heavy</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Iridium browser</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BSD-3 and others</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a class="package" href="https://cgit.freebsd.org/ports/tree/www/iridium-browser/">www/iridium-browser</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Heavy</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Falkon</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MPL 2.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a class="package" href="https://cgit.freebsd.org/ports/tree/www/falkon-qtonly/">www/falkon-qtonly</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Heavy</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Konqueror</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">GPL 2.0 or later</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a class="package" href="https://cgit.freebsd.org/ports/tree/x11-fm/konqueror/">x11-fm/konqueror</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Medium</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Gnome Web (Epiphany)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">GPL 3.0 or later</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a class="package" href="https://cgit.freebsd.org/ports/tree/www/epiphany/">www/epiphany</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Medium</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">qutebrowser</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">GPL 3.0 or later</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a class="package" href="https://cgit.freebsd.org/ports/tree/www/qutebrowser/">www/qutebrowser</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Medium</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Dillo</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">GPL 3.0 or later</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a class="package" href="https://cgit.freebsd.org/ports/tree/www/dillo/">www/dillo</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Light</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Links</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">GPL 2.0 or later</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a class="package" href="https://cgit.freebsd.org/ports/tree/www/links/">www/links</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Light</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">w3m</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MIT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a class="package" href="https://cgit.freebsd.org/ports/tree/www/w3m/">www/w3m</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Light</p></td>
</tr>
</tbody>
</table>
<div class="sect3">
<h4 id="firefox">8.3.1. Firefox<a class="anchor" href="#firefox"></a></h4>
<div class="paragraph">
<p>Firefox is an open source browser that features a standards-compliant HTML display engine, tabbed browsing, popup blocking, extensions, improved security, and more. Firefox is based on the Mozilla codebase.</p>
</div>
<div class="paragraph">
<p>To install the package of the latest release version of Firefox, execute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install firefox</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To instead install Firefox Extended Support Release (ESR) version, execute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install firefox-esr</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="chromium">8.3.2. Chromium<a class="anchor" href="#chromium"></a></h4>
<div class="paragraph">
<p>Chromium is an open source browser project that aims to build a safer, faster, and more stable web browsing experience. Chromium features tabbed browsing, popup blocking, extensions, and much more. Chromium is the open source project upon which the Google Chrome web browser is based.</p>
</div>
<div class="paragraph">
<p>To install Chromium, execute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install chromium</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The executable for Chromium is <span class="filename">/usr/local/bin/chrome</span>, not <span class="filename">/usr/local/bin/chromium</span>.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect3">
<h4 id="iridium">8.3.3. Iridium browser<a class="anchor" href="#iridium"></a></h4>
<div class="paragraph">
<p>Iridium is a free, open, and libre browser modification of the Chromium code base, with privacy being enhanced in several key areas. Automatic transmission of partial queries, keywords, metrics to central services is inhibited and only occurs with consent.</p>
</div>
<div class="paragraph">
<p>To install Iridium, execute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install iridium-browser</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="falkon">8.3.4. Falkon<a class="anchor" href="#falkon"></a></h4>
<div class="paragraph">
<p>Falkon is a new-ish and very fast QtWebEngine browser. It aims to be a lightweight web browser available on all major platforms. Falkon has all standard functions you expect from a web browser. It includes bookmarks, history (both also in sidebar) and tabs. Beyond that, you block ads with a builtin AdBlock plugin, block Flash content with Click2Flash and edit the local CA Certificates database with an SSL Manager.</p>
</div>
<div class="paragraph">
<p>To install Falkon, execute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install falkon</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="konqueror">8.3.5. Konqueror<a class="anchor" href="#konqueror"></a></h4>
<div class="paragraph">
<p>Konqueror is more than a web browser as it is also a file manager and a multimedia viewer. It supports WebKit, a rendering engine used by many modern browsers including Chromium, as well as its own KHTML engine.</p>
</div>
<div class="paragraph">
<p>To install Konqueror, execute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install konqueror</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="gnome-web-epiphany">8.3.6. Gnome Web (Epiphany)<a class="anchor" href="#gnome-web-epiphany"></a></h4>
<div class="paragraph">
<p>Gnome Web (Epiphany) is a web browser designed to be as lightweight and fast as possible, at the expense of many of the features found in other browsers.</p>
</div>
<div class="paragraph">
<p>To install Gnome Web (Epiphany), execute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install epiphany</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="qutebrowser">8.3.7. qutebrowser<a class="anchor" href="#qutebrowser"></a></h4>
<div class="paragraph">
<p>Qutebrowser is a keyboard-focused browser with a minimal GUI. It is based on Python and PyQt5 and free software, licensed under the GPL.</p>
</div>
<div class="paragraph">
<p>To install qutebrowser, execute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install qutebrowser</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="dillo">8.3.8. Dillo<a class="anchor" href="#dillo"></a></h4>
<div class="paragraph">
<p>Dillo aims to be a multiplatform alternative browser that is small, stable, developer-friendly, usable, fast, and extensible. This new, experimental version of Dillo is based upon FLTK toolkit, rather than GTK1, and has been substantially rewritten.</p>
</div>
<div class="paragraph">
<p>To install Dillo, execute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install dillo</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="links">8.3.9. Links<a class="anchor" href="#links"></a></h4>
<div class="paragraph">
<p>A lynx-like web browser with text and graphics modes with many features like displaying tables, menus, etc.</p>
</div>
<div class="paragraph">
<p>To install Links, execute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install links</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="w3m">8.3.10. w3m<a class="anchor" href="#w3m"></a></h4>
<div class="paragraph">
<p>w3m is a pager/text-based web browser. It is a similar application to Lynx, but it has several features Lynx doesn’t have like rendering tables and rendering frames.</p>
</div>
<div class="paragraph">
<p>To install w3m, execute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install w3m</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="desktop-development">8.4. Development tools<a class="anchor" href="#desktop-development"></a></h3>
<div class="paragraph">
<p>This section describes how to install and configure some popular development tools on a FreeBSD system.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">表 12. Supported development tools</caption>
<colgroup>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">License</th>
<th class="tableblock halign-left valign-top">Package</th>
<th class="tableblock halign-left valign-top">Resources Needed</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Visual Studio Code</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MIT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a class="package" href="https://cgit.freebsd.org/ports/tree/editors/vscode/">editors/vscode</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Heavy</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Qt Creator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">QtGPL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a class="package" href="https://cgit.freebsd.org/ports/tree/devel/qtcreator/">devel/qtcreator</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Heavy</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kdevelop</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">GPL 2.0 or later and LGPL 2.0 or later</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a class="package" href="https://cgit.freebsd.org/ports/tree/devel/kdevelop/">devel/kdevelop</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Heavy</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Eclipse IDE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">EPL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a class="package" href="https://cgit.freebsd.org/ports/tree/java/eclipse/">java/eclipse</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Heavy</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Vim</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">VIM</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a class="package" href="https://cgit.freebsd.org/ports/tree/editors/vim/">editors/vim</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Light</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Neovim</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Apache 2.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a class="package" href="https://cgit.freebsd.org/ports/tree/editors/neovim/">editors/neovim</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Light</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GNU Emacs</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">GPL 3.0 or later</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a class="package" href="https://cgit.freebsd.org/ports/tree/editors/emacs/">editors/emacs</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Light</p></td>
</tr>
</tbody>
</table>
<div class="sect3">
<h4 id="vs-code">8.4.1. Visual Studio Code<a class="anchor" href="#vs-code"></a></h4>
<div class="paragraph">
<p>Visual Studio Code is a type of tool that combines the simplicity of a code editor with what developers need for their core edit-build-debug cycle. It provides comprehensive editing and debugging support, an extensibility model, and lightweight integration with existing tools.</p>
</div>
<div class="paragraph">
<p>To install Visual Studio Code, execute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install vscode</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="qt-creator">8.4.2. Qt Creator<a class="anchor" href="#qt-creator"></a></h4>
<div class="paragraph">
<p>Qt Creator is a cross-platform IDE (integrated development environment) tailored to the needs of Qt developers. Functionalities included with Qt Creator are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>code editor with C++, QML and ECMAscript support;</p>
</li>
<li>
<p>rapid code navigation tools;</p>
</li>
<li>
<p>static code checking and style hints as you type;</p>
</li>
<li>
<p>context sensitive help;</p>
</li>
<li>
<p>visual debugger;</p>
</li>
<li>
<p>integrated GUI layout and forms designer.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To install Qt Creator, execute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install qtcreator</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="kdevelop">8.4.3. kdevelop<a class="anchor" href="#kdevelop"></a></h4>
<div class="paragraph">
<p>Open source, feature-full, plugin extensible IDE for C/C++ and other programming languages. It is based on KDevPlatform and the KDE and Qt libraries, and it has been under development since 1998.</p>
</div>
<div class="paragraph">
<p>To install kdevelop, execute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install kdevelop</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="eclipse">8.4.4. Eclipse IDE<a class="anchor" href="#eclipse"></a></h4>
<div class="paragraph">
<p>The Eclipse Platform is an open extensible IDE for anything and yet nothing in particular. The Eclipse Platform provides building blocks and a foundation for constructing and running integrated software-development tools. The Eclipse Platform allows tool builders to independently develop tools that integrate with other people’s tools.</p>
</div>
<div class="paragraph">
<p>To install Eclipse IDE, execute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install eclipse</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="vim">8.4.5. Vim<a class="anchor" href="#vim"></a></h4>
<div class="paragraph">
<p>Vim is a highly configurable text editor built to enable efficient text editing. It is an improved version of the vi editor distributed with most UNIX systems.</p>
</div>
<div class="paragraph">
<p>Vim is often called a &#34;programmer’s editor,&#34; and so useful for programming that many consider it an entire IDE. It’s not just for programmers, though. Vim is perfect for all kinds of text editing, from composing email to editing configuration files.</p>
</div>
<div class="paragraph">
<p>To install Vim, execute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install vim</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="neovim">8.4.6. Neovim<a class="anchor" href="#neovim"></a></h4>
<div class="paragraph">
<p>Neovim is an aggressive refactor of <a class="package" href="https://cgit.freebsd.org/ports/tree/editors/vim/">editors/vim</a>. It represents a complete overhaul of the codebase with many sanity improvements, including sensible defaults, a built-in terminal emulator, asynchronous plugin architecture, and powerful APIs designed for speed and extensibility. It retains full compatibility with almost all Vim plugins and scripts.</p>
</div>
<div class="paragraph">
<p>To install Neovim, execute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install neovim</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="gnu-emacs">8.4.7. GNU Emacs<a class="anchor" href="#gnu-emacs"></a></h4>
<div class="paragraph">
<p>GNU Emacs is an extensible, customizable, free/libre text editor. At its core is an interpreter for Emacs Lisp, a dialect of the Lisp programming language with extensions to support text editing.</p>
</div>
<div class="paragraph">
<p>To install GNU Emacs, execute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install emacs</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="desktop-productivity">8.5. Desktop office productivity<a class="anchor" href="#desktop-productivity"></a></h3>
<div class="paragraph">
<p>When it comes to productivity, users often look for an office suite or an easy-to-use word processor. While some desktop environments like <a href="#kde-environment">KDE Plasma</a> provide an office suite, there is no default productivity package. Several office suites and graphical word processors are available for FreeBSD, regardless of the installed desktop environments.</p>
</div>
<div class="paragraph">
<p>This section demonstrates how to install the following popular productivity software and indicates if the application is resource-heavy, takes time to compile from ports, or has any major dependencies.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">表 13. Supported Desktop office productivity suites</caption>
<colgroup>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">License</th>
<th class="tableblock halign-left valign-top">Package</th>
<th class="tableblock halign-left valign-top">Resources Needed</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">LibreOffice</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MPL 2.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a class="package" href="https://cgit.freebsd.org/ports/tree/editors/libreoffice/">editors/libreoffice</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Heavy</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Calligra Suite</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">LGPL and GPL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a class="package" href="https://cgit.freebsd.org/ports/tree/editors/calligra/">editors/calligra</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Medium</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">AbiWord</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">GPL 2.0 or later</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a class="package" href="https://cgit.freebsd.org/ports/tree/editors/abiword/">editors/abiword</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Medium</p></td>
</tr>
</tbody>
</table>
<div class="sect3">
<h4 id="libreoffice">8.5.1. LibreOffice<a class="anchor" href="#libreoffice"></a></h4>
<div class="paragraph">
<p>LibreOffice is a free software office suite developed by <a href="http://www.documentfoundation.org/">The Document Foundation</a>. It is compatible with other major office suites and available on a variety of platforms. It is a rebranded fork of Apache OpenOffice and includes applications found in a complete office productivity suite: a word processor, spreadsheet, presentation manager, drawing program, database management program, and a tool for creating and editing mathematical formulæ. It is available in a number of different languages and internationalization has been extended to interfaces, spell checkers, and dictionaries. More information about LibreOffice can be found at <a href="http://www.libreoffice.org/">libreoffice.org</a>.</p>
</div>
<div class="paragraph">
<p>To install LibreOffice, execute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install libreoffice</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The LibreOffice package comes by default only in English. To have a localized version of LibreOffice it is necessary to install a language pack. For example, for the version localized in Spanish, it is necessary to install the package <a class="package" href="https://cgit.freebsd.org/ports/tree/editors/libreoffice-es/">editors/libreoffice-es</a> with the command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install libreoffice-es</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="calligra">8.5.2. Calligra<a class="anchor" href="#calligra"></a></h4>
<div class="paragraph">
<p>The KDE Plasma desktop environment includes an office suite which can be installed separately from KDE Plasma. Calligra includes standard components that can be found in other office suites. Words is the word processor, Sheets is the spreadsheet program, Stage manages slide presentations, and Karbon is used to draw graphical documents.</p>
</div>
<div class="paragraph">
<p>To install Calligra, execute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install calligra</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="abiword">8.5.3. AbiWord<a class="anchor" href="#abiword"></a></h4>
<div class="paragraph">
<p>AbiWord is a free word processing program similar in look and feel to Microsoft® Word. It is fast, contains many features, and is user-friendly.</p>
</div>
<div class="paragraph">
<p>AbiWord can import or export many file formats, including some proprietary ones like Microsoft® <span class="filename">.rtf</span>.</p>
</div>
<div class="paragraph">
<p>To install AbiWord, execute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install abiword</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="desktop-viewers">8.6. Document Viewers<a class="anchor" href="#desktop-viewers"></a></h3>
<div class="paragraph">
<p>Some new document formats have gained popularity since the advent of UNIX® and the viewers they require may not be available in the base system. This section demonstrates how to install the following document viewers:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">表 14. Supported Document Viewers</caption>
<colgroup>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">License</th>
<th class="tableblock halign-left valign-top">Package</th>
<th class="tableblock halign-left valign-top">Resources Needed</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Okular</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">GPL 2.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a class="package" href="https://cgit.freebsd.org/ports/tree/graphics/okular/">graphics/okular</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Heavy</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Evince</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">GPL 2.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a class="package" href="https://cgit.freebsd.org/ports/tree/graphics/evince/">graphics/evince</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Medium</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ePDFView</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">GPL 2.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a class="package" href="https://cgit.freebsd.org/ports/tree/graphics/epdfview/">graphics/epdfview</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Medium</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Xpdf</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">GPL 2.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a class="package" href="https://cgit.freebsd.org/ports/tree/graphics/xpdf/">graphics/xpdf</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">light</p></td>
</tr>
</tbody>
</table>
<div class="sect3">
<h4 id="okular">8.6.1. Okular<a class="anchor" href="#okular"></a></h4>
<div class="paragraph">
<p>Okular is a universal document viewer, part of the KDE Plasma project.</p>
</div>
<div class="paragraph">
<p>Okular combines excellent functionality with the versatility of supporting different kind of documents, like PDF, Postscript, DjVu, CHM, XPS, ePub and others.</p>
</div>
<div class="paragraph">
<p>To install Okular, execute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install okular</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="evince">8.6.2. Evince<a class="anchor" href="#evince"></a></h4>
<div class="paragraph">
<p>Evince is a document viewer for multiple document formats including PDF and Postscript. Part of the GNOME project. The goal of evince is to replace document viewers such as ggv and gpdf with a single, simple application.</p>
</div>
<div class="paragraph">
<p>To install Evince, execute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install evince</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="epdfview">8.6.3. ePDFView<a class="anchor" href="#epdfview"></a></h4>
<div class="paragraph">
<p>ePDFView is a lightweight PDF document viewer that only uses the Gtk+ and Poppler libraries. The aim of ePDFView is to make a simple PDF document viewer, similar to Evince but without using the GNOME libraries.</p>
</div>
<div class="paragraph">
<p>To install ePDFView, execute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install epdfview</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="xpdf">8.6.4. Xpdf<a class="anchor" href="#xpdf"></a></h4>
<div class="paragraph">
<p>For users that prefer a small FreeBSD PDF viewer, Xpdf provides a light-weight and efficient viewer which requires few resources. It uses the standard X fonts and does not require any additional toolkits.</p>
</div>
<div class="paragraph">
<p>To install Xpdf, execute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install xpdf</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="desktop-finance">8.7. Finance<a class="anchor" href="#desktop-finance"></a></h3>
<div class="paragraph">
<p>For managing personal finances on a FreeBSD desktop, some powerful and easy-to-use applications can be installed. Some are compatible with widespread file formats, such as the formats used by Quicken and Excel.</p>
</div>
<div class="paragraph">
<p>This section covers these programs:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">表 15. Supported Finance programs</caption>
<colgroup>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">License</th>
<th class="tableblock halign-left valign-top">Package</th>
<th class="tableblock halign-left valign-top">Resources Needed</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">KMyMoney</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">GPL 2.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a class="package" href="https://cgit.freebsd.org/ports/tree/finance/kmymoney/">finance/kmymoney</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Heavy</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GnuCash</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">GPL 2.0 and GPL 3.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a class="package" href="https://cgit.freebsd.org/ports/tree/finance/gnucash/">finance/gnucash</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Heavy</p></td>
</tr>
</tbody>
</table>
<div class="sect3">
<h4 id="kmymoney">8.7.1. KMyMoney<a class="anchor" href="#kmymoney"></a></h4>
<div class="paragraph">
<p>KMyMoney is a personal finance application created by the KDE community. KMyMoney aims to provide the important features found in commercial personal finance manager applications. It also highlights ease-of-use and proper double-entry accounting among its features. KMyMoney imports from standard Quicken QIF files, tracks investments, handles multiple currencies, and provides a wealth of reports.</p>
</div>
<div class="paragraph">
<p>To install KMyMoney, execute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install kmymoney</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="gnucash">8.7.2. GnuCash<a class="anchor" href="#gnucash"></a></h4>
<div class="paragraph">
<p>GnuCash is part of the GNOME effort to provide user-friendly, yet powerful, applications to end-users. GnuCash can be used to keep track of income and expenses, bank accounts, and stocks. It features an intuitive interface while remaining professional.</p>
</div>
<div class="paragraph">
<p>GnuCash provides a smart register, a hierarchical system of accounts, and many keyboard accelerators and auto-completion methods. It can split a single transaction into several more detailed pieces. GnuCash can import and merge Quicken QIF files. It also handles most international date and currency formats.</p>
</div>
<div class="paragraph">
<p>To install GnuCash, execute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install gnucash</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="multimedia">Chapter 9. Multimedia<a class="anchor" href="#multimedia"></a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="multimedia-synopsis">9.1. Synopsis<a class="anchor" href="#multimedia-synopsis"></a></h3>
<div class="paragraph">
<p>The multimedia chapter provides an overview of multimedia support on FreeBSD. Multimedia applications and technologies have become an integral part of modern computing, and FreeBSD provides robust and reliable support for a wide range of multimedia hardware and software. This chapter covers various multimedia components such as audio, video, and image processing. It also discusses various media formats and codecs, as well as tools and applications for multimedia creation and playback. Additionally, the chapter covers multimedia system configuration, troubleshooting, and optimization. Whether you are a multimedia enthusiast or a professional content creator, FreeBSD offers a robust platform for multimedia work. This chapter aims to help get the most out of FreeBSD’s multimedia capabilities, providing useful information and practical examples to help get started.</p>
</div>
</div>
<div class="sect2">
<h3 id="sound-setup">9.2. Setting Up the Sound Card<a class="anchor" href="#sound-setup"></a></h3>
<div class="paragraph">
<p>By default, FreeBSD will automatically detect the sound card used by the system. FreeBSD supports a wide variety of sound cards. The list of supported sound cards can be consulted in <a href="https://man.freebsd.org/cgi/man.cgi?query=sound&amp;sektion=4&amp;format=html">sound(4)</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>It is only necessary to load the sound card module if FreeBSD has not detected it correctly.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Where it is not known which sound card the system has, or which module to use, the <code>snd_driver</code> metadriver can be loaded by executing the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># kldload snd_driver</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, to load the driver as a module at boot time, place the following line in <span class="filename">/boot/loader.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>snd_driver_load=&#34;YES&#34;</pre>
</div>
</div>
<div class="sect3">
<h4 id="sound-testing">9.2.1. Testing Sound<a class="anchor" href="#sound-testing"></a></h4>
<div class="paragraph">
<p>To confirm the sound card is detected the following command can be executed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>dmesg | grep pcm</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should be similar to the following:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>pcm0: &lt;Conexant CX20561 (Hermosa) (Analog 2.0+HP/2.0)&gt; at nid 26,22 and 24 on hdaa0
pcm1: &lt;Conexant CX20561 (Hermosa) (Internal Analog Mic)&gt; at nid 29 on hdaa0</pre>
</div>
</div>
<div class="paragraph">
<p>The status of the sound card may also be checked using this command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># cat /dev/sndstat</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should be similar to the following:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>Installed devices:
pcm0: &lt;Conexant CX20561 (Hermosa) (Analog 2.0+HP/2.0)&gt; (play/rec) default
pcm1: &lt;Conexant CX20561 (Hermosa) (Internal Analog Mic)&gt; (rec)</pre>
</div>
</div>
<div class="paragraph">
<p>If no <code>pcm</code> devices are listed, double-check that the correct device driver was loaded. If all goes well, the sound card should now work in FreeBSD.</p>
</div>
<div class="paragraph">
<p><a href="https://man.freebsd.org/cgi/man.cgi?query=beep&amp;sektion=1&amp;format=html">beep(1)</a> can be used to produce some noise, confirming that the sound card is working:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>beep</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sound-mixer">9.2.2. Mixer<a class="anchor" href="#sound-mixer"></a></h4>
<div class="paragraph">
<p>FreeBSD has different utilities to set and display sound card mixer values built on the FreeBSD Sound System:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">表 16. Supported mixer packages</caption>
<colgroup>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">License</th>
<th class="tableblock halign-left valign-top">Package</th>
<th class="tableblock halign-left valign-top">Toolkit</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://man.freebsd.org/cgi/man.cgi?query=mixer&amp;sektion=8&amp;format=html">mixer(8)</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BSD-2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Included in base system</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CLI</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">dsbmixer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BSD-2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a class="package" href="https://cgit.freebsd.org/ports/tree/audio/dsbmixer/">audio/dsbmixer</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Qt</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">KDE Plasma audio widget</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">GPL 2.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a class="package" href="https://cgit.freebsd.org/ports/tree/audio/plasma5-plasma-pa/">audio/plasma5-plasma-pa</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Qt</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">mixertui</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BSD-2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a class="package" href="https://cgit.freebsd.org/ports/tree/audio/mixertui/">audio/mixertui</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TUI</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="graphics-card-sound">9.2.3. Graphics Card Sound<a class="anchor" href="#graphics-card-sound"></a></h4>
<div class="paragraph">
<p>Graphics cards often come with their own integrated sound devices, and it may be unclear which is being used as the default device. To confirm, run dmesg and look for the pcm entries to identify how the system is enumerating the outputs. Execute the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>dmesg | grep pcm</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output looks something like this:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>pcm0: &lt;HDA NVIDIA (Unknown) PCM #0 DisplayPort&gt; at cad 0 nid 1 on hdac0
pcm1: &lt;HDA NVIDIA (Unknown) PCM #0 DisplayPort&gt; at cad 1 nid 1 on hdac0
pcm2: &lt;HDA NVIDIA (Unknown) PCM #0 DisplayPort&gt; at cad 2 nid 1 on hdac0
pcm3: &lt;HDA NVIDIA (Unknown) PCM #0 DisplayPort&gt; at cad 3 nid 1 on hdac0
hdac1: HDA Codec #2: Realtek ALC889
pcm4: &lt;HDA Realtek ALC889 PCM #0 Analog&gt; at cad 2 nid 1 on hdac1
pcm5: &lt;HDA Realtek ALC889 PCM #1 Analog&gt; at cad 2 nid 1 on hdac1
pcm6: &lt;HDA Realtek ALC889 PCM #2 Digital&gt; at cad 2 nid 1 on hdac1
pcm7: &lt;HDA Realtek ALC889 PCM #3 Digital&gt; at cad 2 nid 1 on hdac1</pre>
</div>
</div>
<div class="paragraph">
<p>The graphics card (NVIDIA®) has been enumerated before the sound card (Realtek®), with the sound card appearing as <code>pcm4</code>. The system can be configured to use the sound card as the default device by executing the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysctl hw.snd.default_unit=4</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To make this change permanent add the next line to <span class="filename">/etc/sysctl.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>hw.snd.default_unit=4</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="automatically-switching-headphones">9.2.4. Automatically Switching to Headphones<a class="anchor" href="#automatically-switching-headphones"></a></h4>
<div class="paragraph">
<p>Some systems may struggle with switching between audio outputs, but fortunately FreeBSD allows automatic switchover to be configured in <span class="filename">device.hints</span>.</p>
</div>
<div class="paragraph">
<p>Identify how the system is enumerating the audio outputs by executing the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>dmesg | grep pcm</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output looks something like this:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>pcm0: &lt;Realtek ALC892 Analog&gt; at nid 23 and 26 on hdaa0
pcm1: &lt;Realtek ALC892 Right Analog Headphones&gt; at nid 22 on hdaa0</pre>
</div>
</div>
<div class="paragraph">
<p>Add the following lines to <span class="filename">/boot/device.hints</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>hint.hdac.0.cad0.nid22.config=&#34;as=1 seq=15 device=Headphones&#34;
hint.hdac.0.cad0.nid26.config=&#34;as=2 seq=0 device=speakers&#34;</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Keep in mind that these values are for the example indicated above. They may vary depending on the system.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect3">
<h4 id="troubleshooting-sound">9.2.5. Troubleshooting Sound<a class="anchor" href="#troubleshooting-sound"></a></h4>
<div class="paragraph">
<p>Some common error messages and their solutions:</p>
</div>
<table id="multimedia-sound-common-error-messages" class="tableblock frame-none grid-all stretch">
<caption class="title">表 17. Common Error Messages</caption>
<colgroup>
<col style="width: 50%;"/>
<col style="width: 50%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Error</th>
<th class="tableblock halign-left valign-top">Solution</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>xxx: can’t open /dev/dsp!</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Type <code>fstat | grep dsp</code> to check if another application is holding the device open. Noteworthy troublemakers are esound and KDE’s sound support.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Programs using <a class="package" href="https://cgit.freebsd.org/ports/tree/audio/pulseaudio/">audio/pulseaudio</a> might need to restart the <a class="package" href="https://cgit.freebsd.org/ports/tree/audio/pulseaudio/">audio/pulseaudio</a> daemon for the changes in <code>hw.snd.default_unit</code> to take effect. Alternatively, <a class="package" href="https://cgit.freebsd.org/ports/tree/audio/pulseaudio/">audio/pulseaudio</a> settings can be changed on the fly. <a href="https://man.freebsd.org/cgi/man.cgi?query=pacmd&amp;sektion=1&amp;format=html">pacmd(1)</a> opens a command line connection to the <a class="package" href="https://cgit.freebsd.org/ports/tree/audio/pulseaudio/">audio/pulseaudio</a> daemon:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pacmd</span>
Welcome to PulseAudio 14.2! Use <span class="s2">&#34;help&#34;</span> <span class="k">for </span>usage information.
&gt;&gt;&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following command changes the default sink to card number 4 as in the previous example:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>set-default-sink 4</pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Do not use the <code>exit</code> command to exit the command line interface. That will kill the <a class="package" href="https://cgit.freebsd.org/ports/tree/audio/pulseaudio/">audio/pulseaudio</a> daemon. Use <span class="keyseq"><kbd>Ctrl</kbd>+<kbd>D</kbd></span> instead.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="audio-ports">9.3. Audio players<a class="anchor" href="#audio-ports"></a></h3>
<div class="paragraph">
<p>This section introduces some of the software available from the FreeBSD Ports Collection which can be used for audio playback.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">表 18. Audio players packages</caption>
<colgroup>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">License</th>
<th class="tableblock halign-left valign-top">Package</th>
<th class="tableblock halign-left valign-top">Toolkit</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Elisa</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">LGPL 3.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a class="package" href="https://cgit.freebsd.org/ports/tree/audio/elisa/">audio/elisa</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Qt</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GNOME Music</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">GPL 2.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a class="package" href="https://cgit.freebsd.org/ports/tree/audio/gnome-music/">audio/gnome-music</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">GTK+</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Audacious</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BSD-2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a class="package" href="https://cgit.freebsd.org/ports/tree/multimedia/audacious/">multimedia/audacious</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Qt</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MOC (music on console)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">GPL 2.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a class="package" href="https://cgit.freebsd.org/ports/tree/audio/moc/">audio/moc</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TUI</p></td>
</tr>
</tbody>
</table>
<div class="sect3">
<h4 id="elisa">9.3.1. Elisa<a class="anchor" href="#elisa"></a></h4>
<div class="paragraph">
<p>Elisa is a music player developed by the KDE community that strives to be simple and nice to use.</p>
</div>
<div class="paragraph">
<p>To install Elisa, execute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install elisa</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="gnome-music">9.3.2. GNOME Music<a class="anchor" href="#gnome-music"></a></h4>
<div class="paragraph">
<p>GNOME Music is the new GNOME music playing application. It aims to combine an elegant and immersive browsing experience with simple and straightforward controls.</p>
</div>
<div class="paragraph">
<p>To install GNOME Music, execute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install gnome-music</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="audacious">9.3.3. Audacious<a class="anchor" href="#audacious"></a></h4>
<div class="paragraph">
<p>Audacious is an open source audio player. A descendant of XMMS, it plays your music how you want it, without stealing away your computer’s resources from other tasks.</p>
</div>
<div class="paragraph">
<p>To install Audacious, execute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install audacious-qt6 audacious-plugins-qt6</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Audacious supports OSS natively, but must be configured in the settings on the Audio tab.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect3">
<h4 id="moc-music-on-console">9.3.4. MOC (music on console)<a class="anchor" href="#moc-music-on-console"></a></h4>
<div class="paragraph">
<p>MOC (music on console) is a console audio player designed to be powerful and easy to use.</p>
</div>
<div class="paragraph">
<p>MOC plays smoothly, regardless of system or I/O load, because it handles the output buffer in a separate thread. It does not cause gaps between files, because the next file to be played is pre-cached while playing the current file.</p>
</div>
<div class="paragraph">
<p>To install MOC (music on console), execute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install moc</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="video-ports">9.4. Video players<a class="anchor" href="#video-ports"></a></h3>
<div class="paragraph">
<p>This section introduces some of the software available from the FreeBSD Ports Collection which can be used for video playback.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">表 19. Video players packages</caption>
<colgroup>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">License</th>
<th class="tableblock halign-left valign-top">Package</th>
<th class="tableblock halign-left valign-top">Toolkit</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MPlayer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">GPL 2.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a class="package" href="https://cgit.freebsd.org/ports/tree/multimedia/mplayer/">multimedia/mplayer</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CLI</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SMPlayer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">GPL 2.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a class="package" href="https://cgit.freebsd.org/ports/tree/multimedia/smplayer/">multimedia/smplayer</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Qt</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">VLC media player</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">GPL 2.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a class="package" href="https://cgit.freebsd.org/ports/tree/multimedia/vlc/">multimedia/vlc</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Qt</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kodi (XBMC)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">GPL 2.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a class="package" href="https://cgit.freebsd.org/ports/tree/multimedia/kodi/">multimedia/kodi</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">X11</p></td>
</tr>
</tbody>
</table>
<div class="sect3">
<h4 id="mplayer">9.4.1. MPlayer<a class="anchor" href="#mplayer"></a></h4>
<div class="paragraph">
<p>MPlayer is a multimedia player and encoder suite which runs on many platforms and works on the command line. It plays a terrific number of different file formats and codecs including popular DivX, XviD, H.264 streams as well as DVD and SVCDs along with many popular audio codecs.</p>
</div>
<div class="paragraph">
<p>To install MPlayer, execute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install mplayer</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For examples of how MPlayer works see <a href="https://man.freebsd.org/cgi/man.cgi?query=mplayer&amp;sektion=1&amp;format=html">mplayer(1)</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="smplayer">9.4.2. SMPlayer<a class="anchor" href="#smplayer"></a></h4>
<div class="paragraph">
<p>SMPlayer intends to be a complete front-end for MPlayer, from basic features like playing videos, DVDs, and VCDs to more advanced features like support for MPlayer filters and more.</p>
</div>
<div class="paragraph">
<p>To install SMPlayer, execute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install smplayer</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="vlc">9.4.3. VLC media player<a class="anchor" href="#vlc"></a></h4>
<div class="paragraph">
<p>VLC media player is a highly portable multimedia player for various audio and video formats (MPEG-1, MPEG-2, MPEG-4, DivX, mp3, ogg, and more) as well as DVD’s, VCD’s, and various streaming protocols. It can also be used as a server to stream in unicast or multicast in IPv4 or IPv6 on a high-bandwidth network. VLC also has the ability to transcode media on-the-fly for streaming or saving to disk.</p>
</div>
<div class="paragraph">
<p>To install VLC, execute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install vlc</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="kodi">9.4.4. Kodi (XBMC)<a class="anchor" href="#kodi"></a></h4>
<div class="paragraph">
<p>Kodi (formerly known as XBMC) is a free and open source cross-platform media-player and entertainment hub. It allows users to play and view most videos, music, podcasts, and other digital media files from local and network storage media and the internet.</p>
</div>
<div class="paragraph">
<p>To install Kodi, execute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install kodi</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="conferencing-meetings">9.5. Conferencing and Meetings<a class="anchor" href="#conferencing-meetings"></a></h3>
<div class="paragraph">
<p>A FreeBSD desktop environment can be used to join video conferences. This section will explain how to configure the webcam and which videoconferencing applications are supported on FreeBSD.</p>
</div>
<div class="sect3">
<h4 id="webcam-setup">9.5.1. Setting Up the Webcam<a class="anchor" href="#webcam-setup"></a></h4>
<div class="paragraph">
<p>To allow FreeBSD access to the webcam and perform its configuration it is necessary to install certain utilities:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a class="package" href="https://cgit.freebsd.org/ports/tree/multimedia/webcamd/">multimedia/webcamd</a> is a daemon that enables the use of hundreds of different USB based webcam and DVB USB devices.</p>
</li>
<li>
<p><a class="package" href="https://cgit.freebsd.org/ports/tree/multimedia/pwcview/">multimedia/pwcview</a> is an application that can be used to view the video stream of the webcam.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To install the required utilities, execute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install webcamd pwcview</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Enable the <a href="https://man.freebsd.org/cgi/man.cgi?query=webcamd&amp;sektion=8&amp;format=html">webcamd(8)</a> service in <code>/etc/rc.conf</code> to start it at system boot:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysrc webcamd_enable=&#34;YES&#34;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The user must belong to the <code>webcamd</code> group. To add the user to <code>webcamd</code> group execute the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pw groupmod webcamd -m username</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Since <a class="package" href="https://cgit.freebsd.org/ports/tree/multimedia/webcamd/">multimedia/webcamd</a> needs the <a href="https://man.freebsd.org/cgi/man.cgi?query=cuse&amp;sektion=3&amp;format=html">cuse(3)</a> module this module must be loaded by executing the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># kldload cuse</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To load <a href="https://man.freebsd.org/cgi/man.cgi?query=cuse&amp;sektion=3&amp;format=html">cuse(3)</a> at system boot, execute the command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysrc kld_list += &#34;cuse&#34;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Once the utilities have been installed the list of available webcams can be shown with <a href="https://man.freebsd.org/cgi/man.cgi?query=webcamd&amp;sektion=8&amp;format=html">webcamd(8)</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># webcamd -l</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should be similar to the following:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>webcamd [-d ugen0.2] -N SunplusIT-Inc-HP-TrueVision-HD-Camera -S unknown -M 0 <i class="conum" data-value="1"></i><b>(1)</b>
webcamd [-d ugen1.3] -N Realtek-802-11n-WLAN-Adapter -S 00e04c000001 -M 0</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Available webcam</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Configure the available webcam executing the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysrc webcamd_0_flags=&#34;-d ugen0.2&#34; </span><i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Note here that if this is a plug-and-play USB webcam, changing the USB port to which it is connected will change the output from <code>webcamd -l</code>, and the entry in rc.conf might need to be updated. For laptops that use USB integrated webcams, this should not be an issue.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>The <a href="https://man.freebsd.org/cgi/man.cgi?query=webcamd&amp;sektion=8&amp;format=html">webcamd(8)</a> service must be started by executing the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># service webcamd start</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should be similar to the following:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>Starting webcamd.
webcamd 1616 - - Attached to ugen0.2[0]</pre>
</div>
</div>
<div class="paragraph">
<p><a class="package" href="https://cgit.freebsd.org/ports/tree/multimedia/pwcview/">multimedia/pwcview</a> can be used to check the proper functioning of the webcam. The following command can be used to execute <a class="package" href="https://cgit.freebsd.org/ports/tree/multimedia/pwcview/">multimedia/pwcview</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>pwcview -f 30 -s vga</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then <a class="package" href="https://cgit.freebsd.org/ports/tree/multimedia/pwcview/">multimedia/pwcview</a> will display the webcam:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/multimedia/pwcview.png" alt="pwcview showing Absolute FreeBSD 3rd edition as an example"/>
</div>
</div>
</div>
<div class="sect3">
<h4 id="meetings-software-status">9.5.2. Meetings software status<a class="anchor" href="#meetings-software-status"></a></h4>
<div class="paragraph">
<p>FreeBSD currently supports the following tools used to carry out videoconferences.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">表 20. Meeting software</caption>
<colgroup>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Firefox status</th>
<th class="tableblock halign-left valign-top">Chromium status</th>
<th class="tableblock halign-left valign-top">Website</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Microsoft Teams</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Does not work</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Works</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://teams.live.com" class="bare">https://teams.live.com</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Google Meet</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Does not work</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Works</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://meet.google.com/" class="bare">https://meet.google.com/</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Zoom</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Works</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Works</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://zoom.us" class="bare">https://zoom.us</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Jitsi</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Does not work</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Works</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://meet.jit.si/" class="bare">https://meet.jit.si/</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">BigBlueButton</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Does not work</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Works</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://bigbluebutton.org/" class="bare">https://bigbluebutton.org/</a></p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect2">
<h3 id="scanners">9.6. Image Scanners<a class="anchor" href="#scanners"></a></h3>
<div class="paragraph">
<p>In FreeBSD, access to image scanners is provided by <a href="http://www.sane-project.org">SANE (Scanner Access Now Easy)</a>, which is available in the FreeBSD Ports Collection.</p>
</div>
<div class="sect3">
<h4 id="scanners-kernel-usb">9.6.1. Checking the Scanner<a class="anchor" href="#scanners-kernel-usb"></a></h4>
<div class="paragraph">
<p>Before attempting any configuration it is important to check the scanner is supported by SANE.</p>
</div>
<div class="paragraph">
<p>With the scanner connected, run the following command to get all connected USB devices:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># usbconfig list</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should be similar to the following:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>ugen4.2: &lt;LITE-ON Technology USB NetVista Full Width Keyboard.&gt; at usbus4, cfg=0 md=HOST spd=LOW (1.5Mbps) pwr=ON (70mA)
ugen4.3: &lt;Logitech USB Optical Mouse&gt; at usbus4, cfg=0 md=HOST spd=LOW (1.5Mbps) pwr=ON (100mA)
ugen3.2: &lt;HP Deskjet 1050 J410 series&gt; at usbus3, cfg=0 md=HOST spd=HIGH (480Mbps) pwr=ON (2mA)</pre>
</div>
</div>
<div class="paragraph">
<p>Run the following command to obtain the <code>idVendor</code> and the <code>idProduct</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># usbconfig -d 3.2 dump_device_desc</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Note here that the scanner is a plug-and-play device, and changing the USB port to which it is connected will change the output from <code>usbconfig list</code>.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>The output should be similar to the following:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>ugen3.2: &lt;HP Deskjet 1050 J410 series&gt; at usbus3, cfg=0 md=HOST spd=HIGH (480Mbps) pwr=ON (2mA)

bLength = 0x0012
bDescriptorType = 0x0001
bcdUSB = 0x0200
bDeviceClass = 0x0000  &lt;Probed by interface class&gt;
bDeviceSubClass = 0x0000
bDeviceProtocol = 0x0000
bMaxPacketSize0 = 0x0040
idVendor = 0x03f0
idProduct = 0x8911
bcdDevice = 0x0100
iManufacturer = 0x0001  &lt;HP&gt;
iProduct = 0x0002  &lt;Deskjet 1050 J410 series&gt;
bNumConfigurations = 0x0001</pre>
</div>
</div>
<div class="paragraph">
<p>Once the <code>idVendor</code> and the <code>idProduct</code> have been obtained, it is necessary to check in the <a href="http://www.sane-project.org/lists/sane-mfgs-cvs.html">list of supported devices of SANE</a> if the scanner is supported by filtering by the idProduct.</p>
</div>
</div>
<div class="sect3">
<h4 id="_sane_configuration">9.6.2. SANE Configuration<a class="anchor" href="#_sane_configuration"></a></h4>
<div class="paragraph">
<p>SANE provides the access to the scanner via backends. To be able to scan with FreeBSD the <a class="package" href="https://cgit.freebsd.org/ports/tree/graphics/sane-backends/">graphics/sane-backends</a> package must be installed by running the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install sane-backends</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Some USB scanners require firmware to be loaded. Like the HP scanner used in the example above, which needs the package <a class="package" href="https://cgit.freebsd.org/ports/tree/print/hplip/">print/hplip</a> installed.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>After installing the necessary packages <a href="https://man.freebsd.org/cgi/man.cgi?query=devd&amp;sektion=8&amp;format=html">devd(8)</a> must be configured to allow FreeBSD access to the scanner.</p>
</div>
<div class="paragraph">
<p>Add the <code>saned.conf</code> file to <span class="filename">/usr/local/etc/devd/saned.conf</span> with the following content:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>notify 100 {
        match &#34;system&#34; &#34;USB&#34;;
        match &#34;subsystem&#34; &#34;INTERFACE&#34;;
        match &#34;type&#34; &#34;ATTACH&#34;;
        match &#34;cdev&#34; &#34;ugen[0-9].[0-9]&#34;;
        match &#34;vendor&#34; &#34;0x03f0&#34;; <i class="conum" data-value="1"></i><b>(1)</b>
        match &#34;product&#34; &#34;0x8911&#34;; <i class="conum" data-value="2"></i><b>(2)</b>
        action &#34;chown -L cups:saned /dev/\$cdev &amp;&amp; chmod -L 660 /dev/\$cdev&#34;;
};</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>vendor</code>: Is the idVendor obtained previously by running the <code>usbconfig -d 3.2 dump_device_desc</code> command. &lt;.&gt; <code>product</code>: Is the idProduct obtained previously by running the <code>usbconfig -d 3.2 dump_device_desc</code> command.</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>After that <a href="https://man.freebsd.org/cgi/man.cgi?query=devd&amp;sektion=8&amp;format=html">devd(8)</a> must be restarted by running the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># service devd restart</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The SANE backends include <a href="https://man.freebsd.org/cgi/man.cgi?query=scanimage&amp;sektion=1&amp;format=html">scanimage(1)</a> which can be used to list the devices and perform an image acquisition.</p>
</div>
<div class="paragraph">
<p>Execute <a href="https://man.freebsd.org/cgi/man.cgi?query=scanimage&amp;sektion=1&amp;format=html">scanimage(1)</a> with <code>-L</code> argument to list the scanner devices:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># scanimage -L</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should be similar to the following:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>device `hpaio:/usb/Deskjet_1050_J410_series?serial=XXXXXXXXXXXXXX&#39; is a Hewlett-Packard Deskjet_1050_J410_series all-in-one</pre>
</div>
</div>
<div class="paragraph">
<p>If <a href="https://man.freebsd.org/cgi/man.cgi?query=scanimage&amp;sektion=1&amp;format=html">scanimage(1)</a> is not able to identify the scanner, this message will appear:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>No scanners were identified. If you were expecting something different,
check that the scanner is plugged in, turned on and detected by the
sane-find-scanner tool (if appropriate). Please read the documentation
which came with this software (README, FAQ, manpages).</pre>
</div>
</div>
<div class="paragraph">
<p>Once <a href="https://man.freebsd.org/cgi/man.cgi?query=scanimage&amp;sektion=1&amp;format=html">scanimage(1)</a> sees the scanner, the configuration is complete and the scanner is now ready to use.</p>
</div>
<div class="paragraph">
<p>To activate the service and have it run at boot execute the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysrc saned_enable=&#34;YES&#34;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>While <a href="https://man.freebsd.org/cgi/man.cgi?query=scanimage&amp;sektion=1&amp;format=html">scanimage(1)</a> can be used to perform an image acquisition from the command line, it is often preferable to use a graphical interface to perform image scanning.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">表 21. Graphical scanner programs</caption>
<colgroup>
<col style="width: 33.3333%;"/>
<col style="width: 33.3333%;"/>
<col style="width: 33.3334%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">License</th>
<th class="tableblock halign-left valign-top">Package</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">skanlite</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">GPL 2.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">graphics/skanlite</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GNOME Simple Scan</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">GPL 3.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">graphics/simple-scan</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">XSANE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">GPL 2.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">graphics/xsane</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="kernelconfig">Chapter 10. Configuring the FreeBSD Kernel<a class="anchor" href="#kernelconfig"></a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="kernelconfig-synopsis">10.1. Synopsis<a class="anchor" href="#kernelconfig-synopsis"></a></h3>
<div class="paragraph">
<p>The kernel is the core of the FreeBSD operating system. It is responsible for managing memory, enforcing security controls, networking, disk access, and much more. While much of FreeBSD is dynamically configurable, it is still occasionally necessary to configure and compile a custom kernel.</p>
</div>
<div class="paragraph">
<p>After reading this chapter, you will know:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>When to build a custom kernel.</p>
</li>
<li>
<p>How to take a hardware inventory.</p>
</li>
<li>
<p>How to customize a kernel configuration file.</p>
</li>
<li>
<p>How to use the kernel configuration file to create and build a new kernel.</p>
</li>
<li>
<p>How to install the new kernel.</p>
</li>
<li>
<p>How to troubleshoot if things go wrong.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>All of the commands listed in the examples in this chapter should be executed as <code>root</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="kernelconfig-custom-kernel">10.2. Why Build a Custom Kernel?<a class="anchor" href="#kernelconfig-custom-kernel"></a></h3>
<div class="paragraph">
<p>Traditionally, FreeBSD used a monolithic kernel. The kernel was one large program, supported a fixed list of devices, and in order to change the kernel’s behavior, one had to compile and then reboot into a new kernel.</p>
</div>
<div class="paragraph">
<p>Today, most of the functionality in the FreeBSD kernel is contained in modules which can be dynamically loaded and unloaded from the kernel as necessary. This allows the running kernel to adapt immediately to new hardware and for new functionality to be brought into the kernel. This is known as a modular kernel.</p>
</div>
<div class="paragraph">
<p>Occasionally, it is still necessary to perform static kernel configuration. Sometimes the needed functionality is so tied to the kernel that it can not be made dynamically loadable. Some security environments prevent the loading and unloading of kernel modules and require that only needed functionality is statically compiled into the kernel.</p>
</div>
<div class="paragraph">
<p>Building a custom kernel is often a rite of passage for advanced BSD users. This process, while time consuming, can provide benefits to the FreeBSD system. Unlike the <span class="filename">GENERIC</span> kernel, which must support a wide range of hardware, a custom kernel can be stripped down to only provide support for that computer’s hardware. This has a number of benefits, such as:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Faster boot time. Since the kernel will only probe the hardware on the system, the time it takes the system to boot can decrease.</p>
</li>
<li>
<p>Lower memory usage. A custom kernel often uses less memory than the <span class="filename">GENERIC</span> kernel by omitting unused features and device drivers. This is important because the kernel code remains resident in physical memory at all times, preventing that memory from being used by applications. For this reason, a custom kernel is useful on a system with a small amount of RAM.</p>
</li>
<li>
<p>Additional hardware support. A custom kernel can add support for devices which are not present in the <span class="filename">GENERIC</span> kernel.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Before building a custom kernel, consider the reason for doing so. If there is a need for specific hardware support, it may already exist as a module.</p>
</div>
<div class="paragraph">
<p>Kernel modules exist in <span class="filename">/boot/kernel</span> and may be dynamically loaded into the running kernel using <a href="https://man.freebsd.org/cgi/man.cgi?query=kldload&amp;sektion=8&amp;format=html">kldload(8)</a>. Most kernel drivers have a loadable module and manual page. For example, the <a href="https://man.freebsd.org/cgi/man.cgi?query=ath&amp;sektion=4&amp;format=html">ath(4)</a> wireless network driver has the following information in its manual page:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">Alternatively, to load the driver as a module at boot time, place the
following line in <a href="https://man.freebsd.org/cgi/man.cgi?query=loader.conf&amp;sektion=5&amp;format=html">loader.conf(5)</a>:

    if_ath_load=&#34;YES&#34;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Adding <code>if_ath_load=&#34;YES&#34;</code> to <span class="filename">/boot/loader.conf</span> will load this module dynamically at boot time.</p>
</div>
<div class="paragraph">
<p>In some cases, there is no associated module in <span class="filename">/boot/kernel</span>. This is mostly true for certain subsystems.</p>
</div>
</div>
<div class="sect2">
<h3 id="kernelconfig-devices">10.3. Finding the System Hardware<a class="anchor" href="#kernelconfig-devices"></a></h3>
<div class="paragraph">
<p>Before editing the kernel configuration file, it is recommended to perform an inventory of the machine’s hardware. On a dual-boot system, the inventory can be created from the other operating system. For example, Microsoft®&#39;s Device Manager contains information about installed devices.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Some versions of Microsoft® Windows® have a System icon which can be used to access Device Manager.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>If FreeBSD is the only installed operating system, use <a href="https://man.freebsd.org/cgi/man.cgi?query=dmesg&amp;sektion=8&amp;format=html">dmesg(8)</a> to determine the hardware that was found and listed during the boot probe. Most device drivers on FreeBSD have a manual page which lists the hardware supported by that driver. For example, the following lines indicate that the <a href="https://man.freebsd.org/cgi/man.cgi?query=psm&amp;sektion=4&amp;format=html">psm(4)</a> driver found a mouse:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">psm0: &lt;PS/2 Mouse&gt; irq 12 on atkbdc0
psm0: <span class="o">[</span>GIANT-LOCKED]
psm0: <span class="o">[</span>ITHREAD]
psm0: model Generic PS/2 mouse, device ID 0</code></pre>
</div>
</div>
<div class="paragraph">
<p>Since this hardware exists, this driver should not be removed from a custom kernel configuration file.</p>
</div>
<div class="paragraph">
<p>If the output of <code>dmesg</code> does not display the results of the boot probe output, instead read the contents of <span class="filename">/var/run/dmesg.boot</span>.</p>
</div>
<div class="paragraph">
<p>Another tool for finding hardware is <a href="https://man.freebsd.org/cgi/man.cgi?query=pciconf&amp;sektion=8&amp;format=html">pciconf(8)</a>, which provides more verbose output. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>pciconf -lv
ath0@pci0:3:0:0:        <span class="nv">class</span><span class="o">=</span>0x020000 <span class="nv">card</span><span class="o">=</span>0x058a1014 <span class="nv">chip</span><span class="o">=</span>0x1014168c <span class="nv">rev</span><span class="o">=</span>0x01 <span class="nv">hdr</span><span class="o">=</span>0x00
    vendor     <span class="o">=</span> <span class="s1">&#39;Atheros Communications Inc.&#39;</span>
    device     <span class="o">=</span> <span class="s1">&#39;AR5212 Atheros AR5212 802.11abg wireless&#39;</span>
    class      <span class="o">=</span> network
    subclass   <span class="o">=</span> ethernet</code></pre>
</div>
</div>
<div class="paragraph">
<p>This output shows that the <span class="filename">ath</span> driver located a wireless Ethernet device.</p>
</div>
<div class="paragraph">
<p>The <code>-k</code> flag of <a href="https://man.freebsd.org/cgi/man.cgi?query=man&amp;sektion=1&amp;format=html">man(1)</a> can be used to provide useful information. For example, it can be used to display a list of manual pages which contain a particular device brand or name:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># man -k Atheros</span>
ath<span class="o">(</span>4<span class="o">)</span>                   - Atheros IEEE 802.11 wireless network driver
ath_hal<span class="o">(</span>4<span class="o">)</span>               - Atheros Hardware Access Layer <span class="o">(</span>HAL<span class="o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Once the hardware inventory list is created, refer to it to ensure that drivers for installed hardware are not removed as the custom kernel configuration is edited.</p>
</div>
</div>
<div class="sect2">
<h3 id="kernelconfig-config">10.4. The Configuration File<a class="anchor" href="#kernelconfig-config"></a></h3>
<div class="paragraph">
<p>In order to create a custom kernel configuration file and build a custom kernel, the full FreeBSD source tree must first be installed.</p>
</div>
<div class="paragraph">
<p>If <span class="filename">/usr/src/</span> does not exist or it is empty, source has not been installed. Source can be installed with Git using the instructions in <a href="./#git">“Using Git”</a>.</p>
</div>
<div class="paragraph">
<p>Once source is installed, review the contents of <span class="filename">/usr/src/sys</span>. This directory contains a number of subdirectories, including those which represent the following supported architectures: <span class="filename">amd64</span>, <span class="filename">i386</span>, <span class="filename">powerpc</span>, and <span class="filename">sparc64</span>. Everything inside a particular architecture’s directory deals with that architecture only and the rest of the code is machine independent code common to all platforms. Each supported architecture has a <span class="filename">conf</span> subdirectory which contains the <span class="filename">GENERIC</span> kernel configuration file for that architecture.</p>
</div>
<div class="paragraph">
<p>Do not make edits to <span class="filename">GENERIC</span>. Instead, copy the file to a different name and make edits to the copy. The convention is to use a name with all capital letters. When maintaining multiple FreeBSD machines with different hardware, it is a good idea to name it after the machine’s hostname. This example creates a copy, named <span class="filename">MYKERNEL</span>, of the <span class="filename">GENERIC</span> configuration file for the <code>amd64</code> architecture:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># cd /usr/src/sys/amd64/conf</span>
<span class="c"># cp GENERIC MYKERNEL</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><span class="filename">MYKERNEL</span> can now be customized with any <code>ASCII</code> text editor. The default editor is vi, though an easier editor for beginners, called ee, is also installed with FreeBSD.</p>
</div>
<div class="paragraph">
<p>The format of the kernel configuration file is simple. Each line contains a keyword that represents a device or subsystem, an argument, and a brief description. Any text after a <code>#</code> is considered a comment and ignored. To remove kernel support for a device or subsystem, put a <code>#</code> at the beginning of the line representing that device or subsystem. Do not add or remove a <code>#</code> for any line that you do not understand.</p>
</div>
<div class="admonitionblock warning">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>It is easy to remove support for a device or option and end up with a broken kernel. For example, if the <a href="https://man.freebsd.org/cgi/man.cgi?query=ata&amp;sektion=4&amp;format=html">ata(4)</a> driver is removed from the kernel configuration file, a system using <code>ATA</code> disk drivers may not boot. When in doubt, just leave support in the kernel.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>In addition to the brief descriptions provided in this file, additional descriptions are contained in <span class="filename">NOTES</span>, which can be found in the same directory as <span class="filename">GENERIC</span> for that architecture. For architecture independent options, refer to <span class="filename">/usr/src/sys/conf/NOTES</span>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When finished customizing the kernel configuration file, save a backup copy to a location outside of <span class="filename">/usr/src</span>.</p>
</div>
<div class="paragraph">
<p>Alternately, keep the kernel configuration file elsewhere and create a symbolic link to the file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># cd /usr/src/sys/amd64/conf</span>
<span class="c"># mkdir /root/kernels</span>
<span class="c"># cp GENERIC /root/kernels/MYKERNEL</span>
<span class="c"># ln -s /root/kernels/MYKERNEL</span></code></pre>
</div>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>An <code>include</code> directive is available for use in configuration files. This allows another configuration file to be included in the current one, making it easy to maintain small changes relative to an existing file. If only a small number of additional options or drivers are required, this allows a delta to be maintained with respect to <span class="filename">GENERIC</span>, as seen in this example:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>include GENERIC
ident MYKERNEL

options         IPFIREWALL
options         DUMMYNET
options         IPFIREWALL_DEFAULT_TO_ACCEPT
options         IPDIVERT</pre>
</div>
</div>
<div class="paragraph">
<p>Using this method, the local configuration file expresses local differences from a <span class="filename">GENERIC</span> kernel. As upgrades are performed, new features added to <span class="filename">GENERIC</span> will also be added to the local kernel unless they are specifically prevented using <code>nooptions</code> or <code>nodevice</code>. A comprehensive list of configuration directives and their descriptions may be found in <a href="https://man.freebsd.org/cgi/man.cgi?query=config&amp;sektion=5&amp;format=html">config(5)</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>To build a file which contains all available options, run the following command as <code>root</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># cd /usr/src/sys/arch/conf &amp;&amp; make LINT</span></code></pre>
</div>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect2">
<h3 id="kernelconfig-building">10.5. Building and Installing a Custom Kernel<a class="anchor" href="#kernelconfig-building"></a></h3>
<div class="paragraph">
<p>Once the edits to the custom configuration file have been saved, the source code for the kernel can be compiled using the following steps:</p>
</div>
<div class="exampleblock procedure">
<div class="content">
<div class="paragraph">
<p><strong>Procedure: Building a Kernel</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Change to this directory:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># cd /usr/src</span></code></pre>
</div>
</div>
</li>
<li>
<p>Compile the new kernel by specifying the name of the custom kernel configuration file:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># make buildkernel KERNCONF=MYKERNEL</span></code></pre>
</div>
</div>
</li>
<li>
<p>Install the new kernel associated with the specified kernel configuration file. This command will copy the new kernel to <span class="filename">/boot/kernel/kernel</span> and save the old kernel to <span class="filename">/boot/kernel.old/kernel</span>:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># make installkernel KERNCONF=MYKERNEL</span></code></pre>
</div>
</div>
</li>
<li>
<p>Shutdown the system and reboot into the new kernel. If something goes wrong, refer to <a href="#kernelconfig-noboot">The kernel does not boot</a>.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="paragraph">
<p>By default, when a custom kernel is compiled, all kernel modules are rebuilt. To update a kernel faster or to build only custom modules, edit <span class="filename">/etc/make.conf</span> before starting to build the kernel.</p>
</div>
<div class="paragraph">
<p>For example, this variable specifies the list of modules to build instead of using the default of building all modules:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>MODULES_OVERRIDE = linux acpi</pre>
</div>
</div>
<div class="paragraph">
<p>Alternately, this variable lists which modules to exclude from the build process:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>WITHOUT_MODULES = linux acpi sound</pre>
</div>
</div>
<div class="paragraph">
<p>Additional variables are available. Refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=make.conf&amp;sektion=5&amp;format=html">make.conf(5)</a> for details.</p>
</div>
</div>
<div class="sect2">
<h3 id="kernelconfig-trouble">10.6. If Something Goes Wrong<a class="anchor" href="#kernelconfig-trouble"></a></h3>
<div class="paragraph">
<p>There are four categories of trouble that can occur when building a custom kernel:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>config</code> fails</dt>
<dd>
<p>If <code>config</code> fails, it will print the line number that is incorrect. As an example, for the following message, make sure that line 17 is typed correctly by comparing it to <span class="filename">GENERIC</span> or <span class="filename">NOTES</span>:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">config: line 17: syntax error</code></pre>
</div>
</div>
</dd>
<dt class="hdlist1"><code>make</code> fails</dt>
<dd>
<p>If <code>make</code> fails, it is usually due to an error in the kernel configuration file which is not severe enough for <code>config</code> to catch. Review the configuration, and if the problem is not apparent, send an email to the {freebsd-questions} which contains the kernel configuration file.</p>
</dd>
</dl>
</div>
<div id="kernelconfig-noboot" class="dlist">
<dl>
<dt class="hdlist1">The kernel does not boot</dt>
<dd>
<p>If the new kernel does not boot or fails to recognize devices, do not panic! Fortunately, FreeBSD has an excellent mechanism for recovering from incompatible kernels. Simply choose the kernel to boot from at the FreeBSD boot loader. This can be accessed when the system boot menu appears by selecting the &#34;Escape to a loader prompt&#34; option. At the prompt, type <code>boot <em>kernel.old</em></code>, or the name of any other kernel that is known to boot properly.</p>
<div class="paragraph">
<p>After booting with a good kernel, check over the configuration file and try to build it again. One helpful resource is <span class="filename">/var/log/messages</span> which records the kernel messages from every successful boot. Also, <a href="https://man.freebsd.org/cgi/man.cgi?query=dmesg&amp;sektion=8&amp;format=html">dmesg(8)</a> will print the kernel messages from the current boot.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When troubleshooting a kernel make sure to keep a copy of a kernel that is known to work, such as <span class="filename">GENERIC</span>. This is important because every time a new kernel is installed, <span class="filename">kernel.old</span> is overwritten with the last installed kernel, which may or may not be bootable. As soon as possible, move the working kernel by renaming the directory containing the good kernel:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># mv /boot/kernel /boot/kernel.bad</span>
<span class="c"># mv /boot/kernel.good /boot/kernel</span></code></pre>
</div>
</div>
</td>
</tr>
</tbody></table>
</div>
</dd>
<dt class="hdlist1">The kernel works, but <a href="https://man.freebsd.org/cgi/man.cgi?query=ps&amp;sektion=1&amp;format=html">ps(1)</a> does not</dt>
<dd>
<p>If the kernel version differs from the one that the system utilities have been built with, for example, a kernel built from -CURRENT sources is installed on a -RELEASE system, many system status commands like <a href="https://man.freebsd.org/cgi/man.cgi?query=ps&amp;sektion=1&amp;format=html">ps(1)</a> and <a href="https://man.freebsd.org/cgi/man.cgi?query=vmstat&amp;sektion=8&amp;format=html">vmstat(8)</a> will not work. To fix this, <a href="./#makeworld">recompile and install a world</a> built with the same version of the source tree as the kernel. It is never a good idea to use a different version of the kernel than the rest of the operating system.</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="printing">Chapter 11. Printing<a class="anchor" href="#printing"></a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Putting information on paper is a vital function, despite many attempts to eliminate it. Printing has two basic components. The data must be delivered to the printer, and must be in a form that the printer can understand.</p>
</div>
<div class="sect2">
<h3 id="printing-quick-start">11.1. Quick Start<a class="anchor" href="#printing-quick-start"></a></h3>
<div class="paragraph">
<p>Basic printing can be set up quickly. The printer must be capable of printing plain <code>ASCII</code> text. For printing to other types of files, see <a href="#printing-lpd-filters">Filters</a>.</p>
</div>
<div class="sidebarblock procedure">
<div class="content">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create a directory to store files while they are being printed:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># mkdir -p /var/spool/lpd/lp</span>
<span class="c"># chown daemon:daemon /var/spool/lpd/lp</span>
<span class="c"># chmod 770 /var/spool/lpd/lp</span></code></pre>
</div>
</div>
</li>
<li>
<p>As <code>root</code>, create <span class="filename">/etc/printcap</span> with these contents:</p>
<div class="literalblock programlisting">
<div class="content">
<pre>lp:\
lp=/dev/unlpt0:\  <i class="conum" data-value="1"></i><b>(1)</b>
sh:\
mx#0:\
sd=/var/spool/lpd/lp:\
lf=/var/log/lpd-errs:</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This line is for a printer connected to a <code>USB</code> port.</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>For a printer connected to a parallel or &#34;printer&#34; port, use:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>:lp=/dev/lpt0:\</pre>
</div>
</div>
<div class="paragraph">
<p>For a printer connected directly to a network, use:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>:lp=:rm=network-printer-name:rp=raw:\</pre>
</div>
</div>
<div class="paragraph">
<p>Replace <em>network-printer-name</em> with the <code>DNS</code> host name of the network printer.</p>
</div>
</li>
<li>
<p>Enable LPD by editing <span class="filename">/etc/rc.conf</span>, adding this line:</p>
<div class="literalblock programlisting">
<div class="content">
<pre>lpd_enable=&#34;YES&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>Start the service:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># service lpd start</span>
Starting lpd.</code></pre>
</div>
</div>
</li>
<li>
<p>Print a test:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># printf &#34;1. This printer can print.\n2. This is the second line.\n&#34; | lpr</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If both lines do not start at the left border, but &#34;stairstep&#34; instead, see <a href="#printing-lpd-filters-stairstep">Preventing Stairstepping on Plain Text Printers</a>.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Text files can now be printed with <code>lpr</code>. Give the filename on the command line, or pipe output directly into <code>lpr</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>lpr textfile.txt
<span class="gp">% </span>ls -lh | lpr</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="printing-connections">11.2. Printer Connections<a class="anchor" href="#printing-connections"></a></h3>
<div class="paragraph">
<p>Printers are connected to computer systems in a variety of ways. Small desktop printers are usually connected directly to a computer’s <code>USB</code> port. Older printers are connected to a parallel or &#34;printer&#34; port. Some printers are directly connected to a network, making it easy for multiple computers to share them. A few printers use a rare serial port connection.</p>
</div>
<div class="paragraph">
<p>FreeBSD can communicate with all of these types of printers.</p>
</div>
<div id="printing-connections-usb" class="dlist">
<dl>
<dt class="hdlist1"><code>USB</code></dt>
<dd>
<p><code>USB</code> printers can be connected to any available <code>USB</code> port on the computer.</p>
<div class="paragraph">
<p>When FreeBSD detects a <code>USB</code> printer, two device entries are created: <span class="filename">/dev/ulpt0</span> and <span class="filename">/dev/unlpt0</span>. Data sent to either device will be relayed to the printer. After each print job, <span class="filename">ulpt0</span> resets the <code>USB</code> port. Resetting the port can cause problems with some printers, so the <span class="filename">unlpt0</span> device is usually used instead. <span class="filename">unlpt0</span> does not reset the USB port at all.</p>
</div>
</dd>
</dl>
</div>
<div id="printing-connections-parallel" class="dlist">
<dl>
<dt class="hdlist1">Parallel (<code>IEEE</code>-1284)</dt>
<dd>
<p>The parallel port device is <span class="filename">/dev/lpt0</span>. This device appears whether a printer is attached or not, it is not autodetected.</p>
<div class="paragraph">
<p>Vendors have largely moved away from these &#34;legacy&#34; ports, and many computers no longer have them. Adapters can be used to connect a parallel printer to a <code>USB</code> port. With such an adapter, the printer can be treated as if it were actually a <code>USB</code> printer. Devices called <em>print servers</em> can also be used to connect parallel printers directly to a network.</p>
</div>
</dd>
</dl>
</div>
<div id="printing-connections-serial" class="dlist">
<dl>
<dt class="hdlist1">Serial (RS-232)</dt>
<dd>
<p>Serial ports are another legacy port, rarely used for printers except in certain niche applications. Cables, connectors, and required wiring vary widely.</p>
<div class="paragraph">
<p>For serial ports built into a motherboard, the serial device name is <span class="filename">/dev/cuau0</span> or <span class="filename">/dev/cuau1</span>. Serial <code>USB</code> adapters can also be used, and these will appear as <span class="filename">/dev/cuaU0</span>.</p>
</div>
<div class="paragraph">
<p>Several communication parameters must be known to communicate with a serial printer. The most important are <em>baud rate</em> or <code>BPS</code> (Bits Per Second) and <em>parity</em>. Values vary, but typical serial printers use a baud rate of 9600 and no parity.</p>
</div>
</dd>
</dl>
</div>
<div id="printing-connections-network" class="dlist">
<dl>
<dt class="hdlist1">Network</dt>
<dd>
<p>Network printers are connected directly to the local computer network.</p>
<div class="paragraph">
<p>The <code>DNS</code> hostname of the printer must be known. If the printer is assigned a dynamic address by <code>DHCP</code>, <code>DNS</code> should be dynamically updated so that the host name always has the correct <code>IP</code> address. Network printers are often given static <code>IP</code> addresses to avoid this problem.</p>
</div>
<div class="paragraph">
<p>Most network printers understand print jobs sent with the LPD protocol. A print queue name can also be specified. Some printers process data differently depending on which queue is used. For example, a <code>raw</code> queue prints the data unchanged, while the <code>text</code> queue adds carriage returns to plain text.</p>
</div>
<div class="paragraph">
<p>Many network printers can also print data sent directly to port 9100.</p>
</div>
</dd>
</dl>
</div>
<div class="sect3">
<h4 id="printing-connections-summary">11.2.1. Summary<a class="anchor" href="#printing-connections-summary"></a></h4>
<div class="paragraph">
<p>Wired network connections are usually the easiest to set up and give the fastest printing. For direct connection to the computer, <code>USB</code> is preferred for speed and simplicity. Parallel connections work but have limitations on cable length and speed. Serial connections are more difficult to configure. Cable wiring differs between models, and communication parameters like baud rate and parity bits must add to the complexity. Fortunately, serial printers are rare.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="printing-pdls">11.3. Common Page Description Languages<a class="anchor" href="#printing-pdls"></a></h3>
<div class="paragraph">
<p>Data sent to a printer must be in a language that the printer can understand. These languages are called Page Description Languages, or PDLs.</p>
</div>
<div id="print-pdls-ascii" class="dlist">
<dl>
<dt class="hdlist1"><code>ASCII</code></dt>
<dd>
<p>Plain <code>ASCII</code> text is the simplest way to send data to a printer. Characters correspond one to one with what will be printed: an <code>A</code> in the data prints an <code>A</code> on the page. Very little formatting is available. There is no way to select a font or proportional spacing. The forced simplicity of plain <code>ASCII</code> means that text can be printed straight from the computer with little or no encoding or translation. The printed output corresponds directly with what was sent.</p>
<div class="paragraph">
<p>Some inexpensive printers cannot print plain <code>ASCII</code> text. This makes them more difficult to set up, but it is usually still possible.</p>
</div>
</dd>
</dl>
</div>
<div id="print-pdls-postscript" class="dlist">
<dl>
<dt class="hdlist1">PostScript®</dt>
<dd>
<p>PostScript® is almost the opposite of <code>ASCII</code>. Rather than simple text, a PostScript® program is a set of instructions that draw the final document. Different fonts and graphics can be used. However, this power comes at a price. The program that draws the page must be written. Usually this program is generated by application software, so the process is invisible to the user.</p>
<div class="paragraph">
<p>Inexpensive printers sometimes leave out PostScript® compatibility as a cost-saving measure.</p>
</div>
</dd>
</dl>
</div>
<div id="print-pdls-pcl" class="dlist">
<dl>
<dt class="hdlist1"><code>PCL</code> (Printer Command Language)</dt>
<dd>
<p><code>PCL</code> is an extension of <code>ASCII</code>, adding escape sequences for formatting, font selection, and printing graphics. Many printers provide <code>PCL5</code> support. Some support the newer <code>PCL6</code> or <code>PCLXL</code>. These later versions are supersets of <code>PCL5</code> and can provide faster printing.</p>
</dd>
</dl>
</div>
<div id="print-pdls-host-based" class="dlist">
<dl>
<dt class="hdlist1">Host-Based</dt>
<dd>
<p>Manufacturers can reduce the cost of a printer by giving it a simple processor and very little memory. These printers are not capable of printing plain text. Instead, bitmaps of text and graphics are drawn by a driver on the host computer and then sent to the printer. These are called <em>host-based</em> printers.</p>
<div class="paragraph">
<p>Communication between the driver and a host-based printer is often through proprietary or undocumented protocols, making them functional only on the most common operating systems.</p>
</div>
</dd>
</dl>
</div>
<div class="sect3">
<h4 id="print-pdls-table">11.3.1. Converting PostScript® to Other PDLs<a class="anchor" href="#print-pdls-table"></a></h4>
<div class="paragraph">
<p>Many applications from the Ports Collection and FreeBSD utilities produce PostScript® output. This table shows the utilities available to convert that into other common PDLs:</p>
</div>
<table id="print-pdls-ps-to-other-tbl" class="tableblock frame-none grid-all stretch">
<caption class="title">表 22. Output PDLs</caption>
<colgroup>
<col style="width: 33.3333%;"/>
<col style="width: 33.3333%;"/>
<col style="width: 33.3334%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Output PDL</th>
<th class="tableblock halign-left valign-top">Generated By</th>
<th class="tableblock halign-left valign-top">Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>PCL</code> or <code>PCL5</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a class="package" href="https://cgit.freebsd.org/ports/tree/print/ghostscript9-base/">print/ghostscript9-base</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>-sDEVICE=ljet4</code> for monochrome, <code>-sDEVICE=cljet5</code> for color</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>PCLXL</code> or <code>PCL6</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a class="package" href="https://cgit.freebsd.org/ports/tree/print/ghostscript9-base/">print/ghostscript9-base</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>-sDEVICE=pxlmono</code> for monochrome, <code>-sDEVICE=pxlcolor</code> for color</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ESC/P2</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a class="package" href="https://cgit.freebsd.org/ports/tree/print/ghostscript9-base/">print/ghostscript9-base</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>-sDEVICE=uniprint</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>XQX</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a class="package" href="https://cgit.freebsd.org/ports/tree/print/foo2zjs/">print/foo2zjs</a></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="print-pdls-summary">11.3.2. Summary<a class="anchor" href="#print-pdls-summary"></a></h4>
<div class="paragraph">
<p>For the easiest printing, choose a printer that supports PostScript®. Printers that support <code>PCL</code> are the next preferred. With <a class="package" href="https://cgit.freebsd.org/ports/tree/print/ghostscript9-base/">print/ghostscript9-base</a>, these printers can be used as if they understood PostScript® natively. Printers that support PostScript® or <code>PCL</code> directly almost always support direct printing of plain <code>ASCII</code> text files also.</p>
</div>
<div class="paragraph">
<p>Line-based printers like typical inkjets usually do not support PostScript® or <code>PCL</code>. They often can print plain <code>ASCII</code> text files. <a class="package" href="https://cgit.freebsd.org/ports/tree/print/ghostscript9-base/">print/ghostscript9-base</a> supports the PDLs used by some of these printers. However, printing an entire graphic-based page on these printers is often very slow due to the large amount of data to be transferred and printed.</p>
</div>
<div class="paragraph">
<p>Host-based printers are often more difficult to set up. Some cannot be used at all because of proprietary PDLs. Avoid these printers when possible.</p>
</div>
<div class="paragraph">
<p>Descriptions of many PDLs can be found at <a href="http://www.undocprint.org/formats/page_description_languages" class="bare">http://www.undocprint.org/formats/page_description_languages</a>. The particular <code>PDL</code> used by various models of printers can be found at <a href="http://www.openprinting.org/printers" class="bare">http://www.openprinting.org/printers</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="printing-direct">11.4. Direct Printing<a class="anchor" href="#printing-direct"></a></h3>
<div class="paragraph">
<p>For occasional printing, files can be sent directly to a printer device without any setup. For example, a file called <span class="filename">sample.txt</span> can be sent to a <code>USB</code> printer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># cp sample.txt /dev/unlpt0</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Direct printing to network printers depends on the abilities of the printer, but most accept print jobs on port 9100, and <a href="https://man.freebsd.org/cgi/man.cgi?query=nc&amp;sektion=1&amp;format=html">nc(1)</a> can be used with them. To print the same file to a printer with the <code>DNS</code> hostname of <em>netlaser</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># nc netlaser 9100 &lt; sample.txt</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="printing-lpd">11.5. LPD (Line Printer Daemon)<a class="anchor" href="#printing-lpd"></a></h3>
<div class="paragraph">
<p>Printing a file in the background is called <em>spooling</em>. A spooler allows the user to continue with other programs on the computer without waiting for the printer to slowly complete the print job.</p>
</div>
<div class="paragraph">
<p>FreeBSD includes a spooler called <a href="https://man.freebsd.org/cgi/man.cgi?query=lpd&amp;sektion=8&amp;format=html">lpd(8)</a>. Print jobs are submitted with <a href="https://man.freebsd.org/cgi/man.cgi?query=lpr&amp;sektion=1&amp;format=html">lpr(1)</a>.</p>
</div>
<div class="sect3">
<h4 id="printing-lpd-setup">11.5.1. Initial Setup<a class="anchor" href="#printing-lpd-setup"></a></h4>
<div class="paragraph">
<p>A directory for storing print jobs is created, ownership is set, and the permissions are set to prevent other users from viewing the contents of those files:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># mkdir -p /var/spool/lpd/lp</span>
<span class="c"># chown daemon:daemon /var/spool/lpd/lp</span>
<span class="c"># chmod 770 /var/spool/lpd/lp</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Printers are defined in <span class="filename">/etc/printcap</span>. An entry for each printer includes details like a name, the port where it is attached, and various other settings. Create <span class="filename">/etc/printcap</span> with these contents:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>lp:\				<i class="conum" data-value="1"></i><b>(1)</b>
	:lp=/dev/unlpt0:\	<i class="conum" data-value="2"></i><b>(2)</b>
	:sh:\			<i class="conum" data-value="3"></i><b>(3)</b>
	:mx#0:\			<i class="conum" data-value="4"></i><b>(4)</b>
	:sd=/var/spool/lpd/lp:\	<i class="conum" data-value="5"></i><b>(5)</b>
	:lf=/var/log/lpd-errs:	<i class="conum" data-value="6"></i><b>(6)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The name of this printer. <a href="https://man.freebsd.org/cgi/man.cgi?query=lpr&amp;sektion=1&amp;format=html">lpr(1)</a> sends print jobs to the <code>lp</code> printer unless another printer is specified with <code>-P</code>, so the default printer should be named <code>lp</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The device where the printer is connected. Replace this line with the appropriate one for the connection type shown here.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Suppress the printing of a header page at the start of a print job.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Do not limit the maximum size of a print job.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The path to the spooling directory for this printer. Each printer uses its own spooling directory.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>The log file where errors on this printer will be reported.</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>After creating <span class="filename">/etc/printcap</span>, use <a href="https://man.freebsd.org/cgi/man.cgi?query=chkprintcap&amp;sektion=8&amp;format=html">chkprintcap(8)</a> to test it for errors:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># chkprintcap</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Fix any reported problems before continuing.</p>
</div>
<div class="paragraph">
<p>Enable <a href="https://man.freebsd.org/cgi/man.cgi?query=lpd&amp;sektion=8&amp;format=html">lpd(8)</a> in <span class="filename">/etc/rc.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>lpd_enable=&#34;YES&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>Start the service:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># service lpd start</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="printing-lpd-lpr">11.5.2. Printing with <a href="https://man.freebsd.org/cgi/man.cgi?query=lpr&amp;sektion=1&amp;format=html">lpr(1)</a><a class="anchor" href="#printing-lpd-lpr"></a></h4>
<div class="paragraph">
<p>Documents are sent to the printer with <code>lpr</code>. A file to be printed can be named on the command line or piped into <code>lpr</code>. These two commands are equivalent, sending the contents of <span class="filename">doc.txt</span> to the default printer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>lpr doc.txt
<span class="gp">% </span>cat doc.txt | lpr</code></pre>
</div>
</div>
<div class="paragraph">
<p>Printers can be selected with <code>-P</code>. To print to a printer called <em>laser</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>lpr -Plaser doc.txt</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="printing-lpd-filters">11.5.3. Filters<a class="anchor" href="#printing-lpd-filters"></a></h4>
<div class="paragraph">
<p>The examples shown so far have sent the contents of a text file directly to the printer. As long as the printer understands the content of those files, output will be printed correctly.</p>
</div>
<div class="paragraph">
<p>Some printers are not capable of printing plain text, and the input file might not even be plain text.</p>
</div>
<div class="paragraph">
<p><em>Filters</em> allow files to be translated or processed. The typical use is to translate one type of input, like plain text, into a form that the printer can understand, like PostScript® or <code>PCL</code>. Filters can also be used to provide additional features, like adding page numbers or highlighting source code to make it easier to read.</p>
</div>
<div class="paragraph">
<p>The filters discussed here are <em>input filters</em> or <em>text filters</em>. These filters convert the incoming file into different forms. Use <a href="https://man.freebsd.org/cgi/man.cgi?query=su&amp;sektion=1&amp;format=html">su(1)</a> to become <code>root</code> before creating the files.</p>
</div>
<div class="paragraph">
<p>Filters are specified in <span class="filename">/etc/printcap</span> with the <code>if=</code> identifier. To use <span class="filename">/usr/local/libexec/lf2crlf</span> as a filter, modify <span class="filename">/etc/printcap</span> like this:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>lp:\
	:lp=/dev/unlpt0:\
	:sh:\
	:mx#0:\
	:sd=/var/spool/lpd/lp:\
	:if=/usr/local/libexec/lf2crlf:\   <i class="conum" data-value="1"></i><b>(1)</b>
	:lf=/var/log/lpd-errs:</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>if=</code> identifies the <em>input filter</em> that will be used on incoming text.</td>
</tr>
</tbody></table>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The backslash <em>line continuation</em> characters at the end of the lines in <span class="filename">printcap</span> entries reveal that an entry for a printer is really just one long line with entries delimited by colon characters. An earlier example can be rewritten as a single less-readable line:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>lp:lp=/dev/unlpt0:sh:mx#0:sd=/var/spool/lpd/lp:if=/usr/local/libexec/lf2crlf:lf=/var/log/lpd-errs:</pre>
</div>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="sect4">
<h5 id="printing-lpd-filters-stairstep">11.5.3.1. Preventing Stairstepping on Plain Text Printers<a class="anchor" href="#printing-lpd-filters-stairstep"></a></h5>
<div class="paragraph">
<p>Typical FreeBSD text files contain only a single line feed character at the end of each line. These lines will &#34;stairstep&#34; on a standard printer:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>A printed file looks
                    like the steps of a staircase
                                                 scattered by the wind</pre>
</div>
</div>
<div class="paragraph">
<p>A filter can convert the newline characters into carriage returns and newlines. The carriage returns make the printer return to the left after each line. Create <span class="filename">/usr/local/libexec/lf2crlf</span> with these contents:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>#!/bin/sh
CR=$&#39;\r&#39;
/usr/bin/sed -e &#34;s/$/${CR}/g&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>Set the permissions and make it executable:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># chmod 555 /usr/local/libexec/lf2crlf</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Modify <span class="filename">/etc/printcap</span> to use the new filter:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>:if=/usr/local/libexec/lf2crlf:\</pre>
</div>
</div>
<div class="paragraph">
<p>Test the filter by printing the same plain text file. The carriage returns will cause each line to start at the left side of the page.</p>
</div>
</div>
<div class="sect4">
<h5 id="printing-lpd-filters-enscript">11.5.3.2. Fancy Plain Text on PostScript® Printers with <a class="package" href="https://cgit.freebsd.org/ports/tree/print/enscript/">print/enscript</a><a class="anchor" href="#printing-lpd-filters-enscript"></a></h5>
<div class="paragraph">
<p>GNUEnscript converts plain text files into nicely-formatted PostScript® for printing on PostScript® printers. It adds page numbers, wraps long lines, and provides numerous other features to make printed text files easier to read. Depending on the local paper size, install either <a class="package" href="https://cgit.freebsd.org/ports/tree/print/enscript-letter/">print/enscript-letter</a> or <a class="package" href="https://cgit.freebsd.org/ports/tree/print/enscript-a4/">print/enscript-a4</a> from the Ports Collection.</p>
</div>
<div class="paragraph">
<p>Create <span class="filename">/usr/local/libexec/enscript</span> with these contents:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>#!/bin/sh
/usr/local/bin/enscript -o -</pre>
</div>
</div>
<div class="paragraph">
<p>Set the permissions and make it executable:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># chmod 555 /usr/local/libexec/enscript</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Modify <span class="filename">/etc/printcap</span> to use the new filter:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>:if=/usr/local/libexec/enscript:\</pre>
</div>
</div>
<div class="paragraph">
<p>Test the filter by printing a plain text file.</p>
</div>
</div>
<div class="sect4">
<h5 id="printing-lpd-filters-ps2pcl">11.5.3.3. Printing PostScript® to <code>PCL</code> Printers<a class="anchor" href="#printing-lpd-filters-ps2pcl"></a></h5>
<div class="paragraph">
<p>Many programs produce PostScript® documents. However, inexpensive printers often only understand plain text or <code>PCL</code>. This filter converts PostScript® files to <code>PCL</code> before sending them to the printer.</p>
</div>
<div class="paragraph">
<p>Install the Ghostscript PostScript® interpreter, <a class="package" href="https://cgit.freebsd.org/ports/tree/print/ghostscript9-base/">print/ghostscript9-base</a>, from the Ports Collection.</p>
</div>
<div class="paragraph">
<p>Create <span class="filename">/usr/local/libexec/ps2pcl</span> with these contents:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>#!/bin/sh
/usr/local/bin/gs -dSAFER -dNOPAUSE -dBATCH -q -sDEVICE=ljet4 -sOutputFile=- -</pre>
</div>
</div>
<div class="paragraph">
<p>Set the permissions and make it executable:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># chmod 555 /usr/local/libexec/ps2pcl</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>PostScript® input sent to this script will be rendered and converted to <code>PCL</code> before being sent on to the printer.</p>
</div>
<div class="paragraph">
<p>Modify <span class="filename">/etc/printcap</span> to use this new input filter:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>:if=/usr/local/libexec/ps2pcl:\</pre>
</div>
</div>
<div class="paragraph">
<p>Test the filter by sending a small PostScript® program to it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span><span class="nb">printf</span> <span class="s2">&#34;%%</span><span class="se">\!</span><span class="s2">PS </span><span class="se">\n</span><span class="s2"> /Helvetica findfont 18 scalefont setfont </span><span class="se">\</span><span class="s2">
72 432 moveto (PostScript printing successful.) show showpage </span><span class="se">\0</span><span class="s2">04&#34;</span> | lpr</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="printing-lpd-filters-smart">11.5.3.4. Smart Filters<a class="anchor" href="#printing-lpd-filters-smart"></a></h5>
<div class="paragraph">
<p>A filter that detects the type of input and automatically converts it to the correct format for the printer can be very convenient. The first two characters of a PostScript® file are usually <code>%!</code>. A filter can detect those two characters. PostScript® files can be sent on to a PostScript® printer unchanged. Text files can be converted to PostScript® with Enscript as shown earlier. Create <span class="filename">/usr/local/libexec/psif</span> with these contents:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>#!/bin/sh
#
#  psif - Print PostScript or plain text on a PostScript printer
#
IFS=&#34;&#34; read -r first_line
first_two_chars=`expr &#34;$first_line&#34; : &#39;\(..\)&#39;`

case &#34;$first_two_chars&#34; in
%!)
    # %! : PostScript job, print it.
    echo &#34;$first_line&#34; &amp;&amp; cat &amp;&amp; exit 0
    exit 2
    ;;
*)
    # otherwise, format with enscript
    ( echo &#34;$first_line&#34;; cat ) | /usr/local/bin/enscript -o - &amp;&amp; exit 0
    exit 2
    ;;
esac</pre>
</div>
</div>
<div class="paragraph">
<p>Set the permissions and make it executable:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># chmod 555 /usr/local/libexec/psif</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Modify <span class="filename">/etc/printcap</span> to use this new input filter:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>:if=/usr/local/libexec/psif:\</pre>
</div>
</div>
<div class="paragraph">
<p>Test the filter by printing PostScript® and plain text files.</p>
</div>
</div>
<div class="sect4">
<h5 id="printing-lpd-filters-othersmart">11.5.3.5. Other Smart Filters<a class="anchor" href="#printing-lpd-filters-othersmart"></a></h5>
<div class="paragraph">
<p>Writing a filter that detects many different types of input and formats them correctly is challenging. <a class="package" href="https://cgit.freebsd.org/ports/tree/print/apsfilter/">print/apsfilter</a> from the Ports Collection is a smart &#34;magic&#34; filter that detects dozens of file types and automatically converts them to the <code>PDL</code> understood by the printer. See <a href="http://www.apsfilter.org" class="bare">http://www.apsfilter.org</a> for more details.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="printing-lpd-queues">11.5.4. Multiple Queues<a class="anchor" href="#printing-lpd-queues"></a></h4>
<div class="paragraph">
<p>The entries in <span class="filename">/etc/printcap</span> are really definitions of <em>queues</em>. There can be more than one queue for a single printer. When combined with filters, multiple queues provide users more control over how their jobs are printed.</p>
</div>
<div class="paragraph">
<p>As an example, consider a networked PostScript® laser printer in an office. Most users want to print plain text, but a few advanced users want to be able to print PostScript® files directly. Two entries can be created for the same printer in <span class="filename">/etc/printcap</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>textprinter:\
	:lp=9100@officelaser:\
	:sh:\
	:mx#0:\
	:sd=/var/spool/lpd/textprinter:\
	:if=/usr/local/libexec/enscript:\
	:lf=/var/log/lpd-errs:

psprinter:\
	:lp=9100@officelaser:\
	:sh:\
	:mx#0:\
	:sd=/var/spool/lpd/psprinter:\
	:lf=/var/log/lpd-errs:</pre>
</div>
</div>
<div class="paragraph">
<p>Documents sent to <code>textprinter</code> will be formatted by the <span class="filename">/usr/local/libexec/enscript</span> filter shown in an earlier example. Advanced users can print PostScript® files on <code>psprinter</code>, where no filtering is done.</p>
</div>
<div class="paragraph">
<p>This multiple queue technique can be used to provide direct access to all kinds of printer features. A printer with a duplexer could use two queues, one for ordinary single-sided printing, and one with a filter that sends the command sequence to enable double-sided printing and then sends the incoming file.</p>
</div>
</div>
<div class="sect3">
<h4 id="printing-lpd-monitor">11.5.5. Monitoring and Controlling Printing<a class="anchor" href="#printing-lpd-monitor"></a></h4>
<div class="paragraph">
<p>Several utilities are available to monitor print jobs and check and control printer operation.</p>
</div>
<div class="sect4">
<h5 id="printing-lpd-monitor-lpq">11.5.5.1. <a href="https://man.freebsd.org/cgi/man.cgi?query=lpq&amp;sektion=1&amp;format=html">lpq(1)</a><a class="anchor" href="#printing-lpd-monitor-lpq"></a></h5>
<div class="paragraph">
<p><a href="https://man.freebsd.org/cgi/man.cgi?query=lpq&amp;sektion=1&amp;format=html">lpq(1)</a> shows the status of a user’s print jobs. Print jobs from other users are not shown.</p>
</div>
<div class="paragraph">
<p>Show the current user’s pending jobs on a single printer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>lpq -Plp
Rank   Owner      Job  Files                                 Total Size
1st    jsmith     0    <span class="o">(</span>standard input<span class="o">)</span>                      12792 bytes</code></pre>
</div>
</div>
<div class="paragraph">
<p>Show the current user’s pending jobs on all printers:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>lpq -a
lp:
Rank   Owner      Job  Files                                 Total Size
1st    jsmith     1    <span class="o">(</span>standard input<span class="o">)</span>                      27320 bytes

laser:
Rank   Owner      Job  Files                                 Total Size
1st    jsmith     287  <span class="o">(</span>standard input<span class="o">)</span>                      22443 bytes</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="printing-lpd-monitor-lprm">11.5.5.2. <a href="https://man.freebsd.org/cgi/man.cgi?query=lprm&amp;sektion=1&amp;format=html">lprm(1)</a><a class="anchor" href="#printing-lpd-monitor-lprm"></a></h5>
<div class="paragraph">
<p><a href="https://man.freebsd.org/cgi/man.cgi?query=lprm&amp;sektion=1&amp;format=html">lprm(1)</a> is used to remove print jobs. Normal users are only allowed to remove their own jobs. <code>root</code> can remove any or all jobs.</p>
</div>
<div class="paragraph">
<p>Remove all pending jobs from a printer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># lprm -Plp -</span>
dfA002smithy dequeued
cfA002smithy dequeued
dfA003smithy dequeued
cfA003smithy dequeued
dfA004smithy dequeued
cfA004smithy dequeued</code></pre>
</div>
</div>
<div class="paragraph">
<p>Remove a single job from a printer. <a href="https://man.freebsd.org/cgi/man.cgi?query=lpq&amp;sektion=1&amp;format=html">lpq(1)</a> is used to find the job number.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>lpq
Rank   Owner      Job  Files                                 Total Size
1st    jsmith     5    <span class="o">(</span>standard input<span class="o">)</span>                      12188 bytes

<span class="gp">% </span>lprm -Plp 5
dfA005smithy dequeued
cfA005smithy dequeued</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="printing-lpd-monitor-lpc">11.5.5.3. <a href="https://man.freebsd.org/cgi/man.cgi?query=lpc&amp;sektion=8&amp;format=html">lpc(8)</a><a class="anchor" href="#printing-lpd-monitor-lpc"></a></h5>
<div class="paragraph">
<p><a href="https://man.freebsd.org/cgi/man.cgi?query=lpc&amp;sektion=8&amp;format=html">lpc(8)</a> is used to check and modify printer status. <code>lpc</code> is followed by a command and an optional printer name. <code>all</code> can be used instead of a specific printer name, and the command will be applied to all printers. Normal users can view status with <a href="https://man.freebsd.org/cgi/man.cgi?query=lpc&amp;sektion=8&amp;format=html">lpc(8)</a>. Only <code>root</code> can use commands which modify printer status.</p>
</div>
<div class="paragraph">
<p>Show the status of all printers:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>lpc status all
lp:
	queuing is enabled
	printing is enabled
	1 entry <span class="k">in </span>spool area
	printer idle
laser:
	queuing is enabled
	printing is enabled
	1 entry <span class="k">in </span>spool area
	waiting <span class="k">for </span>laser to come up</code></pre>
</div>
</div>
<div class="paragraph">
<p>Prevent a printer from accepting new jobs, then begin accepting new jobs again:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># lpc disable lp</span>
lp:
	queuing disabled
<span class="c"># lpc enable lp</span>
lp:
	queuing enabled</code></pre>
</div>
</div>
<div class="paragraph">
<p>Stop printing, but continue to accept new jobs. Then begin printing again:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># lpc stop lp</span>
lp:
	printing disabled
<span class="c"># lpc start lp</span>
lp:
	printing enabled
	daemon started</code></pre>
</div>
</div>
<div class="paragraph">
<p>Restart a printer after some error condition:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># lpc restart lp</span>
lp:
	no daemon to abort
	printing enabled
	daemon restarted</code></pre>
</div>
</div>
<div class="paragraph">
<p>Turn the print queue off and disable printing, with a message to explain the problem to users:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># lpc down lp Repair parts will arrive on Monday</span>
lp:
	printer and queuing disabled
	status message is now: Repair parts will arrive on Monday</code></pre>
</div>
</div>
<div class="paragraph">
<p>Re-enable a printer that is down:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># lpc up lp</span>
lp:
	printing enabled
	daemon started</code></pre>
</div>
</div>
<div class="paragraph">
<p>See <a href="https://man.freebsd.org/cgi/man.cgi?query=lpc&amp;sektion=8&amp;format=html">lpc(8)</a> for more commands and options.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="printing-lpd-shared">11.5.6. Shared Printers<a class="anchor" href="#printing-lpd-shared"></a></h4>
<div class="paragraph">
<p>Printers are often shared by multiple users in businesses and schools. Additional features are provided to make sharing printers more convenient.</p>
</div>
<div class="sect4">
<h5 id="printing-shared-aliases">11.5.6.1. Aliases<a class="anchor" href="#printing-shared-aliases"></a></h5>
<div class="paragraph">
<p>The printer name is set in the first line of the entry in <span class="filename">/etc/printcap</span>. Additional names, or <em>aliases</em>, can be added after that name. Aliases are separated from the name and each other by vertical bars:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>lp|repairsprinter|salesprinter:\</pre>
</div>
</div>
<div class="paragraph">
<p>Aliases can be used in place of the printer name. For example, users in the Sales department print to their printer with</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>lpr -Psalesprinter sales-report.txt</code></pre>
</div>
</div>
<div class="paragraph">
<p>Users in the Repairs department print to <em>their</em> printer with</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>lpr -Prepairsprinter repairs-report.txt</code></pre>
</div>
</div>
<div class="paragraph">
<p>All of the documents print on that single printer. When the Sales department grows enough to need their own printer, the alias can be removed from the shared printer entry and used as the name of a new printer. Users in both departments continue to use the same commands, but the Sales documents are sent to the new printer.</p>
</div>
</div>
<div class="sect4">
<h5 id="printing-shared-headers">11.5.6.2. Header Pages<a class="anchor" href="#printing-shared-headers"></a></h5>
<div class="paragraph">
<p>It can be difficult for users to locate their documents in the stack of pages produced by a busy shared printer. <em>Header pages</em> were created to solve this problem. A header page with the user name and document name is printed before each print job. These pages are also sometimes called <em>banner</em> or <em>separator</em> pages.</p>
</div>
<div class="paragraph">
<p>Enabling header pages differs depending on whether the printer is connected directly to the computer with a <code>USB</code>, parallel, or serial cable, or is connected remotely over a network.</p>
</div>
<div class="paragraph">
<p>Header pages on directly-connected printers are enabled by removing the <code>:sh:\</code> (Suppress Header) line from the entry in <span class="filename">/etc/printcap</span>. These header pages only use line feed characters for new lines. Some printers will need the <span class="filename">/usr/share/examples/printing/hpif</span> filter to prevent stairstepped text. The filter configures <code>PCL</code> printers to print both carriage returns and line feeds when a line feed is received.</p>
</div>
<div class="paragraph">
<p>Header pages for network printers must be configured on the printer itself. Header page entries in <span class="filename">/etc/printcap</span> are ignored. Settings are usually available from the printer front panel or a configuration web page accessible with a web browser.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="printing-lpd-references">11.5.7. References<a class="anchor" href="#printing-lpd-references"></a></h4>
<div class="paragraph">
<p>Example files: <span class="filename">/usr/share/examples/printing/</span>.</p>
</div>
<div class="paragraph">
<p>The <em>4.3BSD Line Printer Spooler Manual</em>, <span class="filename">/usr/share/doc/smm/07.lpd/paper.ascii.gz</span>.</p>
</div>
<div class="paragraph">
<p>Manual pages: <a href="https://man.freebsd.org/cgi/man.cgi?query=printcap&amp;sektion=5&amp;format=html">printcap(5)</a>, <a href="https://man.freebsd.org/cgi/man.cgi?query=lpd&amp;sektion=8&amp;format=html">lpd(8)</a>, <a href="https://man.freebsd.org/cgi/man.cgi?query=lpr&amp;sektion=1&amp;format=html">lpr(1)</a>, <a href="https://man.freebsd.org/cgi/man.cgi?query=lpc&amp;sektion=8&amp;format=html">lpc(8)</a>, <a href="https://man.freebsd.org/cgi/man.cgi?query=lprm&amp;sektion=1&amp;format=html">lprm(1)</a>, <a href="https://man.freebsd.org/cgi/man.cgi?query=lpq&amp;sektion=1&amp;format=html">lpq(1)</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="printing-other">11.6. Other Printing Systems<a class="anchor" href="#printing-other"></a></h3>
<div class="paragraph">
<p>Several other printing systems are available in addition to the built-in <a href="https://man.freebsd.org/cgi/man.cgi?query=lpd&amp;sektion=8&amp;format=html">lpd(8)</a>. These systems offer support for other protocols or additional features.</p>
</div>
<div class="sect3">
<h4 id="printing-other-cups">11.6.1. CUPS (Common UNIX® Printing System)<a class="anchor" href="#printing-other-cups"></a></h4>
<div class="paragraph">
<p>CUPS is a popular printing system available on many operating systems. Using CUPS on FreeBSD is documented in a separate article: <a href="{cups}">CUPS</a></p>
</div>
</div>
<div class="sect3">
<h4 id="printing-other-hplip">11.6.2. HPLIP<a class="anchor" href="#printing-other-hplip"></a></h4>
<div class="paragraph">
<p>Hewlett Packard provides a printing system that supports many of their inkjet and laser printers. The port is <a class="package" href="https://cgit.freebsd.org/ports/tree/print/hplip/">print/hplip</a>. The main web page is at <a href="https://developers.hp.com/hp-linux-imaging-and-printing" class="bare">https://developers.hp.com/hp-linux-imaging-and-printing</a>. The port handles all the installation details on FreeBSD. Configuration information is shown at <a href="https://developers.hp.com/hp-linux-imaging-and-printing/install" class="bare">https://developers.hp.com/hp-linux-imaging-and-printing/install</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="printing-other-lprng">11.6.3. LPRng<a class="anchor" href="#printing-other-lprng"></a></h4>
<div class="paragraph">
<p>LPRng was developed as an enhanced alternative to <a href="https://man.freebsd.org/cgi/man.cgi?query=lpd&amp;sektion=8&amp;format=html">lpd(8)</a>. The port is <a class="package" href="https://cgit.freebsd.org/ports/tree/sysutils/LPRng/">sysutils/LPRng</a>. For details and documentation, see <a href="http://www.lprng.com/" class="bare">http://www.lprng.com/</a>.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="linuxemu">Chapter 12. Linux Binary Compatibility<a class="anchor" href="#linuxemu"></a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="linuxemu-synopsis">12.1. Synopsis<a class="anchor" href="#linuxemu-synopsis"></a></h3>
<div class="paragraph">
<p>FreeBSD provides <strong>optional</strong> binary compatibility with Linux®, commonly referred to as Linuxulator, allowing users to install and run unmodified Linux binaries. It is available for the x86 (both 32 and 64 bit) and AArch64 architectures. Some Linux-specific operating system features are not yet supported; this mostly happens with functionality specific to hardware or related to system management, such as cgroups or namespaces.</p>
</div>
<div class="paragraph">
<p>Before reading this chapter, you should:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Know how to install <a href="./#ports">additional third-party software</a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>After reading this chapter, you will know:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>How to enable Linux binary compatibility on a FreeBSD system.</p>
</li>
<li>
<p>How to install additional Linux shared libraries.</p>
</li>
<li>
<p>How to install Linux applications on a FreeBSD system.</p>
</li>
<li>
<p>The implementation details of Linux compatibility in FreeBSD.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="linuxemu-lbc-install">12.2. Configuring Linux Binary Compatibility<a class="anchor" href="#linuxemu-lbc-install"></a></h3>
<div class="paragraph">
<p>By default, <a href="https://man.freebsd.org/cgi/man.cgi?query=linux&amp;sektion=4&amp;format=html">linux(4)</a> binary compatibility is not enabled.</p>
</div>
<div class="paragraph">
<p>To enable the Linux ABI at boot time, execute the following command:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre># sysrc linux_enable=&#34;YES&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>Once enabled, it can be started without rebooting executing the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># service linux start</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This is enough for statically linked Linux binaries to work.</p>
</div>
<div class="paragraph">
<p>The Linux service will load necessary kernel modules and mount filesystems expected by Linux applications under <span class="filename">/compat/linux</span>. They can be started in the same way native FreeBSD binaries can; they behave almost exactly like native processes and can be traced and debugged the usual way.</p>
</div>
<div class="paragraph">
<p>The current content of <span class="filename">/compat/linux</span> can be checked executing the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ls -l /compat/linux/</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should be similar to the following:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>total 1
dr-xr-xr-x  13 root  wheel  512 Apr 11 19:12 dev
dr-xr-xr-x   1 root  wheel    0 Apr 11 21:03 proc
dr-xr-xr-x   1 root  wheel    0 Apr 11 21:03 sys</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="linux-userlands">12.3. Linux userlands<a class="anchor" href="#linux-userlands"></a></h3>
<div class="paragraph">
<p>Linux software requires more than just an ABI to work. In order to run Linux software a Linux userland must be installed first.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If all that is wanted is to run some software already included in the Ports tree, it can be installed via package manager and <a href="https://man.freebsd.org/cgi/man.cgi?query=pkg&amp;sektion=8&amp;format=html">pkg(8)</a> will automatically setup the required Linux userland.</p>
</div>
<div class="paragraph">
<p>For example, to install Sublime Text 4, along with all the Linux libraries it depends on, run this command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install linux-sublime-text4</span></code></pre>
</div>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="sect3">
<h4 id="linuxemu-packages">12.3.1. CentOS Base System from FreeBSD Packages<a class="anchor" href="#linuxemu-packages"></a></h4>
<div class="paragraph">
<p>To install the CentOS userland execute the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install linux_base-c7</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><a class="package" href="https://cgit.freebsd.org/ports/tree/emulators/linux_base-c7/">emulators/linux_base-c7</a> will place the base system derived from CentOS 7 into <span class="filename">/compat/linux</span>.</p>
</div>
<div class="paragraph">
<p>After installing the package, the contents of <span class="filename">/compat/linux</span> can be verified by running the following command to check that the CentOS userland has been installed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ls -l /compat/linux/</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should be similar to the following:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>total 30
lrwxr-xr-x   1 root  wheel    7 Apr 11  2018 bin -&gt; usr/bin
drwxr-xr-x  13 root  wheel  512 Apr 11 21:10 dev
drwxr-xr-x  25 root  wheel   64 Apr 11 21:10 etc
lrwxr-xr-x   1 root  wheel    7 Apr 11  2018 lib -&gt; usr/lib
lrwxr-xr-x   1 root  wheel    9 Apr 11  2018 lib64 -&gt; usr/lib64
drwxr-xr-x   2 root  wheel    2 Apr 11 21:10 opt
dr-xr-xr-x   1 root  wheel    0 Apr 11 21:25 proc
lrwxr-xr-x   1 root  wheel    8 Feb 18 02:10 run -&gt; /var/run
lrwxr-xr-x   1 root  wheel    8 Apr 11  2018 sbin -&gt; usr/sbin
drwxr-xr-x   2 root  wheel    2 Apr 11 21:10 srv
dr-xr-xr-x   1 root  wheel    0 Apr 11 21:25 sys
drwxr-xr-x   8 root  wheel    9 Apr 11 21:10 usr
drwxr-xr-x  16 root  wheel   17 Apr 11 21:10 var</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="linuxemu-debootstrap">12.3.2. Debian / Ubuntu Base System with debootstrap<a class="anchor" href="#linuxemu-debootstrap"></a></h4>
<div class="paragraph">
<p>An alternative way of providing Linux shared libraries is by using <a class="package" href="https://cgit.freebsd.org/ports/tree/sysutils/debootstrap/">sysutils/debootstrap</a>. This has the advantage of providing a full Debian or Ubuntu distribution.</p>
</div>
<div class="paragraph">
<p>To install debootstrap execute the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install debootstrap</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><a href="https://man.freebsd.org/cgi/man.cgi?query=debootstrap&amp;sektion=8&amp;format=html">debootstrap(8)</a> needs <a href="https://man.freebsd.org/cgi/man.cgi?query=linux&amp;sektion=4&amp;format=html">linux(4)</a> ABI enabled. Once enabled, execute the following command to install Ubuntu or Debian in <span class="filename">/compat/ubuntu</span>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># debootstrap focal /compat/ubuntu</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>While it is technically possible to install into <span class="filename">/compat/linux</span> instead, it’s discouraged due to possible clashes with CentOS-based packages. Instead, derive the directory name from the distribution or version name, e.g., <span class="filename">/compat/ubuntu</span>.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>The output should be similar to the following:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>I: Retrieving InRelease
I: Checking Release signature
I: Valid Release signature (key id F6ECB3762474EDA9D21B7022871920D1991BC93C)
I: Retrieving Packages
I: Validating Packages
I: Resolving dependencies of required packages...
I: Resolving dependencies of base packages...
I: Checking component main on http://archive.ubuntu.com/ubuntu...
[...]
I: Configuring console-setup...
I: Configuring kbd...
I: Configuring ubuntu-minimal...
I: Configuring libc-bin...
I: Configuring ca-certificates...
I: Base system installed successfully.</pre>
</div>
</div>
<div class="paragraph">
<p>Then set up mounts in <span class="filename">/etc/fstab</span>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If the contents of the home directory should be shared and to be able to run X11 applications, <span class="filename">/home</span> and <span class="filename">/tmp</span> should be mounted in the linux compat area using <a href="https://man.freebsd.org/cgi/man.cgi?query=nullfs&amp;sektion=5&amp;format=html">nullfs(5)</a> for loopback.</p>
</div>
<div class="paragraph">
<p>The following example can be added to <span class="filename">/etc/fstab</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre># Device        Mountpoint              FStype          Options                      Dump    Pass#
devfs           /compat/ubuntu/dev      devfs           rw,late                      0       0
tmpfs           /compat/ubuntu/dev/shm  tmpfs           rw,late,size=1g,mode=1777    0       0
fdescfs         /compat/ubuntu/dev/fd   fdescfs         rw,late,linrdlnk             0       0
linprocfs       /compat/ubuntu/proc     linprocfs       rw,late                      0       0
linsysfs        /compat/ubuntu/sys      linsysfs        rw,late                      0       0
/tmp            /compat/ubuntu/tmp      nullfs          rw,late                      0       0
/home           /compat/ubuntu/home     nullfs          rw,late                      0       0</pre>
</div>
</div>
<div class="paragraph">
<p>Then execute <a href="https://man.freebsd.org/cgi/man.cgi?query=mount&amp;sektion=8&amp;format=html">mount(8)</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># mount -al</span></code></pre>
</div>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>To access the system using <a href="https://man.freebsd.org/cgi/man.cgi?query=chroot&amp;sektion=8&amp;format=html">chroot(8)</a> execute the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># chroot /compat/ubuntu /bin/bash</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then <a href="https://man.freebsd.org/cgi/man.cgi?query=uname&amp;sektion=1&amp;format=html">uname(1)</a> can be executed to check the Linux environment:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># uname -s -r -m</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should be similar to the following:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>Linux 3.17.0 x86_64</pre>
</div>
</div>
<div class="paragraph">
<p>Once inside the chroot, the system behaves as in a normal Ubuntu installation While systemd doesn’t work, the <a href="https://man.freebsd.org/cgi/man.cgi?query=service&amp;sektion=8&amp;format=html">service(8)</a> command works as usual.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>To add the package repositories missing from defaults edit the file <span class="filename">/compat/ubuntu/etc/apt/sources.list</span>.</p>
</div>
<div class="paragraph">
<p>For amd64 the following example can be used:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>deb http://archive.ubuntu.com/ubuntu focal main universe restricted multiverse
deb http://security.ubuntu.com/ubuntu/ focal-security universe multiverse restricted main
deb http://archive.ubuntu.com/ubuntu focal-backports universe multiverse restricted main
deb http://archive.ubuntu.com/ubuntu focal-updates universe multiverse restricted main</pre>
</div>
</div>
<div class="paragraph">
<p>For arm64 this other example can be used:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>deb http://ports.ubuntu.com/ubuntu-ports bionic main universe restricted multiverse</pre>
</div>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="linuxemu-advanced">12.4. Advanced Topics<a class="anchor" href="#linuxemu-advanced"></a></h3>
<div class="paragraph">
<p>A list of all Linux-related <a href="https://man.freebsd.org/cgi/man.cgi?query=sysctl&amp;sektion=8&amp;format=html">sysctl(8)</a> knobs can be found in <a href="https://man.freebsd.org/cgi/man.cgi?query=linux&amp;sektion=4&amp;format=html">linux(4)</a>.</p>
</div>
<div class="paragraph">
<p>Some applications require specific filesystems to be mounted.</p>
</div>
<div class="paragraph">
<p>This is normally handled by the <span class="filename">/etc/rc.d/linux</span> script but can be disabled at boot executing the following command:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>sysrc linux_mounts_enable=&#34;NO&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>Filesystems mounted by the rc script will not work for Linux processes inside chroots or jails; if needed, configure them in <span class="filename">/etc/fstab</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>devfs      /compat/linux/dev      devfs      rw,late                    0  0
tmpfs      /compat/linux/dev/shm  tmpfs      rw,late,size=1g,mode=1777  0  0
fdescfs    /compat/linux/dev/fd   fdescfs    rw,late,linrdlnk           0  0
linprocfs  /compat/linux/proc     linprocfs  rw,late                    0  0
linsysfs   /compat/linux/sys      linsysfs   rw,late                    0  0</pre>
</div>
</div>
<div class="paragraph">
<p>Since the Linux binary compatibility layer has gained support for running both 32- and 64-bit Linux binaries, it is no longer possible to link the emulation functionality statically into a custom kernel.</p>
</div>
<div class="sect3">
<h4 id="linuxemu-libs-manually">12.4.1. Installing Additional Libraries Manually<a class="anchor" href="#linuxemu-libs-manually"></a></h4>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>For base system subdirectories created with <a href="https://man.freebsd.org/cgi/man.cgi?query=debootstrap&amp;sektion=8&amp;format=html">debootstrap(8)</a>, use the instructions above instead.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>If a Linux application complains about missing shared libraries after configuring Linux binary compatibility, determine which shared libraries the Linux binary needs and install them manually.</p>
</div>
<div class="paragraph">
<p>From a Linux system using the same CPU architecture, <code>ldd</code> can be used to determine which shared libraries the application needs.</p>
</div>
<div class="paragraph">
<p>For example, to check which shared libraries <code>linuxdoom</code> needs, run this command from a Linux system that has Doom installed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>ldd linuxdoom</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should be similar to the following:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>libXt.so.3 (DLL Jump 3.1) =&gt; /usr/X11/lib/libXt.so.3.1.0
libX11.so.3 (DLL Jump 3.1) =&gt; /usr/X11/lib/libX11.so.3.1.0
libc.so.4 (DLL Jump 4.5pl26) =&gt; /lib/libc.so.4.6.29</pre>
</div>
</div>
<div class="paragraph">
<p>Then, copy all the files in the last column of the output from the Linux system into <span class="filename">/compat/linux</span> on the FreeBSD system. Once copied, create symbolic links to the names in the first column.</p>
</div>
<div class="paragraph">
<p>This example will result in the following files on the FreeBSD system:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>/compat/linux/usr/X11/lib/libXt.so.3.1.0
/compat/linux/usr/X11/lib/libXt.so.3 -&gt; libXt.so.3.1.0
/compat/linux/usr/X11/lib/libX11.so.3.1.0
/compat/linux/usr/X11/lib/libX11.so.3 -&gt; libX11.so.3.1.0
/compat/linux/lib/libc.so.4.6.29
/compat/linux/lib/libc.so.4 -&gt; libc.so.4.6.29</pre>
</div>
</div>
<div class="paragraph">
<p>If a Linux shared library already exists with a matching major revision number to the first column of the <code>ldd</code> output, it does not need to be copied to the file named in the last column, as the existing library should work. It is advisable to copy the shared library if it is a newer version, though. The old one can be removed, as long as the symbolic link points to the new one.</p>
</div>
<div class="paragraph">
<p>For example, these libraries already exist on the FreeBSD system:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>/compat/linux/lib/libc.so.4.6.27
/compat/linux/lib/libc.so.4 -&gt; libc.so.4.6.27</pre>
</div>
</div>
<div class="paragraph">
<p>and <code>ldd</code> indicates that a binary requires a later version:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>libc.so.4 (DLL Jump 4.5pl26) -&gt; libc.so.4.6.29</pre>
</div>
</div>
<div class="paragraph">
<p>Since the existing library is only one or two versions out of date in the last digit, the program should still work with the slightly older version. However, it is safe to replace the existing <span class="filename">libc.so</span> with the newer version:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>/compat/linux/lib/libc.so.4.6.29
/compat/linux/lib/libc.so.4 -&gt; libc.so.4.6.29</pre>
</div>
</div>
<div class="paragraph">
<p>Generally, one will need to look for the shared libraries that Linux binaries depend on only the first few times that a Linux program is installed on FreeBSD. After a while, there will be a sufficient set of Linux shared libraries on the system to be able to run newly installed Linux binaries without any extra work.</p>
</div>
</div>
<div class="sect3">
<h4 id="_branding_linux_elf_binaries">12.4.2. Branding Linux ELF Binaries<a class="anchor" href="#_branding_linux_elf_binaries"></a></h4>
<div class="paragraph">
<p>The FreeBSD kernel uses several methods to determine if the binary to be executed is a Linux one: it checks the brand in the ELF file header, looks for known ELF interpreter paths and checks ELF notes; finally, by default, unbranded ELF executables are assumed to be Linux anyway.</p>
</div>
<div class="paragraph">
<p>Should all those methods fail, an attempt to execute the binary might result in error message:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>./my-linux-elf-binary</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should be similar to the following:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>ELF binary type not known
Abort</pre>
</div>
</div>
<div class="paragraph">
<p>To help the FreeBSD kernel distinguish between a FreeBSD ELF binary and a Linux binary, use <a href="https://man.freebsd.org/cgi/man.cgi?query=brandelf&amp;sektion=1&amp;format=html">brandelf(1)</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>brandelf -t Linux my-linux-elf-binary</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_installing_a_linux_rpm_based_application">12.4.3. Installing a Linux RPM Based Application<a class="anchor" href="#_installing_a_linux_rpm_based_application"></a></h4>
<div class="paragraph">
<p>To install a Linux RPM-based application, first install the <a class="package" href="https://cgit.freebsd.org/ports/tree/archivers/rpm4/">archivers/rpm4</a> package or port. Once installed, <code>root</code> can use this command to install a <span class="filename">.rpm</span>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># cd /compat/linux</span>
<span class="c"># rpm2cpio &lt; /path/to/linux.archive.rpm | cpio -id</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If necessary, <code>brandelf</code> the installed ELF binaries. Note that this will prevent a clean uninstall.</p>
</div>
</div>
<div class="sect3">
<h4 id="_configuring_the_hostname_resolver">12.4.4. Configuring the Hostname Resolver<a class="anchor" href="#_configuring_the_hostname_resolver"></a></h4>
<div class="paragraph">
<p>If DNS does not work or this error appears:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>resolv+: &#34;bind&#34; is an invalid keyword resolv+:
&#34;hosts&#34; is an invalid keyword</pre>
</div>
</div>
<div class="paragraph">
<p>configure <span class="filename">/compat/linux/etc/host.conf</span> as follows:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>order hosts, bind
multi on</pre>
</div>
</div>
<div class="paragraph">
<p>This specifies that <span class="filename">/etc/hosts</span> is searched first and DNS is searched second. When <span class="filename">/compat/linux/etc/host.conf</span> does not exist, Linux applications use <span class="filename">/etc/host.conf</span> in the host system but they complain since that file does not exist in FreeBSD. Remove <code>bind</code> if a name server is not configured using <span class="filename">/etc/resolv.conf</span>.</p>
</div>
</div>
<div class="sect3">
<h4 id="linuxemu-misc">12.4.5. Miscellaneous<a class="anchor" href="#linuxemu-misc"></a></h4>
<div class="paragraph">
<p>More information on how binary compatibility works with Linux® can be found in the article <a href="{linux-emulation}">Linux emulation in FreeBSD</a>.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="wine">Chapter 13. WINE<a class="anchor" href="#wine"></a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="wine-synopsis">13.1. Synopsis<a class="anchor" href="#wine-synopsis"></a></h3>
<div class="paragraph">
<p><a href="https://www.winehq.org/">WINE</a>, which stands for Wine Is Not an Emulator, is technically a software translation layer. It enables to install and run some software written for Windows® on FreeBSD (and other) systems.</p>
</div>
<div class="paragraph">
<p>It operates by intercepting system calls, or requests from the software to the operating system, and translating them from Windows® calls to calls that FreeBSD understands. It will also translate any responses as needed into what the Windows® software is expecting. So in some ways, it <em>emulates</em> a Windows® environment, in that it provides many of the resources Windows® applications are expecting.</p>
</div>
<div class="paragraph">
<p>However, it is not an emulator in the traditional sense. Many of these solutions operate by constructing an entire other computer using software processes in place of hardware. Virtualization (such as that provided by the <a class="package" href="https://cgit.freebsd.org/ports/tree/emulators/qemu/">emulators/qemu</a> port) operates in this way. One of the benefits of this approach is the ability to install a full version of the OS in question to the emulator. It means that the environment will not look any different to applications than a real machine, and chances are good that everything will work on it. The downside to this approach is the fact that software acting as hardware is inherently slower than actual hardware. The computer built in software (called the <em>guest</em>) requires resources from the real machine (the <em>host</em>), and holds on to those resources for as long as it is running.</p>
</div>
<div class="paragraph">
<p>The WINE Project, on the other hand, is much lighter on system’s resources. It will translate system calls on the fly, so while it is difficult to be as fast as a real Windows® computer, it can come very close. On the other hand, WINE is trying to keep up with a moving target in terms of all the different system calls and other functionality it needs to support. As a result there may be applications that do not work as expected on WINE, will not work at all, or will not even install to begin with.</p>
</div>
<div class="paragraph">
<p>At the end of the day, WINE provides another option to try to get a particular Windows® software program running on FreeBSD. It can always serve as the first option which, if successful, offers a good experience without unnecessarily depleting the host FreeBSD system’s resources.</p>
</div>
<div class="paragraph">
<p>This chapter will describe:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>How to install WINE on a FreeBSD system.</p>
</li>
<li>
<p>How WINE operates, and how it is different from other alternatives like virtualizaton.</p>
</li>
<li>
<p>How to fine-tune WINE to the specific needs of some applications.</p>
</li>
<li>
<p>How to install GUI helpers for WINE.</p>
</li>
<li>
<p>Common tips and solutions for on FreeBSD.</p>
</li>
<li>
<p>Considerations for WINE on FreeBSD in terms of the multi-user environment.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Before reading this chapter, it will be useful to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Understand the <a href="./#basics">basics of UNIX® and FreeBSD</a>.</p>
</li>
<li>
<p>Know how to <a href="./#bsdinstall">install FreeBSD</a>.</p>
</li>
<li>
<p>Know how to <a href="./#advanced-networking">set up a network connection</a>.</p>
</li>
<li>
<p>Know how to <a href="./#ports">install additional third-party software</a>.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="wine-overview-concepts">13.2. WINE Overview &amp; Concepts<a class="anchor" href="#wine-overview-concepts"></a></h3>
<div class="paragraph">
<p>WINE is a complex system, so before running it on a FreeBSD system it is worth gaining an understanding of what it is and how it works.</p>
</div>
<div class="sect3">
<h4 id="what-is-wine">13.2.1. What is WINE?<a class="anchor" href="#what-is-wine"></a></h4>
<div class="paragraph">
<p>As mentioned in the <a href="#wine-synopsis">Synopsis</a> for this chapter, WINE is a compatibility layer that allows Windows® applications to run on other operating systems. In theory, it means these programs should run on systems like FreeBSD, macOS, and Android.</p>
</div>
<div class="paragraph">
<p>When WINE runs a Windows® executable, two things occur:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Firstly, WINE implements an environment that mimics that of various versions of Windows®. For example, if an application requests access to a resource such as RAM, WINE has a memory interface that looks and acts (as far as the application is concerned) like Windows®.</p>
</li>
<li>
<p>Then, once that application makes use of that interface, WINE takes the incoming request for space in memory and translates it to something compatible with the host system. In the same way when the application retrieves that data, WINE facilitates fetching it from the host system and passing it back to the Windows® application.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="wine-and-the-os-system">13.2.2. WINE and the FreeBSD System<a class="anchor" href="#wine-and-the-os-system"></a></h4>
<div class="paragraph">
<p>Installing WINE on a FreeBSD system will entail a few different components:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>FreeBSD applications for tasks such as running the Windows® executables, configuring the WINE sub-system, or compiling programs with WINE support.</p>
</li>
<li>
<p>A large number of libraries that implement the core functions of Windows® (for example <span class="filename">/lib/wine/api-ms-core-memory-l1-1-1.dll.so</span>, which is part of the aforementioned memory interface).</p>
</li>
<li>
<p>A number of Windows® executables, which are (or mimic) common utilities (such as <span class="filename">/lib/wine/notepad.exe.so</span>, which provides the standard Windows® text editor).</p>
</li>
<li>
<p>Additional Windows® assets, in particular fonts (like the Tahoma font, which is stored in <span class="filename">share/wine/fonts/tahoma.ttf</span> in the install root).</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="graphical-versus-text-modeterminal-programs-in-wine">13.2.3. Graphical Versus Text Mode/Terminal Programs in WINE<a class="anchor" href="#graphical-versus-text-modeterminal-programs-in-wine"></a></h4>
<div class="paragraph">
<p>As an operating system where terminal utilities are &#34;first-class citizens,&#34; it is natural to assume that WINE will contain extensive support for text-mode program. However, the majority of applications for Windows®, especially the most popular ones, are designed with a graphical user interface (GUI) in mind. Therefore, WINE’s utilities are designed by default to launch graphical programs.</p>
</div>
<div class="paragraph">
<p>However, there are three methods available to run these so-called Console User Interface (CUI) programs:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <em>Bare Streams</em> approach will display the output directly to standard output.</p>
</li>
<li>
<p>The <em>wineconsole</em> utility can be used with either the <em>user</em> or <em>curses</em> backed to utilize some of the enhancements the WINE system provides for CUI applications.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These approaches are described in greater detail on the <a href="https://wiki.winehq.org/Wine_User%27s_Guide#Text_mode_programs_.28CUI:_Console_User_Interface.29">WINE Wiki</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="wine-derivative-projects">13.2.4. WINE Derivative Projects<a class="anchor" href="#wine-derivative-projects"></a></h4>
<div class="paragraph">
<p>WINE itself is a mature open source project, so it is little surprise it is used as the foundation of more complex solutions.</p>
</div>
<div class="sect4">
<h5 id="commercial-wine-implementations">13.2.4.1. Commercial WINE Implementations<a class="anchor" href="#commercial-wine-implementations"></a></h5>
<div class="paragraph">
<p>A number of companies have taken WINE and made it a core of their own, proprietary products (WINE’s LGPL license permits this). Two of the most famous of these are as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Codeweavers CrossOver</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This solution provides a simplified &#34;one-click&#34; installation of WINE, which contains additional enhancements and optimizations (although the company contributes many of these back upstream to the WINE project). One area of focus for Codeweavers is to make the most popular applications install and run smoothly.</p>
</div>
<div class="paragraph">
<p>While the company once produced a native FreeBSD version of their CrossOver solution, it appears to have long been abandoned. While some resources (such as a <a href="https://www.codeweavers.com/compatibility/crossover/forum/freebsd">dedicated forum</a>) are still present, they also have seen no activity for some time.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Steam Proton</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Gaming company Steam also uses WINE to enable Windows® games to install and run on other systems. it is primary target is Linux-based systems, though some support exists for macOS as well.</p>
</div>
<div class="paragraph">
<p>While Steam does not offer a native FreeBSD client, there are several options for using the Linux® client using FreeBSD’s Linux Compatibility Layer.</p>
</div>
</div>
<div class="sect4">
<h5 id="wine-companion-programs">13.2.4.2. WINE Companion Programs<a class="anchor" href="#wine-companion-programs"></a></h5>
<div class="paragraph">
<p>In addition to proprietary offerings, other projects have released applications designed to work in tandem with the standard, open source version of WINE. The goals for these can range from making installation easier to offering easy ways to get popular software installed.</p>
</div>
<div class="paragraph">
<p>These solutions are covered in greater detail in the later section on <a href="#wine-management-guis">GUI frontends</a>, and include the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>winetricks</p>
</li>
<li>
<p>Suyimazu</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="alternatives-to-wine">13.2.5. Alternatives to WINE<a class="anchor" href="#alternatives-to-wine"></a></h4>
<div class="paragraph">
<p>For FreeBSD users, some alternatives to using WINE are as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Dual-Booting: A straightforward option is to run desired Windows® applications natively on that OS. This of course means exiting FreeBSD in order to boot Windows®, so this method is not feasible if access to programs in both systems is required simultaneously.</p>
</li>
<li>
<p>Virtual Machines: Virtual Machines (VMs), as mentioned earlier in this chapter, are software processes that emulate full sets of hardware, on which additional operating systems (including Windows®) can be installed and run. Modern tools make VMs easy to create and manage, but this method comes at a cost. A good portion of the host systems resources must be allocated to each VM, and those resources cannot be reclaimed by the host as long as the VM is running. A few examples of VM managers include the open source solutions qemu, bhyve, and VirtualBox. See the chapter on <a href="#virtualization">Virtualization</a> for more detail.</p>
</li>
<li>
<p>Remote Access: Like many other UNIX®-like systems, FreeBSD can run a variety of applications enabling users to remotely access Windows® computers and use their programs or data. In addtion to clients such as xrdp that connect to the standard Windows® Remote Desktop Protocol, other open source standards such as vnc can also be used (provided a compatible server is present on the other side).</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="installing-wine-on-freebsd">13.3. Installing WINE on FreeBSD<a class="anchor" href="#installing-wine-on-freebsd"></a></h3>
<div class="paragraph">
<p>WINE can be installed via the pkg tool, or by compiling the port(s).</p>
</div>
<div class="sect3">
<h4 id="wine-prerequistes">13.3.1. WINE Prerequistes<a class="anchor" href="#wine-prerequistes"></a></h4>
<div class="paragraph">
<p>Before installing WINE itself, it is useful to have the following pre-requisites installed.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A GUI</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Most Windows® programs are expecting to have a graphical user interface available. If WINE is installed without one present, its dependencies will include the Wayland compositor, and so a GUI will be installed along with WINE. But it is useful to have the GUI of choice installed, configured, and working correctly before installing WINE.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>wine-gecko</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The Windows® operating system has for some time had a default web browser pre-installed: Internet Explorer. As a result, some applications work under the assumption that there will always be something capable of displaying web pages. In order to provide this functionality, the WINE layer includes a web browser component using the Mozilla project’s Gecko engine. When WINE is first launched it will offer to download and install this, and there are reasons users might want it do so (these will be covered in a later chapter). But they can also install it prior to installing WINE, or alongside the install of WINE proper.</p>
</div>
<div class="paragraph">
<p>Install this package with the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install wine-gecko</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternately, compile the port with the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># cd /usr/ports/emulator/wine-gecko</span>
<span class="c"># make install</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>wine-mono</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This port installs the MONO framework, an open source implementation of Microsoft’s .NET. Including this with the WINE installation will make it that much more likely that any applications written in .NET will install and run on the system.</p>
</div>
<div class="paragraph">
<p>To install the package:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install wine-mono</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To compile from the ports collection:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># cd /usr/ports/emulator/wine-mono</span>
<span class="c"># make install</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="installing-wine">13.3.2. Installing WINE via FreeBSD Package Repositories<a class="anchor" href="#installing-wine"></a></h4>
<div class="paragraph">
<p>With the pre-requisites in place, install WINE via package with the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install wine</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternately compile the WINE sub-system from source with the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># cd /usr/ports/emulator/wine</span>
<span class="c"># make install</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="thirtytwo-vs-sixtyfour-bit-wine">13.3.3. Concerns of 32- Versus 64-Bit in WINE Installations<a class="anchor" href="#thirtytwo-vs-sixtyfour-bit-wine"></a></h4>
<div class="paragraph">
<p>Like most software, Windows® applications made the upgrade from the older 32-bit architecture to 64 bits. And most recent software is written for 64-bit operating systems, although modern OSes can sometimes continue to run older 32-bit programs as well. FreeBSD is no different, having had support for 64-bit since the 5.x series.</p>
</div>
<div class="paragraph">
<p>However, using old software no longer supported by default is a common use for emulators, and users commonly turn to WINE to play games and use other programs that do not run properly on modern hardware. Fortunately, FreeBSD can support all three scenarios:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>On modern, 64-bit machine and want to run 64-bit Windows® software, simply install the ports mentioned in the above sections. The ports system will automatically install the 64-bit version.</p>
</li>
<li>
<p>Alternately, users might have an older 32-bit machine that they do not want to run with its original, now non-supported software. They can install the 32-bit (i386) version of FreeBSD, then install the ports in the above sections.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="running-first-wine-program">13.4. Running a First WINE Program on FreeBSD<a class="anchor" href="#running-first-wine-program"></a></h3>
<div class="paragraph">
<p>Now that WINE is installed, the next step is to try it out by running a simple program. An easy way to do this is to download a self-contained application, i.e., one can simply unpack and run without any complex installation process.</p>
</div>
<div class="paragraph">
<p>So-called &#34;portable&#34; versions of applications are good choices for this test, as are programs that run with only a single executable file.</p>
</div>
<div class="sect3">
<h4 id="running-a-program-from-the-command-line">13.4.1. Running a Program from the Command Line<a class="anchor" href="#running-a-program-from-the-command-line"></a></h4>
<div class="paragraph">
<p>There are two different methods to launch a Windows program from the terminal. The first, and most straightforward is to navigate to the directory containing the program’s executable (<span class="filename">.EXE</span>) and issue the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>wine program.exe</code></pre>
</div>
</div>
<div class="paragraph">
<p>For applications that take command-line arguments, add them after the executable as usual:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>wine program2.exe -file file.txt</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternately, supply the full path to the executable to use it in a script, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>wine /home/user/bin/program.exe</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="running-a-program-from-a-gui">13.4.2. Running a Program from a GUI<a class="anchor" href="#running-a-program-from-a-gui"></a></h4>
<div class="paragraph">
<p>After installation graphical shells should be updated with new associations for Windows executable (<span class="filename">.EXE</span>) files. It will now be possible to browse the system using a file manager, and launch the Windows application in the same way as other files and programs (either a single- or double-click, depending on the desktop’s settings).</p>
</div>
<div class="paragraph">
<p>On most desktops, check to make sure this association is correct by right-clicking on the file, and looking for an entry in the context menu to open the file. One of the options (hopefully the default one) will be with the <strong>Wine Windows Program Loader</strong>, as shown in the below screenshot:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/wine/wine-run-np++-1.png" alt="wine run np++ 1"/>
</div>
</div>
<div class="paragraph">
<p>In the event the program does not run as expected, try launching it from the command line and review any messages displayed in the terminal to troubleshoot.</p>
</div>
<div class="paragraph">
<p>In the event WINE is not the default application for <span class="filename">.EXE</span> files after install, check the MIME associate for this extension in the current desktop environment, graphical shell, or file manager.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="configuring-wine-installation">13.5. Configuring WINE Installation<a class="anchor" href="#configuring-wine-installation"></a></h3>
<div class="paragraph">
<p>With an understanding of what WINE is and how it works at a high level, the next step to effectively using it on FreeBSD is becoming familiar with its configuration. The following sections will describe the key concept of the <em>WINE prefix</em>, and illustrate how it is used to control the behavior of applications run through WINE.</p>
</div>
<div class="sect3">
<h4 id="wine-prefixes">13.5.1. WINE Prefixes<a class="anchor" href="#wine-prefixes"></a></h4>
<div class="paragraph">
<p>A WINE <em>prefix</em> is a directory, usually located beneath the default location of <span class="filename">$HOME/.wine</span> though it can be located elsewhere. The prefix is a set of configurations and support files used by the wine to configure and run the Windows® environment a given application needs. By default, a brand new WINE installation will create the following structure when first launched by a user:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="filename">.update-timestamp</span>: contains the last modified date of <span class="filename">file /usr/share/wine/wine.inf</span>. It is used by WINE to determine if a prefix is out of date, and automatically update it if needed.</p>
</li>
<li>
<p><span class="filename">dosdevices/</span>: contains information on mappings of Windows® resources to resources on the host FreeBSD system. For example, after a new WINE installation, this should contain at least two entries which enable access to the FreeBSD filesystem using Windows®-style drive letters:</p>
<div class="ulist">
<ul>
<li>
<p><span class="filename">c:@</span>: A link to <span class="filename">drive_c</span> described below.</p>
</li>
<li>
<p><span class="filename">z:@</span>: A link to the root directory of the system.</p>
</li>
</ul>
</div>
</li>
<li>
<p><span class="filename">drive_c/</span>: emulates the main (i.e., <span class="filename">C:</span>) drive of a Windows® system. It contains a directory structure and associated files mirroring that of standard Windows® systems. A fresh WINE prefix will contain Windows® 10 directories such as <em>Users</em> and <em>Windows</em> that holds the OS itself. Furthermore, applications installed within a prefix will be located in either <em>Program Files</em> or <em>Program Files (x86)</em>, depending on their architecture.</p>
</li>
<li>
<p><span class="filename">system.reg</span>: This Registry file contains information on the Windows® installation, which in the case of WINE is the environment in <span class="filename">drive_c</span>.</p>
</li>
<li>
<p><span class="filename">user.reg</span>: This Registry file contains the current user’s personal configurations, made either by varous software or through the use of the Registry Editor.</p>
</li>
<li>
<p><span class="filename">userdef.reg</span>: This Registry file is a default set of configurations for newly-created users.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="creating-and-using-wine-prefixes">13.5.2. Creating and Using WINE Prefixes<a class="anchor" href="#creating-and-using-wine-prefixes"></a></h4>
<div class="paragraph">
<p>While WINE will create a default prefix in the user’s <span class="filename">$HOME/.wine/</span>, it is possible to set up multiple prefixes. There are a few reasons to do this:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The most common reason is to emulate different versions of Windows®, according to the compatibility needs of the software in question.</p>
</li>
<li>
<p>In addition, it is common to encounter software that does not work correctly in the default environment, and requires special configuration. it is useful to isolate these in their own, custom prefixes, so the changes do not impact other applications.</p>
</li>
<li>
<p>Similarly, copying the default or &#34;main&#34; prefix into a separate &#34;testing&#34; one in order to evaluate an application’s compatibility can reduce the chance of corruption.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Creating a prefix from the terminal requires the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span><span class="nv">WINEPREFIX</span><span class="o">=</span><span class="s2">&#34;/home/username/.wine-new&#34;</span> winecfg</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will run the <code>winecfg</code> program, which can be used to configure wine prefixes (more on this in a later section). But by providing a directory path value for the <code>WINEPREFIX</code> environment variable, a new prefix is created at that location if one does not already exist.</p>
</div>
<div class="paragraph">
<p>Supplying the same variable to the wine program will similarly cause the selected program to be run with the specified prefix:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span><span class="nv">WINEPREFIX</span><span class="o">=</span><span class="s2">&#34;/home/username/.wine-new&#34;</span> wine program.exe</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="configuring-wine-prefixes-with-winecfg">13.5.3. Configuring WINE Prefixes with winecfg<a class="anchor" href="#configuring-wine-prefixes-with-winecfg"></a></h4>
<div class="paragraph">
<p>As described above WINE includes a tool called <code>winecfg</code> to configure prefixes from within a GUI. It contains a variety of functions, which are detailed in the sections below. When <code>winecfg</code> is run from within a prefix, or provided the location of a prefix within the <code>WINEPREFIX</code> variable, it enables the configuration of the selected prefix as described in the below sections.</p>
</div>
<div class="paragraph">
<p>Selections made on the <em>Applications</em> tab will affect the scope of changes made in the <em>Libraries</em> and <em>Graphics</em> tabs, which will be limited to the application selected. See the section on <a href="https://wiki.winehq.org/Wine_User%27s_Guide#Using_Winecfg">Using Winecfg</a> in the WINE Wiki for more details.</p>
</div>
<div class="sect4">
<h5 id="applications">13.5.3.1. Applications<a class="anchor" href="#applications"></a></h5>
<div class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/wine/wine-config-1.png" alt="wine config 1"/>
</div>
</div>
<div class="paragraph">
<p>The <em>Applications</em> contains controls enabling the association of programs with a particular version of Windows®. On first start-up the <em>Application settings</em> section will contain a single entry: <em>Default Settings</em>. This corresponds to all the default configurations of the prefix, which (as the disabled <em>Remove application</em> button implies) cannot be deleted.</p>
</div>
<div class="paragraph">
<p>But additional applications can be added with the following process:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Click the <em>Add application</em> button.</p>
</li>
<li>
<p>Use the provided dialog to select the desired program’s executable.</p>
</li>
<li>
<p>Select the version of Windows® to be used with the selected program.</p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="libraries">13.5.3.2. Libraries<a class="anchor" href="#libraries"></a></h5>
<div class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/wine/wine-config-2.png" alt="wine config 2"/>
</div>
</div>
<div class="paragraph">
<p>WINE provides a set of open source library files as part of its distribution that provide the same functions as their Windows® counterparts. However, as noted earlier in this chapter, the WINE project is always trying to keep pace with new updates to these libraries. As a result, the versions that ship with WINE may be missing functionality that the latest Windows® programs are expecting.</p>
</div>
<div class="paragraph">
<p>However, <code>winecfg</code> makes it possible specify overrides for the built-in libraries, particularly there is a version of Windows® available on the same machine as the host FreeBSD installation. For each library to be overridden, do the following:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Open the <em>New override for library</em> drop-down and select the library to be replaced.</p>
</li>
<li>
<p>Click the <em>Add</em> button.</p>
</li>
<li>
<p>The new override will appear in the <em>Existing overrides</em> list, notice the <em>native, builtin</em> designation in parentheses.</p>
</li>
<li>
<p>Click to select the library.</p>
</li>
<li>
<p>Click the <em>Edit</em> button.</p>
</li>
<li>
<p>Use the provided dialog to select a corresponding library to be used in place of the built-in one.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Be sure to select a file that is truly the corresponding version of the built-in one, otherwise there may be unexpected behavior.</p>
</div>
</div>
<div class="sect4">
<h5 id="graphics">13.5.3.3. Graphics<a class="anchor" href="#graphics"></a></h5>
<div class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/wine/wine-config-3.png" alt="wine config 3"/>
</div>
</div>
<div class="paragraph">
<p>The <em>Graphics</em> tab provides some options to make the windows of programs run via WINE operate smoothly with FreeBSD:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Automatic mouse capture when windows are full-screen.</p>
</li>
<li>
<p>Allowing the FreeBSD window manager to decorate the windows, such as their title bars, for programs running via WINE.</p>
</li>
<li>
<p>Allowing the window manager to control windows for programs running via WINE, such as running resizing functions on them.</p>
</li>
<li>
<p>Create an emulated virtual desktop, within which all WINE programs will run. If this item is selected, the size of the virtual desktop can be specified using the <em>Desktop size</em> input boxes.</p>
</li>
<li>
<p>Setting the screen resolution for programs running via WINE.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="desktop-integration">13.5.3.4. Desktop Integration<a class="anchor" href="#desktop-integration"></a></h5>
<div class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/wine/wine-config-4.png" alt="wine config 4"/>
</div>
</div>
<div class="paragraph">
<p>This tab allows configuration of the following items:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The theme and related visual settings to be used for programs running via WINE.</p>
</li>
<li>
<p>Whether the WINE sub-system should manage MIME types (used to determine which application opens a particular file type) internally.</p>
</li>
<li>
<p>Mappings of directories in the host FreeBSD system to useful folders within the Windows® environment. To change an existing association, select the desired item and click <em>Browse</em>, then use the provided dialog to select a directory.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="drives">13.5.3.5. Drives<a class="anchor" href="#drives"></a></h5>
<div class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/wine/wine-config-5.png" alt="wine config 5"/>
</div>
</div>
<div class="paragraph">
<p>The <em>Drives</em> tab allows linking of directories in the host FreeBSD system to drive letters in the Windows® environment. The default values in this tab should look familiar, as they are displaying the contents of <span class="filename">dosdevices/</span> in the current WINE prefix. Changes made via this dialog will reflect in <span class="filename">dosdevices</span>, and properly-formatted links created in that directory will display in this tab.</p>
</div>
<div class="paragraph">
<p>To create a new entry, such as for a CD-ROM (mounted at <span class="filename">/mnt/cdrom</span>), take the following steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Click the _Add _ button.</p>
</li>
<li>
<p>In the provided dialog, choose a free drive letter.</p>
</li>
<li>
<p>Click <em>OK</em>.</p>
</li>
<li>
<p>Fill in the <em>Path</em> input box by either typing the path to the resource, or click _Browse _ and use the provided dialog to select it.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>By default WINE will autodetect the type of resource linked, but this can be manually overridden. See <a href="https://wiki.winehq.org/Wine_User%27s_Guide#Drive_Settings">the section in the WINE Wiki</a> for more detail on advanced options.</p>
</div>
</div>
<div class="sect4">
<h5 id="audio">13.5.3.6. Audio<a class="anchor" href="#audio"></a></h5>
<div class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/wine/wine-config-6.png" alt="wine config 6"/>
</div>
</div>
<div class="paragraph">
<p>This tab contains some configurable options for routing sound from Windows® programs to the native FreeBSD sound system, including:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Driver selection</p>
</li>
<li>
<p>Default device selection</p>
</li>
<li>
<p>Sound test</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="about">13.5.3.7. About<a class="anchor" href="#about"></a></h5>
<div class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/wine/wine-config-7.png" alt="wine config 7"/>
</div>
</div>
<div class="paragraph">
<p>The final tab contains information on the WINE project, including a link to the website. It also allows entry of (entirely optional) user information, although this is not sent anywhere as it is in other operating systems.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="wine-management-guis">13.6. WINE Management GUIs<a class="anchor" href="#wine-management-guis"></a></h3>
<div class="paragraph">
<p>While the base install of WINE comes with a GUI configuration tool in <code>winecfg</code>, it is main purpose is just that: strictly configuring an existing WINE prefix. There are, however, more advanced applications that will assist in the initial installation of applications as well as optimizing their WINE environments. The below sections include a selection of the most popular.</p>
</div>
<div class="sect3">
<h4 id="winetricks">13.6.1. Winetricks<a class="anchor" href="#winetricks"></a></h4>
<div class="paragraph">
<p>The <code>winetricks</code> tool is a cross-platform, general purpose helper program for WINE. It is not developed by the WINE project proper, but rather maintained on <a href="https://github.com/Winetricks/winetricks">Github</a> by a group of contributors. It contains some automated &#34;recipes&#34; for getting common applications to work on WINE, both by optimizing the settings as well as acquiring some DLL libraries automatically.</p>
</div>
<div class="sect4">
<h5 id="installing-winetricks">13.6.1.1. Installing winetricks<a class="anchor" href="#installing-winetricks"></a></h5>
<div class="paragraph">
<p>To install <code>winetricks</code> on a FreeBSD using binary packages, use the following commands (note <code>winetricks</code> requires either the i386-wine or i386-wine-devel package, and is therefore not installed automatically with other dependencies):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install i386-wine winetricks</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To compile it from source, issue the following in the terminal:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># cd /usr/ports/emulators/i386-wine</span>
<span class="c"># make install</span>
<span class="c"># cd /usr/ports/emulators/winetricks</span>
<span class="c"># make install</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If a manual installation is required, refer to the <a href="https://github.com/Winetricks/winetricks">Github</a> account for instructions.</p>
</div>
</div>
<div class="sect4">
<h5 id="using-winetricks">13.6.1.2. Using winetricks<a class="anchor" href="#using-winetricks"></a></h5>
<div class="paragraph">
<p>Run <code>winetricks</code> with the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>winetricks</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note: this should be in a 32-bit prefix to run <code>winetricks</code>. Launching <code>winetricks</code> displays a window with a number of choices, as follows:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/wine/winetricks-run-1.png" alt="winetricks run 1"/>
</div>
</div>
<div class="paragraph">
<p>Selecting either <em>Install an application</em>, <em>Install a benchmark</em>, or <em>Install a game</em> shows a list with supported options, such as the one below for applications:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/wine/winetricks-run-2.png" alt="winetricks run 2"/>
</div>
</div>
<div class="paragraph">
<p>Selecting one or more items and clicking <em>OK</em> will start their installation process(es). Initially, some messages that appear to be errors may show up, but they’re actually informational alerts as <code>winetricks</code> configures the WINE environment to get around known issues for the application:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/wine/winetricks-app-install-1.png" alt="winetricks app install 1"/>
</div>
</div>
<div class="paragraph">
<p>Once these are circumvented, the actual installer for the application will be run:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/wine/winetricks-app-install-2.png" alt="winetricks app install 2"/>
</div>
</div>
<div class="paragraph">
<p>Once the installation completes, the new Windows application should be available from the desktop environment’s standard menu (shown in the screenshot below for the LXQT desktop environment):</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/wine/winetricks-menu-1.png" alt="winetricks menu 1"/>
</div>
</div>
<div class="paragraph">
<p>In order to remove the application, run <code>winetricks</code> again, and select <em>Run an uninstaller</em>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/wine/winetricks-uninstall-1.png" alt="winetricks uninstall 1"/>
</div>
</div>
<div class="paragraph">
<p>A Windows®-style dialog will appear with a list of installed programs and components. Select the application to be removed, then click the <em>Modify/Remove</em> button.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/wine/winetricks-uninstall-2.png" alt="winetricks uninstall 2"/>
</div>
</div>
<div class="paragraph">
<p>This will run the applications built-in installer, which should also have the option to uninstall.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/wine/winetricks-uninstall-3.png" alt="winetricks uninstall 3"/>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="homura">13.6.2. Suyimazu<a class="anchor" href="#homura"></a></h4>
<div class="paragraph">
<p>Suyimazu is an application similar to <code>winetricks</code>, although it was inspired by the <a href="https://lutris.net/">Lutris</a> gaming system for Linux. But while it is focused on games, there are also non-gaming applications available for install through Suyimazu.</p>
</div>
<div class="sect4">
<h5 id="installing-homura">13.6.2.1. Installing Suyimazu<a class="anchor" href="#installing-homura"></a></h5>
<div class="paragraph">
<p>To install Suyimazu’s binary package, issue the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install suyimazu</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Suyimazu is available in the FreeBSD Ports system. However, than the <em>emulators</em> section of Ports or binary packages, look for it in the <em>games</em> section.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># cd /usr/ports/games/suyimazu</span>
<span class="c"># make install</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="using-homura">13.6.2.2. Using Suyimazu<a class="anchor" href="#using-homura"></a></h5>
<div class="paragraph">
<p>Suyimazu’s usage is quite similar to that of <code>winetricks</code>. When using it for the first time, launch it from the command line (or a desktop environment runner applet) with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>Suyimazu</code></pre>
</div>
</div>
<div class="paragraph">
<p>This should result in a friendly welcome message. Click <em>OK</em> to continue.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/wine/homura-launch-1.png" alt="homura launch 1"/>
</div>
</div>
<div class="paragraph">
<p>The program will also offer to place a link in the application menu of compatible environments:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/wine/homura-run-2.png" alt="homura run 2"/>
</div>
</div>
<div class="paragraph">
<p>Depending on the setup of the FreeBSD machine, Suyimazu may display a message urging the install of native graphics drivers.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/wine/homura-run-3.png" alt="homura run 3"/>
</div>
</div>
<div class="paragraph">
<p>The application’s window should then appear, which amounts to a &#34;main menu&#34; with all its options. Many of the items are the same as <code>winetricks</code>, although Suyimazu offers some additional, helpful options such as opening its data folder (<em>Open Suyimazu Folder</em>) or running a specified program (<em>Run a executable in prefix</em>).</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/wine/homura-install-1.png" alt="homura install 1"/>
</div>
</div>
<div class="paragraph">
<p>To select one of Suyimazu’s supported applications to install, select <em>Installation</em>, and click <em>OK</em>. This will display a list of applications Homura can install automatically. Select one, and click <em>OK</em> to start the process.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/wine/homura-install-2.png" alt="homura install 2"/>
</div>
</div>
<div class="paragraph">
<p>As a first step Suyimazu will download the selected program. A notification may appear in supported desktop environments.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/wine/homura-install-3.png" alt="homura install 3"/>
</div>
</div>
<div class="paragraph">
<p>The program will also create a new prefix for the application. A standard WINE dialog with this message will display.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/wine/homura-install-4.png" alt="homura install 4"/>
</div>
</div>
<div class="paragraph">
<p>Next, Suyimazu will install any prerequisites for the selected program. This may involve downloading and extracting a fair number of files, the details of which will show in dialogs.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/wine/homura-install-5.png" alt="homura install 5"/>
</div>
</div>
<div class="paragraph">
<p>Downloaded packages are automatically opened and run as required.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/wine/homura-install-6.png" alt="homura install 6"/>
</div>
</div>
<div class="paragraph">
<p>The installation may end with a simple desktop notification or message in the terminal, depending on how Suyimazu was launched. But in either case Suyimazu should return to the main screen. To confirm the installation was successful, select <em>Launcher</em>, and click <em>OK</em>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/wine/homura-install-7.png" alt="homura install 7"/>
</div>
</div>
<div class="paragraph">
<p>This will display a list of installed applications.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/wine/homura-install-8.png" alt="homura install 8"/>
</div>
</div>
<div class="paragraph">
<p>To run the new program, select it from the list, and click <em>OK</em>. To uninstall the application, select <em>Uninstallation</em> from the main screen, which will display a similar list. Select the program to be removed, and click <em>OK</em>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/wine/homura-uninstall-1.png" alt="homura uninstall 1"/>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="running-multiple-management-guis">13.6.3. Running Multiple Management GUIs<a class="anchor" href="#running-multiple-management-guis"></a></h4>
<div class="paragraph">
<p>it is worth noting that the above solutions are not mutually exclusive. it is perfectly acceptable, even advantageous, to have both installed at the same time, as they support a different set of programs.</p>
</div>
<div class="paragraph">
<p>However, it is wise to ensure that they do not access any of the same WINE prefixes. Each of these solutions applies workarounds and makes changes to the registries based on known workarounds to existing WINE issues in order to make a given application run smoothly. Allowing both <code>winetricks</code> and Homura to access the same prefix could lead to some of these being overwritten, with the result being some or all applications do not work as expected.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="wine-in-multi-user-os-installations">13.7. WINE in Multi-User FreeBSD Installations<a class="anchor" href="#wine-in-multi-user-os-installations"></a></h3>
<div class="sect3">
<h4 id="issues-with-using-a-common-wine-prefix">13.7.1. Issues with Using a Common WINE Prefix<a class="anchor" href="#issues-with-using-a-common-wine-prefix"></a></h4>
<div class="paragraph">
<p>Like most UNIX®-like operating systems, FreeBSD is designed for multiple users to be logged in and working at the same time. On the other hand, Windows® is multi-user in the sense that there can be multiple user accounts set up on one system. But the expectation is that only one will be using the physical machine (a desktop or laptop PC) at any given moment.</p>
</div>
<div class="paragraph">
<p>More recent consumer versions of Windows® have taken some steps to improve the OS in multi-user scenarios. But it is still largely structured around a single-user experience. Furthermore, the measures the WINE project has taken to create a compatible environment means, unlike FreeBSD applications (including WINE itself), it will resemble this single-user environment.</p>
</div>
<div class="paragraph">
<p>So it follows that each user will have to maintain their own set of configurations, which is potentially good. Yet it is advantageous to install applications, particularly large ones like office suites or games, only once. Two examples of reasons to do this are maintenance (software updates need only be applied once) and efficiency in storage (no duplicated files).</p>
</div>
<div class="paragraph">
<p>There are two strategies to minimize the impact of multiple WINE users in the system.</p>
</div>
</div>
<div class="sect3">
<h4 id="installing-applications-to-a-common-drivesettings">13.7.2. Installing Applications to a Common Drive<a class="anchor" href="#installing-applications-to-a-common-drivesettings"></a></h4>
<div class="paragraph">
<p>As shown in the section on WINE Configuration, WINE provides the ability to attach additional drives to a given prefix. In this way, applications can be installed to a common location, while each user will still have an prefix where individual settings may be kept (depending on the program). This is a good setup if there are relatively few applications to be shared between users, and they are programs that require few custom tweaks changes to the prefix in order to function.</p>
</div>
<div class="paragraph">
<p>The steps to make install applications in this way are as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>First, set up a shared location on the system where the files will be stored, such as <span class="filename">/mnt/windows-drive_d/</span>. Creating new directories is described in the <a href="https://man.freebsd.org/cgi/man.cgi?query=mkdir&amp;sektion=1&amp;format=html">mkdir(1)</a> manual page.</p>
</li>
<li>
<p>Next, set permissions for this new directory to allow only desired users to access it. One approach to this is to create a new group such as &#34;windows,&#34; add the desired users to that group (see the sub-section on groups in the <a href="./#users-groups">Users and Basic Account Management</a> section), and set to the permissions on the directory to <code>770</code> (the section on <a href="./#permissions">Permissions</a> illustrates this process).</p>
</li>
<li>
<p>Finally, add the location as a drive to the user’s prefix using the <code>winecfg</code> as described in the above section on WINE Configuration in this chapter.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Once complete, applications can be installed to this location, and subsequently run using the assigned drive letter (or the standard UNIX®-style directory path). However, as noted above, only one user should be running these applications (which may be accessing files within their installation directory) at the same time. Some applications may also exhibit unexpected behavior when run by a user who is not the owner, despite being a member of the group that should have full &#34;read/write/execute&#34; permissions for the entire directory.</p>
</div>
</div>
<div class="sect3">
<h4 id="using-a-common-installation-of-wine">13.7.3. Using a Common Installation of WINE<a class="anchor" href="#using-a-common-installation-of-wine"></a></h4>
<div class="paragraph">
<p>If, on the other hand, there are many applications to be shared, or they require specific tuning in order to work correctly, a different approach may be required. In this method, a completely separate user is created specifically for the purposes of storing the WINE prefix and all its installed applications. Individual users are then granted permission to run programs as this user using the <a href="https://man.freebsd.org/cgi/man.cgi?query=sudo&amp;sektion=8&amp;format=html">sudo(8)</a> command. The result is that these users can launch a WINE application as they normally would, only it will act as though launched by the newly-created user, and therefore use the centrally-maintained prefix containing both settings and programs. To accomplish this, take the following steps:</p>
</div>
<div class="paragraph">
<p>Create a new user with the following command (as <code>root</code>), which will step through the required details:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># adduser</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Enter the username (e.g., <em>windows</em>) and Full name (&#34;Microsoft Windows&#34;). Then accept the defaults for the remainder of the questions. Next, install the <code>sudo</code> utility using binary packages with the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install sudo</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Once installed, edit <span class="filename">/etc/sudoers</span> as follows:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre># User alias specification

# define which users can run the wine/windows programs
User_Alias WINDOWS_USERS = user1,user2

# define which users can administrate (become root)
User_Alias ADMIN = user1

# Cmnd alias specification

# define which commands the WINDOWS_USERS may run
Cmnd_Alias WINDOWS = /usr/bin/wine,/usr/bin/winecfg

# Defaults
Defaults:WINDOWS_USERS env_reset
Defaults:WINDOWS_USERS env_keep += DISPLAY
Defaults:WINDOWS_USERS env_keep += XAUTHORITY
Defaults    !lecture,tty_tickets,!fqdn

# User privilege specification
root    ALL=(ALL) ALL

# Members of the admin user_alias, defined above, may gain root privileges
ADMIN ALL=(ALL) ALL

# The WINDOWS_USERS may run WINDOWS programs as user windows without a password
WINDOWS_USERS ALL = (windows) NOPASSWD: WINDOWS</pre>
</div>
</div>
<div class="paragraph">
<p>The result of these changes is the users named in the <em>User_Alias</em> section are permitted to run the programs listed in the <em>Cmnd Alias</em> section using the resources listed in the <em>Defaults</em> section (the current display) as if they were the user listed in the final line of the file. In other words, users designates as <em>WINDOWS_USERS</em> can run the WINE and <code>winecfg</code> applications as user <em>windows</em>. As a bonus, the configuration here means they will not be required to enter the password for the <em>windows</em> user.</p>
</div>
<div class="paragraph">
<p>Next provide access to the display back to the <em>windows</em> user, as whom the WINE programs will be running:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>xhost +local:windows</code></pre>
</div>
</div>
<div class="paragraph">
<p>This should be added to the list of commands run either at login or when the default graphical environment starts. Once all the above are complete, a user configured as one of the <code>WINDOW_USERS</code> in <span class="filename">sudoers</span> can run programs using the shared prefix with the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>sudo -u windows wine program.exe</code></pre>
</div>
</div>
<div class="paragraph">
<p>it is worth noting that multiple users accessing this shared environment at the same time is still risky. However, consider also that the shared environment can itself contain multiple prefixes. In this way an administrator can create a tested and verified set of programs, each with its own prefix. At the same time, one user can play a game while another works with office programs without the need for redundant software installations.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="wine-on-os-faq">13.8. WINE on FreeBSD FAQ<a class="anchor" href="#wine-on-os-faq"></a></h3>
<div class="paragraph">
<p>The following section describes some frequently asked questions, tips/tricks, or common issues in running WINE on FreeBSD, along with their respective answers.</p>
</div>
<div class="sect3">
<h4 id="basic-installation-and-usage">13.8.1. Basic Installation and Usage<a class="anchor" href="#basic-installation-and-usage"></a></h4>
<div class="sect4">
<h5 id="how-to-install-32-bit-and-64-bit-wine-on-the-same-system">13.8.1.1. How to Install 32-bit and 64-bit WINE on the Same System?<a class="anchor" href="#how-to-install-32-bit-and-64-bit-wine-on-the-same-system"></a></h5>
<div class="paragraph">
<p>As described earlier in this section, the wine and i386-wine packages conflict with one another, and therefore cannot be installed on the same system in the normal way. However, multiple installs can be achieved using mechanisms like chroots/jails, or by building WINE from source (note this does <em>not</em> mean building the port).</p>
</div>
</div>
<div class="sect4">
<h5 id="can-dos-programs-be-run-on-wine">13.8.1.2. Can DOS Programs Be Run on WINE?<a class="anchor" href="#can-dos-programs-be-run-on-wine"></a></h5>
<div class="paragraph">
<p>They can, as &#34;Console User Interface&#34; applications as mentioned earlier in this section. However, there is an arguably better method for running DOS software: <a class="package" href="https://cgit.freebsd.org/ports/tree/emulators/dosbox/">DOSBox</a>. On the other hand, there is little reason not to at least try it. Simply create a new prefix, install the software, and if it does not work delete the prefix.</p>
</div>
</div>
<div class="sect4">
<h5 id="should-the-wine-devel-packageport-be-installed-to-use-the-development-version-of-wine-instead-of-stable">13.8.1.3. Should the <a class="package" href="https://cgit.freebsd.org/ports/tree/emulators/wine-devel/">emulators/wine-devel</a> Package/Port be Installed to Use the Development Version of WINE Instead of Stable?<a class="anchor" href="#should-the-wine-devel-packageport-be-installed-to-use-the-development-version-of-wine-instead-of-stable"></a></h5>
<div class="paragraph">
<p>Yes, installing this version will install the &#34;development&#34; version of WINE. As with the 32- and 64-bit versions, they cannot be installed together with the stable versions unless additional measures are taken.</p>
</div>
<div class="paragraph">
<p>Note that WINE also has a &#34;Staging&#34; version, which contains the most recent updates. This was at one time available as a FreeBSD port; however, it has since been removed. It can be compiled directly from source however.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="install-optimization">13.8.2. Install Optimization<a class="anchor" href="#install-optimization"></a></h4>
<div class="sect4">
<h5 id="how-should-windows-hardware-graphics-drivers-be-handled">13.8.2.1. How Should Windows® Hardware (e.g., Graphics) Drivers be Handled?<a class="anchor" href="#how-should-windows-hardware-graphics-drivers-be-handled"></a></h5>
<div class="paragraph">
<p>Operating system drivers transfer commands between applications and hardware. WINE emulates a Windows® environment, including the drivers, which in turn use FreeBSD’s native drivers for this transfer. it is not advisable to install Windows® drivers, as the WINE system is designed to use the host systems drivers. If, for example, a graphics card that benefits from dedicated drivers, install them using the standard FreeBSD methods, not Windows® installers.</p>
</div>
</div>
<div class="sect4">
<h5 id="is-there-a-way-to-make-windows-fonts-look-better">13.8.2.2. Is There a way to Make Windows® Fonts Look Better?<a class="anchor" href="#is-there-a-way-to-make-windows-fonts-look-better"></a></h5>
<div class="paragraph">
<p>A user on the FreeBSD forums suggests this configuration to fix out-of-the-box look of WINE fonts, which can be slightly pixelated.</p>
</div>
<div class="paragraph">
<p>According to <a href="https://forums.freebsd.org/threads/make-wine-ui-fonts-look-good.68273/">a post in the FreeBSD Forums</a>, adding the following to <span class="filename">.config/fontconfig/fonts.conf</span> will add anti-aliasing and make text more readable.</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>&lt;?xml version=&#34;1.0&#34;?&gt;
&lt;!DOCTYPE fontconfig SYSTEM &#34;fonts.dtd&gt;&#34;

&lt;fontconfig&gt;

  &lt;!-- antialias all fonts --&gt;
  &lt;match target=&#34;font&#34;&gt;
    &lt;edit name=&#34;antialias&#34; mode=&#34;assign&#34;&gt;&lt;bool&gt;true&lt;/bool&gt;&lt;/edit&gt;&gt;
    &lt;edit name=&#34;hinting&#34; mode=&#34;assign&#34;&gt;&lt;bool&gt;true&lt;/bool&gt;&lt;/edit&gt;&gt;
    &lt;edit name=&#34;hintstyle&#34; mode=&#34;assign&#34;&gt;&lt;const&gt;hintslight&lt;/const&gt;&lt;/edit&gt;&gt;
    &lt;edit name=&#34;rgba&#34; mode=&#34;assign&#34;&gt;&lt;const&gt;rgb&lt;/const&gt;&lt;/edit&gt;&gt;
  &lt;/match&gt;
&lt;/fontconfig&gt;</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="does-having-windows-installed-elsewhere-on-a-system-help-wine-operate">13.8.2.3. Does Having Windows® Installed Elsewhere on a System Help WINE Operate?<a class="anchor" href="#does-having-windows-installed-elsewhere-on-a-system-help-wine-operate"></a></h5>
<div class="paragraph">
<p>It may, depending on the application being run. As mentioned in the section describing <code>winecfg</code>, some built-in WINE DLLs and other libraries can be overridden by providing a path to an alternate version. Provided the Windows® partition or drive is mounted to the FreeBSD system and accessible to the user, configuring some of these overrides will use native Windows® libraries and may decrease the chance of unexpected behavior.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="application-specific">13.8.3. Application-Specific<a class="anchor" href="#application-specific"></a></h4>
<div class="sect4">
<h5 id="where-is-the-best-place-to-see-if-application-x-works-on-wine">13.8.3.1. Where is the Best Place to see if Application X Works on WINE?<a class="anchor" href="#where-is-the-best-place-to-see-if-application-x-works-on-wine"></a></h5>
<div class="paragraph">
<p>The first step in determining compatibility should be the <a href="https://appdb.winehq.org/">WINE AppDB</a>. This is a compilation of reports of programs working (or not) on all supported platforms, although (as previously mentioned), solutions for one platform are often applicable to others.</p>
</div>
</div>
<div class="sect4">
<h5 id="is-there-anything-that-will-help-games-run-better">13.8.3.2. Is There Anything That Will Help Games Run Better?<a class="anchor" href="#is-there-anything-that-will-help-games-run-better"></a></h5>
<div class="paragraph">
<p>Perhaps. Many Windows® games rely on DirectX, a proprietary Microsoft graphics layer. However there are projects in the open source community attempting to implement support for this technology.</p>
</div>
<div class="paragraph">
<p>The <em>dxvk</em> project, which is an attempt to implement DirectX using the FreeBSD-compatible Vulkan graphics sub-system, is one such. Although its primary target is WINE on Linux, <a href="https://forums.freebsd.org/threads/what-about-gaming-on-freebsd.723/page-9">some FreeBSD users report</a> compiling and using dxvk.</p>
</div>
<div class="paragraph">
<p>In addition, work is under way on a <a href="https://www.freshports.org/emulators/wine-proton/">wine-proton port</a>. This will bring the work of Valve, developer of the Steam gaming platform, to FreeBSD. Proton is a distribution of WINE designed to allow many Windows® games to run on other operating systems with minimal setup.</p>
</div>
</div>
<div class="sect4">
<h5 id="is-there-anywhere-freebsd-wine-users-gather-to-exchange-tips-and-tricks">13.8.3.3. Is There Anywhere FreeBSD WINE Users Gather to Exchange Tips and Tricks?<a class="anchor" href="#is-there-anywhere-freebsd-wine-users-gather-to-exchange-tips-and-tricks"></a></h5>
<div class="paragraph">
<p>There are plenty of places FreeBSD users discuss issues related to WINE that can be searched for solutions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://forums.freebsd.org/">The FreeBSD forums</a>, particularly the <em>Installation and Maintenance of Ports or Packages</em> or <em>Emulation and virtualization</em> forums.</p>
</li>
<li>
<p><a href="https://wiki.freebsd.org/IRC/Channels">FreeBSD IRC channels</a> including #freebsd (for general support), #freebsd-games, and others.</p>
</li>
<li>
<p><a href="https://discord.gg/2CCuhCt">The BSD World Discord server’s</a> channels including <em>bsd-desktop</em>, <em>bsd-gaming</em>, <em>bsd-wine</em>, and others.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="other-os-resources">13.8.4. Other OS Resources<a class="anchor" href="#other-os-resources"></a></h4>
<div class="paragraph">
<p>There are a number of resources focused on other operating systems that may be useful for FreeBSD users:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://wiki.winehq.org/">The WINE Wiki</a> has a wealth of information on using WINE, much of which is applicable across many of WINE’s supported operating systems.</p>
</li>
<li>
<p>Similarly, the documentation available from other OS projects can also be of good value. <a href="https://wiki.archlinux.org/index.php/wine">The WINE page</a> on the Arch Linux Wiki is a particularly good example, although some of the &#34;Third-party applications&#34; (i.e., &#34;companion applications&#34;) are obviously not available on FreeBSD.</p>
</li>
<li>
<p>Finally, Codeweavers (a developer of a commercial version of WINE) is an active upstream contributor. Oftentimes answers to questions in <a href="https://www.codeweavers.com/support/forums">their support forum</a> can be of aid in troubleshooting problems with the open source version of WINE.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<h1 id="system-administration" class="sect0">Part III: 系统管理<a class="anchor" href="#system-administration"></a></h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>剩下的章节涵盖了 FreeBSD 系统管理的各个方面。每一章都以描述读完该章节后将学到的内容为开头，并详细说明读者在学习该章节之前应该具备的知识。</p>
</div>
<div class="paragraph">
<p>这些章节的设计是根据需要阅读的。它们不需要按照特定的顺序阅读，也不需要在开始使用 FreeBSD 之前全部阅读完毕。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="config-tuning">Chapter 14. Configuration, Services, Logging and Power Management<a class="anchor" href="#config-tuning"></a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="config-synopsis">14.1. Synopsis<a class="anchor" href="#config-synopsis"></a></h3>
<div class="paragraph">
<p>One of the important aspects of FreeBSD is proper system configuration. This chapter explains much of the FreeBSD configuration process, including some of the parameters which can be set to tune a FreeBSD system.</p>
</div>
<div class="paragraph">
<p>Before reading this chapter, you should:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Understand UNIX® and FreeBSD basics (<a href="./#basics">FreeBSD Basics</a>).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>After reading this chapter, you will know:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>How to use the various configuration files in <span class="filename">/etc</span>.</p>
</li>
<li>
<p>The basics of <span class="filename">rc.conf</span> configuration and <span class="filename">/usr/local/etc/rc.d</span> startup scripts.</p>
</li>
<li>
<p>How to tune FreeBSD using <a href="https://man.freebsd.org/cgi/man.cgi?query=sysctl&amp;sektion=8&amp;format=html">sysctl(8)</a> variables.</p>
</li>
<li>
<p>How to configure the power management in FreeBSD.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="configtuning-configfiles">14.2. Configuration Files<a class="anchor" href="#configtuning-configfiles"></a></h3>
<div class="paragraph">
<p>FreeBSD maintains a clear separation between the base system and third party applications and therefore this affects where the configuration files of these applications are located.</p>
</div>
<div class="paragraph">
<p>FreeBSD base system configuration is located at the <span class="filename">/etc</span> directory, and the <span class="filename">/usr/local/etc</span> directory contains all the configuration files of the applications installed on the system through the ports collection and packages.</p>
</div>
<div class="paragraph">
<p>The kernel state configuration is located in <span class="filename">/etc/sysctl.conf</span>. In the section <a href="#configtuning-sysctl">The sysctl utility</a>, the operation of <a href="https://man.freebsd.org/cgi/man.cgi?query=sysctl&amp;sektion=8&amp;format=html">sysctl(8)</a> will be explained in more detail.</p>
</div>
<div class="paragraph">
<p>For more information about the FreeBSD file system structure refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=hier&amp;sektion=7&amp;format=html">hier(7)</a>.</p>
</div>
<div class="paragraph">
<p>As a general rule, configuration files do not use a standard on what syntax they must follow. Although it is true that the <code>#</code> character is normally used to comment a line and that each line has a configuration variable.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Some applications like <a href="https://man.freebsd.org/cgi/man.cgi?query=pkg&amp;sektion=8&amp;format=html">pkg(8)</a> are starting to use the <a href="https://github.com/vstakhov/libucl">Universal Configuration Language (UCL)</a>.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="sect3">
<h4 id="_the_etc_directory">14.2.1. The <span class="filename">/etc</span> directory<a class="anchor" href="#_the_etc_directory"></a></h4>
<div class="paragraph">
<p>The <span class="filename">/etc</span> directory contains all of the FreeBSD base system configuration files that are responsible for configuring FreeBSD.</p>
</div>
<div class="admonitionblock caution">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p><strong>Extreme</strong> caution must be taken when modifying files in the <span class="filename">/etc</span> directory; misconfiguration could make FreeBSD unbootable or malfunction.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<table class="tableblock frame-none grid-all stretch informaltable">
<colgroup>
<col style="width: 50%;"/>
<col style="width: 50%;"/>
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="filename">/etc</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">System configuration files and scripts.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="filename">/etc/defaults</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Default system configuration files, see <a href="https://man.freebsd.org/cgi/man.cgi?query=rc&amp;sektion=8&amp;format=html">rc(8)</a> for more information.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="filename">/etc/fstab</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://man.freebsd.org/cgi/man.cgi?query=fstab&amp;sektion=5&amp;format=html">fstab(5)</a> contains descriptive information about the various file systems.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="filename">/etc/mail</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Extra <a href="https://man.freebsd.org/cgi/man.cgi?query=sendmail&amp;sektion=8&amp;format=html">sendmail(8)</a> configuration and other MTA configuration files.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="filename">/etc/mtree</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">mtree configuration files, see man: mtree[8] for more information.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="filename">/etc/pam.d</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Configuration files for the Pluggable Authentication Modules (PAM) library.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="filename">/etc/periodic</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Scripts that are run daily, weekly, and monthly, via <a href="https://man.freebsd.org/cgi/man.cgi?query=cron&amp;sektion=8&amp;format=html">cron(8)</a>, see <a href="https://man.freebsd.org/cgi/man.cgi?query=periodic&amp;sektion=8&amp;format=html">periodic(8)</a> for more information.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="filename">/etc/rc.d</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">System and daemon startup/control scripts, see <a href="https://man.freebsd.org/cgi/man.cgi?query=rc&amp;sektion=8&amp;format=html">rc(8)</a> for more information.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="filename">/etc/rc.conf</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Contains descriptive information about the local host name, configuration details for any potential network interfaces and which services should be started up at system initial boot time. More information in <a href="#configtuning-core-configuration">Managing System-Specific Configuration</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="filename">/etc/security</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">OpenBSM audit configuration files, see <a href="https://man.freebsd.org/cgi/man.cgi?query=audit&amp;sektion=8&amp;format=html">audit(8)</a> for more information.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="filename">/etc/ppp</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ppp configuration files, see <a href="https://man.freebsd.org/cgi/man.cgi?query=ppp&amp;sektion=8&amp;format=html">ppp(8)</a> for more information.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="filename">/etc/ssh</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">OpenSSH configuration files, see <a href="https://man.freebsd.org/cgi/man.cgi?query=ssh&amp;sektion=1&amp;format=html">ssh(1)</a> for more information.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="filename">/etc/ssl</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">OpenSSL configuration files.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="filename">/etc/sysctl.conf</span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Contains settings for the kernel. More information in <a href="#configtuning-sysctl">The sysctl utility</a></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="configtuning-sysctl">14.2.2. The sysctl utility<a class="anchor" href="#configtuning-sysctl"></a></h4>
<div class="paragraph">
<p>The <a href="https://man.freebsd.org/cgi/man.cgi?query=sysctl&amp;sektion=8&amp;format=html">sysctl(8)</a> utility is used to make changes to a running FreeBSD system.</p>
</div>
<div class="paragraph">
<p>The <a href="https://man.freebsd.org/cgi/man.cgi?query=sysctl&amp;sektion=8&amp;format=html">sysctl(8)</a> utility retrieves kernel state and allows processes with appropriate privilege to set kernel state. The state to be retrieved or set is described using a &#34;Management Information Base&#34; (&#34;MIB&#34;) style name, described as a dotted set of components.</p>
</div>
<table class="tableblock frame-none grid-all stretch informaltable">
<caption class="title">表 23. Management Information Base</caption>
<colgroup>
<col style="width: 50%;"/>
<col style="width: 50%;"/>
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">sysctl</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#34;Magic&#34; numbers</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">kern</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kernel functions and features</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">vm</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">virtual memory</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">vfs</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Filesystem</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">net</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Network</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">debug</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Debugging parameters</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">hw</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hardware</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">machdep</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Machine dependent</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">user</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Userland</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">p1003_1b</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">POSIX 1003.1B</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>At its core, <a href="https://man.freebsd.org/cgi/man.cgi?query=sysctl&amp;sektion=8&amp;format=html">sysctl(8)</a> serves two functions: to read and to modify system settings.</p>
</div>
<div class="paragraph">
<p>To view all readable variables:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>sysctl -a</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should be similar to the following:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>kern.ostype: FreeBSD
...
vm.swap_enabled: 1
vm.overcommit: 0
vm.domain.0.pidctrl.kdd: 8
vm.domain.0.pidctrl.kid: 4
vm.domain.0.pidctrl.kpd: 3
...
vfs.zfs.sync_pass_rewrite: 2
vfs.zfs.sync_pass_dont_compress: 8
vfs.zfs.sync_pass_deferred_free: 2</pre>
</div>
</div>
<div class="paragraph">
<p>To read a particular variable, specify its name:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>sysctl kern.maxproc</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should be similar to the following:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>kern.maxproc: 1044</pre>
</div>
</div>
<div class="paragraph">
<p>The Management Information Base (MIB) is hierarchical and hence, specifying a prefix prints all the nodes hanging from it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>sysctl net</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should be similar to the following:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>net.local.stream.recvspace: 8192
net.local.stream.sendspace: 8192
net.local.dgram.recvspace: 16384
net.local.dgram.maxdgram: 2048
net.local.seqpacket.recvspace: 8192
net.local.seqpacket.maxseqpacket: 8192
net.local.sockcount: 60
net.local.taskcount: 25
net.local.recycled: 0
net.local.deferred: 0
net.local.inflight: 0
net.inet.ip.portrange.randomtime: 1
net.inet.ip.portrange.randomcps: 9999
[...]</pre>
</div>
</div>
<div class="paragraph">
<p>To set a particular variable, use the <em>variable</em>=<em>value</em> syntax:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysctl kern.maxfiles=5000</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should be similar to the following:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>kern.maxfiles: 2088 -&gt; 5000</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>To keep the configuration after a reboot it is necessary to add these variables to the <span class="filename">/etc/sysctl.conf</span> file as explained below.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect3">
<h4 id="configtuning-sysctlconf">14.2.3. The <span class="filename">/etc/sysctl.conf</span> file<a class="anchor" href="#configtuning-sysctlconf"></a></h4>
<div class="paragraph">
<p>The configuration file for <a href="https://man.freebsd.org/cgi/man.cgi?query=sysctl&amp;sektion=8&amp;format=html">sysctl(8)</a>, <span class="filename">/etc/sysctl.conf</span>, looks much like <span class="filename">/etc/rc.conf</span>.</p>
</div>
<div class="paragraph">
<p>Values are set using a <code>variable=value</code> syntax.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The specified values are set after the system goes into multi-user mode. Not all variables are settable in this mode.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>For example, to turn off logging of fatal signal exits and prevent users from seeing processes started by other users, the following tunables can be set in <span class="filename">/etc/sysctl.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre># Do not log fatal signal exits (e.g., sig 11)
kern.logsigexit=0

# Prevent users from seeing information about processes that
# are being run under another UID.
security.bsd.see_other_uids=0</pre>
</div>
</div>
<div class="paragraph">
<p>To obtain more information about what function a particular sysctl has, the following command can be executed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>sysctl -d kern.dfldsiz</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should be similar to the following:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>kern.dfldsiz: Initial data size limit</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="configtuning-core-configuration">14.2.4. Managing System-Specific Configuration<a class="anchor" href="#configtuning-core-configuration"></a></h4>
<div class="paragraph">
<p>The principal location for system configuration information is <span class="filename">/etc/rc.conf</span>.</p>
</div>
<div class="paragraph">
<p>This file contains a wide range of configuration information and it is read at system startup to configure the system. It provides the configuration information for the <span class="filename">rc*</span> files.</p>
</div>
<div class="paragraph">
<p>The entries in <span class="filename">/etc/rc.conf</span> override the default settings in <span class="filename">/etc/defaults/rc.conf</span>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The file <span class="filename">/etc/defaults/rc.conf</span> containing the default settings should not be edited. Instead, all system-specific changes should be made to <span class="filename">/etc/rc.conf</span>.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>A number of strategies may be applied in clustered applications to separate site-wide configuration from system-specific configuration in order to reduce administration overhead.</p>
</div>
<div class="paragraph">
<p>The recommended approach is to place system-specific configuration into <span class="filename">/etc/rc.conf.local</span>.</p>
</div>
<div class="paragraph">
<p>For example, these entries in <span class="filename">/etc/rc.conf</span> apply to all systems:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>sshd_enable=&#34;YES&#34;
keyrate=&#34;fast&#34;
defaultrouter=&#34;10.1.1.254&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>Whereas these entries in <span class="filename">/etc/rc.conf.local</span> apply to this system only:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>hostname=&#34;node1.example.org&#34;
ifconfig_fxp0=&#34;inet 10.1.1.1/8&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>Distribute <span class="filename">/etc/rc.conf</span> to every system using an application such as rsync or puppet, while <span class="filename">/etc/rc.conf.local</span> remains unique.</p>
</div>
<div class="paragraph">
<p>Upgrading the system will not overwrite <span class="filename">/etc/rc.conf</span>, so system configuration information will not be lost.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Both <span class="filename">/etc/rc.conf</span> and <span class="filename">/etc/rc.conf.local</span> are parsed by <a href="https://man.freebsd.org/cgi/man.cgi?query=sh&amp;sektion=1&amp;format=html">sh(1)</a>. This allows system operators to create complex configuration scenarios. Refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=rc.conf&amp;sektion=5&amp;format=html">rc.conf(5)</a> for further information on this topic.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="configtuning-rcd">14.3. Managing Services in FreeBSD<a class="anchor" href="#configtuning-rcd"></a></h3>
<div class="paragraph">
<p>FreeBSD uses the <a href="https://man.freebsd.org/cgi/man.cgi?query=rc&amp;sektion=8&amp;format=html">rc(8)</a> system of startup scripts during system initialization and for managing services.</p>
</div>
<div class="paragraph">
<p>The scripts listed in <span class="filename">/etc/rc.d</span> provide basic services which can be controlled with the <code>start</code>, <code>stop</code>, and <code>restart</code> options to <a href="https://man.freebsd.org/cgi/man.cgi?query=service&amp;sektion=8&amp;format=html">service(8)</a>.</p>
</div>
<div class="paragraph">
<p>A basic script may look similar to the following:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>#!/bin/sh
#
# PROVIDE: utility
# REQUIRE: DAEMON
# KEYWORD: shutdown

. /etc/rc.subr

name=utility
rcvar=utility_enable

command=&#34;/usr/local/sbin/utility&#34;

load_rc_config $name

#
# DO NOT CHANGE THESE DEFAULT VALUES HERE
# SET THEM IN THE /etc/rc.conf FILE
#
utility_enable=${utility_enable-&#34;NO&#34;}
pidfile=${utility_pidfile-&#34;/var/run/utility.pid&#34;}

run_rc_command &#34;$1&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>Refer to <a href="{rc-scripting}">this article</a> for instructions on how to create custom <a href="https://man.freebsd.org/cgi/man.cgi?query=rc&amp;sektion=8&amp;format=html">rc(8)</a> scripts.</p>
</div>
<div class="sect3">
<h4 id="configtuning-starting-services">14.3.1. Starting Services<a class="anchor" href="#configtuning-starting-services"></a></h4>
<div class="paragraph">
<p>Many users install third party software on FreeBSD from the Ports Collection and require the installed services to be started upon system initialization.</p>
</div>
<div class="paragraph">
<p>Services, such as <a class="package" href="https://cgit.freebsd.org/ports/tree/security/openssh-portable/">security/openssh-portable</a> or <a class="package" href="https://cgit.freebsd.org/ports/tree/www/nginx/">www/nginx</a> are just two of the many software packages which may be started during system initialization. This section explains the procedures available for starting services.</p>
</div>
<div class="paragraph">
<p>Since the <a href="https://man.freebsd.org/cgi/man.cgi?query=rc&amp;sektion=8&amp;format=html">rc(8)</a> system is primarily intended to start and stop services at system startup and shutdown time, the <code>start</code>, <code>stop</code> and <code>restart</code> options will only perform their action if the appropriate <span class="filename">/etc/rc.conf</span> variable is set.</p>
</div>
<div class="paragraph">
<p>So the first step to start a service, like for example <a class="package" href="https://cgit.freebsd.org/ports/tree/www/nginx/">www/nginx</a> is to add it to <span class="filename">/etc/rc.conf</span> by executing the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysrc nginx_enable=&#34;YES&#34;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then nginx can be started executing the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># service nginx start</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>To <code>start</code>, <code>stop</code> or <code>restart</code> a service regardless of the settings in <span class="filename">/etc/rc.conf</span>, these commands should be prefixed with &#34;one&#34;. For instance, to start <a class="package" href="https://cgit.freebsd.org/ports/tree/www/nginx/">www/nginx</a> regardless of the current <span class="filename">/etc/rc.conf</span> setting, execute the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># service nginx onestart</span></code></pre>
</div>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect3">
<h4 id="configtuning-status-services">14.3.2. Status of a Service<a class="anchor" href="#configtuning-status-services"></a></h4>
<div class="paragraph">
<p>To determine if a service is running, use the <code>status</code> subcommand.</p>
</div>
<div class="paragraph">
<p>For example, to verify that <a class="package" href="https://cgit.freebsd.org/ports/tree/www/nginx/">www/nginx</a> is running:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># service nginx status</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should be similar to the following:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>nginx is running as pid 27871.</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="configtuning-reload-services">14.3.3. Reload a Service<a class="anchor" href="#configtuning-reload-services"></a></h4>
<div class="paragraph">
<p>In some cases, it is also possible to <code>reload</code> a service. This attempts to send a signal to an individual service, forcing the service to reload its configuration files.</p>
</div>
<div class="paragraph">
<p>In most cases, this means sending the service a <code>SIGHUP</code> signal.</p>
</div>
<div class="paragraph">
<p><strong>Not all services support this feature.</strong></p>
</div>
<div class="paragraph">
<p>The <a href="https://man.freebsd.org/cgi/man.cgi?query=rc&amp;sektion=8&amp;format=html">rc(8)</a> system is used for network services and it also contributes to most of the system initialization. For instance, when the <span class="filename">/etc/rc.d/bgfsck</span> script is executed, it prints out the following message:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">Starting background file system checks <span class="k">in </span>60 seconds.</code></pre>
</div>
</div>
<div class="paragraph">
<p>This script is used for background file system checks, which occur only during system initialization.</p>
</div>
<div class="paragraph">
<p>Many system services depend on other services to function properly. For example, <a href="https://man.freebsd.org/cgi/man.cgi?query=yp&amp;sektion=8&amp;format=html">yp(8)</a> and other RPC-based services may fail to start until after the <a href="https://man.freebsd.org/cgi/man.cgi?query=rpcbind&amp;sektion=8&amp;format=html">rpcbind(8)</a> service has started.</p>
</div>
<div class="paragraph">
<p>Additional information can be found in <a href="https://man.freebsd.org/cgi/man.cgi?query=rc&amp;sektion=8&amp;format=html">rc(8)</a> and <a href="https://man.freebsd.org/cgi/man.cgi?query=rc.subr&amp;sektion=8&amp;format=html">rc.subr(8)</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_using_services_to_start_services">14.3.4. Using Services to Start Services<a class="anchor" href="#_using_services_to_start_services"></a></h4>
<div class="paragraph">
<p>Other services can be started using <a href="https://man.freebsd.org/cgi/man.cgi?query=inetd&amp;sektion=8&amp;format=html">inetd(8)</a>. Working with <a href="https://man.freebsd.org/cgi/man.cgi?query=inetd&amp;sektion=8&amp;format=html">inetd(8)</a> and its configuration is described in depth in <a href="./#network-inetd">“The inetd Super-Server”</a>.</p>
</div>
<div class="paragraph">
<p>In some cases, it may make more sense to use <a href="https://man.freebsd.org/cgi/man.cgi?query=cron&amp;sektion=8&amp;format=html">cron(8)</a> to start system services. This approach has a number of advantages as <a href="https://man.freebsd.org/cgi/man.cgi?query=cron&amp;sektion=8&amp;format=html">cron(8)</a> runs these processes as the owner of the <a href="https://man.freebsd.org/cgi/man.cgi?query=crontab&amp;sektion=5&amp;format=html">crontab(5)</a>. This allows regular users to start and maintain their own applications.</p>
</div>
<div class="paragraph">
<p>The <code>@reboot</code> feature of <a href="https://man.freebsd.org/cgi/man.cgi?query=cron&amp;sektion=8&amp;format=html">cron(8)</a>, may be used in place of the time specification. This causes the job to run when <a href="https://man.freebsd.org/cgi/man.cgi?query=cron&amp;sektion=8&amp;format=html">cron(8)</a> is started, normally during system initialization.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="cron-periodic">14.4. Cron and Periodic<a class="anchor" href="#cron-periodic"></a></h3>
<div class="paragraph">
<p>Scheduling tasks to run at a certain day or time is a very common task on FreeBSD. The tool in charge of performing this task is <a href="https://man.freebsd.org/cgi/man.cgi?query=cron&amp;sektion=8&amp;format=html">cron(8)</a>.</p>
</div>
<div class="paragraph">
<p>In addition to tasks that can be scheduled by the user via <a href="https://man.freebsd.org/cgi/man.cgi?query=cron&amp;sektion=8&amp;format=html">cron(8)</a>, FreeBSD performs routine background tasks managed by <a href="https://man.freebsd.org/cgi/man.cgi?query=periodic&amp;sektion=8&amp;format=html">periodic(8)</a>.</p>
</div>
<div class="sect3">
<h4 id="configtuning-cron">14.4.1. Cron<a class="anchor" href="#configtuning-cron"></a></h4>
<div class="paragraph">
<p>The <a href="https://man.freebsd.org/cgi/man.cgi?query=cron&amp;sektion=8&amp;format=html">cron(8)</a> utility runs in the background and regularly checks <span class="filename">/etc/crontab</span> for tasks to execute and searches <span class="filename">/var/cron/tabs</span> for custom crontab files.</p>
</div>
<div class="paragraph">
<p>These files are used to schedule tasks which cron runs at the specified times.</p>
</div>
<div class="paragraph">
<p>Each entry in a crontab defines a task to run and is known as a <em>cron job</em>.</p>
</div>
<div class="paragraph">
<p>Two different types of configuration files are used: the system crontab, which should not be modified, and user crontabs, which can be created and edited as needed. The format used by these files is documented in <a href="https://man.freebsd.org/cgi/man.cgi?query=crontab&amp;sektion=5&amp;format=html">crontab(5)</a>. The format of the system crontab, <span class="filename">/etc/crontab</span> includes a <code>who</code> column which does not exist in user crontabs. In the system crontab, cron runs the command as the user specified in this column. In a user crontab, all commands run as the user who created the crontab.</p>
</div>
<div class="paragraph">
<p>User crontabs allow individual users to schedule their own tasks. The <code>root</code> user can also have a user <span class="filename">crontab</span> which can be used to schedule tasks that do not exist in the system <span class="filename">crontab</span>.</p>
</div>
<div class="paragraph">
<p>Here is a sample entry from the system crontab, <span class="filename">/etc/crontab</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre># /etc/crontab - root&#39;s crontab for FreeBSD
#
# $FreeBSD$ <i class="conum" data-value="1"></i><b>(1)</b>
#
SHELL=/bin/sh
PATH=/sbin:/bin:/usr/sbin:/usr/bin:/usr/local/sbin:/usr/local/bin <i class="conum" data-value="2"></i><b>(2)</b>
#
#minute hour    mday    month   wday    who     command <i class="conum" data-value="3"></i><b>(3)</b>
#
# Save some entropy so that /dev/random can re-seed on boot.
*/11    *       *       *       *       operator /usr/libexec/save-entropy <i class="conum" data-value="4"></i><b>(4)</b>
#
# Rotate log files every hour, if necessary.
0       *       *       *       *       root    newsyslog
#
# Perform daily/weekly/monthly maintenance.
1       3       *       *       *       root    periodic daily
15      4       *       *       6       root    periodic weekly
30      5       1       *       *       root    periodic monthly
#
# Adjust the time zone if the CMOS clock keeps local time, as opposed to
# UTC time.  See adjkerntz(8) for details.
1,31    0-5     *       *       *       root    adjkerntz -a</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Lines that begin with the <code>#</code> character are comments. A comment can be placed in the file as a reminder of what and why a desired action is performed. Comments cannot be on the same line as a command or else they will be interpreted as part of the command; they must be on a new line. Blank lines are ignored.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The equals (<code>=</code>) character is used to define any environment settings. In this example, it is used to define the <code>SHELL</code> and <code>PATH</code>. If the <code>SHELL</code> is omitted, cron will use the default Bourne shell. If the <code>PATH</code> is omitted, the full path must be given to the command or script to run.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>This line defines the seven fields used in a system crontab: <code>minute</code>, <code>hour</code>, <code>mday</code>, <code>month</code>, <code>wday</code>, <code>who</code>, and <code>command</code>. The <code>minute</code> field is the time in minutes when the specified command will be run, the <code>hour</code> is the hour when the specified command will be run, the <code>mday</code> is the day of the month, <code>month</code> is the month, and <code>wday</code> is the day of the week. These fields must be numeric values, representing the twenty-four hour clock, or a <code>*</code>, representing all values for that field. The <code>who</code> field only exists in the system crontab and specifies which user the command should be run as. The last field is the command to be executed.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>This entry defines the values for this cron job. The <code>*/11</code>, followed by several more <code>*</code> characters, specifies that <code>/usr/libexec/save-entropy</code> is invoked by <code>operator</code> every eleven minutes of every hour, of every day and day of the week, of every month. Commands can include any number of switches. However, commands which extend to multiple lines need to be broken with the backslash &#34;\&#34; continuation character.</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect3">
<h4 id="configtuning-installcrontab">14.4.2. Creating a User Crontab<a class="anchor" href="#configtuning-installcrontab"></a></h4>
<div class="paragraph">
<p>To create a user crontab, invoke <code>crontab</code> in editor mode:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>crontab -e</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will open the user’s crontab using the default text editor. The first time a user runs this command, it will open an empty file. Once a user creates a crontab, this command will open that file for editing.</p>
</div>
<div class="paragraph">
<p>It is useful to add these lines to the top of the crontab file in order to set the environment variables and to remember the meanings of the fields in the crontab:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>SHELL=/bin/sh
PATH=/sbin:/bin:/usr/sbin:/usr/bin:/usr/local/sbin:/usr/local/bin
# Order of crontab fields
# minute hour mday month wday command</pre>
</div>
</div>
<div class="paragraph">
<p>Then add a line for each command or script to run, specifying the time to run the command. This example runs the specified custom Bourne shell script every day at two in the afternoon. Since the path to the script is not specified in <code>PATH</code>, the full path to the script is given:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>0 14 * * * /home/user/bin/mycustomscript.sh</pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Before using a custom script, make sure it is executable and test it with the limited set of environment variables set by cron. To replicate the environment that would be used to run the above cron entry, use:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>env -i SHELL=/bin/sh PATH=/etc:/bin:/sbin:/usr/bin:/usr/sbin HOME=/home/user LOGNAME=user /home/user/bin/mycustomscript.sh</pre>
</div>
</div>
<div class="paragraph">
<p>The environment set by cron is discussed in <a href="https://man.freebsd.org/cgi/man.cgi?query=crontab&amp;sektion=5&amp;format=html">crontab(5)</a>. Checking that scripts operate correctly in a cron environment is especially important if they include any commands that delete files using wildcards.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>When finished editing the crontab, save the file. It will automatically be installed, and cron will read the crontab and run its cron jobs at their specified times. To list the cron jobs in a crontab, use this command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>crontab -l</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should be similar to the following:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>0 14 * * * /home/user/bin/mycustomscript.sh</pre>
</div>
</div>
<div class="paragraph">
<p>To remove all of the cron jobs in a user crontab:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>crontab -r</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should be similar to the following:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>remove crontab for user? y</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="configtuning-periodic">14.4.3. Periodic<a class="anchor" href="#configtuning-periodic"></a></h4>
<div class="paragraph">
<p>FreeBSD provides a set of system management scripts to check status of various subsystems, perform security-related checks, rotate log files, etc. These scripts are run on a periodic basis: daily. weekly, or monthly. The management of these tasks is performed by <a href="https://man.freebsd.org/cgi/man.cgi?query=periodic&amp;sektion=8&amp;format=html">periodic(8)</a> and its configuration resides in <a href="https://man.freebsd.org/cgi/man.cgi?query=periodic.conf&amp;sektion=5&amp;format=html">periodic.conf(5)</a>. The periodic tasks are initiated by entries in the system crontab, shown above.</p>
</div>
<div class="paragraph">
<p>Scripts executed by <a href="https://man.freebsd.org/cgi/man.cgi?query=periodic&amp;sektion=8&amp;format=html">periodic(8)</a> are located in <span class="filename">/etc/periodic/</span> for base utilities and in <span class="filename">/usr/local/etc/periodic/</span> for third-party software.</p>
</div>
<div class="paragraph">
<p>They are organized in 4 subdirectories, daily, weekly, monthly and security.</p>
</div>
</div>
<div class="sect3">
<h4 id="enable-disable-periodic">14.4.4. Enable or Disable Periodic Tasks<a class="anchor" href="#enable-disable-periodic"></a></h4>
<div class="paragraph">
<p>FreeBSD has some scripts enabled by default to run periodically.</p>
</div>
<div class="paragraph">
<p>To enable or disable a task, the first step is to edit <span class="filename">/etc/periodic.conf</span> executing the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ee /etc/periodic.conf</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And then to enable, for example, <code>daily_status_zfs_enable</code> put the following content in the file:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>daily_status_zfs_enable=&#34;YES&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>To disable a task that is active by default, all that needs to be done is to change <code>YES</code> to <code>NO</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="configuring-output-periodic-tasks">14.4.5. Configuring the Output of Periodic Tasks<a class="anchor" href="#configuring-output-periodic-tasks"></a></h4>
<div class="paragraph">
<p>In <span class="filename">/etc/periodic.conf</span> the variables <code>daily_output</code>, <code>weekly_output</code> and <code>monthly_output</code> specifies where to send the results of the script execution.</p>
</div>
<div class="paragraph">
<p>By default the output of the periodic scripts are emailed to root, and therefore it is best to read root’s mail or alias root to a mailbox that is monitored.</p>
</div>
<div class="paragraph">
<p>To send the results to another email or to other emails, add the email addresses separated by spaces to <span class="filename">/etc/periodic.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>daily_output=&#34;email1@example.com email2@example.com&#34;
weekly_output=&#34;email1@example.com email2@example.com&#34;
monthly_output=&#34;email1@example.com email2@example.com&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>To log periodic output instead of receiving it as email, add the following lines to <span class="filename">/etc/periodic.conf</span>. <a href="https://man.freebsd.org/cgi/man.cgi?query=newsyslog&amp;sektion=8&amp;format=html">newsyslog(8)</a> will rotate these files at the appropriate times:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>daily_output=/var/log/daily.log
weekly_output=/var/log/weekly.log
monthly_output=/var/log/monthly.log</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="configtuning-syslog">14.5. Configuring System Logging<a class="anchor" href="#configtuning-syslog"></a></h3>
<div class="paragraph">
<p>Generating and reading system logs is an important aspect of system administration. The information in system logs can be used to detect hardware and software issues as well as application and system configuration errors. This information also plays an important role in security auditing and incident response. Most system daemons and applications will generate log entries.</p>
</div>
<div class="paragraph">
<p>FreeBSD provides a system logger, <a href="https://man.freebsd.org/cgi/man.cgi?query=syslogd&amp;sektion=8&amp;format=html">syslogd(8)</a>, to manage logging. By default, syslogd is enabled and started when the system boots.</p>
</div>
<div class="paragraph">
<p>This section describes how to configure the FreeBSD system logger for both local and remote logging and how to perform log rotation and log management.</p>
</div>
<div class="sect3">
<h4 id="_configuring_local_logging">14.5.1. Configuring Local Logging<a class="anchor" href="#_configuring_local_logging"></a></h4>
<div class="paragraph">
<p>The configuration file, <span class="filename">/etc/syslog.conf</span>, controls what syslogd does with log entries as they are received. There are several parameters to control the handling of incoming events. The <em>facility</em> describes which subsystem generated the message, such as the kernel or a daemon, and the <em>level</em> describes the severity of the event that occurred. This makes it possible to configure if and where a log message is logged, depending on the facility and level. It is also possible to take action depending on the application that sent the message, and in the case of remote logging, the hostname of the machine generating the logging event.</p>
</div>
<div class="paragraph">
<p>This configuration file contains one line per action, where the syntax for each line is a selector field followed by an action field. The syntax of the selector field is <em>facility.level</em> which will match log messages from <em>facility</em> at level <em>level</em> or higher. It is also possible to add an optional comparison flag before the level to specify more precisely what is logged. Multiple selector fields can be used for the same action, and are separated with a semicolon (<code>;</code>). Using <code>*</code> will match everything. The action field denotes where to send the log message, such as to a file or remote log host.</p>
</div>
<div class="paragraph">
<p>As an example, here is the default <span class="filename">/etc/syslog.conf</span> from FreeBSD:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre># $FreeBSD$
#
#       Spaces ARE valid field separators in this file. However,
#       other *nix-like systems still insist on using tabs as field
#       separators. If you are sharing this file between systems, you
#       may want to use only tabs as field separators here.
#       Consult the syslog.conf(5) manpage.
*.err;kern.warning;auth.notice;mail.crit                /dev/console <i class="conum" data-value="1"></i><b>(1)</b>
*.notice;authpriv.none;kern.debug;lpr.info;mail.crit;news.err   /var/log/messages
security.*                                      /var/log/security
auth.info;authpriv.info                         /var/log/auth.log
mail.info                                       /var/log/maillog <i class="conum" data-value="2"></i><b>(2)</b>
cron.*                                          /var/log/cron
!-devd
*.=debug                                        /var/log/debug.log <i class="conum" data-value="3"></i><b>(3)</b>
*.emerg                                         *
daemon.info                                     /var/log/daemon.log
# uncomment this to log all writes to /dev/console to /var/log/console.log
# touch /var/log/console.log and chmod it to mode 600 before it will work
#console.info                                   /var/log/console.log
# uncomment this to enable logging of all log messages to /var/log/all.log
# touch /var/log/all.log and chmod it to mode 600 before it will work
#*.*                                            /var/log/all.log
# uncomment this to enable logging to a remote loghost named loghost
#*.*                                            @loghost
# uncomment these if you&#39;re running inn
# news.crit                                     /var/log/news/news.crit
# news.err                                      /var/log/news/news.err
# news.notice                                   /var/log/news/news.notice
# Uncomment this if you wish to see messages produced by devd
# !devd
# *.&gt;=notice                                    /var/log/devd.log <i class="conum" data-value="4"></i><b>(4)</b>
!*
include                                         /etc/syslog.d
include                                         /usr/local/etc/syslog.d</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Matches all messages with a level of <code>err</code> or higher, as well as <code>kern.warning</code>, <code>auth.notice</code> and <code>mail.crit</code>, and sends these log messages to the console (<span class="filename">/dev/console</span>). &lt;.&gt; Matches all messages from the <code>mail</code> facility at level <code>info</code> or above and logs the messages to <span class="filename">/var/log/maillog</span>. &lt;.&gt; Uses a comparison flag (<code>=</code>) to only match messages at level <code>debug</code> and logs them to <span class="filename">/var/log/debug.log</span>. &lt;.&gt; Is an example usage of a program specification. This makes the rules following it only valid for the specified program. In this case, only the messages generated by <a href="https://man.freebsd.org/cgi/man.cgi?query=devd&amp;sektion=8&amp;format=html">devd(8)</a> are logged to <span class="filename">/var/log/devd.log</span>.</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>For more information about <span class="filename">/etc/syslog.conf</span>, its syntax, and more advanced usage examples, see <a href="https://man.freebsd.org/cgi/man.cgi?query=syslog.conf&amp;sektion=5&amp;format=html">syslog.conf(5)</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="logging-facilities">14.5.2. Logging Facilities<a class="anchor" href="#logging-facilities"></a></h4>
<div class="paragraph">
<p>A facility describes the part of the system generating the message. Facilities are a way of separating the different messages so that it is easier for the user to consult the logs.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">表 24. syslog facilities</caption>
<colgroup>
<col style="width: 50%;"/>
<col style="width: 50%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">auth</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The authorization system: <a href="https://man.freebsd.org/cgi/man.cgi?query=login&amp;sektion=1&amp;format=html">login(1)</a>, <a href="https://man.freebsd.org/cgi/man.cgi?query=su&amp;sektion=1&amp;format=html">su(1)</a>, <a href="https://man.freebsd.org/cgi/man.cgi?query=getty&amp;sektion=8&amp;format=html">getty(8)</a>, etc.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">authpriv</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The same as auth, but logged to a file readable only by root.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">console</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Messages written to <span class="filename">/dev/console</span> by the kernel console output driver.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">cron</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Messages written by the <a href="https://man.freebsd.org/cgi/man.cgi?query=cron&amp;sektion=8&amp;format=html">cron(8)</a> daemon.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">daemon</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">System daemons, such as <a href="https://man.freebsd.org/cgi/man.cgi?query=routed&amp;sektion=8&amp;format=html">routed(8)</a>, that are not provided for explicitly by other facilities.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ftp</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The file transfer protocol daemons: <a href="https://man.freebsd.org/cgi/man.cgi?query=ftpd&amp;sektion=8&amp;format=html">ftpd(8)</a>, <a href="https://man.freebsd.org/cgi/man.cgi?query=tftpd&amp;sektion=8&amp;format=html">tftpd(8)</a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">kern</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Messages generated by the kernel. These cannot be generated by any user processes.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">lpr</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The line printer spooling system: <a href="https://man.freebsd.org/cgi/man.cgi?query=lpr&amp;sektion=1&amp;format=html">lpr(1)</a>, <a href="https://man.freebsd.org/cgi/man.cgi?query=lpc&amp;sektion=8&amp;format=html">lpc(8)</a>, <a href="https://man.freebsd.org/cgi/man.cgi?query=lpd&amp;sektion=8&amp;format=html">lpd(8)</a>, etc.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">mail</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The mail system.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">mark</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This facility adds a record every 20 minutes.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">news</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The network news system.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ntp</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The network time protocol system.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">security</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Security subsystems, such as <a href="https://man.freebsd.org/cgi/man.cgi?query=ipfw&amp;sektion=4&amp;format=html">ipfw(4)</a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">syslog</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Messages generated internally by syslogd(8).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">user</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Messages generated by random user processes. <strong>This is the default facility identifier if none is specified</strong>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">uucp</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The Unix-to-Unix Copy system. An ancient protocol. Really weird to see messages from this facility.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">local0 through local7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Reserved for local use.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="logging-levels">14.5.3. Logging Levels<a class="anchor" href="#logging-levels"></a></h4>
<div class="paragraph">
<p>The level describes the severity of the message, and is a keyword from the following ordered list (higher to lower):</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">表 25. syslog levels</caption>
<colgroup>
<col style="width: 50%;"/>
<col style="width: 50%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">emerg</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A panic condition. This is normally broadcast to all users.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">alert</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A condition that should be corrected immediately, such as a corrupted system database.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">crit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Critical conditions, e.g., hard device errors.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">err</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Errors.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">warning</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Warning messages.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">notice</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Conditions that are not error conditions, but should possibly be handled specially.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">info</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Informational messages.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">debug</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Messages that contain information normally of use only when debugging a program.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">none</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This special level disables a particular facility.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="read-log-messages">14.5.4. Read Log Messages<a class="anchor" href="#read-log-messages"></a></h4>
<div class="paragraph">
<p>By default FreeBSD log files use the format <a href="https://datatracker.ietf.org/doc/html/rfc3164">rfc3164</a>, also known as The BSD syslog Protocol. Learn more about other formats and how to use them at <a href="https://man.freebsd.org/cgi/man.cgi?query=syslog&amp;sektion=8&amp;format=html">syslog(8)</a>.</p>
</div>
<div class="paragraph">
<p>Typically the logs have the following syntax:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>date time hostname program[pid]: the message</pre>
</div>
</div>
<div class="paragraph">
<p>The output of the <span class="filename">/var/log/cron</span> file will be used as an example:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>[...]
Jul 16 12:40:00 FreeBSD /usr/sbin/cron[81519]: (root) CMD (/usr/libexec/atrun)
Jul 16 12:44:00 FreeBSD /usr/sbin/cron[83072]: (operator) CMD (/usr/libexec/save-entropy)
[...]</pre>
</div>
</div>
<div class="paragraph">
<p>Verbose logging, so the facility and the level on each message will be added, can be enabled in <a href="https://man.freebsd.org/cgi/man.cgi?query=syslog&amp;sektion=8&amp;format=html">syslog(8)</a> by running the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysrc syslogd_flags=&#34;-vv&#34;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Once the function is activated, the facility and the level will be displayed in the log as shown in the following example:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>[...]
Jul 16 17:40:00 &lt;cron.info&gt; FreeBSD /usr/sbin/cron[1016]: (root) CMD (/usr/libexec/atrun)
Jul 16 17:44:00 &lt;cron.info&gt; FreeBSD /usr/sbin/cron[1030]: (operator) CMD (/usr/libexec/save-entropy)
[...]</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_log_management_and_rotation">14.5.5. Log Management and Rotation<a class="anchor" href="#_log_management_and_rotation"></a></h4>
<div class="paragraph">
<p>Log files can grow quickly, taking up disk space and making it more difficult to locate useful information.</p>
</div>
<div class="paragraph">
<p>In FreeBSD, <a href="https://man.freebsd.org/cgi/man.cgi?query=newsyslog&amp;sektion=8&amp;format=html">newsyslog(8)</a> is used to manage log files and attempt to mitigate this.</p>
</div>
<div class="paragraph">
<p>This built-in program periodically rotates and compresses log files, and optionally creates missing log files and signals programs when log files are moved.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Since newsyslog is run from <a href="https://man.freebsd.org/cgi/man.cgi?query=cron&amp;sektion=8&amp;format=html">cron(8)</a>, it cannot rotate files more often than it is scheduled to run from <a href="https://man.freebsd.org/cgi/man.cgi?query=cron&amp;sektion=8&amp;format=html">cron(8)</a>. In the default configuration, it runs every hour.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Here is the default configuration in FreeBSD, more information in <a href="https://man.freebsd.org/cgi/man.cgi?query=newsyslog.conf&amp;sektion=5&amp;format=html">newsyslog.conf(5)</a>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre># configuration file for newsyslog
# $FreeBSD$
#
# Entries which do not specify the &#39;/pid_file&#39; field will cause the
# syslogd process to be signalled when that log file is rotated.  This
# action is only appropriate for log files which are written to by the
# syslogd process (ie, files listed in /etc/syslog.conf).  If there
# is no process which needs to be signalled when a given log file is
# rotated, then the entry for that file should include the &#39;N&#39; flag.
#
# Note: some sites will want to select more restrictive protections than the
# defaults.  In particular, it may be desirable to switch many of the 644
# entries to 640 or 600.  For example, some sites will consider the
# contents of maillog, messages, and lpd-errs to be confidential.  In the
# future, these defaults may change to more conservative ones.
#
# logfilename          [owner:group]    mode count size when  flags [/pid_file] [sig_num]
/var/log/all.log                        600  7     *    @T00  J
/var/log/auth.log                       600  7     1000 @0101T JC
/var/log/console.log                    600  5     1000 *     J
/var/log/cron                           600  3     1000 *     JC
/var/log/daily.log                      640  7     *    @T00  JN
/var/log/debug.log                      600  7     1000 *     JC
/var/log/init.log                       644  3     1000 *     J
/var/log/kerberos.log                   600  7     1000 *     J
/var/log/maillog                        640  7     *    @T00  JC
/var/log/messages                       644  5     1000 @0101T JC
/var/log/monthly.log                    640  12    *    $M1D0 JN
/var/log/devd.log                       644  3     1000 *     JC
/var/log/security                       600  10    1000 *     JC
/var/log/utx.log                        644  3     *    @01T05 B
/var/log/weekly.log                     640  5     *    $W6D0 JN
/var/log/daemon.log                     644  5     1000 @0101T JC

&lt;include&gt; /etc/newsyslog.conf.d/[!.]*.conf
&lt;include&gt; /usr/local/etc/newsyslog.conf.d/[!.]*.conf</pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>logfilename</code> - Name of the system log file to be archived.</p>
</li>
<li>
<p><code>[owner:group]</code> - This optional field specifies the owner and group for the archive file.</p>
</li>
<li>
<p><code>mode</code> - Specify the file mode of the log file and archives. Valid mode bits are 0666. (That is, read and write permissions for the rotated log may be specified for the owner, group, and others.)</p>
</li>
<li>
<p><code>count</code> - Specify the maximum number of archive files which may exist.</p>
</li>
<li>
<p><code>size</code> - When the size of the log file reaches size in kilobytes, the log file will be trimmed as described above. If this field contains an asterisk (&#39;*&#39;), the log file will not be trimmed based on size.</p>
</li>
<li>
<p><code>when</code> - Consist of an interval, a specific time, or both. Supported options in <a href="https://man.freebsd.org/cgi/man.cgi?query=newsyslog.conf&amp;sektion=5&amp;format=html">newsyslog.conf(5)</a>.</p>
</li>
<li>
<p><code>flags</code> - Indicates the flags that newsyslog accepts, supported options in <a href="https://man.freebsd.org/cgi/man.cgi?query=newsyslog.conf&amp;sektion=5&amp;format=html">newsyslog.conf(5)</a>.</p>
</li>
<li>
<p><code>[/pid_file]</code> - This optional field specifies the file name containing a daemon’s process ID or to find a group process ID.</p>
</li>
<li>
<p><code>[sig_num]</code> - This optional field specifies the signal that will be sent to the daemon process.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The last two fields are optional and specify the name of the Process ID (PID) file of a process and a signal number to send to that process when the file is rotated.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect3">
<h4 id="network-syslogd">14.5.6. Configuring Remote Logging<a class="anchor" href="#network-syslogd"></a></h4>
<div class="paragraph">
<p>Monitoring the log files of multiple hosts can become unwieldy as the number of systems increases. Configuring centralized logging can reduce some of the administrative burden of log file administration.</p>
</div>
<div class="paragraph">
<p>In FreeBSD, centralized log file aggregation, merging, and rotation can be configured using syslogd and newsyslog.</p>
</div>
<div class="paragraph">
<p>This section demonstrates an example configuration, where host <code>A</code>, named <code>logserv.example.com</code>, will collect logging information for the local network.</p>
</div>
<div class="paragraph">
<p>Host <code>B</code>, named <code>logclient.example.com</code>, will be configured to pass logging information to the logging server.</p>
</div>
<div class="sect4">
<h5 id="_log_server_configuration">14.5.6.1. Log Server Configuration<a class="anchor" href="#_log_server_configuration"></a></h5>
<div class="paragraph">
<p>A log server is a system that has been configured to accept logging information from other hosts.</p>
</div>
<div class="paragraph">
<p>Before configuring a log server, check the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If there is a firewall between the logging server and any logging clients, ensure that the firewall ruleset allows UDP port 514 for both the clients and the server.</p>
</li>
<li>
<p>The logging server and all client machines must have forward and reverse entries in the local DNS. If the network does not have a DNS server, create entries in each system’s <span class="filename">/etc/hosts</span>. Proper name resolution is required so that log entries are not rejected by the logging server.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>On the log server, edit <span class="filename">/etc/syslog.conf</span> to specify the name of the client to receive log entries from, the logging facility to be used, and the name of the log to store the host’s log entries. This example adds the hostname of <code>B</code>, logs all facilities, and stores the log entries in <span class="filename">/var/log/logclient.log</span>.</p>
</div>
<div class="exampleblock">
<div class="title">例 22. Sample Log Server Configuration</div>
<div class="content">
<div class="literalblock programlisting">
<div class="content">
<pre>+logclient.example.com
*.*     /var/log/logclient.log</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>When adding multiple log clients, add a similar two-line entry for each client. More information about the available facilities may be found in <a href="https://man.freebsd.org/cgi/man.cgi?query=syslog.conf&amp;sektion=5&amp;format=html">syslog.conf(5)</a>.</p>
</div>
<div class="paragraph">
<p>Next, execute the following commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysrc syslogd_enable=&#34;YES&#34;</span>
<span class="c"># sysrc syslogd_flags=&#34;-a logclient.example.com -v -v&#34;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The first entry starts syslogd at system boot. The second entry allows log entries from the specified client. The <code>-v -v</code> increases the verbosity of logged messages. This is useful for tweaking facilities as administrators are able to see what type of messages are being logged under each facility.</p>
</div>
<div class="paragraph">
<p>Multiple <code>-a</code> options may be specified to allow logging from multiple clients. IP addresses and whole netblocks may also be specified. Refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=syslogd&amp;sektion=8&amp;format=html">syslogd(8)</a> for a full list of possible options.</p>
</div>
<div class="paragraph">
<p>Finally, create the log file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># touch /var/log/logclient.log</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>At this point, syslogd should be restarted and verified:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># service syslogd restart</span>
<span class="c"># pgrep syslog</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If a PID is returned, the server restarted successfully, and client configuration can begin. If the server did not restart, consult <span class="filename">/var/log/messages</span> for the error.</p>
</div>
</div>
<div class="sect4">
<h5 id="_log_client_configuration">14.5.6.2. Log Client Configuration<a class="anchor" href="#_log_client_configuration"></a></h5>
<div class="paragraph">
<p>A logging client sends log entries to a logging server on the network. The client also keeps a local copy of its own logs.</p>
</div>
<div class="paragraph">
<p>Once a logging server has been configured, execute the following commands on the logging client:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysrc syslogd_enable=&#34;YES&#34;</span>
<span class="c"># sysrc syslogd_flags=&#34;-s -v -v&#34;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The first entry enables syslogd on boot up. The second entry prevents logs from being accepted by this client from other hosts (<code>-s</code>) and increases the verbosity of logged messages.</p>
</div>
<div class="paragraph">
<p>Next, define the logging server in the client’s <span class="filename">/etc/syslog.conf</span>. In this example, all logged facilities are sent to a remote system, denoted by the <code>@</code> symbol, with the specified hostname:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>*.*  @logserv.example.com</pre>
</div>
</div>
<div class="paragraph">
<p>After saving the edit, restart syslogd for the changes to take effect:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># service syslogd restart</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To test that log messages are being sent across the network, use <a href="https://man.freebsd.org/cgi/man.cgi?query=logger&amp;sektion=1&amp;format=html">logger(1)</a> on the client to send a message to syslogd:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># logger &#34;Test message from logclient&#34;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This message should now exist both in <span class="filename">/var/log/messages</span> on the client and <span class="filename">/var/log/logclient.log</span> on the log server.</p>
</div>
</div>
<div class="sect4">
<h5 id="_debugging_log_servers">14.5.6.3. Debugging Log Servers<a class="anchor" href="#_debugging_log_servers"></a></h5>
<div class="paragraph">
<p>If no messages are being received on the log server, the cause is most likely a network connectivity issue, a hostname resolution issue, or a typo in a configuration file. To isolate the cause, ensure that both the logging server and the logging client are able to <code>ping</code> each other using the hostname specified in their <span class="filename">/etc/rc.conf</span>. If this fails, check the network cabling, the firewall ruleset, and the hostname entries in the DNS server or <span class="filename">/etc/hosts</span> on both the logging server and clients. Repeat until the <code>ping</code> is successful from both hosts.</p>
</div>
<div class="paragraph">
<p>If the <code>ping</code> succeeds on both hosts but log messages are still not being received, temporarily increase logging verbosity to narrow down the configuration issue. In the following example, <span class="filename">/var/log/logclient.log</span> on the logging server is empty and <span class="filename">/var/log/messages</span> on the logging client does not indicate a reason for the failure.</p>
</div>
<div class="paragraph">
<p>To increase debugging output, edit the <code>syslogd_flags</code> entry on the logging server and issue a restart:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">sysrc <span class="nv">syslogd_flags</span><span class="o">=</span><span class="s2">&#34;-d -a logclient.example.com -v -v&#34;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># service syslogd restart</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Debugging data similar to the following will flash on the console immediately after the restart:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>logmsg: pri 56, flags 4, from logserv.example.com, msg syslogd: restart
syslogd: restarted
logmsg: pri 6, flags 4, from logserv.example.com, msg syslogd: kernel boot file is /boot/kernel/kernel
Logging to FILE /var/log/messages
syslogd: kernel boot file is /boot/kernel/kernel
cvthname(192.168.1.10)
validate: dgram from IP 192.168.1.10, port 514, name logclient.example.com;
rejected in rule 0 due to name mismatch.</pre>
</div>
</div>
<div class="paragraph">
<p>In this example, the log messages are being rejected due to a typo which results in a hostname mismatch. The client’s hostname should be <code>logclient</code>, not <code>logclien</code>. Fix the typo, issue a restart, and verify the results:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># service syslogd restart</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should be similar to the following:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>logmsg: pri 56, flags 4, from logserv.example.com, msg syslogd: restart
syslogd: restarted
logmsg: pri 6, flags 4, from logserv.example.com, msg syslogd: kernel boot file is /boot/kernel/kernel
syslogd: kernel boot file is /boot/kernel/kernel
logmsg: pri 166, flags 17, from logserv.example.com,
msg Dec 10 20:55:02 &lt;syslog.err&gt; logserv.example.com syslogd: exiting on signal 2
cvthname(192.168.1.10)
validate: dgram from IP 192.168.1.10, port 514, name logclient.example.com;
accepted in rule 0.
logmsg: pri 15, flags 0, from logclient.example.com, msg Dec 11 02:01:28 trhodes: Test message 2
Logging to FILE /var/log/logclient.log
Logging to FILE /var/log/messages</pre>
</div>
</div>
<div class="paragraph">
<p>At this point, the messages are being properly received and placed in the correct file.</p>
</div>
</div>
<div class="sect4">
<h5 id="_security_considerations">14.5.6.4. Security Considerations<a class="anchor" href="#_security_considerations"></a></h5>
<div class="paragraph">
<p>As with any network service, security requirements should be considered before implementing a logging server. Log files may contain sensitive data about services enabled on the local host, user accounts, and configuration data. Network data sent from the client to the server will not be encrypted or password protected. If a need for encryption exists, consider using <a class="package" href="https://cgit.freebsd.org/ports/tree/security/stunnel/">security/stunnel</a>, which will transmit the logging data over an encrypted tunnel.</p>
</div>
<div class="paragraph">
<p>Local security is also an issue. Log files are not encrypted during use or after log rotation. Local users may access log files to gain additional insight into system configuration. Setting proper permissions on log files is critical. The built-in log rotator, newsyslog, supports setting permissions on newly created and rotated log files. Setting log files to mode <code>600</code> should prevent unwanted access by local users. Refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=newsyslog.conf&amp;sektion=5&amp;format=html">newsyslog.conf(5)</a> for additional information.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="acpi-overview">14.6. Power and Resource Management<a class="anchor" href="#acpi-overview"></a></h3>
<div class="paragraph">
<p>It is important to utilize hardware resources in an efficient manner. Power and resource management allows the operating system to monitor system limits and to possibly run some actions triggered by events related to those limits.</p>
</div>
<div class="sect3">
<h4 id="acpi-config">14.6.1. ACPI configuration<a class="anchor" href="#acpi-config"></a></h4>
<div class="paragraph">
<p>On FreeBSD the management of these resources is managed by the <a href="https://man.freebsd.org/cgi/man.cgi?query=acpi&amp;sektion=4&amp;format=html">acpi(4)</a> kernel device.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In FreeBSD the <a href="https://man.freebsd.org/cgi/man.cgi?query=acpi&amp;sektion=4&amp;format=html">acpi(4)</a> driver is loaded by default at system boot.</p>
</div>
<div class="paragraph">
<p>This driver <strong>cannot be unloaded after boot</strong> because the system bus uses it for various hardware interactions.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>In addition to <a href="https://man.freebsd.org/cgi/man.cgi?query=acpi&amp;sektion=4&amp;format=html">acpi(4)</a>, FreeBSD has several dedicated kernel modules for various ACPI vendor subsystems. These modules will add some extra functionality like fan speed, keyboard backlit or screen brightness.</p>
</div>
<div class="paragraph">
<p>The list can be obtained by running the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>ls /boot/kernel | grep acpi</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should be similar to the following:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>acpi_asus.ko
acpi_asus_wmi.ko
acpi_dock.ko
acpi_fujitsu.ko
acpi_hp.ko
acpi_ibm.ko
acpi_panasonic.ko
acpi_sony.ko
acpi_toshiba.ko
acpi_video.ko
acpi_wmi.ko
sdhci_acpi.ko
uacpi.ko</pre>
</div>
</div>
<div class="paragraph">
<p>In the event that, for example, an IBM/Lenovo laptop is used, it will be necessary to load the module <a href="https://man.freebsd.org/cgi/man.cgi?query=acpi_ibm&amp;sektion=4&amp;format=html">acpi_ibm(4)</a> by executing the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># kldload acpi_ibm</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And add this line to <span class="filename">/boot/loader.conf</span> to load it at boot:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>acpi_ibm_load=&#34;YES&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>An alternative to the <a href="https://man.freebsd.org/cgi/man.cgi?query=acpi_video&amp;sektion=4&amp;format=html">acpi_video(4)</a> module is the <a href="https://man.freebsd.org/cgi/man.cgi?query=backlight&amp;sektion=9&amp;format=html">backlight(9)</a> driver. It provides a generic way for handling a panel backlight. The default GENERIC kernel includes this driver. The <a href="https://man.freebsd.org/cgi/man.cgi?query=backlight&amp;sektion=8&amp;format=html">backlight(8)</a> utility can be used to query and adjust the brightness of the panel backlight. In this example the brightness is decreased by 10%:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>backlight decr 10</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="cpu-power-management">14.6.2. CPU Power Management<a class="anchor" href="#cpu-power-management"></a></h4>
<div class="paragraph">
<p>CPU is the most consuming part of the system. Knowing how to improve CPU efficiency is a fundamental part of our system in order to save energy.</p>
</div>
<div class="paragraph">
<p>In order to make proper use of the machine’s resources in a correct way, FreeBSD supports technologies such as Intel Turbo Boost, AMD Turbo Core, Intel Speed Shift among others through the use of <a href="https://man.freebsd.org/cgi/man.cgi?query=powerd&amp;sektion=8&amp;format=html">powerd(8)</a> and cpufreq[4].</p>
</div>
<div class="paragraph">
<p>The first step will be to obtain the CPU information by executing the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>sysctl dev.cpu.0 <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>In this case the <code>0</code> digit represents the first core of the CPU.</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>The output should be similar to the following:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>dev.cpu.0.cx_method: C1/mwait/hwc C2/mwait/hwc C3/mwait/hwc/bma
dev.cpu.0.cx_usage_counters: 3507294 0 0
dev.cpu.0.cx_usage: 100.00% 0.00% 0.00% last 3804us
dev.cpu.0.cx_lowest: C3 <i class="conum" data-value="1"></i><b>(1)</b>
dev.cpu.0.cx_supported: C1/1/1 C2/2/1 C3/3/57 <i class="conum" data-value="2"></i><b>(2)</b>
dev.cpu.0.freq_levels: 2267/35000 2266/35000 1600/15000 800/12000 <i class="conum" data-value="3"></i><b>(3)</b>
dev.cpu.0.freq: 1600 <i class="conum" data-value="4"></i><b>(4)</b>
dev.cpu.0.temperature: 40.0C <i class="conum" data-value="5"></i><b>(5)</b>
dev.cpu.0.coretemp.throttle_log: 0
dev.cpu.0.coretemp.tjmax: 105.0C
dev.cpu.0.coretemp.resolution: 1
dev.cpu.0.coretemp.delta: 65
dev.cpu.0.%parent: acpi0
dev.cpu.0.%pnpinfo: _HID=none _UID=0 _CID=none
dev.cpu.0.%location: handle=\_PR_.CPU0
dev.cpu.0.%driver: cpu
dev.cpu.0.%desc: ACPI CPU</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Lowest Cx state to use for idling the CPU.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>CPU supported Cx states.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Currently available levels for the CPU (frequency/power usage).</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Current active CPU frequency in MHz.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Current temperature of the CPU.</td>
</tr>
</tbody></table>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If the temperature information is not displayed, load the <a href="https://man.freebsd.org/cgi/man.cgi?query=coretemp&amp;sektion=4&amp;format=html">coretemp(4)</a> module. In case of using an AMD CPU, load the <a href="https://man.freebsd.org/cgi/man.cgi?query=amdtemp&amp;sektion=4&amp;format=html">amdtemp(4)</a> module.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Once the CPU information is available the easiest way to configure power saving is to let <a href="https://man.freebsd.org/cgi/man.cgi?query=powerd&amp;sektion=8&amp;format=html">powerd(8)</a> take over.</p>
</div>
<div class="paragraph">
<p>Enable <a href="https://man.freebsd.org/cgi/man.cgi?query=powerd&amp;sektion=8&amp;format=html">powerd(8)</a> service in <span class="filename">/etc/rc.conf</span> to start at system boot:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysrc powerd_enable=YES</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>It will also be necessary to indicate certain parameters to <a href="https://man.freebsd.org/cgi/man.cgi?query=powerd&amp;sektion=8&amp;format=html">powerd(8)</a> to tell it how to manage the state of the CPU executing the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysrc powerd_flags=&#34;-a hiadaptive -i 25 -r 85 -N&#34;</span></code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>-a</code>: Selects the mode to use while on AC power.</p>
</li>
<li>
<p><code>hiadaptive</code>: Operation mode. More info at <a href="https://man.freebsd.org/cgi/man.cgi?query=powerd&amp;sektion=8&amp;format=html">powerd(8)</a>.</p>
</li>
<li>
<p><code>-i</code>: Specifies the CPU load percent level when adaptive mode should begin to degrade performance to save power.</p>
</li>
<li>
<p><code>-r</code>: Specifies the CPU load percent level where adaptive mode should consider the CPU running and increase performance.</p>
</li>
<li>
<p><code>-N</code>: Treat &#34;nice&#34; time as idle for the purpose of load calculation; i.e., do not increase the CPU frequency if the CPU is only busy with &#34;nice&#34; processes.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>And then enable the service executing the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># service powerd start</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="cpufreq">14.6.3. CPU Frequency Control<a class="anchor" href="#cpufreq"></a></h4>
<div class="paragraph">
<p>FreeBSD includes a generic <a href="https://man.freebsd.org/cgi/man.cgi?query=cpufreq&amp;sektion=4&amp;format=html">cpufreq(4)</a> driver to allow the administrator, or software such as <a href="https://man.freebsd.org/cgi/man.cgi?query=powerd&amp;sektion=8&amp;format=html">powerd(8)</a> and <a class="package" href="https://cgit.freebsd.org/ports/tree/sysutils/powerdxx/">sysutils/powerdxx</a>, to manage the frequency of the CPU to achieve the desired balance between performance and economy. A lower setting will save power while reducing the heat generated by the CPU. A higher setting will increase performance at the cost of using additional power and generating more heat.</p>
</div>
</div>
<div class="sect3">
<h4 id="est">14.6.4. Intel® Enhanced Speed Step™<a class="anchor" href="#est"></a></h4>
<div class="paragraph">
<p>The Intel® Enhanced Speed Step™ driver, <a href="https://man.freebsd.org/cgi/man.cgi?query=est&amp;sektion=4&amp;format=html">est(4)</a>, replaces the generic <a href="https://man.freebsd.org/cgi/man.cgi?query=cpufreq&amp;sektion=4&amp;format=html">cpufreq(4)</a> driver for CPUs that provide this feature. The CPU frequency can be statically adjusted using <a href="https://man.freebsd.org/cgi/man.cgi?query=sysctl&amp;sektion=8&amp;format=html">sysctl(8)</a>, or with the <code>/etc/rc.d/power_profile</code> startup script. Additional software, such as <a href="https://man.freebsd.org/cgi/man.cgi?query=powerd&amp;sektion=8&amp;format=html">powerd(8)</a> or <a class="package" href="https://cgit.freebsd.org/ports/tree/sysutils/powerdxx/">sysutils/powerdxx</a>, can be used to automatically adjust the CPU frequency based on processor utilization.</p>
</div>
<div class="paragraph">
<p>Each supported frequency, along with its expected power consumption, can be listed by examining the <a href="https://man.freebsd.org/cgi/man.cgi?query=sysctl&amp;sektion=3&amp;format=html">sysctl(3)</a> tree:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysctl dev.cpufreq.0.freq_driver dev.cpu.0.freq_levels dev.cpu.0.freq</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should be similar to the following:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>dev.cpufreq.0.freq_driver: est0
dev.cpu.0.freq_levels: 3001/53000 3000/53000 2900/50301 2700/46082 2600/43525 2400/39557 2300/37137 2100/33398 2000/31112 1800/27610 1700/25455 1500/22171 1400/20144 1200/17084 1100/15181 900/12329 800/10550
dev.cpu.0.freq: 800</pre>
</div>
</div>
<div class="paragraph">
<p>A frequency 1 MHz higher than the maximum frequency of the CPU indicates the Intel® Turbo Boost™ feature.</p>
</div>
</div>
<div class="sect3">
<h4 id="hwpstate_intel">14.6.5. Intel Speed Shift™<a class="anchor" href="#hwpstate_intel"></a></h4>
<div class="paragraph">
<p>Users running newer Intel® CPUs may find some differences in dynamic frequency control when upgrading to FreeBSD 13. A new driver for the Intel® Speed Shift™ feature set, available on certain SKUs, exposes the ability for the hardware to dynamically vary the core frequencies, including on a per core basis. FreeBSD 13 comes with the <a href="https://man.freebsd.org/cgi/man.cgi?query=hwpstate_intel&amp;sektion=4&amp;format=html">hwpstate_intel(4)</a> driver to automatically enable Speed Shift™ control on equipped CPUs, replacing the older Enhanced Speed Step™ <a href="https://man.freebsd.org/cgi/man.cgi?query=est&amp;sektion=4&amp;format=html">est(4)</a> driver. The <a href="https://man.freebsd.org/cgi/man.cgi?query=sysctl&amp;sektion=8&amp;format=html">sysctl(8)</a> <code>dev.cpufreq.%d.freq_driver</code> will indicate if the system is using Speed Shift.</p>
</div>
<div class="paragraph">
<p>To determine which frequency control driver is being used, examining the <code>dev.cpufreq.0.freq_driver</code> oid.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysctl dev.cpufreq.0.freq_driver</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should be similar to the following:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>dev.cpufreq.0.freq_driver: hwpstate_intel0</pre>
</div>
</div>
<div class="paragraph">
<p>This indicates that the new <a href="https://man.freebsd.org/cgi/man.cgi?query=hwpstate_intel&amp;sektion=4&amp;format=html">hwpstate_intel(4)</a> driver is in use. On such systems, the oid <code>dev.cpu.%d.freq_levels</code> will show only the maximum CPU frequency, and will indicate a power consumption level of <code>-1</code>.</p>
</div>
<div class="paragraph">
<p>The current CPU frequency can be determined by examining the <code>dev.cpu.%d.freq</code> oid.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysctl dev.cpu.0.freq_levels dev.cpu.0.freq</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should be similar to the following:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>dev.cpu.0.freq_levels: 3696/-1
dev.cpu.0.freq: 898</pre>
</div>
</div>
<div class="paragraph">
<p>For more information, including on how to balance performance and energy use, and on how to disable this driver, refer to the man page <a href="https://man.freebsd.org/cgi/man.cgi?query=hwpstate_intel&amp;sektion=4&amp;format=html">hwpstate_intel(4)</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Users accustomed to using <a href="https://man.freebsd.org/cgi/man.cgi?query=powerd&amp;sektion=8&amp;format=html">powerd(8)</a> or <a class="package" href="https://cgit.freebsd.org/ports/tree/sysutils/powerdxx/">sysutils/powerdxx</a> will find these utilities have been superseded by the <a href="https://man.freebsd.org/cgi/man.cgi?query=hwpstate_intel&amp;sektion=4&amp;format=html">hwpstate_intel(4)</a> driver and no longer work as expected.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect3">
<h4 id="graphics-card-power-management">14.6.6. Graphics Card Power Management<a class="anchor" href="#graphics-card-power-management"></a></h4>
<div class="paragraph">
<p>Graphics cards have become a fundamental part of computing in recent years. Some graphics cards may have excessive power consumption. FreeBSD allows certain configurations to improve power consumption.</p>
</div>
<div class="paragraph">
<p>In case of using a Intel® graphics card with the <a class="package" href="https://cgit.freebsd.org/ports/tree/graphics/drm-kmod/">graphics/drm-kmod</a> driver these options can be added to <span class="filename">/boot/loader.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>compat.linuxkpi.fastboot=1 <i class="conum" data-value="1"></i><b>(1)</b>
compat.linuxkpi.enable_dc=2 <i class="conum" data-value="2"></i><b>(2)</b>
compat.linuxkpi.enable_fbc=1 <i class="conum" data-value="3"></i><b>(3)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Try to skip unnecessary mode sets at boot time. &lt;.&gt; Enable power-saving display C-states. &lt;.&gt; Enable frame buffer compression for power savings</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect3">
<h4 id="_suspendresume">14.6.7. Suspend/Resume<a class="anchor" href="#_suspendresume"></a></h4>
<div class="paragraph">
<p>The suspend/resume function allows the machine to be kept in a state in which there is no a big energy consumption and allows the system to be resumed without having to lose the state of the running programs.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In order for the suspend/resume functionality to work correctly the graphics drivers must be loaded on the system. In non-KMS-supported graphics cards <a href="https://man.freebsd.org/cgi/man.cgi?query=sc&amp;sektion=4&amp;format=html">sc(4)</a> must be used not to break the suspend/resume functionality.</p>
</div>
<div class="paragraph">
<p>More information about which driver to use and how to configure it can be found at the <a href="./#x11">The X Window System chapter</a>.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p><a href="https://man.freebsd.org/cgi/man.cgi?query=acpi&amp;sektion=4&amp;format=html">acpi(4)</a> supports the next list of sleep states:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">表 26. Supported Sleep States</caption>
<colgroup>
<col style="width: 50%;"/>
<col style="width: 50%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">S1</th>
<th class="tableblock halign-left valign-top">Quick suspend to RAM. The CPU enters a lower power state, but most peripherals are left running.</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">S2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Lower power state than S1, but with the same basic characteristics. Not supported by many systems.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">S3 (Sleep mode)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Suspend to RAM. Most devices are powered off, and the system stops running except for memory refresh.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">S4 (Hibernation)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Suspend to disk. All devices are powered off, and the system stops running. When resuming, the system starts as if from a cold power on. <strong>Not yet supported by FreeBSD</strong>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">S5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">System shuts down cleanly and powers off.</p></td>
</tr>
</tbody>
</table>
<div class="sect4">
<h5 id="configure-suspend-resume">14.6.7.1. Configuring Suspend/Resume<a class="anchor" href="#configure-suspend-resume"></a></h5>
<div class="paragraph">
<p>The first step will be to know which type of sleep states supports the hardware we are using executing the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>sysctl hw.acpi.supported_sleep_state</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should be similar to the following:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>hw.acpi.supported_sleep_state: S3 S4 S5</pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>As stated above FreeBSD does <strong>not</strong> yet support the <code>S4</code> state.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p><a href="https://man.freebsd.org/cgi/man.cgi?query=acpiconf&amp;sektion=8&amp;format=html">acpiconf(8)</a> can be used to check if the <code>S3</code> state works correctly by running the following command, if it succeeds, the screen should go black and the machine will turn off:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># acpiconf -s 3</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In the vast majority of cases the Suspend/Resume functionality wants to be used on a laptop.</p>
</div>
<div class="paragraph">
<p>FreeBSD can be configured to enter the <code>S3</code> state when closing the lid by adding the following line to the <span class="filename">/etc/sysctl.conf</span> file.</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>hw.acpi.lid_switch_state=S3</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="troubleshooting-suspend-resume">14.6.7.2. Troubleshooting in Suspend/Resume<a class="anchor" href="#troubleshooting-suspend-resume"></a></h5>
<div class="paragraph">
<p>A lot of effort has been made to make the Suspend and Resume functions work properly and in the best way on FreeBSD. But currently the Suspend and Resume functions only work properly on some specific laptops.</p>
</div>
<div class="paragraph">
<p>Some checks can be done in case it doesn’t work properly.</p>
</div>
<div class="paragraph">
<p>In some cases it is enough to turn off the bluetooth. In others it is enough loading the correct driver for the graphics card, etc.</p>
</div>
<div class="paragraph">
<p>In case it doesn’t work correctly, some tips can be found on the FreeBSD Wiki in the section <a href="https://wiki.freebsd.org/SuspendResume">Suspend/Resume</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="adding-swap-space">14.7. Adding Swap Space<a class="anchor" href="#adding-swap-space"></a></h3>
<div class="paragraph">
<p>Sometimes a FreeBSD system requires more swap space. This section describes two methods to increase swap space: adding swap to an existing partition or new hard drive, and creating a swap file on an existing file system.</p>
</div>
<div class="paragraph">
<p>For information on how to encrypt swap space, which options exist, and why it should be done, refer to <a href="./#swap-encrypting">“Encrypting Swap”</a>.</p>
</div>
<div class="sect3">
<h4 id="new-drive-swap">14.7.1. Swap on a New Hard Drive or Existing Partition<a class="anchor" href="#new-drive-swap"></a></h4>
<div class="paragraph">
<p>Adding a new drive for swap gives better performance than using a partition on an existing drive. Setting up partitions and drives is explained in <a href="./#disks-adding">Adding Disks</a> while <a href="./#configtuning-initial">Designing the Partition Layout</a> discusses partition layouts and swap partition size considerations.</p>
</div>
<div class="admonitionblock warning">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>It is possible to use any partition not currently mounted, even if it already contains data. Using <code>swapon</code> on a partition that contains data will overwrite and destroy that data. Make sure that the partition to be added as swap is really the intended partition before running <code>swapon</code>.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p><a href="https://man.freebsd.org/cgi/man.cgi?query=swapon&amp;sektion=8&amp;format=html">swapon(8)</a> can be used to add a swap partition to the system executing the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># swapon /dev/ada1p2</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To automatically add this swap partition on boot, add an entry to <span class="filename">/etc/fstab</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>/dev/ada1p2 none swap sw 0 0</pre>
</div>
</div>
<div class="paragraph">
<p>See <a href="https://man.freebsd.org/cgi/man.cgi?query=fstab&amp;sektion=5&amp;format=html">fstab(5)</a> for an explanation of the entries in <span class="filename">/etc/fstab</span>.</p>
</div>
</div>
<div class="sect3">
<h4 id="create-swapfile">14.7.2. Creating a Swap File<a class="anchor" href="#create-swapfile"></a></h4>
<div id="swapfile-10-and-later" class="paragraph">
<p>These examples create a 512M swap file called <span class="filename">/usr/swap0</span>.</p>
</div>
<div class="admonitionblock warning">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Swap files on ZFS file systems are strongly discouraged, as swapping can lead to system hangs.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>The first step is to create the swap file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># dd if=/dev/zero of=/usr/swap0 bs=1m count=512</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The second step is to put the proper permissions on the new file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># chmod 0600 /usr/swap0</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The third step is to inform the system about the swap file by adding a line to <span class="filename">/etc/fstab</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>md none swap sw,file=/usr/swap0,late 0 0</pre>
</div>
</div>
<div class="paragraph">
<p>Swap space will be added on system startup. To add swap space immediately, use <a href="https://man.freebsd.org/cgi/man.cgi?query=swapon&amp;sektion=8&amp;format=html">swapon(8)</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># swapon -aL</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="boot">Chapter 15. The FreeBSD Booting Process<a class="anchor" href="#boot"></a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="boot-synopsis">15.1. Synopsis<a class="anchor" href="#boot-synopsis"></a></h3>
<div class="paragraph">
<p>The process of starting a computer and loading the operating system is referred to as &#34;the bootstrap process&#34;, or &#34;booting&#34;. FreeBSD’s boot process provides a great deal of flexibility in customizing what happens when the system starts, including the ability to select from different operating systems installed on the same computer, different versions of the same operating system, or a different installed kernel.</p>
</div>
<div class="paragraph">
<p>This chapter details the configuration options that can be set. It demonstrates how to customize the FreeBSD boot process, including everything that happens until the FreeBSD kernel has started, probed for devices, and started <a href="https://man.freebsd.org/cgi/man.cgi?query=init&amp;sektion=8&amp;format=html">init(8)</a>. This occurs when the text color of the boot messages changes from bright white to grey.</p>
</div>
<div class="paragraph">
<p>After reading this chapter, you will recognize:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The components of the FreeBSD bootstrap system and how they interact.</p>
</li>
<li>
<p>The options that can be passed to the components in the FreeBSD bootstrap in order to control the boot process.</p>
</li>
<li>
<p>The basics of setting device hints.</p>
</li>
<li>
<p>How to boot into single- and multi-user mode and how to properly shut down a FreeBSD system.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This chapter only describes the boot process for FreeBSD running on x86 and amd64 systems.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect2">
<h3 id="boot-introduction">15.2. FreeBSD Boot Process<a class="anchor" href="#boot-introduction"></a></h3>
<div class="paragraph">
<p>Turning on a computer and starting the operating system poses an interesting dilemma. By definition, the computer does not know how to do anything until the operating system is started. This includes running programs from the disk. If the computer can not run a program from the disk without the operating system, and the operating system programs are on the disk, how is the operating system started?</p>
</div>
<div class="paragraph">
<p>This problem parallels one in the book The Adventures of Baron Munchausen. A character had fallen part way down a manhole, and pulled himself out by grabbing his bootstraps and lifting. In the early days of computing, the term <em>bootstrap</em> was applied to the mechanism used to load the operating system. It has since become shortened to &#34;booting&#34;.</p>
</div>
<div class="paragraph">
<p>On x86 hardware, the Basic Input/Output System (BIOS) is responsible for loading the operating system. The BIOS looks on the hard disk for the Master Boot Record (MBR), which must be located in a specific place on the disk. The BIOS has enough knowledge to load and run the MBR, and assumes that the MBR can then carry out the rest of the tasks involved in loading the operating system, possibly with the help of the BIOS.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>FreeBSD provides for booting from both the older MBR standard, and the newer GUID Partition Table (GPT). GPT partitioning is often found on computers with the Unified Extensible Firmware Interface (UEFI). However, FreeBSD can boot from GPT partitions even on machines with only a legacy BIOS with <a href="https://man.freebsd.org/cgi/man.cgi?query=gptboot&amp;sektion=8&amp;format=html">gptboot(8)</a>. Work is under way to provide direct UEFI booting.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>The code within the MBR is typically referred to as a <em>boot manager</em>, especially when it interacts with the user. The boot manager usually has more code in the first track of the disk or within the file system. Examples of boot managers include the standard FreeBSD boot manager boot0, also called Boot Easy, and GNU GRUB, which is used by many Linux® distributions.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Users of GRUB should refer to <a href="https://www.gnu.org/software/grub/grub-documentation.html">GNU-provided documentation</a>.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>If only one operating system is installed, the MBR searches for the first bootable (active) slice on the disk, and then runs the code on that slice to load the remainder of the operating system. When multiple operating systems are present, a different boot manager can be installed to display a list of operating systems so the user can select one to boot.</p>
</div>
<div class="paragraph">
<p>The remainder of the FreeBSD bootstrap system is divided into three stages. The first stage knows just enough to get the computer into a specific state and run the second stage. The second stage can do a little bit more, before running the third stage. The third stage finishes the task of loading the operating system. The work is split into three stages because the MBR puts limits on the size of the programs that can be run at stages one and two. Chaining the tasks together allows FreeBSD to provide a more flexible loader.</p>
</div>
<div class="paragraph">
<p>The kernel is then started and begins to probe for devices and initialize them for use. Once the kernel boot process is finished, the kernel passes control to the user process <a href="https://man.freebsd.org/cgi/man.cgi?query=init&amp;sektion=8&amp;format=html">init(8)</a>, which makes sure the disks are in a usable state, starts the user-level resource configuration which mounts file systems, sets up network cards to communicate on the network, and starts the processes which have been configured to run at startup.</p>
</div>
<div class="paragraph">
<p>This section describes these stages in more detail and demonstrates how to interact with the FreeBSD boot process.</p>
</div>
<div class="sect3">
<h4 id="boot-boot0">15.2.1. The Boot Manager<a class="anchor" href="#boot-boot0"></a></h4>
<div class="paragraph">
<p>The boot manager code in the MBR is sometimes referred to as <em>stage zero</em> of the boot process. By default, FreeBSD uses the boot0 boot manager.</p>
</div>
<div class="paragraph">
<p>The MBR installed by the FreeBSD installer is based on <span class="filename">/boot/boot0</span>. The size and capability of boot0 is restricted to 446 bytes due to the slice table and <code>0x55AA</code> identifier at the end of the MBR. If boot0 and multiple operating systems are installed, a message similar to this example will be displayed at boot time:</p>
</div>
<div id="boot-boot0-example" class="exampleblock">
<div class="title">例 23. <span class="filename">boot0</span> Screenshot</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">F1 Win
F2 FreeBSD

Default: F2</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Other operating systems will overwrite an existing MBR if they are installed after FreeBSD. If this happens, or to replace the existing MBR with the FreeBSD MBR, use the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># fdisk -B -b /boot/boot0 device</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>where <em>device</em> is the boot disk, such as <span class="filename">ad0</span> for the first IDE disk, <span class="filename">ad2</span> for the first IDE disk on a second IDE controller, or <span class="filename">da0</span> for the first SCSI disk. To create a custom configuration of the MBR, refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=boot0cfg&amp;sektion=8&amp;format=html">boot0cfg(8)</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="boot-boot1">15.2.2. Stage One and Stage Two<a class="anchor" href="#boot-boot1"></a></h4>
<div class="paragraph">
<p>Conceptually, the first and second stages are part of the same program on the same area of the disk. Due to space constraints, they have been split into two, but are always installed together. They are copied from the combined <span class="filename">/boot/boot</span> by the FreeBSD installer or <code>bsdlabel</code>.</p>
</div>
<div class="paragraph">
<p>These two stages are located outside file systems, in the first track of the boot slice, starting with the first sector. This is where boot0, or any other boot manager, expects to find a program to run which will continue the boot process.</p>
</div>
<div class="paragraph">
<p>The first stage, <span class="filename">boot1</span>, is very simple, since it can only be 512 bytes in size. It knows just enough about the FreeBSD <em>bsdlabel</em>, which stores information about the slice, to find and execute <span class="filename">boot2</span>.</p>
</div>
<div class="paragraph">
<p>Stage two, <span class="filename">boot2</span>, is slightly more sophisticated, and understands the FreeBSD file system enough to find files. It can provide a simple interface to choose the kernel or loader to run. It runs loader, which is much more sophisticated and provides a boot configuration file. If the boot process is interrupted at stage two, the following interactive screen is displayed:</p>
</div>
<div id="boot-boot2-example" class="exampleblock">
<div class="title">例 24. <span class="filename">boot2</span> Screenshot</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">&gt;&gt; </span>FreeBSD/i386 BOOT
Default: 0:ad<span class="o">(</span>0,a<span class="o">)</span>/boot/loader
boot:</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>To replace the installed <span class="filename">boot1</span> and <span class="filename">boot2</span>, use <code>bsdlabel</code>, where <em>diskslice</em> is the disk and slice to boot from, such as <span class="filename">ad0s1</span> for the first slice on the first IDE disk:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># bsdlabel -B diskslice</span></code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If just the disk name is used, such as <span class="filename">ad0</span>, <code>bsdlabel</code> will create the disk in &#34;dangerously dedicated mode&#34;, without slices. This is probably not the desired action, so double check the <em>diskslice</em> before pressing <kbd>Return</kbd>.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect3">
<h4 id="boot-loader">15.2.3. Stage Three<a class="anchor" href="#boot-loader"></a></h4>
<div class="paragraph">
<p>The loader is the final stage of the three-stage bootstrap process. It is located on the file system, usually as <span class="filename">/boot/loader</span>.</p>
</div>
<div class="paragraph">
<p>The loader is intended as an interactive method for configuration, using a built-in command set, backed up by a more powerful interpreter which has a more complex command set.</p>
</div>
<div class="paragraph">
<p>During initialization, loader will probe for a console and for disks, and figure out which disk it is booting from. It will set variables accordingly, and an interpreter is started where user commands can be passed from a script or interactively.</p>
</div>
<div class="paragraph">
<p>The loader will then read <span class="filename">/boot/loader.rc</span>, which by default reads in <span class="filename">/boot/defaults/loader.conf</span> which sets reasonable defaults for variables and reads <span class="filename">/boot/loader.conf</span> for local changes to those variables. <span class="filename">loader.rc</span> then acts on these variables, loading whichever modules and kernel are selected.</p>
</div>
<div class="paragraph">
<p>Finally, by default, loader issues a 10 second wait for key presses, and boots the kernel if it is not interrupted. If interrupted, the user is presented with a prompt which understands the command set, where the user may adjust variables, unload all modules, load modules, and then finally boot or reboot. <a href="#boot-loader-commands">Loader Built-In Commands</a> lists the most commonly used loader commands. For a complete discussion of all available commands, refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=loader&amp;sektion=8&amp;format=html">loader(8)</a>.</p>
</div>
<table id="boot-loader-commands" class="tableblock frame-none grid-all stretch">
<caption class="title">表 27. Loader Built-In Commands</caption>
<colgroup>
<col style="width: 20%;"/>
<col style="width: 80%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Variable</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">autoboot <em>seconds</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Proceeds to boot the kernel if not interrupted within the time span given, in seconds. It displays a countdown, and the default time span is 10 seconds.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">boot [<code>-options</code>] [<code>kernelname</code>]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Immediately proceeds to boot the kernel, with any specified options or kernel name. Providing a kernel name on the command-line is only applicable after an <code>unload</code> has been issued. Otherwise, the previously-loaded kernel will be used. If <em>kernelname</em> is not qualified, it will be searched under <em>/boot/kernel</em> and <em>/boot/modules</em>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">boot-conf</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Goes through the same automatic configuration of modules based on specified variables, most commonly <code>kernel</code>. This only makes sense if <code>unload</code> is used first, before changing some variables.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">help [<code><em>topic</em></code>]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Shows help messages read from <span class="filename">/boot/loader.help</span>. If the topic given is <code>index</code>, the list of available topics is displayed.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">include <code><em>filename</em></code> …​</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Reads the specified file and interprets it line by line. An error immediately stops the <code>include</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">load [-t <code><em>type</em></code>] <code><em>filename</em></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Loads the kernel, kernel module, or file of the type given, with the specified filename. Any arguments after <em>filename</em> are passed to the file. If <em>filename</em> is not qualified, it will be searched under <em>/boot/kernel</em> and <em>/boot/modules</em>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ls [-l] [<code><em>path</em></code>]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Displays a listing of files in the given path, or the root directory, if the path is not specified. If <code>-l</code> is specified, file sizes will also be shown.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">lsdev [<code>-v</code>]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Lists all of the devices from which it may be possible to load modules. If <code>-v</code> is specified, more details are printed.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">lsmod [<code>-v</code>]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Displays loaded modules. If <code>-v</code> is specified, more details are shown.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">more <code><em>filename</em></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Displays the files specified, with a pause at each <code>LINES</code> displayed.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">reboot</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Immediately reboots the system.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">set <code><em>variable</em></code>, set <code><em>variable=value</em></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets the specified environment variables.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">unload</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Removes all loaded modules.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Here are some practical examples of loader usage. To boot the usual kernel in single-user mode:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"> boot -s</code></pre>
</div>
</div>
<div class="paragraph">
<p>To unload the usual kernel and modules and then load the previous or another, specified kernel:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"> unload
 load /path/to/kernelfile</code></pre>
</div>
</div>
<div class="paragraph">
<p>Use the qualified <span class="filename">/boot/GENERIC/kernel</span> to refer to the default kernel that comes with an installation, or <span class="filename">/boot/kernel.old/kernel</span>, to refer to the previously installed kernel before a system upgrade or before configuring a custom kernel.</p>
</div>
<div class="paragraph">
<p>Use the following to load the usual modules with another kernel. Note that in this case it is not necessary the qualified name:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">unload
<span class="nb">set </span><span class="nv">kernel</span><span class="o">=</span><span class="s2">&#34;mykernel&#34;</span>
boot-conf</code></pre>
</div>
</div>
<div class="paragraph">
<p>To load an automated kernel configuration script:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"> load -t userconfig_script /boot/kernel.conf</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="boot-init">15.2.4. Last Stage<a class="anchor" href="#boot-init"></a></h4>
<div class="paragraph">
<p>Once the kernel is loaded by either loader or by boot2, which bypasses loader, it examines any boot flags and adjusts its behavior as necessary. <a href="#boot-kernel">Kernel Interaction During Boot</a> lists the commonly used boot flags. Refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=boot&amp;sektion=8&amp;format=html">boot(8)</a> for more information on the other boot flags.</p>
</div>
<table id="boot-kernel" class="tableblock frame-none grid-all stretch">
<caption class="title">表 28. Kernel Interaction During Boot</caption>
<colgroup>
<col style="width: 50%;"/>
<col style="width: 50%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Option</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>-a</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">During kernel initialization, ask for the device to mount as the root file system.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>-C</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Boot the root file system from a CDROM.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>-s</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Boot into single-user mode.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>-v</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Be more verbose during kernel startup.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Once the kernel has finished booting, it passes control to the user process <a href="https://man.freebsd.org/cgi/man.cgi?query=init&amp;sektion=8&amp;format=html">init(8)</a>, which is located at <span class="filename">/sbin/init</span>, or the program path specified in the <code>init_path</code> variable in <code>loader</code>. This is the last stage of the boot process.</p>
</div>
<div class="paragraph">
<p>The boot sequence makes sure that the file systems available on the system are consistent. If a UFS file system is not, and <code>fsck</code> cannot fix the inconsistencies, init drops the system into single-user mode so that the system administrator can resolve the problem directly. Otherwise, the system boots into multi-user mode.</p>
</div>
<div class="sect4">
<h5 id="boot-singleuser">15.2.4.1. Single-User Mode<a class="anchor" href="#boot-singleuser"></a></h5>
<div class="paragraph">
<p>A user can specify this mode by booting with <code>-s</code> or by setting the <code>boot_single</code> variable in loader. It can also be reached by running <code>shutdown now</code> from multi-user mode. Single-user mode begins with this message:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>Enter full pathname of shell or RETURN for /bin/sh:</pre>
</div>
</div>
<div class="paragraph">
<p>If the user presses <kbd>Enter</kbd>, the system will enter the default Bourne shell. To specify a different shell, input the full path to the shell.</p>
</div>
<div class="paragraph">
<p>Single-user mode is usually used to repair a system that will not boot due to an inconsistent file system or an error in a boot configuration file. It can also be used to reset the <code>root</code> password when it is unknown. These actions are possible as the single-user mode prompt gives full, local access to the system and its configuration files. There is no networking in this mode.</p>
</div>
<div class="paragraph">
<p>While single-user mode is useful for repairing a system, it poses a security risk unless the system is in a physically secure location. By default, any user who can gain physical access to a system will have full control of that system after booting into single-user mode.</p>
</div>
<div class="paragraph">
<p>If the system <code>console</code> is changed to <code>insecure</code> in <span class="filename">/etc/ttys</span>, the system will first prompt for the <code>root</code> password before initiating single-user mode. This adds a measure of security while removing the ability to reset the <code>root</code> password when it is unknown.</p>
</div>
<div id="boot-insecure-console" class="exampleblock">
<div class="title">例 25. Configuring an Insecure Console in <span class="filename">/etc/ttys</span></div>
<div class="content">
<div class="literalblock programlisting">
<div class="content">
<pre># name  getty                           type    status          comments
#
# If console is marked &#34;insecure&#34;, then init will ask for the root password
# when going to single-user mode.
console none                            unknown off insecure</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>An <code>insecure</code> console means that physical security to the console is considered to be insecure, so only someone who knows the <code>root</code> password may use single-user mode.</p>
</div>
</div>
<div class="sect4">
<h5 id="boot-multiuser">15.2.4.2. Multi-User Mode<a class="anchor" href="#boot-multiuser"></a></h5>
<div class="paragraph">
<p>If init finds the file systems to be in order, or once the user has finished their commands in single-user mode and has typed <code>exit</code> to leave single-user mode, the system enters multi-user mode, in which it starts the resource configuration of the system.</p>
</div>
<div class="paragraph">
<p>The resource configuration system reads in configuration defaults from <span class="filename">/etc/defaults/rc.conf</span> and system-specific details from <span class="filename">/etc/rc.conf</span>. It then proceeds to mount the system file systems listed in <span class="filename">/etc/fstab</span>. It starts up networking services, miscellaneous system daemons, then the startup scripts of locally installed packages.</p>
</div>
<div class="paragraph">
<p>To learn more about the resource configuration system, refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=rc&amp;sektion=8&amp;format=html">rc(8)</a> and examine the scripts located in <span class="filename">/etc/rc.d</span>.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="device-hints">15.3. Device Hints<a class="anchor" href="#device-hints"></a></h3>
<div class="paragraph">
<p>During initial system startup, the boot <a href="https://man.freebsd.org/cgi/man.cgi?query=loader&amp;sektion=8&amp;format=html">loader(8)</a> reads <a href="https://man.freebsd.org/cgi/man.cgi?query=device.hints&amp;sektion=5&amp;format=html">device.hints(5)</a>. This file stores kernel boot information known as variables, sometimes referred to as &#34;device hints&#34;. These &#34;device hints&#34; are used by device drivers for device configuration.</p>
</div>
<div class="paragraph">
<p>Device hints may also be specified at the Stage 3 boot loader prompt, as demonstrated in <a href="#boot-loader">Stage Three</a>. Variables can be added using <code>set</code>, removed with <code>unset</code>, and viewed <code>show</code>. Variables set in <span class="filename">/boot/device.hints</span> can also be overridden. Device hints entered at the boot loader are not permanent and will not be applied on the next reboot.</p>
</div>
<div class="paragraph">
<p>Once the system is booted, <a href="https://man.freebsd.org/cgi/man.cgi?query=kenv&amp;sektion=1&amp;format=html">kenv(1)</a> can be used to dump all of the variables.</p>
</div>
<div class="paragraph">
<p>The syntax for <span class="filename">/boot/device.hints</span> is one variable per line, using the hash &#34;#&#34; as comment markers. Lines are constructed as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"> hint.driver.unit.keyword<span class="o">=</span><span class="s2">&#34;value&#34;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The syntax for the Stage 3 boot loader is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"> <span class="nb">set </span>hint.driver.unit.keyword<span class="o">=</span>value</code></pre>
</div>
</div>
<div class="paragraph">
<p>where <code>driver</code> is the device driver name, <code>unit</code> is the device driver unit number, and <code>keyword</code> is the hint keyword. The keyword may consist of the following options:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>at</code>: specifies the bus which the device is attached to.</p>
</li>
<li>
<p><code>port</code>: specifies the start address of the I/O to be used.</p>
</li>
<li>
<p><code>irq</code>: specifies the interrupt request number to be used.</p>
</li>
<li>
<p><code>drq</code>: specifies the DMA channel number.</p>
</li>
<li>
<p><code>maddr</code>: specifies the physical memory address occupied by the device.</p>
</li>
<li>
<p><code>flags</code>: sets various flag bits for the device.</p>
</li>
<li>
<p><code>disabled</code>: if set to <code>1</code> the device is disabled.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Since device drivers may accept or require more hints not listed here, viewing a driver’s manual page is recommended. For more information, refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=device.hints&amp;sektion=5&amp;format=html">device.hints(5)</a>, <a href="https://man.freebsd.org/cgi/man.cgi?query=kenv&amp;sektion=1&amp;format=html">kenv(1)</a>, <a href="https://man.freebsd.org/cgi/man.cgi?query=loader.conf&amp;sektion=5&amp;format=html">loader.conf(5)</a>, and <a href="https://man.freebsd.org/cgi/man.cgi?query=loader&amp;sektion=8&amp;format=html">loader(8)</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="boot-shutdown">15.4. Shutdown Sequence<a class="anchor" href="#boot-shutdown"></a></h3>
<div class="paragraph">
<p>Upon controlled shutdown using <a href="https://man.freebsd.org/cgi/man.cgi?query=shutdown&amp;sektion=8&amp;format=html">shutdown(8)</a>, <a href="https://man.freebsd.org/cgi/man.cgi?query=init&amp;sektion=8&amp;format=html">init(8)</a> will attempt to run the script <span class="filename">/etc/rc.shutdown</span>, and then proceed to send all processes the <code>TERM</code> signal, and subsequently the <code>KILL</code> signal to any that do not terminate in a timely manner.</p>
</div>
<div class="paragraph">
<p>To power down a FreeBSD machine on architectures and systems that support power management, use <code>shutdown -p now</code> to turn the power off immediately. To reboot a FreeBSD system, use <code>shutdown -r now</code>. One must be <code>root</code> or a member of <code>operator</code> in order to run <a href="https://man.freebsd.org/cgi/man.cgi?query=shutdown&amp;sektion=8&amp;format=html">shutdown(8)</a>. One can also use <a href="https://man.freebsd.org/cgi/man.cgi?query=halt&amp;sektion=8&amp;format=html">halt(8)</a> and <a href="https://man.freebsd.org/cgi/man.cgi?query=reboot&amp;sektion=8&amp;format=html">reboot(8)</a>. Refer to their manual pages and to <a href="https://man.freebsd.org/cgi/man.cgi?query=shutdown&amp;sektion=8&amp;format=html">shutdown(8)</a> for more information.</p>
</div>
<div class="paragraph">
<p>Modify group membership by referring to <a href="./#users-synopsis">“Users and Basic Account Management”</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Power management requires <a href="https://man.freebsd.org/cgi/man.cgi?query=acpi&amp;sektion=4&amp;format=html">acpi(4)</a> to be loaded as a module or statically compiled into a custom kernel.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="security">Chapter 16. Security<a class="anchor" href="#security"></a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="security-synopsis">16.1. Synopsis<a class="anchor" href="#security-synopsis"></a></h3>
<div class="paragraph">
<p>Hundreds of standard practices have been authored about how to secure systems and networks, and as a user of FreeBSD, understanding how to protect against attacks and intruders is a must.</p>
</div>
<div class="paragraph">
<p>In this chapter, several fundamentals and techniques will be discussed. The FreeBSD system comes with multiple layers of security, and many more third party utilities may be added to enhance security.</p>
</div>
<div class="paragraph">
<p>This chapter covers:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Basic FreeBSD system security concepts.</p>
</li>
<li>
<p>The various crypt mechanisms available in FreeBSD.</p>
</li>
<li>
<p>How to configure TCP Wrappers for use with <a href="https://man.freebsd.org/cgi/man.cgi?query=inetd&amp;sektion=8&amp;format=html">inetd(8)</a>.</p>
</li>
<li>
<p>How to set up Kerberos on FreeBSD.</p>
</li>
<li>
<p>How to configure and use OpenSSH on FreeBSD.</p>
</li>
<li>
<p>How to use OpenSSL on FreeBSD.</p>
</li>
<li>
<p>How to use file system ACLs.</p>
</li>
<li>
<p>How to use pkg to audit third party software packages installed from the Ports Collection.</p>
</li>
<li>
<p>How to utilize FreeBSD security advisories.</p>
</li>
<li>
<p>What Process Accounting is and how to enable it on FreeBSD.</p>
</li>
<li>
<p>How to control user resources using login classes or the resource limits database.</p>
</li>
<li>
<p>What is Capsicum and a basic example.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Certain topics due to their complexity are found in dedicated chapters such as <a href="./#firewalls">Firewalls</a>, <a href="./#mac">Mandatory Access Control</a> and articles like <a href="{vpn-ipsec}">VPN over IPsec</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="security-intro">16.2. Introduction<a class="anchor" href="#security-intro"></a></h3>
<div class="paragraph">
<p>Security is everyone’s responsibility. A weak entry point in any system could allow intruders to gain access to critical information and cause havoc on an entire network. One of the core principles of information security is the CIA triad, which stands for the Confidentiality, Integrity, and Availability of information systems.</p>
</div>
<div class="paragraph">
<p>The CIA triad is a bedrock concept of computer security as customers and users expect their data to be protected. For example, a customer expects that their credit card information is securely stored (confidentiality), that their orders are not changed behind the scenes (integrity), and that they have access to their order information at all times (availability).</p>
</div>
<div class="paragraph">
<p>To provide CIA, security professionals apply a defense in depth strategy. The idea of defense in depth is to add several layers of security to prevent one single layer failing and the entire security system collapsing. For example, a system administrator cannot simply turn on a firewall and consider the network or system secure. One must also audit accounts, check the integrity of binaries, and ensure malicious tools are not installed. To implement an effective security strategy, one must understand threats and how to defend against them.</p>
</div>
<div class="paragraph">
<p>What is a threat as it pertains to computer security? Threats are not limited to remote attackers who attempt to access a system without permission from a remote location. Threats also include employees, malicious software, unauthorized network devices, natural disasters, security vulnerabilities, and even competing corporations.</p>
</div>
<div class="paragraph">
<p>Systems and networks can be accessed without permission, sometimes by accident, or by remote attackers, and in some cases, via corporate espionage or former employees. As a user, it is important to prepare for and admit when a mistake has led to a security breach and report possible issues to the security team. As an administrator, it is important to know of the threats and be prepared to mitigate them.</p>
</div>
<div class="paragraph">
<p>When applying security to systems, it is recommended to start by securing the basic accounts and system configuration, and then to secure the network layer so that it adheres to the system policy and the organization’s security procedures. Many organizations already have a security policy that covers the configuration of technology devices. The policy should include the security configuration of workstations, desktops, mobile devices, phones, production servers, and development servers. In many cases, standard operating procedures (SOPs) already exist. When in doubt, ask the security team.</p>
</div>
</div>
<div class="sect2">
<h3 id="sec-accounts">16.3. Securing Accounts<a class="anchor" href="#sec-accounts"></a></h3>
<div class="paragraph">
<p>Maintaining secure accounts in FreeBSD is crucial for data confidentiality, system integrity, and privilege separation, as it prevents unauthorized access, malware, and data breaches while ensuring compliance and protecting an organization’s reputation.</p>
</div>
<div class="sect3">
<h4 id="security-accounts">16.3.1. Preventing Logins<a class="anchor" href="#security-accounts"></a></h4>
<div class="paragraph">
<p>In securing a system, a good starting point is an audit of accounts. Disable any accounts that do not need login access.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Ensure that <code>root</code> has a strong password and that this password is not shared.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>To deny login access to accounts, two methods exist.</p>
</div>
<div class="paragraph">
<p>The first is to lock the account, this example shows how to lock the <code>imani</code> account:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pw lock imani</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The second method is to prevent login access by changing the shell to <span class="filename">/usr/sbin/nologin</span>. The <a href="https://man.freebsd.org/cgi/man.cgi?query=nologin&amp;sektion=8&amp;format=html">nologin(8)</a> shell prevents the system from assigning a shell to the user when they attempt to login.</p>
</div>
<div class="paragraph">
<p>Only the superuser can change the shell for other users:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># chsh -s /usr/sbin/nologin imani</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="security-passwords">16.3.2. Password Hashes<a class="anchor" href="#security-passwords"></a></h4>
<div class="paragraph">
<p>Passwords are a necessary evil of technology. When they must be used, they should be complex and a powerful hash mechanism should be used to encrypt the version that is stored in the password database. FreeBSD supports several algorithms, including SHA256, SHA512 and Blowfish hash algorithms in its <code>crypt()</code> library, see <a href="https://man.freebsd.org/cgi/man.cgi?query=crypt&amp;sektion=3&amp;format=html">crypt(3)</a> for details.</p>
</div>
<div class="paragraph">
<p>The default of SHA512 should not be changed to a less secure hashing algorithm, but can be changed to the more secure Blowfish algorithm.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Blowfish is not part of AES and is not considered compliant with any Federal Information Processing Standards (FIPS). Its use may not be permitted in some environments.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>To determine which hash algorithm is used to encrypt a user’s password, the superuser can view the hash for the user in the FreeBSD password database. Each hash starts with a symbol which indicates the type of hash mechanism used to encrypt the password.</p>
</div>
<div class="paragraph">
<p>If DES is used, there is no beginning symbol. For MD5, the symbol is <code>$</code>. For SHA256 and SHA512, the symbol is <code>$6$</code>. For Blowfish, the symbol is <code>$2a$</code>. In this example, the password for <code>imani</code> is hashed using the default SHA512 algorithm as the hash starts with <code>$6$</code>. Note that the encrypted hash, not the password itself, is stored in the password database:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># grep imani /etc/master.passwd</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should be similar to the following:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>imani:$6$pzIjSvCAn.PBYQBA$PXpSeWPx3g5kscj3IMiM7tUEUSPmGexxta.8Lt9TGSi2lNQqYGKszsBPuGME0:1001:1001::0:0:imani:/usr/home/imani:/bin/sh</pre>
</div>
</div>
<div class="paragraph">
<p>The hash mechanism is set in the user’s login class.</p>
</div>
<div class="paragraph">
<p>The following command can be run to check which hash mechanism is currently being used:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># grep user /etc/master.passwd</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should be similar to the following:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>:passwd_format=sha512:\</pre>
</div>
</div>
<div class="paragraph">
<p>For example, to change the algorithm to Blowfish, modify that line to look like this:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>:passwd_format=blf:\</pre>
</div>
</div>
<div class="paragraph">
<p>Then, <a href="https://man.freebsd.org/cgi/man.cgi?query=cap_mkdb&amp;sektion=1&amp;format=html">cap_mkdb(1)</a> must be executed to upgrade the login.conf database:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># cap_mkdb /etc/login.conf</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that this change will not affect any existing password hashes. This means that all passwords should be re-hashed by asking users to run <code>passwd</code> in order to change their password.</p>
</div>
</div>
<div class="sect3">
<h4 id="security-pwpolicy">16.3.3. Password Policy Enforcement<a class="anchor" href="#security-pwpolicy"></a></h4>
<div class="paragraph">
<p>Enforcing a strong password policy for local accounts is a fundamental aspect of system security. In FreeBSD, password length, password strength, and password complexity can be implemented using built-in Pluggable Authentication Modules (PAM).</p>
</div>
<div class="paragraph">
<p>This section demonstrates how to configure the minimum and maximum password length and the enforcement of mixed characters using the <a href="https://man.freebsd.org/cgi/man.cgi?query=pam_passwdqc&amp;sektion=8&amp;format=html">pam_passwdqc(8)</a> module. This module is enforced when a user changes their password.</p>
</div>
<div class="paragraph">
<p>To configure this module, become the superuser and uncomment the line containing <code>pam_passwdqc.so</code> in <span class="filename">/etc/pam.d/passwd</span>.</p>
</div>
<div class="paragraph">
<p>Then, edit that line to match the password policy:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>password        requisite       pam_passwdqc.so         min=disabled,disabled,disabled,12,10 similar=deny retry=3 enforce=users</pre>
</div>
</div>
<div class="paragraph">
<p>The explanation of the parameters can be found in <a href="https://man.freebsd.org/cgi/man.cgi?query=pam_passwdqc&amp;sektion=8&amp;format=html">pam_passwdqc(8)</a>.</p>
</div>
<div class="paragraph">
<p>Once this file is saved, a user changing their password will see a message similar to the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>passwd</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should be similar to the following:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>Changing local password for user
Old Password:

You can now choose the new password.
A valid password should be a mix of upper and lower case letters,
digits and other characters.  You can use a 12 character long
password with characters from at least 3 of these 4 classes, or
a 10 character long password containing characters from all the
classes.  Characters that form a common pattern are discarded by
the check.
Alternatively, if no one else can see your terminal now, you can
pick this as your password: &#34;trait-useful&amp;knob&#34;.
Enter new password:</pre>
</div>
</div>
<div class="paragraph">
<p>If a password that does not match the policy is entered, it will be rejected with a warning and the user will have an opportunity to try again, up to the configured number of retries.</p>
</div>
<div class="paragraph">
<p>If your organization’s policy requires passwords to expire, FreeBSD supports the <code>passwordtime</code> in the user’s login class in <span class="filename">/etc/login.conf</span></p>
</div>
<div class="paragraph">
<p>The <code>default</code> login class contains an example:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>#       :passwordtime=90d:\</pre>
</div>
</div>
<div class="paragraph">
<p>So, to set an expiry of 90 days for this login class, remove the comment symbol (#), save the edit, and execute the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># cap_mkdb /etc/login.conf</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To set the expiration on individual users, pass an expiration date or the number of days to expiry and a username to <code>pw</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pw usermod -p 30-apr-2025 -n user</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As seen here, an expiration date is set in the form of day, month, and year. For more information, see <a href="https://man.freebsd.org/cgi/man.cgi?query=pw&amp;sektion=8&amp;format=html">pw(8)</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="security-sudo">16.3.4. Shared Administration with sudo<a class="anchor" href="#security-sudo"></a></h4>
<div class="paragraph">
<p>System administrators often need the ability to grant enhanced permissions to users so they may perform privileged tasks. The idea that team members are provided access to a FreeBSD system to perform their specific tasks opens up unique challenges to every administrator. These team members only need a subset of access beyond normal end user levels; however, they almost always tell management they are unable to perform their tasks without superuser access. Thankfully, there is no reason to provide such access to end users because tools exist to manage this exact requirement.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Even administrators should limit their privileges when not needed.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Up to this point, the security chapter has covered permitting access to authorized users and attempting to prevent unauthorized access. Another problem arises once authorized users have access to the system resources. In many cases, some users may need access to application startup scripts, or a team of administrators need to maintain the system. Traditionally, the standard users and groups, file permissions, and even the <a href="https://man.freebsd.org/cgi/man.cgi?query=su&amp;sektion=1&amp;format=html">su(1)</a> command would manage this access. And as applications required more access, as more users needed to use system resources, a better solution was required. The most used application is currently Sudo.</p>
</div>
<div class="paragraph">
<p>Sudo allows administrators to configure more rigid access to system commands and provide for some advanced logging features. As a tool, it is available from the Ports Collection as <a class="package" href="https://cgit.freebsd.org/ports/tree/security/sudo/">security/sudo</a> or by use of the <a href="https://man.freebsd.org/cgi/man.cgi?query=pkg&amp;sektion=8&amp;format=html">pkg(8)</a> utility.</p>
</div>
<div class="paragraph">
<p>Execute the following command to install it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install sudo</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>After the installation is complete, the installed <code>visudo</code> will open the configuration file with a text editor. Using <code>visudo</code> is highly recommended as it comes with a built in syntax checker to verify there are no errors before the file is saved.</p>
</div>
<div class="paragraph">
<p>The configuration file is made up of several small sections which allow for extensive configuration. In the following example, web application maintainer, user1, needs to start, stop, and restart the web application known as <em>webservice</em>. To grant this user permission to perform these tasks, add this line to the end of <span class="filename">/usr/local/etc/sudoers</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>user1   ALL=(ALL)       /usr/sbin/service webservice *</pre>
</div>
</div>
<div class="paragraph">
<p>The user may now start <em>webservice</em> using this command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>sudo /usr/sbin/service webservice start</code></pre>
</div>
</div>
<div class="paragraph">
<p>While this configuration allows a single user access to the webservice service; however, in most organizations, there is an entire web team in charge of managing the service. A single line can also give access to an entire group. These steps will create a web group, add a user to this group, and allow all members of the group to manage the service:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pw groupadd -g 6001 -n webteam</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Using the same <a href="https://man.freebsd.org/cgi/man.cgi?query=pw&amp;sektion=8&amp;format=html">pw(8)</a> command, the user is added to the webteam group:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pw groupmod -m user1 -n webteam</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, this line in <span class="filename">/usr/local/etc/sudoers</span> allows any member of the webteam group to manage <em>webservice</em>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>%webteam   ALL=(ALL)       /usr/sbin/service webservice *</pre>
</div>
</div>
<div class="paragraph">
<p>Unlike <a href="https://man.freebsd.org/cgi/man.cgi?query=su&amp;sektion=1&amp;format=html">su(1)</a>, <a href="https://man.freebsd.org/cgi/man.cgi?query=sudo&amp;sektion=8&amp;format=html">sudo(8)</a> only requires the end user password. This avoids sharing passwords, which is a poor practice.</p>
</div>
<div class="paragraph">
<p>Users permitted to run applications with <a href="https://man.freebsd.org/cgi/man.cgi?query=sudo&amp;sektion=8&amp;format=html">sudo(8)</a> only enter their own passwords. This is more secure and gives better control than <a href="https://man.freebsd.org/cgi/man.cgi?query=su&amp;sektion=1&amp;format=html">su(1)</a>, where the <code>root</code> password is entered and the user acquires all <code>root</code> permissions.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Most organizations are moving or have moved toward a two factor authentication model. In these cases, the user may not have a password to enter.</p>
</div>
<div class="paragraph">
<p><a href="https://man.freebsd.org/cgi/man.cgi?query=sudo&amp;sektion=8&amp;format=html">sudo(8)</a> can be configured to permit two factor authentication model by using the <code>NOPASSWD</code> variable. Adding it to the configuration above will allow all members of the <em>webteam</em> group to manage the service without the password requirement:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>%webteam   ALL=(ALL)       NOPASSWD: /usr/sbin/service webservice *</pre>
</div>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect3">
<h4 id="security-doas">16.3.5. Shared Administration with Doas<a class="anchor" href="#security-doas"></a></h4>
<div class="paragraph">
<p><a href="https://man.freebsd.org/cgi/man.cgi?query=doas&amp;sektion=1&amp;format=html">doas(1)</a> is a command-line utility ported from OpenBSD. It serves as an alternative to the widely used <a href="https://man.freebsd.org/cgi/man.cgi?query=sudo&amp;sektion=8&amp;format=html">sudo(8)</a> command in Unix-like systems.</p>
</div>
<div class="paragraph">
<p>With doas, users can execute commands with elevated privileges, typically as the root user, while maintaining a simplified and security-conscious approach. Unlike <a href="https://man.freebsd.org/cgi/man.cgi?query=sudo&amp;sektion=8&amp;format=html">sudo(8)</a>, doas emphasizes simplicity and minimalism, focusing on streamlined privilege delegation without an overwhelming array of configuration options.</p>
</div>
<div class="paragraph">
<p>Execute the following command to install it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install doas</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>After the installation <span class="filename">/usr/local/etc/doas.conf</span> must be configured to grant access for users for specific commands, or roles.</p>
</div>
<div class="paragraph">
<p>The simpliest entry could be the following, which grants the user <code>local_user</code> with <code>root</code> permissions without asking for its password when executing the doas command.</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>permit nopass local_user as root</pre>
</div>
</div>
<div class="paragraph">
<p>After the installation and configuration of the <code>doas</code> utility, a command can now be executed with enhanced privileges, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">$ </span>doas vi /etc/rc.conf</code></pre>
</div>
</div>
<div class="paragraph">
<p>For more configuration examples, please read <a href="https://man.freebsd.org/cgi/man.cgi?query=doas.conf&amp;sektion=5&amp;format=html">doas.conf(5)</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="security-ids">16.4. Intrusion Detection System (IDS)<a class="anchor" href="#security-ids"></a></h3>
<div class="paragraph">
<p>Verification of system files and binaries is important because it provides the system administration and security teams information about system changes. A software application that monitors the system for changes is called an Intrusion Detection System (IDS).</p>
</div>
<div class="paragraph">
<p>FreeBSD provides native support for a basic IDS system called <a href="https://man.freebsd.org/cgi/man.cgi?query=mtree&amp;sektion=8&amp;format=html">mtree(8)</a>. While the nightly security emails will notify an administrator of changes, the information is stored locally and there is a chance that a malicious user could modify this information in order to hide their changes to the system. As such, it is recommended to create a separate set of binary signatures and store them on a read-only, root-owned directory or, preferably, on a removable USB disk or remote server.</p>
</div>
<div class="paragraph">
<p>It is also recommended to run <code>freebsd-update IDS</code> after each update.</p>
</div>
<div class="sect3">
<h4 id="security-ids-generate-spec-file">16.4.1. Generating the Specification File<a class="anchor" href="#security-ids-generate-spec-file"></a></h4>
<div class="paragraph">
<p>The built-in <a href="https://man.freebsd.org/cgi/man.cgi?query=mtree&amp;sektion=8&amp;format=html">mtree(8)</a> utility can be used to generate a specification of the contents of a directory. A seed, or a numeric constant, is used to generate the specification and is required to check that the specification has not changed. This makes it possible to determine if a file or binary has been modified. Since the seed value is unknown by an attacker, faking or checking the checksum values of files will be difficult to impossible.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>It is recommended to create specifications for the directories which contain binaries and configuration files, as well as any directories containing sensitive data. Typically, specifications are created for <span class="filename">/bin</span>, <span class="filename">/sbin</span>, <span class="filename">/usr/bin</span>, <span class="filename">/usr/sbin</span>, <span class="filename">/usr/local/bin</span>, <span class="filename">/etc</span>, and <span class="filename">/usr/local/etc</span>.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>The following example generates a set of <code>sha512</code> hashes, one for each system binary in <span class="filename">/bin</span>, and saves those values to a hidden file in user’s home directory, <span class="filename">/home/user/.bin_chksum_mtree</span>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># mtree -s 123456789 -c -K cksum,sha512 -p /bin &gt; /home/user/.bin_chksum_mtree</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should be similar to the following:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>mtree: /bin checksum: 3427012225</pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>123456789</code> value represents the seed, and should be chosen randomly. This value should be remembered, <strong>but not shared</strong>.</p>
</div>
<div class="paragraph">
<p>It is important to keep the seed value and the checksum output hidden from malicious users.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect3">
<h4 id="security-ids-spec-file-structure">16.4.2. The Specification File Structure<a class="anchor" href="#security-ids-spec-file-structure"></a></h4>
<div class="paragraph">
<p>The mtree format is a textual format that describes a collection of filesystem objects. Such files are typically used to create or verify directory hierarchies.</p>
</div>
<div class="paragraph">
<p>An mtree file consists of a series of lines, each providing information about a single filesystem object. Leading whitespace is always ignored.</p>
</div>
<div class="paragraph">
<p>The specification file created above will be used to explain the format and content:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>#          user: root <i class="conum" data-value="1"></i><b>(1)</b>
#       machine: machinename <i class="conum" data-value="2"></i><b>(2)</b>
#          tree: /bin <i class="conum" data-value="3"></i><b>(3)</b>
#          date: Thu Aug  24 21:58:37 2023 <i class="conum" data-value="4"></i><b>(4)</b>

# .
/set type=file uid=0 gid=0 mode=0555 nlink=1 flags=uarch <i class="conum" data-value="5"></i><b>(5)</b>
.               type=dir mode=0755 nlink=2 time=1681388848.239523000 <i class="conum" data-value="6"></i><b>(6)</b>
    \133        nlink=2 size=12520 time=1685991378.688509000 \
                cksum=520880818 \
                sha512=5c1374ce0e2ba1b3bc5a41b23f4bbdc1ec89ae82fa01237f376a5eeef41822e68f1d8f75ec46b7bceb65396c122a9d837d692740fdebdcc376a05275adbd3471
    cat         size=14600 time=1685991378.694601000 cksum=3672531848 \ <i class="conum" data-value="7"></i><b>(7)</b>
                sha512=b30b96d155fdc4795432b523989a6581d71cdf69ba5f0ccb45d9b9e354b55a665899b16aee21982fffe20c4680d11da4e3ed9611232a775c69f926e5385d53a2
    chflags     size=8920 time=1685991378.700385000 cksum=1629328991 \
                sha512=289a088cbbcbeb436dd9c1f74521a89b66643976abda696b99b9cc1fbfe8b76107c5b54d4a6a9b65332386ada73fc1bbb10e43c4e3065fa2161e7be269eaf86a
    chio        size=20720 time=1685991378.706095000 cksum=1948751604 \
                sha512=46f58277ff16c3495ea51e74129c73617f31351e250315c2b878a88708c2b8a7bb060e2dc8ff92f606450dbc7dd2816da4853e465ec61ee411723e8bf52709ee
    chmod       size=9616 time=1685991378.712546000 cksum=4244658911 \
                sha512=1769313ce08cba84ecdc2b9c07ef86d2b70a4206420dd71343867be7ab59659956f6f5a458c64e2531a1c736277a8e419c633a31a8d3c7ccc43e99dd4d71d630</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>User who created the specification. &lt;.&gt; Machine’s hostname. &lt;.&gt; Directory path. &lt;.&gt; The Date and time when the specification was created. &lt;.&gt; <code>/set</code> special commands, defines some settings obtained from the files analyzed. &lt;.&gt; Refers to the parsed directory and indicates things like what type it is, its mode, the number of hard links, and the time in UNIX format since it was modified. &lt;.&gt; Refers to the file and shows the size, time and a list of hashes to verify the integrity.</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect3">
<h4 id="security-ids-verify-specification-file">16.4.3. Verify the Specification file<a class="anchor" href="#security-ids-verify-specification-file"></a></h4>
<div class="paragraph">
<p>To verify that the binary signatures have not changed, compare the current contents of the directory to the previously generated specification, and save the results to a file.</p>
</div>
<div class="paragraph">
<p>This command requires the seed that was used to generate the original specification:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># mtree -s 123456789 -p /bin &lt; /home/user/.bin_chksum_mtree &gt;&gt; /home/user/.bin_chksum_output</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This should produce the same checksum for <span class="filename">/bin</span> that was produced when the specification was created. If no changes have occurred to the binaries in this directory, the <span class="filename">/home/user/.bin_chksum_output</span> output file will be empty.</p>
</div>
<div class="paragraph">
<p>To simulate a change, change the date on <span class="filename">/bin/cat</span> using <a href="https://man.freebsd.org/cgi/man.cgi?query=touch&amp;sektion=1&amp;format=html">touch(1)</a> and run the verification command again:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># touch /bin/cat</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Run the verification command again:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># mtree -s 123456789 -p /bin &lt; /home/user/.bin_chksum_mtree &gt;&gt; /home/user/.bin_chksum_output</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And then check the content of the output file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># cat /root/.bin_chksum_output</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should be similar to the following:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>cat:    modification time (Fri Aug 25 13:30:17 2023, Fri Aug 25 13:34:20 2023)</pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This is just an example of what would be displayed when executing the command, to show the changes that would occur in the metadata.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="security-secure-levels">16.5. Secure levels<a class="anchor" href="#security-secure-levels"></a></h3>
<div class="paragraph">
<p>securelevel is a security mechanism implemented in the kernel. When the securelevel is positive, the kernel restricts certain tasks; not even the superuser (root) is allowed to do them.</p>
</div>
<div class="paragraph">
<p>The securelevel mechanism limits the ability to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Unset certain file flags, such as <code>schg</code> (the system immutable flag).</p>
</li>
<li>
<p>Write to kernel memory via <span class="filename">/dev/mem</span> and <span class="filename">/dev/kmem</span>.</p>
</li>
<li>
<p>Load kernel modules.</p>
</li>
<li>
<p>Alter firewall rules.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="security-secure-levels-definitions">16.5.1. Secure Levels Definitions<a class="anchor" href="#security-secure-levels-definitions"></a></h4>
<div class="paragraph">
<p>The kernel runs with five different security levels. Any super-user process can raise the level, but no process can lower it.</p>
</div>
<div class="paragraph">
<p>The security definitions are:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">-1</dt>
<dd>
<p><strong>Permanently insecure mode</strong> - always run the system in insecure mode.
This is the default initial value.</p>
</dd>
<dt class="hdlist1">0</dt>
<dd>
<p><strong>Insecure mode</strong> - immutable and append-only flags may be turned off.
All devices may be read or written subject to their permissions.</p>
</dd>
<dt class="hdlist1">1</dt>
<dd>
<p><strong>Secure mode</strong> - the system immutable and system append-only flags may not be turned off;
disks for mounted file systems, <span class="filename">/dev/mem</span> and <span class="filename">/dev/kmem</span> may not be opened for writing;
<span class="filename">/dev/io</span> (if your platform has it) may not be opened at all; kernel modules (see <a href="https://man.freebsd.org/cgi/man.cgi?query=kld&amp;sektion=4&amp;format=html">kld(4)</a>) may not be loaded or unloaded.
The kernel debugger may not be entered using the debug.kdb.enter sysctl.
A panic or trap cannot be forced using the debug.kdb.panic, debug.kdb.panic_str and other sysctl’s.</p>
</dd>
<dt class="hdlist1">2</dt>
<dd>
<p><strong>Highly secure mode</strong> - same as secure mode, plus disks may not be opened for writing (except by <a href="https://man.freebsd.org/cgi/man.cgi?query=mount&amp;sektion=2&amp;format=html">mount(2)</a>) whether mounted or not.
This level precludes tampering with file systems by unmounting them, but also inhibits running <a href="https://man.freebsd.org/cgi/man.cgi?query=newfs&amp;sektion=8&amp;format=html">newfs(8)</a> while the system is multiuser.</p>
</dd>
<dt class="hdlist1">3</dt>
<dd>
<p><strong>Network secure mode</strong> - same as highly secure mode, plus IP packet filter rules (see <a href="https://man.freebsd.org/cgi/man.cgi?query=ipfw&amp;sektion=8&amp;format=html">ipfw(8)</a>, <a href="https://man.freebsd.org/cgi/man.cgi?query=ipfirewall&amp;sektion=4&amp;format=html">ipfirewall(4)</a> and <a href="https://man.freebsd.org/cgi/man.cgi?query=pfctl&amp;sektion=8&amp;format=html">pfctl(8)</a>) cannot be changed and <a href="https://man.freebsd.org/cgi/man.cgi?query=dummynet&amp;sektion=4&amp;format=html">dummynet(4)</a> or <a href="https://man.freebsd.org/cgi/man.cgi?query=pf&amp;sektion=4&amp;format=html">pf(4)</a> configuration cannot be adjusted.</p>
</dd>
</dl>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In summary, the key difference between <code>Permanently Insecure Mode</code> and <code>Insecure Mode</code> in FreeBSD secure levels is the degree of security they provide. <code>Permanently Insecure Mode</code> completely lifts all security restrictions, while <code>Insecure Mode</code> relaxes some restrictions but still maintains a level of control and security.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect3">
<h4 id="security-modify-secure-levels">16.5.2. Modify Secure Levels<a class="anchor" href="#security-modify-secure-levels"></a></h4>
<div class="paragraph">
<p>In order to change the securelevel of the system it is necessary to activate <code>kern_securelevel_enable</code> by executing the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysrc kern_securelevel_enable=&#34;YES&#34;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And set the value of <code>kern_securelevel</code> to the desired security level:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysrc kern_securelevel=2</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To check the status of the securelevel on a running system execute the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysctl -n kern.securelevel</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The output contains the current value of the securelevel. If it is greater than 0, at least some of the securelevel’s protections are enabled.</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>-1</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="security-file-flags">16.6. File flags<a class="anchor" href="#security-file-flags"></a></h3>
<div class="paragraph">
<p>File flags allow users to attach additional metadata or attributes to files and directories beyond basic permissions and ownership. These flags provide a way to control various behaviors and properties of files without needing to resort to creating special directories or using extended attributes.</p>
</div>
<div class="paragraph">
<p>File flags can be used to achieve different goals, such as preventing file deletion, making files append-only, synchronizing file updates, and more. Some commonly used file flags in FreeBSD include the &#34;immutable&#34; flag, which prevents modification or deletion of a file, and the &#34;append-only&#34; flag, which allows only data to be added to the end of a file but not modified or removed.</p>
</div>
<div class="paragraph">
<p>These flags can be managed using the <a href="https://man.freebsd.org/cgi/man.cgi?query=chflags&amp;sektion=1&amp;format=html">chflags(1)</a> command in FreeBSD, providing administrators and users with greater control over the behavior and characteristics of their files and directories. It is important to note that file flags are typically managed by root or users with appropriate privileges, as they can influence how files are accessed and manipulated. Some flags are available for the use of the file’s owner, as described in <a href="https://man.freebsd.org/cgi/man.cgi?query=chflags&amp;sektion=1&amp;format=html">chflags(1)</a>.</p>
</div>
<div class="sect3">
<h4 id="security-work-file-flag">16.6.1. Work with File Flags<a class="anchor" href="#security-work-file-flag"></a></h4>
<div class="paragraph">
<p>In this example, a file named <span class="filename">~/important.txt</span> in user’s home directory want to be protected against deletions.</p>
</div>
<div class="paragraph">
<p>Execute the following command to set the <code>schg</code> file flag:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># chflags schg ~/important.txt</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When any user, including the <code>root</code> user, tries to delete the file, the system will display the message:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>rm: important.txt: Operation not permitted</pre>
</div>
</div>
<div class="paragraph">
<p>To delete the file, it will be necessary to delete the file flags of that file by executing the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># chflags noschg ~/important.txt</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A list of supported file flags and their functionality can be found in <a href="https://man.freebsd.org/cgi/man.cgi?query=chflags&amp;sektion=1&amp;format=html">chflags(1)</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="openssh">16.7. OpenSSH<a class="anchor" href="#openssh"></a></h3>
<div class="paragraph">
<p>OpenSSH is a set of network connectivity tools used to provide secure access to remote machines. Additionally, TCP/IP connections can be tunneled or forwarded securely through SSH connections. OpenSSH encrypts all traffic to eliminate eavesdropping, connection hijacking, and other network-level attacks.</p>
</div>
<div class="paragraph">
<p>OpenSSH is maintained by the OpenBSD project and is installed by default in FreeBSD.</p>
</div>
<div class="paragraph">
<p>When data is sent over the network in an unencrypted form, network sniffers anywhere in between the client and server can steal user/password information or data transferred during the session. OpenSSH offers a variety of authentication and encryption methods to prevent this from happening.</p>
</div>
<div class="paragraph">
<p>More information about OpenSSH is available in the <a href="https://www.openssh.com/">web page</a>.</p>
</div>
<div class="paragraph">
<p>This section provides an overview of the built-in client utilities to securely access other systems and securely transfer files from a FreeBSD system. It then describes how to configure a SSH server on a FreeBSD system.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>As stated, this chapter will cover the base system version of OpenSSH. A version of OpenSSH is also available in the <a class="package" href="https://cgit.freebsd.org/ports/tree/security/openssh-portable/">security/openssh-portable</a>, which provides additional configuration options and is updated more regularly.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="sect3">
<h4 id="_using_the_ssh_client_utilities">16.7.1. Using the SSH Client Utilities<a class="anchor" href="#_using_the_ssh_client_utilities"></a></h4>
<div class="paragraph">
<p>To log into a SSH server, use <a href="https://man.freebsd.org/cgi/man.cgi?query=ssh&amp;sektion=1&amp;format=html">ssh(1)</a> and specify a username that exists on that server and the IP address or hostname of the server. If this is the first time a connection has been made to the specified server, the user will be prompted to first verify the server’s fingerprint:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ssh user@example.com</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should be similar to the following:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>The authenticity of host &#39;example.com (10.0.0.1)&#39; can&#39;t be established.
ECDSA key fingerprint is 25:cc:73:b5:b3:96:75:3d:56:19:49:d2:5c:1f:91:3b.
Are you sure you want to continue connecting (yes/no)? yes
Permanently added &#39;example.com&#39; (ECDSA) to the list of known hosts.
Password for user@example.com: user_password</pre>
</div>
</div>
<div class="paragraph">
<p>SSH utilizes a key fingerprint system to verify the authenticity of the server when the client connects. When the user accepts the key’s fingerprint by typing <code>yes</code> when connecting for the first time, a copy of the key is saved to <span class="filename">~/.ssh/known_hosts</span> in the user’s home directory. Future attempts to login are verified against the saved key and <a href="https://man.freebsd.org/cgi/man.cgi?query=ssh&amp;sektion=1&amp;format=html">ssh(1)</a> will display an alert if the server’s key does not match the saved key. If this occurs, the user should first verify why the key has changed before continuing with the connection.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>How to perform this check is outside the scope of this chapter.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Use <a href="https://man.freebsd.org/cgi/man.cgi?query=scp&amp;sektion=1&amp;format=html">scp(1)</a> to securely copy a file to or from a remote machine.</p>
</div>
<div class="paragraph">
<p>This example copies <code>COPYRIGHT</code> on the remote system to a file of the same name in the current directory of the local system:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># scp user@example.com:/COPYRIGHT COPYRIGHT</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should be similar to the following:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>Password for user@example.com: *******
COPYRIGHT            100% |*****************************|  4735</pre>
</div>
</div>
<div class="paragraph">
<p>Since the fingerprint was already verified for this host, the server’s key is automatically checked before prompting for the user’s password.</p>
</div>
<div class="paragraph">
<p>The arguments passed to <a href="https://man.freebsd.org/cgi/man.cgi?query=scp&amp;sektion=1&amp;format=html">scp(1)</a> are similar to <a href="https://man.freebsd.org/cgi/man.cgi?query=cp&amp;sektion=1&amp;format=html">cp(1)</a>. The file or files to copy is the first argument and the destination to copy to is the second. Since the file is fetched over the network, one or more of the file arguments takes the form <code>user@host:&lt;path_to_remote_file&gt;</code>. Be aware when copying directories recursively that <a href="https://man.freebsd.org/cgi/man.cgi?query=scp&amp;sektion=1&amp;format=html">scp(1)</a> uses <code>-r</code>, whereas <a href="https://man.freebsd.org/cgi/man.cgi?query=cp&amp;sektion=1&amp;format=html">cp(1)</a> uses <code>-R</code>.</p>
</div>
<div class="paragraph">
<p>To open an interactive session for copying files, use <a href="https://man.freebsd.org/cgi/man.cgi?query=sftp&amp;sektion=1&amp;format=html">sftp(1)</a>.</p>
</div>
<div class="paragraph">
<p>Refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=sftp&amp;sektion=1&amp;format=html">sftp(1)</a> for a list of available commands while in an <a href="https://man.freebsd.org/cgi/man.cgi?query=sftp&amp;sektion=1&amp;format=html">sftp(1)</a> session.</p>
</div>
</div>
<div class="sect3">
<h4 id="security-ssh-keygen">16.7.2. Key-based Authentication<a class="anchor" href="#security-ssh-keygen"></a></h4>
<div class="paragraph">
<p>Instead of using passwords, a client can be configured to connect to the remote machine using keys. For security reasons, this is the preferred method.</p>
</div>
<div class="paragraph">
<p><a href="https://man.freebsd.org/cgi/man.cgi?query=ssh-keygen&amp;sektion=1&amp;format=html">ssh-keygen(1)</a> can be used to generate the authentication keys. To generate a public and private key pair, specify the type of key and follow the prompts. It is recommended to protect the keys with a memorable, but hard to guess passphrase.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>ssh-keygen -t rsa -b 4096</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should be similar to the following:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>Generating public/private rsa key pair.
Enter file in which to save the key (/home/user/.ssh/id_rsa):
Created directory &#39;/home/user/.ssh/.ssh&#39;.
Enter passphrase (empty for no passphrase):
Enter same passphrase again:
Your identification has been saved in /home/user/.ssh/id_rsa.
Your public key has been saved in /home/user/.ssh/id_rsa.pub.
The key fingerprint is:
SHA256:54Xm9Uvtv6H4NOo6yjP/YCfODryvUU7yWHzMqeXwhq8 user@host.example.com
The key&#39;s randomart image is:
+---[RSA 2048]----+
|                 |
|                 |
|                 |
|        . o..    |
|       .S*+*o    |
|      . O=Oo . . |
|       = Oo= oo..|
|      .oB.* +.oo.|
|       =OE**.o..=|
+----[SHA256]-----+</pre>
</div>
</div>
<div class="paragraph">
<p>The private key is stored in <span class="filename">~/.ssh/id_rsa</span> and the public key is stored in <span class="filename">~/.ssh/id_rsa.pub</span>. The <em>public</em> key must be copied to <span class="filename">~/.ssh/authorized_keys</span> on the remote machine for key-based authentication to work.</p>
</div>
<div class="admonitionblock warning">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Utilizing a passphrase for OpenSSH keys is a key security practice, providing an extra layer of protection against unauthorized access and enhancing overall cybersecurity.</p>
</div>
<div class="paragraph">
<p>In case of loss or theft, this adds another layer of security.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect3">
<h4 id="security-ssh-tunneling">16.7.3. SSH Tunneling<a class="anchor" href="#security-ssh-tunneling"></a></h4>
<div class="paragraph">
<p>OpenSSH has the ability to create a tunnel to encapsulate another protocol in an encrypted session.</p>
</div>
<div class="paragraph">
<p>The following command tells <a href="https://man.freebsd.org/cgi/man.cgi?query=ssh&amp;sektion=1&amp;format=html">ssh(1)</a> to create a tunnel:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>ssh -D 8080 user@example.com</code></pre>
</div>
</div>
<div class="paragraph">
<p>This example uses the following options:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">-D</dt>
<dd>
<p>Specifies a local &#34;dynamic&#34; application-level port forwarding.</p>
</dd>
<dt class="hdlist1"><a href="mailto:user@foo.example.com">user@foo.example.com</a></dt>
<dd>
<p>The login name to use on the specified remote SSH server.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>An SSH tunnel works by creating a listen socket on <code>localhost</code> on the specified <code>localport</code>.</p>
</div>
<div class="paragraph">
<p>This method can be used to wrap any number of insecure TCP protocols such as SMTP, POP3, and FTP.</p>
</div>
</div>
<div class="sect3">
<h4 id="_enabling_the_ssh_server">16.7.4. Enabling the SSH Server<a class="anchor" href="#_enabling_the_ssh_server"></a></h4>
<div class="paragraph">
<p>In addition to providing built-in SSH client utilities, a FreeBSD system can be configured as an SSH server, accepting connections from other SSH clients.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>As stated, this chapter will cover the base system version of OpenSSH. Please <strong>not</strong> confuse with <a class="package" href="https://cgit.freebsd.org/ports/tree/security/openssh-portable/">security/openssh-portable</a>, the version of OpenSSH that ships with the FreeBSD ports.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>In order to have the SSH Server enabled across reboots execute the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysrc sshd_enable=&#34;YES&#34;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then execute the following command to enable the service:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># service sshd start</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The first time sshd starts on a FreeBSD system, the system’s host keys will be automatically created and the fingerprint will be displayed on the console. Provide users with the fingerprint so that they can verify it the first time they connect to the server.</p>
</div>
<div class="paragraph">
<p>Refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=sshd&amp;sektion=8&amp;format=html">sshd(8)</a> for the list of available options when starting sshd and a more complete discussion about authentication, the login process, and the various configuration files.</p>
</div>
<div class="paragraph">
<p>At this point, the sshd should be available to all users with a username and password on the system.</p>
</div>
</div>
<div class="sect3">
<h4 id="config-publickey-auth">16.7.5. Configuring publickey auth method<a class="anchor" href="#config-publickey-auth"></a></h4>
<div class="paragraph">
<p>Configuring OpenSSH to use public key authentication enhances security by leveraging asymmetric cryptography for authentication. This method eliminates password-related risks, such as weak passwords or interception during transmission, while thwarting various password-based attacks. However, it’s vital to ensure the private keys are well-protected to prevent unauthorized access.</p>
</div>
<div class="paragraph">
<p>The first step will be to configure <a href="https://man.freebsd.org/cgi/man.cgi?query=sshd&amp;sektion=8&amp;format=html">sshd(8)</a> to use the required authentication method.</p>
</div>
<div class="paragraph">
<p>Edit <span class="filename">/etc/ssh/sshd_config</span> and uncomment the following configuration:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>PubkeyAuthentication yes</pre>
</div>
</div>
<div class="paragraph">
<p>Once the configuration is done, the users will have to send the system administrator their <strong>public key</strong> and these keys will be added in <span class="filename">.ssh/authorized_keys</span>. The process for generating the keys is described in <a href="#security-ssh-keygen">Key-based Authentication</a>.</p>
</div>
<div class="paragraph">
<p>Then restart the server executing the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># service sshd reload</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>It is strongly recommended to follow the security improvements indicated in <a href="#security-sshd-security-options">SSH Server Security Options</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="security-sshd-security-options">16.7.6. SSH Server Security Options<a class="anchor" href="#security-sshd-security-options"></a></h4>
<div class="paragraph">
<p>While sshd is the most widely used remote administration facility for FreeBSD, brute force and drive by attacks are common to any system exposed to public networks.</p>
</div>
<div class="paragraph">
<p>Several additional parameters are available to prevent the success of these attacks and will be described in this section. All configurations will be done in <span class="filename">/etc/ssh/sshd_config</span></p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Do not confuse <span class="filename">/etc/ssh/sshd_config</span> with <span class="filename">/etc/ssh/ssh_config</span> (note the extra <code>d</code> in the first filename). The first file configures the server and the second file configures the client. Refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=ssh_config&amp;sektion=5&amp;format=html">ssh_config(5)</a> for a listing of the available client settings.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>By default, authentication can be done with both pubkey and password. To allow <strong>only</strong> pubkey authentication, <strong>which is strongly recommended</strong>, change the variable:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>PasswordAuthentication no</pre>
</div>
</div>
<div class="paragraph">
<p>It is a good idea to limit which users can log into the SSH server and from where using the <code>AllowUsers</code> keyword in the OpenSSH server configuration file. For example, to only allow <code>user</code> to log in from <code>192.168.1.32</code>, add this line to <span class="filename">/etc/ssh/sshd_config</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>AllowUsers user@192.168.1.32</pre>
</div>
</div>
<div class="paragraph">
<p>To allow <code>user</code> to log in from anywhere, list that user without specifying an IP address:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>AllowUsers user</pre>
</div>
</div>
<div class="paragraph">
<p>Multiple users should be listed on the same line, like so:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>AllowUsers root@192.168.1.32 user</pre>
</div>
</div>
<div class="paragraph">
<p>After making all the changes, and before restarting the service, it is recommended to verify that the configuration made is correct by executing the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sshd -t</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If the configuration file is correct, no output will be shown. In case the configuration file is incorrect, it will show something like this:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>/etc/ssh/sshd_config: line 3: Bad configuration option: sdadasdasdasads
/etc/ssh/sshd_config: terminating, 1 bad configuration options</pre>
</div>
</div>
<div class="paragraph">
<p>After making the changes and checking that the configuration file is correct, tell sshd to reload its configuration file by running:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># service sshd reload</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="openssl">16.8. OpenSSL<a class="anchor" href="#openssl"></a></h3>
<div class="paragraph">
<p>OpenSSL is a cryptography toolkit implementing the Secure Sockets Layer (SSL) and Transport Layer Security (TLS) network protocols and many cryptography routines.</p>
</div>
<div class="paragraph">
<p>The openssl program is a command line tool for using the various cryptography functions of OpenSSL’s crypto library from the shell. It can be used for</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Creation and management of private keys, public keys and parameters</p>
</li>
<li>
<p>Public key cryptographic operations</p>
</li>
<li>
<p>Creation of X.509 certificates, CSRs and CRLs</p>
</li>
<li>
<p>Calculation of Message Digests</p>
</li>
<li>
<p>Encryption and Decryption with Ciphers</p>
</li>
<li>
<p>SSL/TLS Client and Server Tests</p>
</li>
<li>
<p>Handling of S/MIME signed or encrypted mail</p>
</li>
<li>
<p>Time Stamp requests, generation and verification</p>
</li>
<li>
<p>Benchmarking the crypto routines</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For more information about OpenSSL, read the free <a href="https://www.feistyduck.com/books/openssl-cookbook/">OpenSSL Cookbook</a>.</p>
</div>
<div class="sect3">
<h4 id="generating-certificates">16.8.1. Generating Certificates<a class="anchor" href="#generating-certificates"></a></h4>
<div class="paragraph">
<p>OpenSSL supports the generation of certificates both to be validated by a <a href="https://en.wikipedia.org/wiki/Certificate_authority">CA</a> and for own use.</p>
</div>
<div class="paragraph">
<p>Run the command <a href="https://man.freebsd.org/cgi/man.cgi?query=openssl&amp;sektion=1&amp;format=html">openssl(1)</a> to generate a valid certificate for a <a href="https://en.wikipedia.org/wiki/Certificate_authority">CA</a> with the following arguments. This command will create two files in the current directory. The certificate request, <span class="filename">req.pem</span>, can be sent to a <a href="https://en.wikipedia.org/wiki/Certificate_authority">CA</a> which, will validate the entered credentials, sign the request, and return the signed certificate. The second file, <span class="filename">cert.key</span>, is the private key for the certificate and should be stored in a secure location. If this falls in the hands of others, it can be used to impersonate the user or the server.</p>
</div>
<div class="paragraph">
<p>Execute the following command to generate the certificate:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># openssl req -new -nodes -out req.pem -keyout cert.key -sha3-512 -newkey rsa:4096</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should be similar to the following:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>Generating a RSA private key
..................................................................................................................................+++++
......................................+++++
writing new private key to &#39;cert.key&#39;
-----
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter &#39;.&#39;, the field will be left blank.
-----
Country Name (2 letter code) [AU]:ES
State or Province Name (full name) [Some-State]:Valencian Community
Locality Name (eg, city) []:Valencia
Organization Name (eg, company) [Internet Widgits Pty Ltd]:My Company
Organizational Unit Name (eg, section) []:Systems Administrator
Common Name (e.g. server FQDN or YOUR name) []:localhost.example.org
Email Address []:user@FreeBSD.org

Please enter the following &#39;extra&#39; attributes
to be sent with your certificate request
A challenge password []:123456789
An optional company name []:Another name</pre>
</div>
</div>
<div class="paragraph">
<p>Alternately, if a signature from a <a href="https://en.wikipedia.org/wiki/Certificate_authority">CA</a> is not required, a self-signed certificate can be created. This will create two new files in the current directory: a private key file <span class="filename">cert.key</span>, and the certificate itself, <span class="filename">cert.crt</span>. These should be placed in a directory, preferably under <span class="filename">/etc/ssl/</span>, which is readable only by <code>root</code>. Permissions of <code>0700</code> are appropriate for these files and can be set using <code>chmod</code>.</p>
</div>
<div class="paragraph">
<p>Execute the following command to generate the certificate:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># openssl req -new -x509 -days 365 -sha3-512 -keyout /etc/ssl/private/cert.key -out /etc/ssl/certs/cert.crt</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should be similar to the following:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>Generating a RSA private key
........................................+++++
...........+++++
writing new private key to &#39;/etc/ssl/private/cert.key&#39;
Enter PEM pass phrase:
Verifying - Enter PEM pass phrase:
-----
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter &#39;.&#39;, the field will be left blank.
-----
Country Name (2 letter code) [AU]:ES
State or Province Name (full name) [Some-State]:Valencian Community
Locality Name (eg, city) []:Valencia
Organization Name (eg, company) [Internet Widgits Pty Ltd]:My Company
Organizational Unit Name (eg, section) []:Systems Administrator
Common Name (e.g. server FQDN or YOUR name) []:localhost.example.org
Email Address []:user@FreeBSD.org</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="fips-provider">16.8.2. Configuring the FIPS Provider<a class="anchor" href="#fips-provider"></a></h4>
<div class="paragraph">
<p>With the import of OpenSSL 3 into the base system (on FreeBSD 14 and later), its new concept of provider modules was introduced in the system. Besides the default provider module built-in to the library, the <em>legacy</em> module implements the now optional deprecated cryptography algorithms, while the <em>fips</em> module restricts the OpenSSL implementation to the cryptography algorithms present in the <a href="https://en.wikipedia.org/wiki/Federal_Information_Processing_Standards">FIPS</a> set of standards. This part of OpenSSL receives <a href="https://www.openssl.org/docs/fips.html">particular care</a>, including a <a href="https://www.openssl.org/news/fips-cve.html">list of relevant security issues</a>, and is subject to the <a href="https://github.com/openssl/openssl/blob/master/README-FIPS.md">FIPS 140 validation process</a> on a regular basis. The <a href="https://www.openssl.org/source/">list of FIPS validated versions</a> is also available. This allows users to ensure FIPS compliance in their use of OpenSSL.</p>
</div>
<div class="paragraph">
<p>Importantly, the <a href="https://man.freebsd.org/cgi/man.cgi?query=fips_module&amp;sektion=7&amp;format=html">fips_module(7)</a> is protected by an additional security measure, preventing its use without passing an integrity check. This check can be setup by the local system administrator, allowing every user of OpenSSL 3 to load this module. When not configured correctly, the FIPS module is expected to fail as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># echo test | openssl aes-128-cbc -a -provider fips -pbkdf2</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The ouput should be similar to the following:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>aes-128-cbc: unable to load provider fips
Hint: use -provider-path option or OPENSSL_MODULES environment variable.
00206124D94D0000:error:1C8000D5:Provider routines:SELF_TEST_post:missing config data:crypto/openssl/providers/fips/self_test.c:275:
00206124D94D0000:error:1C8000E0:Provider routines:ossl_set_error_state:fips module entering error state:crypto/openssl/providers/fips/self_test.c:373:
00206124D94D0000:error:1C8000D8:Provider routines:OSSL_provider_init_int:self test post failure:crypto/openssl/providers/fips/fipsprov.c:707:
00206124D94D0000:error:078C0105:common libcrypto routines:provider_init:init fail:crypto/openssl/crypto/provider_core.c:932:name=fips</pre>
</div>
</div>
<div class="paragraph">
<p>The check can be configured through the creation of a file in <span class="filename">/etc/ssl/fipsmodule.cnf</span>, which will then be referenced in OpenSSL’s main configuration file <span class="filename">/etc/ssl/openssl.cnf</span>. OpenSSL provides the <a href="https://man.freebsd.org/cgi/man.cgi?query=openssl-fipsinstall&amp;sektion=1&amp;format=html">openssl-fipsinstall(1)</a> utility to help with this process, which can be used as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># openssl fipsinstall -module /usr/lib/ossl-modules/fips.so -out /etc/ssl/fipsmodule.cnf</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The ouput should be similar to the following:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>INSTALL PASSED</pre>
</div>
</div>
<div class="paragraph">
<p>The <span class="filename">/etc/ssl/openssl.cnf</span> should then be modified, in order to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Include the <span class="filename">/etc/ssl/fipsmodule.cnf</span> file generated above,</p>
</li>
<li>
<p>Expose the FIPS module for possible use,</p>
</li>
<li>
<p>And explicitly activate the default module.</p>
</li>
</ul>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>[...]
# For FIPS
# Optionally include a file that is generated by the OpenSSL fipsinstall
# application. This file contains configuration data required by the OpenSSL
# fips provider. It contains a named section e.g. [fips_sect] which is
# referenced from the [provider_sect] below.
# Refer to the OpenSSL security policy for more information.
.include /etc/ssl/fipsmodule.cnf

[...]

# List of providers to load
[provider_sect]
default = default_sect
# The fips section name should match the section name inside the
# included fipsmodule.cnf.
fips = fips_sect

# If no providers are activated explicitly, the default one is activated implicitly.
# See man 7 OSSL_PROVIDER-default for more details.
#
# If you add a section explicitly activating any other provider(s), you most
# probably need to explicitly activate the default provider, otherwise it
# becomes unavailable in openssl.  As a consequence applications depending on
# OpenSSL may not work correctly which could lead to significant system
# problems including inability to remotely access the system.
[default_sect]
activate = 1</pre>
</div>
</div>
<div class="paragraph">
<p>With this done, it should be possible to confirm that the FIPS module is effectively available and working:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># echo test | openssl aes-128-cbc -a -provider fips -pbkdf2</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The ouput should be similar to the following:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>enter AES-128-CBC encryption password:
Verifying - enter AES-128-CBC encryption password:
U2FsdGVkX18idooW6e3LqWeeiKP76kufcOUClh57j8U=</pre>
</div>
</div>
<div class="paragraph">
<p>This procedure has to be repeated every time the FIPS module is modified, e.g., after performing system updates, or after applying security fixes affecting OpenSSL in the base system.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="kerberos5">16.9. Kerberos<a class="anchor" href="#kerberos5"></a></h3>
<div class="paragraph">
<p>Kerberos is a network authentication protocol which was originally created by the Massachusetts Institute of Technology (MIT) as a way to securely provide authentication across a potentially hostile network. The Kerberos protocol uses strong cryptography so that both a client and server can prove their identity without sending any unencrypted secrets over the network. Kerberos can be described as an identity-verifying proxy system and as a trusted third-party authentication system. After a user authenticates with Kerberos, their communications can be encrypted to assure privacy and data integrity.</p>
</div>
<div class="paragraph">
<p>The only function of Kerberos is to provide the secure authentication of users and servers on the network. It does not provide authorization or auditing functions. It is recommended that Kerberos be used with other security methods which provide authorization and audit services.</p>
</div>
<div class="paragraph">
<p>The current version of the protocol is version 5, described in RFC 4120. Several free implementations of this protocol are available, covering a wide range of operating systems. MIT continues to develop their Kerberos package. It is commonly used in the US as a cryptography product, and has historically been subject to US export regulations. In FreeBSD, MITKerberos is available as the <a class="package" href="https://cgit.freebsd.org/ports/tree/security/krb5/">security/krb5</a> package or port. The Heimdal Kerberos implementation was explicitly developed outside of the US to avoid export regulations. The Heimdal Kerberos distribution is included in the base FreeBSD installation, and another distribution with more configurable options is available as <a class="package" href="https://cgit.freebsd.org/ports/tree/security/heimdal/">security/heimdal</a> in the Ports Collection.</p>
</div>
<div class="paragraph">
<p>In Kerberos users and services are identified as &#34;principals&#34; which are contained within an administrative grouping, called a &#34;realm&#34;. A typical user principal would be of the form <code><em>user</em>@<em>REALM</em></code> (realms are traditionally uppercase).</p>
</div>
<div class="paragraph">
<p>This section provides a guide on how to set up Kerberos using the Heimdal distribution included in FreeBSD.</p>
</div>
<div class="paragraph">
<p>For purposes of demonstrating a Kerberos installation, the name spaces will be as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The DNS domain (zone) will be <code>example.org</code>.</p>
</li>
<li>
<p>The Kerberos realm will be <code>EXAMPLE.ORG</code>.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Use real domain names when setting up Kerberos, even if it will run internally. This avoids DNS problems and assures inter-operation with other Kerberos realms.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="sect3">
<h4 id="_setting_up_a_heimdal_kdc">16.9.1. Setting up a Heimdal KDC<a class="anchor" href="#_setting_up_a_heimdal_kdc"></a></h4>
<div class="paragraph">
<p>The Key Distribution Center (KDC) is the centralized authentication service that Kerberos provides, the &#34;trusted third party&#34; of the system. It is the computer that issues Kerberos tickets, which are used for clients to authenticate to servers. As the KDC is considered trusted by all other computers in the Kerberos realm, it has heightened security concerns. Direct access to the KDC should be limited.</p>
</div>
<div class="paragraph">
<p>While running a KDC requires few computing resources, a dedicated machine acting only as a KDC is recommended for security reasons.</p>
</div>
<div class="paragraph">
<p>To begin, install the <a class="package" href="https://cgit.freebsd.org/ports/tree/security/heimdal/">security/heimdal</a> package as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install heimdal</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Next, update <span class="filename">/etc/rc.conf</span> using <code>sysrc</code> as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysrc kdc_enable=yes</span>
<span class="c"># sysrc kadmind_enable=yes</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Next, edit <span class="filename">/etc/krb5.conf</span> as follows:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>[libdefaults]
    default_realm = EXAMPLE.ORG
[realms]
    EXAMPLE.ORG = {
	kdc = kerberos.example.org
	admin_server = kerberos.example.org
    }
[domain_realm]
    .example.org = EXAMPLE.ORG</pre>
</div>
</div>
<div class="paragraph">
<p>In this example, the KDC will use the fully-qualified hostname <code>kerberos.example.org</code>. The hostname of the KDC must be resolvable in the DNS.</p>
</div>
<div class="paragraph">
<p>Kerberos can also use the DNS to locate KDCs, instead of a <code>[realms]</code> section in <span class="filename">/etc/krb5.conf</span>. For large organizations that have their own DNS servers, the above example could be trimmed to:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>[libdefaults]
      default_realm = EXAMPLE.ORG
[domain_realm]
    .example.org = EXAMPLE.ORG</pre>
</div>
</div>
<div class="paragraph">
<p>With the following lines being included in the <code>example.org</code> zone file:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>_kerberos._udp      IN  SRV     01 00 88 kerberos.example.org.
_kerberos._tcp      IN  SRV     01 00 88 kerberos.example.org.
_kpasswd._udp       IN  SRV     01 00 464 kerberos.example.org.
_kerberos-adm._tcp  IN  SRV     01 00 749 kerberos.example.org.
_kerberos           IN  TXT     EXAMPLE.ORG</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In order for clients to be able to find the Kerberos services, they <em>must</em> have either a fully configured <span class="filename">/etc/krb5.conf</span> or a minimally configured <span class="filename">/etc/krb5.conf</span> <em>and</em> a properly configured DNS server.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Next, create the Kerberos database which contains the keys of all principals (users and hosts) encrypted with a master password. It is not required to remember this password as it will be stored in <span class="filename">/var/heimdal/m-key</span>; it would be reasonable to use a 45-character random password for this purpose. To create the master key, run <code>kstash</code> and enter a password:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># kstash</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should be similar to the following:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>Master key: xxxxxxxxxxxxxxxxxxxxxxx
Verifying password - Master key: xxxxxxxxxxxxxxxxxxxxxxx</pre>
</div>
</div>
<div class="paragraph">
<p>Once the master key has been created, the database should be initialized. The Kerberos administrative tool <a href="https://man.freebsd.org/cgi/man.cgi?query=kadmin&amp;sektion=8&amp;format=html">kadmin(8)</a> can be used on the KDC in a mode that operates directly on the database, without using the <a href="https://man.freebsd.org/cgi/man.cgi?query=kadmind&amp;sektion=8&amp;format=html">kadmind(8)</a> network service, as <code>kadmin -l</code>. This resolves the chicken-and-egg problem of trying to connect to the database before it is created. At the <code>kadmin</code> prompt, use <code>init</code> to create the realm’s initial database:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># kadmin -l</span>
<span class="gp">kadmin&gt; </span>init EXAMPLE.ORG
Realm max ticket life <span class="o">[</span>unlimited]:</code></pre>
</div>
</div>
<div class="paragraph">
<p>Lastly, while still in <code>kadmin</code>, create the first principal using <code>add</code>. Stick to the default options for the principal for now, as these can be changed later with <code>modify</code>. Type <code>?</code> at the prompt to see the available options.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">kadmin&gt; </span>add tillman</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should be similar to the following:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>Max ticket life [unlimited]:
Max renewable life [unlimited]:
Principal expiration time [never]:
Password expiration time [never]:
Attributes []:
Password: xxxxxxxx
Verifying password - Password: xxxxxxxx</pre>
</div>
</div>
<div class="paragraph">
<p>Next, start the KDC services by running:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># service kdc start</span>
<span class="c"># service kadmind start</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>While there will not be any kerberized daemons running at this point, it is possible to confirm that the KDC is functioning by obtaining a ticket for the principal that was just created:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>kinit tillman</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should be similar to the following:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>tillman@EXAMPLE.ORG&#39;s Password:</pre>
</div>
</div>
<div class="paragraph">
<p>Confirm that a ticket was successfully obtained using <code>klist</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>klist</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should be similar to the following:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>Credentials cache: FILE:/tmp/krb5cc_1001
	Principal: tillman@EXAMPLE.ORG

  Issued                Expires               Principal
Aug 27 15:37:58 2013  Aug 28 01:37:58 2013  krbtgt/EXAMPLE.ORG@EXAMPLE.ORG</pre>
</div>
</div>
<div class="paragraph">
<p>The temporary ticket can be destroyed when the test is finished:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>kdestroy</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_configuring_a_server_to_use_kerberos">16.9.2. Configuring a Server to Use Kerberos<a class="anchor" href="#_configuring_a_server_to_use_kerberos"></a></h4>
<div class="paragraph">
<p>The first step in configuring a server to use Kerberos authentication is to ensure that it has the correct configuration in <span class="filename">/etc/krb5.conf</span>. The version from the KDC can be used as-is, or it can be regenerated on the new system.</p>
</div>
<div class="paragraph">
<p>Next, create <span class="filename">/etc/krb5.keytab</span> on the server. This is the main part of &#34;Kerberizing&#34; a service - it corresponds to generating a secret shared between the service and the KDC. The secret is a cryptographic key, stored in a &#34;keytab&#34;. The keytab contains the server’s host key, which allows it and the KDC to verify each others&#39; identity. It must be transmitted to the server in a secure fashion, as the security of the server can be broken if the key is made public. Typically, the <span class="filename">keytab</span> is generated on an administrator’s trusted machine using <code>kadmin</code>, then securely transferred to the server, e.g., with <a href="https://man.freebsd.org/cgi/man.cgi?query=scp&amp;sektion=1&amp;format=html">scp(1)</a>; it can also be created directly on the server if that is consistent with the desired security policy. It is very important that the keytab is transmitted to the server in a secure fashion: if the key is known by some other party, that party can impersonate any user to the server! Using <code>kadmin</code> on the server directly is convenient, because the entry for the host principal in the KDC database is also created using <code>kadmin</code>.</p>
</div>
<div class="paragraph">
<p>Of course, <code>kadmin</code> is a kerberized service; a Kerberos ticket is needed to authenticate to the network service, but to ensure that the user running <code>kadmin</code> is actually present (and their session has not been hijacked), <code>kadmin</code> will prompt for the password to get a fresh ticket. The principal authenticating to the kadmin service must be permitted to use the <code>kadmin</code> interface, as specified in <span class="filename">/var/heimdal/kadmind.acl</span>. See the section titled &#34;Remote administration&#34; in <code>info heimdal</code> for details on designing access control lists. Instead of enabling remote <code>kadmin</code> access, the administrator could securely connect to the KDC via the local console or <a href="https://man.freebsd.org/cgi/man.cgi?query=ssh&amp;sektion=1&amp;format=html">ssh(1)</a>, and perform administration locally using <code>kadmin -l</code>.</p>
</div>
<div class="paragraph">
<p>After installing <span class="filename">/etc/krb5.conf</span>, use <code>add --random-key</code> in <code>kadmin</code>. This adds the server’s host principal to the database, but does not extract a copy of the host principal key to a keytab. To generate the keytab, use <code>ext</code> to extract the server’s host principal key to its own keytab:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># kadmin</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should be similar to the following:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>kadmin&gt; add --random-key host/myserver.example.org
Max ticket life [unlimited]:
Max renewable life [unlimited]:
Principal expiration time [never]:
Password expiration time [never]:
Attributes []:
kadmin&gt; ext_keytab host/myserver.example.org
kadmin&gt; exit</pre>
</div>
</div>
<div class="paragraph">
<p>Note that <code>ext_keytab</code> stores the extracted key in <span class="filename">/etc/krb5.keytab</span> by default. This is good when being run on the server being kerberized, but the <code>--keytab <em>path/to/file</em></code> argument should be used when the keytab is being extracted elsewhere:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># kadmin</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should be similar to the following:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>kadmin&gt; ext_keytab --keytab=/tmp/example.keytab host/myserver.example.org
kadmin&gt; exit</pre>
</div>
</div>
<div class="paragraph">
<p>The keytab can then be securely copied to the server using <a href="https://man.freebsd.org/cgi/man.cgi?query=scp&amp;sektion=1&amp;format=html">scp(1)</a> or a removable media. Be sure to specify a non-default keytab name to avoid inserting unneeded keys into the system’s keytab.</p>
</div>
<div class="paragraph">
<p>At this point, the server can read encrypted messages from the KDC using its shared key, stored in <span class="filename">krb5.keytab</span>. It is now ready for the Kerberos-using services to be enabled. One of the most common such services is <a href="https://man.freebsd.org/cgi/man.cgi?query=sshd&amp;sektion=8&amp;format=html">sshd(8)</a>, which supports Kerberos via the GSS-API. In <span class="filename">/etc/ssh/sshd_config</span>, add the line:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>GSSAPIAuthentication yes</pre>
</div>
</div>
<div class="paragraph">
<p>After making this change, <a href="https://man.freebsd.org/cgi/man.cgi?query=sshd&amp;sektion=8&amp;format=html">sshd(8)</a> must be restarted for the new configuration to take effect: <code>service sshd restart</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_configuring_a_client_to_use_kerberos">16.9.3. Configuring a Client to Use Kerberos<a class="anchor" href="#_configuring_a_client_to_use_kerberos"></a></h4>
<div class="paragraph">
<p>As it was for the server, the client requires configuration in <span class="filename">/etc/krb5.conf</span>. Copy the file in place (securely) or re-enter it as needed.</p>
</div>
<div class="paragraph">
<p>Test the client by using <code>kinit</code>, <code>klist</code>, and <code>kdestroy</code> from the client to obtain, show, and then delete a ticket for an existing principal. Kerberos applications should also be able to connect to Kerberos enabled servers. If that does not work but obtaining a ticket does, the problem is likely with the server and not with the client or the KDC. In the case of kerberized <a href="https://man.freebsd.org/cgi/man.cgi?query=ssh&amp;sektion=1&amp;format=html">ssh(1)</a>, GSS-API is disabled by default, so test using <code>ssh -o GSSAPIAuthentication=yes <em>hostname</em></code>.</p>
</div>
<div class="paragraph">
<p>When testing a Kerberized application, try using a packet sniffer such as <code>tcpdump</code> to confirm that no sensitive information is sent in the clear.</p>
</div>
<div class="paragraph">
<p>Various Kerberos client applications are available. With the advent of a bridge so that applications using SASL for authentication can use GSS-API mechanisms as well, large classes of client applications can use Kerberos for authentication, from Jabber clients to IMAP clients.</p>
</div>
<div class="paragraph">
<p>Users within a realm typically have their Kerberos principal mapped to a local user account. Occasionally, one needs to grant access to a local user account to someone who does not have a matching Kerberos principal. For example, <code>tillman@EXAMPLE.ORG</code> may need access to the local user account <code>webdevelopers</code>. Other principals may also need access to that local account.</p>
</div>
<div class="paragraph">
<p>The <span class="filename">.k5login</span> and <span class="filename">.k5users</span> files, placed in a user’s home directory, can be used to solve this problem. For example, if the following <span class="filename">.k5login</span> is placed in the home directory of <code>webdevelopers</code>, both principals listed will have access to that account without requiring a shared password:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>tillman@example.org
jdoe@example.org</pre>
</div>
</div>
<div class="paragraph">
<p>Refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=ksu&amp;sektion=1&amp;format=html">ksu(1)</a> for more information about <span class="filename">.k5users</span>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_mit_differences">16.9.4. MIT Differences<a class="anchor" href="#_mit_differences"></a></h4>
<div class="paragraph">
<p>The major difference between the MIT and Heimdal implementations is that <code>kadmin</code> has a different, but equivalent, set of commands and uses a different protocol. If the KDC is MIT, the Heimdal version of <code>kadmin</code> cannot be used to administer the KDC remotely, and vice versa.</p>
</div>
<div class="paragraph">
<p>Client applications may also use slightly different command line options to accomplish the same tasks. Following the instructions at <a href="http://web.mit.edu/Kerberos/www/">http://web.mit.edu/Kerberos/www/</a> is recommended. Be careful of path issues: the MIT port installs into <span class="filename">/usr/local/</span> by default, and the FreeBSD system applications run instead of the MIT versions if <code>PATH</code> lists the system directories first.</p>
</div>
<div class="paragraph">
<p>When using MIT Kerberos as a KDC on FreeBSD, execute the following commands to add the required configurations to <span class="filename">/etc/rc.conf</span>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysrc kdc_program=&#34;/usr/local/sbin/kdc&#34;</span>
<span class="c"># sysrc kadmind_program=&#34;/usr/local/sbin/kadmind&#34;</span>
<span class="c"># sysrc kdc_flags=&#34;&#34;</span>
<span class="c"># sysrc kdc_enable=&#34;YES&#34;</span>
<span class="c"># sysrc kadmind_enable=&#34;YES&#34;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_kerberos_tips_tricks_and_troubleshooting">16.9.5. Kerberos Tips, Tricks, and Troubleshooting<a class="anchor" href="#_kerberos_tips_tricks_and_troubleshooting"></a></h4>
<div class="paragraph">
<p>When configuring and troubleshooting Kerberos, keep the following points in mind:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>When using either Heimdal or MITKerberos from ports, ensure that the <code>PATH</code> lists the port’s versions of the client applications before the system versions.</p>
</li>
<li>
<p>If all the computers in the realm do not have synchronized time settings, authentication may fail. <a href="./#network-ntp">“Clock Synchronization with NTP”</a> describes how to synchronize clocks using NTP.</p>
</li>
<li>
<p>If the hostname is changed, the <code>host/</code> principal must be changed and the keytab updated. This also applies to special keytab entries like the <code>HTTP/</code> principal used for Apache’s <a class="package" href="https://cgit.freebsd.org/ports/tree/www/mod_auth_kerb/">www/mod_auth_kerb</a>.</p>
</li>
<li>
<p>All hosts in the realm must be both forward and reverse resolvable in DNS or, at a minimum, exist in <span class="filename">/etc/hosts</span>. CNAMEs will work, but the A and PTR records must be correct and in place. The error message for unresolvable hosts is not intuitive: <code>Kerberos5 refuses authentication because Read req failed: Key table entry not found</code>.</p>
</li>
<li>
<p>Some operating systems that act as clients to the KDC do not set the permissions for <code>ksu</code> to be setuid <code>root</code>. This means that <code>ksu</code> does not work. This is a permissions problem, not a KDC error.</p>
</li>
<li>
<p>With MITKerberos, to allow a principal to have a ticket life longer than the default lifetime of ten hours, use <code>modify_principal</code> at the <a href="https://man.freebsd.org/cgi/man.cgi?query=kadmin&amp;sektion=8&amp;format=html">kadmin(8)</a> prompt to change the <code>maxlife</code> of both the principal in question and the <code>krbtgt</code> principal. The principal can then use <code>kinit -l</code> to request a ticket with a longer lifetime.</p>
</li>
<li>
<p>When running a packet sniffer on the KDC to aid in troubleshooting while running <code>kinit</code> from a workstation, the Ticket Granting Ticket (TGT) is sent immediately, even before the password is typed. This is because the Kerberos server freely transmits a TGT to any unauthorized request. However, every TGT is encrypted in a key derived from the user’s password. When a user types their password, it is not sent to the KDC, it is instead used to decrypt the TGT that <code>kinit</code> already obtained. If the decryption process results in a valid ticket with a valid time stamp, the user has valid Kerberos credentials. These credentials include a session key for establishing secure communications with the Kerberos server in the future, as well as the actual TGT, which is encrypted with the Kerberos server’s own key. This second layer of encryption allows the Kerberos server to verify the authenticity of each TGT.</p>
</li>
<li>
<p>Host principals can have a longer ticket lifetime. If the user principal has a lifetime of a week but the host being connected to has a lifetime of nine hours, the user cache will have an expired host principal and the ticket cache will not work as expected.</p>
</li>
<li>
<p>When setting up <span class="filename">krb5.dict</span> to prevent specific bad passwords from being used as described in <a href="https://man.freebsd.org/cgi/man.cgi?query=kadmind&amp;sektion=8&amp;format=html">kadmind(8)</a>, remember that it only applies to principals that have a password policy assigned to them. The format used in <span class="filename">krb5.dict</span> is one string per line. Creating a symbolic link to <span class="filename">/usr/share/dict/words</span> might be useful.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_mitigating_kerberos_limitations">16.9.6. Mitigating Kerberos Limitations<a class="anchor" href="#_mitigating_kerberos_limitations"></a></h4>
<div class="paragraph">
<p>Since Kerberos is an all or nothing approach, every service enabled on the network must either be modified to work with Kerberos or be otherwise secured against network attacks. This is to prevent user credentials from being stolen and re-used. An example is when Kerberos is enabled on all remote shells but the non-Kerberized POP3 mail server sends passwords in plain text.</p>
</div>
<div class="paragraph">
<p>The KDC is a single point of failure. By design, the KDC must be as secure as its master password database. The KDC should have absolutely no other services running on it and should be physically secure. The danger is high because Kerberos stores all passwords encrypted with the same master key which is stored as a file on the KDC.</p>
</div>
<div class="paragraph">
<p>A compromised master key is not quite as bad as one might fear. The master key is only used to encrypt the Kerberos database and as a seed for the random number generator. As long as access to the KDC is secure, an attacker cannot do much with the master key.</p>
</div>
<div class="paragraph">
<p>If the KDC is unavailable, network services are unusable as authentication cannot be performed. This can be alleviated with a single master KDC and one or more slaves, and with careful implementation of secondary or fall-back authentication using PAM.</p>
</div>
<div class="paragraph">
<p>Kerberos allows users, hosts and services to authenticate between themselves. It does not have a mechanism to authenticate the KDC to the users, hosts, or services. This means that a trojaned <code>kinit</code> could record all user names and passwords. File system integrity checking tools like <a class="package" href="https://cgit.freebsd.org/ports/tree/security/tripwire/">security/tripwire</a> can alleviate this.</p>
</div>
</div>
<div class="sect3">
<h4 id="_resources_and_further_information">16.9.7. Resources and Further Information<a class="anchor" href="#_resources_and_further_information"></a></h4>
<div class="ulist">
<ul>
<li>
<p><a href="http://www.faqs.org/faqs/Kerberos-faq/general/preamble.html">The Kerberos FAQ</a></p>
</li>
<li>
<p><a href="http://web.mit.edu/Kerberos/www/dialogue.html">Designing an Authentication System: a Dialog in Four Scenes</a></p>
</li>
<li>
<p><a href="https://www.ietf.org/rfc/rfc4120.txt">RFC 4120, The Kerberos Network Authentication Service (V5)</a></p>
</li>
<li>
<p><a href="http://web.mit.edu/Kerberos/www/">MIT Kerberos home page</a></p>
</li>
<li>
<p><a href="https://github.com/heimdal/heimdal/wiki">Heimdal Kerberos project wiki page</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="tcpwrappers">16.10. TCP Wrappers<a class="anchor" href="#tcpwrappers"></a></h3>
<div class="paragraph">
<p>TCP Wrappers is a host-based network access control system. By intercepting incoming network requests before they reach the actual network service, TCP Wrappers assess whether the source IP address is permitted or denied access based on predefined rules in configuration files.</p>
</div>
<div class="paragraph">
<p>However, while TCP Wrappers provide basic access control, they should not be considered a substitute for more robust security measures. For comprehensive protection, it’s recommended to use advanced technologies like firewalls, along with proper user authentication practices and intrusion detection systems.</p>
</div>
<div class="sect3">
<h4 id="tcpwrappers-initial-configuration">16.10.1. Initial Configuration<a class="anchor" href="#tcpwrappers-initial-configuration"></a></h4>
<div class="paragraph">
<p>TCP Wrappers are enabled by default in <a href="https://man.freebsd.org/cgi/man.cgi?query=inetd&amp;sektion=8&amp;format=html">inetd(8)</a>. So the first step will be to enable <a href="https://man.freebsd.org/cgi/man.cgi?query=inetd&amp;sektion=8&amp;format=html">inetd(8)</a> executing the following commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysrc inetd_enable=&#34;YES&#34;</span>
<span class="c"># service inetd start</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, properly configure <span class="filename">/etc/hosts.allow</span>.</p>
</div>
<div class="admonitionblock warning">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Unlike other implementations of TCP Wrappers, the use of <span class="filename">hosts.deny</span> is deprecated in FreeBSD. All configuration options should be placed in <span class="filename">/etc/hosts.allow</span>.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>In the simplest configuration, daemon connection policies are set to either permit or block, depending on the options in <span class="filename">/etc/hosts.allow</span>. The default configuration in FreeBSD is to allow all connections to the daemons started with inetd.</p>
</div>
<div class="paragraph">
<p>Basic configuration usually takes the form of <code>daemon : address : action</code>, where <code>daemon</code> is the daemon which inetd started, <code>address</code> is a valid hostname, IP address, or an IPv6 address enclosed in brackets ([ ]), and <code>action</code> is either <code>allow</code> or <code>deny</code>. TCP Wrappers uses a first rule match semantic, meaning that the configuration file is scanned from the beginning for a matching rule. When a match is found, the rule is applied and the search process stops.</p>
</div>
<div class="paragraph">
<p>For example, to allow POP3 connections via the <a class="package" href="https://cgit.freebsd.org/ports/tree/mail/qpopper/">mail/qpopper</a> daemon, the following lines should be appended to <span class="filename">/etc/hosts.allow</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre># This line is required for POP3 connections:
qpopper : ALL : allow</pre>
</div>
</div>
<div class="paragraph">
<p>Whenever this file is edited, restart inetd:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># service inetd restart</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="tcpwrappers-advanced-config">16.10.2. Advanced Configuration<a class="anchor" href="#tcpwrappers-advanced-config"></a></h4>
<div class="paragraph">
<p>TCP Wrappers provides advanced options to allow more control over the way connections are handled. In some cases, it may be appropriate to return a comment to certain hosts or daemon connections. In other cases, a log entry should be recorded or an email sent to the administrator. Other situations may require the use of a service for local connections only. This is all possible through the use of configuration options known as wildcards, expansion characters, and external command execution. To learn more about wildcards and their associated functionality, refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=hosts_access&amp;sektion=5&amp;format=html">hosts_access(5)</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="fs-acl">16.11. Access Control Lists<a class="anchor" href="#fs-acl"></a></h3>
<div class="paragraph">
<p>Access Control Lists (ACLs) extend traditional UNIX® file permissions by allowing fine-grained access control for users and groups on a per-file or per-directory basis. Each ACL entry defines a user or group and the associated permissions, such as read, write, and execute. FreeBSD provides commands like <a href="https://man.freebsd.org/cgi/man.cgi?query=getfacl&amp;sektion=1&amp;format=html">getfacl(1)</a> and <a href="https://man.freebsd.org/cgi/man.cgi?query=setfacl&amp;sektion=1&amp;format=html">setfacl(1)</a> to manage ACLs.</p>
</div>
<div class="paragraph">
<p>ACLs are useful in scenarios requiring more specific access control than standard permissions, commonly used in multi-user environments or shared hosting. However, complexity may be unavoidable, but careful planning is required to ensure that the desired security properties are being provided</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>FreeBSD supports the implementation of NFSv4 ACLs in both UFS and OpenZFS. Please note that some arguments to the <a href="https://man.freebsd.org/cgi/man.cgi?query=setfacl&amp;sektion=1&amp;format=html">setfacl(1)</a> command only work with POSIX ACLs and others in NFSv4 ACLs.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="sect3">
<h4 id="acl-enabling-support-ufs">16.11.1. Enabling ACL Support in UFS<a class="anchor" href="#acl-enabling-support-ufs"></a></h4>
<div class="paragraph">
<p>ACLs are enabled by the mount-time administrative flag, <code>acls</code>, which may be added to <span class="filename">/etc/fstab</span>.</p>
</div>
<div class="paragraph">
<p>Therefore it will be necessary to access <span class="filename">/etc/fstab</span> and in the options section add the <code>acls</code> flag as follows:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre># Device        Mountpoint        FStype    Options     Dump      Pass#
/dev/ada0s1a    /                 ufs       rw,acls     1         1</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="security-acl-info">16.11.2. Get ACLs information<a class="anchor" href="#security-acl-info"></a></h4>
<div class="paragraph">
<p>It is possible to check the ACLs of a file or a directory using <a href="https://man.freebsd.org/cgi/man.cgi?query=getfacl&amp;sektion=1&amp;format=html">getfacl(1)</a>.</p>
</div>
<div class="paragraph">
<p>For example, to view the ACL settings on <span class="filename">~/test</span> file execute the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>getfacl <span class="nb">test</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should be similar to the following in case of using NFSv4 ACLs:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre># file: test
# owner: freebsduser
# group: freebsduser
            owner@:rw-p--aARWcCos:-------:allow
            group@:r-----a-R-c--s:-------:allow
         everyone@:r-----a-R-c--s:-------:allow</pre>
</div>
</div>
<div class="paragraph">
<p>And the output should be similar to the following in case of using POSIX.1e ACLs:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre># file: test
# owner: freebsduser
# group: freebsduser
user::rw-
group::r--
other::r--</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="security-working-acls">16.11.3. Working with ACLs<a class="anchor" href="#security-working-acls"></a></h4>
<div class="paragraph">
<p><a href="https://man.freebsd.org/cgi/man.cgi?query=setfacl&amp;sektion=1&amp;format=html">setfacl(1)</a> can be used to add, modify or remove ACLs from a file or directory.</p>
</div>
<div class="paragraph">
<p>As noted above, some arguments to <a href="https://man.freebsd.org/cgi/man.cgi?query=setfacl&amp;sektion=1&amp;format=html">setfacl(1)</a> do not work with NFSv4 ACLs, and vice versa. This section covers how to execute the commands for POSIX ACLs and for NFSv4 ACLs and shows examples of both.</p>
</div>
<div class="paragraph">
<p>For example, to set the mandatory elements of the POSIX.1e default ACL:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>setfacl -d -m u::rwx,g::rx,o::rx,mask::rwx directory</code></pre>
</div>
</div>
<div class="paragraph">
<p>This other example sets read, write, and execute permissions for the file owner’s POSIX.1e ACL entry and read and write permissions for group mail on file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>setfacl -m u::rwx,g:mail:rw file</code></pre>
</div>
</div>
<div class="paragraph">
<p>To do the same as in the previous example but in NFSv4 ACL:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>setfacl -m owner@:rwxp::allow,g:mail:rwp::allow file</code></pre>
</div>
</div>
<div class="paragraph">
<p>To remove all ACL entries except for the three required from file in POSIX.1e ACL:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>setfacl -bn file</code></pre>
</div>
</div>
<div class="paragraph">
<p>To remove all ACL entries in NFSv4 ACL:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>setfacl -b file</code></pre>
</div>
</div>
<div class="paragraph">
<p>Refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=getfacl&amp;sektion=1&amp;format=html">getfacl(1)</a> and <a href="https://man.freebsd.org/cgi/man.cgi?query=setfacl&amp;sektion=1&amp;format=html">setfacl(1)</a> for more information about the options available for these commands.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="capsicum">16.12. Capsicum<a class="anchor" href="#capsicum"></a></h3>
<div class="paragraph">
<p>Capsicum is a lightweight OS capability and sandbox framework implementing a hybrid capability system model. Capabilities are unforgeable tokens of authority that can be delegated and must be presented to perform an action. Capsicum makes file descriptors into capabilities.</p>
</div>
<div class="paragraph">
<p>Capsicum can be used for application and library compartmentalisation, the decomposition of larger bodies of software into isolated (sandboxed) components in order to implement security policies and limit the impact of software vulnerabilities.</p>
</div>
</div>
<div class="sect2">
<h3 id="security-accounting">16.13. Process Accounting<a class="anchor" href="#security-accounting"></a></h3>
<div class="paragraph">
<p>Process accounting is a security method in which an administrator may keep track of system resources used and their allocation among users, provide for system monitoring, and minimally track a user’s commands.</p>
</div>
<div class="paragraph">
<p>Process accounting has both positive and negative points. One of the positives is that an intrusion may be narrowed down to the point of entry. A negative is the amount of logs generated by process accounting, and the disk space they may require. This section walks an administrator through the basics of process accounting.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If more fine-grained accounting is needed, refer to <a href="./#audit">Security Event Auditing</a>.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="sect3">
<h4 id="_enabling_and_utilizing_process_accounting">16.13.1. Enabling and Utilizing Process Accounting<a class="anchor" href="#_enabling_and_utilizing_process_accounting"></a></h4>
<div class="paragraph">
<p>Before using process accounting, it must be enabled using the following commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysrc accounting_enable=yes</span>
<span class="c"># service accounting start</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The accounting information is stored in files located in <span class="filename">/var/account</span>, which is automatically created, if necessary, the first time the accounting service starts. These files contain sensitive information, including all the commands issued by all users. Write access to the files is limited to <code>root</code>, and read access is limited to <code>root</code> and members of the <code>wheel</code> group. To also prevent members of <code>wheel</code> from reading the files, change the mode of the <span class="filename">/var/account</span> directory to allow access only by <code>root</code>.</p>
</div>
<div class="paragraph">
<p>Once enabled, accounting will begin to track information such as CPU statistics and executed commands. All accounting logs are in a non-human readable format which can be viewed using <a href="https://man.freebsd.org/cgi/man.cgi?query=sa&amp;sektion=8&amp;format=html">sa(8)</a>. If issued without any options, <a href="https://man.freebsd.org/cgi/man.cgi?query=sa&amp;sektion=8&amp;format=html">sa(8)</a> prints information relating to the number of per-user calls, the total elapsed time in minutes, total CPU and user time in minutes, and the average number of I/O operations. Refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=sa&amp;sektion=8&amp;format=html">sa(8)</a> for the list of available options which control the output.</p>
</div>
<div class="paragraph">
<p>To display the commands issued by users, use <code>lastcomm</code>.</p>
</div>
<div class="paragraph">
<p>For example, this command prints out all usage of <code>ls</code> by <code>trhodes</code> on the <code>ttyp1</code> terminal:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># lastcomm ls trhodes ttyp1</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Many other useful options exist and are explained in <a href="https://man.freebsd.org/cgi/man.cgi?query=lastcomm&amp;sektion=1&amp;format=html">lastcomm(1)</a>, <a href="https://man.freebsd.org/cgi/man.cgi?query=acct&amp;sektion=5&amp;format=html">acct(5)</a>, and <a href="https://man.freebsd.org/cgi/man.cgi?query=sa&amp;sektion=8&amp;format=html">sa(8)</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="security-resourcelimits">16.14. Resource Limits<a class="anchor" href="#security-resourcelimits"></a></h3>
<div class="paragraph">
<p>In FreeBSD, resource limits refer to the mechanisms that control and manage the allocation of various system resources to processes and users. These limits are designed to prevent a single process or user from consuming an excessive amount of resources, which could lead to performance degradation or system instability. Resource limits help ensure fair resource distribution among all active processes and users on the system.</p>
</div>
<div class="paragraph">
<p>FreeBSD provides several methods for an administrator to limit the amount of system resources an individual may use.</p>
</div>
<div class="paragraph">
<p>The traditional method defines login classes by editing <span class="filename">/etc/login.conf</span>. While this method is still supported, any changes require a multi-step process of editing this file, rebuilding the resource database, making necessary changes to <span class="filename">/etc/master.passwd</span>, and rebuilding the password database. This can become time consuming, depending upon the number of users to configure.</p>
</div>
<div class="paragraph">
<p><a href="https://man.freebsd.org/cgi/man.cgi?query=rctl&amp;sektion=8&amp;format=html">rctl(8)</a> can be used to provide a more fine-grained method for controlling resource limits. This command supports more than user limits as it can also be used to set resource constraints on processes and jails.</p>
</div>
<div class="paragraph">
<p>This section demonstrates both methods for controlling resources, beginning with the traditional method.</p>
</div>
<div class="sect3">
<h4 id="security-resource-limits-types">16.14.1. Types of Resources<a class="anchor" href="#security-resource-limits-types"></a></h4>
<div class="paragraph">
<p>FreeBSD provides limits for various types of resources, including:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">表 29. Resource types</caption>
<colgroup>
<col style="width: 50%;"/>
<col style="width: 50%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CPU Time</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Limits the amount of CPU time a process can consume</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Memory</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Controls the amount of physical memory a process can use</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Open Files</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Limits the number of files a process can have open simultaneously</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Processes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Controls the number of processes a user or a process can create</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">File Size</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Limits the maximum size of files that a process can create</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Core Dumps</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Controls whether processes are allowed to generate core dump files</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Network Resources</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Limits the amount of network resources (e.g., sockets) a process can use</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>For a full listing of types see <a href="https://man.freebsd.org/cgi/man.cgi?query=login.conf&amp;sektion=5&amp;format=html">login.conf(5)</a> and <a href="https://man.freebsd.org/cgi/man.cgi?query=rctl&amp;sektion=8&amp;format=html">rctl(8)</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="users-limiting">16.14.2. Configuring Login Classes<a class="anchor" href="#users-limiting"></a></h4>
<div class="paragraph">
<p>In the traditional method, login classes and the resource limits to apply to a login class are defined in <span class="filename">/etc/login.conf</span>. Each user account can be assigned to a login class, where <code>default</code> is the default login class. Each login class has a set of login capabilities associated with it. A login capability is a <code><em>name</em>=<em>value</em></code> pair, where <em>name</em> is a well-known identifier and <em>value</em> is an arbitrary string which is processed accordingly depending on the <em>name</em>.</p>
</div>
<div class="paragraph">
<p>The first step to configure a resource limit will be to open <span class="filename">/etc/login.conf</span> by executing the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ee /etc/login.conf</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then locate the section for the user class to be modified. In this example, let’s assume the user class is named <code>limited</code>, create it in case it not exists.</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>limited:\ <i class="conum" data-value="1"></i><b>(1)</b>
        :maxproc=50:\ <i class="conum" data-value="2"></i><b>(2)</b>
        :tc=default: <i class="conum" data-value="3"></i><b>(3)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Name of the user class. &lt;.&gt; Sets the maximum number of processes (maxproc) to 50 for users in the <code>limited</code> class. &lt;.&gt; Indicates that this user class inherits the default settings from the &#34;default&#34; class.</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>After modifying the <span class="filename">/etc/login.conf</span> file, run <a href="https://man.freebsd.org/cgi/man.cgi?query=cap_mkdb&amp;sektion=1&amp;format=html">cap_mkdb(1)</a> to generate the database that FreeBSD uses to apply these settings:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># cap_mkdb /etc/login.conf</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><a href="https://man.freebsd.org/cgi/man.cgi?query=chpass&amp;sektion=1&amp;format=html">chpass(1)</a> can be used to change the class to the desired user executint the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># chpass username</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This will open a text editor, add the new <code>limited</code> class there as follows:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>#Changing user information for username.
Login: username
Password: $6$2H.419USdGaiJeqK$6kgcTnDadasdasd3YnlNZsOni5AMymibkAfRCPirc7ZFjjv
DVsKyXx26daabdfqSdasdsmL/ZMUpdHiO0
Uid [#]: 1001
Gid [# or name]: 1001
Change [month day year]:
Expire [month day year]:
Class: limited
Home directory: /home/username
Shell: /bin/sh
Full Name: User &amp;
Office Location:
Office Phone:
Home Phone:
Other information:</pre>
</div>
</div>
<div class="paragraph">
<p>Now, the user assigned to the <code>limited</code> class will have a maximum process limit of 50. Remember that this is just one example of setting a resource limit using the <span class="filename">/etc/login.conf</span> file.</p>
</div>
<div class="paragraph">
<p>Keep in mind that after making changes to the <span class="filename">/etc/login.conf</span> file, the user needs to log out and log back in for the changes to take effect. Additionally, always exercise caution when editing system configuration files, especially when using privileged access.</p>
</div>
</div>
<div class="sect3">
<h4 id="security-rctl">16.14.3. Enabling and Configuring Resource Limits<a class="anchor" href="#security-rctl"></a></h4>
<div class="paragraph">
<p>The <a href="https://man.freebsd.org/cgi/man.cgi?query=rctl&amp;sektion=8&amp;format=html">rctl(8)</a> system provides a more fine-grained way to set and manage resource limits for individual processes and users. It allows you to dynamically assign resource limits to specific processes or users, regardless of their user class.</p>
</div>
<div class="paragraph">
<p>The first step to use <a href="https://man.freebsd.org/cgi/man.cgi?query=rctl&amp;sektion=8&amp;format=html">rctl(8)</a> will be to enable it adding the following line to <span class="filename">/boot/loader.conf</span> and reboot the system:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>kern.racct.enable=1</pre>
</div>
</div>
<div class="paragraph">
<p>Then active the <a href="https://man.freebsd.org/cgi/man.cgi?query=rctl&amp;sektion=8&amp;format=html">rctl(8)</a> service and enable it executing by the following commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysrc rctl_enable=&#34;YES&#34;</span>
<span class="c"># service rctl start</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then <a href="https://man.freebsd.org/cgi/man.cgi?query=rctl&amp;sektion=8&amp;format=html">rctl(8)</a> may be used to set rules for the system.</p>
</div>
<div class="paragraph">
<p>Rule syntax (<a href="https://man.freebsd.org/cgi/man.cgi?query=rctl.conf&amp;sektion=5&amp;format=html">rctl.conf(5)</a>) is controlled through the use of a subject, subject-id, resource, and action, as seen in this example rule:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>subject:subject-id:resource:action=amount/per</pre>
</div>
</div>
<div class="paragraph">
<p>For example to constrained the user to add no more than 10 processes execute the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># rctl -a user:username:maxproc:deny=10/user</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To check the applied resource limits the <a href="https://man.freebsd.org/cgi/man.cgi?query=rctl&amp;sektion=8&amp;format=html">rctl(8)</a> command can be executed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># rctl</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should be similar to the following:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>user:username:maxproc:deny=10</pre>
</div>
</div>
<div class="paragraph">
<p>Rules will persist across reboots if they have been added to <span class="filename">/etc/rctl.conf</span>. The format is a rule, without the preceding command. For example, the previous rule could be added as:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>user:username:maxproc:deny=10</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="security-pkg">16.15. Monitoring Third Party Security Issues<a class="anchor" href="#security-pkg"></a></h3>
<div class="paragraph">
<p>In recent years, the security world has made many improvements to how vulnerability assessment is handled. The threat of system intrusion increases as third party utilities are installed and configured for virtually any operating system available today.</p>
</div>
<div class="paragraph">
<p>Vulnerability assessment is a key factor in security. While FreeBSD releases advisories for the base system, doing so for every third party utility is beyond the FreeBSD Project’s capability. There is a way to mitigate third party vulnerabilities and warn administrators of known security issues. A FreeBSD add on utility known as pkg includes options explicitly for this purpose.</p>
</div>
<div class="paragraph">
<p>pkg polls a database for security issues. The database is updated and maintained by the FreeBSD Security Team and ports developers.</p>
</div>
<div class="paragraph">
<p>Installation provides <a href="https://man.freebsd.org/cgi/man.cgi?query=periodic&amp;sektion=8&amp;format=html">periodic(8)</a> configuration files for maintaining the pkg audit database, and provides a programmatic method of keeping it updated.</p>
</div>
<div class="paragraph">
<p>After installation, and to audit third party utilities as part of the Ports Collection at any time, an administrator may choose to update the database and view known vulnerabilities of installed packages by invoking:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>pkg audit -F</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should be similar to the following:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>vulnxml file up-to-date
chromium-116.0.5845.96_1 is vulnerable:
  chromium -- multiple vulnerabilities
  CVE: CVE-2023-4431
  CVE: CVE-2023-4427
  CVE: CVE-2023-4428
  CVE: CVE-2023-4429
  CVE: CVE-2023-4430
  WWW: https://vuxml.FreeBSD.org/freebsd/5fa332b9-4269-11ee-8290-a8a1599412c6.html

samba413-4.13.17_5 is vulnerable:
  samba -- multiple vulnerabilities
  CVE: CVE-2023-3347
  CVE: CVE-2023-34966
  CVE: CVE-2023-34968
  CVE: CVE-2022-2127
  CVE: CVE-2023-34967
  WWW: https://vuxml.FreeBSD.org/freebsd/441e1e1a-27a5-11ee-a156-080027f5fec9.html

2 problem(s) in 2 installed package(s) found.</pre>
</div>
</div>
<div class="paragraph">
<p>By pointing a web browser to the displayed URL, an administrator may obtain more information about the vulnerability.</p>
</div>
<div class="paragraph">
<p>This will include the versions affected, by FreeBSD port version, along with other web sites which may contain security advisories.</p>
</div>
</div>
<div class="sect2">
<h3 id="security-advisories">16.16. FreeBSD Security Advisories<a class="anchor" href="#security-advisories"></a></h3>
<div class="paragraph">
<p>Like many producers of quality operating systems, the FreeBSD Project has a security team which is responsible for determining the End-of-Life (EoL) date for each FreeBSD release and to provide security updates for supported releases which have not yet reached their EoL. More information about the FreeBSD security team and the supported releases is available on the <a href="https://www.FreeBSD.org/security">FreeBSD security page</a>.</p>
</div>
<div class="paragraph">
<p>One task of the security team is to respond to reported security vulnerabilities in the FreeBSD operating system. Once a vulnerability is confirmed, the security team verifies the steps necessary to fix the vulnerability and updates the source code with the fix. It then publishes the details as a &#34;Security Advisory&#34;. Security advisories are published on the <a href="https://www.FreeBSD.org/security/advisories/">FreeBSD website</a> and mailed to the {freebsd-security-notifications}, {freebsd-security}, and {freebsd-announce}.</p>
</div>
<div class="sect3">
<h4 id="_format_of_a_security_advisory">16.16.1. Format of a Security Advisory<a class="anchor" href="#_format_of_a_security_advisory"></a></h4>
<div class="paragraph">
<p>Here is an example of a FreeBSD security advisory:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA512

=============================================================================
FreeBSD-SA-23:07.bhyve                                      Security Advisory
                                                          The FreeBSD Project

Topic:          bhyve privileged guest escape via fwctl

Category:       core
Module:         bhyve
Announced:      2023-08-01
Credits:        Omri Ben Bassat and Vladimir Eli Tokarev from Microsoft
Affects:        FreeBSD 13.1 and 13.2
Corrected:      2023-08-01 19:48:53 UTC (stable/13, 13.2-STABLE)
                2023-08-01 19:50:47 UTC (releng/13.2, 13.2-RELEASE-p2)
                2023-08-01 19:48:26 UTC (releng/13.1, 13.1-RELEASE-p9)
CVE Name:       CVE-2023-3494

For general information regarding FreeBSD Security Advisories,
including descriptions of the fields above, security branches, and the
following sections, please visit &lt;URL:https://security.FreeBSD.org/&gt;.

I.   Background

bhyve(8)&#39;s fwctl interface provides a mechanism through which guest
firmware can query the hypervisor for information about the virtual
machine.  The fwctl interface is available to guests when bhyve is run
with the &#34;-l bootrom&#34; option, used for example when booting guests in
UEFI mode.

bhyve is currently only supported on the amd64 platform.

II.  Problem Description

The fwctl driver implements a state machine which is executed when the
guest accesses certain x86 I/O ports.  The interface lets the guest copy
a string into a buffer resident in the bhyve process&#39; memory.  A bug in
the state machine implementation can result in a buffer overflowing when
copying this string.

III. Impact

A malicious, privileged software running in a guest VM can exploit the
buffer overflow to achieve code execution on the host in the bhyve
userspace process, which typically runs as root.  Note that bhyve runs
in a Capsicum sandbox, so malicious code is constrained by the
capabilities available to the bhyve process.

IV.  Workaround

No workaround is available.  bhyve guests that are executed without the
&#34;-l bootrom&#34; option are unaffected.

V.   Solution

Upgrade your vulnerable system to a supported FreeBSD stable or
release / security branch (releng) dated after the correction date.

Perform one of the following:

1) To update your vulnerable system via a binary patch:

Systems running a RELEASE version of FreeBSD on the amd64, i386, or
(on FreeBSD 13 and later) arm64 platforms can be updated via the
freebsd-update(8) utility:

# freebsd-update fetch
# freebsd-update install

Restart all affected virtual machines.

2) To update your vulnerable system via a source code patch:

The following patches have been verified to apply to the applicable
FreeBSD release branches.

a) Download the relevant patch from the location below, and verify the
detached PGP signature using your PGP utility.

[FreeBSD 13.2]
# fetch https://security.FreeBSD.org/patches/SA-23:07/bhyve.13.2.patch
# fetch https://security.FreeBSD.org/patches/SA-23:07/bhyve.13.2.patch.asc
# gpg --verify bhyve.13.2.patch.asc

[FreeBSD 13.1]
# fetch https://security.FreeBSD.org/patches/SA-23:07/bhyve.13.1.patch
# fetch https://security.FreeBSD.org/patches/SA-23:07/bhyve.13.1.patch.asc
# gpg --verify bhyve.13.1.patch.asc

b) Apply the patch.  Execute the following commands as root:

# cd /usr/src
# patch &lt; /path/to/patch

c) Recompile the operating system using buildworld and installworld as
described in &lt;URL:https://www.FreeBSD.org/handbook/makeworld.html&gt;.

Restart all affected virtual machines.

VI.  Correction details

This issue is corrected by the corresponding Git commit hash or Subversion
revision number in the following stable and release branches:

Branch/path                             Hash                     Revision
- -------------------------------------------------------------------------
stable/13/                              9fe302d78109    stable/13-n255918
releng/13.2/                            2bae613e0da3  releng/13.2-n254625
releng/13.1/                            87702e38a4b4  releng/13.1-n250190
- -------------------------------------------------------------------------

Run the following command to see which files were modified by a
particular commit:

# git show --stat &lt;commit hash&gt;

Or visit the following URL, replacing NNNNNN with the hash:

&lt;URL:https://cgit.freebsd.org/src/commit/?id=NNNNNN&gt;

To determine the commit count in a working tree (for comparison against
nNNNNNN in the table above), run:

# git rev-list --count --first-parent HEAD

VII. References

&lt;URL:https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2023-3494&gt;

The latest revision of this advisory is available at
&lt;URL:https://security.FreeBSD.org/advisories/FreeBSD-SA-23:07.bhyve.asc&gt;
-----BEGIN PGP SIGNATURE-----

iQIzBAEBCgAdFiEEthUnfoEIffdcgYM7bljekB8AGu8FAmTJdsIACgkQbljekB8A
Gu8Q1Q/7BFw5Aa0cFxBzbdz+O5NAImj58MvKS6xw61bXcYr12jchyT6ENC7yiR+K
qCqbe5TssRbtZ1gg/94gSGEXccz5OcJGxW+qozhcdPUh2L2nzBPkMCrclrYJfTtM
cnmQKjg/wFZLUVr71GEM95ZFaktlZdXyXx9Z8eBzow5rXexpl1TTHQQ2kZZ41K4K
KFhup91dzGCIj02cqbl+1h5BrXJe3s/oNJt5JKIh/GBh5THQu9n6AywQYl18HtjV
fMb1qRTAS9WbiEP5QV2eEuOG86ucuhytqnEN5MnXJ2rLSjfb9izs9HzLo3ggy7yb
hN3tlbfIPjMEwYexieuoyP3rzKkLeYfLXqJU4zKCRnIbBIkMRy4mcFkfcYmI+MhF
NPh2R9kccemppKXeDhKJurH0vsetr8ti+AwOZ3pgO21+9w+mjE+EfaedIi+JWhip
hwqeFv03bAQHJdacNYGV47NsJ91CY4ZgWC3ZOzBZ2Y5SDtKFjyc0bf83WTfU9A/0
drC0z3xaJribah9e6k5d7lmZ7L6aHCbQ70+aayuAEZQLr/N1doB0smNi0IHdrtY0
JdIqmVX+d1ihVhJ05prC460AS/Kolqiaysun1igxR+ZnctE9Xdo1BlLEbYu2KjT4
LpWvSuhRMSQaYkJU72SodQc0FM5mqqNN42Vx+X4EutOfvQuRGlI=
=MlAY
-----END PGP SIGNATURE-----</pre>
</div>
</div>
<div class="paragraph">
<p>Every security advisory uses the following format:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Each security advisory is signed by the PGP key of the Security Officer. The public key for the Security Officer can be verified at <a href="./#pgpkeys">OpenPGP Keys</a>.</p>
</li>
<li>
<p>The name of the security advisory always begins with <code>FreeBSD-SA-</code> (for FreeBSD Security Advisory), followed by the year in two digit format (<code>23:</code>), followed by the advisory number for that year (<code>07.</code>), followed by the name of the affected application or subsystem (<code>bhyve</code>).</p>
</li>
<li>
<p>The <code>Topic</code> field summarizes the vulnerability.</p>
</li>
<li>
<p>The <code>Category</code> refers to the affected part of the system which may be one of <code>core</code>, <code>contrib</code>, or <code>ports</code>. The <code>core</code> category means that the vulnerability affects a core component of the FreeBSD operating system. The <code>contrib</code> category means that the vulnerability affects software included with FreeBSD, such as BIND. The <code>ports</code> category indicates that the vulnerability affects software available through the Ports Collection.</p>
</li>
<li>
<p>The <code>Module</code> field refers to the component location. In this example, the <code>bhyve</code> module is affected; therefore, this vulnerability affects an application installed with the operating system.</p>
</li>
<li>
<p>The <code>Announced</code> field reflects the date the security advisory was published. This means that the security team has verified that the problem exists and that a patch has been committed to the FreeBSD source code repository.</p>
</li>
<li>
<p>The <code>Credits</code> field gives credit to the individual or organization who noticed the vulnerability and reported it.</p>
</li>
<li>
<p>The <code>Affects</code> field explains which releases of FreeBSD are affected by this vulnerability.</p>
</li>
<li>
<p>The <code>Corrected</code> field indicates the date, time, time offset, and releases that were corrected. The section in parentheses shows each branch for which the fix has been merged, and the version number of the corresponding release from that branch. The release identifier itself includes the version number and, if appropriate, the patch level. The patch level is the letter <code>p</code> followed by a number, indicating the sequence number of the patch, allowing users to track which patches have already been applied to the system.</p>
</li>
<li>
<p>The <code>CVE Name</code> field lists the advisory number, if one exists, in the public <a href="http://cve.mitre.org">cve.mitre.org</a> security vulnerabilities database.</p>
</li>
<li>
<p>The <code>Background</code> field provides a description of the affected module.</p>
</li>
<li>
<p>The <code>Problem Description</code> field explains the vulnerability. This can include information about the flawed code and how the utility could be maliciously used.</p>
</li>
<li>
<p>The <code>Impact</code> field describes what type of impact the problem could have on a system.</p>
</li>
<li>
<p>The <code>Workaround</code> field indicates if a workaround is available to system administrators who cannot immediately patch the system.</p>
</li>
<li>
<p>The <code>Solution</code> field provides the instructions for patching the affected system. This is a step by step tested and verified method for getting a system patched and working securely.</p>
</li>
<li>
<p>The <code>Correction Details</code> field displays each affected Subversion or Git branch with the revision number that contains the corrected code.</p>
</li>
<li>
<p>The <code>References</code> field offers sources of additional information regarding the vulnerability.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="jails">Chapter 17. Jails and Containers<a class="anchor" href="#jails"></a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="jails-synopsis">17.1. Synopsis<a class="anchor" href="#jails-synopsis"></a></h3>
<div class="paragraph">
<p>Since system administration is a difficult task, many tools have been developed to make life easier for the administrator. These tools often enhance the way systems are installed, configured, and maintained. One of the tools which can be used to enhance the security of a FreeBSD system is <em>jails</em>. Jails have been available since FreeBSD 4.X and continue to be enhanced in their usefulness, performance, reliability, and security.</p>
</div>
<div class="paragraph">
<p>Jails build upon the <a href="https://man.freebsd.org/cgi/man.cgi?query=chroot&amp;sektion=2&amp;format=html">chroot(2)</a> concept, which is used to change the root directory of a set of processes. This creates a safe environment, separate from the rest of the system. Processes created in the chrooted environment can not access files or resources outside of it. For that reason, compromising a service running in a chrooted environment should not allow the attacker to compromise the entire system.</p>
</div>
<div class="paragraph">
<p>However, a chroot has several limitations. It is suited to easy tasks which do not require much flexibility or complex, advanced features. Over time, many ways have been found to escape from a chrooted environment, making it a less than ideal solution for securing services.</p>
</div>
<div class="paragraph">
<p>Jails improve on the concept of the traditional chroot environment in several ways.</p>
</div>
<div class="paragraph">
<p>In a traditional chroot environment, processes are only limited in the part of the file system they can access. The rest of the system resources, system users, running processes, and the networking subsystem are shared by the chrooted processes and the processes of the host system. Jails expand this model by virtualizing access to the file system, the set of users, and the networking subsystem. More fine-grained controls are available for tuning the access of a jailed environment. Jails can be considered as a type of operating system-level virtualization.</p>
</div>
<div class="paragraph">
<p>This chapter covers:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>What a jail is and what purpose it may serve in FreeBSD installations.</p>
</li>
<li>
<p>The different types of jail.</p>
</li>
<li>
<p>The different ways to configure the network for a jail.</p>
</li>
<li>
<p>The jail configuration file.</p>
</li>
<li>
<p>How to create the different types of jail.</p>
</li>
<li>
<p>How to start, stop, and restart a jail.</p>
</li>
<li>
<p>The basics of jail administration, both from inside and outside the jail.</p>
</li>
<li>
<p>How to upgrade the different types of jail.</p>
</li>
<li>
<p>A incomplete list of the different FreeBSD jail managers.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="jail-types">17.2. Jail Types<a class="anchor" href="#jail-types"></a></h3>
<div class="paragraph">
<p>Some administrators divide jails into different types, although the underlying technology is the same. Each administrator will have to assess what type of jail to create in each case depending on the problem they have to solve.</p>
</div>
<div class="paragraph">
<p>Below can be found a list of the different types, their characteristics, and considerations for use.</p>
</div>
<div class="sect3">
<h4 id="thick-jails">17.2.1. Thick Jails<a class="anchor" href="#thick-jails"></a></h4>
<div class="paragraph">
<p>A thick jail is a traditional form of FreeBSD Jail. In a thick jail, a complete copy of the base system is replicated within the jail’s environment. This means that the jail has its own separate instance of the FreeBSD base system, including libraries, executables, and configuration files. The jail can be thought of as an almost complete standalone FreeBSD installation, but running within the confines of the host system. This isolation ensures that the processes within the jail are kept separate from those on the host and other jails.</p>
</div>
<div class="paragraph">
<p>Advantages of Thick Jails:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>High degree of isolation: Processes within the jail are isolated from the host system and other jails.</p>
</li>
<li>
<p>Independence: Thick jails can have different versions of libraries, configurations, and software than the host system or other jails.</p>
</li>
<li>
<p>Security: Since the jail contains its own base system, vulnerabilities or issues affecting the jail environment won’t directly impact the host or other jails.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Disadvantages of Thick Jails:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Resource overhead: Because each jail maintains its own separate base system, thick jails consume more resources compared to thin jails.</p>
</li>
<li>
<p>Maintenance: Each jail requires its own maintenance and updates for its base system components.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="thin-jails">17.2.2. Thin Jails<a class="anchor" href="#thin-jails"></a></h4>
<div class="paragraph">
<p>A thin jail shares the base system using OpenZFS snapshots or NullFS mounts from a template. Only a minimal subset of base system is duplicated for each thin jail, resulting in less resource consumption compared to a thick jail. However, this also means that thin jails have less isolation and independence compared to thick jails. Changes in shared components could potentially affect multiple thin jails simultaneously.</p>
</div>
<div class="paragraph">
<p>In summary, a FreeBSD Thin Jail is a type of FreeBSD Jail that replicates a substantial portion, but not all, of the base system within the isolated environment.</p>
</div>
<div class="paragraph">
<p>Advantages of Thin Jails:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Resource Efficiency: Thin jails are more resource-efficient compared to thick jails. Since they share most of the base system, they consume less disk space and memory. This makes it possible to run more jails on the same hardware without consuming excessive resources.</p>
</li>
<li>
<p>Faster Deployment: Creating and launching thin jails is generally faster compared to thick jails. This can be particularly advantageous when you need to rapidly deploy multiple instances.</p>
</li>
<li>
<p>Unified Maintenance: Since thin jails share the majority of their base system with the host system, updates and maintenance of common base system components (such as libraries and binaries) only need to be done once on the host. This simplifies the maintenance process compared to maintaining an individual base system for each thick jail.</p>
</li>
<li>
<p>Shared Resources: Thin jails can more easily share common resources such as libraries and binaries with the host system. This can potentially lead to more efficient disk caching and improved performance for applications within the jail.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Disadvantages of Thin Jails:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Reduced Isolation: The primary disadvantage of thin jails is that they offer less isolation compared to thick jails. Since they share a significant portion of the template’s base system, vulnerabilities or issues affecting shared components could potentially impact multiple jails simultaneously.</p>
</li>
<li>
<p>Security Concerns: The reduced isolation in thin jails could pose security risks, as a compromise in one jail might have a greater potential to affect other jails or the host system.</p>
</li>
<li>
<p>Dependency Conflicts: If multiple thin jails require different versions of the same libraries or software, managing dependencies can become complex. In some cases, this might require additional effort to ensure compatibility.</p>
</li>
<li>
<p>Compatibility Challenges: Applications within a thin jail might encounter compatibility issues if they assume a certain base system environment that differs from the shared components provided by the template.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="vnet-jails">17.2.3. VNET Jails<a class="anchor" href="#vnet-jails"></a></h4>
<div class="paragraph">
<p>A FreeBSD VNET jail is a virtualized environment that allows for the isolation and control of network resources for processes running within it. It provides a high level of network segmentation and security by creating a separate network stack for processes within the jail, ensuring that network traffic within the jail is isolated from the host system and other jails.</p>
</div>
<div class="paragraph">
<p>In essence, FreeBSD VNET jails add a network configuration mechanism. This means a VNET jail can be created as a Thick or Thin Jail.</p>
</div>
</div>
<div class="sect3">
<h4 id="linux-jails">17.2.4. Linux Jails<a class="anchor" href="#linux-jails"></a></h4>
<div class="paragraph">
<p>A FreeBSD Linux Jail is a feature in the FreeBSD operating system that enables the use of Linux binaries and applications within a FreeBSD jail. This functionality is achieved by incorporating a compatibility layer that allows certain Linux system calls and libraries to be translated and executed on the FreeBSD kernel. The purpose of a Linux Jail is to facilitate the execution of Linux software on a FreeBSD system without needing a separate Linux virtual machine or environment.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="host-configuration">17.3. Host Configuration<a class="anchor" href="#host-configuration"></a></h3>
<div class="paragraph">
<p>Before creating any jail on the host system it is necessary to perform certain configuration and obtain some information from the host system.</p>
</div>
<div class="paragraph">
<p>It will be necessary to configure the <a href="https://man.freebsd.org/cgi/man.cgi?query=jail&amp;sektion=8&amp;format=html">jail(8)</a> utility, create the necessary directories to configure and install jails, obtain information from the host’s network, and check whether the host uses OpenZFS or UFS as its file system.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The FreeBSD version running in the jail can not be newer than the version running in the host.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="sect3">
<h4 id="host-configuration-jail-utility">17.3.1. Jail Utility<a class="anchor" href="#host-configuration-jail-utility"></a></h4>
<div class="paragraph">
<p>The <a href="https://man.freebsd.org/cgi/man.cgi?query=jail&amp;sektion=8&amp;format=html">jail(8)</a> utility manages jails.</p>
</div>
<div class="paragraph">
<p>To start jails when the system boots, run the following commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysrc jail_enable=&#34;YES&#34;</span>
<span class="c"># sysrc jail_parallel_start=&#34;YES&#34;</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>With <code>jail_parallel_start</code>, all configured jails will be started in the background.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect3">
<h4 id="jails-networking">17.3.2. Networking<a class="anchor" href="#jails-networking"></a></h4>
<div class="paragraph">
<p>Networking for FreeBSD jails can be configured several different ways:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Host Networking Mode (IP Sharing)</dt>
<dd>
<p>In host networking mode, a jail shares the same networking stack as the host system. When a jail is created in host networking mode it uses the same network interface and IP address. This means that the jail doesn’t have a separate IP address, and its network traffic is associated with the host’s IP.</p>
</dd>
<dt class="hdlist1">Virtual Networks (VNET)</dt>
<dd>
<p>Virtual Networks are a feature of FreeBSD jails that offer more advanced and flexible networking solutions than a basic networking mode like host networking. VNET allows the creation of isolated network stacks for each jail, providing them with their own separate IP addresses, routing tables, and network interfaces. This offers a higher level of network isolation and allows jails to function as if they are running on separate virtual machines.</p>
</dd>
<dt class="hdlist1">The netgraph system</dt>
<dd>
<p><a href="https://man.freebsd.org/cgi/man.cgi?query=netgraph&amp;sektion=4&amp;format=html">netgraph(4)</a> is a versatile kernel framework for creating custom network configurations. It can be used to define how network traffic flows between jails and the host system and between different jails.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="host-configuration-directories">17.3.3. Setting Up the Jail Directory Tree<a class="anchor" href="#host-configuration-directories"></a></h4>
<div class="paragraph">
<p>There is no specific place to put the files for the jails.</p>
</div>
<div class="paragraph">
<p>Some administrators use <span class="filename">/jail</span>, others <span class="filename">/usr/jail</span>, and still others <span class="filename">/usr/local/jails</span>. In this chapter <span class="filename">/usr/local/jails</span> will be used.</p>
</div>
<div class="paragraph">
<p>Apart from <span class="filename">/usr/local/jails</span> other directories will be created:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="filename">media</span> will contain the compressed files of the downloaded userlands.</p>
</li>
<li>
<p><span class="filename">templates</span> will contain the templates when using Thin Jails.</p>
</li>
<li>
<p><span class="filename">containers</span> will contain the jails.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When using OpenZFS, execute the following commands to create datasets for these directories:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zfs create -o mountpoint=/usr/local/jails zroot/jails</span>
<span class="c"># zfs create zroot/jails/media</span>
<span class="c"># zfs create zroot/jails/templates</span>
<span class="c"># zfs create zroot/jails/containers</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In this case, <code>zroot</code> was used for the parent dataset, but other datasets could have been used.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>When using UFS, execute the following commands to create the directories:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># mkdir /usr/local/jails/</span>
<span class="c"># mkdir /usr/local/jails/media</span>
<span class="c"># mkdir /usr/local/jails/templates</span>
<span class="c"># mkdir /usr/local/jails/containers</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="jail-configuration-files">17.3.4. Jail Configuration Files<a class="anchor" href="#jail-configuration-files"></a></h4>
<div class="paragraph">
<p>There are two ways to configure jails.</p>
</div>
<div class="paragraph">
<p>The first one is to add an entry for each jail to the file <span class="filename">/etc/jail.conf</span>. The other option is to create a file for each jail in the directory <span class="filename">/etc/jail.conf.d/</span>.</p>
</div>
<div class="paragraph">
<p>There is no right or wrong option. Each administrator must choose the one that best suits their needs.</p>
</div>
<div class="paragraph">
<p>In case a host system has few jails, an entry for each jail can be added in the file <span class="filename">/etc/jail.conf</span>. If the host system has many jails, it is good idea to have one configuration file for each jail in the <span class="filename">/etc/jail.conf.d/</span> directory.</p>
</div>
<div class="paragraph">
<p>A typical jail entry would look like this:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>jailname { <i class="conum" data-value="1"></i><b>(1)</b>
  # STARTUP/LOGGING
  exec.start = &#34;/bin/sh /etc/rc&#34;; <i class="conum" data-value="2"></i><b>(2)</b>
  exec.stop = &#34;/bin/sh /etc/rc.shutdown&#34;; <i class="conum" data-value="3"></i><b>(3)</b>
  exec.consolelog = &#34;/var/log/jail_console_${name}.log&#34;; <i class="conum" data-value="4"></i><b>(4)</b>

  # PERMISSIONS
  allow.raw_sockets; <i class="conum" data-value="5"></i><b>(5)</b>
  exec.clean; <i class="conum" data-value="6"></i><b>(6)</b>
  mount.devfs; <i class="conum" data-value="7"></i><b>(7)</b>

  # HOSTNAME/PATH
  host.hostname = &#34;${name}&#34;; <i class="conum" data-value="8"></i><b>(8)</b>
  path = &#34;/usr/local/jails/containers/${name}&#34;; <i class="conum" data-value="9"></i><b>(9)</b>

  # NETWORK
  ip4.addr = 192.168.1.151; <i class="conum" data-value="10"></i><b>(10)</b>
  ip6.addr = ::ffff:c0a8:197 <i class="conum" data-value="11"></i><b>(11)</b>
  interface = em0; <i class="conum" data-value="12"></i><b>(12)</b>
}</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>jailname</code> - Name of the jail. &lt;.&gt; <code>exec.start</code> - Command(s) to run in the jail environment when a jail is created. A typical command to run is &#34;/bin/sh /etc/rc&#34;. &lt;.&gt; <code>exec.stop</code> - Command(s) to run in the jail environment before a jail is removed. A typical command to run is &#34;/bin/sh /etc/rc.shutdown&#34;. &lt;.&gt; <code>exec.consolelog</code> - A file to direct command output (stdout and stderr) to. &lt;.&gt; <code>allow.raw_sockets</code> - Allow creating raw sockets inside the jail. Setting this parameter allows utilities like <a href="https://man.freebsd.org/cgi/man.cgi?query=ping&amp;sektion=8&amp;format=html">ping(8)</a> and <a href="https://man.freebsd.org/cgi/man.cgi?query=traceroute&amp;sektion=8&amp;format=html">traceroute(8)</a> to operate inside the jail. &lt;.&gt; <code>exec.clean</code> - Run commands in a clean environment. &lt;.&gt; <code>mount.devfs</code> - Mount a <a href="https://man.freebsd.org/cgi/man.cgi?query=devfs&amp;sektion=5&amp;format=html">devfs(5)</a> filesystem on the chrooted <span class="filename">/dev</span> directory, and apply the ruleset in the devfs_ruleset parameter to restrict the devices visible inside the jail. &lt;.&gt; <code>host.hostname</code> - The hostname of the jail. &lt;.&gt; <code>path</code> - The directory which is to be the root of the jail. Any commands that are run inside the jail, either by jail or from <a href="https://man.freebsd.org/cgi/man.cgi?query=jexec&amp;sektion=8&amp;format=html">jexec(8)</a>, are run from this directory. &lt;.&gt; <code>ip4.addr</code> - IPv4 address. There are two configuration possibilities for IPv4. The first is to establish an IP or a list of IPs as has been done in the example. The other is to use <code>ip4</code> instead and set the <code>inherit</code> value to inherit the host’s IP address. &lt;.&gt; <code>ip6.addr</code> - IPv6 address. There are two configuration possibilities for IPv6. The first is to establish an IP or a list of IPs as has been done in the example. The other is to use <code>ip6</code> instead and set the <code>inherit</code> value to inherit the host’s IP address. &lt;.&gt; <code>interface</code> - A network interface to add the jail’s IP addresses. Usually the host interface.</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>More information about configuration variables can be found in <a href="https://man.freebsd.org/cgi/man.cgi?query=jail&amp;sektion=8&amp;format=html">jail(8)</a> and <a href="https://man.freebsd.org/cgi/man.cgi?query=jail.conf&amp;sektion=5&amp;format=html">jail.conf(5)</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="classic-jail">17.4. Classic Jail (Thick Jail)<a class="anchor" href="#classic-jail"></a></h3>
<div class="paragraph">
<p>These jails resemble a real FreeBSD system. They can be managed more or less like a normal host system and updated independently.</p>
</div>
<div class="sect3">
<h4 id="creating-classic-jail">17.4.1. Creating a Classic Jail<a class="anchor" href="#creating-classic-jail"></a></h4>
<div class="paragraph">
<p>In principle, a jail only needs a hostname, a root directory, an IP address, and a userland.</p>
</div>
<div class="paragraph">
<p>The userland for the jail can be obtained from the official FreeBSD download servers.</p>
</div>
<div class="paragraph">
<p>Execute the following command to download the userland:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># fetch https://download.freebsd.org/ftp/releases/amd64/amd64/13.2-RELEASE/base.txz -o /usr/local/jails/media/13.2-RELEASE-base.txz</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Once the download is complete, it will be necessary to extract the contents into the jail directory.</p>
</div>
<div class="paragraph">
<p>Execute the following commands to extract the userland into the jail’s directory:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># mkdir -p /usr/local/jails/containers/classic</span>
<span class="c"># tar -xf /usr/local/jails/media/13.2-RELEASE-base.txz -C /usr/local/jails/containers/classic --unlink</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>With the userland extracted in the jail directory, it will be necessary to copy the timezone and DNS server files:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># cp /etc/resolv.conf /usr/local/jails/containers/classic/etc/resolv.conf</span>
<span class="c"># cp /etc/localtime /usr/local/jails/containers/classic/etc/localtime</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>With the files copied, the next thing to do is update to the latest patch level by executing the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># freebsd-update -b /usr/local/jails/containers/classic/ fetch install</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The last step is to configure the jail. It will be necessary to add an entry to the configuration file <span class="filename">/etc/jail.conf</span> or in <span class="filename">jail.conf.d</span> with the parameters of the jail.</p>
</div>
<div class="paragraph">
<p>An example would be the following:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>classic {
  # STARTUP/LOGGING
  exec.start = &#34;/bin/sh /etc/rc&#34;;
  exec.stop = &#34;/bin/sh /etc/rc.shutdown&#34;;
  exec.consolelog = &#34;/var/log/jail_console_${name}.log&#34;;

  # PERMISSIONS
  allow.raw_sockets;
  exec.clean;
  mount.devfs;

  # HOSTNAME/PATH
  host.hostname = &#34;${name}&#34;;
  path = &#34;/usr/local/jails/containers/${name}&#34;;

  # NETWORK
  ip4.addr = 192.168.1.151;
  interface = em0;
}</pre>
</div>
</div>
<div class="paragraph">
<p>Execute the following command to start the jail:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># service jail start classic</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>More information on how to manage jails can be found in the section <a href="#jail-management">Jail Management</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="thin-jail">17.5. Thin Jails<a class="anchor" href="#thin-jail"></a></h3>
<div class="paragraph">
<p>Although Thin Jails use the same technology as Thick Jails, the creation procedure is different. Thin jails can be created using OpenZFS snapshots or using templates and NullFS. The use of OpenZFS snapshots and templates using NullFS have certain advantages over classic jails, such as being able to create them faster from snapshots or being able to update multiple jails using NullFS.</p>
</div>
<div class="sect3">
<h4 id="creating-thin-jail-openzfs-snapshots">17.5.1. Creating a Thin Jail Using OpenZFS Snapshots<a class="anchor" href="#creating-thin-jail-openzfs-snapshots"></a></h4>
<div class="paragraph">
<p>Due to the good integration between FreeBSD and OpenZFS it is very easy to create new Thin Jails using OpenZFS Snapshots.</p>
</div>
<div class="paragraph">
<p>To create a Thin Jail using OpenZFS Snapshots the first step is to create a template.</p>
</div>
<div class="paragraph">
<p>Templates will only be used to create new jails. For this reason they are created in &#34;read-only&#34; mode so that jails are created with an immutable base.</p>
</div>
<div class="paragraph">
<p>To create the dataset for the template, execute the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zfs create -p zroot/jails/templates/13.2-RELEASE</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then execute the following command to download the userland:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># fetch https://download.freebsd.org/ftp/releases/amd64/amd64/13.2-RELEASE/base.txz -o /usr/local/jails/media/13.2-RELEASE-base.txz</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Once the download is complete, it will be necessary to extract the contents in the template directory by executing the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># tar -xf /usr/local/jails/media/13.2-RELEASE-base.txz -C /usr/local/jails/templates/13.2-RELEASE --unlink</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>With the userland extracted in the templates directory, it will be necessary to copy the timezone and DNS server files to the template directory by executing the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># cp /etc/resolv.conf /usr/local/jails/templates/13.2-RELEASE/etc/resolv.conf</span>
<span class="c"># cp /etc/localtime /usr/local/jails/templates/13.2-RELEASE/etc/localtime</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The next thing to do is update to the latest patch level by executing the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># freebsd-update -b /usr/local/jails/templates/13.2-RELEASE/ fetch install</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Once the update is finished, the template is ready.</p>
</div>
<div class="paragraph">
<p>To create an OpenZFS Snapshot from the template, execute the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zfs snapshot zroot/jails/templates/13.2-RELEASE@base</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Once the OpenZFS Snapshot has been created, infinite jails can be created using the OpenZFS clone function.</p>
</div>
<div class="paragraph">
<p>To create a Thin Jail named <code>thinjail</code>, execute the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zfs clone zroot/jails/templates/13.2-RELEASE@base zroot/jails/containers/thinjail</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The last step is to configure the jail. It will be necessary to add an entry to the configuration file <span class="filename">/etc/jail.conf</span> or in <span class="filename">jail.conf.d</span> with the parameters of the jail.</p>
</div>
<div class="paragraph">
<p>An example would be the following:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>thinjail {
  # STARTUP/LOGGING
  exec.start = &#34;/bin/sh /etc/rc&#34;;
  exec.stop = &#34;/bin/sh /etc/rc.shutdown&#34;;
  exec.consolelog = &#34;/var/log/jail_console_${name}.log&#34;;

  # PERMISSIONS
  allow.raw_sockets;
  exec.clean;
  mount.devfs;

  # HOSTNAME/PATH
  host.hostname = &#34;${name}&#34;;
  path = &#34;/usr/local/jails/containers/${name}&#34;;

  # NETWORK
  ip4 = inherit;
  interface = em0;
}</pre>
</div>
</div>
<div class="paragraph">
<p>Execute the following command to start the jail:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># service jail start thinjail</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>More information on how to manage jails can be found in the section <a href="#jail-management">Jail Management</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="creating-thin-jail-nullfs">17.5.2. Creating a Thin Jail Using NullFS<a class="anchor" href="#creating-thin-jail-nullfs"></a></h4>
<div class="paragraph">
<p>A jail can be created with reduced duplication of system files by using the Thin Jail technique and using NullFS to selectively share specific directories from the host system into the jail.</p>
</div>
<div class="paragraph">
<p>The first step is to create the dataset to save the template, execute the following command if using OpenZFS:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zfs create -p zroot/jails/templates/13.2-RELEASE-base</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Or this one if using UFS:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># mkdir /usr/local/jails/templates/13.2-RELEASE-base</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then execute the following command to download the userland:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># fetch https://download.freebsd.org/ftp/releases/amd64/amd64/13.2-RELEASE/base.txz -o /usr/local/jails/media/13.2-RELEASE-base.txz</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Once the download is complete, it will be necessary to extract the contents in the template directory by executing the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># tar -xf /usr/local/jails/media/13.2-RELEASE-base.txz -C /usr/local/jails/templates/13.2-RELEASE-base --unlink</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Once the userland is extracted in the templates directory, it will be necessary to copy the timezone and DNS server files to the template directory by executing the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># cp /etc/resolv.conf /usr/local/jails/templates/13.2-RELEASE-base/etc/resolv.conf</span>
<span class="c"># cp /etc/localtime /usr/local/jails/templates/13.2-RELEASE-base/etc/localtime</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>With the files moved to the template, the next thing to do is update to the latest patch level by executing the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># freebsd-update -b /usr/local/jails/templates/13.2-RELEASE-base/ fetch install</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In addition to the base template, it is also necessary to create a directory where the <code>skeleton</code> will be located. Some directories will be copied from the template to the <code>skeleton</code>.</p>
</div>
<div class="paragraph">
<p>Execute the following command to create the dataset for the <code>skeleton</code> in case of using OpenZFS:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zfs create -p zroot/jails/templates/13.2-RELEASE-skeleton</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Or this one in case of using UFS:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># mkdir /usr/local/jails/templates/13.2-RELEASE-skeleton</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then create the <code>skeleton</code> directories. The <code>skeleton</code> directories will hold the local directories of the jails.</p>
</div>
<div class="paragraph">
<p>Execute the following commands to create the directories:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># mkdir -p /usr/local/jails/templates/13.2-RELEASE-skeleton/home</span>
<span class="c"># mkdir -p /usr/local/jails/templates/13.2-RELEASE-skeleton/usr</span>
<span class="c"># mv /usr/local/jails/templates/13.2-RELEASE-base/etc /usr/local/jails/templates/13.2-RELEASE-skeleton/etc</span>
<span class="c"># mv /usr/local/jails/templates/13.2-RELEASE-base/usr/local /usr/local/jails/templates/13.2-RELEASE-skeleton/usr/local</span>
<span class="c"># mv /usr/local/jails/templates/13.2-RELEASE-base/tmp /usr/local/jails/templates/13.2-RELEASE-skeleton/tmp</span>
<span class="c"># mv /usr/local/jails/templates/13.2-RELEASE-base/var /usr/local/jails/templates/13.2-RELEASE-skeleton/var</span>
<span class="c"># mv /usr/local/jails/templates/13.2-RELEASE-base/root /usr/local/jails/templates/13.2-RELEASE-skeleton/root</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The next step is to create the symlinks to the <code>skeleton</code> by executing the following commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># cd /usr/local/jails/templates/13.2-RELEASE-base/</span>
<span class="c"># mkdir skeleton</span>
<span class="c"># ln -s skeleton/etc etc</span>
<span class="c"># ln -s skeleton/home home</span>
<span class="c"># ln -s skeleton/root root</span>
<span class="c"># ln -s skeleton/usr/local usr/local</span>
<span class="c"># ln -s skeleton/tmp tmp</span>
<span class="c"># ln -s skeleton/var var</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>With the <code>skeleton</code> ready, it will be necessary to copy the data to the jail directory.</p>
</div>
<div class="paragraph">
<p>In case of using OpenZFS, OpenZFS snapshots can be used to easily create as many jails as necessary by executing the following commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zfs snapshot zroot/jails/templates/13.2-RELEASE-skeleton@base</span>
<span class="c"># zfs clone zroot/jails/templates/13.2-RELEASE-skeleton@base zroot/jails/containers/thinjail</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In case of using UFS the <a href="https://man.freebsd.org/cgi/man.cgi?query=cp&amp;sektion=1&amp;format=html">cp(1)</a> program can be used by executing the following commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># mkdir /usr/local/jails/containers/thinjail</span>
<span class="c"># cp -R /usr/local/jails/templates/13.2-RELEASE-skeleton /usr/local/jails/containers/thinjail</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then create the directory in which the base template and the skeleton will be mounted:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># mkdir -p /usr/local/jails/thinjail-nullfs-base</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Add a jail entry in <span class="filename">/etc/jail.conf</span> or a file in <span class="filename">jail.conf.d</span> as follows:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>thinjail {
  # STARTUP/LOGGING
  exec.start = &#34;/bin/sh /etc/rc&#34;;
  exec.stop = &#34;/bin/sh /etc/rc.shutdown&#34;;
  exec.consolelog = &#34;/var/log/jail_console_${name}.log&#34;;

  # PERMISSIONS
  allow.raw_sockets;
  exec.clean;
  mount.devfs;

  # HOSTNAME/PATH
  host.hostname = &#34;${name}&#34;;
  path = &#34;/usr/local/jails/containers/${name}&#34;;

  # NETWORK
  ip4.addr = 192.168.1.153;
  interface = em0;

  # MOUNT
  mount.fstab = &#34;/usr/local/jails/thinjail-nullfs-base.fstab&#34;;
}</pre>
</div>
</div>
<div class="paragraph">
<p>Then the create the <span class="filename">/usr/local/jails/thinjail-nullfs-base.fstab</span> file as follows:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>/usr/local/jails/templates/13.2-RELEASE-base  /usr/local/jails/thinjail-nullfs-base/ nullfs   ro          0 0
/usr/local/jails/containers/thinjail     /usr/local/jails/thinjail-nullfs-base/skeleton nullfs  rw  0 0</pre>
</div>
</div>
<div class="paragraph">
<p>Execute the following command to start the jail:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># service jail start thinjail</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="creating-vnet-jail">17.5.3. Creating a VNET Jail<a class="anchor" href="#creating-vnet-jail"></a></h4>
<div class="paragraph">
<p>FreeBSD VNET Jails have their own distinct networking stack, including interfaces, IP addresses, routing tables, and firewall rules.</p>
</div>
<div class="paragraph">
<p>The first step to create a VNET jail is to create the <a href="https://man.freebsd.org/cgi/man.cgi?query=bridge&amp;sektion=4&amp;format=html">bridge(4)</a> by executing the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ifconfig bridge create</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should be similar to the following:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>bridge0</pre>
</div>
</div>
<div class="paragraph">
<p>With the <code>bridge</code> created, it will be necessary to attach it to the <code>em0</code> interface by executing the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ifconfig bridge0 addm em0</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To make this setting persist across reboots, add the following lines to <span class="filename">/etc/rc.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>defaultrouter=&#34;192.168.1.1&#34;
cloned_interfaces=&#34;bridge0&#34;
ifconfig_bridge0=&#34;inet 192.168.1.150/24 addm em0 up&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>The next step is to create the jail as indicated above.</p>
</div>
<div class="paragraph">
<p>Either the <a href="#classic-jail">Classic Jail (Thick Jail)</a> procedure and the <a href="#thin-jail">Thin Jails</a> procedure can be used. The only thing that will change is the configuration in the <span class="filename">/etc/jail.conf</span> file.</p>
</div>
<div class="paragraph">
<p>The path <span class="filename">/usr/local/jails/containers/vnet</span> will be used as an example for the created jail.</p>
</div>
<div class="paragraph">
<p>The following is an example configuration for a VNET jail:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>vnet {
  # STARTUP/LOGGING
  exec.start = &#34;/bin/sh /etc/rc&#34;;
  exec.stop  = &#34;/bin/sh /etc/rc.shutdown&#34;;
  exec.consolelog = &#34;/var/log/jail_console_${name}.log&#34;;

  # PERMISSIONS
  allow.raw_sockets;
  exec.clean;
  mount.devfs;
  devfs_ruleset = 5;

  # PATH/HOSTNAME
  path = &#34;/usr/local/jails/containers/${name}&#34;;
  host.hostname = &#34;${name}&#34;;

  # VNET/VIMAGE
  vnet;
  vnet.interface = &#34;${epair}b&#34;;

  # NETWORKS/INTERFACES
  $id = &#34;154&#34;; <i class="conum" data-value="1"></i><b>(1)</b>
  $ip = &#34;192.168.1.${id}/24&#34;;
  $gateway = &#34;192.168.1.1&#34;;
  $bridge = &#34;bridge0&#34;; <i class="conum" data-value="2"></i><b>(2)</b>
  $epair = &#34;epair${id}&#34;;

  # ADD TO bridge INTERFACE
  exec.prestart += &#34;ifconfig ${epair} create up&#34;;
  exec.prestart += &#34;ifconfig ${epair}a up descr jail:${name}&#34;;
  exec.prestart += &#34;ifconfig ${bridge} addm ${epair}a up&#34;;
  exec.start    += &#34;ifconfig ${epair}b ${ip} up&#34;;
  exec.start    += &#34;route add default ${gateway}&#34;;
  exec.poststop = &#34;ifconfig ${bridge} deletem ${epair}a&#34;;
  exec.poststop += &#34;ifconfig ${epair}a destroy&#34;;
}</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Represents the IP of the Jail, it must be <strong>unique</strong>. &lt;.&gt; Refers to the bridge created previously.</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect3">
<h4 id="creating-linux-jail">17.5.4. Creating a Linux Jail<a class="anchor" href="#creating-linux-jail"></a></h4>
<div class="paragraph">
<p>FreeBSD can run Linux inside a jail using <a href="./#linuxemu">Linux Binary Compatibility</a> and <a href="https://man.freebsd.org/cgi/man.cgi?query=debootstrap&amp;sektion=8&amp;format=html">debootstrap(8)</a>. Jails do not have a kernel. They run on the host’s kernel. Therefore it is necessary to enable Linux Binary Compatibility in the host system.</p>
</div>
<div class="paragraph">
<p>To enable the Linux ABI at boot time, execute the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysrc linux_enable=&#34;YES&#34;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Once enabled, it can be started without rebooting by executing the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># service linux start</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The next step will be to create a jail as indicated above, for example in <a href="#creating-thin-jail-openzfs-snapshots">Creating a Thin Jail Using OpenZFS Snapshots</a>, but <strong>without</strong> performing the configuration. FreeBSD Linux jails require a specific configuration that will be detailed below.</p>
</div>
<div class="paragraph">
<p>Once the jail has been created as explained above, execute the following command to perform required configuration for the jail and start it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># jail -cm \</span>
    <span class="nv">name</span><span class="o">=</span>ubuntu <span class="se">\</span>
    host.hostname<span class="o">=</span><span class="s2">&#34;ubuntu.example.com&#34;</span> <span class="se">\</span>
    <span class="nv">path</span><span class="o">=</span><span class="s2">&#34;/usr/local/jails/ubuntu&#34;</span> <span class="se">\</span>
    <span class="nv">interface</span><span class="o">=</span><span class="s2">&#34;em0&#34;</span> <span class="se">\</span>
    ip4.addr<span class="o">=</span><span class="s2">&#34;192.168.1.150&#34;</span> <span class="se">\</span>
    exec.start<span class="o">=</span><span class="s2">&#34;/bin/sh /etc/rc&#34;</span> <span class="se">\</span>
    exec.stop<span class="o">=</span><span class="s2">&#34;/bin/sh /etc/rc.shutdown&#34;</span> <span class="se">\</span>
    mount.devfs <span class="se">\</span>
    <span class="nv">devfs_ruleset</span><span class="o">=</span>4 <span class="se">\</span>
    allow.mount <span class="se">\</span>
    allow.mount.devfs <span class="se">\</span>
    allow.mount.fdescfs <span class="se">\</span>
    allow.mount.procfs <span class="se">\</span>
    allow.mount.linprocfs <span class="se">\</span>
    allow.mount.linsysfs <span class="se">\</span>
    allow.mount.tmpfs <span class="se">\</span>
    <span class="nv">enforce_statfs</span><span class="o">=</span>1</code></pre>
</div>
</div>
<div class="paragraph">
<p>To access the jail, it will be necessary to install <a class="package" href="https://cgit.freebsd.org/ports/tree/sysutils/debootstrap/">sysutils/debootstrap</a>.</p>
</div>
<div class="paragraph">
<p>Execute the following command to access the FreeBSD Linux jail:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># jexec -u root ubuntu</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Inside the jail, execute the following commands to install <a class="package" href="https://cgit.freebsd.org/ports/tree/sysutils/debootstrap/">sysutils/debootstrap</a> and prepare the Ubuntu environment:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install debootstrap</span>
<span class="c"># debootstrap jammy /compat/ubuntu</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When the process has finished and the message <code>Base system installed successfully</code> is displayed on the console, it will be necessary to stop the jail from the host system by executing the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># service jail ubuntu onestop</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then add an entry in <span class="filename">/etc/jail.conf</span> for the Linux jail:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>ubuntu {
  # STARTUP/LOGGING
  exec.start = &#34;/bin/sh /etc/rc&#34;;
  exec.stop = &#34;/bin/sh /etc/rc.shutdown&#34;;
  exec.consolelog = &#34;/var/log/jail_console_${name}.log&#34;;

  # PERMISSIONS
  allow.raw_sockets;
  exec.clean;
  mount.devfs;
  devfs_ruleset=4;

  # HOSTNAME/PATH
  host.hostname = &#34;${name}&#34;;
  path = &#34;/usr/local/jails/containers/${name}&#34;;

  # NETWORK
  ip4.addr = 192.168.1.155;
  interface = em0;

  # MOUNT
  mount += &#34;devfs     $path/compat/ubuntu/dev     devfs     rw  0 0&#34;;
  mount += &#34;tmpfs     $path/compat/ubuntu/dev/shm tmpfs     rw,size=1g,mode=1777  0 0&#34;;
  mount += &#34;fdescfs   $path/compat/ubuntu/dev/fd  fdescfs   rw,linrdlnk 0 0&#34;;
  mount += &#34;linprocfs $path/compat/ubuntu/proc    linprocfs rw  0 0&#34;;
  mount += &#34;linsysfs  $path/compat/ubuntu/sys     linsysfs  rw  0 0&#34;;
  mount += &#34;/tmp      $path/compat/ubuntu/tmp     nullfs    rw  0 0&#34;;
  mount += &#34;/home     $path/compat/ubuntu/home    nullfs    rw  0 0&#34;;
}</pre>
</div>
</div>
<div class="paragraph">
<p>Then the jail can be started as usual with the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># service jail start ubuntu</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The Ubuntu environment can be accessed using the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># jexec ubuntu chroot /compat/ubuntu /bin/bash</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>More information can be found in the chapter <a href="./#linuxemu">Linux Binary Compatibility</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="jail-management">17.6. Jail Management<a class="anchor" href="#jail-management"></a></h3>
<div class="paragraph">
<p>Once the jail is created, there are a number of operations that can be performed, like starting, rebooting or deleting the jail, installing software in it, etc. In this section the different actions that can be done with jails from the host will be described.</p>
</div>
<div class="sect3">
<h4 id="list-running-jails">17.6.1. List Running Jails<a class="anchor" href="#list-running-jails"></a></h4>
<div class="paragraph">
<p>To list the jails that are running on the host system, the command <a href="https://man.freebsd.org/cgi/man.cgi?query=jls&amp;sektion=8&amp;format=html">jls(8)</a> can be used:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># jls</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should be similar to the following:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>   JID  IP Address      Hostname                      Path
     1  192.168.250.70  classic                       /usr/local/jails/containers/classic</pre>
</div>
</div>
<div class="paragraph">
<p><a href="https://man.freebsd.org/cgi/man.cgi?query=jls&amp;sektion=8&amp;format=html">jls(8)</a> supports the <code>--libxo</code> argument, which through the <a href="https://man.freebsd.org/cgi/man.cgi?query=libxo&amp;sektion=3&amp;format=html">libxo(3)</a> library allows other types of formats to be displayed, such as <code>JSON</code>, <code>HTML</code>, etc.</p>
</div>
<div class="paragraph">
<p>For example, execute the following command to get the <code>JSON</code> output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># jls --libxo=json</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should be similar to the following:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>{&#34;__version&#34;: &#34;2&#34;, &#34;jail-information&#34;: {&#34;jail&#34;: [{&#34;jid&#34;:1,&#34;ipv4&#34;:&#34;192.168.250.70&#34;,&#34;hostname&#34;:&#34;classic&#34;,&#34;path&#34;:&#34;/usr/local/jails/containers/classic&#34;}]}}</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="start-jail">17.6.2. Start, Restart, and Stop a Jail<a class="anchor" href="#start-jail"></a></h4>
<div class="paragraph">
<p><a href="https://man.freebsd.org/cgi/man.cgi?query=service&amp;sektion=8&amp;format=html">service(8)</a> is used to start, reboot, or stop a jail on the host.</p>
</div>
<div class="paragraph">
<p>For example, to start a jail, run the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># service jail start jailname</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Change the <code>start</code> argument to <code>restart</code> or <code>stop</code> to perform other actions on the jail.</p>
</div>
</div>
<div class="sect3">
<h4 id="destroy-jail">17.6.3. Destroy a Jail<a class="anchor" href="#destroy-jail"></a></h4>
<div class="paragraph">
<p>Destroying a jail is not as simple as stopping the jail using <a href="https://man.freebsd.org/cgi/man.cgi?query=service&amp;sektion=8&amp;format=html">service(8)</a> and removing the jail directory and <span class="filename">/etc/jail.conf</span> entry.</p>
</div>
<div class="paragraph">
<p>FreeBSD takes system security very seriously. For this reason there are certain files that not even the root user can delete. This functionality is known as File Flags.</p>
</div>
<div class="paragraph">
<p>The first step is to stop the desired jail executing the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># service jail stop jailname</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The second step is to remove these flags with <a href="https://man.freebsd.org/cgi/man.cgi?query=chflags&amp;sektion=1&amp;format=html">chflags(1)</a> by executing the following command, in which <code>classic</code> is the name of the jail to remove:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># chflags -R 0 /usr/local/jails/classic</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The third step is to delete the directory where the jail was:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># rm -rf /usr/local/jails/classic</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, it will be necessary to remove the jail entry in <span class="filename">/etc/jail.conf</span> or in <span class="filename">jail.conf.d</span>.</p>
</div>
</div>
<div class="sect3">
<h4 id="handle-packages-jail">17.6.4. Handle Packages in a Jail<a class="anchor" href="#handle-packages-jail"></a></h4>
<div class="paragraph">
<p>The <a href="https://man.freebsd.org/cgi/man.cgi?query=pkg&amp;sektion=8&amp;format=html">pkg(8)</a> tool supports the <code>-j</code> argument in order to handle packages installed inside the jail.</p>
</div>
<div class="paragraph">
<p>For example, to install <a class="package" href="https://cgit.freebsd.org/ports/tree/nginx-lite/">nginx-lite</a> in the jail, the next command can be executed <strong>from the host</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg -j classic install nginx-lite</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For more information on working with packages in FreeBSD, see <a href="./#ports">Installing Applications: Packages and Ports</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="access-jail">17.6.5. Access a Jail<a class="anchor" href="#access-jail"></a></h4>
<div class="paragraph">
<p>While it has been stated above that it is best to manage jails from the host system, a jail can be entered with <a href="https://man.freebsd.org/cgi/man.cgi?query=jexec&amp;sektion=8&amp;format=html">jexec(8)</a>.</p>
</div>
<div class="paragraph">
<p>The jail can be entered by running <a href="https://man.freebsd.org/cgi/man.cgi?query=jexec&amp;sektion=8&amp;format=html">jexec(8)</a> from the host:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># jexec -u root jailname</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When gaining access to the jail, the message configured in <a href="https://man.freebsd.org/cgi/man.cgi?query=motd&amp;sektion=5&amp;format=html">motd(5)</a> will be displayed.</p>
</div>
</div>
<div class="sect3">
<h4 id="execute-commands-jail">17.6.6. Execute Commands in a Jail<a class="anchor" href="#execute-commands-jail"></a></h4>
<div class="paragraph">
<p>To execute a command from the host system in a jail the <a href="https://man.freebsd.org/cgi/man.cgi?query=jexec&amp;sektion=8&amp;format=html">jexec(8)</a> can be used.</p>
</div>
<div class="paragraph">
<p>For example, to stop a service that is running inside a jail, the command will be executed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># jexec -l jailname service stop nginx</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="jail-upgrading">17.7. Jail Upgrading<a class="anchor" href="#jail-upgrading"></a></h3>
<div class="paragraph">
<p>Upgrading FreeBSD Jails ensures that the isolated environments remain secure, up-to-date, and in line with the latest features and improvements available in the FreeBSD ecosystem.</p>
</div>
<div class="sect3">
<h4 id="jails-updating">17.7.1. Upgrading a Classic Jail or a Thin Jail using OpenZFS Snapshots<a class="anchor" href="#jails-updating"></a></h4>
<div class="paragraph">
<p>Jails <strong>must be updated from the host</strong> operating system. The default behavior in FreeBSD is to disallow the use of <a href="https://man.freebsd.org/cgi/man.cgi?query=chflags&amp;sektion=1&amp;format=html">chflags(1)</a> in a jail. This will prevent the update of some files so updating from withing the jail will fail.</p>
</div>
<div class="paragraph">
<p>To update the jail to the latest patch release of the version of FreeBSD it is running, execute the following commands on the host:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># freebsd-update -j classic fetch install</span>
<span class="c"># service jail restart classic</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To upgrade the jail to a new major or minor version, first upgrade the host system as described in <a href="./#freebsdupdate-upgrade">Performing Major and Minor Version Upgrades</a>. Once the host has been upgraded and rebooted, the jail can then be upgraded.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In case of upgrade from one version to another, it is easier to create a new jail than to upgrade completely.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>For example to upgrade from 13.1-RELEASE to 13.2-RELEASE, execute the following commands on the host:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># freebsd-update -j classic -r 13.2-RELEASE upgrade</span>
<span class="c"># freebsd-update -j classic install</span>
<span class="c"># service jail restart classic</span>
<span class="c"># freebsd-update -j classic install</span>
<span class="c"># service jail restart classic</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>It is necessary to execute the <code>install</code> step two times. The first one upgrades the kernel, and the second one upgrades the rest of the components.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Then, if it was a major version upgrade, reinstall all installed packages and restart the jail again. This is required because the ABI version changes when upgrading between major versions of FreeBSD.</p>
</div>
<div class="paragraph">
<p>From the host:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg -j jailname upgrade -f</span>
<span class="c"># service jail restart jailname</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="upgrading-thin-jail">17.7.2. Upgrading a Thin Jail Using NullFS<a class="anchor" href="#upgrading-thin-jail"></a></h4>
<div class="paragraph">
<p>Since Thin Jails that use NullFS share the majority of system directories, they are very easy to update. It is enough to update the template. This allows updating multiple jails at the same time.</p>
</div>
<div class="paragraph">
<p>To update the template to the latest patch release of the version of FreeBSD it is running, execute the following commands on the host:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># freebsd-update -b /usr/local/jails/templates/13.1-RELEASE-base/ fetch install</span>
<span class="c"># service jail restart</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To upgrade the template to a new major or minor version, first upgrade the host system as described in <a href="./#freebsdupdate-upgrade">Performing Major and Minor Version Upgrades</a>. Once the host has been upgraded and rebooted, the template can then be upgraded.</p>
</div>
<div class="paragraph">
<p>For example, to upgrade from 13.1-RELEASE to 13.2-RELEASE, execute the following commands on the host:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># freebsd-update -b /usr/local/jails/templates/13.1-RELEASE-base/ -r 13.2-RELEASE upgrade</span>
<span class="c"># freebsd-update -b /usr/local/jails/templates/13.1-RELEASE-base/ install</span>
<span class="c"># service jail restart</span>
<span class="c"># freebsd-update -b /usr/local/jails/templates/13.1-RELEASE-base/ install</span>
<span class="c"># service jail restart</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="jail-resource-limits">17.8. Jail Resource Limits<a class="anchor" href="#jail-resource-limits"></a></h3>
<div class="paragraph">
<p>Controlling the resources that a jail uses from the host system is a task to be taken into account by the system administrator.</p>
</div>
<div class="paragraph">
<p><a href="https://man.freebsd.org/cgi/man.cgi?query=rctl&amp;sektion=8&amp;format=html">rctl(8)</a> allows you to manage the resources that a jail can use from the host system.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>kern.racct.enable</code> tunable must be enabled at <span class="filename">/boot/loader.conf</span>.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>The syntax to limit the resources of a jail is as follows:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>rctl -a jail:&lt;jailname&gt;:resource:action=amount/percentage</pre>
</div>
</div>
<div class="paragraph">
<p>For example, to limit the maximum RAM that a jail can access, run the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># rctl -a jail:classic:memoryuse:deny=2G</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To make the limitation persistent across reboots of the host system, it will be necessary to add the rule to the <span class="filename">/etc/rctl.conf</span> file as follows:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>jail:classic:memoryuse:deny=2G/jail</pre>
</div>
</div>
<div class="paragraph">
<p>More information on resource limits can be found in the security chapter in the <a href="./#security-resourcelimits">Resource Limits section</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="jail-managers-and-containers">17.9. Jail Managers and Containers<a class="anchor" href="#jail-managers-and-containers"></a></h3>
<div class="paragraph">
<p>As previously explained, each type of FreeBSD Jail can be created and configured manually, but FreeBSD also has third-party utilities to make configuration and administration easier.</p>
</div>
<div class="paragraph">
<p>Below is an incomplete list of the different FreeBSD Jail managers:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">表 30. Jail Managers</caption>
<colgroup>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
<col style="width: 25%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">License</th>
<th class="tableblock halign-left valign-top">Package</th>
<th class="tableblock halign-left valign-top">Documentation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">BastilleBSD</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BSD-3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a class="package" href="https://cgit.freebsd.org/ports/tree/sysutils/bastille/">sysutils/bastille</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://bastille.readthedocs.io/en/latest/">Documentation</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">pot</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BSD-3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a class="package" href="https://cgit.freebsd.org/ports/tree/sysutils/pot/">sysutils/pot</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://pot.pizzamig.dev/">Documentation</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">cbsd</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BSD-2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a class="package" href="https://cgit.freebsd.org/ports/tree/sysutils/cbsd/">sysutils/cbsd</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.bsdstore.ru/en/docs.html">Documentation</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">AppJail</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BSD-3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a class="package" href="https://cgit.freebsd.org/ports/tree/sysutils/appjail/">sysutils/appjail</a>, for devel <a class="package" href="https://cgit.freebsd.org/ports/tree/sysutils/appjail-devel/">sysutils/appjail-devel</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/DtxdF/AppJail#getting-started">Documentation</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">iocage</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BSD-2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a class="package" href="https://cgit.freebsd.org/ports/tree/sysutils/iocage/">sysutils/iocage</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://iocage.readthedocs.io/en/latest/">Documentation</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ezjail</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://erdgeist.org/beerware.html">Beer Ware</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a class="package" href="https://cgit.freebsd.org/ports/tree/sysutils/ezjail/">sysutils/ezjail</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://erdgeist.org/arts/software/ezjail/">Documentation</a></p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="mac">Chapter 18. Mandatory Access Control<a class="anchor" href="#mac"></a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="mac-synopsis">18.1. Synopsis<a class="anchor" href="#mac-synopsis"></a></h3>
<div class="paragraph">
<p>FreeBSD supports security extensions based on the POSIX®.1e draft. These security mechanisms include file system Access Control Lists (<a href="./#fs-acl">“Access Control Lists”</a>) and Mandatory Access Control (MAC). MAC allows access control modules to be loaded in order to implement security policies. Some modules provide protections for a narrow subset of the system, hardening a particular service. Others provide comprehensive labeled security across all subjects and objects. The mandatory part of the definition indicates that enforcement of controls is performed by administrators and the operating system. This is in contrast to the default security mechanism of Discretionary Access Control (DAC) where enforcement is left to the discretion of users.</p>
</div>
<div class="paragraph">
<p>This chapter focuses on the MAC framework and the set of pluggable security policy modules FreeBSD provides for enabling various security mechanisms.</p>
</div>
<div class="paragraph">
<p>After reading this chapter, you will know:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The terminology associated with the MAC framework.</p>
</li>
<li>
<p>The capabilities of MAC security policy modules as well as the difference between a labeled and non-labeled policy.</p>
</li>
<li>
<p>The considerations to take into account before configuring a system to use the MAC framework.</p>
</li>
<li>
<p>Which MAC security policy modules are included in FreeBSD and how to configure them.</p>
</li>
<li>
<p>How to implement a more secure environment using the MAC framework.</p>
</li>
<li>
<p>How to test the MAC configuration to ensure the framework has been properly implemented.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Before reading this chapter, you should:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Understand UNIX® and FreeBSD basics (<a href="./#basics">FreeBSD Basics</a>).</p>
</li>
<li>
<p>Have some familiarity with security and how it pertains to FreeBSD (<a href="./#security">Security</a>).</p>
</li>
</ul>
</div>
<div class="admonitionblock warning">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Improper MAC configuration may cause loss of system access, aggravation of users, or inability to access the features provided by Xorg. More importantly, MAC should not be relied upon to completely secure a system. The MAC framework only augments an existing security policy. Without sound security practices and regular security checks, the system will never be completely secure.</p>
</div>
<div class="paragraph">
<p>The examples contained within this chapter are for demonstration purposes and the example settings should <em>not</em> be implemented on a production system. Implementing any security policy takes a good deal of understanding, proper design, and thorough testing.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>While this chapter covers a broad range of security issues relating to the MAC framework, the development of new MAC security policy modules will not be covered. A number of security policy modules included with the MAC framework have specific characteristics which are provided for both testing and new module development. Refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=mac_test&amp;sektion=4&amp;format=html">mac_test(4)</a>, <a href="https://man.freebsd.org/cgi/man.cgi?query=mac_stub&amp;sektion=4&amp;format=html">mac_stub(4)</a> and <a href="https://man.freebsd.org/cgi/man.cgi?query=mac_none&amp;sektion=4&amp;format=html">mac_none(4)</a> for more information on these security policy modules and the various mechanisms they provide.</p>
</div>
</div>
<div class="sect2">
<h3 id="mac-inline-glossary">18.2. Key Terms<a class="anchor" href="#mac-inline-glossary"></a></h3>
<div class="paragraph">
<p>The following key terms are used when referring to the MAC framework:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>compartment</em>: a set of programs and data to be partitioned or separated, where users are given explicit access to specific component of a system. A compartment represents a grouping, such as a work group, department, project, or topic. Compartments make it possible to implement a need-to-know-basis security policy.</p>
</li>
<li>
<p><em>integrity</em>: the level of trust which can be placed on data. As the integrity of the data is elevated, so does the ability to trust that data.</p>
</li>
<li>
<p><em>level</em>: the increased or decreased setting of a security attribute. As the level increases, its security is considered to elevate as well.</p>
</li>
<li>
<p><em>label</em>: a security attribute which can be applied to files, directories, or other items in the system. It could be considered a confidentiality stamp. When a label is placed on a file, it describes the security properties of that file and will only permit access by files, users, and resources with a similar security setting. The meaning and interpretation of label values depends on the policy configuration. Some policies treat a label as representing the integrity or secrecy of an object while other policies might use labels to hold rules for access.</p>
</li>
<li>
<p><em>multilabel</em>: this property is a file system option which can be set in single-user mode using <a href="https://man.freebsd.org/cgi/man.cgi?query=tunefs&amp;sektion=8&amp;format=html">tunefs(8)</a>, during boot using <a href="https://man.freebsd.org/cgi/man.cgi?query=fstab&amp;sektion=5&amp;format=html">fstab(5)</a>, or during the creation of a new file system. This option permits an administrator to apply different MAC labels on different objects. This option only applies to security policy modules which support labeling.</p>
</li>
<li>
<p><em>single label</em>: a policy where the entire file system uses one label to enforce access control over the flow of data. Whenever <code>multilabel</code> is not set, all files will conform to the same label setting.</p>
</li>
<li>
<p><em>object</em>: an entity through which information flows under the direction of a <em>subject</em>. This includes directories, files, fields, screens, keyboards, memory, magnetic storage, printers or any other data storage or moving device. An object is a data container or a system resource. Access to an object effectively means access to its data.</p>
</li>
<li>
<p><em>subject</em>: any active entity that causes information to flow between <em>objects</em> such as a user, user process, or system process. On FreeBSD, this is almost always a thread acting in a process on behalf of a user.</p>
</li>
<li>
<p><em>policy</em>: a collection of rules which defines how objectives are to be achieved. A policy usually documents how certain items are to be handled. This chapter considers a policy to be a collection of rules which controls the flow of data and information and defines who has access to that data and information.</p>
</li>
<li>
<p><em>high-watermark</em>: this type of policy permits the raising of security levels for the purpose of accessing higher level information. In most cases, the original level is restored after the process is complete. Currently, the FreeBSD MAC framework does not include this type of policy.</p>
</li>
<li>
<p><em>low-watermark</em>: this type of policy permits lowering security levels for the purpose of accessing information which is less secure. In most cases, the original security level of the user is restored after the process is complete. The only security policy module in FreeBSD to use this is <a href="https://man.freebsd.org/cgi/man.cgi?query=mac_lomac&amp;sektion=4&amp;format=html">mac_lomac(4)</a>.</p>
</li>
<li>
<p><em>sensitivity</em>: usually used when discussing Multilevel Security (MLS). A sensitivity level describes how important or secret the data should be. As the sensitivity level increases, so does the importance of the secrecy, or confidentiality, of the data.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="mac-understandlabel">18.3. Understanding MAC Labels<a class="anchor" href="#mac-understandlabel"></a></h3>
<div class="paragraph">
<p>A MAC label is a security attribute which may be applied to subjects and objects throughout the system. When setting a label, the administrator must understand its implications in order to prevent unexpected or undesired behavior of the system. The attributes available on an object depend on the loaded policy module, as policy modules interpret their attributes in different ways.</p>
</div>
<div class="paragraph">
<p>The security label on an object is used as a part of a security access control decision by a policy. With some policies, the label contains all of the information necessary to make a decision. In other policies, the labels may be processed as part of a larger rule set.</p>
</div>
<div class="paragraph">
<p>There are two types of label policies: single label and multi label. By default, the system will use single label. The administrator should be aware of the pros and cons of each in order to implement policies which meet the requirements of the system’s security model.</p>
</div>
<div class="paragraph">
<p>A single label security policy only permits one label to be used for every subject or object. Since a single label policy enforces one set of access permissions across the entire system, it provides lower administration overhead, but decreases the flexibility of policies which support labeling. However, in many environments, a single label policy may be all that is required.</p>
</div>
<div class="paragraph">
<p>A single label policy is somewhat similar to DAC as <code>root</code> configures the policies so that users are placed in the appropriate categories and access levels. A notable difference is that many policy modules can also restrict <code>root</code>. Basic control over objects will then be released to the group, but <code>root</code> may revoke or modify the settings at any time.</p>
</div>
<div class="paragraph">
<p>When appropriate, a multi label policy can be set on a UFS file system by passing <code>multilabel</code> to <a href="https://man.freebsd.org/cgi/man.cgi?query=tunefs&amp;sektion=8&amp;format=html">tunefs(8)</a>. A multi label policy permits each subject or object to have its own independent MAC label. The decision to use a multi label or single label policy is only required for policies which implement the labeling feature, such as <code>biba</code>, <code>lomac</code>, and <code>mls</code>. Some policies, such as <code>seeotheruids</code>, <code>portacl</code> and <code>partition</code>, do not use labels at all.</p>
</div>
<div class="paragraph">
<p>Using a multi label policy on a partition and establishing a multi label security model can increase administrative overhead as everything in that file system has a label. This includes directories, files, and even device nodes.</p>
</div>
<div class="paragraph">
<p>The following command will set <code>multilabel</code> on the specified UFS file system. This may only be done in single-user mode and is not a requirement for the swap file system:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># tunefs -l enable /</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Some users have experienced problems with setting the <code>multilabel</code> flag on the root partition. If this is the case, please review <a href="#mac-troubleshoot">Troubleshooting the MAC Framework</a>.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Since the multi label policy is set on a per-file system basis, a multi label policy may not be needed if the file system layout is well designed. Consider an example security MAC model for a FreeBSD web server. This machine uses the single label, <code>biba/high</code>, for everything in the default file systems. If the web server needs to run at <code>biba/low</code> to prevent write up capabilities, it could be installed to a separate UFS <span class="filename">/usr/local</span> file system set at <code>biba/low</code>.</p>
</div>
<div class="sect3">
<h4 id="_label_configuration">18.3.1. Label Configuration<a class="anchor" href="#_label_configuration"></a></h4>
<div class="paragraph">
<p>Virtually all aspects of label policy module configuration will be performed using the base system utilities. These commands provide a simple interface for object or subject configuration or the manipulation and verification of the configuration.</p>
</div>
<div class="paragraph">
<p>All configuration may be done using <code>setfmac</code>, which is used to set MAC labels on system objects, and <code>setpmac</code>, which is used to set the labels on system subjects. For example, to set the <code>biba</code> MAC label to <code>high</code> on <span class="filename">test</span>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># setfmac biba/high test</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If the configuration is successful, the prompt will be returned without error. A common error is <code>Permission denied</code> which usually occurs when the label is being set or modified on a restricted object. Other conditions may produce different failures. For instance, the file may not be owned by the user attempting to relabel the object, the object may not exist, or the object may be read-only. A mandatory policy will not allow the process to relabel the file, maybe because of a property of the file, a property of the process, or a property of the proposed new label value. For example, if a user running at low integrity tries to change the label of a high integrity file, or a user running at low integrity tries to change the label of a low integrity file to a high integrity label, these operations will fail.</p>
</div>
<div class="paragraph">
<p>The system administrator may use <code>setpmac</code> to override the policy module’s settings by assigning a different label to the invoked process:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># setfmac biba/high test</span>
Permission denied
<span class="c"># setpmac biba/low setfmac biba/high test</span>
<span class="c"># getfmac test</span>
<span class="nb">test</span>: biba/high</code></pre>
</div>
</div>
<div class="paragraph">
<p>For currently running processes, such as sendmail, <code>getpmac</code> is usually used instead. This command takes a process ID (PID) in place of a command name. If users attempt to manipulate a file not in their access, subject to the rules of the loaded policy modules, the <code>Operation not permitted</code> error will be displayed.</p>
</div>
</div>
<div class="sect3">
<h4 id="_predefined_labels">18.3.2. Predefined Labels<a class="anchor" href="#_predefined_labels"></a></h4>
<div class="paragraph">
<p>A few FreeBSD policy modules which support the labeling feature offer three predefined labels: <code>low</code>, <code>equal</code>, and <code>high</code>, where:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>low</code> is considered the lowest label setting an object or subject may have. Setting this on objects or subjects blocks their access to objects or subjects marked high.</p>
</li>
<li>
<p><code>equal</code> sets the subject or object to be disabled or unaffected and should only be placed on objects considered to be exempt from the policy.</p>
</li>
<li>
<p><code>high</code> grants an object or subject the highest setting available in the Biba and MLS policy modules.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Such policy modules include <a href="https://man.freebsd.org/cgi/man.cgi?query=mac_biba&amp;sektion=4&amp;format=html">mac_biba(4)</a>, <a href="https://man.freebsd.org/cgi/man.cgi?query=mac_mls&amp;sektion=4&amp;format=html">mac_mls(4)</a> and <a href="https://man.freebsd.org/cgi/man.cgi?query=mac_lomac&amp;sektion=4&amp;format=html">mac_lomac(4)</a>. Each of the predefined labels establishes a different information flow directive. Refer to the manual page of the module to determine the traits of the generic label configurations.</p>
</div>
</div>
<div class="sect3">
<h4 id="_numeric_labels">18.3.3. Numeric Labels<a class="anchor" href="#_numeric_labels"></a></h4>
<div class="paragraph">
<p>The Biba and MLS policy modules support a numeric label which may be set to indicate the precise level of hierarchical control. This numeric level is used to partition or sort information into different groups of classification, only permitting access to that group or a higher group level. For example:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>biba/10:2+3+6(5:2+3-20:2+3+4+5+6)</pre>
</div>
</div>
<div class="paragraph">
<p>may be interpreted as &#34;Biba Policy Label/Grade 10:Compartments 2, 3 and 6: (grade 5 …​&#34;)</p>
</div>
<div class="paragraph">
<p>In this example, the first grade would be considered the effective grade with effective compartments, the second grade is the low grade, and the last one is the high grade. In most configurations, such fine-grained settings are not needed as they are considered to be advanced configurations.</p>
</div>
<div class="paragraph">
<p>System objects only have a current grade and compartment. System subjects reflect the range of available rights in the system, and network interfaces, where they are used for access control.</p>
</div>
<div class="paragraph">
<p>The grade and compartments in a subject and object pair are used to construct a relationship known as <em>dominance</em>, in which a subject dominates an object, the object dominates the subject, neither dominates the other, or both dominate each other. The &#34;both dominate&#34; case occurs when the two labels are equal. Due to the information flow nature of Biba, a user has rights to a set of compartments that might correspond to projects, but objects also have a set of compartments. Users may have to subset their rights using <code>su</code> or <code>setpmac</code> in order to access objects in a compartment from which they are not restricted.</p>
</div>
</div>
<div class="sect3">
<h4 id="_user_labels">18.3.4. User Labels<a class="anchor" href="#_user_labels"></a></h4>
<div class="paragraph">
<p>Users are required to have labels so that their files and processes properly interact with the security policy defined on the system. This is configured in <span class="filename">/etc/login.conf</span> using login classes. Every policy module that uses labels will implement the user class setting.</p>
</div>
<div class="paragraph">
<p>To set the user class default label which will be enforced by MAC, add a <code>label</code> entry. An example <code>label</code> entry containing every policy module is displayed below. Note that in a real configuration, the administrator would never enable every policy module. It is recommended that the rest of this chapter be reviewed before any configuration is implemented.</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>default:\
	:copyright=/etc/COPYRIGHT:\
	:welcome=/etc/motd:\
	:setenv=MAIL=/var/mail/$,BLOCKSIZE=K:\
	:path=~/bin:/sbin:/bin:/usr/sbin:/usr/bin:/usr/local/sbin:/usr/local/bin:\
	:manpath=/usr/share/man /usr/local/man:\
	:nologin=/usr/sbin/nologin:\
	:cputime=1h30m:\
	:datasize=8M:\
	:vmemoryuse=100M:\
	:stacksize=2M:\
	:memorylocked=4M:\
	:memoryuse=8M:\
	:filesize=8M:\
	:coredumpsize=8M:\
	:openfiles=24:\
	:maxproc=32:\
	:priority=0:\
	:requirehome:\
	:passwordtime=91d:\
	:umask=022:\
	:ignoretime@:\
	:label=partition/13,mls/5,biba/10(5-15),lomac/10[2]:</pre>
</div>
</div>
<div class="paragraph">
<p>While users can not modify the default value, they may change their label after they login, subject to the constraints of the policy. The example above tells the Biba policy that a process’s minimum integrity is <code>5</code>, its maximum is <code>15</code>, and the default effective label is <code>10</code>. The process will run at <code>10</code> until it chooses to change label, perhaps due to the user using <code>setpmac</code>, which will be constrained by Biba to the configured range.</p>
</div>
<div class="paragraph">
<p>After any change to <span class="filename">login.conf</span>, the login class capability database must be rebuilt using <code>cap_mkdb</code>.</p>
</div>
<div class="paragraph">
<p>Many sites have a large number of users requiring several different user classes. In depth planning is required as this can become difficult to manage.</p>
</div>
</div>
<div class="sect3">
<h4 id="_network_interface_labels">18.3.5. Network Interface Labels<a class="anchor" href="#_network_interface_labels"></a></h4>
<div class="paragraph">
<p>Labels may be set on network interfaces to help control the flow of data across the network. Policies using network interface labels function in the same way that policies function with respect to objects. Users at high settings in Biba, for example, will not be permitted to access network interfaces with a label of <code>low</code>.</p>
</div>
<div class="paragraph">
<p>When setting the MAC label on network interfaces, <code>maclabel</code> may be passed to <code>ifconfig</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ifconfig bge0 maclabel biba/equal</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This example will set the MAC label of <code>biba/equal</code> on the <code>bge0</code> interface. When using a setting similar to <code>biba/high(low-high)</code>, the entire label should be quoted to prevent an error from being returned.</p>
</div>
<div class="paragraph">
<p>Each policy module which supports labeling has a tunable which may be used to disable the MAC label on network interfaces. Setting the label to <code>equal</code> will have a similar effect. Review the output of <code>sysctl</code>, the policy manual pages, and the information in the rest of this chapter for more information on those tunables.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mac-planning">18.4. Planning the Security Configuration<a class="anchor" href="#mac-planning"></a></h3>
<div class="paragraph">
<p>Before implementing any MAC policies, a planning phase is recommended. During the planning stages, an administrator should consider the implementation requirements and goals, such as:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>How to classify information and resources available on the target systems.</p>
</li>
<li>
<p>Which information or resources to restrict access to along with the type of restrictions that should be applied.</p>
</li>
<li>
<p>Which MAC modules will be required to achieve this goal.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A trial run of the trusted system and its configuration should occur <em>before</em> a MAC implementation is used on production systems. Since different environments have different needs and requirements, establishing a complete security profile will decrease the need of changes once the system goes live.</p>
</div>
<div class="paragraph">
<p>Consider how the MAC framework augments the security of the system as a whole. The various security policy modules provided by the MAC framework could be used to protect the network and file systems or to block users from accessing certain ports and sockets. Perhaps the best use of the policy modules is to load several security policy modules at a time in order to provide a MLS environment. This approach differs from a hardening policy, which typically hardens elements of a system which are used only for specific purposes. The downside to MLS is increased administrative overhead.</p>
</div>
<div class="paragraph">
<p>The overhead is minimal when compared to the lasting effect of a framework which provides the ability to pick and choose which policies are required for a specific configuration and which keeps performance overhead down. The reduction of support for unneeded policies can increase the overall performance of the system as well as offer flexibility of choice. A good implementation would consider the overall security requirements and effectively implement the various security policy modules offered by the framework.</p>
</div>
<div class="paragraph">
<p>A system utilizing MAC guarantees that a user will not be permitted to change security attributes at will. All user utilities, programs, and scripts must work within the constraints of the access rules provided by the selected security policy modules and control of the MAC access rules is in the hands of the system administrator.</p>
</div>
<div class="paragraph">
<p>It is the duty of the system administrator to carefully select the correct security policy modules. For an environment that needs to limit access control over the network, the <a href="https://man.freebsd.org/cgi/man.cgi?query=mac_portacl&amp;sektion=4&amp;format=html">mac_portacl(4)</a>, <a href="https://man.freebsd.org/cgi/man.cgi?query=mac_ifoff&amp;sektion=4&amp;format=html">mac_ifoff(4)</a>, and <a href="https://man.freebsd.org/cgi/man.cgi?query=mac_biba&amp;sektion=4&amp;format=html">mac_biba(4)</a> policy modules make good starting points. For an environment where strict confidentiality of file system objects is required, consider the <a href="https://man.freebsd.org/cgi/man.cgi?query=mac_bsdextended&amp;sektion=4&amp;format=html">mac_bsdextended(4)</a> and <a href="https://man.freebsd.org/cgi/man.cgi?query=mac_mls&amp;sektion=4&amp;format=html">mac_mls(4)</a> policy modules.</p>
</div>
<div class="paragraph">
<p>Policy decisions could be made based on network configuration. If only certain users should be permitted access to <a href="https://man.freebsd.org/cgi/man.cgi?query=ssh&amp;sektion=1&amp;format=html">ssh(1)</a>, the <a href="https://man.freebsd.org/cgi/man.cgi?query=mac_portacl&amp;sektion=4&amp;format=html">mac_portacl(4)</a> policy module is a good choice. In the case of file systems, access to objects might be considered confidential to some users, but not to others. As an example, a large development team might be broken off into smaller projects where developers in project A might not be permitted to access objects written by developers in project B. Yet both projects might need to access objects created by developers in project C. Using the different security policy modules provided by the MAC framework, users could be divided into these groups and then given access to the appropriate objects.</p>
</div>
<div class="paragraph">
<p>Each security policy module has a unique way of dealing with the overall security of a system. Module selection should be based on a well thought out security policy which may require revision and reimplementation. Understanding the different security policy modules offered by the MAC framework will help administrators choose the best policies for their situations.</p>
</div>
<div class="paragraph">
<p>The rest of this chapter covers the available modules, describes their use and configuration, and in some cases, provides insight on applicable situations.</p>
</div>
<div class="admonitionblock caution">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Implementing MAC is much like implementing a firewall since care must be taken to prevent being completely locked out of the system. The ability to revert back to a previous configuration should be considered and the implementation of MAC over a remote connection should be done with extreme caution.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect2">
<h3 id="mac-policies">18.5. Available MAC Policies<a class="anchor" href="#mac-policies"></a></h3>
<div class="paragraph">
<p>The default FreeBSD kernel includes <code>options MAC</code>. This means that every module included with the MAC framework can be loaded with <code>kldload</code> as a run-time kernel module. After testing the module, add the module name to <span class="filename">/boot/loader.conf</span> so that it will load during boot. Each module also provides a kernel option for those administrators who choose to compile their own custom kernel.</p>
</div>
<div class="paragraph">
<p>FreeBSD includes a group of policies that will cover most security requirements. Each policy is summarized below. The last three policies support integer settings in place of the three default labels.</p>
</div>
<div class="sect3">
<h4 id="mac-seeotheruids">18.5.1. The MAC See Other UIDs Policy<a class="anchor" href="#mac-seeotheruids"></a></h4>
<div class="paragraph">
<p>Module name: <span class="filename">mac_seeotheruids.ko</span></p>
</div>
<div class="paragraph">
<p>Kernel configuration line: <code>options MAC_SEEOTHERUIDS</code></p>
</div>
<div class="paragraph">
<p>Boot option: <code>mac_seeotheruids_load=&#34;YES&#34;</code></p>
</div>
<div class="paragraph">
<p>The <a href="https://man.freebsd.org/cgi/man.cgi?query=mac_seeotheruids&amp;sektion=4&amp;format=html">mac_seeotheruids(4)</a> module extends the <code>security.bsd.see_other_uids</code> and <code>security.bsd.see_other_gids sysctl</code> tunables. This option does not require any labels to be set before configuration and can operate transparently with other modules.</p>
</div>
<div class="paragraph">
<p>After loading the module, the following <code>sysctl</code> tunables may be used to control its features:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>security.mac.seeotheruids.enabled</code> enables the module and implements the default settings which deny users the ability to view processes and sockets owned by other users.</p>
</li>
<li>
<p><code>security.mac.seeotheruids.specificgid_enabled</code> allows specified groups to be exempt from this policy. To exempt specific groups, use the <code>security.mac.seeotheruids.specificgid=<em>XXX</em> sysctl</code> tunable, replacing <em>XXX</em> with the numeric group ID to be exempted.</p>
</li>
<li>
<p><code>security.mac.seeotheruids.primarygroup_enabled</code> is used to exempt specific primary groups from this policy. When using this tunable, <code>security.mac.seeotheruids.specificgid_enabled</code> may not be set.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="mac-bsdextended">18.5.2. The MAC BSD Extended Policy<a class="anchor" href="#mac-bsdextended"></a></h4>
<div class="paragraph">
<p>Module name: <span class="filename">mac_bsdextended.ko</span></p>
</div>
<div class="paragraph">
<p>Kernel configuration line: <code>options MAC_BSDEXTENDED</code></p>
</div>
<div class="paragraph">
<p>Boot option: <code>mac_bsdextended_load=&#34;YES&#34;</code></p>
</div>
<div class="paragraph">
<p>The <a href="https://man.freebsd.org/cgi/man.cgi?query=mac_bsdextended&amp;sektion=4&amp;format=html">mac_bsdextended(4)</a> module enforces a file system firewall. It provides an extension to the standard file system permissions model, permitting an administrator to create a firewall-like ruleset to protect files, utilities, and directories in the file system hierarchy. When access to a file system object is attempted, the list of rules is iterated until either a matching rule is located or the end is reached. This behavior may be changed using <code>security.mac.bsdextended.firstmatch_enabled</code>. Similar to other firewall modules in FreeBSD, a file containing the access control rules can be created and read by the system at boot time using an <a href="https://man.freebsd.org/cgi/man.cgi?query=rc.conf&amp;sektion=5&amp;format=html">rc.conf(5)</a> variable.</p>
</div>
<div class="paragraph">
<p>The rule list may be entered using <a href="https://man.freebsd.org/cgi/man.cgi?query=ugidfw&amp;sektion=8&amp;format=html">ugidfw(8)</a> which has a syntax similar to <a href="https://man.freebsd.org/cgi/man.cgi?query=ipfw&amp;sektion=8&amp;format=html">ipfw(8)</a>. More tools can be written by using the functions in the <a href="https://man.freebsd.org/cgi/man.cgi?query=libugidfw&amp;sektion=3&amp;format=html">libugidfw(3)</a> library.</p>
</div>
<div class="paragraph">
<p>After the <a href="https://man.freebsd.org/cgi/man.cgi?query=mac_bsdextended&amp;sektion=4&amp;format=html">mac_bsdextended(4)</a> module has been loaded, the following command may be used to list the current rule configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ugidfw list</span>
0 slots, 0 rules</code></pre>
</div>
</div>
<div class="paragraph">
<p>By default, no rules are defined and everything is completely accessible. To create a rule which blocks all access by users but leaves <code>root</code> unaffected:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ugidfw add subject not uid root new object not uid root mode n</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>While this rule is simple to implement, it is a very bad idea as it blocks all users from issuing any commands. A more realistic example blocks <code>user1</code> all access, including directory listings, to <code><em>user2</em></code>&#39;s home directory:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ugidfw set 2 subject uid user1 object uid user2 mode n</span>
<span class="c"># ugidfw set 3 subject uid user1 object gid user2 mode n</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Instead of <code>user1</code>, <code>not uid <em>user2</em></code> could be used in order to enforce the same access restrictions for all users. However, the <code>root</code> user is unaffected by these rules.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Extreme caution should be taken when working with this module as incorrect use could block access to certain parts of the file system.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect3">
<h4 id="mac-ifoff">18.5.3. The MAC Interface Silencing Policy<a class="anchor" href="#mac-ifoff"></a></h4>
<div class="paragraph">
<p>Module name: <span class="filename">mac_ifoff.ko</span></p>
</div>
<div class="paragraph">
<p>Kernel configuration line: <code>options MAC_IFOFF</code></p>
</div>
<div class="paragraph">
<p>Boot option: <code>mac_ifoff_load=&#34;YES&#34;</code></p>
</div>
<div class="paragraph">
<p>The <a href="https://man.freebsd.org/cgi/man.cgi?query=mac_ifoff&amp;sektion=4&amp;format=html">mac_ifoff(4)</a> module is used to disable network interfaces on the fly and to keep network interfaces from being brought up during system boot. It does not use labels and does not depend on any other MAC modules.</p>
</div>
<div class="paragraph">
<p>Most of this module’s control is performed through these <code>sysctl</code> tunables:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>security.mac.ifoff.lo_enabled</code> enables or disables all traffic on the loopback, <a href="https://man.freebsd.org/cgi/man.cgi?query=lo&amp;sektion=4&amp;format=html">lo(4)</a>, interface.</p>
</li>
<li>
<p><code>security.mac.ifoff.bpfrecv_enabled</code> enables or disables all traffic on the Berkeley Packet Filter interface, <a href="https://man.freebsd.org/cgi/man.cgi?query=bpf&amp;sektion=4&amp;format=html">bpf(4)</a>.</p>
</li>
<li>
<p><code>security.mac.ifoff.other_enabled</code> enables or disables traffic on all other interfaces.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>One of the most common uses of <a href="https://man.freebsd.org/cgi/man.cgi?query=mac_ifoff&amp;sektion=4&amp;format=html">mac_ifoff(4)</a> is network monitoring in an environment where network traffic should not be permitted during the boot sequence. Another use would be to write a script which uses an application such as <a class="package" href="https://cgit.freebsd.org/ports/tree/security/aide/">security/aide</a> to automatically block network traffic if it finds new or altered files in protected directories.</p>
</div>
</div>
<div class="sect3">
<h4 id="mac-portacl">18.5.4. The MAC Port Access Control List Policy<a class="anchor" href="#mac-portacl"></a></h4>
<div class="paragraph">
<p>Module name: <span class="filename">mac_portacl.ko</span></p>
</div>
<div class="paragraph">
<p>Kernel configuration line: <code>MAC_PORTACL</code></p>
</div>
<div class="paragraph">
<p>Boot option: <code>mac_portacl_load=&#34;YES&#34;</code></p>
</div>
<div class="paragraph">
<p>The <a href="https://man.freebsd.org/cgi/man.cgi?query=mac_portacl&amp;sektion=4&amp;format=html">mac_portacl(4)</a> module is used to limit binding to local TCP and UDP ports, making it possible to allow non-<code>root</code> users to bind to specified privileged ports below 1024.</p>
</div>
<div class="paragraph">
<p>Once loaded, this module enables the MAC policy on all sockets. The following tunables are available:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>security.mac.portacl.enabled</code> enables or disables the policy completely.</p>
</li>
<li>
<p><code>security.mac.portacl.port_high</code> sets the highest port number that <a href="https://man.freebsd.org/cgi/man.cgi?query=mac_portacl&amp;sektion=4&amp;format=html">mac_portacl(4)</a> protects.</p>
</li>
<li>
<p><code>security.mac.portacl.suser_exempt</code>, when set to a non-zero value, exempts the <code>root</code> user from this policy.</p>
</li>
<li>
<p><code>security.mac.portacl.rules</code> specifies the policy as a text string of the form <code>rule[,rule,…​]</code>, with as many rules as needed, and where each rule is of the form <code>idtype:id:protocol:port</code>. The <code>idtype</code> is either <code>uid</code> or <code>gid</code>. The <code>protocol</code> parameter can be <code>tcp</code> or <code>udp</code>. The <code>port</code> parameter is the port number to allow the specified user or group to bind to. Only numeric values can be used for the user ID, group ID, and port parameters.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>By default, ports below 1024 can only be used by privileged processes which run as <code>root</code>. For <a href="https://man.freebsd.org/cgi/man.cgi?query=mac_portacl&amp;sektion=4&amp;format=html">mac_portacl(4)</a> to allow non-privileged processes to bind to ports below 1024, set the following tunables as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysctl security.mac.portacl.port_high=1023</span>
<span class="c"># sysctl net.inet.ip.portrange.reservedlow=0</span>
<span class="c"># sysctl net.inet.ip.portrange.reservedhigh=0</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To prevent the <code>root</code> user from being affected by this policy, set <code>security.mac.portacl.suser_exempt</code> to a non-zero value.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysctl security.mac.portacl.suser_exempt=1</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To allow the <code>www</code> user with UID 80 to bind to port 80 without ever needing <code>root</code> privilege:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysctl security.mac.portacl.rules=uid:80:tcp:80</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This next example permits the user with the UID of 1001 to bind to TCP ports 110 (POP3) and 995 (POP3s):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysctl security.mac.portacl.rules=uid:1001:tcp:110,uid:1001:tcp:995</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mac-partition">18.5.5. The MAC Partition Policy<a class="anchor" href="#mac-partition"></a></h4>
<div class="paragraph">
<p>Module name: <span class="filename">mac_partition.ko</span></p>
</div>
<div class="paragraph">
<p>Kernel configuration line: <code>options MAC_PARTITION</code></p>
</div>
<div class="paragraph">
<p>Boot option: <code>mac_partition_load=&#34;YES&#34;</code></p>
</div>
<div class="paragraph">
<p>The <a href="https://man.freebsd.org/cgi/man.cgi?query=mac_partition&amp;sektion=4&amp;format=html">mac_partition(4)</a> policy drops processes into specific &#34;partitions&#34; based on their MAC label. Most configuration for this policy is done using <a href="https://man.freebsd.org/cgi/man.cgi?query=setpmac&amp;sektion=8&amp;format=html">setpmac(8)</a>. One <code>sysctl</code> tunable is available for this policy:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>security.mac.partition.enabled</code> enables the enforcement of MAC process partitions.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When this policy is enabled, users will only be permitted to see their processes, and any others within their partition, but will not be permitted to work with utilities outside the scope of this partition. For instance, a user in the <code>insecure</code> class will not be permitted to access <code>top</code> as well as many other commands that must spawn a process.</p>
</div>
<div class="paragraph">
<p>This example adds <code>top</code> to the label set on users in the <code>insecure</code> class. All processes spawned by users in the <code>insecure</code> class will stay in the <code>partition/13</code> label.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># setpmac partition/13 top</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This command displays the partition label and the process list:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ps Zax</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This command displays another user’s process partition label and that user’s currently running processes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ps -ZU trhodes</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Users can see processes in <code>root</code>&#39;s label unless the <a href="https://man.freebsd.org/cgi/man.cgi?query=mac_seeotheruids&amp;sektion=4&amp;format=html">mac_seeotheruids(4)</a> policy is loaded.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect3">
<h4 id="mac-mls">18.5.6. The MAC Multi-Level Security Module<a class="anchor" href="#mac-mls"></a></h4>
<div class="paragraph">
<p>Module name: <span class="filename">mac_mls.ko</span></p>
</div>
<div class="paragraph">
<p>Kernel configuration line: <code>options MAC_MLS</code></p>
</div>
<div class="paragraph">
<p>Boot option: <code>mac_mls_load=&#34;YES&#34;</code></p>
</div>
<div class="paragraph">
<p>The <a href="https://man.freebsd.org/cgi/man.cgi?query=mac_mls&amp;sektion=4&amp;format=html">mac_mls(4)</a> policy controls access between subjects and objects in the system by enforcing a strict information flow policy.</p>
</div>
<div class="paragraph">
<p>In MLS environments, a &#34;clearance&#34; level is set in the label of each subject or object, along with compartments. Since these clearance levels can reach numbers greater than several thousand, it would be a daunting task to thoroughly configure every subject or object. To ease this administrative overhead, three labels are included in this policy: <code>mls/low</code>, <code>mls/equal</code>, and <code>mls/high</code>, where:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Anything labeled with <code>mls/low</code> will have a low clearance level and not be permitted to access information of a higher level. This label also prevents objects of a higher clearance level from writing or passing information to a lower level.</p>
</li>
<li>
<p><code>mls/equal</code> should be placed on objects which should be exempt from the policy.</p>
</li>
<li>
<p><code>mls/high</code> is the highest level of clearance possible. Objects assigned this label will hold dominance over all other objects in the system; however, they will not permit the leaking of information to objects of a lower class.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>MLS provides:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A hierarchical security level with a set of non-hierarchical categories.</p>
</li>
<li>
<p>Fixed rules of <code>no read up, no write down</code>. This means that a subject can have read access to objects on its own level or below, but not above. Similarly, a subject can have write access to objects on its own level or above, but not beneath.</p>
</li>
<li>
<p>Secrecy, or the prevention of inappropriate disclosure of data.</p>
</li>
<li>
<p>A basis for the design of systems that concurrently handle data at multiple sensitivity levels without leaking information between secret and confidential.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following <code>sysctl</code> tunables are available:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>security.mac.mls.enabled</code> is used to enable or disable the MLS policy.</p>
</li>
<li>
<p><code>security.mac.mls.ptys_equal</code> labels all <a href="https://man.freebsd.org/cgi/man.cgi?query=pty&amp;sektion=4&amp;format=html">pty(4)</a> devices as <code>mls/equal</code> during creation.</p>
</li>
<li>
<p><code>security.mac.mls.revocation_enabled</code> revokes access to objects after their label changes to a label of a lower grade.</p>
</li>
<li>
<p><code>security.mac.mls.max_compartments</code> sets the maximum number of compartment levels allowed on a system.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To manipulate MLS labels, use <a href="https://man.freebsd.org/cgi/man.cgi?query=setfmac&amp;sektion=8&amp;format=html">setfmac(8)</a>. To assign a label to an object:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># setfmac mls/5 test</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To get the MLS label for the file <span class="filename">test</span>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># getfmac test</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Another approach is to create a master policy file in <span class="filename">/etc/</span> which specifies the MLS policy information and to feed that file to <code>setfmac</code>.</p>
</div>
<div class="paragraph">
<p>When using the MLS policy module, an administrator plans to control the flow of sensitive information. The default <code>block read up block write down</code> sets everything to a low state. Everything is accessible and an administrator slowly augments the confidentiality of the information.</p>
</div>
<div class="paragraph">
<p>Beyond the three basic label options, an administrator may group users and groups as required to block the information flow between them. It might be easier to look at the information in clearance levels using descriptive words, such as classifications of <code>Confidential</code>, <code>Secret</code>, and <code>Top Secret</code>. Some administrators instead create different groups based on project levels. Regardless of the classification method, a well thought out plan must exist before implementing a restrictive policy.</p>
</div>
<div class="paragraph">
<p>Some example situations for the MLS policy module include an e-commerce web server, a file server holding critical company information, and financial institution environments.</p>
</div>
</div>
<div class="sect3">
<h4 id="mac-biba">18.5.7. The MAC Biba Module<a class="anchor" href="#mac-biba"></a></h4>
<div class="paragraph">
<p>Module name: <span class="filename">mac_biba.ko</span></p>
</div>
<div class="paragraph">
<p>Kernel configuration line: <code>options MAC_BIBA</code></p>
</div>
<div class="paragraph">
<p>Boot option: <code>mac_biba_load=&#34;YES&#34;</code></p>
</div>
<div class="paragraph">
<p>The <a href="https://man.freebsd.org/cgi/man.cgi?query=mac_biba&amp;sektion=4&amp;format=html">mac_biba(4)</a> module loads the MAC Biba policy. This policy is similar to the MLS policy with the exception that the rules for information flow are slightly reversed. This is to prevent the downward flow of sensitive information whereas the MLS policy prevents the upward flow of sensitive information.</p>
</div>
<div class="paragraph">
<p>In Biba environments, an &#34;integrity&#34; label is set on each subject or object. These labels are made up of hierarchical grades and non-hierarchical components. As a grade ascends, so does its integrity.</p>
</div>
<div class="paragraph">
<p>Supported labels are <code>biba/low</code>, <code>biba/equal</code>, and <code>biba/high</code>, where:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>biba/low</code> is considered the lowest integrity an object or subject may have. Setting this on objects or subjects blocks their write access to objects or subjects marked as <code>biba/high</code>, but will not prevent read access.</p>
</li>
<li>
<p><code>biba/equal</code> should only be placed on objects considered to be exempt from the policy.</p>
</li>
<li>
<p><code>biba/high</code> permits writing to objects set at a lower label, but does not permit reading that object. It is recommended that this label be placed on objects that affect the integrity of the entire system.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Biba provides:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Hierarchical integrity levels with a set of non-hierarchical integrity categories.</p>
</li>
<li>
<p>Fixed rules are <code>no write up, no read down</code>, the opposite of MLS. A subject can have write access to objects on its own level or below, but not above. Similarly, a subject can have read access to objects on its own level or above, but not below.</p>
</li>
<li>
<p>Integrity by preventing inappropriate modification of data.</p>
</li>
<li>
<p>Integrity levels instead of MLS sensitivity levels.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following tunables can be used to manipulate the Biba policy:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>security.mac.biba.enabled</code> is used to enable or disable enforcement of the Biba policy on the target machine.</p>
</li>
<li>
<p><code>security.mac.biba.ptys_equal</code> is used to disable the Biba policy on <a href="https://man.freebsd.org/cgi/man.cgi?query=pty&amp;sektion=4&amp;format=html">pty(4)</a> devices.</p>
</li>
<li>
<p><code>security.mac.biba.revocation_enabled</code> forces the revocation of access to objects if the label is changed to dominate the subject.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To access the Biba policy setting on system objects, use <code>setfmac</code> and <code>getfmac</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># setfmac biba/low test</span>
<span class="c"># getfmac test</span>
<span class="nb">test</span>: biba/low</code></pre>
</div>
</div>
<div class="paragraph">
<p>Integrity, which is different from sensitivity, is used to guarantee that information is not manipulated by untrusted parties. This includes information passed between subjects and objects. It ensures that users will only be able to modify or access information they have been given explicit access to. The <a href="https://man.freebsd.org/cgi/man.cgi?query=mac_biba&amp;sektion=4&amp;format=html">mac_biba(4)</a> security policy module permits an administrator to configure which files and programs a user may see and invoke while assuring that the programs and files are trusted by the system for that user.</p>
</div>
<div class="paragraph">
<p>During the initial planning phase, an administrator must be prepared to partition users into grades, levels, and areas. The system will default to a high label once this policy module is enabled, and it is up to the administrator to configure the different grades and levels for users. Instead of using clearance levels, a good planning method could include topics. For instance, only allow developers modification access to the source code repository, source code compiler, and other development utilities. Other users would be grouped into other categories such as testers, designers, or end users and would only be permitted read access.</p>
</div>
<div class="paragraph">
<p>A lower integrity subject is unable to write to a higher integrity subject and a higher integrity subject cannot list or read a lower integrity object. Setting a label at the lowest possible grade could make it inaccessible to subjects. Some prospective environments for this security policy module would include a constrained web server, a development and test machine, and a source code repository. A less useful implementation would be a personal workstation, a machine used as a router, or a network firewall.</p>
</div>
</div>
<div class="sect3">
<h4 id="mac-lomac">18.5.8. The MAC Low-watermark Module<a class="anchor" href="#mac-lomac"></a></h4>
<div class="paragraph">
<p>Module name: <span class="filename">mac_lomac.ko</span></p>
</div>
<div class="paragraph">
<p>Kernel configuration line: <code>options MAC_LOMAC</code></p>
</div>
<div class="paragraph">
<p>Boot option: <code>mac_lomac_load=&#34;YES&#34;</code></p>
</div>
<div class="paragraph">
<p>Unlike the MAC Biba policy, the <a href="https://man.freebsd.org/cgi/man.cgi?query=mac_lomac&amp;sektion=4&amp;format=html">mac_lomac(4)</a> policy permits access to lower integrity objects only after decreasing the integrity level to not disrupt any integrity rules.</p>
</div>
<div class="paragraph">
<p>The Low-watermark integrity policy works almost identically to Biba, with the exception of using floating labels to support subject demotion via an auxiliary grade compartment. This secondary compartment takes the form <code>[auxgrade]</code>. When assigning a policy with an auxiliary grade, use the syntax <code>lomac/10[2]</code>, where <code>2</code> is the auxiliary grade.</p>
</div>
<div class="paragraph">
<p>This policy relies on the ubiquitous labeling of all system objects with integrity labels, permitting subjects to read from low integrity objects and then downgrading the label on the subject to prevent future writes to high integrity objects using <code>[auxgrade]</code>. The policy may provide greater compatibility and require less initial configuration than Biba.</p>
</div>
<div class="paragraph">
<p>Like the Biba and MLS policies, <code>setfmac</code> and <code>setpmac</code> are used to place labels on system objects:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># setfmac /usr/home/trhodes lomac/high[low]</span>
<span class="c"># getfmac /usr/home/trhodes lomac/high[low]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The auxiliary grade <code>low</code> is a feature provided only by the MACLOMAC policy.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mac-userlocked">18.6. User Lock Down<a class="anchor" href="#mac-userlocked"></a></h3>
<div class="paragraph">
<p>This example considers a relatively small storage system with fewer than fifty users. Users will have login capabilities and are permitted to store data and access resources.</p>
</div>
<div class="paragraph">
<p>For this scenario, the <a href="https://man.freebsd.org/cgi/man.cgi?query=mac_bsdextended&amp;sektion=4&amp;format=html">mac_bsdextended(4)</a> and <a href="https://man.freebsd.org/cgi/man.cgi?query=mac_seeotheruids&amp;sektion=4&amp;format=html">mac_seeotheruids(4)</a> policy modules could co-exist and block access to system objects while hiding user processes.</p>
</div>
<div class="paragraph">
<p>Begin by adding the following line to <span class="filename">/boot/loader.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>mac_seeotheruids_load=&#34;YES&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>The <a href="https://man.freebsd.org/cgi/man.cgi?query=mac_bsdextended&amp;sektion=4&amp;format=html">mac_bsdextended(4)</a> security policy module may be activated by adding this line to <span class="filename">/etc/rc.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>ugidfw_enable=&#34;YES&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>Default rules stored in <span class="filename">/etc/rc.bsdextended</span> will be loaded at system initialization. However, the default entries may need modification. Since this machine is expected only to service users, everything may be left commented out except the last two lines in order to force the loading of user owned system objects by default.</p>
</div>
<div class="paragraph">
<p>Add the required users to this machine and reboot. For testing purposes, try logging in as a different user across two consoles. Run <code>ps aux</code> to see if processes of other users are visible. Verify that running <a href="https://man.freebsd.org/cgi/man.cgi?query=ls&amp;sektion=1&amp;format=html">ls(1)</a> on another user’s home directory fails.</p>
</div>
<div class="paragraph">
<p>Do not try to test with the <code>root</code> user unless the specific <code>sysctl</code>s have been modified to block super user access.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When a new user is added, their <a href="https://man.freebsd.org/cgi/man.cgi?query=mac_bsdextended&amp;sektion=4&amp;format=html">mac_bsdextended(4)</a> rule will not be in the ruleset list. To update the ruleset quickly, unload the security policy module and reload it again using <a href="https://man.freebsd.org/cgi/man.cgi?query=kldunload&amp;sektion=8&amp;format=html">kldunload(8)</a> and <a href="https://man.freebsd.org/cgi/man.cgi?query=kldload&amp;sektion=8&amp;format=html">kldload(8)</a>.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect2">
<h3 id="mac-implementing">18.7. Nagios in a MAC Jail<a class="anchor" href="#mac-implementing"></a></h3>
<div class="paragraph">
<p>This section demonstrates the steps that are needed to implement the Nagios network monitoring system in a MAC environment. This is meant as an example which still requires the administrator to test that the implemented policy meets the security requirements of the network before using in a production environment.</p>
</div>
<div class="paragraph">
<p>This example requires <code>multilabel</code> to be set on each file system. It also assumes that <a class="package" href="https://cgit.freebsd.org/ports/tree/net-mgmt/nagios-plugins/">net-mgmt/nagios-plugins</a>, <a class="package" href="https://cgit.freebsd.org/ports/tree/net-mgmt/nagios/">net-mgmt/nagios</a>, and <a class="package" href="https://cgit.freebsd.org/ports/tree/www/apache22/">www/apache22</a> are all installed, configured, and working correctly before attempting the integration into the MAC framework.</p>
</div>
<div class="sect3">
<h4 id="_create_an_insecure_user_class">18.7.1. Create an Insecure User Class<a class="anchor" href="#_create_an_insecure_user_class"></a></h4>
<div class="paragraph">
<p>Begin the procedure by adding the following user class to <span class="filename">/etc/login.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>insecure:\
:copyright=/etc/COPYRIGHT:\
:welcome=/etc/motd:\
:setenv=MAIL=/var/mail/$,BLOCKSIZE=K:\
:path=~/bin:/sbin:/bin:/usr/sbin:/usr/bin:/usr/local/sbin:/usr/local/bin
:manpath=/usr/share/man /usr/local/man:\
:nologin=/usr/sbin/nologin:\
:cputime=1h30m:\
:datasize=8M:\
:vmemoryuse=100M:\
:stacksize=2M:\
:memorylocked=4M:\
:memoryuse=8M:\
:filesize=8M:\
:coredumpsize=8M:\
:openfiles=24:\
:maxproc=32:\
:priority=0:\
:requirehome:\
:passwordtime=91d:\
:umask=022:\
:ignoretime@:\
:label=biba/10(10-10):</pre>
</div>
</div>
<div class="paragraph">
<p>Then, add the following line to the default user class section:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>:label=biba/high:</pre>
</div>
</div>
<div class="paragraph">
<p>Save the edits and issue the following command to rebuild the database:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># cap_mkdb /etc/login.conf</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_configure_users">18.7.2. Configure Users<a class="anchor" href="#_configure_users"></a></h4>
<div class="paragraph">
<p>Set the <code>root</code> user to the default class using:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pw usermod root -L default</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>All user accounts that are not <code>root</code> will now require a login class. The login class is required, otherwise users will be refused access to common commands. The following <code>sh</code> script should do the trick:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># for x in `awk -F: &#39;($3 &gt;= 1001) &amp;&amp; ($3 != 65534) { print $1 }&#39; \</span>
	/etc/passwd<span class="sb">`</span>; <span class="k">do </span>pw usermod <span class="nv">$x</span> -L default; <span class="k">done</span>;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next, drop the <code>nagios</code> and <code>www</code> accounts into the insecure class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pw usermod nagios -L insecure</span>
<span class="c"># pw usermod www -L insecure</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_create_the_contexts_file">18.7.3. Create the Contexts File<a class="anchor" href="#_create_the_contexts_file"></a></h4>
<div class="paragraph">
<p>A contexts file should now be created as <span class="filename">/etc/policy.contexts</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre># This is the default BIBA policy for this system.

# System:
/var/run(/.*)?			biba/equal

/dev/(/.*)?			biba/equal

/var				biba/equal
/var/spool(/.*)?		biba/equal

/var/log(/.*)?			biba/equal

/tmp(/.*)?			biba/equal
/var/tmp(/.*)?			biba/equal

/var/spool/mqueue		biba/equal
/var/spool/clientmqueue		biba/equal

# For Nagios:
/usr/local/etc/nagios(/.*)?	biba/10

/var/spool/nagios(/.*)?		biba/10

# For apache
/usr/local/etc/apache(/.*)?	biba/10</pre>
</div>
</div>
<div class="paragraph">
<p>This policy enforces security by setting restrictions on the flow of information. In this specific configuration, users, including <code>root</code>, should never be allowed to access Nagios. Configuration files and processes that are a part of Nagios will be completely self contained or jailed.</p>
</div>
<div class="paragraph">
<p>This file will be read after running <code>setfsmac</code> on every file system. This example sets the policy on the root file system:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># setfsmac -ef /etc/policy.contexts /</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Next, add these edits to the main section of <span class="filename">/etc/mac.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>default_labels file ?biba
default_labels ifnet ?biba
default_labels process ?biba
default_labels socket ?biba</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_loader_configuration">18.7.4. Loader Configuration<a class="anchor" href="#_loader_configuration"></a></h4>
<div class="paragraph">
<p>To finish the configuration, add the following lines to <span class="filename">/boot/loader.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>mac_biba_load=&#34;YES&#34;
mac_seeotheruids_load=&#34;YES&#34;
security.mac.biba.trust_all_interfaces=1</pre>
</div>
</div>
<div class="paragraph">
<p>And the following line to the network card configuration stored in <span class="filename">/etc/rc.conf</span>. If the primary network configuration is done via DHCP, this may need to be configured manually after every system boot:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>maclabel biba/equal</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_testing_the_configuration">18.7.5. Testing the Configuration<a class="anchor" href="#_testing_the_configuration"></a></h4>
<div class="paragraph">
<p>First, ensure that the web server and Nagios will not be started on system initialization and reboot. Ensure that <code>root</code> cannot access any of the files in the Nagios configuration directory. If <code>root</code> can list the contents of <span class="filename">/var/spool/nagios</span>, something is wrong. Instead, a &#34;permission denied&#34; error should be returned.</p>
</div>
<div class="paragraph">
<p>If all seems well, Nagios, Apache, and Sendmail can now be started:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># cd /etc/mail &amp;&amp; make stop &amp;&amp; \</span>
setpmac biba/equal make start <span class="o">&amp;&amp;</span> setpmac biba/10<span class="se">\(</span>10-10<span class="se">\)</span> apachectl start <span class="o">&amp;&amp;</span> <span class="se">\</span>
setpmac biba/10<span class="se">\(</span>10-10<span class="se">\)</span> /usr/local/etc/rc.d/nagios.sh forcestart</code></pre>
</div>
</div>
<div class="paragraph">
<p>Double check to ensure that everything is working properly. If not, check the log files for error messages. If needed, use <a href="https://man.freebsd.org/cgi/man.cgi?query=sysctl&amp;sektion=8&amp;format=html">sysctl(8)</a> to disable the <a href="https://man.freebsd.org/cgi/man.cgi?query=mac_biba&amp;sektion=4&amp;format=html">mac_biba(4)</a> security policy module and try starting everything again as usual.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>root</code> user can still change the security enforcement and edit its configuration files. The following command will permit the degradation of the security policy to a lower grade for a newly spawned shell:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># setpmac biba/10 csh</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To block this from happening, force the user into a range using <a href="https://man.freebsd.org/cgi/man.cgi?query=login.conf&amp;sektion=5&amp;format=html">login.conf(5)</a>. If <a href="https://man.freebsd.org/cgi/man.cgi?query=setpmac&amp;sektion=8&amp;format=html">setpmac(8)</a> attempts to run a command outside of the compartment’s range, an error will be returned and the command will not be executed. In this case, set root to <code>biba/high(high-high)</code>.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mac-troubleshoot">18.8. Troubleshooting the MAC Framework<a class="anchor" href="#mac-troubleshoot"></a></h3>
<div class="paragraph">
<p>This section discusses common configuration errors and how to resolve them.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">The <code>multilabel</code> flag does not stay enabled on the root (<span class="filename">/</span>) partition</dt>
<dd>
<p>The following steps may resolve this transient error:</p>
</dd>
</dl>
</div>
<div class="exampleblock procedure">
<div class="content">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Edit <span class="filename">/etc/fstab</span> and set the root partition to <code>ro</code> for read-only.</p>
</li>
<li>
<p>Reboot into single user mode.</p>
</li>
<li>
<p>Run <code>tunefs -l enable</code> on <span class="filename">/</span>.</p>
</li>
<li>
<p>Reboot the system.</p>
</li>
<li>
<p>Run <code>mount -urw</code><span class="filename">/</span> and change the <code>ro</code> back to <code>rw</code> in <span class="filename">/etc/fstab</span> and reboot the system again.</p>
</li>
<li>
<p>Double-check the output from <code>mount</code> to ensure that <code>multilabel</code> has been properly set on the root file system.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">After establishing a secure environment with MAC, Xorg no longer starts</dt>
<dd>
<p>This could be caused by the MAC <code>partition</code> policy or by a mislabeling in one of the MAC labeling policies. To debug, try the following:</p>
</dd>
</dl>
</div>
<div class="exampleblock procedure">
<div class="content">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Check the error message. If the user is in the <code>insecure</code> class, the <code>partition</code> policy may be the culprit. Try setting the user’s class back to the <code>default</code> class and rebuild the database with <code>cap_mkdb</code>. If this does not alleviate the problem, go to step two.</p>
</li>
<li>
<p>Double-check that the label policies are set correctly for the user, Xorg, and the <span class="filename">/dev</span> entries.</p>
</li>
<li>
<p>If neither of these resolve the problem, send the error message and a description of the environment to the {freebsd-questions}.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">The <code>_secure_path: unable to stat .login_conf</code> error appears</dt>
<dd>
<p>This error can appear when a user attempts to switch from the <code>root</code> user to another user in the system. This message usually occurs when the user has a higher label setting than that of the user they are attempting to become. For instance, if <code>joe</code> has a default label of <code>biba/low</code> and <code>root</code> has a label of <code>biba/high</code>, <code>root</code> cannot view <code>joe</code>&#39;s home directory. This will happen whether or not <code>root</code> has used <code>su</code> to become <code>joe</code> as the Biba integrity model will not permit <code>root</code> to view objects set at a lower integrity level.</p>
</dd>
<dt class="hdlist1">The system no longer recognizes <code>root</code></dt>
<dd>
<p>When this occurs, <code>whoami</code> returns <code>0</code> and <code>su</code> returns <code>who are you?</code>.</p>
<div class="paragraph">
<p>This can happen if a labeling policy has been disabled by <a href="https://man.freebsd.org/cgi/man.cgi?query=sysctl&amp;sektion=8&amp;format=html">sysctl(8)</a> or the policy module was unloaded. If the policy is disabled, the login capabilities database needs to be reconfigured. Double check <span class="filename">/etc/login.conf</span> to ensure that all <code>label</code> options have been removed and rebuild the database with <code>cap_mkdb</code>.</p>
</div>
<div class="paragraph">
<p>This may also happen if a policy restricts access to <span class="filename">master.passwd</span>. This is usually caused by an administrator altering the file under a label which conflicts with the general policy being used by the system. In these cases, the user information would be read by the system and access would be blocked as the file has inherited the new label. Disable the policy using <a href="https://man.freebsd.org/cgi/man.cgi?query=sysctl&amp;sektion=8&amp;format=html">sysctl(8)</a> and everything should return to normal.</p>
</div>
</dd>
</dl>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="audit">Chapter 19. Security Event Auditing<a class="anchor" href="#audit"></a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="audit-synopsis">19.1. Synopsis<a class="anchor" href="#audit-synopsis"></a></h3>
<div class="paragraph">
<p>The FreeBSD operating system includes support for security event auditing. Event auditing supports reliable, fine-grained, and configurable logging of a variety of security-relevant system events, including logins, configuration changes, and file and network access. These log records can be invaluable for live system monitoring, intrusion detection, and postmortem analysis. FreeBSD implements Sun™&#39;s published Basic Security Module (BSM) Application Programming Interface (API) and file format, and is interoperable with the Solaris™ and Mac OS® X audit implementations.</p>
</div>
<div class="paragraph">
<p>This chapter focuses on the installation and configuration of event auditing. It explains audit policies and provides an example audit configuration.</p>
</div>
<div class="paragraph">
<p>After reading this chapter, you will know:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>What event auditing is and how it works.</p>
</li>
<li>
<p>How to configure event auditing on FreeBSD for users and processes.</p>
</li>
<li>
<p>How to review the audit trail using the audit reduction and review tools.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Before reading this chapter, you should:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Understand UNIX® and FreeBSD basics (<a href="./#basics">FreeBSD Basics</a>).</p>
</li>
<li>
<p>Be familiar with the basics of kernel configuration/compilation (<a href="./#kernelconfig">Configuring the FreeBSD Kernel</a>).</p>
</li>
<li>
<p>Have some familiarity with security and how it pertains to FreeBSD (<a href="./#security">Security</a>).</p>
</li>
</ul>
</div>
<div class="admonitionblock warning">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The audit facility has some known limitations. Not all security-relevant system events are auditable and some login mechanisms, such as Xorg-based display managers and third-party daemons, do not properly configure auditing for user login sessions.</p>
</div>
<div class="paragraph">
<p>The security event auditing facility is able to generate very detailed logs of system activity. On a busy system, trail file data can be very large when configured for high detail, exceeding gigabytes a week in some configurations. Administrators should take into account the disk space requirements associated with high volume audit configurations. For example, it may be desirable to dedicate a file system to <span class="filename">/var/audit</span> so that other file systems are not affected if the audit file system becomes full.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect2">
<h3 id="audit-inline-glossary">19.2. Key Terms<a class="anchor" href="#audit-inline-glossary"></a></h3>
<div class="paragraph">
<p>The following terms are related to security event auditing:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>event</em>: an auditable event is any event that can be logged using the audit subsystem. Examples of security-relevant events include the creation of a file, the building of a network connection, or a user logging in. Events are either &#34;attributable&#34;, meaning that they can be traced to an authenticated user, or &#34;non-attributable&#34;. Examples of non-attributable events are any events that occur before authentication in the login process, such as bad password attempts.</p>
</li>
<li>
<p><em>class</em>: a named set of related events which are used in selection expressions. Commonly used classes of events include &#34;file creation&#34; (fc), &#34;exec&#34; (ex), and &#34;login_logout&#34; (lo).</p>
</li>
<li>
<p><em>record</em>: an audit log entry describing a security event. Records contain a record event type, information on the subject (user) performing the action, date and time information, information on any objects or arguments, and a success or failure condition.</p>
</li>
<li>
<p><em>trail</em>: a log file consisting of a series of audit records describing security events. Trails are in roughly chronological order with respect to the time events completed. Only authorized processes are allowed to commit records to the audit trail.</p>
</li>
<li>
<p><em>selection expression</em>: a string containing a list of prefixes and audit event class names used to match events.</p>
</li>
<li>
<p><em>preselection</em>: the process by which the system identifies which events are of interest to the administrator. The preselection configuration uses a series of selection expressions to identify which classes of events to audit for which users, as well as global settings that apply to both authenticated and unauthenticated processes.</p>
</li>
<li>
<p><em>reduction</em>: the process by which records from existing audit trails are selected for preservation, printing, or analysis. Likewise, the process by which undesired audit records are removed from the audit trail. Using reduction, administrators can implement policies for the preservation of audit data. For example, detailed audit trails might be kept for one month, but after that, trails might be reduced in order to preserve only login information for archival purposes.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="audit-config">19.3. Audit Configuration<a class="anchor" href="#audit-config"></a></h3>
<div class="paragraph">
<p>User space support for event auditing is installed as part of the base FreeBSD operating system. Kernel support is available in the <span class="filename">GENERIC</span> kernel by default, and <a href="https://man.freebsd.org/cgi/man.cgi?query=auditd&amp;sektion=8&amp;format=html">auditd(8)</a> can be enabled by adding the following line to <span class="filename">/etc/rc.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>auditd_enable=&#34;YES&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>Then, start the audit daemon:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># service auditd start</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Users who prefer to compile a custom kernel must include the following line in their custom kernel configuration file:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>options	AUDIT</pre>
</div>
</div>
<div class="sect3">
<h4 id="_event_selection_expressions">19.3.1. Event Selection Expressions<a class="anchor" href="#_event_selection_expressions"></a></h4>
<div class="paragraph">
<p>Selection expressions are used in a number of places in the audit configuration to determine which events should be audited. Expressions contain a list of event classes to match. Selection expressions are evaluated from left to right, and two expressions are combined by appending one onto the other.</p>
</div>
<div class="paragraph">
<p><a href="#event-selection">Default Audit Event Classes</a> summarizes the default audit event classes:</p>
</div>
<table id="event-selection" class="tableblock frame-none grid-all stretch">
<caption class="title">表 31. Default Audit Event Classes</caption>
<colgroup>
<col style="width: 33.3333%;"/>
<col style="width: 33.3333%;"/>
<col style="width: 33.3334%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Class Name</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Action</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">all</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">all</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Match all event classes.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">aa</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">authentication and authorization</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ad</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">administrative</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Administrative actions performed on the system as a whole.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ap</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">application</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Application defined action.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">cl</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">file close</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Audit calls to the <code>close</code> system call.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ex</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">exec</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Audit program execution. Auditing of command line arguments and environmental variables is controlled via <a href="https://man.freebsd.org/cgi/man.cgi?query=audit_control&amp;sektion=5&amp;format=html">audit_control(5)</a> using the <code>argv</code> and <code>envv</code> parameters to the <code>policy</code> setting.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">fa</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">file attribute access</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Audit the access of object attributes such as <a href="https://man.freebsd.org/cgi/man.cgi?query=stat&amp;sektion=1&amp;format=html">stat(1)</a> and <a href="https://man.freebsd.org/cgi/man.cgi?query=pathconf&amp;sektion=2&amp;format=html">pathconf(2)</a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">fc</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">file create</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Audit events where a file is created as a result.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">fd</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">file delete</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Audit events where file deletion occurs.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">fm</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">file attribute modify</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Audit events where file attribute modification occurs, such as by <a href="https://man.freebsd.org/cgi/man.cgi?query=chown&amp;sektion=8&amp;format=html">chown(8)</a>, <a href="https://man.freebsd.org/cgi/man.cgi?query=chflags&amp;sektion=1&amp;format=html">chflags(1)</a>, and <a href="https://man.freebsd.org/cgi/man.cgi?query=flock&amp;sektion=2&amp;format=html">flock(2)</a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">fr</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">file read</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Audit events in which data is read or files are opened for reading.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">fw</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">file write</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Audit events in which data is written or files are written or modified.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">io</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ioctl</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Audit use of the <code>ioctl</code> system call.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ip</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ipc</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Audit various forms of Inter-Process Communication, including POSIX pipes and System V IPC operations.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">lo</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">login_logout</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Audit <a href="https://man.freebsd.org/cgi/man.cgi?query=login&amp;sektion=1&amp;format=html">login(1)</a> and <a href="https://man.freebsd.org/cgi/man.cgi?query=logout&amp;sektion=1&amp;format=html">logout(1)</a> events.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">na</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">non attributable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Audit non-attributable events.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">invalid class</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Match no audit events.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">nt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">network</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Audit events related to network actions such as <a href="https://man.freebsd.org/cgi/man.cgi?query=connect&amp;sektion=2&amp;format=html">connect(2)</a> and <a href="https://man.freebsd.org/cgi/man.cgi?query=accept&amp;sektion=2&amp;format=html">accept(2)</a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ot</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">other</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Audit miscellaneous events.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">pc</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">process</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Audit process operations such as <a href="https://man.freebsd.org/cgi/man.cgi?query=exec&amp;sektion=3&amp;format=html">exec(3)</a> and <a href="https://man.freebsd.org/cgi/man.cgi?query=exit&amp;sektion=3&amp;format=html">exit(3)</a>.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>These audit event classes may be customized by modifying the <span class="filename">audit_class</span> and <span class="filename">audit_event</span> configuration files.</p>
</div>
<div class="paragraph">
<p>Each audit event class may be combined with a prefix indicating whether successful/failed operations are matched, and whether the entry is adding or removing matching for the class and type. <a href="#event-prefixes">Prefixes for Audit Event Classes</a> summarizes the available prefixes:</p>
</div>
<table id="event-prefixes" class="tableblock frame-none grid-all stretch">
<caption class="title">表 32. Prefixes for Audit Event Classes</caption>
<colgroup>
<col style="width: 50%;"/>
<col style="width: 50%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Prefix</th>
<th class="tableblock halign-left valign-top">Action</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">+</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Audit successful events in this class.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Audit failed events in this class.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">^</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Audit neither successful nor failed events in this class.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">^+</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Do not audit successful events in this class.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">^-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Do not audit failed events in this class.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>If no prefix is present, both successful and failed instances of the event will be audited.</p>
</div>
<div class="paragraph">
<p>The following example selection string selects both successful and failed login/logout events, but only successful execution events:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>lo,+ex</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_configuration_files">19.3.2. Configuration Files<a class="anchor" href="#_configuration_files"></a></h4>
<div class="paragraph">
<p>The following configuration files for security event auditing are found in <span class="filename">/etc/security</span>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="filename">audit_class</span>: contains the definitions of the audit classes.</p>
</li>
<li>
<p><span class="filename">audit_control</span>: controls aspects of the audit subsystem, such as default audit classes, minimum disk space to leave on the audit log volume, and maximum audit trail size.</p>
</li>
<li>
<p><span class="filename">audit_event</span>: textual names and descriptions of system audit events and a list of which classes each event is in.</p>
</li>
<li>
<p><span class="filename">audit_user</span>: user-specific audit requirements to be combined with the global defaults at login.</p>
</li>
<li>
<p><span class="filename">audit_warn</span>: a customizable shell script used by <a href="https://man.freebsd.org/cgi/man.cgi?query=auditd&amp;sektion=8&amp;format=html">auditd(8)</a> to generate warning messages in exceptional situations, such as when space for audit records is running low or when the audit trail file has been rotated.</p>
</li>
</ul>
</div>
<div class="admonitionblock warning">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Audit configuration files should be edited and maintained carefully, as errors in configuration may result in improper logging of events.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>In most cases, administrators will only need to modify <span class="filename">audit_control</span> and <span class="filename">audit_user</span>. The first file controls system-wide audit properties and policies and the second file may be used to fine-tune auditing by user.</p>
</div>
<div class="sect4">
<h5 id="audit-auditcontrol">19.3.2.1. The <span class="filename">audit_control</span> File<a class="anchor" href="#audit-auditcontrol"></a></h5>
<div class="paragraph">
<p>A number of defaults for the audit subsystem are specified in <span class="filename">audit_control</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>dir:/var/audit
dist:off
flags:lo,aa
minfree:5
naflags:lo,aa
policy:cnt,argv
filesz:2M
expire-after:10M</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>dir</code> entry is used to set one or more directories where audit logs will be stored. If more than one directory entry appears, they will be used in order as they fill. It is common to configure audit so that audit logs are stored on a dedicated file system, in order to prevent interference between the audit subsystem and other subsystems if the file system fills.</p>
</div>
<div class="paragraph">
<p>If the <code>dist</code> field is set to <code>on</code> or <code>yes</code>, hard links will be created to all trail files in <span class="filename">/var/audit/dist</span>.</p>
</div>
<div class="paragraph">
<p>The <code>flags</code> field sets the system-wide default preselection mask for attributable events. In the example above, successful and failed login/logout events as well as authentication and authorization are audited for all users.</p>
</div>
<div class="paragraph">
<p>The <code>minfree</code> entry defines the minimum percentage of free space for the file system where the audit trail is stored.</p>
</div>
<div class="paragraph">
<p>The <code>naflags</code> entry specifies audit classes to be audited for non-attributed events, such as the login/logout process and authentication and authorization.</p>
</div>
<div class="paragraph">
<p>The <code>policy</code> entry specifies a comma-separated list of policy flags controlling various aspects of audit behavior. The <code>cnt</code> indicates that the system should continue running despite an auditing failure (this flag is highly recommended). The other flag, <code>argv</code>, causes command line arguments to the <a href="https://man.freebsd.org/cgi/man.cgi?query=execve&amp;sektion=2&amp;format=html">execve(2)</a> system call to be audited as part of command execution.</p>
</div>
<div class="paragraph">
<p>The <code>filesz</code> entry specifies the maximum size for an audit trail before automatically terminating and rotating the trail file. A value of <code>0</code> disables automatic log rotation. If the requested file size is below the minimum of 512k, it will be ignored and a log message will be generated.</p>
</div>
<div class="paragraph">
<p>The <code>expire-after</code> field specifies when audit log files will expire and be removed.</p>
</div>
</div>
<div class="sect4">
<h5 id="audit-audituser">19.3.2.2. The <span class="filename">audit_user</span> File<a class="anchor" href="#audit-audituser"></a></h5>
<div class="paragraph">
<p>The administrator can specify further audit requirements for specific users in <span class="filename">audit_user</span>. Each line configures auditing for a user via two fields: the <code>alwaysaudit</code> field specifies a set of events that should always be audited for the user, and the <code>neveraudit</code> field specifies a set of events that should never be audited for the user.</p>
</div>
<div class="paragraph">
<p>The following example entries audit login/logout events and successful command execution for <code>root</code> and file creation and successful command execution for <code>www</code>. If used with the default <span class="filename">audit_control</span>, the <code>lo</code> entry for <code>root</code> is redundant, and login/logout events will also be audited for <code>www</code>.</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>root:lo,+ex:no
www:fc,+ex:no</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="audit-administration">19.4. Working with Audit Trails<a class="anchor" href="#audit-administration"></a></h3>
<div class="paragraph">
<p>Since audit trails are stored in the BSM binary format, several built-in tools are available to modify or convert these trails to text. To convert trail files to a simple text format, use <code>praudit</code>. To reduce the audit trail file for analysis, archiving, or printing purposes, use <code>auditreduce</code>. This utility supports a variety of selection parameters, including event type, event class, user, date or time of the event, and the file path or object acted on.</p>
</div>
<div class="paragraph">
<p>For example, to dump the entire contents of a specified audit log in plain text:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># praudit /var/audit/AUDITFILE</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Where <em>AUDITFILE</em> is the audit log to dump.</p>
</div>
<div class="paragraph">
<p>Audit trails consist of a series of audit records made up of tokens, which <code>praudit</code> prints sequentially, one per line. Each token is of a specific type, such as <code>header</code> (an audit record header) or <code>path</code> (a file path from a name lookup). The following is an example of an <code>execve</code> event:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>header,133,10,execve(2),0,Mon Sep 25 15:58:03 2006, + 384 msec
exec arg,finger,doug
path,/usr/bin/finger
attribute,555,root,wheel,90,24918,104944
subject,robert,root,wheel,root,wheel,38439,38032,42086,128.232.9.100
return,success,0
trailer,133</pre>
</div>
</div>
<div class="paragraph">
<p>This audit represents a successful <code>execve</code> call, in which the command <code>finger doug</code> has been run. The <code>exec arg</code> token contains the processed command line presented by the shell to the kernel. The <code>path</code> token holds the path to the executable as looked up by the kernel. The <code>attribute</code> token describes the binary and includes the file mode. The <code>subject</code> token stores the audit user ID, effective user ID and group ID, real user ID and group ID, process ID, session ID, port ID, and login address. Notice that the audit user ID and real user ID differ as the user <code>robert</code> switched to the <code>root</code> account before running this command, but it is audited using the original authenticated user. The <code>return</code> token indicates the successful execution and the <code>trailer</code> concludes the record.</p>
</div>
<div class="paragraph">
<p>XML output format is also supported and can be selected by including <code>-x</code>.</p>
</div>
<div class="paragraph">
<p>Since audit logs may be very large, a subset of records can be selected using <code>auditreduce</code>. This example selects all audit records produced for the user <code>trhodes</code> stored in <span class="filename">AUDITFILE</span>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># auditreduce -u trhodes /var/audit/AUDITFILE | praudit</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Members of the <code>audit</code> group have permission to read audit trails in <span class="filename">/var/audit</span>. By default, this group is empty, so only the <code>root</code> user can read audit trails. Users may be added to the <code>audit</code> group in order to delegate audit review rights. As the ability to track audit log contents provides significant insight into the behavior of users and processes, it is recommended that the delegation of audit review rights be performed with caution.</p>
</div>
<div class="sect3">
<h4 id="_live_monitoring_using_audit_pipes">19.4.1. Live Monitoring Using Audit Pipes<a class="anchor" href="#_live_monitoring_using_audit_pipes"></a></h4>
<div class="paragraph">
<p>Audit pipes are cloning pseudo-devices which allow applications to tap the live audit record stream. This is primarily of interest to authors of intrusion detection and system monitoring applications. However, the audit pipe device is a convenient way for the administrator to allow live monitoring without running into problems with audit trail file ownership or log rotation interrupting the event stream. To track the live audit event stream:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># praudit /dev/auditpipe</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>By default, audit pipe device nodes are accessible only to the <code>root</code> user. To make them accessible to the members of the <code>audit</code> group, add a <code>devfs</code> rule to <span class="filename">/etc/devfs.rules</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>add path &#39;auditpipe*&#39; mode 0440 group audit</pre>
</div>
</div>
<div class="paragraph">
<p>See <a href="https://man.freebsd.org/cgi/man.cgi?query=devfs.rules&amp;sektion=5&amp;format=html">devfs.rules(5)</a> for more information on configuring the devfs file system.</p>
</div>
<div class="admonitionblock warning">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>It is easy to produce audit event feedback cycles, in which the viewing of each audit event results in the generation of more audit events. For example, if all network I/O is audited, and <code>praudit</code> is run from an SSH session, a continuous stream of audit events will be generated at a high rate, as each event being printed will generate another event. For this reason, it is advisable to run <code>praudit</code> on an audit pipe device from sessions without fine-grained I/O auditing.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect3">
<h4 id="_rotating_and_compressing_audit_trail_files">19.4.2. Rotating and Compressing Audit Trail Files<a class="anchor" href="#_rotating_and_compressing_audit_trail_files"></a></h4>
<div class="paragraph">
<p>Audit trails are written to by the kernel and managed by the audit daemon, <a href="https://man.freebsd.org/cgi/man.cgi?query=auditd&amp;sektion=8&amp;format=html">auditd(8)</a>. Administrators should not attempt to use <a href="https://man.freebsd.org/cgi/man.cgi?query=newsyslog.conf&amp;sektion=5&amp;format=html">newsyslog.conf(5)</a> or other tools to directly rotate audit logs. Instead, <code>audit</code> should be used to shut down auditing, reconfigure the audit system, and perform log rotation. The following command causes the audit daemon to create a new audit log and signal the kernel to switch to using the new log. The old log will be terminated and renamed, at which point it may then be manipulated by the administrator:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># audit -n</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If <a href="https://man.freebsd.org/cgi/man.cgi?query=auditd&amp;sektion=8&amp;format=html">auditd(8)</a> is not currently running, this command will fail and an error message will be produced.</p>
</div>
<div class="paragraph">
<p>Adding the following line to <span class="filename">/etc/crontab</span> will schedule this rotation every twelve hours:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>0     */12       *       *       *       root    /usr/sbin/audit -n</pre>
</div>
</div>
<div class="paragraph">
<p>The change will take effect once <span class="filename">/etc/crontab</span> is saved.</p>
</div>
<div class="paragraph">
<p>Automatic rotation of the audit trail file based on file size is possible using <code>filesz</code> in <span class="filename">audit_control</span> as described in <a href="#audit-auditcontrol">The <span class="filename">audit_control</span> File</a>.</p>
</div>
<div class="paragraph">
<p>As audit trail files can become very large, it is often desirable to compress or otherwise archive trails once they have been closed by the audit daemon. The <span class="filename">audit_warn</span> script can be used to perform customized operations for a variety of audit-related events, including the clean termination of audit trails when they are rotated. For example, the following may be added to <span class="filename">/etc/security/audit_warn</span> to compress audit trails on close:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>#
# Compress audit trail files on close.
#
if [ &#34;$1&#34; = closefile ]; then
        gzip -9 $2
fi</pre>
</div>
</div>
<div class="paragraph">
<p>Other archiving activities might include copying trail files to a centralized server, deleting old trail files, or reducing the audit trail to remove unneeded records. This script will be run only when audit trail files are cleanly terminated. It will not be run on trails left unterminated following an improper shutdown.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="disks">Chapter 20. Storage<a class="anchor" href="#disks"></a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="disks-synopsis">20.1. Synopsis<a class="anchor" href="#disks-synopsis"></a></h3>
<div class="paragraph">
<p>This chapter covers the use of disks and storage media in FreeBSD. This includes SCSI and IDE disks, CD and DVD media, memory-backed disks, and USB storage devices.</p>
</div>
<div class="paragraph">
<p>After reading this chapter, you will know:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>How to add additional hard disks to a FreeBSD system.</p>
</li>
<li>
<p>How to grow the size of a disk’s partition on FreeBSD.</p>
</li>
<li>
<p>How to configure FreeBSD to use USB storage devices.</p>
</li>
<li>
<p>How to use CD and DVD media on a FreeBSD system.</p>
</li>
<li>
<p>How to use the backup programs available under FreeBSD.</p>
</li>
<li>
<p>How to set up memory disks.</p>
</li>
<li>
<p>What file system snapshots are and how to use them efficiently.</p>
</li>
<li>
<p>How to use quotas to limit disk space usage.</p>
</li>
<li>
<p>How to encrypt disks and swap to secure them against attackers.</p>
</li>
<li>
<p>How to configure a highly available storage network.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Before reading this chapter, you should:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Know how to <a href="./#kernelconfig">configure and install a new FreeBSD kernel</a>.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="disks-adding">20.2. Adding Disks<a class="anchor" href="#disks-adding"></a></h3>
<div class="paragraph">
<p>This section describes how to add a new SATA disk to a machine that currently only has a single drive. First, turn off the computer and install the drive in the computer following the instructions of the computer, controller, and drive manufacturers. Reboot the system and become <code>root</code>.</p>
</div>
<div class="paragraph">
<p>Inspect <span class="filename">/var/run/dmesg.boot</span> to ensure the new disk was found. In this example, the newly added SATA drive will appear as <span class="filename">ada1</span>.</p>
</div>
<div class="paragraph">
<p>For this example, a single large partition will be created on the new disk. The <a href="http://en.wikipedia.org/wiki/GUID_Partition_Table">GPT</a> partitioning scheme will be used in preference to the older and less versatile MBR scheme.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If the disk to be added is not blank, old partition information can be removed with <code>gpart delete</code>. See <a href="https://man.freebsd.org/cgi/man.cgi?query=gpart&amp;sektion=8&amp;format=html">gpart(8)</a> for details.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>The partition scheme is created, and then a single partition is added. To improve performance on newer disks with larger hardware block sizes, the partition is aligned to one megabyte boundaries:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># gpart create -s GPT ada1</span>
<span class="c"># gpart add -t freebsd-ufs -a 1M ada1</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Depending on use, several smaller partitions may be desired. See <a href="https://man.freebsd.org/cgi/man.cgi?query=gpart&amp;sektion=8&amp;format=html">gpart(8)</a> for options to create partitions smaller than a whole disk.</p>
</div>
<div class="paragraph">
<p>The disk partition information can be viewed with <code>gpart show</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>gpart show ada1
<span class="gp">=&gt;        </span>34  1465146988  ada1  GPT  <span class="o">(</span>699G<span class="o">)</span>
          34        2014        - free -  <span class="o">(</span>1.0M<span class="o">)</span>
        2048  1465143296     1  freebsd-ufs  <span class="o">(</span>699G<span class="o">)</span>
  1465145344        1678        - free -  <span class="o">(</span>839K<span class="o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A file system is created in the new partition on the new disk:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># newfs -U /dev/ada1p1</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>An empty directory is created as a <em>mountpoint</em>, a location for mounting the new disk in the original disk’s file system:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># mkdir /newdisk</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, an entry is added to <span class="filename">/etc/fstab</span> so the new disk will be mounted automatically at startup:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>/dev/ada1p1	/newdisk	ufs	rw	2	2</pre>
</div>
</div>
<div class="paragraph">
<p>The new disk can be mounted manually, without restarting the system:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># mount /newdisk</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="disks-growing">20.3. Resizing and Growing Disks<a class="anchor" href="#disks-growing"></a></h3>
<div class="paragraph">
<p>A disk’s capacity can increase without any changes to the data already present. This happens commonly with virtual machines, when the virtual disk turns out to be too small and is enlarged. Sometimes a disk image is written to a USB memory stick, but does not use the full capacity. Here we describe how to resize or <em>grow</em> disk contents to take advantage of increased capacity.</p>
</div>
<div class="paragraph">
<p>Determine the device name of the disk to be resized by inspecting <span class="filename">/var/run/dmesg.boot</span>. In this example, there is only one SATA disk in the system, so the drive will appear as <span class="filename">ada0</span>.</p>
</div>
<div class="paragraph">
<p>List the partitions on the disk to see the current configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># gpart show ada0</span>
<span class="gp">=&gt;      </span>34  83886013  ada0  GPT  <span class="o">(</span>48G<span class="o">)</span> <span class="o">[</span>CORRUPT]
        34       128     1  freebsd-boot  <span class="o">(</span>64k<span class="o">)</span>
       162  79691648     2  freebsd-ufs  <span class="o">(</span>38G<span class="o">)</span>
  79691810   4194236     3  freebsd-swap  <span class="o">(</span>2G<span class="o">)</span>
  83886046         1        - free -  <span class="o">(</span>512B<span class="o">)</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If the disk was formatted with the <a href="http://en.wikipedia.org/wiki/GUID_Partition_Table">GPT</a> partitioning scheme, it may show as &#34;corrupted&#34; because the GPT backup partition table is no longer at the end of the drive. Fix the backup partition table with <code>gpart</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># gpart recover ada0</span>
ada0 recovered</code></pre>
</div>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Now the additional space on the disk is available for use by a new partition, or an existing partition can be expanded:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># gpart show ada0</span>
<span class="gp">=&gt;       </span>34  102399933  ada0  GPT  <span class="o">(</span>48G<span class="o">)</span>
         34        128     1  freebsd-boot  <span class="o">(</span>64k<span class="o">)</span>
        162   79691648     2  freebsd-ufs  <span class="o">(</span>38G<span class="o">)</span>
   79691810    4194236     3  freebsd-swap  <span class="o">(</span>2G<span class="o">)</span>
   83886046   18513921        - free -  <span class="o">(</span>8.8G<span class="o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Partitions can only be resized into contiguous free space. Here, the last partition on the disk is the swap partition, but the second partition is the one that needs to be resized. Swap partitions only contain temporary data, so it can safely be unmounted, deleted, and then recreate the third partition after resizing the second partition.</p>
</div>
<div class="paragraph">
<p>Disable the swap partition:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># swapoff /dev/ada0p3</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Delete the third partition, specified by the <code>-i</code> flag, from the disk <em>ada0</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># gpart delete -i 3 ada0</span>
ada0p3 deleted
<span class="c"># gpart show ada0</span>
<span class="gp">=&gt;       </span>34  102399933  ada0  GPT  <span class="o">(</span>48G<span class="o">)</span>
         34        128     1  freebsd-boot  <span class="o">(</span>64k<span class="o">)</span>
        162   79691648     2  freebsd-ufs  <span class="o">(</span>38G<span class="o">)</span>
   79691810   22708157        - free -  <span class="o">(</span>10G<span class="o">)</span></code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>There is risk of data loss when modifying the partition table of a mounted file system. It is best to perform the following steps on an unmounted file system while running from a live CD-ROM or USB device. However, if absolutely necessary, a mounted file system can be resized after disabling GEOM safety features:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysctl kern.geom.debugflags=16</span></code></pre>
</div>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Resize the partition, leaving room to recreate a swap partition of the desired size. The partition to resize is specified with <code>-i</code>, and the new desired size with <code>-s</code>. Optionally, alignment of the partition is controlled with <code>-a</code>. This only modifies the size of the partition. The file system in the partition will be expanded in a separate step.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># gpart resize -i 2 -s 47G -a 4k ada0</span>
ada0p2 resized
<span class="c"># gpart show ada0</span>
<span class="gp">=&gt;       </span>34  102399933  ada0  GPT  <span class="o">(</span>48G<span class="o">)</span>
         34        128     1  freebsd-boot  <span class="o">(</span>64k<span class="o">)</span>
        162   98566144     2  freebsd-ufs  <span class="o">(</span>47G<span class="o">)</span>
   98566306    3833661        - free -  <span class="o">(</span>1.8G<span class="o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Recreate the swap partition and activate it. If no size is specified with <code>-s</code>, all remaining space is used:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># gpart add -t freebsd-swap -a 4k ada0</span>
ada0p3 added
<span class="c"># gpart show ada0</span>
<span class="gp">=&gt;       </span>34  102399933  ada0  GPT  <span class="o">(</span>48G<span class="o">)</span>
         34        128     1  freebsd-boot  <span class="o">(</span>64k<span class="o">)</span>
        162   98566144     2  freebsd-ufs  <span class="o">(</span>47G<span class="o">)</span>
   98566306    3833661     3  freebsd-swap  <span class="o">(</span>1.8G<span class="o">)</span>
<span class="c"># swapon /dev/ada0p3</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Grow the UFS file system to use the new capacity of the resized partition:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># growfs /dev/ada0p2</span>
Device is mounted <span class="nb">read</span>-write; resizing will result <span class="k">in </span>temporary write suspension <span class="k">for</span> /.
It<span class="s1">&#39;s strongly recommended to make a backup before growing the file system.
OK to grow file system on /dev/ada0p2, mounted on /, from 38GB to 47GB? [Yes/No] Yes
super-block backups (for fsck -b #) at:
 80781312, 82063552, 83345792, 84628032, 85910272, 87192512, 88474752,
 89756992, 91039232, 92321472, 93603712, 94885952, 96168192, 97450432</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If the file system is ZFS, the resize is triggered by running the <code>online</code> subcommand with <code>-e</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zpool online -e zroot /dev/ada0p2</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Both the partition and the file system on it have now been resized to use the newly-available disk space.</p>
</div>
</div>
<div class="sect2">
<h3 id="usb-disks">20.4. USB Storage Devices<a class="anchor" href="#usb-disks"></a></h3>
<div class="paragraph">
<p>Many external storage solutions, such as hard drives, USB thumbdrives, and CD and DVD burners, use the Universal Serial Bus (USB). FreeBSD provides support for USB 1.x, 2.0, and 3.0 devices.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>USB 3.0 support is not compatible with some hardware, including Haswell (Lynx point) chipsets. If FreeBSD boots with a <code>failed with error 19</code> message, disable xHCI/USB3 in the system BIOS.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Support for USB storage devices is built into the <span class="filename">GENERIC</span> kernel. For a custom kernel, be sure that the following lines are present in the kernel configuration file:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>device scbus	# SCSI bus (required for ATA/SCSI)
device da	# Direct Access (disks)
device pass	# Passthrough device (direct ATA/SCSI access)
device uhci	# provides USB 1.x support
device ohci	# provides USB 1.x support
device ehci	# provides USB 2.0 support
device xhci	# provides USB 3.0 support
device usb	# USB Bus (required)
device umass	# Disks/Mass storage - Requires scbus and da
device cd	# needed for CD and DVD burners</pre>
</div>
</div>
<div class="paragraph">
<p>FreeBSD uses the <a href="https://man.freebsd.org/cgi/man.cgi?query=umass&amp;sektion=4&amp;format=html">umass(4)</a> driver which uses the SCSI subsystem to access USB storage devices. Since any USB device will be seen as a SCSI device by the system, if the USB device is a CD or DVD burner, do <em>not</em> include <code>device atapicam</code> in a custom kernel configuration file.</p>
</div>
<div class="paragraph">
<p>The rest of this section demonstrates how to verify that a USB storage device is recognized by FreeBSD and how to configure the device so that it can be used.</p>
</div>
<div class="sect3">
<h4 id="_device_configuration">20.4.1. Device Configuration<a class="anchor" href="#_device_configuration"></a></h4>
<div class="paragraph">
<p>To test the USB configuration, plug in the USB device. Use <code>dmesg</code> to confirm that the drive appears in the system message buffer. It should look something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">umass0: &lt;STECH Simple Drive, class 0/0, rev 2.00/1.04, addr 3&gt; on usbus0
umass0:  SCSI over Bulk-Only; quirks <span class="o">=</span> 0x0100
umass0:4:0:-1: Attached to scbus4
da0 at umass-sim0 bus 0 scbus4 target 0 lun 0
da0: &lt;STECH Simple Drive 1.04&gt; Fixed Direct Access SCSI-4 device
da0: Serial Number WD-WXE508CAN263
da0: 40.000MB/s transfers
da0: 152627MB <span class="o">(</span>312581808 512 byte sectors: 255H 63S/T 19457C<span class="o">)</span>
da0: <span class="nv">quirks</span><span class="o">=</span>0x2&lt;NO_6_BYTE&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The brand, device node (<span class="filename">da0</span>), speed, and size will differ according to the device.</p>
</div>
<div class="paragraph">
<p>Since the USB device is seen as a SCSI one, <code>camcontrol</code> can be used to list the USB storage devices attached to the system:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># camcontrol devlist</span>
&lt;STECH Simple Drive 1.04&gt;          at scbus4 target 0 lun 0 <span class="o">(</span>pass3,da0<span class="o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternately, <code>usbconfig</code> can be used to list the device. Refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=usbconfig&amp;sektion=8&amp;format=html">usbconfig(8)</a> for more information about this command.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># usbconfig</span>
ugen0.3: &lt;Simple Drive STECH&gt; at usbus0, <span class="nv">cfg</span><span class="o">=</span>0 <span class="nv">md</span><span class="o">=</span>HOST <span class="nv">spd</span><span class="o">=</span>HIGH <span class="o">(</span>480Mbps<span class="o">)</span> <span class="nv">pwr</span><span class="o">=</span>ON <span class="o">(</span>2mA<span class="o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If the device has not been formatted, refer to <a href="#disks-adding">Adding Disks</a> for instructions on how to format and create partitions on the USB drive. If the drive comes with a file system, it can be mounted by <code>root</code> using the instructions in <a href="./#mount-unmount">“Mounting and Unmounting File Systems”</a>.</p>
</div>
<div class="admonitionblock warning">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Allowing untrusted users to mount arbitrary media, by enabling <code>vfs.usermount</code> as described below, should not be considered safe from a security point of view. Most file systems were not built to safeguard against malicious devices.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>To make the device mountable as a normal user, one solution is to make all users of the device a member of the <code>operator</code> group using <a href="https://man.freebsd.org/cgi/man.cgi?query=pw&amp;sektion=8&amp;format=html">pw(8)</a>. Next, ensure that <code>operator</code> is able to read and write the device by adding these lines to <span class="filename">/etc/devfs.rules</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>[localrules=5]
add path &#39;da*&#39; mode 0660 group operator</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If internal SCSI disks are also installed in the system, change the second line as follows:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>add path &#39;da[3-9]*&#39; mode 0660 group operator</pre>
</div>
</div>
<div class="paragraph">
<p>This will exclude the first three SCSI disks (<span class="filename">da0</span> to <span class="filename">da2</span>) from belonging to the <code>operator</code> group. Replace <em>3</em> with the number of internal SCSI disks. Refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=devfs.rules&amp;sektion=5&amp;format=html">devfs.rules(5)</a> for more information about this file.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Next, enable the ruleset in <span class="filename">/etc/rc.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>devfs_system_ruleset=&#34;localrules&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>Then, instruct the system to allow regular users to mount file systems by adding the following line to <span class="filename">/etc/sysctl.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>vfs.usermount=1</pre>
</div>
</div>
<div class="paragraph">
<p>Since this only takes effect after the next reboot, use <code>sysctl</code> to set this variable now:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysctl vfs.usermount=1</span>
vfs.usermount: 0 -&gt; 1</code></pre>
</div>
</div>
<div class="paragraph">
<p>The final step is to create a directory where the file system is to be mounted. This directory needs to be owned by the user that is to mount the file system. One way to do that is for <code>root</code> to create a subdirectory owned by that user as <span class="filename">/mnt/username</span>. In the following example, replace <em>username</em> with the login name of the user and <em>usergroup</em> with the user’s primary group:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># mkdir /mnt/username</span>
<span class="c"># chown username:usergroup /mnt/username</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Suppose a USB thumbdrive is plugged in, and a device <span class="filename">/dev/da0s1</span> appears. If the device is formatted with a FAT file system, the user can mount it using:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>mount -t msdosfs -o -m<span class="o">=</span>644,-M<span class="o">=</span>755 /dev/da0s1 /mnt/username</code></pre>
</div>
</div>
<div class="paragraph">
<p>Before the device can be unplugged, it <em>must</em> be unmounted first:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>umount /mnt/username</code></pre>
</div>
</div>
<div class="paragraph">
<p>After device removal, the system message buffer will show messages similar to the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">umass0: at uhub3, port 2, addr 3 <span class="o">(</span>disconnected<span class="o">)</span>
da0 at umass-sim0 bus 0 scbus4 target 0 lun 0
da0: &lt;STECH Simple Drive 1.04&gt; s/n WD-WXE508CAN263          detached
<span class="o">(</span>da0:umass-sim0:0:0:0<span class="o">)</span>: Periph destroyed</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_automounting_removable_media">20.4.2. Automounting Removable Media<a class="anchor" href="#_automounting_removable_media"></a></h4>
<div class="paragraph">
<p>USB devices can be automatically mounted by uncommenting this line in <span class="filename">/etc/auto_master</span>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">/media		-media		-nosuid</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then add these lines to <span class="filename">/etc/devd.conf</span>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">notify 100 <span class="o">{</span>
	match <span class="s2">&#34;system&#34;</span> <span class="s2">&#34;GEOM&#34;</span>;
	match <span class="s2">&#34;subsystem&#34;</span> <span class="s2">&#34;DEV&#34;</span>;
	action <span class="s2">&#34;/usr/sbin/automount -c&#34;</span>;
<span class="o">}</span>;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Reload the configuration if <a href="https://man.freebsd.org/cgi/man.cgi?query=autofs&amp;sektion=5&amp;format=html">autofs(5)</a> and <a href="https://man.freebsd.org/cgi/man.cgi?query=devd&amp;sektion=8&amp;format=html">devd(8)</a> are already running:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># service automount restart</span>
<span class="c"># service devd restart</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><a href="https://man.freebsd.org/cgi/man.cgi?query=autofs&amp;sektion=5&amp;format=html">autofs(5)</a> can be set to start at boot by adding this line to <span class="filename">/etc/rc.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>autofs_enable=&#34;YES&#34;</pre>
</div>
</div>
<div class="paragraph">
<p><a href="https://man.freebsd.org/cgi/man.cgi?query=autofs&amp;sektion=5&amp;format=html">autofs(5)</a> requires <a href="https://man.freebsd.org/cgi/man.cgi?query=devd&amp;sektion=8&amp;format=html">devd(8)</a> to be enabled, as it is by default.</p>
</div>
<div class="paragraph">
<p>Start the services immediately with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># service automount start</span>
<span class="c"># service automountd start</span>
<span class="c"># service autounmountd start</span>
<span class="c"># service devd start</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Each file system that can be automatically mounted appears as a directory in <span class="filename">/media/</span>. The directory is named after the file system label. If the label is missing, the directory is named after the device node.</p>
</div>
<div class="paragraph">
<p>The file system is transparently mounted on the first access, and unmounted after a period of inactivity. Automounted drives can also be unmounted manually:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># automount -fu</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This mechanism is typically used for memory cards and USB memory sticks. It can be used with any block device, including optical drives or iSCSILUNs.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="creating-cds">20.5. Creating and Using CD Media<a class="anchor" href="#creating-cds"></a></h3>
<div class="paragraph">
<p>Compact Disc (CD) media provide a number of features that differentiate them from conventional disks. They are designed so that they can be read continuously without delays to move the head between tracks. While CD media do have tracks, these refer to a section of data to be read continuously, and not a physical property of the disk. The ISO 9660 file system was designed to deal with these differences.</p>
</div>
<div class="paragraph">
<p>The FreeBSD Ports Collection provides several utilities for burning and duplicating audio and data CDs. This chapter demonstrates the use of several command line utilities. For CD burning software with a graphical utility, consider installing the <a class="package" href="https://cgit.freebsd.org/ports/tree/sysutils/xcdroast/">sysutils/xcdroast</a> or <a class="package" href="https://cgit.freebsd.org/ports/tree/sysutils/k3b/">sysutils/k3b</a> packages or ports.</p>
</div>
<div class="sect3">
<h4 id="atapicam">20.5.1. Supported Devices<a class="anchor" href="#atapicam"></a></h4>
<div class="paragraph">
<p>The <span class="filename">GENERIC</span> kernel provides support for SCSI, USB, and ATAPICD readers and burners. If a custom kernel is used, the options that need to be present in the kernel configuration file vary by the type of device.</p>
</div>
<div class="paragraph">
<p>For a SCSI burner, make sure these options are present:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>device scbus	# SCSI bus (required for ATA/SCSI)
device da	# Direct Access (disks)
device pass	# Passthrough device (direct ATA/SCSI access)
device cd	# needed for CD and DVD burners</pre>
</div>
</div>
<div class="paragraph">
<p>For a USB burner, make sure these options are present:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>device scbus	# SCSI bus (required for ATA/SCSI)
device da	# Direct Access (disks)
device pass	# Passthrough device (direct ATA/SCSI access)
device cd	# needed for CD and DVD burners
device uhci	# provides USB 1.x support
device ohci	# provides USB 1.x support
device ehci	# provides USB 2.0 support
device xhci	# provides USB 3.0 support
device usb	# USB Bus (required)
device umass	# Disks/Mass storage - Requires scbus and da</pre>
</div>
</div>
<div class="paragraph">
<p>For an ATAPI burner, make sure these options are present:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>device ata	# Legacy ATA/SATA controllers
device scbus	# SCSI bus (required for ATA/SCSI)
device pass	# Passthrough device (direct ATA/SCSI access)
device cd	# needed for CD and DVD burners</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>On FreeBSD versions prior to 10.x, this line is also needed in the kernel configuration file if the burner is an ATAPI device:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>device atapicam</pre>
</div>
</div>
<div class="paragraph">
<p>Alternately, this driver can be loaded at boot time by adding the following line to <span class="filename">/boot/loader.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>atapicam_load=&#34;YES&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>This will require a reboot of the system as this driver can only be loaded at boot time.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>To verify that FreeBSD recognizes the device, run <code>dmesg</code> and look for an entry for the device. On systems prior to 10.x, the device name in the first line of the output will be <span class="filename">acd0</span> instead of <span class="filename">cd0</span>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>dmesg | grep <span class="nb">cd
</span>cd0 at ahcich1 bus 0 scbus1 target 0 lun 0
cd0: &lt;HL-DT-ST DVDRAM GU70N LT20&gt; Removable CD-ROM SCSI-0 device
cd0: Serial Number M3OD3S34152
cd0: 150.000MB/s transfers <span class="o">(</span>SATA 1.x, UDMA6, ATAPI 12bytes, PIO 8192bytes<span class="o">)</span>
cd0: Attempt to query device size failed: NOT READY, Medium not present - tray closed</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="cdrecord">20.5.2. Burning a CD<a class="anchor" href="#cdrecord"></a></h4>
<div class="paragraph">
<p>In FreeBSD, <code>cdrecord</code> can be used to burn CDs. This command is installed with the <a class="package" href="https://cgit.freebsd.org/ports/tree/sysutils/cdrtools/">sysutils/cdrtools</a> package or port.</p>
</div>
<div class="paragraph">
<p>While <code>cdrecord</code> has many options, basic usage is simple. Specify the name of the ISO file to burn and, if the system has multiple burner devices, specify the name of the device to use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># cdrecord dev=device imagefile.iso</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To determine the device name of the burner, use <code>-scanbus</code> which might produce results like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># cdrecord -scanbus</span>
ProDVD-ProBD-Clone 3.00 <span class="o">(</span>amd64-unknown-freebsd10.0<span class="o">)</span> Copyright <span class="o">(</span>C<span class="o">)</span> 1995-2010 Jörg Schilling
Using libscg version <span class="s1">&#39;schily-0.9&#39;</span>
scsibus0:
        0,0,0     0<span class="o">)</span> <span class="s1">&#39;SEAGATE &#39;</span> <span class="s1">&#39;ST39236LW       &#39;</span> <span class="s1">&#39;0004&#39;</span> Disk
        0,1,0     1<span class="o">)</span> <span class="s1">&#39;SEAGATE &#39;</span> <span class="s1">&#39;ST39173W        &#39;</span> <span class="s1">&#39;5958&#39;</span> Disk
        0,2,0     2<span class="o">)</span> <span class="k">*</span>
        0,3,0     3<span class="o">)</span> <span class="s1">&#39;iomega  &#39;</span> <span class="s1">&#39;jaz 1GB         &#39;</span> <span class="s1">&#39;J.86&#39;</span> Removable Disk
        0,4,0     4<span class="o">)</span> <span class="s1">&#39;NEC     &#39;</span> <span class="s1">&#39;CD-ROM DRIVE:466&#39;</span> <span class="s1">&#39;1.26&#39;</span> Removable CD-ROM
        0,5,0     5<span class="o">)</span> <span class="k">*</span>
        0,6,0     6<span class="o">)</span> <span class="k">*</span>
        0,7,0     7<span class="o">)</span> <span class="k">*</span>
scsibus1:
        1,0,0   100<span class="o">)</span> <span class="k">*</span>
        1,1,0   101<span class="o">)</span> <span class="k">*</span>
        1,2,0   102<span class="o">)</span> <span class="k">*</span>
        1,3,0   103<span class="o">)</span> <span class="k">*</span>
        1,4,0   104<span class="o">)</span> <span class="k">*</span>
        1,5,0   105<span class="o">)</span> <span class="s1">&#39;YAMAHA  &#39;</span> <span class="s1">&#39;CRW4260         &#39;</span> <span class="s1">&#39;1.0q&#39;</span> Removable CD-ROM
        1,6,0   106<span class="o">)</span> <span class="s1">&#39;ARTEC   &#39;</span> <span class="s1">&#39;AM12S           &#39;</span> <span class="s1">&#39;1.06&#39;</span> Scanner
        1,7,0   107<span class="o">)</span> <span class="k">*</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Locate the entry for the CD burner and use the three numbers separated by commas as the value for <code>dev</code>. In this case, the Yamaha burner device is <code>1,5,0</code>, so the appropriate input to specify that device is <code>dev=1,5,0</code>. Refer to the manual page for <code>cdrecord</code> for other ways to specify this value and for information on writing audio tracks and controlling the write speed.</p>
</div>
<div class="paragraph">
<p>Alternately, run the following command to get the device address of the burner:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># camcontrol devlist</span>
&lt;MATSHITA CDRW/DVD UJDA740 1.00&gt;   at scbus1 target 0 lun 0 <span class="o">(</span>cd0,pass0<span class="o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Use the numeric values for <code>scbus</code>, <code>target</code>, and <code>lun</code>. For this example, <code>1,0,0</code> is the device name to use.</p>
</div>
</div>
<div class="sect3">
<h4 id="mkisofs">20.5.3. Writing Data to an ISO File System<a class="anchor" href="#mkisofs"></a></h4>
<div class="paragraph">
<p>In order to produce a data CD, the data files that are going to make up the tracks on the CD must be prepared before they can be burned to the CD. In FreeBSD, <a class="package" href="https://cgit.freebsd.org/ports/tree/sysutils/cdrtools/">sysutils/cdrtools</a> installs <code>mkisofs</code>, which can be used to produce an ISO 9660 file system that is an image of a directory tree within a UNIX® file system. The simplest usage is to specify the name of the ISO file to create and the path to the files to place into the ISO 9660 file system:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># mkisofs -o imagefile.iso /path/to/tree</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This command maps the file names in the specified path to names that fit the limitations of the standard ISO 9660 file system, and will exclude files that do not meet the standard for ISO file systems.</p>
</div>
<div class="paragraph">
<p>A number of options are available to overcome the restrictions imposed by the standard. In particular, <code>-R</code> enables the Rock Ridge extensions common to UNIX® systems and <code>-J</code> enables Joliet extensions used by Microsoft® systems.</p>
</div>
<div class="paragraph">
<p>For CDs that are going to be used only on FreeBSD systems, <code>-U</code> can be used to disable all filename restrictions. When used with <code>-R</code>, it produces a file system image that is identical to the specified FreeBSD tree, even if it violates the ISO 9660 standard.</p>
</div>
<div class="paragraph">
<p>The last option of general use is <code>-b</code>. This is used to specify the location of a boot image for use in producing an &#34;El Torito&#34; bootable CD. This option takes an argument which is the path to a boot image from the top of the tree being written to the CD. By default, <code>mkisofs</code> creates an ISO image in &#34;floppy disk emulation&#34; mode, and thus expects the boot image to be exactly 1200, 1440 or 2880 KB in size. Some boot loaders, like the one used by the FreeBSD distribution media, do not use emulation mode. In this case, <code>-no-emul-boot</code> should be used. So, if <span class="filename">/tmp/myboot</span> holds a bootable FreeBSD system with the boot image in <span class="filename">/tmp/myboot/boot/cdboot</span>, this command would produce <span class="filename">/tmp/bootable.iso</span>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># mkisofs -R -no-emul-boot -b boot/cdboot -o /tmp/bootable.iso /tmp/myboot</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The resulting ISO image can be mounted as a memory disk with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># mdconfig -a -t vnode -f /tmp/bootable.iso -u 0</span>
<span class="c"># mount -t cd9660 /dev/md0 /mnt</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>One can then verify that <span class="filename">/mnt</span> and <span class="filename">/tmp/myboot</span> are identical.</p>
</div>
<div class="paragraph">
<p>There are many other options available for <code>mkisofs</code> to fine-tune its behavior. Refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=mkisofs&amp;sektion=8&amp;format=html">mkisofs(8)</a> for details.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>It is possible to copy a data CD to an image file that is functionally equivalent to the image file created with <code>mkisofs</code>. To do so, use <span class="filename">dd</span> with the device name as the input file and the name of the ISO to create as the output file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># dd if=/dev/cd0 of=file.iso bs=2048</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The resulting image file can be burned to CD as described in <a href="#cdrecord">Burning a CD</a>.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect3">
<h4 id="mounting-cd">20.5.4. Using Data CDs<a class="anchor" href="#mounting-cd"></a></h4>
<div class="paragraph">
<p>Once an ISO has been burned to a CD, it can be mounted by specifying the file system type, the name of the device containing the CD, and an existing mount point:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># mount -t cd9660 /dev/cd0 /mnt</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Since <code>mount</code> assumes that a file system is of type <code>ufs</code>, an <code>Incorrect super block</code> error will occur if <code>-t cd9660</code> is not included when mounting a data CD.</p>
</div>
<div class="paragraph">
<p>While any data CD can be mounted this way, disks with certain ISO 9660 extensions might behave oddly. For example, Joliet disks store all filenames in two-byte Unicode characters. If some non-English characters show up as question marks, specify the local charset with <code>-C</code>. For more information, refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=mount_cd9660&amp;sektion=8&amp;format=html">mount_cd9660(8)</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In order to do this character conversion with the help of <code>-C</code>, the kernel requires the <span class="filename">cd9660_iconv.ko</span> module to be loaded. This can be done either by adding this line to <span class="filename">loader.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>cd9660_iconv_load=&#34;YES&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>and then rebooting the machine, or by directly loading the module with <code>kldload</code>.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Occasionally, <code>Device not configured</code> will be displayed when trying to mount a data CD. This usually means that the CD drive has not detected a disk in the tray, or that the drive is not visible on the bus. It can take a couple of seconds for a CD drive to detect media, so be patient.</p>
</div>
<div class="paragraph">
<p>Sometimes, a SCSICD drive may be missed because it did not have enough time to answer the bus reset. To resolve this, a custom kernel can be created which increases the default SCSI delay. Add the following option to the custom kernel configuration file and rebuild the kernel using the instructions in <a href="./#kernelconfig-building">“Building and Installing a Custom Kernel”</a>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>options SCSI_DELAY=15000</pre>
</div>
</div>
<div class="paragraph">
<p>This tells the SCSI bus to pause 15 seconds during boot, to give the CD drive every possible chance to answer the bus reset.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>It is possible to burn a file directly to CD, without creating an ISO 9660 file system. This is known as burning a raw data CD and some people do this for backup purposes.</p>
</div>
<div class="paragraph">
<p>This type of disk can not be mounted as a normal data CD. In order to retrieve the data burned to such a CD, the data must be read from the raw device node. For example, this command will extract a compressed tar file located on the second CD device into the current working directory:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># tar xzvf /dev/cd1</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In order to mount a data CD, the data must be written using <code>mkisofs</code>.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect3">
<h4 id="duplicating-audiocds">20.5.5. Duplicating Audio CDs<a class="anchor" href="#duplicating-audiocds"></a></h4>
<div class="paragraph">
<p>To duplicate an audio CD, extract the audio data from the CD to a series of files, then write these files to a blank CD.</p>
</div>
<div class="paragraph">
<p><a href="#using-cdrecord">Procedure: Duplicating an Audio CD</a> describes how to duplicate and burn an audio CD. If the FreeBSD version is less than 10.0 and the device is ATAPI, the <code>atapicam</code> module must be first loaded using the instructions in <a href="#atapicam">Supported Devices</a>.</p>
</div>
<div id="using-cdrecord" class="olist arabic procedure">
<div class="title">Procedure: Duplicating an Audio CD</div>
<ol class="arabic">
<li>
<p>The <a class="package" href="https://cgit.freebsd.org/ports/tree/sysutils/cdrtools/">sysutils/cdrtools</a> package or port installs <code>cdda2wav</code>. This command can be used to extract all of the audio tracks, with each track written to a separate WAV file in the current working directory:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>cdda2wav -vall -B -Owav</code></pre>
</div>
</div>
<div class="paragraph">
<p>A device name does not need to be specified if there is only one CD device on the system. Refer to the <code>cdda2wav</code> manual page for instructions on how to specify a device and to learn more about the other options available for this command.</p>
</div>
</li>
<li>
<p>Use <code>cdrecord</code> to write the <span class="filename">.wav</span> files:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>cdrecord -v <span class="nv">dev</span><span class="o">=</span>2,0 -dao -useinfo  <span class="k">*</span>.wav</code></pre>
</div>
</div>
<div class="paragraph">
<p>Make sure that <em>2,0</em> is set appropriately, as described in <a href="#cdrecord">Burning a CD</a>.</p>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="creating-dvds">20.6. Creating and Using DVD Media<a class="anchor" href="#creating-dvds"></a></h3>
<div class="paragraph">
<p>Compared to the CD, the DVD is the next generation of optical media storage technology. The DVD can hold more data than any CD and is the standard for video publishing.</p>
</div>
<div class="paragraph">
<p>Five physical recordable formats can be defined for a recordable DVD:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>DVD-R: This was the first DVD recordable format available. The DVD-R standard is defined by the <a href="http://www.dvdforum.org/forum.shtml">DVD Forum</a>. This format is write once.</p>
</li>
<li>
<p>DVD-RW: This is the rewritable version of the DVD-R standard. A DVD-RW can be rewritten about 1000 times.</p>
</li>
<li>
<p>DVD-RAM: This is a rewritable format which can be seen as a removable hard drive. However, this media is not compatible with most DVD-ROM drives and DVD-Video players as only a few DVD writers support the DVD-RAM format. Refer to <a href="#creating-dvd-ram">Using a DVD-RAM</a> for more information on DVD-RAM use.</p>
</li>
<li>
<p>DVD+RW: This is a rewritable format defined by the <a href="https://en.wikipedia.org/wiki/DVD%2BRW_Alliance">DVD+RW Alliance</a>. A DVD+RW can be rewritten about 1000 times.</p>
</li>
<li>
<p>DVD+R: This format is the write once variation of the DVD+RW format.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A single layer recordable DVD can hold up to 4,700,000,000 bytes which is actually 4.38 GB or 4485 MB as 1 kilobyte is 1024 bytes.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A distinction must be made between the physical media and the application. For example, a DVD-Video is a specific file layout that can be written on any recordable DVD physical media such as DVD-R, DVD+R, or DVD-RW. Before choosing the type of media, ensure that both the burner and the DVD-Video player are compatible with the media under consideration.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="sect3">
<h4 id="_configuration">20.6.1. Configuration<a class="anchor" href="#_configuration"></a></h4>
<div class="paragraph">
<p>To perform DVD recording, use <a href="https://man.freebsd.org/cgi/man.cgi?query=growisofs&amp;sektion=1&amp;format=html">growisofs(1)</a>. This command is part of the <a class="package" href="https://cgit.freebsd.org/ports/tree/sysutils/dvd+rw-tools/">sysutils/dvd+rw-tools</a> utilities which support all DVD media types.</p>
</div>
<div class="paragraph">
<p>These tools use the SCSI subsystem to access the devices, therefore <a href="#atapicam">ATAPI/CAM support</a> must be loaded or statically compiled into the kernel. This support is not needed if the burner uses the USB interface. Refer to <a href="#usb-disks">USB Storage Devices</a> for more details on USB device configuration.</p>
</div>
<div class="paragraph">
<p>DMA access must also be enabled for ATAPI devices, by adding the following line to <span class="filename">/boot/loader.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>hw.ata.atapi_dma=&#34;1&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>Before attempting to use dvd+rw-tools, consult the <a href="http://fy.chalmers.se/~appro/linux/DVD+RW/hcn.html">Hardware Compatibility Notes</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>For a graphical user interface, consider using <a class="package" href="https://cgit.freebsd.org/ports/tree/sysutils/k3b/">sysutils/k3b</a> which provides a user friendly interface to <a href="https://man.freebsd.org/cgi/man.cgi?query=growisofs&amp;sektion=1&amp;format=html">growisofs(1)</a> and many other burning tools.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect3">
<h4 id="_burning_data_dvds">20.6.2. Burning Data DVDs<a class="anchor" href="#_burning_data_dvds"></a></h4>
<div class="paragraph">
<p>Since <a href="https://man.freebsd.org/cgi/man.cgi?query=growisofs&amp;sektion=1&amp;format=html">growisofs(1)</a> is a front-end to <a href="#mkisofs">mkisofs</a>, it will invoke <a href="https://man.freebsd.org/cgi/man.cgi?query=mkisofs&amp;sektion=8&amp;format=html">mkisofs(8)</a> to create the file system layout and perform the write on the DVD. This means that an image of the data does not need to be created before the burning process.</p>
</div>
<div class="paragraph">
<p>To burn to a DVD+R or a DVD-R the data in <span class="filename">/path/to/data</span>, use the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># growisofs -dvd-compat -Z /dev/cd0 -J -R /path/to/data</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example, <code>-J -R</code> is passed to <a href="https://man.freebsd.org/cgi/man.cgi?query=mkisofs&amp;sektion=8&amp;format=html">mkisofs(8)</a> to create an ISO 9660 file system with Joliet and Rock Ridge extensions. Refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=mkisofs&amp;sektion=8&amp;format=html">mkisofs(8)</a> for more details.</p>
</div>
<div class="paragraph">
<p>For the initial session recording, <code>-Z</code> is used for both single and multiple sessions. Replace <em>/dev/cd0</em>, with the name of the DVD device. Using <code>-dvd-compat</code> indicates that the disk will be closed and that the recording will be unappendable. This should also provide better media compatibility with DVD-ROM drives.</p>
</div>
<div class="paragraph">
<p>To burn a pre-mastered image, such as <em>imagefile.iso</em>, use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># growisofs -dvd-compat -Z /dev/cd0=imagefile.iso</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The write speed should be detected and automatically set according to the media and the drive being used. To force the write speed, use <code>-speed=</code>. Refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=growisofs&amp;sektion=1&amp;format=html">growisofs(1)</a> for example usage.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In order to support working files larger than 4.38GB, an UDF/ISO-9660 hybrid file system must be created by passing <code>-udf -iso-level 3</code> to <a href="https://man.freebsd.org/cgi/man.cgi?query=mkisofs&amp;sektion=8&amp;format=html">mkisofs(8)</a> and all related programs, such as <a href="https://man.freebsd.org/cgi/man.cgi?query=growisofs&amp;sektion=1&amp;format=html">growisofs(1)</a>. This is required only when creating an ISO image file or when writing files directly to a disk. Since a disk created this way must be mounted as an UDF file system with <a href="https://man.freebsd.org/cgi/man.cgi?query=mount_udf&amp;sektion=8&amp;format=html">mount_udf(8)</a>, it will be usable only on an UDF aware operating system. Otherwise it will look as if it contains corrupted files.</p>
</div>
<div class="paragraph">
<p>To create this type of ISO file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>mkisofs -R -J -udf -iso-level 3 -o imagefile.iso /path/to/data</code></pre>
</div>
</div>
<div class="paragraph">
<p>To burn files directly to a disk:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># growisofs -dvd-compat -udf -iso-level 3 -Z /dev/cd0 -J -R /path/to/data</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When an ISO image already contains large files, no additional options are required for <a href="https://man.freebsd.org/cgi/man.cgi?query=growisofs&amp;sektion=1&amp;format=html">growisofs(1)</a> to burn that image on a disk.</p>
</div>
<div class="paragraph">
<p>Be sure to use an up-to-date version of <a class="package" href="https://cgit.freebsd.org/ports/tree/sysutils/cdrtools/">sysutils/cdrtools</a>, which contains <a href="https://man.freebsd.org/cgi/man.cgi?query=mkisofs&amp;sektion=8&amp;format=html">mkisofs(8)</a>, as an older version may not contain large files support. If the latest version does not work, install <a class="package" href="https://cgit.freebsd.org/ports/tree/sysutils/cdrtools-devel/">sysutils/cdrtools-devel</a> and read its <a href="https://man.freebsd.org/cgi/man.cgi?query=mkisofs&amp;sektion=8&amp;format=html">mkisofs(8)</a>.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect3">
<h4 id="_burning_a_dvd_video">20.6.3. Burning a DVD-Video<a class="anchor" href="#_burning_a_dvd_video"></a></h4>
<div class="paragraph">
<p>A DVD-Video is a specific file layout based on the ISO 9660 and micro-UDF (M-UDF) specifications. Since DVD-Video presents a specific data structure hierarchy, a particular program such as <a class="package" href="https://cgit.freebsd.org/ports/tree/multimedia/dvdauthor/">multimedia/dvdauthor</a> is needed to author the DVD.</p>
</div>
<div class="paragraph">
<p>If an image of the DVD-Video file system already exists, it can be burned in the same way as any other image. If <code>dvdauthor</code> was used to make the DVD and the result is in <span class="filename">/path/to/video</span>, the following command should be used to burn the DVD-Video:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># growisofs -Z /dev/cd0 -dvd-video /path/to/video</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>-dvd-video</code> is passed to <a href="https://man.freebsd.org/cgi/man.cgi?query=mkisofs&amp;sektion=8&amp;format=html">mkisofs(8)</a> to instruct it to create a DVD-Video file system layout. This option implies the <code>-dvd-compat</code> <a href="https://man.freebsd.org/cgi/man.cgi?query=growisofs&amp;sektion=1&amp;format=html">growisofs(1)</a> option.</p>
</div>
</div>
<div class="sect3">
<h4 id="_using_a_dvdrw">20.6.4. Using a DVD+RW<a class="anchor" href="#_using_a_dvdrw"></a></h4>
<div class="paragraph">
<p>Unlike CD-RW, a virgin DVD+RW needs to be formatted before first use. It is <em>recommended</em> to let <a href="https://man.freebsd.org/cgi/man.cgi?query=growisofs&amp;sektion=1&amp;format=html">growisofs(1)</a> take care of this automatically whenever appropriate. However, it is possible to use <code>dvd+rw-format</code> to format the DVD+RW:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># dvd+rw-format /dev/cd0</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Only perform this operation once and keep in mind that only virgin DVD+RW medias need to be formatted. Once formatted, the DVD+RW can be burned as usual.</p>
</div>
<div class="paragraph">
<p>To burn a totally new file system and not just append some data onto a DVD+RW, the media does not need to be blanked first. Instead, write over the previous recording like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># growisofs -Z /dev/cd0 -J -R /path/to/newdata</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The DVD+RW format supports appending data to a previous recording. This operation consists of merging a new session to the existing one as it is not considered to be multi-session writing. <a href="https://man.freebsd.org/cgi/man.cgi?query=growisofs&amp;sektion=1&amp;format=html">growisofs(1)</a> will <em>grow</em> the ISO 9660 file system present on the media.</p>
</div>
<div class="paragraph">
<p>For example, to append data to a DVD+RW, use the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># growisofs -M /dev/cd0 -J -R /path/to/nextdata</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The same <a href="https://man.freebsd.org/cgi/man.cgi?query=mkisofs&amp;sektion=8&amp;format=html">mkisofs(8)</a> options used to burn the initial session should be used during next writes.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Use <code>-dvd-compat</code> for better media compatibility with DVD-ROM drives. When using DVD+RW, this option will not prevent the addition of data.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>To blank the media, use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># growisofs -Z /dev/cd0=/dev/zero</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_using_a_dvd_rw">20.6.5. Using a DVD-RW<a class="anchor" href="#_using_a_dvd_rw"></a></h4>
<div class="paragraph">
<p>A DVD-RW accepts two disc formats: incremental sequential and restricted overwrite. By default, DVD-RW discs are in sequential format.</p>
</div>
<div class="paragraph">
<p>A virgin DVD-RW can be directly written without being formatted. However, a non-virgin DVD-RW in sequential format needs to be blanked before writing a new initial session.</p>
</div>
<div class="paragraph">
<p>To blank a DVD-RW in sequential mode:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># dvd+rw-format -blank=full /dev/cd0</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A full blanking using <code>-blank=full</code> will take about one hour on a 1x media. A fast blanking can be performed using <code>-blank</code>, if the DVD-RW will be recorded in Disk-At-Once (DAO) mode. To burn the DVD-RW in DAO mode, use the command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># growisofs -use-the-force-luke=dao -Z /dev/cd0=imagefile.iso</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Since <a href="https://man.freebsd.org/cgi/man.cgi?query=growisofs&amp;sektion=1&amp;format=html">growisofs(1)</a> automatically attempts to detect fast blanked media and engage DAO write, <code>-use-the-force-luke=dao</code> should not be required.</p>
</div>
<div class="paragraph">
<p>One should instead use restricted overwrite mode with any DVD-RW as this format is more flexible than the default of incremental sequential.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>To write data on a sequential DVD-RW, use the same instructions as for the other DVD formats:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># growisofs -Z /dev/cd0 -J -R /path/to/data</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To append some data to a previous recording, use <code>-M</code> with <a href="https://man.freebsd.org/cgi/man.cgi?query=growisofs&amp;sektion=1&amp;format=html">growisofs(1)</a>. However, if data is appended on a DVD-RW in incremental sequential mode, a new session will be created on the disc and the result will be a multi-session disc.</p>
</div>
<div class="paragraph">
<p>A DVD-RW in restricted overwrite format does not need to be blanked before a new initial session. Instead, overwrite the disc with <code>-Z</code>. It is also possible to grow an existing ISO 9660 file system written on the disc with <code>-M</code>. The result will be a one-session DVD.</p>
</div>
<div class="paragraph">
<p>To put a DVD-RW in restricted overwrite format, the following command must be used:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># dvd+rw-format /dev/cd0</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To change back to sequential format, use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># dvd+rw-format -blank=full /dev/cd0</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_multi_session">20.6.6. Multi-Session<a class="anchor" href="#_multi_session"></a></h4>
<div class="paragraph">
<p>Few DVD-ROM drives support multi-session DVDs and most of the time only read the first session. DVD+R, DVD-R and DVD-RW in sequential format can accept multiple sessions. The notion of multiple sessions does not exist for the DVD+RW and the DVD-RW restricted overwrite formats.</p>
</div>
<div class="paragraph">
<p>Using the following command after an initial non-closed session on a DVD+R, DVD-R, or DVD-RW in sequential format, will add a new session to the disc:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># growisofs -M /dev/cd0 -J -R /path/to/nextdata</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Using this command with a DVD+RW or a DVD-RW in restricted overwrite mode will append data while merging the new session to the existing one. The result will be a single-session disc. Use this method to add data after an initial write on these types of media.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Since some space on the media is used between each session to mark the end and start of sessions, one should add sessions with a large amount of data to optimize media space. The number of sessions is limited to 154 for a DVD+R, about 2000 for a DVD-R, and 127 for a DVD+R Double Layer.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect3">
<h4 id="_for_more_information">20.6.7. For More Information<a class="anchor" href="#_for_more_information"></a></h4>
<div class="paragraph">
<p>To obtain more information about a DVD, use <code>dvd+rw-mediainfo <em>/dev/cd0</em></code> while the disc in the specified drive.</p>
</div>
<div class="paragraph">
<p>More information about dvd+rw-tools can be found in <a href="https://man.freebsd.org/cgi/man.cgi?query=growisofs&amp;sektion=1&amp;format=html">growisofs(1)</a>, on the <a href="http://fy.chalmers.se/~appro/linux/DVD+RW/">dvd+rw-tools web site</a>, and in the <a href="http://lists.debian.org/cdwrite/">cdwrite mailing list</a> archives.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When creating a problem report related to the use of dvd+rw-tools, always include the output of <code>dvd+rw-mediainfo</code>.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect3">
<h4 id="creating-dvd-ram">20.6.8. Using a DVD-RAM<a class="anchor" href="#creating-dvd-ram"></a></h4>
<div class="paragraph">
<p>DVD-RAM writers can use either a SCSI or ATAPI interface. For ATAPI devices, DMA access has to be enabled by adding the following line to <span class="filename">/boot/loader.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>hw.ata.atapi_dma=&#34;1&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>A DVD-RAM can be seen as a removable hard drive. Like any other hard drive, the DVD-RAM must be formatted before it can be used. In this example, the whole disk space will be formatted with a standard UFS2 file system:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># dd if=/dev/zero of=/dev/acd0 bs=2k count=1</span>
<span class="c"># bsdlabel -Bw acd0</span>
<span class="c"># newfs /dev/acd0</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The DVD device, <span class="filename">acd0</span>, must be changed according to the configuration.</p>
</div>
<div class="paragraph">
<p>Once the DVD-RAM has been formatted, it can be mounted as a normal hard drive:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># mount /dev/acd0 /mnt</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Once mounted, the DVD-RAM will be both readable and writeable.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="floppies">20.7. Creating and Using Floppy Disks<a class="anchor" href="#floppies"></a></h3>
<div class="paragraph">
<p>This section explains how to format a 3.5 inch floppy disk in FreeBSD.</p>
</div>
<div class="exampleblock procedure">
<div class="content">
<div class="paragraph">
<p><strong>Procedure: Steps to Format a Floppy</strong></p>
</div>
<div class="paragraph">
<p>A floppy disk needs to be low-level formatted before it can be used. This is usually done by the vendor, but formatting is a good way to check media integrity. To low-level format the floppy disk on FreeBSD, use <a href="https://man.freebsd.org/cgi/man.cgi?query=fdformat&amp;sektion=1&amp;format=html">fdformat(1)</a>. When using this utility, make note of any error messages, as these can help determine if the disk is good or bad.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>To format the floppy, insert a new 3.5 inch floppy disk into the first floppy drive and issue:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># /usr/sbin/fdformat -f 1440 /dev/fd0</span></code></pre>
</div>
</div>
</li>
<li>
<p>After low-level formatting the disk, create a disk label as it is needed by the system to determine the size of the disk and its geometry. The supported geometry values are listed in <span class="filename">/etc/disktab</span>.</p>
<div class="paragraph">
<p>To write the disk label, use <a href="https://man.freebsd.org/cgi/man.cgi?query=bsdlabel&amp;sektion=8&amp;format=html">bsdlabel(8)</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># /sbin/bsdlabel -B -w /dev/fd0 fd1440</span></code></pre>
</div>
</div>
</li>
<li>
<p>The floppy is now ready to be high-level formatted with a file system. The floppy’s file system can be either UFS or FAT, where FAT is generally a better choice for floppies.</p>
<div class="paragraph">
<p>To format the floppy with FAT, issue:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># /sbin/newfs_msdos /dev/fd0</span></code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="paragraph">
<p>The disk is now ready for use. To use the floppy, mount it with <a href="https://man.freebsd.org/cgi/man.cgi?query=mount_msdosfs&amp;sektion=8&amp;format=html">mount_msdosfs(8)</a>. One can also install and use <a class="package" href="https://cgit.freebsd.org/ports/tree/emulators/mtools/">emulators/mtools</a> from the Ports Collection.</p>
</div>
</div>
<div class="sect2">
<h3 id="using-ntfs">20.8. Using NTFS Disks<a class="anchor" href="#using-ntfs"></a></h3>
<div class="paragraph">
<p>This section explains how to mount NTFS disks in FreeBSD.</p>
</div>
<div class="paragraph">
<p>NTFS (New Technology File System) is a proprietary journaling file system developed by Microsoft®. It has been the default file system in Microsoft Windows® for many years. FreeBSD can mount NTFS volumes using a FUSE file system. These file systems are implemented as user space programs which interact with the <a href="https://man.freebsd.org/cgi/man.cgi?query=fusefs&amp;sektion=5&amp;format=html">fusefs(5)</a> kernel module via a well defined interface.</p>
</div>
<div class="exampleblock procedure">
<div class="content">
<div class="paragraph">
<p><strong>Procedure: Steps to Mount a NTFS Disk</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Before using a FUSE file system we need to load the <a href="https://man.freebsd.org/cgi/man.cgi?query=fusefs&amp;sektion=5&amp;format=html">fusefs(5)</a> kernel module:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># kldload fusefs</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Use <a href="https://man.freebsd.org/cgi/man.cgi?query=sysrc&amp;sektion=8&amp;format=html">sysrc(8)</a> to load the module at startup:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysrc kld_list+=fusefs</span></code></pre>
</div>
</div>
</li>
<li>
<p>Install the actual NTFS file system from packages as in the example (see <a href="./#pkgng-intro">Using pkg for Binary Package Management</a>) or from ports (see <a href="./#ports-using">Using the Ports Collection</a>):</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install fusefs-ntfs</span></code></pre>
</div>
</div>
</li>
<li>
<p>Last we need to create a directory where the file system will be mounted:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># mkdir /mnt/usb</span></code></pre>
</div>
</div>
</li>
<li>
<p>Suppose a USB disk is plugged in. The disk partition information can be viewed with <a href="https://man.freebsd.org/cgi/man.cgi?query=gpart&amp;sektion=8&amp;format=html">gpart(8)</a>:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># gpart show da0</span>
<span class="o">=</span>&gt;	  63  1953525105  da0 MBR   <span class="o">(</span>932G<span class="o">)</span>
	  63  1953525105    1 ntfs  <span class="o">(</span>932G<span class="o">)</span></code></pre>
</div>
</div>
</li>
<li>
<p>We can mount the disk using the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ntfs-3g /dev/da0s1 /mnt/usb/</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The disk is now ready to use.</p>
</div>
</li>
<li>
<p>Additionally, an entry can be added to /etc/fstab:</p>
<div class="literalblock programlisting">
<div class="content">
<pre>/dev/da0s1  /mnt/usb	ntfs mountprog=/usr/local/bin/ntfs-3g,noauto,rw  0 0</pre>
</div>
</div>
<div class="paragraph">
<p>Now the disk can be now mounted with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># mount /mnt/usb</span></code></pre>
</div>
</div>
</li>
<li>
<p>The disk can be unmounted with:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># umount /mnt/usb/</span></code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="backup-basics">20.9. Backup Basics<a class="anchor" href="#backup-basics"></a></h3>
<div class="paragraph">
<p>Implementing a backup plan is essential in order to have the ability to recover from disk failure, accidental file deletion, random file corruption, or complete machine destruction, including destruction of on-site backups.</p>
</div>
<div class="paragraph">
<p>The backup type and schedule will vary, depending upon the importance of the data, the granularity needed for file restores, and the amount of acceptable downtime. Some possible backup techniques include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Archives of the whole system, backed up onto permanent, off-site media. This provides protection against all of the problems listed above, but is slow and inconvenient to restore from, especially for non-privileged users.</p>
</li>
<li>
<p>File system snapshots, which are useful for restoring deleted files or previous versions of files.</p>
</li>
<li>
<p>Copies of whole file systems or disks which are synchronized with another system on the network using a scheduled <a class="package" href="https://cgit.freebsd.org/ports/tree/net/rsync/">net/rsync</a>.</p>
</li>
<li>
<p>Hardware or software RAID, which minimizes or avoids downtime when a disk fails.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Typically, a mix of backup techniques is used. For example, one could create a schedule to automate a weekly, full system backup that is stored off-site and to supplement this backup with hourly ZFS snapshots. In addition, one could make a manual backup of individual directories or files before making file edits or deletions.</p>
</div>
<div class="paragraph">
<p>This section describes some of the utilities which can be used to create and manage backups on a FreeBSD system.</p>
</div>
<div class="sect3">
<h4 id="_file_system_backups">20.9.1. File System Backups<a class="anchor" href="#_file_system_backups"></a></h4>
<div class="paragraph">
<p>The traditional UNIX® programs for backing up a file system are <a href="https://man.freebsd.org/cgi/man.cgi?query=dump&amp;sektion=8&amp;format=html">dump(8)</a>, which creates the backup, and <a href="https://man.freebsd.org/cgi/man.cgi?query=restore&amp;sektion=8&amp;format=html">restore(8)</a>, which restores the backup. These utilities work at the disk block level, below the abstractions of the files, links, and directories that are created by file systems. Unlike other backup software, <code>dump</code> backs up an entire file system and is unable to backup only part of a file system or a directory tree that spans multiple file systems. Instead of writing files and directories, <code>dump</code> writes the raw data blocks that comprise files and directories.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If <code>dump</code> is used on the root directory, it will not back up <span class="filename">/home</span>, <span class="filename">/usr</span> or many other directories since these are typically mount points for other file systems or symbolic links into those file systems.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>When used to restore data, <code>restore</code> stores temporary files in <span class="filename">/tmp/</span> by default. When using a recovery disk with a small <span class="filename">/tmp</span>, set <code>TMPDIR</code> to a directory with more free space in order for the restore to succeed.</p>
</div>
<div class="paragraph">
<p>When using <code>dump</code>, be aware that some quirks remain from its early days in Version 6 of AT&amp;T UNIX®,circa 1975. The default parameters assume a backup to a 9-track tape, rather than to another type of media or to the high-density tapes available today. These defaults must be overridden on the command line.</p>
</div>
<div class="paragraph">
<p>It is possible to backup a file system across the network to a another system or to a tape drive attached to another computer. While the <a href="https://man.freebsd.org/cgi/man.cgi?query=rdump&amp;sektion=8&amp;format=html">rdump(8)</a> and <a href="https://man.freebsd.org/cgi/man.cgi?query=rrestore&amp;sektion=8&amp;format=html">rrestore(8)</a> utilities can be used for this purpose, they are not considered to be secure.</p>
</div>
<div class="paragraph">
<p>Instead, one can use <code>dump</code> and <code>restore</code> in a more secure fashion over an SSH connection. This example creates a full, compressed backup of <span class="filename">/usr</span> and sends the backup file to the specified host over a SSH connection.</p>
</div>
<div class="exampleblock">
<div class="title">例 26. Using <code>dump</code> over ssh</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># /sbin/dump -0uan -f - /usr | gzip -2 | ssh -c blowfish \</span>
          targetuser@targetmachine.example.com dd <span class="nv">of</span><span class="o">=</span>/mybigfiles/dump-usr-l0.gz</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>This example sets <code>RSH</code> in order to write the backup to a tape drive on a remote system over a SSH connection:</p>
</div>
<div class="exampleblock">
<div class="title">例 27. Using <code>dump</code> over ssh with <code>RSH</code> Set</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># env RSH=/usr/bin/ssh /sbin/dump -0uan -f targetuser@targetmachine.example.com:/dev/sa0 /usr</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_directory_backups">20.9.2. Directory Backups<a class="anchor" href="#_directory_backups"></a></h4>
<div class="paragraph">
<p>Several built-in utilities are available for backing up and restoring specified files and directories as needed.</p>
</div>
<div class="paragraph">
<p>A good choice for making a backup of all of the files in a directory is <a href="https://man.freebsd.org/cgi/man.cgi?query=tar&amp;sektion=1&amp;format=html">tar(1)</a>. This utility dates back to Version 6 of AT&amp;T UNIX® and by default assumes a recursive backup to a local tape device. Switches can be used to instead specify the name of a backup file.</p>
</div>
<div class="paragraph">
<p>This example creates a compressed backup of the current directory and saves it to <span class="filename">/tmp/mybackup.tgz</span>. When creating a backup file, make sure that the backup is not saved to the same directory that is being backed up.</p>
</div>
<div class="exampleblock">
<div class="title">例 28. Backing Up the Current Directory with <code>tar</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># tar czvf /tmp/mybackup.tgz .</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>To restore the entire backup, <code>cd</code> into the directory to restore into and specify the name of the backup. Note that this will overwrite any newer versions of files in the restore directory. When in doubt, restore to a temporary directory or specify the name of the file within the backup to restore.</p>
</div>
<div class="exampleblock">
<div class="title">例 29. Restoring Up the Current Directory with <code>tar</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># tar xzvf /tmp/mybackup.tgz</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>There are dozens of available switches which are described in <a href="https://man.freebsd.org/cgi/man.cgi?query=tar&amp;sektion=1&amp;format=html">tar(1)</a>. This utility also supports the use of exclude patterns to specify which files should not be included when backing up the specified directory or restoring files from a backup.</p>
</div>
<div class="paragraph">
<p>To create a backup using a specified list of files and directories, <a href="https://man.freebsd.org/cgi/man.cgi?query=cpio&amp;sektion=1&amp;format=html">cpio(1)</a> is a good choice. Unlike <code>tar</code>, <code>cpio</code> does not know how to walk the directory tree and it must be provided the list of files to backup.</p>
</div>
<div class="paragraph">
<p>For example, a list of files can be created using <code>ls</code> or <code>find</code>. This example creates a recursive listing of the current directory which is then piped to <code>cpio</code> in order to create an output backup file named <span class="filename">/tmp/mybackup.cpio</span>.</p>
</div>
<div class="exampleblock">
<div class="title">例 30. Using <code>ls</code> and <code>cpio</code> to Make a Recursive Backup of the Current Directory</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ls -R | cpio -ovF /tmp/mybackup.cpio</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>A backup utility which tries to bridge the features provided by <code>tar</code> and <code>cpio</code> is <a href="https://man.freebsd.org/cgi/man.cgi?query=pax&amp;sektion=1&amp;format=html">pax(1)</a>. Over the years, the various versions of <code>tar</code> and <code>cpio</code> became slightly incompatible. POSIX® created <code>pax</code> which attempts to read and write many of the various <code>cpio</code> and <code>tar</code> formats, plus new formats of its own.</p>
</div>
<div class="paragraph">
<p>The <code>pax</code> equivalent to the previous examples would be:</p>
</div>
<div class="exampleblock">
<div class="title">例 31. Backing Up the Current Directory with <code>pax</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pax -wf /tmp/mybackup.pax .</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="backups-tapebackups">20.9.3. Using Data Tapes for Backups<a class="anchor" href="#backups-tapebackups"></a></h4>
<div class="paragraph">
<p>While tape technology has continued to evolve, modern backup systems tend to combine off-site backups with local removable media. FreeBSD supports any tape drive that uses SCSI, such as LTO or DAT. There is limited support for SATA and USB tape drives.</p>
</div>
<div class="paragraph">
<p>For SCSI tape devices, FreeBSD uses the <a href="https://man.freebsd.org/cgi/man.cgi?query=sa&amp;sektion=4&amp;format=html">sa(4)</a> driver and the <span class="filename">/dev/sa0</span>, <span class="filename">/dev/nsa0</span>, and <span class="filename">/dev/esa0</span> devices. The physical device name is <span class="filename">/dev/sa0</span>. When <span class="filename">/dev/nsa0</span> is used, the backup application will not rewind the tape after writing a file, which allows writing more than one file to a tape. Using <span class="filename">/dev/esa0</span> ejects the tape after the device is closed.</p>
</div>
<div class="paragraph">
<p>In FreeBSD, <code>mt</code> is used to control operations of the tape drive, such as seeking through files on a tape or writing tape control marks to the tape. For example, the first three files on a tape can be preserved by skipping past them before writing a new file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># mt -f /dev/nsa0 fsf 3</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This utility supports many operations. Refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=mt&amp;sektion=1&amp;format=html">mt(1)</a> for details.</p>
</div>
<div class="paragraph">
<p>To write a single file to tape using <code>tar</code>, specify the name of the tape device and the file to backup:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># tar cvf /dev/sa0 file</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To recover files from a <code>tar</code> archive on tape into the current directory:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># tar xvf /dev/sa0</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To backup a UFS file system, use <code>dump</code>. This examples backs up <span class="filename">/usr</span> without rewinding the tape when finished:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># dump -0aL -b64 -f /dev/nsa0 /usr</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To interactively restore files from a <code>dump</code> file on tape into the current directory:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># restore -i -f /dev/nsa0</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="backups-programs-amanda">20.9.4. Third-Party Backup Utilities<a class="anchor" href="#backups-programs-amanda"></a></h4>
<div class="paragraph">
<p>The FreeBSD Ports Collection provides many third-party utilities which can be used to schedule the creation of backups, simplify tape backup, and make backups easier and more convenient. Many of these applications are client/server based and can be used to automate the backups of a single system or all of the computers in a network.</p>
</div>
<div class="paragraph">
<p>Popular utilities include Amanda, Bacula, rsync, and duplicity.</p>
</div>
</div>
<div class="sect3">
<h4 id="_emergency_recovery">20.9.5. Emergency Recovery<a class="anchor" href="#_emergency_recovery"></a></h4>
<div class="paragraph">
<p>In addition to regular backups, it is recommended to perform the following steps as part of an emergency preparedness plan.</p>
</div>
<div class="paragraph">
<p>Create a print copy of the output of the following commands:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>gpart show</code></p>
</li>
<li>
<p><code>more /etc/fstab</code></p>
</li>
<li>
<p><code>dmesg</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Store this printout and a copy of the installation media in a secure location. Should an emergency restore be needed, boot into the installation media and select <code>Live CD</code> to access a rescue shell. This rescue mode can be used to view the current state of the system, and if needed, to reformat disks and restore data from backups.</p>
</div>
<div class="paragraph">
<p>Next, test the rescue shell and the backups. Make notes of the procedure. Store these notes with the media, the printouts, and the backups. These notes may prevent the inadvertent destruction of the backups while under the stress of performing an emergency recovery.</p>
</div>
<div class="paragraph">
<p>For an added measure of security, store the latest backup at a remote location which is physically separated from the computers and disk drives by a significant distance.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="disks-virtual">20.10. Memory Disks<a class="anchor" href="#disks-virtual"></a></h3>
<div class="paragraph">
<p>In addition to physical disks, FreeBSD also supports the creation and use of memory disks. One possible use for a memory disk is to access the contents of an ISO file system without the overhead of first burning it to a CD or DVD, then mounting the CD/DVD media.</p>
</div>
<div class="paragraph">
<p>In FreeBSD, the <a href="https://man.freebsd.org/cgi/man.cgi?query=md&amp;sektion=4&amp;format=html">md(4)</a> driver is used to provide support for memory disks. The <span class="filename">GENERIC</span> kernel includes this driver. When using a custom kernel configuration file, ensure it includes this line:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>device md</pre>
</div>
</div>
<div class="sect3">
<h4 id="disks-mdconfig">20.10.1. Attaching and Detaching Existing Images<a class="anchor" href="#disks-mdconfig"></a></h4>
<div class="paragraph">
<p>To mount an existing file system image, use <code>mdconfig</code> to specify the name of the ISO file and a free unit number. Then, refer to that unit number to mount it on an existing mount point. Once mounted, the files in the ISO will appear in the mount point. This example attaches <em>diskimage.iso</em> to the memory device <span class="filename">/dev/md0</span> then mounts that memory device on <span class="filename">/mnt</span>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># mdconfig -f diskimage.iso -u 0</span>
<span class="c"># mount -t cd9660 /dev/md0 /mnt</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that <code>-t cd9660</code> was used to mount an ISO format. If a unit number is not specified with <code>-u</code>, <code>mdconfig</code> will automatically allocate an unused memory device and output the name of the allocated unit, such as <span class="filename">md4</span>. Refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=mdconfig&amp;sektion=8&amp;format=html">mdconfig(8)</a> for more details about this command and its options.</p>
</div>
<div class="paragraph">
<p>When a memory disk is no longer in use, its resources should be released back to the system. First, unmount the file system, then use <code>mdconfig</code> to detach the disk from the system and release its resources. To continue this example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># umount /mnt</span>
<span class="c"># mdconfig -d -u 0</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To determine if any memory disks are still attached to the system, type <code>mdconfig -l</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="disks-md-freebsd5">20.10.2. Creating a File- or Memory-Backed Memory Disk<a class="anchor" href="#disks-md-freebsd5"></a></h4>
<div class="paragraph">
<p>FreeBSD also supports memory disks where the storage to use is allocated from either a hard disk or an area of memory. The first method is commonly referred to as a file-backed file system and the second method as a memory-backed file system. Both types can be created using <code>mdconfig</code>.</p>
</div>
<div class="paragraph">
<p>To create a new memory-backed file system, specify a type of <code>swap</code> and the size of the memory disk to create. Then, format the memory disk with a file system and mount as usual. This example creates a 5M memory disk on unit <code>1</code>. That memory disk is then formatted with the UFS file system before it is mounted:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># mdconfig -a -t swap -s 5m -u 1</span>
<span class="c"># newfs -U md1</span>
/dev/md1: 5.0MB <span class="o">(</span>10240 sectors<span class="o">)</span> block size 16384, fragment size 2048
        using 4 cylinder groups of 1.27MB, 81 blks, 192 inodes.
        with soft updates
super-block backups <span class="o">(</span><span class="k">for </span>fsck -b <span class="c">#) at:</span>
 160, 2752, 5344, 7936
<span class="c"># mount /dev/md1 /mnt</span>
<span class="c"># df /mnt</span>
Filesystem 1K-blocks Used Avail Capacity  Mounted on
/dev/md1        4718    4  4338     0%    /mnt</code></pre>
</div>
</div>
<div class="paragraph">
<p>To create a new file-backed memory disk, first allocate an area of disk to use. This example creates an empty 5MB file named <span class="filename">newimage</span>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># dd if=/dev/zero of=newimage bs=1k count=5k</span>
5120+0 records <span class="k">in
</span>5120+0 records out</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next, attach that file to a memory disk, label the memory disk and format it with the UFS file system, mount the memory disk, and verify the size of the file-backed disk:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># mdconfig -f newimage -u 0</span>
<span class="c"># bsdlabel -w md0 auto</span>
<span class="c"># newfs -U md0a</span>
/dev/md0a: 5.0MB <span class="o">(</span>10224 sectors<span class="o">)</span> block size 16384, fragment size 2048
        using 4 cylinder groups of 1.25MB, 80 blks, 192 inodes.
super-block backups <span class="o">(</span><span class="k">for </span>fsck -b <span class="c">#) at:</span>
 160, 2720, 5280, 7840
<span class="c"># mount /dev/md0a /mnt</span>
<span class="c"># df /mnt</span>
Filesystem 1K-blocks Used Avail Capacity  Mounted on
/dev/md0a       4710    4  4330     0%    /mnt</code></pre>
</div>
</div>
<div class="paragraph">
<p>It takes several commands to create a file- or memory-backed file system using <code>mdconfig</code>. FreeBSD also comes with <code>mdmfs</code> which automatically configures a memory disk, formats it with the UFS file system, and mounts it. For example, after creating <em>newimage</em> with <code>dd</code>, this one command is equivalent to running the <code>bsdlabel</code>, <code>newfs</code>, and <code>mount</code> commands shown above:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># mdmfs -F newimage -s 5m md0 /mnt</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To instead create a new memory-based memory disk with <code>mdmfs</code>, use this one command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># mdmfs -s 5m md1 /mnt</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If the unit number is not specified, <code>mdmfs</code> will automatically select an unused memory device. For more details about <code>mdmfs</code>, refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=mdmfs&amp;sektion=8&amp;format=html">mdmfs(8)</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="snapshots">20.11. File System Snapshots<a class="anchor" href="#snapshots"></a></h3>
<div class="paragraph">
<p>FreeBSD offers a feature in conjunction with <a href="./#soft-updates">Soft Updates</a>: file system snapshots.</p>
</div>
<div class="paragraph">
<p>UFS snapshots allow a user to create images of specified file systems, and treat them as a file. Snapshot files must be created in the file system that the action is performed on, and a user may create no more than 20 snapshots per file system. Active snapshots are recorded in the superblock so they are persistent across unmount and remount operations along with system reboots. When a snapshot is no longer required, it can be removed using <a href="https://man.freebsd.org/cgi/man.cgi?query=rm&amp;sektion=1&amp;format=html">rm(1)</a>. While snapshots may be removed in any order, all the used space may not be acquired because another snapshot will possibly claim some of the released blocks.</p>
</div>
<div class="paragraph">
<p>The un-alterable <code>snapshot</code> file flag is set by <a href="https://man.freebsd.org/cgi/man.cgi?query=mksnap_ffs&amp;sektion=8&amp;format=html">mksnap_ffs(8)</a> after initial creation of a snapshot file. <a href="https://man.freebsd.org/cgi/man.cgi?query=unlink&amp;sektion=1&amp;format=html">unlink(1)</a> makes an exception for snapshot files since it allows them to be removed.</p>
</div>
<div class="paragraph">
<p>Snapshots are created using <a href="https://man.freebsd.org/cgi/man.cgi?query=mount&amp;sektion=8&amp;format=html">mount(8)</a>. To place a snapshot of <span class="filename">/var</span> in the file <span class="filename">/var/snapshot/snap</span>, use the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># mount -u -o snapshot /var/snapshot/snap /var</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, use <a href="https://man.freebsd.org/cgi/man.cgi?query=mksnap_ffs&amp;sektion=8&amp;format=html">mksnap_ffs(8)</a> to create the snapshot:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># mksnap_ffs /var /var/snapshot/snap</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>One can find snapshot files on a file system, such as <span class="filename">/var</span>, using <a href="https://man.freebsd.org/cgi/man.cgi?query=find&amp;sektion=1&amp;format=html">find(1)</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># find /var -flags snapshot</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Once a snapshot has been created, it has several uses:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Some administrators will use a snapshot file for backup purposes, because the snapshot can be transferred to CDs or tape.</p>
</li>
<li>
<p>The file system integrity checker, <a href="https://man.freebsd.org/cgi/man.cgi?query=fsck&amp;sektion=8&amp;format=html">fsck(8)</a>, may be run on the snapshot. Assuming that the file system was clean when it was mounted, this should always provide a clean and unchanging result.</p>
</li>
<li>
<p>Running <a href="https://man.freebsd.org/cgi/man.cgi?query=dump&amp;sektion=8&amp;format=html">dump(8)</a> on the snapshot will produce a dump file that is consistent with the file system and the timestamp of the snapshot. <a href="https://man.freebsd.org/cgi/man.cgi?query=dump&amp;sektion=8&amp;format=html">dump(8)</a> can also take a snapshot, create a dump image, and then remove the snapshot in one command by using <code>-L</code>.</p>
</li>
<li>
<p>The snapshot can be mounted as a frozen image of the file system. To <a href="https://man.freebsd.org/cgi/man.cgi?query=mount&amp;sektion=8&amp;format=html">mount(8)</a> the snapshot <span class="filename">/var/snapshot/snap</span> run:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># mdconfig -a -t vnode -o readonly -f /var/snapshot/snap -u 4</span>
<span class="c"># mount -r /dev/md4 /mnt</span></code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>The frozen <span class="filename">/var</span> is now available through <span class="filename">/mnt</span>. Everything will initially be in the same state it was during the snapshot creation time. The only exception is that any earlier snapshots will appear as zero length files. To unmount the snapshot, use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># umount /mnt</span>
<span class="c"># mdconfig -d -u 4</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For more information about <code>softupdates</code> and file system snapshots, including technical papers, visit Marshall Kirk McKusick’s website at <a href="http://www.mckusick.com/">http://www.mckusick.com/</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="quotas">20.12. Disk Quotas<a class="anchor" href="#quotas"></a></h3>
<div class="paragraph">
<p>Disk quotas can be used to limit the amount of disk space or the number of files a user or members of a group may allocate on a per-file system basis. This prevents one user or group of users from consuming all of the available disk space.</p>
</div>
<div class="paragraph">
<p>This section describes how to configure disk quotas for the UFS file system. To configure quotas on the ZFS file system, refer to <a href="./#zfs-zfs-quota">Dataset, User, and Group Quotas</a></p>
</div>
<div class="sect3">
<h4 id="_enabling_disk_quotas">20.12.1. Enabling Disk Quotas<a class="anchor" href="#_enabling_disk_quotas"></a></h4>
<div class="paragraph">
<p>To determine if the FreeBSD kernel provides support for disk quotas:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>sysctl kern.features.ufs_quota
kern.features.ufs_quota: 1</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example, the <code>1</code> indicates quota support. If the value is instead <code>0</code>, add the following line to a custom kernel configuration file and rebuild the kernel using the instructions in <a href="./#kernelconfig">Configuring the FreeBSD Kernel</a>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>options QUOTA</pre>
</div>
</div>
<div class="paragraph">
<p>Next, enable disk quotas in <span class="filename">/etc/rc.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>quota_enable=&#34;YES&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>Normally on bootup, the quota integrity of each file system is checked by <a href="https://man.freebsd.org/cgi/man.cgi?query=quotacheck&amp;sektion=8&amp;format=html">quotacheck(8)</a>. This program insures that the data in the quota database properly reflects the data on the file system. This is a time consuming process that will significantly affect the time the system takes to boot. To skip this step, add this variable to <span class="filename">/etc/rc.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>check_quotas=&#34;NO&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>Finally, edit <span class="filename">/etc/fstab</span> to enable disk quotas on a per-file system basis. To enable per-user quotas on a file system, add <code>userquota</code> to the options field in the <span class="filename">/etc/fstab</span> entry for the file system to enable quotas on. For example:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>/dev/da1s2g   /home    ufs rw,userquota 1 2</pre>
</div>
</div>
<div class="paragraph">
<p>To enable group quotas, use <code>groupquota</code> instead. To enable both user and group quotas, separate the options with a comma:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>/dev/da1s2g    /home    ufs rw,userquota,groupquota 1 2</pre>
</div>
</div>
<div class="paragraph">
<p>By default, quota files are stored in the root directory of the file system as <span class="filename">quota.user</span> and <span class="filename">quota.group</span>. Refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=fstab&amp;sektion=5&amp;format=html">fstab(5)</a> for more information. Specifying an alternate location for the quota files is not recommended.</p>
</div>
<div class="paragraph">
<p>Once the configuration is complete, reboot the system and <span class="filename">/etc/rc</span> will automatically run the appropriate commands to create the initial quota files for all of the quotas enabled in <span class="filename">/etc/fstab</span>.</p>
</div>
<div class="paragraph">
<p>In the normal course of operations, there should be no need to manually run <a href="https://man.freebsd.org/cgi/man.cgi?query=quotacheck&amp;sektion=8&amp;format=html">quotacheck(8)</a>, <a href="https://man.freebsd.org/cgi/man.cgi?query=quotaon&amp;sektion=8&amp;format=html">quotaon(8)</a>, or <a href="https://man.freebsd.org/cgi/man.cgi?query=quotaoff&amp;sektion=8&amp;format=html">quotaoff(8)</a>. However, one should read these manual pages to be familiar with their operation.</p>
</div>
</div>
<div class="sect3">
<h4 id="_setting_quota_limits">20.12.2. Setting Quota Limits<a class="anchor" href="#_setting_quota_limits"></a></h4>
<div class="paragraph">
<p>To verify that quotas are enabled, run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># quota -v</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>There should be a one line summary of disk usage and current quota limits for each file system that quotas are enabled on.</p>
</div>
<div class="paragraph">
<p>The system is now ready to be assigned quota limits with <code>edquota</code>.</p>
</div>
<div class="paragraph">
<p>Several options are available to enforce limits on the amount of disk space a user or group may allocate, and how many files they may create. Allocations can be limited based on disk space (block quotas), number of files (inode quotas), or a combination of both. Each limit is further broken down into two categories: hard and soft limits.</p>
</div>
<div class="paragraph">
<p>A hard limit may not be exceeded. Once a user reaches a hard limit, no further allocations can be made on that file system by that user. For example, if the user has a hard limit of 500 kbytes on a file system and is currently using 490 kbytes, the user can only allocate an additional 10 kbytes. Attempting to allocate an additional 11 kbytes will fail.</p>
</div>
<div class="paragraph">
<p>Soft limits can be exceeded for a limited amount of time, known as the grace period, which is one week by default. If a user stays over their limit longer than the grace period, the soft limit turns into a hard limit and no further allocations are allowed. When the user drops back below the soft limit, the grace period is reset.</p>
</div>
<div class="paragraph">
<p>In the following example, the quota for the <code>test</code> account is being edited. When <code>edquota</code> is invoked, the editor specified by <code>EDITOR</code> is opened in order to edit the quota limits. The default editor is set to vi.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># edquota -u test</span>
Quotas <span class="k">for </span>user <span class="nb">test</span>:
/usr: kbytes <span class="k">in </span>use: 65, limits <span class="o">(</span>soft <span class="o">=</span> 50, hard <span class="o">=</span> 75<span class="o">)</span>
        inodes <span class="k">in </span>use: 7, limits <span class="o">(</span>soft <span class="o">=</span> 50, hard <span class="o">=</span> 60<span class="o">)</span>
/usr/var: kbytes <span class="k">in </span>use: 0, limits <span class="o">(</span>soft <span class="o">=</span> 50, hard <span class="o">=</span> 75<span class="o">)</span>
        inodes <span class="k">in </span>use: 0, limits <span class="o">(</span>soft <span class="o">=</span> 50, hard <span class="o">=</span> 60<span class="o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>There are normally two lines for each file system that has quotas enabled. One line represents the block limits and the other represents the inode limits. Change the value to modify the quota limit. For example, to raise the block limit on <span class="filename">/usr</span> to a soft limit of <code>500</code> and a hard limit of <code>600</code>, change the values in that line as follows:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>/usr: kbytes in use: 65, limits (soft = 500, hard = 600)</pre>
</div>
</div>
<div class="paragraph">
<p>The new quota limits take effect upon exiting the editor.</p>
</div>
<div class="paragraph">
<p>Sometimes it is desirable to set quota limits on a range of users. This can be done by first assigning the desired quota limit to a user. Then, use <code>-p</code> to duplicate that quota to a specified range of user IDs (UIDs). The following command will duplicate those quota limits for UIDs <code>10,000</code> through <code>19,999</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># edquota -p test 10000-19999</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For more information, refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=edquota&amp;sektion=8&amp;format=html">edquota(8)</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_checking_quota_limits_and_disk_usage">20.12.3. Checking Quota Limits and Disk Usage<a class="anchor" href="#_checking_quota_limits_and_disk_usage"></a></h4>
<div class="paragraph">
<p>To check individual user or group quotas and disk usage, use <a href="https://man.freebsd.org/cgi/man.cgi?query=quota&amp;sektion=1&amp;format=html">quota(1)</a>. A user may only examine their own quota and the quota of a group they are a member of. Only the superuser may view all user and group quotas. To get a summary of all quotas and disk usage for file systems with quotas enabled, use <a href="https://man.freebsd.org/cgi/man.cgi?query=repquota&amp;sektion=8&amp;format=html">repquota(8)</a>.</p>
</div>
<div class="paragraph">
<p>Normally, file systems that the user is not using any disk space on will not show in the output of <code>quota</code>, even if the user has a quota limit assigned for that file system. Use <code>-v</code> to display those file systems. The following is sample output from <code>quota -v</code> for a user that has quota limits on two file systems.</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>Disk quotas for user test (uid 1002):
     Filesystem  usage    quota   limit   grace   files   quota   limit   grace
           /usr      65*     50      75   5days       7      50      60
       /usr/var       0      50      75               0      50      60</pre>
</div>
</div>
<div class="paragraph">
<p>In this example, the user is currently 15 kbytes over the soft limit of 50 kbytes on <span class="filename">/usr</span> and has 5 days of grace period left. The asterisk <code>*</code> indicates that the user is currently over the quota limit.</p>
</div>
</div>
<div class="sect3">
<h4 id="_quotas_over_nfs">20.12.4. Quotas over NFS<a class="anchor" href="#_quotas_over_nfs"></a></h4>
<div class="paragraph">
<p>Quotas are enforced by the quota subsystem on the NFS server. The <a href="https://man.freebsd.org/cgi/man.cgi?query=rpc.rquotad&amp;sektion=8&amp;format=html">rpc.rquotad(8)</a> daemon makes quota information available to <code>quota</code> on NFS clients, allowing users on those machines to see their quota statistics.</p>
</div>
<div class="paragraph">
<p>On the NFS server, enable <code>rpc.rquotad</code> by removing the <code>#</code> from this line in <strong class="filename">/etc/inetd.conf</strong>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>rquotad/1      dgram rpc/udp wait root /usr/libexec/rpc.rquotad rpc.rquotad</pre>
</div>
</div>
<div class="paragraph">
<p>Then, restart <code>inetd</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># service inetd restart</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="disks-encrypting">20.13. Encrypting Disk Partitions<a class="anchor" href="#disks-encrypting"></a></h3>
<div class="paragraph">
<p>FreeBSD offers excellent online protections against unauthorized data access. File permissions and <a href="./#mac">Mandatory Access Control</a> (MAC) help prevent unauthorized users from accessing data while the operating system is active and the computer is powered up. However, the permissions enforced by the operating system are irrelevant if an attacker has physical access to a computer and can move the computer’s hard drive to another system to copy and analyze the data.</p>
</div>
<div class="paragraph">
<p>Regardless of how an attacker may have come into possession of a hard drive or powered-down computer, the GEOM-based cryptographic subsystems built into FreeBSD are able to protect the data on the computer’s file systems against even highly-motivated attackers with significant resources. Unlike encryption methods that encrypt individual files, the built-in <code>gbde</code> and <code>geli</code> utilities can be used to transparently encrypt entire file systems. No cleartext ever touches the hard drive’s platter.</p>
</div>
<div class="paragraph">
<p>This chapter demonstrates how to create an encrypted file system on FreeBSD. It first demonstrates the process using <code>gbde</code> and then demonstrates the same example using <code>geli</code>.</p>
</div>
<div class="sect3">
<h4 id="_disk_encryption_with_gbde">20.13.1. Disk Encryption with gbde<a class="anchor" href="#_disk_encryption_with_gbde"></a></h4>
<div class="paragraph">
<p>The objective of the <a href="https://man.freebsd.org/cgi/man.cgi?query=gbde&amp;sektion=4&amp;format=html">gbde(4)</a> facility is to provide a formidable challenge for an attacker to gain access to the contents of a <em>cold</em> storage device. However, if the computer is compromised while up and running and the storage device is actively attached, or the attacker has access to a valid passphrase, it offers no protection to the contents of the storage device. Thus, it is important to provide physical security while the system is running and to protect the passphrase used by the encryption mechanism.</p>
</div>
<div class="paragraph">
<p>This facility provides several barriers to protect the data stored in each disk sector. It encrypts the contents of a disk sector using 128-bit AES in CBC mode. Each sector on the disk is encrypted with a different AES key. For more information on the cryptographic design, including how the sector keys are derived from the user-supplied passphrase, refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=gbde&amp;sektion=4&amp;format=html">gbde(4)</a>.</p>
</div>
<div class="paragraph">
<p>FreeBSD provides a kernel module for gbde which can be loaded with this command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># kldload geom_bde</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If using a custom kernel configuration file, ensure it contains this line:</p>
</div>
<div class="paragraph">
<p><code>options GEOM_BDE</code></p>
</div>
<div class="paragraph">
<p>The following example demonstrates adding a new hard drive to a system that will hold a single encrypted partition that will be mounted as <span class="filename">/private</span>.</p>
</div>
<div class="olist arabic procedure">
<div class="title">Procedure: Encrypting a Partition with gbde</div>
<ol class="arabic">
<li>
<p>Add the New Hard Drive</p>
<div class="paragraph">
<p>Install the new drive to the system as explained in <a href="#disks-adding">Adding Disks</a>. For the purposes of this example, a new hard drive partition has been added as <span class="filename">/dev/ad4s1c</span> and <span class="filename">/dev/ad0s1*</span> represents the existing standard FreeBSD partitions.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ls /dev/ad*</span>
/dev/ad0        /dev/ad0s1b     /dev/ad0s1e     /dev/ad4s1
/dev/ad0s1      /dev/ad0s1c     /dev/ad0s1f     /dev/ad4s1c
/dev/ad0s1a     /dev/ad0s1d     /dev/ad4</code></pre>
</div>
</div>
</li>
<li>
<p>Create a Directory to Hold <code>gbde</code> Lock Files</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># mkdir /etc/gbde</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The gbde lock file contains information that gbde requires to access encrypted partitions. Without access to the lock file, gbde will not be able to decrypt the data contained in the encrypted partition without significant manual intervention which is not supported by the software. Each encrypted partition uses a separate lock file.</p>
</div>
</li>
<li>
<p>Initialize the <code>gbde</code> Partition</p>
<div class="paragraph">
<p>A gbde partition must be initialized before it can be used. This initialization needs to be performed only once. This command will open the default editor, in order to set various configuration options in a template. For use with the UFS file system, set the sector_size to 2048:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># gbde init /dev/ad4s1c -i -L /etc/gbde/ad4s1c.lock</span>
<span class="c"># $FreeBSD: src/sbin/gbde/template.txt,v 1.1.36.1 2009/08/03 08:13:06 kensmith Exp $</span>
<span class="c">#</span>
<span class="c"># Sector size is the smallest unit of data which can be read or written.</span>
<span class="c"># Making it too small decreases performance and decreases available space.</span>
<span class="c"># Making it too large may prevent filesystems from working.  512 is the</span>
<span class="c"># minimum and always safe.  For UFS, use the fragment size</span>
<span class="c">#</span>
sector_size	<span class="o">=</span>	2048
<span class="o">[</span>...]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once the edit is saved, the user will be asked twice to type the passphrase used to secure the data. The passphrase must be the same both times. The ability of gbde to protect data depends entirely on the quality of the passphrase. For tips on how to select a secure passphrase that is easy to remember, see <a href="http://world.std.com/~reinhold/diceware.html">http://world.std.com/~reinhold/diceware.htm</a>.</p>
</div>
<div class="paragraph">
<p>This initialization creates a lock file for the gbde partition. In this example, it is stored as <span class="filename">/etc/gbde/ad4s1c.lock</span>. Lock files must end in &#34;.lock&#34; in order to be correctly detected by the <span class="filename">/etc/rc.d/gbde</span> start up script.</p>
</div>
<div class="admonitionblock caution">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Lock files <em>must</em> be backed up together with the contents of any encrypted partitions. Without the lock file, the legitimate owner will be unable to access the data on the encrypted partition.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
</li>
<li>
<p>Attach the Encrypted Partition to the Kernel</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># gbde attach /dev/ad4s1c -l /etc/gbde/ad4s1c.lock</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This command will prompt to input the passphrase that was selected during the initialization of the encrypted partition. The new encrypted device will appear in <span class="filename">/dev</span> as <span class="filename">/dev/device_name.bde</span>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ls /dev/ad*</span>
/dev/ad0        /dev/ad0s1b     /dev/ad0s1e     /dev/ad4s1
/dev/ad0s1      /dev/ad0s1c     /dev/ad0s1f     /dev/ad4s1c
/dev/ad0s1a     /dev/ad0s1d     /dev/ad4        /dev/ad4s1c.bde</code></pre>
</div>
</div>
</li>
<li>
<p>Create a File System on the Encrypted Device</p>
<div class="paragraph">
<p>Once the encrypted device has been attached to the kernel, a file system can be created on the device. This example creates a UFS file system with soft updates enabled. Be sure to specify the partition which has a <span class="filename">*.bde</span> extension:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># newfs -U /dev/ad4s1c.bde</span></code></pre>
</div>
</div>
</li>
<li>
<p>Mount the Encrypted Partition</p>
<div class="paragraph">
<p>Create a mount point and mount the encrypted file system:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># mkdir /private</span>
<span class="c"># mount /dev/ad4s1c.bde /private</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verify That the Encrypted File System is Available</p>
<div class="paragraph">
<p>The encrypted file system should now be visible and available for use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>df -H
Filesystem        Size   Used  Avail Capacity  Mounted on
/dev/ad0s1a      1037M    72M   883M     8%    /
/devfs            1.0K   1.0K     0B   100%    /dev
/dev/ad0s1f       8.1G    55K   7.5G     0%    /home
/dev/ad0s1e      1037M   1.1M   953M     0%    /tmp
/dev/ad0s1d       6.1G   1.9G   3.7G    35%    /usr
/dev/ad4s1c.bde   150G   4.1K   138G     0%    /private</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>After each boot, any encrypted file systems must be manually re-attached to the kernel, checked for errors, and mounted, before the file systems can be used. To configure these steps, add the following lines to <span class="filename">/etc/rc.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>gbde_autoattach_all=&#34;YES&#34;
gbde_devices=&#34;ad4s1c&#34;
gbde_lockdir=&#34;/etc/gbde&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>This requires that the passphrase be entered at the console at boot time. After typing the correct passphrase, the encrypted partition will be mounted automatically. Additional gbde boot options are available and listed in <a href="https://man.freebsd.org/cgi/man.cgi?query=rc.conf&amp;sektion=5&amp;format=html">rc.conf(5)</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>sysinstall is incompatible with gbde-encrypted devices. All <span class="filename">*.bde</span> devices must be detached from the kernel before starting sysinstall or it will crash during its initial probing for devices. To detach the encrypted device used in the example, use the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># gbde detach /dev/ad4s1c</span></code></pre>
</div>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect3">
<h4 id="disks-encrypting-geli">20.13.2. Disk Encryption with <code>geli</code><a class="anchor" href="#disks-encrypting-geli"></a></h4>
<div class="paragraph">
<p>An alternative cryptographic GEOM class is available using <code>geli</code>. This control utility adds some features and uses a different scheme for doing cryptographic work. It provides the following features:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Utilizes the <a href="https://man.freebsd.org/cgi/man.cgi?query=crypto&amp;sektion=9&amp;format=html">crypto(9)</a> framework and automatically uses cryptographic hardware when it is available.</p>
</li>
<li>
<p>Supports multiple cryptographic algorithms such as AES, Blowfish, and 3DES.</p>
</li>
<li>
<p>Allows the root partition to be encrypted. The passphrase used to access the encrypted root partition will be requested during system boot.</p>
</li>
<li>
<p>Allows the use of two independent keys.</p>
</li>
<li>
<p>It is fast as it performs simple sector-to-sector encryption.</p>
</li>
<li>
<p>Allows backup and restore of master keys. If a user destroys their keys, it is still possible to get access to the data by restoring keys from the backup.</p>
</li>
<li>
<p>Allows a disk to attach with a random, one-time key which is useful for swap partitions and temporary file systems.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>More features and usage examples can be found in <a href="https://man.freebsd.org/cgi/man.cgi?query=geli&amp;sektion=8&amp;format=html">geli(8)</a>.</p>
</div>
<div class="paragraph">
<p>The following example describes how to generate a key file which will be used as part of the master key for the encrypted provider mounted under <span class="filename">/private</span>. The key file will provide some random data used to encrypt the master key. The master key will also be protected by a passphrase. The provider’s sector size will be 4kB. The example describes how to attach to the <code>geli</code> provider, create a file system on it, mount it, work with it, and finally, how to detach it.</p>
</div>
<div class="olist arabic procedure">
<div class="title">Procedure: Encrypting a Partition with <code>geli</code></div>
<ol class="arabic">
<li>
<p>Load <code>geli</code> Support</p>
<div class="paragraph">
<p>Support for <code>geli</code> is available as a loadable kernel module. To configure the system to automatically load the module at boot time, add the following line to <span class="filename">/boot/loader.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>geom_eli_load=&#34;YES&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>To load the kernel module now:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># kldload geom_eli</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For a custom kernel, ensure the kernel configuration file contains these lines:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>options GEOM_ELI
device crypto</pre>
</div>
</div>
</li>
<li>
<p>Generate the Master Key</p>
<div class="paragraph">
<p>The following commands generate a master key that all data will be encrypted with. This key can never be changed. Rather than using it directly, it is encrypted with one or more user keys. The user keys are made up of an optional combination of random bytes from a file, <span class="filename">/root/da2.key</span>, and/or a passphrase. In this case, the data source for the key file is <span class="filename">/dev/random</span>. This command also configures the sector size of the provider (<span class="filename">/dev/da2.eli</span>) as 4kB, for better performance:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># dd if=/dev/random of=/root/da2.key bs=64 count=1</span>
<span class="c"># geli init -K /root/da2.key -s 4096 /dev/da2</span>
Enter new passphrase:
Reenter new passphrase:</code></pre>
</div>
</div>
<div class="paragraph">
<p>It is not mandatory to use both a passphrase and a key file as either method of securing the master key can be used in isolation.</p>
</div>
<div class="paragraph">
<p>If the key file is given as &#34;-&#34;, standard input will be used. For example, this command generates three key files:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># cat keyfile1 keyfile2 keyfile3 | geli init -K - /dev/da2</span></code></pre>
</div>
</div>
</li>
<li>
<p>Attach the Provider with the Generated Key</p>
<div class="paragraph">
<p>To attach the provider, specify the key file, the name of the disk, and the passphrase:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># geli attach -k /root/da2.key /dev/da2</span>
Enter passphrase:</code></pre>
</div>
</div>
<div class="paragraph">
<p>This creates a new device with an <span class="filename">.eli</span> extension:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ls /dev/da2*</span>
/dev/da2  /dev/da2.eli</code></pre>
</div>
</div>
</li>
<li>
<p>Create the New File System</p>
<div class="paragraph">
<p>Next, format the device with the UFS file system and mount it on an existing mount point:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># dd if=/dev/random of=/dev/da2.eli bs=1m</span>
<span class="c"># newfs /dev/da2.eli</span>
<span class="c"># mount /dev/da2.eli /private</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The encrypted file system should now be available for use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># df -H</span>
Filesystem     Size   Used  Avail Capacity  Mounted on
/dev/ad0s1a    248M    89M   139M    38%    /
/devfs         1.0K   1.0K     0B   100%    /dev
/dev/ad0s1f    7.7G   2.3G   4.9G    32%    /usr
/dev/ad0s1d    989M   1.5M   909M     0%    /tmp
/dev/ad0s1e    3.9G   1.3G   2.3G    35%    /var
/dev/da2.eli   150G   4.1K   138G     0%    /private</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Once the work on the encrypted partition is done, and the <span class="filename">/private</span> partition is no longer needed, it is prudent to put the device into cold storage by unmounting and detaching the <code>geli</code> encrypted partition from the kernel:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># umount /private</span>
<span class="c"># geli detach da2.eli</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>An <span class="filename">rc.d</span> script is provided to simplify the mounting of <code>geli</code>-encrypted devices at boot time. For this example, add these lines to <span class="filename">/etc/rc.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>geli_devices=&#34;da2&#34;
geli_da2_flags=&#34;-k /root/da2.key&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>This configures <span class="filename">/dev/da2</span> as a <code>geli</code> provider with a master key of <span class="filename">/root/da2.key</span>. The system will automatically detach the provider from the kernel before the system shuts down. During the startup process, the script will prompt for the passphrase before attaching the provider. Other kernel messages might be shown before and after the password prompt. If the boot process seems to stall, look carefully for the password prompt among the other messages. Once the correct passphrase is entered, the provider is attached. The file system is then mounted, typically by an entry in <span class="filename">/etc/fstab</span>. Refer to <a href="./#mount-unmount">“Mounting and Unmounting File Systems”</a> for instructions on how to configure a file system to mount at boot time.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="swap-encrypting">20.14. Encrypting Swap<a class="anchor" href="#swap-encrypting"></a></h3>
<div class="paragraph">
<p>Like the encryption of disk partitions, encryption of swap space is used to protect sensitive information. Consider an application that deals with passwords. As long as these passwords stay in physical memory, they are not written to disk and will be cleared after a reboot. However, if FreeBSD starts swapping out memory pages to free space, the passwords may be written to the disk unencrypted. Encrypting swap space can be a solution for this scenario.</p>
</div>
<div class="paragraph">
<p>This section demonstrates how to configure an encrypted swap partition using <a href="https://man.freebsd.org/cgi/man.cgi?query=gbde&amp;sektion=8&amp;format=html">gbde(8)</a> or <a href="https://man.freebsd.org/cgi/man.cgi?query=geli&amp;sektion=8&amp;format=html">geli(8)</a> encryption. It assumes that <span class="filename">/dev/ada0s1b</span> is the swap partition.</p>
</div>
<div class="sect3">
<h4 id="_configuring_encrypted_swap">20.14.1. Configuring Encrypted Swap<a class="anchor" href="#_configuring_encrypted_swap"></a></h4>
<div class="paragraph">
<p>Swap partitions are not encrypted by default and should be cleared of any sensitive data before continuing. To overwrite the current swap partition with random garbage, execute the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># dd if=/dev/random of=/dev/ada0s1b bs=1m</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To encrypt the swap partition using <a href="https://man.freebsd.org/cgi/man.cgi?query=gbde&amp;sektion=8&amp;format=html">gbde(8)</a>, add the <code>.bde</code> suffix to the swap line in <span class="filename">/etc/fstab</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre># Device		Mountpoint	FStype	Options		Dump	Pass#
/dev/ada0s1b.bde	none		swap	sw		0	0</pre>
</div>
</div>
<div class="paragraph">
<p>To instead encrypt the swap partition using <a href="https://man.freebsd.org/cgi/man.cgi?query=geli&amp;sektion=8&amp;format=html">geli(8)</a>, use the <code>.eli</code> suffix:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre># Device		Mountpoint	FStype	Options		Dump	Pass#
/dev/ada0s1b.eli	none		swap	sw		0	0</pre>
</div>
</div>
<div class="paragraph">
<p>By default, <a href="https://man.freebsd.org/cgi/man.cgi?query=geli&amp;sektion=8&amp;format=html">geli(8)</a> uses the AES algorithm with a key length of 128 bits. Normally the default settings will suffice. If desired, these defaults can be altered in the options field in <span class="filename">/etc/fstab</span>. The possible flags are:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">aalgo</dt>
<dd>
<p>Data integrity verification algorithm used to ensure that the encrypted data has not been tampered with. See <a href="https://man.freebsd.org/cgi/man.cgi?query=geli&amp;sektion=8&amp;format=html">geli(8)</a> for a list of supported algorithms.</p>
</dd>
<dt class="hdlist1">ealgo</dt>
<dd>
<p>Encryption algorithm used to protect the data. See <a href="https://man.freebsd.org/cgi/man.cgi?query=geli&amp;sektion=8&amp;format=html">geli(8)</a> for a list of supported algorithms.</p>
</dd>
<dt class="hdlist1">keylen</dt>
<dd>
<p>The length of the key used for the encryption algorithm. See <a href="https://man.freebsd.org/cgi/man.cgi?query=geli&amp;sektion=8&amp;format=html">geli(8)</a> for the key lengths that are supported by each encryption algorithm.</p>
</dd>
<dt class="hdlist1">sectorsize</dt>
<dd>
<p>The size of the blocks data is broken into before it is encrypted. Larger sector sizes increase performance at the cost of higher storage overhead. The recommended size is 4096 bytes.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>This example configures an encrypted swap partition using the Blowfish algorithm with a key length of 128 bits and a sectorsize of 4 kilobytes:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre># Device		Mountpoint	FStype	Options				Dump	Pass#
/dev/ada0s1b.eli	none		swap	sw,ealgo=blowfish,keylen=128,sectorsize=4096	0	0</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_encrypted_swap_verification">20.14.2. Encrypted Swap Verification<a class="anchor" href="#_encrypted_swap_verification"></a></h4>
<div class="paragraph">
<p>Once the system has rebooted, proper operation of the encrypted swap can be verified using <code>swapinfo</code>.</p>
</div>
<div class="paragraph">
<p>If <a href="https://man.freebsd.org/cgi/man.cgi?query=gbde&amp;sektion=8&amp;format=html">gbde(8)</a> is being used:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>swapinfo
Device          1K-blocks     Used    Avail Capacity
/dev/ada0s1b.bde   542720        0   542720     0</code></pre>
</div>
</div>
<div class="paragraph">
<p>If <a href="https://man.freebsd.org/cgi/man.cgi?query=geli&amp;sektion=8&amp;format=html">geli(8)</a> is being used:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>swapinfo
Device          1K-blocks     Used    Avail Capacity
/dev/ada0s1b.eli   542720        0   542720     0</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="disks-hast">20.15. Highly Available Storage (HAST)<a class="anchor" href="#disks-hast"></a></h3>
<div class="paragraph">
<p>High availability is one of the main requirements in serious business applications and highly-available storage is a key component in such environments. In FreeBSD, the Highly Available STorage (HAST) framework allows transparent storage of the same data across several physically separated machines connected by a TCP/IP network. HAST can be understood as a network-based RAID1 (mirror), and is similar to the DRBD® storage system used in the GNU/Linux® platform. In combination with other high-availability features of FreeBSD like CARP, HAST makes it possible to build a highly-available storage cluster that is resistant to hardware failures.</p>
</div>
<div class="paragraph">
<p>The following are the main features of HAST:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Can be used to mask I/O errors on local hard drives.</p>
</li>
<li>
<p>File system agnostic as it works with any file system supported by FreeBSD.</p>
</li>
<li>
<p>Efficient and quick resynchronization as only the blocks that were modified during the downtime of a node are synchronized.</p>
</li>
<li>
<p>Can be used in an already deployed environment to add additional redundancy.</p>
</li>
<li>
<p>Together with CARP, Heartbeat, or other tools, it can be used to build a robust and durable storage system.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>After reading this section, you will know:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>What HAST is, how it works, and which features it provides.</p>
</li>
<li>
<p>How to set up and use HAST on FreeBSD.</p>
</li>
<li>
<p>How to integrate CARP and <a href="https://man.freebsd.org/cgi/man.cgi?query=devd&amp;sektion=8&amp;format=html">devd(8)</a> to build a robust storage system.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Before reading this section, you should:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Understand UNIX® and FreeBSD basics (<a href="./#basics">FreeBSD Basics</a>).</p>
</li>
<li>
<p>Know how to configure network interfaces and other core FreeBSD subsystems (<a href="./#config-tuning">Configuration and Tuning</a>).</p>
</li>
<li>
<p>Have a good understanding of FreeBSD networking (<a href="./#network-communication">Network Communication</a>).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The HAST project was sponsored by The FreeBSD Foundation with support from <a href="http://www.omc.net/">http://www.omc.net/</a> and <a href="http://www.transip.nl/">http://www.transip.nl/</a>.</p>
</div>
<div class="sect3">
<h4 id="_hast_operation">20.15.1. HAST Operation<a class="anchor" href="#_hast_operation"></a></h4>
<div class="paragraph">
<p>HAST provides synchronous block-level replication between two physical machines: the <em>primary</em> node and the <em>secondary</em> node. These two machines together are referred to as a cluster.</p>
</div>
<div class="paragraph">
<p>Since HAST works in a primary-secondary configuration, it allows only one of the cluster nodes to be active at any given time. The primary node, also called <em>active</em>, is the one which will handle all the I/O requests to HAST-managed devices. The secondary node is automatically synchronized from the primary node.</p>
</div>
<div class="paragraph">
<p>The physical components of the HAST system are the local disk on primary node, and the disk on the remote, secondary node.</p>
</div>
<div class="paragraph">
<p>HAST operates synchronously on a block level, making it transparent to file systems and applications. HAST provides regular GEOM providers in <span class="filename">/dev/hast/</span> for use by other tools or applications. There is no difference between using HAST-provided devices and raw disks or partitions.</p>
</div>
<div class="paragraph">
<p>Each write, delete, or flush operation is sent to both the local disk and to the remote disk over TCP/IP. Each read operation is served from the local disk, unless the local disk is not up-to-date or an I/O error occurs. In such cases, the read operation is sent to the secondary node.</p>
</div>
<div class="paragraph">
<p>HAST tries to provide fast failure recovery. For this reason, it is important to reduce synchronization time after a node’s outage. To provide fast synchronization, HAST manages an on-disk bitmap of dirty extents and only synchronizes those during a regular synchronization, with an exception of the initial sync.</p>
</div>
<div class="paragraph">
<p>There are many ways to handle synchronization. HAST implements several replication modes to handle different synchronization methods:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>memsync</em>: This mode reports a write operation as completed when the local write operation is finished and when the remote node acknowledges data arrival, but before actually storing the data. The data on the remote node will be stored directly after sending the acknowledgement. This mode is intended to reduce latency, but still provides good reliability. This mode is the default.</p>
</li>
<li>
<p><em>fullsync</em>: This mode reports a write operation as completed when both the local write and the remote write complete. This is the safest and the slowest replication mode.</p>
</li>
<li>
<p><em>async</em>: This mode reports a write operation as completed when the local write completes. This is the fastest and the most dangerous replication mode. It should only be used when replicating to a distant node where latency is too high for other modes.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_hast_configuration">20.15.2. HAST Configuration<a class="anchor" href="#_hast_configuration"></a></h4>
<div class="paragraph">
<p>The HAST framework consists of several components:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <a href="https://man.freebsd.org/cgi/man.cgi?query=hastd&amp;sektion=8&amp;format=html">hastd(8)</a> daemon which provides data synchronization. When this daemon is started, it will automatically load <code>geom_gate.ko</code>.</p>
</li>
<li>
<p>The userland management utility, <a href="https://man.freebsd.org/cgi/man.cgi?query=hastctl&amp;sektion=8&amp;format=html">hastctl(8)</a>.</p>
</li>
<li>
<p>The <a href="https://man.freebsd.org/cgi/man.cgi?query=hast.conf&amp;sektion=5&amp;format=html">hast.conf(5)</a> configuration file. This file must exist before starting hastd.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Users who prefer to statically build <code>GEOM_GATE</code> support into the kernel should add this line to the custom kernel configuration file, then rebuild the kernel using the instructions in <a href="./#kernelconfig">Configuring the FreeBSD Kernel</a>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>options	GEOM_GATE</pre>
</div>
</div>
<div class="paragraph">
<p>The following example describes how to configure two nodes in primary-secondary operation using HAST to replicate the data between the two. The nodes will be called <code>hasta</code>, with an IP address of <code>172.16.0.1</code>, and <code>hastb</code>, with an IP address of <code>172.16.0.2</code>. Both nodes will have a dedicated hard drive <span class="filename">/dev/ad6</span> of the same size for HAST operation. The HAST pool, sometimes referred to as a resource or the GEOM provider in <span class="filename">/dev/hast/</span>, will be called <code>test</code>.</p>
</div>
<div class="paragraph">
<p>Configuration of HAST is done using <span class="filename">/etc/hast.conf</span>. This file should be identical on both nodes. The simplest configuration is:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>resource test {
	on hasta {
		local /dev/ad6
		remote 172.16.0.2
	}
	on hastb {
		local /dev/ad6
		remote 172.16.0.1
	}
}</pre>
</div>
</div>
<div class="paragraph">
<p>For more advanced configuration, refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=hast.conf&amp;sektion=5&amp;format=html">hast.conf(5)</a>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>It is also possible to use host names in the <code>remote</code> statements if the hosts are resolvable and defined either in <span class="filename">/etc/hosts</span> or in the local DNS.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Once the configuration exists on both nodes, the HAST pool can be created. Run these commands on both nodes to place the initial metadata onto the local disk and to start <a href="https://man.freebsd.org/cgi/man.cgi?query=hastd&amp;sektion=8&amp;format=html">hastd(8)</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># hastctl create test</span>
<span class="c"># service hastd onestart</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>It is <em>not</em> possible to use GEOM providers with an existing file system or to convert an existing storage to a HAST-managed pool. This procedure needs to store some metadata on the provider and there will not be enough required space available on an existing provider.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>A HAST node’s <code>primary</code> or <code>secondary</code> role is selected by an administrator, or software like Heartbeat, using <a href="https://man.freebsd.org/cgi/man.cgi?query=hastctl&amp;sektion=8&amp;format=html">hastctl(8)</a>. On the primary node, <code>hasta</code>, issue this command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># hastctl role primary test</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Run this command on the secondary node, <code>hastb</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># hastctl role secondary test</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Verify the result by running <code>hastctl</code> on each node:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># hastctl status test</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Check the <code>status</code> line in the output. If it says <code>degraded</code>, something is wrong with the configuration file. It should say <code>complete</code> on each node, meaning that the synchronization between the nodes has started. The synchronization completes when <code>hastctl status</code> reports 0 bytes of <code>dirty</code> extents.</p>
</div>
<div class="paragraph">
<p>The next step is to create a file system on the GEOM provider and mount it. This must be done on the <code>primary</code> node. Creating the file system can take a few minutes, depending on the size of the hard drive. This example creates a UFS file system on <span class="filename">/dev/hast/test</span>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># newfs -U /dev/hast/test</span>
<span class="c"># mkdir /hast/test</span>
<span class="c"># mount /dev/hast/test /hast/test</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Once the HAST framework is configured properly, the final step is to make sure that HAST is started automatically during system boot. Add this line to <span class="filename">/etc/rc.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>hastd_enable=&#34;YES&#34;</pre>
</div>
</div>
<div class="sect4">
<h5 id="_failover_configuration">20.15.2.1. Failover Configuration<a class="anchor" href="#_failover_configuration"></a></h5>
<div class="paragraph">
<p>The goal of this example is to build a robust storage system which is resistant to the failure of any given node. If the primary node fails, the secondary node is there to take over seamlessly, check and mount the file system, and continue to work without missing a single bit of data.</p>
</div>
<div class="paragraph">
<p>To accomplish this task, the Common Address Redundancy Protocol (CARP) is used to provide for automatic failover at the IP layer. CARP allows multiple hosts on the same network segment to share an IP address. Set up CARP on both nodes of the cluster according to the documentation available in <a href="./#carp">“Common Address Redundancy Protocol (CARP)”</a>. In this example, each node will have its own management IP address and a shared IP address of <em>172.16.0.254</em>. The primary HAST node of the cluster must be the primary CARP node.</p>
</div>
<div class="paragraph">
<p>The HAST pool created in the previous section is now ready to be exported to the other hosts on the network. This can be accomplished by exporting it through NFS or Samba, using the shared IP address <em>172.16.0.254</em>. The only problem which remains unresolved is an automatic failover should the primary node fail.</p>
</div>
<div class="paragraph">
<p>In the event of CARP interfaces going up or down, the FreeBSD operating system generates a <a href="https://man.freebsd.org/cgi/man.cgi?query=devd&amp;sektion=8&amp;format=html">devd(8)</a> event, making it possible to watch for state changes on the CARP interfaces. A state change on the CARP interface is an indication that one of the nodes failed or came back online. These state change events make it possible to run a script which will automatically handle the HAST failover.</p>
</div>
<div class="paragraph">
<p>To catch state changes on the CARP interfaces, add this configuration to <span class="filename">/etc/devd.conf</span> on each node:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>notify 30 {
	match &#34;system&#34; &#34;IFNET&#34;;
	match &#34;subsystem&#34; &#34;carp0&#34;;
	match &#34;type&#34; &#34;LINK_UP&#34;;
	action &#34;/usr/local/sbin/carp-hast-switch primary&#34;;
};

notify 30 {
	match &#34;system&#34; &#34;IFNET&#34;;
	match &#34;subsystem&#34; &#34;carp0&#34;;
	match &#34;type&#34; &#34;LINK_DOWN&#34;;
	action &#34;/usr/local/sbin/carp-hast-switch secondary&#34;;
};</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If the systems are running FreeBSD 10 or higher, replace <span class="filename">carp0</span> with the name of the CARP-configured interface.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Restart <a href="https://man.freebsd.org/cgi/man.cgi?query=devd&amp;sektion=8&amp;format=html">devd(8)</a> on both nodes to put the new configuration into effect:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># service devd restart</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When the specified interface state changes by going up or down , the system generates a notification, allowing the <a href="https://man.freebsd.org/cgi/man.cgi?query=devd&amp;sektion=8&amp;format=html">devd(8)</a> subsystem to run the specified automatic failover script, <span class="filename">/usr/local/sbin/carp-hast-switch</span>. For further clarification about this configuration, refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=devd.conf&amp;sektion=5&amp;format=html">devd.conf(5)</a>.</p>
</div>
<div class="paragraph">
<p>Here is an example of an automated failover script:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>#!/bin/sh

# Original script by Freddie Cash &lt;fjwcash@gmail.com&gt;
# Modified by Michael W. Lucas &lt;mwlucas@BlackHelicopters.org&gt;
# and Viktor Petersson &lt;vpetersson@wireload.net&gt;

# The names of the HAST resources, as listed in /etc/hast.conf
resources=&#34;test&#34;

# delay in mounting HAST resource after becoming primary
# make your best guess
delay=3

# logging
log=&#34;local0.debug&#34;
name=&#34;carp-hast&#34;

# end of user configurable stuff

case &#34;$1&#34; in
	primary)
		logger -p $log -t $name &#34;Switching to primary provider for ${resources}.&#34;
		sleep ${delay}

		# Wait for any &#34;hastd secondary&#34; processes to stop
		for disk in ${resources}; do
			while $( pgrep -lf &#34;hastd: ${disk} \(secondary\)&#34; &gt; /dev/null 2&gt;&amp;1 ); do
				sleep 1
			done

			# Switch role for each disk
			hastctl role primary ${disk}
			if [ $? -ne 0 ]; then
				logger -p $log -t $name &#34;Unable to change role to primary for resource ${disk}.&#34;
				exit 1
			fi
		done

		# Wait for the /dev/hast/* devices to appear
		for disk in ${resources}; do
			for I in $( jot 60 ); do
				[ -c &#34;/dev/hast/${disk}&#34; ] &amp;&amp; break
				sleep 0.5
			done

			if [ ! -c &#34;/dev/hast/${disk}&#34; ]; then
				logger -p $log -t $name &#34;GEOM provider /dev/hast/${disk} did not appear.&#34;
				exit 1
			fi
		done

		logger -p $log -t $name &#34;Role for HAST resources ${resources} switched to primary.&#34;

		logger -p $log -t $name &#34;Mounting disks.&#34;
		for disk in ${resources}; do
			mkdir -p /hast/${disk}
			fsck -p -y -t ufs /dev/hast/${disk}
			mount /dev/hast/${disk} /hast/${disk}
		done

	;;

	secondary)
		logger -p $log -t $name &#34;Switching to secondary provider for ${resources}.&#34;

		# Switch roles for the HAST resources
		for disk in ${resources}; do
			if ! mount | grep -q &#34;^/dev/hast/${disk} on &#34;
			then
			else
				umount -f /hast/${disk}
			fi
			sleep $delay
			hastctl role secondary ${disk} 2&gt;&amp;1
			if [ $? -ne 0 ]; then
				logger -p $log -t $name &#34;Unable to switch role to secondary for resource ${disk}.&#34;
				exit 1
			fi
			logger -p $log -t $name &#34;Role switched to secondary for resource ${disk}.&#34;
		done
	;;
esac</pre>
</div>
</div>
<div class="paragraph">
<p>In a nutshell, the script takes these actions when a node becomes primary:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Promotes the HAST pool to primary on the other node.</p>
</li>
<li>
<p>Checks the file system under the HAST pool.</p>
</li>
<li>
<p>Mounts the pool.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When a node becomes secondary:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Unmounts the HAST pool.</p>
</li>
<li>
<p>Degrades the HAST pool to secondary.</p>
</li>
</ul>
</div>
<div class="admonitionblock caution">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This is just an example script which serves as a proof of concept. It does not handle all the possible scenarios and can be extended or altered in any way, for example, to start or stop required services.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>For this example, a standard UFS file system was used. To reduce the time needed for recovery, a journal-enabled UFS or ZFS file system can be used instead.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>More detailed information with additional examples can be found at <a href="http://wiki.FreeBSD.org/HAST">http://wiki.FreeBSD.org/HAST</a>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_troubleshooting">20.15.3. Troubleshooting<a class="anchor" href="#_troubleshooting"></a></h4>
<div class="paragraph">
<p>HAST should generally work without issues. However, as with any other software product, there may be times when it does not work as supposed. The sources of the problems may be different, but the rule of thumb is to ensure that the time is synchronized between the nodes of the cluster.</p>
</div>
<div class="paragraph">
<p>When troubleshooting HAST, the debugging level of <a href="https://man.freebsd.org/cgi/man.cgi?query=hastd&amp;sektion=8&amp;format=html">hastd(8)</a> should be increased by starting <code>hastd</code> with <code>-d</code>. This argument may be specified multiple times to further increase the debugging level. Consider also using <code>-F</code>, which starts <code>hastd</code> in the foreground.</p>
</div>
<div class="sect4">
<h5 id="disks-hast-sb">20.15.3.1. Recovering from the Split-brain Condition<a class="anchor" href="#disks-hast-sb"></a></h5>
<div class="paragraph">
<p><em>Split-brain</em> occurs when the nodes of the cluster are unable to communicate with each other, and both are configured as primary. This is a dangerous condition because it allows both nodes to make incompatible changes to the data. This problem must be corrected manually by the system administrator.</p>
</div>
<div class="paragraph">
<p>The administrator must either decide which node has more important changes, or perform the merge manually. Then, let HAST perform full synchronization of the node which has the broken data. To do this, issue these commands on the node which needs to be resynchronized:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># hastctl role init test</span>
<span class="c"># hastctl create test</span>
<span class="c"># hastctl role secondary test</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="geom">Chapter 21. GEOM: Modular Disk Transformation Framework<a class="anchor" href="#geom"></a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="geom-synopsis">21.1. Synopsis<a class="anchor" href="#geom-synopsis"></a></h3>
<div class="paragraph">
<p>In FreeBSD, the GEOM framework permits access and control to classes, such as Master Boot Records and BSD labels, through the use of providers, or the disk devices in <span class="filename">/dev</span>. By supporting various software RAID configurations, GEOM transparently provides access to the operating system and operating system utilities.</p>
</div>
<div class="paragraph">
<p>This chapter covers the use of disks under the GEOM framework in FreeBSD. This includes the major RAID control utilities which use the framework for configuration. This chapter is not a definitive guide to RAID configurations and only GEOM-supported RAID classifications are discussed.</p>
</div>
<div class="paragraph">
<p>After reading this chapter, you will know:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>What type of RAID support is available through GEOM.</p>
</li>
<li>
<p>How to use the base utilities to configure, maintain, and manipulate the various RAID levels.</p>
</li>
<li>
<p>How to mirror, stripe, encrypt, and remotely connect disk devices through GEOM.</p>
</li>
<li>
<p>How to troubleshoot disks attached to the GEOM framework.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Before reading this chapter, you should:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Understand how FreeBSD treats disk devices (<a href="./#disks">Storage</a>).</p>
</li>
<li>
<p>Know how to configure and install a new kernel (<a href="./#kernelconfig">Configuring the FreeBSD Kernel</a>).</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="geom-striping">21.2. RAID0 - Striping<a class="anchor" href="#geom-striping"></a></h3>
<div class="paragraph">
<p>Striping combines several disk drives into a single volume. Striping can be performed through the use of hardware RAID controllers. The GEOM disk subsystem provides software support for disk striping, also known as RAID0, without the need for a RAID disk controller.</p>
</div>
<div class="paragraph">
<p>In RAID0, data is split into blocks that are written across all the drives in the array. As seen in the following illustration, instead of having to wait on the system to write 256k to one disk, RAID0 can simultaneously write 64k to each of the four disks in the array, offering superior I/O performance. This performance can be enhanced further by using multiple disk controllers.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/geom/striping.png" alt="Disk Striping Illustration"/>
</div>
</div>
<div class="paragraph">
<p>Each disk in a RAID0 stripe must be of the same size, since I/O requests are interleaved to read or write to multiple disks in parallel.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>RAID0 does <em>not</em> provide any redundancy. This means that if one disk in the array fails, all of the data on the disks is lost. If the data is important, implement a backup strategy that regularly saves backups to a remote system or device.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>The process for creating a software, GEOM-based RAID0 on a FreeBSD system using commodity disks is as follows. Once the stripe is created, refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=gstripe&amp;sektion=8&amp;format=html">gstripe(8)</a> for more information on how to control an existing stripe.</p>
</div>
<div class="sidebarblock procedure">
<div class="content">
<div class="paragraph">
<p><strong>Procedure: Creating a Stripe of Unformatted ATA Disks</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Load the <span class="filename">geom_stripe.ko</span> module:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># kldload geom_stripe</span></code></pre>
</div>
</div>
</li>
<li>
<p>Ensure that a suitable mount point exists. If this volume will become a root partition, then temporarily use another mount point such as <span class="filename">/mnt</span>.</p>
</li>
<li>
<p>Determine the device names for the disks which will be striped, and create the new stripe device. For example, to stripe two unused and unpartitioned ATA disks with device names of <span class="filename">/dev/ad2</span> and <span class="filename">/dev/ad3</span>:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># gstripe label -v st0 /dev/ad2 /dev/ad3</span>
Metadata value stored on /dev/ad2.
Metadata value stored on /dev/ad3.
Done.</code></pre>
</div>
</div>
</li>
<li>
<p>Write a standard label, also known as a partition table, on the new volume and install the default bootstrap code:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># bsdlabel -wB /dev/stripe/st0</span></code></pre>
</div>
</div>
</li>
<li>
<p>This process should create two other devices in <span class="filename">/dev/stripe</span> in addition to <span class="filename">st0</span>. Those include <span class="filename">st0a</span> and <span class="filename">st0c</span>. At this point, a UFS file system can be created on <span class="filename">st0a</span> using <code>newfs</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># newfs -U /dev/stripe/st0a</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Many numbers will glide across the screen, and after a few seconds, the process will be complete. The volume has been created and is ready to be mounted.</p>
</div>
</li>
<li>
<p>To manually mount the created disk stripe:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># mount /dev/stripe/st0a /mnt</span></code></pre>
</div>
</div>
</li>
<li>
<p>To mount this striped file system automatically during the boot process, place the volume information in <span class="filename">/etc/fstab</span>. In this example, a permanent mount point, named <span class="filename">stripe</span>, is created:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># mkdir /stripe</span>
<span class="c"># echo &#34;/dev/stripe/st0a /stripe ufs rw 2 2&#34; \</span>
<span class="gp">&gt;&gt; </span>/etc/fstab</code></pre>
</div>
</div>
</li>
<li>
<p>The <span class="filename">geom_stripe.ko</span> module must also be automatically loaded during system initialization, by adding a line to <span class="filename">/boot/loader.conf</span>:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># echo &#39;geom_stripe_load=&#34;YES&#34;&#39; &gt;&gt; /boot/loader.conf</span></code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="geom-mirror">21.3. RAID1 - Mirroring<a class="anchor" href="#geom-mirror"></a></h3>
<div class="paragraph">
<p>RAID1, or <em>mirroring</em>, is the technique of writing the same data to more than one disk drive. Mirrors are usually used to guard against data loss due to drive failure. Each drive in a mirror contains an identical copy of the data. When an individual drive fails, the mirror continues to work, providing data from the drives that are still functioning. The computer keeps running, and the administrator has time to replace the failed drive without user interruption.</p>
</div>
<div class="paragraph">
<p>Two common situations are illustrated in these examples. The first creates a mirror out of two new drives and uses it as a replacement for an existing single drive. The second example creates a mirror on a single new drive, copies the old drive’s data to it, then inserts the old drive into the mirror. While this procedure is slightly more complicated, it only requires one new drive.</p>
</div>
<div class="paragraph">
<p>Traditionally, the two drives in a mirror are identical in model and capacity, but <a href="https://man.freebsd.org/cgi/man.cgi?query=gmirror&amp;sektion=8&amp;format=html">gmirror(8)</a> does not require that. Mirrors created with dissimilar drives will have a capacity equal to that of the smallest drive in the mirror. Extra space on larger drives will be unused. Drives inserted into the mirror later must have at least as much capacity as the smallest drive already in the mirror.</p>
</div>
<div class="admonitionblock warning">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The mirroring procedures shown here are non-destructive, but as with any major disk operation, make a full backup first.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="admonitionblock warning">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>While <a href="https://man.freebsd.org/cgi/man.cgi?query=dump&amp;sektion=8&amp;format=html">dump(8)</a> is used in these procedures to copy file systems, it does not work on file systems with soft updates journaling. See <a href="https://man.freebsd.org/cgi/man.cgi?query=tunefs&amp;sektion=8&amp;format=html">tunefs(8)</a> for information on detecting and disabling soft updates journaling.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="sect3">
<h4 id="geom-mirror-metadata">21.3.1. Metadata Issues<a class="anchor" href="#geom-mirror-metadata"></a></h4>
<div class="paragraph">
<p>Many disk systems store metadata at the end of each disk. Old metadata should be erased before reusing the disk for a mirror. Most problems are caused by two particular types of leftover metadata: GPT partition tables and old metadata from a previous mirror.</p>
</div>
<div class="paragraph">
<p>GPT metadata can be erased with <a href="https://man.freebsd.org/cgi/man.cgi?query=gpart&amp;sektion=8&amp;format=html">gpart(8)</a>. This example erases both primary and backup GPT partition tables from disk <span class="filename">ada8</span>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># gpart destroy -F ada8</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A disk can be removed from an active mirror and the metadata erased in one step using <a href="https://man.freebsd.org/cgi/man.cgi?query=gmirror&amp;sektion=8&amp;format=html">gmirror(8)</a>. Here, the example disk <span class="filename">ada8</span> is removed from the active mirror <span class="filename">gm4</span>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># gmirror remove gm4 ada8</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If the mirror is not running, but old mirror metadata is still on the disk, use <code>gmirror clear</code> to remove it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># gmirror clear ada8</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><a href="https://man.freebsd.org/cgi/man.cgi?query=gmirror&amp;sektion=8&amp;format=html">gmirror(8)</a> stores one block of metadata at the end of the disk. As GPT partition schemes also store metadata at the end of the disk, mirroring entire GPT disks with <a href="https://man.freebsd.org/cgi/man.cgi?query=gmirror&amp;sektion=8&amp;format=html">gmirror(8)</a> is not recommended. MBR partitioning is used here because it only stores a partition table at the start of the disk and does not conflict with the mirror metadata.</p>
</div>
</div>
<div class="sect3">
<h4 id="geom-mirror-two-new-disks">21.3.2. Creating a Mirror with Two New Disks<a class="anchor" href="#geom-mirror-two-new-disks"></a></h4>
<div class="paragraph">
<p>In this example, FreeBSD has already been installed on a single disk, <span class="filename">ada0</span>. Two new disks, <span class="filename">ada1</span> and <span class="filename">ada2</span>, have been connected to the system. A new mirror will be created on these two disks and used to replace the old single disk.</p>
</div>
<div class="paragraph">
<p>The <span class="filename">geom_mirror.ko</span> kernel module must either be built into the kernel or loaded at boot- or run-time. Manually load the kernel module now:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># gmirror load</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Create the mirror with the two new drives:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># gmirror label -v gm0 /dev/ada1 /dev/ada2</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><span class="filename">gm0</span> is a user-chosen device name assigned to the new mirror. After the mirror has been started, this device name appears in <span class="filename">/dev/mirror/</span>.</p>
</div>
<div class="paragraph">
<p>MBR and bsdlabel partition tables can now be created on the mirror with <a href="https://man.freebsd.org/cgi/man.cgi?query=gpart&amp;sektion=8&amp;format=html">gpart(8)</a>. This example uses a traditional file system layout, with partitions for <span class="filename">/</span>, swap, <span class="filename">/var</span>, <span class="filename">/tmp</span>, and <span class="filename">/usr</span>. A single <span class="filename">/</span> and a swap partition will also work.</p>
</div>
<div class="paragraph">
<p>Partitions on the mirror do not have to be the same size as those on the existing disk, but they must be large enough to hold all the data already present on <span class="filename">ada0</span>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># gpart create -s MBR mirror/gm0</span>
<span class="c"># gpart add -t freebsd -a 4k mirror/gm0</span>
<span class="c"># gpart show mirror/gm0</span>
<span class="gp">=&gt;       </span>63  156301423  mirror/gm0  MBR  <span class="o">(</span>74G<span class="o">)</span>
         63         63                    - free -  <span class="o">(</span>31k<span class="o">)</span>
        126  156301299                 1  freebsd  <span class="o">(</span>74G<span class="o">)</span>
  156301425         61                    - free -  <span class="o">(</span>30k<span class="o">)</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># gpart create -s BSD mirror/gm0s1</span>
<span class="c"># gpart add -t freebsd-ufs  -a 4k -s 2g mirror/gm0s1</span>
<span class="c"># gpart add -t freebsd-swap -a 4k -s 4g mirror/gm0s1</span>
<span class="c"># gpart add -t freebsd-ufs  -a 4k -s 2g mirror/gm0s1</span>
<span class="c"># gpart add -t freebsd-ufs  -a 4k -s 1g mirror/gm0s1</span>
<span class="c"># gpart add -t freebsd-ufs  -a 4k mirror/gm0s1</span>
<span class="c"># gpart show mirror/gm0s1</span>
<span class="gp">=&gt;        </span>0  156301299  mirror/gm0s1  BSD  <span class="o">(</span>74G<span class="o">)</span>
          0          2                      - free -  <span class="o">(</span>1.0k<span class="o">)</span>
          2    4194304                   1  freebsd-ufs  <span class="o">(</span>2.0G<span class="o">)</span>
    4194306    8388608                   2  freebsd-swap <span class="o">(</span>4.0G<span class="o">)</span>
   12582914    4194304                   4  freebsd-ufs  <span class="o">(</span>2.0G<span class="o">)</span>
   16777218    2097152                   5  freebsd-ufs  <span class="o">(</span>1.0G<span class="o">)</span>
   18874370  137426928                   6  freebsd-ufs  <span class="o">(</span>65G<span class="o">)</span>
  156301298          1                      - free -  <span class="o">(</span>512B<span class="o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Make the mirror bootable by installing bootcode in the MBR and bsdlabel and setting the active slice:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># gpart bootcode -b /boot/mbr mirror/gm0</span>
<span class="c"># gpart set -a active -i 1 mirror/gm0</span>
<span class="c"># gpart bootcode -b /boot/boot mirror/gm0s1</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Format the file systems on the new mirror, enabling soft-updates.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># newfs -U /dev/mirror/gm0s1a</span>
<span class="c"># newfs -U /dev/mirror/gm0s1d</span>
<span class="c"># newfs -U /dev/mirror/gm0s1e</span>
<span class="c"># newfs -U /dev/mirror/gm0s1f</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>File systems from the original <span class="filename">ada0</span> disk can now be copied onto the mirror with <a href="https://man.freebsd.org/cgi/man.cgi?query=dump&amp;sektion=8&amp;format=html">dump(8)</a> and <a href="https://man.freebsd.org/cgi/man.cgi?query=restore&amp;sektion=8&amp;format=html">restore(8)</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># mount /dev/mirror/gm0s1a /mnt</span>
<span class="c"># dump -C16 -b64 -0aL -f - / | (cd /mnt &amp;&amp; restore -rf -)</span>
<span class="c"># mount /dev/mirror/gm0s1d /mnt/var</span>
<span class="c"># mount /dev/mirror/gm0s1e /mnt/tmp</span>
<span class="c"># mount /dev/mirror/gm0s1f /mnt/usr</span>
<span class="c"># dump -C16 -b64 -0aL -f - /var | (cd /mnt/var &amp;&amp; restore -rf -)</span>
<span class="c"># dump -C16 -b64 -0aL -f - /tmp | (cd /mnt/tmp &amp;&amp; restore -rf -)</span>
<span class="c"># dump -C16 -b64 -0aL -f - /usr | (cd /mnt/usr &amp;&amp; restore -rf -)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Edit <span class="filename">/mnt/etc/fstab</span> to point to the new mirror file systems:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre># Device		Mountpoint	FStype	Options	Dump	Pass#
/dev/mirror/gm0s1a	/		ufs	rw	1	1
/dev/mirror/gm0s1b	none		swap	sw	0	0
/dev/mirror/gm0s1d	/var		ufs	rw	2	2
/dev/mirror/gm0s1e	/tmp		ufs	rw	2	2
/dev/mirror/gm0s1f	/usr		ufs	rw	2	2</pre>
</div>
</div>
<div class="paragraph">
<p>If the <span class="filename">geom_mirror.ko</span> kernel module has not been built into the kernel, <span class="filename">/mnt/boot/loader.conf</span> is edited to load the module at boot:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>geom_mirror_load=&#34;YES&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>Reboot the system to test the new mirror and verify that all data has been copied. The BIOS will see the mirror as two individual drives rather than a mirror. Since the drives are identical, it does not matter which is selected to boot.</p>
</div>
<div class="paragraph">
<p>See <a href="#gmirror-troubleshooting">Troubleshooting</a> if there are problems booting. Powering down and disconnecting the original <span class="filename">ada0</span> disk will allow it to be kept as an offline backup.</p>
</div>
<div class="paragraph">
<p>In use, the mirror will behave just like the original single drive.</p>
</div>
</div>
<div class="sect3">
<h4 id="geom-mirror-existing-drive">21.3.3. Creating a Mirror with an Existing Drive<a class="anchor" href="#geom-mirror-existing-drive"></a></h4>
<div class="paragraph">
<p>In this example, FreeBSD has already been installed on a single disk, <span class="filename">ada0</span>. A new disk, <span class="filename">ada1</span>, has been connected to the system. A one-disk mirror will be created on the new disk, the existing system copied onto it, and then the old disk will be inserted into the mirror. This slightly complex procedure is required because <code>gmirror</code> needs to put a 512-byte block of metadata at the end of each disk, and the existing <span class="filename">ada0</span> has usually had all of its space already allocated.</p>
</div>
<div class="paragraph">
<p>Load the <span class="filename">geom_mirror.ko</span> kernel module:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># gmirror load</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Check the media size of the original disk with <code>diskinfo</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># diskinfo -v ada0 | head -n3</span>
/dev/ada0
        512             <span class="c"># sectorsize</span>
        1000204821504   <span class="c"># mediasize in bytes (931G)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Create a mirror on the new disk. To make certain that the mirror capacity is not any larger than the original <span class="filename">ada0</span> drive, <a href="https://man.freebsd.org/cgi/man.cgi?query=gnop&amp;sektion=8&amp;format=html">gnop(8)</a> is used to create a fake drive of the exact same size. This drive does not store any data, but is used only to limit the size of the mirror. When <a href="https://man.freebsd.org/cgi/man.cgi?query=gmirror&amp;sektion=8&amp;format=html">gmirror(8)</a> creates the mirror, it will restrict the capacity to the size of <span class="filename">gzero.nop</span>, even if the new <span class="filename">ada1</span> drive has more space. Note that the <em>1000204821504</em> in the second line is equal to <span class="filename">ada0</span>&#39;s media size as shown by <code>diskinfo</code> above.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># geom zero load</span>
<span class="c"># gnop create -s 1000204821504 gzero</span>
<span class="c"># gmirror label -v gm0 gzero.nop ada1</span>
<span class="c"># gmirror forget gm0</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Since <span class="filename">gzero.nop</span> does not store any data, the mirror does not see it as connected. The mirror is told to &#34;forget&#34; unconnected components, removing references to <span class="filename">gzero.nop</span>. The result is a mirror device containing only a single disk, <span class="filename">ada1</span>.</p>
</div>
<div class="paragraph">
<p>After creating <span class="filename">gm0</span>, view the partition table on <span class="filename">ada0</span>. This output is from a 1 TB drive. If there is some unallocated space at the end of the drive, the contents may be copied directly from <span class="filename">ada0</span> to the new mirror.</p>
</div>
<div class="paragraph">
<p>However, if the output shows that all of the space on the disk is allocated, as in the following listing, there is no space available for the 512-byte mirror metadata at the end of the disk.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># gpart show ada0</span>
<span class="gp">=&gt;        </span>63  1953525105        ada0  MBR  <span class="o">(</span>931G<span class="o">)</span>
          63  1953525105           1  freebsd  <span class="o">[</span>active]  <span class="o">(</span>931G<span class="o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case, the partition table must be edited to reduce the capacity by one sector on <span class="filename">mirror/gm0</span>. The procedure will be explained later.</p>
</div>
<div class="paragraph">
<p>In either case, partition tables on the primary disk should be first copied using <code>gpart backup</code> and <code>gpart restore</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># gpart backup ada0 &gt; table.ada0</span>
<span class="c"># gpart backup ada0s1 &gt; table.ada0s1</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>These commands create two files, <span class="filename">table.ada0</span> and <span class="filename">table.ada0s1</span>. This example is from a 1 TB drive:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># cat table.ada0</span>
MBR 4
1 freebsd         63 1953525105   <span class="o">[</span>active]</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># cat table.ada0s1</span>
BSD 8
1  freebsd-ufs          0    4194304
2 freebsd-swap    4194304   33554432
4  freebsd-ufs   37748736   50331648
5  freebsd-ufs   88080384   41943040
6  freebsd-ufs  130023424  838860800
7  freebsd-ufs  968884224  984640881</code></pre>
</div>
</div>
<div class="paragraph">
<p>If no free space is shown at the end of the disk, the size of both the slice and the last partition must be reduced by one sector. Edit the two files, reducing the size of both the slice and last partition by one. These are the last numbers in each listing.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># cat table.ada0</span>
MBR 4
1 freebsd         63 1953525104   <span class="o">[</span>active]</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># cat table.ada0s1</span>
BSD 8
1  freebsd-ufs          0    4194304
2 freebsd-swap    4194304   33554432
4  freebsd-ufs   37748736   50331648
5  freebsd-ufs   88080384   41943040
6  freebsd-ufs  130023424  838860800
7  freebsd-ufs  968884224  984640880</code></pre>
</div>
</div>
<div class="paragraph">
<p>If at least one sector was unallocated at the end of the disk, these two files can be used without modification.</p>
</div>
<div class="paragraph">
<p>Now restore the partition table into <span class="filename">mirror/gm0</span>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># gpart restore mirror/gm0 &lt; table.ada0</span>
<span class="c"># gpart restore mirror/gm0s1 &lt; table.ada0s1</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Check the partition table with <code>gpart show</code>. This example has <span class="filename">gm0s1a</span> for <span class="filename">/</span>, <span class="filename">gm0s1d</span> for <span class="filename">/var</span>, <span class="filename">gm0s1e</span> for <span class="filename">/usr</span>, <span class="filename">gm0s1f</span> for <span class="filename">/data1</span>, and <span class="filename">gm0s1g</span> for <span class="filename">/data2</span>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># gpart show mirror/gm0</span>
<span class="gp">=&gt;        </span>63  1953525104  mirror/gm0  MBR  <span class="o">(</span>931G<span class="o">)</span>
          63  1953525042           1  freebsd  <span class="o">[</span>active]  <span class="o">(</span>931G<span class="o">)</span>
  1953525105          62              - free -  <span class="o">(</span>31k<span class="o">)</span>

<span class="c"># gpart show mirror/gm0s1</span>
<span class="gp">=&gt;         </span>0  1953525042  mirror/gm0s1  BSD  <span class="o">(</span>931G<span class="o">)</span>
           0     2097152             1  freebsd-ufs  <span class="o">(</span>1.0G<span class="o">)</span>
     2097152    16777216             2  freebsd-swap  <span class="o">(</span>8.0G<span class="o">)</span>
    18874368    41943040             4  freebsd-ufs  <span class="o">(</span>20G<span class="o">)</span>
    60817408    20971520             5  freebsd-ufs  <span class="o">(</span>10G<span class="o">)</span>
    81788928   629145600             6  freebsd-ufs  <span class="o">(</span>300G<span class="o">)</span>
   710934528  1242590514             7  freebsd-ufs  <span class="o">(</span>592G<span class="o">)</span>
  1953525042          63                - free -  <span class="o">(</span>31k<span class="o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Both the slice and the last partition must have at least one free block at the end of the disk.</p>
</div>
<div class="paragraph">
<p>Create file systems on these new partitions. The number of partitions will vary to match the original disk, <span class="filename">ada0</span>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># newfs -U /dev/mirror/gm0s1a</span>
<span class="c"># newfs -U /dev/mirror/gm0s1d</span>
<span class="c"># newfs -U /dev/mirror/gm0s1e</span>
<span class="c"># newfs -U /dev/mirror/gm0s1f</span>
<span class="c"># newfs -U /dev/mirror/gm0s1g</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Make the mirror bootable by installing bootcode in the MBR and bsdlabel and setting the active slice:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># gpart bootcode -b /boot/mbr mirror/gm0</span>
<span class="c"># gpart set -a active -i 1 mirror/gm0</span>
<span class="c"># gpart bootcode -b /boot/boot mirror/gm0s1</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Adjust <span class="filename">/etc/fstab</span> to use the new partitions on the mirror. Back up this file first by copying it to <span class="filename">/etc/fstab.orig</span>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># cp /etc/fstab /etc/fstab.orig</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Edit <span class="filename">/etc/fstab</span>, replacing <span class="filename">/dev/ada0</span> with <span class="filename">mirror/gm0</span>.</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre># Device		Mountpoint	FStype	Options	Dump	Pass#
/dev/mirror/gm0s1a	/		ufs	rw	1	1
/dev/mirror/gm0s1b	none		swap	sw	0	0
/dev/mirror/gm0s1d	/var		ufs	rw	2	2
/dev/mirror/gm0s1e	/usr		ufs	rw	2	2
/dev/mirror/gm0s1f	/data1		ufs	rw	2	2
/dev/mirror/gm0s1g	/data2		ufs	rw	2	2</pre>
</div>
</div>
<div class="paragraph">
<p>If the <span class="filename">geom_mirror.ko</span> kernel module has not been built into the kernel, edit <span class="filename">/boot/loader.conf</span> to load it at boot:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>geom_mirror_load=&#34;YES&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>File systems from the original disk can now be copied onto the mirror with <a href="https://man.freebsd.org/cgi/man.cgi?query=dump&amp;sektion=8&amp;format=html">dump(8)</a> and <a href="https://man.freebsd.org/cgi/man.cgi?query=restore&amp;sektion=8&amp;format=html">restore(8)</a>. Each file system dumped with <code>dump -L</code> will create a snapshot first, which can take some time.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># mount /dev/mirror/gm0s1a /mnt</span>
<span class="c"># dump -C16 -b64 -0aL -f - /    | (cd /mnt &amp;&amp; restore -rf -)</span>
<span class="c"># mount /dev/mirror/gm0s1d /mnt/var</span>
<span class="c"># mount /dev/mirror/gm0s1e /mnt/usr</span>
<span class="c"># mount /dev/mirror/gm0s1f /mnt/data1</span>
<span class="c"># mount /dev/mirror/gm0s1g /mnt/data2</span>
<span class="c"># dump -C16 -b64 -0aL -f - /usr | (cd /mnt/usr &amp;&amp; restore -rf -)</span>
<span class="c"># dump -C16 -b64 -0aL -f - /var | (cd /mnt/var &amp;&amp; restore -rf -)</span>
<span class="c"># dump -C16 -b64 -0aL -f - /data1 | (cd /mnt/data1 &amp;&amp; restore -rf -)</span>
<span class="c"># dump -C16 -b64 -0aL -f - /data2 | (cd /mnt/data2 &amp;&amp; restore -rf -)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Restart the system, booting from <span class="filename">ada1</span>. If everything is working, the system will boot from <span class="filename">mirror/gm0</span>, which now contains the same data as <span class="filename">ada0</span> had previously. See <a href="#gmirror-troubleshooting">Troubleshooting</a> if there are problems booting.</p>
</div>
<div class="paragraph">
<p>At this point, the mirror still consists of only the single <span class="filename">ada1</span> disk.</p>
</div>
<div class="paragraph">
<p>After booting from <span class="filename">mirror/gm0</span> successfully, the final step is inserting <span class="filename">ada0</span> into the mirror.</p>
</div>
<div class="admonitionblock important">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When <span class="filename">ada0</span> is inserted into the mirror, its former contents will be overwritten by data from the mirror. Make certain that <span class="filename">mirror/gm0</span> has the same contents as <span class="filename">ada0</span> before adding <span class="filename">ada0</span> to the mirror. If the contents previously copied by <a href="https://man.freebsd.org/cgi/man.cgi?query=dump&amp;sektion=8&amp;format=html">dump(8)</a> and <a href="https://man.freebsd.org/cgi/man.cgi?query=restore&amp;sektion=8&amp;format=html">restore(8)</a> are not identical to what was on <span class="filename">ada0</span>, revert <span class="filename">/etc/fstab</span> to mount the file systems on <span class="filename">ada0</span>, reboot, and start the whole procedure again.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># gmirror insert gm0 ada0</span>
GEOM_MIRROR: Device gm0: rebuilding provider ada0</code></pre>
</div>
</div>
<div class="paragraph">
<p>Synchronization between the two disks will start immediately. Use <code>gmirror status</code> to view the progress.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># gmirror status</span>
      Name    Status  Components
mirror/gm0  DEGRADED  ada1 <span class="o">(</span>ACTIVE<span class="o">)</span>
                      ada0 <span class="o">(</span>SYNCHRONIZING, 64%<span class="o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>After a while, synchronization will finish.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">GEOM_MIRROR: Device gm0: rebuilding provider ada0 finished.
<span class="c"># gmirror status</span>
      Name    Status  Components
mirror/gm0  COMPLETE  ada1 <span class="o">(</span>ACTIVE<span class="o">)</span>
                      ada0 <span class="o">(</span>ACTIVE<span class="o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><span class="filename">mirror/gm0</span> now consists of the two disks <span class="filename">ada0</span> and <span class="filename">ada1</span>, and the contents are automatically synchronized with each other. In use, <span class="filename">mirror/gm0</span> will behave just like the original single drive.</p>
</div>
</div>
<div class="sect3">
<h4 id="gmirror-troubleshooting">21.3.4. Troubleshooting<a class="anchor" href="#gmirror-troubleshooting"></a></h4>
<div class="paragraph">
<p>If the system no longer boots, BIOS settings may have to be changed to boot from one of the new mirrored drives. Either mirror drive can be used for booting, as they contain identical data.</p>
</div>
<div class="paragraph">
<p>If the boot stops with this message, something is wrong with the mirror device:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">Mounting from ufs:/dev/mirror/gm0s1a failed with error 19.

Loader variables:
  vfs.root.mountfrom<span class="o">=</span>ufs:/dev/mirror/gm0s1a
  vfs.root.mountfrom.options<span class="o">=</span>rw

Manual root filesystem specification:
  &lt;fstype&gt;:&lt;device&gt; <span class="o">[</span>options]
      Mount &lt;device&gt; using filesystem &lt;fstype&gt;
      and with the specified <span class="o">(</span>optional<span class="o">)</span> option list.

    e.g. ufs:/dev/da0s1a
        zfs:tank
        cd9660:/dev/acd0 ro
          <span class="o">(</span>which is equivalent to: mount -t cd9660 -o ro /dev/acd0 /<span class="o">)</span>

  ?               List valid disk boot devices
  .               Yield 1 second <span class="o">(</span><span class="k">for </span>background tasks<span class="o">)</span>
  &lt;empty line&gt;    Abort manual input

mountroot&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Forgetting to load the <span class="filename">geom_mirror.ko</span> module in <span class="filename">/boot/loader.conf</span> can cause this problem. To fix it, boot from a FreeBSD installation media and choose <code>Shell</code> at the first prompt. Then load the mirror module and mount the mirror device:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># gmirror load</span>
<span class="c"># mount /dev/mirror/gm0s1a /mnt</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Edit <span class="filename">/mnt/boot/loader.conf</span>, adding a line to load the mirror module:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>geom_mirror_load=&#34;YES&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>Save the file and reboot.</p>
</div>
<div class="paragraph">
<p>Other problems that cause <code>error 19</code> require more effort to fix. Although the system should boot from <span class="filename">ada0</span>, another prompt to select a shell will appear if <span class="filename">/etc/fstab</span> is incorrect. Enter <code>ufs:/dev/ada0s1a</code> at the boot loader prompt and press <kbd>Enter</kbd>. Undo the edits in <span class="filename">/etc/fstab</span> then mount the file systems from the original disk (<span class="filename">ada0</span>) instead of the mirror. Reboot the system and try the procedure again.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">Enter full pathname of shell or RETURN <span class="k">for</span> /bin/sh:
<span class="c"># cp /etc/fstab.orig /etc/fstab</span>
<span class="c"># reboot</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_recovering_from_disk_failure">21.3.5. Recovering from Disk Failure<a class="anchor" href="#_recovering_from_disk_failure"></a></h4>
<div class="paragraph">
<p>The benefit of disk mirroring is that an individual disk can fail without causing the mirror to lose any data. In the above example, if <span class="filename">ada0</span> fails, the mirror will continue to work, providing data from the remaining working drive, <span class="filename">ada1</span>.</p>
</div>
<div class="paragraph">
<p>To replace the failed drive, shut down the system and physically replace the failed drive with a new drive of equal or greater capacity. Manufacturers use somewhat arbitrary values when rating drives in gigabytes, and the only way to really be sure is to compare the total count of sectors shown by <code>diskinfo -v</code>. A drive with larger capacity than the mirror will work, although the extra space on the new drive will not be used.</p>
</div>
<div class="paragraph">
<p>After the computer is powered back up, the mirror will be running in a &#34;degraded&#34; mode with only one drive. The mirror is told to forget drives that are not currently connected:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># gmirror forget gm0</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Any old metadata should be cleared from the replacement disk using the instructions in <a href="#geom-mirror-metadata">Metadata Issues</a>. Then the replacement disk, <span class="filename">ada4</span> for this example, is inserted into the mirror:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># gmirror insert gm0 /dev/ada4</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Resynchronization begins when the new drive is inserted into the mirror. This process of copying mirror data to a new drive can take a while. Performance of the mirror will be greatly reduced during the copy, so inserting new drives is best done when there is low demand on the computer.</p>
</div>
<div class="paragraph">
<p>Progress can be monitored with <code>gmirror status</code>, which shows drives that are being synchronized and the percentage of completion. During resynchronization, the status will be <code>DEGRADED</code>, changing to <code>COMPLETE</code> when the process is finished.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="geom-raid3">21.4. RAID3 - Byte-level Striping with Dedicated Parity<a class="anchor" href="#geom-raid3"></a></h3>
<div class="paragraph">
<p>RAID3 is a method used to combine several disk drives into a single volume with a dedicated parity disk. In a RAID3 system, data is split up into a number of bytes that are written across all the drives in the array except for one disk which acts as a dedicated parity disk. This means that disk reads from a RAID3 implementation access all disks in the array. Performance can be enhanced by using multiple disk controllers. The RAID3 array provides a fault tolerance of 1 drive, while providing a capacity of 1 - 1/n times the total capacity of all drives in the array, where n is the number of hard drives in the array. Such a configuration is mostly suitable for storing data of larger sizes such as multimedia files.</p>
</div>
<div class="paragraph">
<p>At least 3 physical hard drives are required to build a RAID3 array. Each disk must be of the same size, since I/O requests are interleaved to read or write to multiple disks in parallel. Also, due to the nature of RAID3, the number of drives must be equal to 3, 5, 9, 17, and so on, or 2^n + 1.</p>
</div>
<div class="paragraph">
<p>This section demonstrates how to create a software RAID3 on a FreeBSD system.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>While it is theoretically possible to boot from a RAID3 array on FreeBSD, that configuration is uncommon and is not advised.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="sect3">
<h4 id="_creating_a_dedicated_raid3_array">21.4.1. Creating a Dedicated RAID3 Array<a class="anchor" href="#_creating_a_dedicated_raid3_array"></a></h4>
<div class="paragraph">
<p>In FreeBSD, support for RAID3 is implemented by the <a href="https://man.freebsd.org/cgi/man.cgi?query=graid3&amp;sektion=8&amp;format=html">graid3(8)</a> GEOM class. Creating a dedicated RAID3 array on FreeBSD requires the following steps.</p>
</div>
<div class="olist arabic procedure">
<ol class="arabic">
<li>
<p>First, load the <span class="filename">geom_raid3.ko</span> kernel module by issuing one of the following commands:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># graid3 load</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>or:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># kldload geom_raid3</span></code></pre>
</div>
</div>
</li>
<li>
<p>Ensure that a suitable mount point exists. This command creates a new directory to use as the mount point:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># mkdir /multimedia</span></code></pre>
</div>
</div>
</li>
<li>
<p>Determine the device names for the disks which will be added to the array, and create the new RAID3 device. The final device listed will act as the dedicated parity disk. This example uses three unpartitioned ATA drives: <span class="filename">ada1</span> and <span class="filename">ada2</span> for data, and <span class="filename">ada3</span> for parity.</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># graid3 label -v gr0 /dev/ada1 /dev/ada2 /dev/ada3</span>
Metadata value stored on /dev/ada1.
Metadata value stored on /dev/ada2.
Metadata value stored on /dev/ada3.
Done.</code></pre>
</div>
</div>
</li>
<li>
<p>Partition the newly created <span class="filename">gr0</span> device and put a UFS file system on it:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># gpart create -s GPT /dev/raid3/gr0</span>
<span class="c"># gpart add -t freebsd-ufs /dev/raid3/gr0</span>
<span class="c"># newfs -j /dev/raid3/gr0p1</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Many numbers will glide across the screen, and after a bit of time, the process will be complete. The volume has been created and is ready to be mounted:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># mount /dev/raid3/gr0p1 /multimedia/</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The RAID3 array is now ready to use.</p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Additional configuration is needed to retain this setup across system reboots.</p>
</div>
<div class="olist arabic procedure">
<ol class="arabic">
<li>
<p>The <span class="filename">geom_raid3.ko</span> module must be loaded before the array can be mounted. To automatically load the kernel module during system initialization, add the following line to <span class="filename">/boot/loader.conf</span>:</p>
<div class="literalblock programlisting">
<div class="content">
<pre>geom_raid3_load=&#34;YES&#34;</pre>
</div>
</div>
</li>
<li>
<p>The following volume information must be added to <span class="filename">/etc/fstab</span> in order to automatically mount the array’s file system during the system boot process:</p>
<div class="literalblock programlisting">
<div class="content">
<pre>/dev/raid3/gr0p1	/multimedia	ufs	rw	2	2</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="geom-graid">21.5. Software RAID Devices<a class="anchor" href="#geom-graid"></a></h3>
<div class="paragraph">
<p>Some motherboards and expansion cards add some simple hardware, usually just a ROM, that allows the computer to boot from a RAID array. After booting, access to the RAID array is handled by software running on the computer’s main processor. This &#34;hardware-assisted software RAID&#34; gives RAID arrays that are not dependent on any particular operating system, and which are functional even before an operating system is loaded.</p>
</div>
<div class="paragraph">
<p>Several levels of RAID are supported, depending on the hardware in use. See <a href="https://man.freebsd.org/cgi/man.cgi?query=graid&amp;sektion=8&amp;format=html">graid(8)</a> for a complete list.</p>
</div>
<div class="paragraph">
<p><a href="https://man.freebsd.org/cgi/man.cgi?query=graid&amp;sektion=8&amp;format=html">graid(8)</a> requires the <span class="filename">geom_raid.ko</span> kernel module, which is included in the <span class="filename">GENERIC</span> kernel starting with FreeBSD 9.1. If needed, it can be loaded manually with <code>graid load</code>.</p>
</div>
<div class="sect3">
<h4 id="geom-graid-creating">21.5.1. Creating an Array<a class="anchor" href="#geom-graid-creating"></a></h4>
<div class="paragraph">
<p>Software RAID devices often have a menu that can be entered by pressing special keys when the computer is booting. The menu can be used to create and delete RAID arrays. <a href="https://man.freebsd.org/cgi/man.cgi?query=graid&amp;sektion=8&amp;format=html">graid(8)</a> can also create arrays directly from the command line.</p>
</div>
<div class="paragraph">
<p><code>graid label</code> is used to create a new array. The motherboard used for this example has an Intel software RAID chipset, so the Intel metadata format is specified. The new array is given a label of <span class="filename">gm0</span>, it is a mirror (RAID1), and uses drives <span class="filename">ada0</span> and <span class="filename">ada1</span>.</p>
</div>
<div class="admonitionblock caution">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Some space on the drives will be overwritten when they are made into a new array. Back up existing data first!</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># graid label Intel gm0 RAID1 ada0 ada1</span>
GEOM_RAID: Intel-a29ea104: Array Intel-a29ea104 created.
GEOM_RAID: Intel-a29ea104: Disk ada0 state changed from NONE to ACTIVE.
GEOM_RAID: Intel-a29ea104: Subdisk gm0:0-ada0 state changed from NONE to ACTIVE.
GEOM_RAID: Intel-a29ea104: Disk ada1 state changed from NONE to ACTIVE.
GEOM_RAID: Intel-a29ea104: Subdisk gm0:1-ada1 state changed from NONE to ACTIVE.
GEOM_RAID: Intel-a29ea104: Array started.
GEOM_RAID: Intel-a29ea104: Volume gm0 state changed from STARTING to OPTIMAL.
Intel-a29ea104 created
GEOM_RAID: Intel-a29ea104: Provider raid/r0 <span class="k">for </span>volume gm0 created.</code></pre>
</div>
</div>
<div class="paragraph">
<p>A status check shows the new mirror is ready for use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># graid status</span>
   Name   Status  Components
raid/r0  OPTIMAL  ada0 <span class="o">(</span>ACTIVE <span class="o">(</span>ACTIVE<span class="o">))</span>
                  ada1 <span class="o">(</span>ACTIVE <span class="o">(</span>ACTIVE<span class="o">))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The array device appears in <span class="filename">/dev/raid/</span>. The first array is called <span class="filename">r0</span>. Additional arrays, if present, will be <span class="filename">r1</span>, <span class="filename">r2</span>, and so on.</p>
</div>
<div class="paragraph">
<p>The BIOS menu on some of these devices can create arrays with special characters in their names. To avoid problems with those special characters, arrays are given simple numbered names like <span class="filename">r0</span>. To show the actual labels, like <span class="filename">gm0</span> in the example above, use <a href="https://man.freebsd.org/cgi/man.cgi?query=sysctl&amp;sektion=8&amp;format=html">sysctl(8)</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysctl kern.geom.raid.name_format=1</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="geom-graid-volumes">21.5.2. Multiple Volumes<a class="anchor" href="#geom-graid-volumes"></a></h4>
<div class="paragraph">
<p>Some software RAID devices support more than one <em>volume</em> on an array. Volumes work like partitions, allowing space on the physical drives to be split and used in different ways. For example, Intel software RAID devices support two volumes. This example creates a 40 G mirror for safely storing the operating system, followed by a 20 G RAID0 (stripe) volume for fast temporary storage:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># graid label -S 40G Intel gm0 RAID1 ada0 ada1</span>
<span class="c"># graid add -S 20G gm0 RAID0</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Volumes appear as additional <span class="filename">rX</span> entries in <span class="filename">/dev/raid/</span>. An array with two volumes will show <span class="filename">r0</span> and <span class="filename">r1</span>.</p>
</div>
<div class="paragraph">
<p>See <a href="https://man.freebsd.org/cgi/man.cgi?query=graid&amp;sektion=8&amp;format=html">graid(8)</a> for the number of volumes supported by different software RAID devices.</p>
</div>
</div>
<div class="sect3">
<h4 id="geom-graid-converting">21.5.3. Converting a Single Drive to a Mirror<a class="anchor" href="#geom-graid-converting"></a></h4>
<div class="paragraph">
<p>Under certain specific conditions, it is possible to convert an existing single drive to a <a href="https://man.freebsd.org/cgi/man.cgi?query=graid&amp;sektion=8&amp;format=html">graid(8)</a> array without reformatting. To avoid data loss during the conversion, the existing drive must meet these minimum requirements:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The drive must be partitioned with the MBR partitioning scheme. GPT or other partitioning schemes with metadata at the end of the drive will be overwritten and corrupted by the <a href="https://man.freebsd.org/cgi/man.cgi?query=graid&amp;sektion=8&amp;format=html">graid(8)</a> metadata.</p>
</li>
<li>
<p>There must be enough unpartitioned and unused space at the end of the drive to hold the <a href="https://man.freebsd.org/cgi/man.cgi?query=graid&amp;sektion=8&amp;format=html">graid(8)</a> metadata. This metadata varies in size, but the largest occupies 64 M, so at least that much free space is recommended.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If the drive meets these requirements, start by making a full backup. Then create a single-drive mirror with that drive:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># graid label Intel gm0 RAID1 ada0 NONE</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><a href="https://man.freebsd.org/cgi/man.cgi?query=graid&amp;sektion=8&amp;format=html">graid(8)</a> metadata was written to the end of the drive in the unused space. A second drive can now be inserted into the mirror:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># graid insert raid/r0 ada1</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Data from the original drive will immediately begin to be copied to the second drive. The mirror will operate in degraded status until the copy is complete.</p>
</div>
</div>
<div class="sect3">
<h4 id="geom-graid-inserting">21.5.4. Inserting New Drives into the Array<a class="anchor" href="#geom-graid-inserting"></a></h4>
<div class="paragraph">
<p>Drives can be inserted into an array as replacements for drives that have failed or are missing. If there are no failed or missing drives, the new drive becomes a spare. For example, inserting a new drive into a working two-drive mirror results in a two-drive mirror with one spare drive, not a three-drive mirror.</p>
</div>
<div class="paragraph">
<p>In the example mirror array, data immediately begins to be copied to the newly-inserted drive. Any existing information on the new drive will be overwritten.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># graid insert raid/r0 ada1</span>
GEOM_RAID: Intel-a29ea104: Disk ada1 state changed from NONE to ACTIVE.
GEOM_RAID: Intel-a29ea104: Subdisk gm0:1-ada1 state changed from NONE to NEW.
GEOM_RAID: Intel-a29ea104: Subdisk gm0:1-ada1 state changed from NEW to REBUILD.
GEOM_RAID: Intel-a29ea104: Subdisk gm0:1-ada1 rebuild start at 0.</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="geom-graid-removing">21.5.5. Removing Drives from the Array<a class="anchor" href="#geom-graid-removing"></a></h4>
<div class="paragraph">
<p>Individual drives can be permanently removed from a from an array and their metadata erased:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># graid remove raid/r0 ada1</span>
GEOM_RAID: Intel-a29ea104: Disk ada1 state changed from ACTIVE to OFFLINE.
GEOM_RAID: Intel-a29ea104: Subdisk gm0:1-[unknown] state changed from ACTIVE to NONE.
GEOM_RAID: Intel-a29ea104: Volume gm0 state changed from OPTIMAL to DEGRADED.</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="geom-graid-stopping">21.5.6. Stopping the Array<a class="anchor" href="#geom-graid-stopping"></a></h4>
<div class="paragraph">
<p>An array can be stopped without removing metadata from the drives. The array will be restarted when the system is booted.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># graid stop raid/r0</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="geom-graid-status">21.5.7. Checking Array Status<a class="anchor" href="#geom-graid-status"></a></h4>
<div class="paragraph">
<p>Array status can be checked at any time. After a drive was added to the mirror in the example above, data is being copied from the original drive to the new drive:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># graid status</span>
   Name    Status  Components
raid/r0  DEGRADED  ada0 <span class="o">(</span>ACTIVE <span class="o">(</span>ACTIVE<span class="o">))</span>
                   ada1 <span class="o">(</span>ACTIVE <span class="o">(</span>REBUILD 28%<span class="o">))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Some types of arrays, like <code>RAID0</code> or <code>CONCAT</code>, may not be shown in the status report if disks have failed. To see these partially-failed arrays, add <code>-ga</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># graid status -ga</span>
          Name  Status  Components
Intel-e2d07d9a  BROKEN  ada6 <span class="o">(</span>ACTIVE <span class="o">(</span>ACTIVE<span class="o">))</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="geom-graid-deleting">21.5.8. Deleting Arrays<a class="anchor" href="#geom-graid-deleting"></a></h4>
<div class="paragraph">
<p>Arrays are destroyed by deleting all of the volumes from them. When the last volume present is deleted, the array is stopped and metadata is removed from the drives:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># graid delete raid/r0</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="geom-graid-unexpected">21.5.9. Deleting Unexpected Arrays<a class="anchor" href="#geom-graid-unexpected"></a></h4>
<div class="paragraph">
<p>Drives may unexpectedly contain <a href="https://man.freebsd.org/cgi/man.cgi?query=graid&amp;sektion=8&amp;format=html">graid(8)</a> metadata, either from previous use or manufacturer testing. <a href="https://man.freebsd.org/cgi/man.cgi?query=graid&amp;sektion=8&amp;format=html">graid(8)</a> will detect these drives and create an array, interfering with access to the individual drive. To remove the unwanted metadata:</p>
</div>
<div class="olist arabic procedure">
<ol class="arabic">
<li>
<p>Boot the system. At the boot menu, select <code>2</code> for the loader prompt. Enter:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">OK <span class="nb">set </span>kern.geom.raid.enable<span class="o">=</span>0
OK boot</code></pre>
</div>
</div>
<div class="paragraph">
<p>The system will boot with <a href="https://man.freebsd.org/cgi/man.cgi?query=graid&amp;sektion=8&amp;format=html">graid(8)</a> disabled.</p>
</div>
</li>
<li>
<p>Back up all data on the affected drive.</p>
</li>
<li>
<p>As a workaround, <a href="https://man.freebsd.org/cgi/man.cgi?query=graid&amp;sektion=8&amp;format=html">graid(8)</a> array detection can be disabled by adding</p>
<div class="literalblock programlisting">
<div class="content">
<pre>kern.geom.raid.enable=0</pre>
</div>
</div>
<div class="paragraph">
<p>to <span class="filename">/boot/loader.conf</span>.</p>
</div>
<div class="paragraph">
<p>To permanently remove the <a href="https://man.freebsd.org/cgi/man.cgi?query=graid&amp;sektion=8&amp;format=html">graid(8)</a> metadata from the affected drive, boot a FreeBSD installation CD-ROM or memory stick, and select <code>Shell</code>. Use <code>status</code> to find the name of the array, typically <code>raid/r0</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># graid status</span>
   Name   Status  Components
raid/r0  OPTIMAL  ada0 <span class="o">(</span>ACTIVE <span class="o">(</span>ACTIVE<span class="o">))</span>
                  ada1 <span class="o">(</span>ACTIVE <span class="o">(</span>ACTIVE<span class="o">))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Delete the volume by name:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># graid delete raid/r0</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If there is more than one volume shown, repeat the process for each volume. After the last array has been deleted, the volume will be destroyed.</p>
</div>
<div class="paragraph">
<p>Reboot and verify data, restoring from backup if necessary. After the metadata has been removed, the <code>kern.geom.raid.enable=0</code> entry in <span class="filename">/boot/loader.conf</span> can also be removed.</p>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="geom-ggate">21.6. GEOM Gate Network<a class="anchor" href="#geom-ggate"></a></h3>
<div class="paragraph">
<p>GEOM provides a simple mechanism for providing remote access to devices such as disks, CDs, and file systems through the use of the GEOM Gate network daemon, ggated. The system with the device runs the server daemon which handles requests made by clients using ggatec. The devices should not contain any sensitive data as the connection between the client and the server is not encrypted.</p>
</div>
<div class="paragraph">
<p>Similar to NFS, which is discussed in <a href="./#network-nfs">Network File System (NFS)</a>, ggated is configured using an exports file. This file specifies which systems are permitted to access the exported resources and what level of access they are offered. For example, to give the client <code>192.168.1.5</code> read and write access to the fourth slice on the first SCSI disk, create <span class="filename">/etc/gg.exports</span> with this line:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>192.168.1.5 RW /dev/da0s4d</pre>
</div>
</div>
<div class="paragraph">
<p>Before exporting the device, ensure it is not currently mounted. Then, start ggated:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ggated</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Several options are available for specifying an alternate listening port or changing the default location of the exports file. Refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=ggated&amp;sektion=8&amp;format=html">ggated(8)</a> for details.</p>
</div>
<div class="paragraph">
<p>To access the exported device on the client machine, first use <code>ggatec</code> to specify the IP address of the server and the device name of the exported device. If successful, this command will display a <code>ggate</code> device name to mount. Mount that specified device name on a free mount point. This example connects to the <span class="filename">/dev/da0s4d</span> partition on <code>192.168.1.1</code>, then mounts <span class="filename">/dev/ggate0</span> on <span class="filename">/mnt</span>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ggatec create -o rw 192.168.1.1 /dev/da0s4d</span>
ggate0
<span class="c"># mount /dev/ggate0 /mnt</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The device on the server may now be accessed through <span class="filename">/mnt</span> on the client. For more details about <code>ggatec</code> and a few usage examples, refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=ggatec&amp;sektion=8&amp;format=html">ggatec(8)</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The mount will fail if the device is currently mounted on either the server or any other client on the network. If simultaneous access is needed to network resources, use NFS instead.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>When the device is no longer needed, unmount it with <code>umount</code> so that the resource is available to other clients.</p>
</div>
</div>
<div class="sect2">
<h3 id="geom-glabel">21.7. Labeling Disk Devices<a class="anchor" href="#geom-glabel"></a></h3>
<div class="paragraph">
<p>During system initialization, the FreeBSD kernel creates device nodes as devices are found. This method of probing for devices raises some issues. For instance, what if a new disk device is added via USB? It is likely that a flash device may be handed the device name of <span class="filename">da0</span> and the original <span class="filename">da0</span> shifted to <span class="filename">da1</span>. This will cause issues mounting file systems if they are listed in <span class="filename">/etc/fstab</span> which may also prevent the system from booting.</p>
</div>
<div class="paragraph">
<p>One solution is to chain SCSI devices in order so a new device added to the SCSI card will be issued unused device numbers. But what about USB devices which may replace the primary SCSI disk? This happens because USB devices are usually probed before the SCSI card. One solution is to only insert these devices after the system has been booted. Another method is to use only a single ATA drive and never list the SCSI devices in <span class="filename">/etc/fstab</span>.</p>
</div>
<div class="paragraph">
<p>A better solution is to use <code>glabel</code> to label the disk devices and use the labels in <span class="filename">/etc/fstab</span>. Since <code>glabel</code> stores the label in the last sector of a given provider, the label will remain persistent across reboots. By using this label as a device, the file-system may always be mounted regardless of what device node it is accessed through.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>glabel</code> can create both transient and permanent labels. Only permanent labels are consistent across reboots. Refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=glabel&amp;sektion=8&amp;format=html">glabel(8)</a> for more information on the differences between labels.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="sect3">
<h4 id="_label_types_and_examples">21.7.1. Label Types and Examples<a class="anchor" href="#_label_types_and_examples"></a></h4>
<div class="paragraph">
<p>Permanent labels can be a generic or a file system label. Permanent file system labels can be created with <a href="https://man.freebsd.org/cgi/man.cgi?query=tunefs&amp;sektion=8&amp;format=html">tunefs(8)</a> or <a href="https://man.freebsd.org/cgi/man.cgi?query=newfs&amp;sektion=8&amp;format=html">newfs(8)</a>. These types of labels are created in a sub-directory of <span class="filename">/dev</span>, and will be named according to the file system type. For example, UFS2 file system labels will be created in <span class="filename">/dev/ufs</span>. Generic permanent labels can be created with <code>glabel label</code>. These are not file system specific and will be created in <span class="filename">/dev/label</span>.</p>
</div>
<div class="paragraph">
<p>Temporary labels are destroyed at the next reboot. These labels are created in <span class="filename">/dev/label</span> and are suited to experimentation. A temporary label can be created using <code>glabel create</code>.</p>
</div>
<div class="paragraph">
<p>To create a permanent label for a UFS2 file system without destroying any data, issue the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># tunefs -L home /dev/da3</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A label should now exist in <span class="filename">/dev/ufs</span> which may be added to <span class="filename">/etc/fstab</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>/dev/ufs/home		/home            ufs     rw              2      2</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The file system must not be mounted while attempting to run <code>tunefs</code>.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Now the file system may be mounted:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># mount /home</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>From this point on, so long as the <span class="filename">geom_label.ko</span> kernel module is loaded at boot with <span class="filename">/boot/loader.conf</span> or the <code>GEOM_LABEL</code> kernel option is present, the device node may change without any ill effect on the system.</p>
</div>
<div class="paragraph">
<p>File systems may also be created with a default label by using the <code>-L</code> flag with <code>newfs</code>. Refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=newfs&amp;sektion=8&amp;format=html">newfs(8)</a> for more information.</p>
</div>
<div class="paragraph">
<p>The following command can be used to destroy the label:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># glabel destroy home</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The following example shows how to label the partitions of a boot disk.</p>
</div>
<div class="exampleblock">
<div class="title">例 32. Labeling Partitions on the Boot Disk</div>
<div class="content">
<div class="paragraph">
<p>By permanently labeling the partitions on the boot disk, the system should be able to continue to boot normally, even if the disk is moved to another controller or transferred to a different system. For this example, it is assumed that a single ATA disk is used, which is currently recognized by the system as <span class="filename">ad0</span>. It is also assumed that the standard FreeBSD partition scheme is used, with <span class="filename">/</span>, <span class="filename">/var</span>, <span class="filename">/usr</span> and <span class="filename">/tmp</span>, as well as a swap partition.</p>
</div>
<div class="paragraph">
<p>Reboot the system, and at the <a href="https://man.freebsd.org/cgi/man.cgi?query=loader&amp;sektion=8&amp;format=html">loader(8)</a> prompt, press <kbd>4</kbd> to boot into single user mode. Then enter the following commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># glabel label rootfs /dev/ad0s1a</span>
GEOM_LABEL: Label <span class="k">for </span>provider /dev/ad0s1a is label/rootfs
<span class="c"># glabel label var /dev/ad0s1d</span>
GEOM_LABEL: Label <span class="k">for </span>provider /dev/ad0s1d is label/var
<span class="c"># glabel label usr /dev/ad0s1f</span>
GEOM_LABEL: Label <span class="k">for </span>provider /dev/ad0s1f is label/usr
<span class="c"># glabel label tmp /dev/ad0s1e</span>
GEOM_LABEL: Label <span class="k">for </span>provider /dev/ad0s1e is label/tmp
<span class="c"># glabel label swap /dev/ad0s1b</span>
GEOM_LABEL: Label <span class="k">for </span>provider /dev/ad0s1b is label/swap
<span class="c"># exit</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The system will continue with multi-user boot. After the boot completes, edit <span class="filename">/etc/fstab</span> and replace the conventional device names, with their respective labels. The final <span class="filename">/etc/fstab</span> will look like this:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre># Device                Mountpoint      FStype  Options         Dump    Pass#
/dev/label/swap         none            swap    sw              0       0
/dev/label/rootfs       /               ufs     rw              1       1
/dev/label/tmp          /tmp            ufs     rw              2       2
/dev/label/usr          /usr            ufs     rw              2       2
/dev/label/var          /var            ufs     rw              2       2</pre>
</div>
</div>
<div class="paragraph">
<p>The system can now be rebooted. If everything went well, it will come up normally and <code>mount</code> will show:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># mount</span>
/dev/label/rootfs on / <span class="o">(</span>ufs, <span class="nb">local</span><span class="o">)</span>
devfs on /dev <span class="o">(</span>devfs, <span class="nb">local</span><span class="o">)</span>
/dev/label/tmp on /tmp <span class="o">(</span>ufs, <span class="nb">local</span>, soft-updates<span class="o">)</span>
/dev/label/usr on /usr <span class="o">(</span>ufs, <span class="nb">local</span>, soft-updates<span class="o">)</span>
/dev/label/var on /var <span class="o">(</span>ufs, <span class="nb">local</span>, soft-updates<span class="o">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The <a href="https://man.freebsd.org/cgi/man.cgi?query=glabel&amp;sektion=8&amp;format=html">glabel(8)</a> class supports a label type for UFS file systems, based on the unique file system id, <code>ufsid</code>. These labels may be found in <span class="filename">/dev/ufsid</span> and are created automatically during system startup. It is possible to use <code>ufsid</code> labels to mount partitions using <span class="filename">/etc/fstab</span>. Use <code>glabel status</code> to receive a list of file systems and their corresponding <code>ufsid</code> labels:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>glabel status
                  Name  Status  Components
ufsid/486b6fc38d330916     N/A  ad4s1d
ufsid/486b6fc16926168e     N/A  ad4s1f</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the above example, <span class="filename">ad4s1d</span> represents <span class="filename">/var</span>, while <span class="filename">ad4s1f</span> represents <span class="filename">/usr</span>. Using the <code>ufsid</code> values shown, these partitions may now be mounted with the following entries in <span class="filename">/etc/fstab</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>/dev/ufsid/486b6fc38d330916        /var        ufs        rw        2      2
/dev/ufsid/486b6fc16926168e        /usr        ufs        rw        2      2</pre>
</div>
</div>
<div class="paragraph">
<p>Any partitions with <code>ufsid</code> labels can be mounted in this way, eliminating the need to manually create permanent labels, while still enjoying the benefits of device name independent mounting.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="geom-gjournal">21.8. UFS Journaling Through GEOM<a class="anchor" href="#geom-gjournal"></a></h3>
<div class="paragraph">
<p>Support for journals on UFS file systems is available on FreeBSD. The implementation is provided through the GEOM subsystem and is configured using <code>gjournal</code>. Unlike other file system journaling implementations, the <code>gjournal</code> method is block based and not implemented as part of the file system. It is a GEOM extension.</p>
</div>
<div class="paragraph">
<p>Journaling stores a log of file system transactions, such as changes that make up a complete disk write operation, before meta-data and file writes are committed to the disk. This transaction log can later be replayed to redo file system transactions, preventing file system inconsistencies.</p>
</div>
<div class="paragraph">
<p>This method provides another mechanism to protect against data loss and inconsistencies of the file system. Unlike Soft Updates, which tracks and enforces meta-data updates, and snapshots, which create an image of the file system, a log is stored in disk space specifically for this task. For better performance, the journal may be stored on another disk. In this configuration, the journal provider or storage device should be listed after the device to enable journaling on.</p>
</div>
<div class="paragraph">
<p>The <span class="filename">GENERIC</span> kernel provides support for <code>gjournal</code>. To automatically load the <span class="filename">geom_journal.ko</span> kernel module at boot time, add the following line to <span class="filename">/boot/loader.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>geom_journal_load=&#34;YES&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>If a custom kernel is used, ensure the following line is in the kernel configuration file:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>options	GEOM_JOURNAL</pre>
</div>
</div>
<div class="paragraph">
<p>Once the module is loaded, a journal can be created on a new file system using the following steps. In this example, <span class="filename">da4</span> is a new SCSI disk:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># gjournal load</span>
<span class="c"># gjournal label /dev/da4</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This will load the module and create a <span class="filename">/dev/da4.journal</span> device node on <span class="filename">/dev/da4</span>.</p>
</div>
<div class="paragraph">
<p>A UFS file system may now be created on the journaled device, then mounted on an existing mount point:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># newfs -O 2 -J /dev/da4.journal</span>
<span class="c"># mount /dev/da4.journal /mnt</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In the case of several slices, a journal will be created for each individual slice. For instance, if <span class="filename">ad4s1</span> and <span class="filename">ad4s2</span> are both slices, then <code>gjournal</code> will create <span class="filename">ad4s1.journal</span> and <span class="filename">ad4s2.journal</span>.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Journaling may also be enabled on current file systems by using <code>tunefs</code>. However, <em>always</em> make a backup before attempting to alter an existing file system. In most cases, <code>gjournal</code> will fail if it is unable to create the journal, but this does not protect against data loss incurred as a result of misusing <code>tunefs</code>. Refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=gjournal&amp;sektion=8&amp;format=html">gjournal(8)</a> and <a href="https://man.freebsd.org/cgi/man.cgi?query=tunefs&amp;sektion=8&amp;format=html">tunefs(8)</a> for more information about these commands.</p>
</div>
<div class="paragraph">
<p>It is possible to journal the boot disk of a FreeBSD system. Refer to the article <a href="{gjournal-desktop}">Implementing UFS Journaling on a Desktop PC</a> for detailed instructions.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="zfs">Chapter 22. The Z File System (ZFS)<a class="anchor" href="#zfs"></a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>ZFS is an advanced file system designed to solve major problems found in previous storage subsystem software.</p>
</div>
<div class="paragraph">
<p>Originally developed at Sun™, ongoing open source ZFS development has moved to the <a href="http://open-zfs.org">OpenZFS Project</a>.</p>
</div>
<div class="paragraph">
<p>ZFS has three major design goals:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Data integrity: All data includes a <a href="#zfs-term-checksum">checksum</a> of the data. ZFS calculates checksums and writes them along with the data. When reading that data later, ZFS recalculates the checksums. If the checksums do not match, meaning detecting one or more data errors, ZFS will attempt to automatically correct errors when ditto-, mirror-, or parity-blocks are available.</p>
</li>
<li>
<p>Pooled storage: adding physical storage devices to a pool, and allocating storage space from that shared pool. Space is available to all file systems and volumes, and increases by adding new storage devices to the pool.</p>
</li>
<li>
<p>Performance: caching mechanisms provide increased performance. <a href="#zfs-term-arc">ARC</a> is an advanced memory-based read cache. ZFS provides a second level disk-based read cache with <a href="#zfs-term-l2arc">L2ARC</a>, and a disk-based synchronous write cache named <a href="#zfs-term-zil">ZIL</a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A complete list of features and terminology is in <a href="#zfs-term">ZFS Features and Terminology</a>.</p>
</div>
<div class="sect2">
<h3 id="zfs-differences">22.1. What Makes ZFS Different<a class="anchor" href="#zfs-differences"></a></h3>
<div class="paragraph">
<p>More than a file system, ZFS is fundamentally different from traditional file systems. Combining the traditionally separate roles of volume manager and file system provides ZFS with unique advantages. The file system is now aware of the underlying structure of the disks. Traditional file systems could exist on a single disk alone at a time. If there were two disks then creating two separate file systems was necessary. A traditional hardware RAID configuration avoided this problem by presenting the operating system with a single logical disk made up of the space provided by physical disks on top of which the operating system placed a file system. Even with software RAID solutions like those provided by GEOM, the UFS file system living on top of the RAID believes it’s dealing with a single device. ZFS&#39; combination of the volume manager and the file system solves this and allows the creation of file systems that all share a pool of available storage. One big advantage of ZFS&#39; awareness of the physical disk layout is that existing file systems grow automatically when adding extra disks to the pool. This new space then becomes available to the file systems. ZFS can also apply different properties to each file system. This makes it useful to create separate file systems and datasets instead of a single monolithic file system.</p>
</div>
</div>
<div class="sect2">
<h3 id="zfs-quickstart">22.2. Quick Start Guide<a class="anchor" href="#zfs-quickstart"></a></h3>
<div class="paragraph">
<p>FreeBSD can mount ZFS pools and datasets during system initialization. To enable it, add this line to <span class="filename">/etc/rc.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>zfs_enable=&#34;YES&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>Then start the service:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># service zfs start</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The examples in this section assume three SCSI disks with the device names <span class="filename">da0</span>, <span class="filename">da1</span>, and <span class="filename">da2</span>. Users of SATA hardware should instead use <span class="filename">ada</span> device names.</p>
</div>
<div class="sect3">
<h4 id="zfs-quickstart-single-disk-pool">22.2.1. Single Disk Pool<a class="anchor" href="#zfs-quickstart-single-disk-pool"></a></h4>
<div class="paragraph">
<p>To create a simple, non-redundant pool using a single disk device:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zpool create example /dev/da0</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To view the new pool, review the output of <code>df</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># df</span>
Filesystem  1K-blocks    Used    Avail Capacity  Mounted on
/dev/ad0s1a   2026030  235230  1628718    13%    /
devfs               1       1        0   100%    /dev
/dev/ad0s1d  54098308 1032846 48737598     2%    /usr
example      17547136       0 17547136     0%    /example</code></pre>
</div>
</div>
<div class="paragraph">
<p>This output shows creating and mounting of the <code>example</code> pool, and that is now accessible as a file system. Create files for users to browse:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># cd /example</span>
<span class="c"># ls</span>
<span class="c"># touch testfile</span>
<span class="c"># ls -al</span>
total 4
drwxr-xr-x   2 root  wheel    3 Aug 29 23:15 .
drwxr-xr-x  21 root  wheel  512 Aug 29 23:12 ..
-rw-r--r--   1 root  wheel    0 Aug 29 23:15 testfile</code></pre>
</div>
</div>
<div class="paragraph">
<p>This pool is not using any advanced ZFS features and properties yet. To create a dataset on this pool with compression enabled:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zfs create example/compressed</span>
<span class="c"># zfs set compression=gzip example/compressed</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>example/compressed</code> dataset is now a ZFS compressed file system. Try copying some large files to <span class="filename">/example/compressed</span>.</p>
</div>
<div class="paragraph">
<p>Disable compression with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zfs set compression=off example/compressed</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To unmount a file system, use <code>zfs umount</code> and then verify with <code>df</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zfs umount example/compressed</span>
<span class="c"># df</span>
Filesystem  1K-blocks    Used    Avail Capacity  Mounted on
/dev/ad0s1a   2026030  235232  1628716    13%    /
devfs               1       1        0   100%    /dev
/dev/ad0s1d  54098308 1032864 48737580     2%    /usr
example      17547008       0 17547008     0%    /example</code></pre>
</div>
</div>
<div class="paragraph">
<p>To re-mount the file system to make it accessible again, use <code>zfs mount</code> and verify with <code>df</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zfs mount example/compressed</span>
<span class="c"># df</span>
Filesystem         1K-blocks    Used    Avail Capacity  Mounted on
/dev/ad0s1a          2026030  235234  1628714    13%    /
devfs                      1       1        0   100%    /dev
/dev/ad0s1d         54098308 1032864 48737580     2%    /usr
example             17547008       0 17547008     0%    /example
example/compressed  17547008       0 17547008     0%    /example/compressed</code></pre>
</div>
</div>
<div class="paragraph">
<p>Running <code>mount</code> shows the pool and file systems:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># mount</span>
/dev/ad0s1a on / <span class="o">(</span>ufs, <span class="nb">local</span><span class="o">)</span>
devfs on /dev <span class="o">(</span>devfs, <span class="nb">local</span><span class="o">)</span>
/dev/ad0s1d on /usr <span class="o">(</span>ufs, <span class="nb">local</span>, soft-updates<span class="o">)</span>
example on /example <span class="o">(</span>zfs, <span class="nb">local</span><span class="o">)</span>
example/compressed on /example/compressed <span class="o">(</span>zfs, <span class="nb">local</span><span class="o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Use ZFS datasets like any file system after creation. Set other available features on a per-dataset basis when needed. The example below creates a new file system called <code>data</code>. It assumes the file system contains important files and configures it to store two copies of each data block.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zfs create example/data</span>
<span class="c"># zfs set copies=2 example/data</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Use <code>df</code> to see the data and space usage:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># df</span>
Filesystem         1K-blocks    Used    Avail Capacity  Mounted on
/dev/ad0s1a          2026030  235234  1628714    13%    /
devfs                      1       1        0   100%    /dev
/dev/ad0s1d         54098308 1032864 48737580     2%    /usr
example             17547008       0 17547008     0%    /example
example/compressed  17547008       0 17547008     0%    /example/compressed
example/data        17547008       0 17547008     0%    /example/data</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that all file systems in the pool have the same available space. Using <code>df</code> in these examples shows that the file systems use the space they need and all draw from the same pool. ZFS gets rid of concepts such as volumes and partitions, and allows several file systems to share the same pool.</p>
</div>
<div class="paragraph">
<p>To destroy the file systems and then the pool that is no longer needed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zfs destroy example/compressed</span>
<span class="c"># zfs destroy example/data</span>
<span class="c"># zpool destroy example</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="zfs-quickstart-raid-z">22.2.2. RAID-Z<a class="anchor" href="#zfs-quickstart-raid-z"></a></h4>
<div class="paragraph">
<p>Disks fail. One way to avoid data loss from disk failure is to use RAID. ZFS supports this feature in its pool design. RAID-Z pools require three or more disks but provide more usable space than mirrored pools.</p>
</div>
<div class="paragraph">
<p>This example creates a RAID-Z pool, specifying the disks to add to the pool:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zpool create storage raidz da0 da1 da2</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Sun™ recommends that the number of devices used in a RAID-Z configuration be between three and nine. For environments requiring a single pool consisting of 10 disks or more, consider breaking it up into smaller RAID-Z groups. If two disks are available, ZFS mirroring provides redundancy if required. Refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=zpool&amp;sektion=8&amp;format=html">zpool(8)</a> for more details.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>The previous example created the <code>storage</code> zpool. This example makes a new file system called <code>home</code> in that pool:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zfs create storage/home</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Enable compression and store an extra copy of directories and files:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zfs set copies=2 storage/home</span>
<span class="c"># zfs set compression=gzip storage/home</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To make this the new home directory for users, copy the user data to this directory and create the appropriate symbolic links:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># cp -rp /home/* /storage/home</span>
<span class="c"># rm -rf /home /usr/home</span>
<span class="c"># ln -s /storage/home /home</span>
<span class="c"># ln -s /storage/home /usr/home</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Users data is now stored on the freshly-created <span class="filename">/storage/home</span>. Test by adding a new user and logging in as that user.</p>
</div>
<div class="paragraph">
<p>Create a file system snapshot to roll back to later:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zfs snapshot storage/home@08-30-08</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>ZFS creates snapshots of a dataset, not a single directory or file.</p>
</div>
<div class="paragraph">
<p>The <code>@</code> character is a delimiter between the file system name or the volume name. Before deleting an important directory, back up the file system, then roll back to an earlier snapshot in which the directory still exists:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zfs rollback storage/home@08-30-08</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To list all available snapshots, run <code>ls</code> in the file system’s <span class="filename">.zfs/snapshot</span> directory. For example, to see the snapshot taken:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ls /storage/home/.zfs/snapshot</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Write a script to take regular snapshots of user data. Over time, snapshots can use up a lot of disk space. Remove the previous snapshot using the command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zfs destroy storage/home@08-30-08</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>After testing, make <span class="filename">/storage/home</span> the real <span class="filename">/home</span> with this command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zfs set mountpoint=/home storage/home</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Run <code>df</code> and <code>mount</code> to confirm that the system now treats the file system as the real <span class="filename">/home</span>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># mount</span>
/dev/ad0s1a on / <span class="o">(</span>ufs, <span class="nb">local</span><span class="o">)</span>
devfs on /dev <span class="o">(</span>devfs, <span class="nb">local</span><span class="o">)</span>
/dev/ad0s1d on /usr <span class="o">(</span>ufs, <span class="nb">local</span>, soft-updates<span class="o">)</span>
storage on /storage <span class="o">(</span>zfs, <span class="nb">local</span><span class="o">)</span>
storage/home on /home <span class="o">(</span>zfs, <span class="nb">local</span><span class="o">)</span>
<span class="c"># df</span>
Filesystem   1K-blocks    Used    Avail Capacity  Mounted on
/dev/ad0s1a    2026030  235240  1628708    13%    /
devfs                1       1        0   100%    /dev
/dev/ad0s1d   54098308 1032826 48737618     2%    /usr
storage       26320512       0 26320512     0%    /storage
storage/home  26320512       0 26320512     0%    /home</code></pre>
</div>
</div>
<div class="paragraph">
<p>This completes the RAID-Z configuration. Add daily status updates about the created file systems to the nightly <a href="https://man.freebsd.org/cgi/man.cgi?query=periodic&amp;sektion=8&amp;format=html">periodic(8)</a> runs by adding this line to <span class="filename">/etc/periodic.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>daily_status_zfs_enable=&#34;YES&#34;</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="zfs-quickstart-recovering-raid-z">22.2.3. Recovering RAID-Z<a class="anchor" href="#zfs-quickstart-recovering-raid-z"></a></h4>
<div class="paragraph">
<p>Every software RAID has a method of monitoring its <code>state</code>. View the status of RAID-Z devices using:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zpool status -x</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If all pools are <a href="#zfs-term-online">Online</a> and everything is normal, the message shows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">all pools are healthy</code></pre>
</div>
</div>
<div class="paragraph">
<p>If there is a problem, perhaps a disk being in the <a href="#zfs-term-offline">Offline</a> state, the pool state will look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">  pool: storage
 state: DEGRADED
status: One or more devices has been taken offline by the administrator.
	Sufficient replicas exist <span class="k">for </span>the pool to <span class="k">continue </span>functioning <span class="k">in </span>a
	degraded state.
action: Online the device using <span class="s1">&#39;zpool online&#39;</span> or replace the device with
	<span class="s1">&#39;zpool replace&#39;</span>.
 scrub: none requested
config:

	NAME        STATE     READ WRITE CKSUM
	storage     DEGRADED     0     0     0
	  raidz1    DEGRADED     0     0     0
	    da0     ONLINE       0     0     0
	    da1     OFFLINE      0     0     0
	    da2     ONLINE       0     0     0

errors: No known data errors</code></pre>
</div>
</div>
<div class="paragraph">
<p>&#34;OFFLINE&#34; shows the administrator took <span class="filename">da1</span> offline using:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zpool offline storage da1</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Power down the computer now and replace <span class="filename">da1</span>. Power up the computer and return <span class="filename">da1</span> to the pool:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zpool replace storage da1</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Next, check the status again, this time without <code>-x</code> to display all pools:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zpool status storage</span>
 pool: storage
 state: ONLINE
 scrub: resilver completed with 0 errors on Sat Aug 30 19:44:11 2008
config:

	NAME        STATE     READ WRITE CKSUM
	storage     ONLINE       0     0     0
	  raidz1    ONLINE       0     0     0
	    da0     ONLINE       0     0     0
	    da1     ONLINE       0     0     0
	    da2     ONLINE       0     0     0

errors: No known data errors</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example, everything is normal.</p>
</div>
</div>
<div class="sect3">
<h4 id="zfs-quickstart-data-verification">22.2.4. Data Verification<a class="anchor" href="#zfs-quickstart-data-verification"></a></h4>
<div class="paragraph">
<p>ZFS uses checksums to verify the integrity of stored data. Creating file systems automatically enables them.</p>
</div>
<div class="admonitionblock warning">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Disabling Checksums is possible but <em>not</em> recommended! Checksums take little storage space and provide data integrity. Most ZFS features will not work properly with checksums disabled. Disabling these checksums will not increase performance noticeably.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Verifying the data checksums (called <em>scrubbing</em>) ensures integrity of the <code>storage</code> pool with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zpool scrub storage</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The duration of a scrub depends on the amount of data stored. Larger amounts of data will take proportionally longer to verify. Since scrubbing is I/O intensive, ZFS allows a single scrub to run at a time. After scrubbing completes, view the status with <code>zpool status</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zpool status storage</span>
 pool: storage
 state: ONLINE
 scrub: scrub completed with 0 errors on Sat Jan 26 19:57:37 2013
config:

	NAME        STATE     READ WRITE CKSUM
	storage     ONLINE       0     0     0
	  raidz1    ONLINE       0     0     0
	    da0     ONLINE       0     0     0
	    da1     ONLINE       0     0     0
	    da2     ONLINE       0     0     0

errors: No known data errors</code></pre>
</div>
</div>
<div class="paragraph">
<p>Displaying the completion date of the last scrubbing helps decide when to start another. Routine scrubs help protect data from silent corruption and ensure the integrity of the pool.</p>
</div>
<div class="paragraph">
<p>Refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=zfs&amp;sektion=8&amp;format=html">zfs(8)</a> and <a href="https://man.freebsd.org/cgi/man.cgi?query=zpool&amp;sektion=8&amp;format=html">zpool(8)</a> for other ZFS options.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="zfs-zpool">22.3. <code>zpool</code> Administration<a class="anchor" href="#zfs-zpool"></a></h3>
<div class="paragraph">
<p>ZFS administration uses two main utilities. The <code>zpool</code> utility controls the operation of the pool and allows adding, removing, replacing, and managing disks. The <a href="#zfs-zfs"><code>zfs</code></a> utility allows creating, destroying, and managing datasets, both <a href="#zfs-term-filesystem">file systems</a> and <a href="#zfs-term-volume">volumes</a>.</p>
</div>
<div class="sect3">
<h4 id="zfs-zpool-create">22.3.1. Creating and Destroying Storage Pools<a class="anchor" href="#zfs-zpool-create"></a></h4>
<div class="paragraph">
<p>Creating a ZFS storage pool requires permanent decisions, as the pool structure cannot change after creation. The most important decision is which types of vdevs to group the physical disks into. See the list of <a href="#zfs-term-vdev">vdev types</a> for details about the possible options. After creating the pool, most vdev types do not allow adding disks to the vdev. The exceptions are mirrors, which allow adding new disks to the vdev, and stripes, which upgrade to mirrors by attaching a new disk to the vdev. Although adding new vdevs expands a pool, the pool layout cannot change after pool creation. Instead, back up the data, destroy the pool, and recreate it.</p>
</div>
<div class="paragraph">
<p>Create a simple mirror pool:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zpool create mypool mirror /dev/ada1 /dev/ada2</span>
<span class="c"># zpool status</span>
  pool: mypool
 state: ONLINE
  scan: none requested
config:

        NAME        STATE     READ WRITE CKSUM
        mypool      ONLINE       0     0     0
          mirror-0  ONLINE       0     0     0
            ada1    ONLINE       0     0     0
            ada2    ONLINE       0     0     0

errors: No known data errors</code></pre>
</div>
</div>
<div class="paragraph">
<p>To create more than one vdev with a single command, specify groups of disks separated by the vdev type keyword, <code>mirror</code> in this example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zpool create mypool mirror /dev/ada1 /dev/ada2 mirror /dev/ada3 /dev/ada4</span>
<span class="c"># zpool status</span>
  pool: mypool
 state: ONLINE
  scan: none requested
config:

        NAME        STATE     READ WRITE CKSUM
        mypool      ONLINE       0     0     0
          mirror-0  ONLINE       0     0     0
            ada1    ONLINE       0     0     0
            ada2    ONLINE       0     0     0
          mirror-1  ONLINE       0     0     0
            ada3    ONLINE       0     0     0
            ada4    ONLINE       0     0     0

errors: No known data errors</code></pre>
</div>
</div>
<div class="paragraph">
<p>Pools can also use partitions rather than whole disks. Putting ZFS in a separate partition allows the same disk to have other partitions for other purposes. In particular, it allows adding partitions with bootcode and file systems needed for booting. This allows booting from disks that are also members of a pool. ZFS adds no performance penalty on FreeBSD when using a partition rather than a whole disk. Using partitions also allows the administrator to <em>under-provision</em> the disks, using less than the full capacity. If a future replacement disk of the same nominal size as the original actually has a slightly smaller capacity, the smaller partition will still fit, using the replacement disk.</p>
</div>
<div class="paragraph">
<p>Create a <a href="#zfs-term-vdev-raidz">RAID-Z2</a> pool using partitions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zpool create mypool raidz2 /dev/ada0p3 /dev/ada1p3 /dev/ada2p3 /dev/ada3p3 /dev/ada4p3 /dev/ada5p3</span>
<span class="c"># zpool status</span>
  pool: mypool
 state: ONLINE
  scan: none requested
config:

        NAME        STATE     READ WRITE CKSUM
        mypool      ONLINE       0     0     0
          raidz2-0  ONLINE       0     0     0
            ada0p3  ONLINE       0     0     0
            ada1p3  ONLINE       0     0     0
            ada2p3  ONLINE       0     0     0
            ada3p3  ONLINE       0     0     0
            ada4p3  ONLINE       0     0     0
            ada5p3  ONLINE       0     0     0

errors: No known data errors</code></pre>
</div>
</div>
<div class="paragraph">
<p>Destroy a pool that is no longer needed to reuse the disks. Destroying a pool requires unmounting the file systems in that pool first. If any dataset is in use, the unmount operation fails without destroying the pool. Force the pool destruction with <code>-f</code>. This can cause undefined behavior in applications which had open files on those datasets.</p>
</div>
</div>
<div class="sect3">
<h4 id="zfs-zpool-attach">22.3.2. Adding and Removing Devices<a class="anchor" href="#zfs-zpool-attach"></a></h4>
<div class="paragraph">
<p>Two ways exist for adding disks to a pool: attaching a disk to an existing vdev with <code>zpool attach</code>, or adding vdevs to the pool with <code>zpool add</code>. Some <a href="#zfs-term-vdev">vdev types</a> allow adding disks to the vdev after creation.</p>
</div>
<div class="paragraph">
<p>A pool created with a single disk lacks redundancy. It can detect corruption but can not repair it, because there is no other copy of the data. The <a href="#zfs-term-copies">copies</a> property may be able to recover from a small failure such as a bad sector, but does not provide the same level of protection as mirroring or RAID-Z. Starting with a pool consisting of a single disk vdev, use <code>zpool attach</code> to add a new disk to the vdev, creating a mirror. Also use <code>zpool attach</code> to add new disks to a mirror group, increasing redundancy and read performance. When partitioning the disks used for the pool, replicate the layout of the first disk on to the second. Use <code>gpart backup</code> and <code>gpart restore</code> to make this process easier.</p>
</div>
<div class="paragraph">
<p>Upgrade the single disk (stripe) vdev <span class="filename">ada0p3</span> to a mirror by attaching <span class="filename">ada1p3</span>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zpool status</span>
  pool: mypool
 state: ONLINE
  scan: none requested
config:

        NAME        STATE     READ WRITE CKSUM
        mypool      ONLINE       0     0     0
          ada0p3    ONLINE       0     0     0

errors: No known data errors
<span class="c"># zpool attach mypool ada0p3 ada1p3</span>
Make sure to <span class="nb">wait </span><span class="k">until </span>resilvering finishes before rebooting.

If you boot from pool <span class="s1">&#39;mypool&#39;</span>, you may need to update boot code on newly attached disk _ada1p3_.

Assuming you use GPT partitioning and _da0_ is your new boot disk you may use the following <span class="nb">command</span>:

        gpart bootcode -b /boot/pmbr -p /boot/gptzfsboot -i 1 da0
<span class="c"># gpart bootcode -b /boot/pmbr -p /boot/gptzfsboot -i 1 ada1</span>
bootcode written to ada1
<span class="c"># zpool status</span>
  pool: mypool
 state: ONLINE
status: One or more devices is currently being resilvered.  The pool will
        <span class="k">continue </span>to <span class="k">function</span>, possibly <span class="k">in </span>a degraded state.
action: Wait <span class="k">for </span>the resilver to complete.
  scan: resilver <span class="k">in </span>progress since Fri May 30 08:19:19 2014
        527M scanned out of 781M at 47.9M/s, 0h0m to go
        527M resilvered, 67.53% <span class="k">done
</span>config:

        NAME        STATE     READ WRITE CKSUM
        mypool      ONLINE       0     0     0
          mirror-0  ONLINE       0     0     0
            ada0p3  ONLINE       0     0     0
            ada1p3  ONLINE       0     0     0  <span class="o">(</span>resilvering<span class="o">)</span>

errors: No known data errors
<span class="c"># zpool status</span>
  pool: mypool
 state: ONLINE
  scan: resilvered 781M <span class="k">in </span>0h0m with 0 errors on Fri May 30 08:15:58 2014
config:

        NAME        STATE     READ WRITE CKSUM
        mypool      ONLINE       0     0     0
          mirror-0  ONLINE       0     0     0
            ada0p3  ONLINE       0     0     0
            ada1p3  ONLINE       0     0     0

errors: No known data errors</code></pre>
</div>
</div>
<div class="paragraph">
<p>When adding disks to the existing vdev is not an option, as for RAID-Z, an alternative method is to add another vdev to the pool. Adding vdevs provides higher performance by distributing writes across the vdevs. Each vdev provides its own redundancy. Mixing vdev types like <code>mirror</code> and <code>RAID-Z</code> is possible but discouraged. Adding a non-redundant vdev to a pool containing mirror or RAID-Z vdevs risks the data on the entire pool. Distributing writes means a failure of the non-redundant disk will result in the loss of a fraction of every block written to the pool.</p>
</div>
<div class="paragraph">
<p>ZFS stripes data across each of the vdevs. For example, with two mirror vdevs, this is effectively a RAID 10 that stripes writes across two sets of mirrors. ZFS allocates space so that each vdev reaches 100% full at the same time. Having vdevs with different amounts of free space will lower performance, as more data writes go to the less full vdev.</p>
</div>
<div class="paragraph">
<p>When attaching new devices to a boot pool, remember to update the bootcode.</p>
</div>
<div class="paragraph">
<p>Attach a second mirror group (<span class="filename">ada2p3</span> and <span class="filename">ada3p3</span>) to the existing mirror:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zpool status</span>
  pool: mypool
 state: ONLINE
  scan: resilvered 781M <span class="k">in </span>0h0m with 0 errors on Fri May 30 08:19:35 2014
config:

        NAME        STATE     READ WRITE CKSUM
        mypool      ONLINE       0     0     0
          mirror-0  ONLINE       0     0     0
            ada0p3  ONLINE       0     0     0
            ada1p3  ONLINE       0     0     0

errors: No known data errors
<span class="c"># zpool add mypool mirror ada2p3 ada3p3</span>
<span class="c"># gpart bootcode -b /boot/pmbr -p /boot/gptzfsboot -i 1 ada2</span>
bootcode written to ada2
<span class="c"># gpart bootcode -b /boot/pmbr -p /boot/gptzfsboot -i 1 ada3</span>
bootcode written to ada3
<span class="c"># zpool status</span>
  pool: mypool
 state: ONLINE
  scan: scrub repaired 0 <span class="k">in </span>0h0m with 0 errors on Fri May 30 08:29:51 2014
config:

        NAME        STATE     READ WRITE CKSUM
        mypool      ONLINE       0     0     0
          mirror-0  ONLINE       0     0     0
            ada0p3  ONLINE       0     0     0
            ada1p3  ONLINE       0     0     0
          mirror-1  ONLINE       0     0     0
            ada2p3  ONLINE       0     0     0
            ada3p3  ONLINE       0     0     0

errors: No known data errors</code></pre>
</div>
</div>
<div class="paragraph">
<p>Removing vdevs from a pool is impossible and removal of disks from a mirror is exclusive if there is enough remaining redundancy. If a single disk remains in a mirror group, that group ceases to be a mirror and becomes a stripe, risking the entire pool if that remaining disk fails.</p>
</div>
<div class="paragraph">
<p>Remove a disk from a three-way mirror group:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zpool status</span>
  pool: mypool
 state: ONLINE
  scan: scrub repaired 0 <span class="k">in </span>0h0m with 0 errors on Fri May 30 08:29:51 2014
config:

        NAME        STATE     READ WRITE CKSUM
        mypool      ONLINE       0     0     0
          mirror-0  ONLINE       0     0     0
            ada0p3  ONLINE       0     0     0
            ada1p3  ONLINE       0     0     0
            ada2p3  ONLINE       0     0     0

errors: No known data errors
<span class="c"># zpool detach mypool ada2p3</span>
<span class="c"># zpool status</span>
  pool: mypool
 state: ONLINE
  scan: scrub repaired 0 <span class="k">in </span>0h0m with 0 errors on Fri May 30 08:29:51 2014
config:

        NAME        STATE     READ WRITE CKSUM
        mypool      ONLINE       0     0     0
          mirror-0  ONLINE       0     0     0
            ada0p3  ONLINE       0     0     0
            ada1p3  ONLINE       0     0     0

errors: No known data errors</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="zfs-zpool-status">22.3.3. Checking the Status of a Pool<a class="anchor" href="#zfs-zpool-status"></a></h4>
<div class="paragraph">
<p>Pool status is important. If a drive goes offline or ZFS detects a read, write, or checksum error, the corresponding error count increases. The <code>status</code> output shows the configuration and status of each device in the pool and the status of the entire pool. Actions to take and details about the last <a href="#zfs-zpool-scrub"><code>scrub</code></a> are also shown.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zpool status</span>
  pool: mypool
 state: ONLINE
  scan: scrub repaired 0 <span class="k">in </span>2h25m with 0 errors on Sat Sep 14 04:25:50 2013
config:

        NAME        STATE     READ WRITE CKSUM
        mypool      ONLINE       0     0     0
          raidz2-0  ONLINE       0     0     0
            ada0p3  ONLINE       0     0     0
            ada1p3  ONLINE       0     0     0
            ada2p3  ONLINE       0     0     0
            ada3p3  ONLINE       0     0     0
            ada4p3  ONLINE       0     0     0
            ada5p3  ONLINE       0     0     0

errors: No known data errors</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="zfs-zpool-clear">22.3.4. Clearing Errors<a class="anchor" href="#zfs-zpool-clear"></a></h4>
<div class="paragraph">
<p>When detecting an error, ZFS increases the read, write, or checksum error counts. Clear the error message and reset the counts with <code>zpool clear <em>mypool</em></code>. Clearing the error state can be important for automated scripts that alert the administrator when the pool encounters an error. Without clearing old errors, the scripts may fail to report further errors.</p>
</div>
</div>
<div class="sect3">
<h4 id="zfs-zpool-replace">22.3.5. Replacing a Functioning Device<a class="anchor" href="#zfs-zpool-replace"></a></h4>
<div class="paragraph">
<p>It may be desirable to replace one disk with a different disk. When replacing a working disk, the process keeps the old disk online during the replacement. The pool never enters a <a href="#zfs-term-degraded">degraded</a> state, reducing the risk of data loss. Running <code>zpool replace</code> copies the data from the old disk to the new one. After the operation completes, ZFS disconnects the old disk from the vdev. If the new disk is larger than the old disk, it may be possible to grow the zpool, using the new space. See <a href="#zfs-zpool-online">Growing a Pool</a>.</p>
</div>
<div class="paragraph">
<p>Replace a functioning device in the pool:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zpool status</span>
  pool: mypool
 state: ONLINE
  scan: none requested
config:

        NAME        STATE     READ WRITE CKSUM
        mypool      ONLINE       0     0     0
          mirror-0  ONLINE       0     0     0
            ada0p3  ONLINE       0     0     0
            ada1p3  ONLINE       0     0     0

errors: No known data errors
<span class="c"># zpool replace mypool ada1p3 ada2p3</span>
Make sure to <span class="nb">wait </span><span class="k">until </span>resilvering finishes before rebooting.

When booting from the pool <span class="s1">&#39;zroot&#39;</span>, update the boot code on the newly attached disk <span class="s1">&#39;ada2p3&#39;</span>.

Assuming GPT partitioning is used and <span class="o">[</span>.filename]#da0# is the new boot disk, use the following <span class="nb">command</span>:

        gpart bootcode -b /boot/pmbr -p /boot/gptzfsboot -i 1 da0
<span class="c"># gpart bootcode -b /boot/pmbr -p /boot/gptzfsboot -i 1 ada2</span>
<span class="c"># zpool status</span>
  pool: mypool
 state: ONLINE
status: One or more devices is currently being resilvered.  The pool will
        <span class="k">continue </span>to <span class="k">function</span>, possibly <span class="k">in </span>a degraded state.
action: Wait <span class="k">for </span>the resilver to complete.
  scan: resilver <span class="k">in </span>progress since Mon Jun  2 14:21:35 2014
        604M scanned out of 781M at 46.5M/s, 0h0m to go
        604M resilvered, 77.39% <span class="k">done
</span>config:

        NAME             STATE     READ WRITE CKSUM
        mypool           ONLINE       0     0     0
          mirror-0       ONLINE       0     0     0
            ada0p3       ONLINE       0     0     0
            replacing-1  ONLINE       0     0     0
              ada1p3     ONLINE       0     0     0
              ada2p3     ONLINE       0     0     0  <span class="o">(</span>resilvering<span class="o">)</span>

errors: No known data errors
<span class="c"># zpool status</span>
  pool: mypool
 state: ONLINE
  scan: resilvered 781M <span class="k">in </span>0h0m with 0 errors on Mon Jun  2 14:21:52 2014
config:

        NAME        STATE     READ WRITE CKSUM
        mypool      ONLINE       0     0     0
          mirror-0  ONLINE       0     0     0
            ada0p3  ONLINE       0     0     0
            ada2p3  ONLINE       0     0     0

errors: No known data errors</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="zfs-zpool-resilver">22.3.6. Dealing with Failed Devices<a class="anchor" href="#zfs-zpool-resilver"></a></h4>
<div class="paragraph">
<p>When a disk in a pool fails, the vdev to which the disk belongs enters the <a href="#zfs-term-degraded">degraded</a> state. The data is still available, but with reduced performance because ZFS computes missing data from the available redundancy. To restore the vdev to a fully functional state, replace the failed physical device. ZFS is then instructed to begin the <a href="#zfs-term-resilver">resilver</a> operation. ZFS recomputes data on the failed device from available redundancy and writes it to the replacement device. After completion, the vdev returns to <a href="#zfs-term-online">online</a> status.</p>
</div>
<div class="paragraph">
<p>If the vdev does not have any redundancy, or if devices have failed and there is not enough redundancy to compensate, the pool enters the <a href="#zfs-term-faulted">faulted</a> state. Unless enough devices can reconnect the pool becomes inoperative requiring a data restore from backups.</p>
</div>
<div class="paragraph">
<p>When replacing a failed disk, the name of the failed disk changes to the GUID of the new disk. A new device name parameter for <code>zpool replace</code> is not required if the replacement device has the same device name.</p>
</div>
<div class="paragraph">
<p>Replace a failed disk using <code>zpool replace</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zpool status</span>
  pool: mypool
 state: DEGRADED
status: One or more devices could not be opened.  Sufficient replicas exist <span class="k">for
        </span>the pool to <span class="k">continue </span>functioning <span class="k">in </span>a degraded state.
action: Attach the missing device and online it using <span class="s1">&#39;zpool online&#39;</span>.
   see: http://illumos.org/msg/ZFS-8000-2Q
  scan: none requested
config:

        NAME                    STATE     READ WRITE CKSUM
        mypool                  DEGRADED     0     0     0
          mirror-0              DEGRADED     0     0     0
            ada0p3              ONLINE       0     0     0
            316502962686821739  UNAVAIL      0     0     0  was /dev/ada1p3

errors: No known data errors
<span class="c"># zpool replace mypool 316502962686821739 ada2p3</span>
<span class="c"># zpool status</span>
  pool: mypool
 state: DEGRADED
status: One or more devices is currently being resilvered.  The pool will
        <span class="k">continue </span>to <span class="k">function</span>, possibly <span class="k">in </span>a degraded state.
action: Wait <span class="k">for </span>the resilver to complete.
  scan: resilver <span class="k">in </span>progress since Mon Jun  2 14:52:21 2014
        641M scanned out of 781M at 49.3M/s, 0h0m to go
        640M resilvered, 82.04% <span class="k">done
</span>config:

        NAME                        STATE     READ WRITE CKSUM
        mypool                      DEGRADED     0     0     0
          mirror-0                  DEGRADED     0     0     0
            ada0p3                  ONLINE       0     0     0
            replacing-1             UNAVAIL      0     0     0
              15732067398082357289  UNAVAIL      0     0     0  was /dev/ada1p3/old
              ada2p3                ONLINE       0     0     0  <span class="o">(</span>resilvering<span class="o">)</span>

errors: No known data errors
<span class="c"># zpool status</span>
  pool: mypool
 state: ONLINE
  scan: resilvered 781M <span class="k">in </span>0h0m with 0 errors on Mon Jun  2 14:52:38 2014
config:

        NAME        STATE     READ WRITE CKSUM
        mypool      ONLINE       0     0     0
          mirror-0  ONLINE       0     0     0
            ada0p3  ONLINE       0     0     0
            ada2p3  ONLINE       0     0     0

errors: No known data errors</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="zfs-zpool-scrub">22.3.7. Scrubbing a Pool<a class="anchor" href="#zfs-zpool-scrub"></a></h4>
<div class="paragraph">
<p>Routinely <a href="#zfs-term-scrub">scrub</a> pools, ideally at least once every month. The <code>scrub</code> operation is disk-intensive and will reduce performance while running. Avoid high-demand periods when scheduling <code>scrub</code> or use <a href="#zfs-advanced-tuning-scrub_delay"><code>vfs.zfs.scrub_delay</code></a> to adjust the relative priority of the <code>scrub</code> to keep it from slowing down other workloads.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zpool scrub mypool</span>
<span class="c"># zpool status</span>
  pool: mypool
 state: ONLINE
  scan: scrub <span class="k">in </span>progress since Wed Feb 19 20:52:54 2014
        116G scanned out of 8.60T at 649M/s, 3h48m to go
        0 repaired, 1.32% <span class="k">done
</span>config:

        NAME        STATE     READ WRITE CKSUM
        mypool      ONLINE       0     0     0
          raidz2-0  ONLINE       0     0     0
            ada0p3  ONLINE       0     0     0
            ada1p3  ONLINE       0     0     0
            ada2p3  ONLINE       0     0     0
            ada3p3  ONLINE       0     0     0
            ada4p3  ONLINE       0     0     0
            ada5p3  ONLINE       0     0     0

errors: No known data errors</code></pre>
</div>
</div>
<div class="paragraph">
<p>To cancel a scrub operation if needed, run <code>zpool scrub -s <em>mypool</em></code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="zfs-zpool-selfheal">22.3.8. Self-Healing<a class="anchor" href="#zfs-zpool-selfheal"></a></h4>
<div class="paragraph">
<p>The checksums stored with data blocks enable the file system to <em>self-heal</em>. This feature will automatically repair data whose checksum does not match the one recorded on another device that is part of the storage pool. For example, a mirror configuration with two disks where one drive is starting to malfunction and cannot properly store the data any more. This is worse when the data was not accessed for a long time, as with long term archive storage. Traditional file systems need to run commands that check and repair the data like <a href="https://man.freebsd.org/cgi/man.cgi?query=fsck&amp;sektion=8&amp;format=html">fsck(8)</a>. These commands take time, and in severe cases, an administrator has to decide which repair operation to perform. When ZFS detects a data block with a mismatched checksum, it tries to read the data from the mirror disk. If that disk can provide the correct data, ZFS will give that to the application and correct the data on the disk with the wrong checksum. This happens without any interaction from a system administrator during normal pool operation.</p>
</div>
<div class="paragraph">
<p>The next example shows this self-healing behavior by creating a mirrored pool of disks <span class="filename">/dev/ada0</span> and <span class="filename">/dev/ada1</span>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zpool create healer mirror /dev/ada0 /dev/ada1</span>
<span class="c"># zpool status healer</span>
  pool: healer
 state: ONLINE
  scan: none requested
config:

    NAME        STATE     READ WRITE CKSUM
    healer      ONLINE       0     0     0
      mirror-0  ONLINE       0     0     0
       ada0     ONLINE       0     0     0
       ada1     ONLINE       0     0     0

errors: No known data errors
<span class="c"># zpool list</span>
NAME     SIZE  ALLOC   FREE   CKPOINT  EXPANDSZ   FRAG   CAP  DEDUP  HEALTH  ALTROOT
healer   960M  92.5K   960M         -         -     0%    0%  1.00x  ONLINE  -</code></pre>
</div>
</div>
<div class="paragraph">
<p>Copy some important data to the pool to protect from data errors using the self-healing feature and create a checksum of the pool for later comparison.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># cp /some/important/data /healer</span>
<span class="c"># zfs list</span>
NAME     SIZE  ALLOC   FREE    CAP  DEDUP  HEALTH  ALTROOT
healer   960M  67.7M   892M     7%  1.00x  ONLINE  -
<span class="c"># sha1 /healer &gt; checksum.txt</span>
<span class="c"># cat checksum.txt</span>
SHA1 <span class="o">(</span>/healer<span class="o">)</span> <span class="o">=</span> 2753eff56d77d9a536ece6694bf0a82740344d1f</code></pre>
</div>
</div>
<div class="paragraph">
<p>Simulate data corruption by writing random data to the beginning of one of the disks in the mirror. To keep ZFS from healing the data when detected, export the pool before the corruption and import it again afterwards.</p>
</div>
<div class="admonitionblock warning">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This is a dangerous operation that can destroy vital data, shown here for demonstration alone. <strong>Do not try</strong> it during normal operation of a storage pool. Nor should this intentional corruption example run on any disk with a file system not using ZFS on another partition in it. Do not use any other disk device names other than the ones that are part of the pool. Ensure proper backups of the pool exist and test them before running the command!</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zpool export healer</span>
<span class="c"># dd if=/dev/random of=/dev/ada1 bs=1m count=200</span>
200+0 records <span class="k">in
</span>200+0 records out
209715200 bytes transferred <span class="k">in </span>62.992162 secs <span class="o">(</span>3329227 bytes/sec<span class="o">)</span>
<span class="c"># zpool import healer</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The pool status shows that one device has experienced an error. Note that applications reading data from the pool did not receive any incorrect data. ZFS provided data from the <span class="filename">ada0</span> device with the correct checksums. To find the device with the wrong checksum, look for one whose <code>CKSUM</code> column contains a nonzero value.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zpool status healer</span>
    pool: healer
   state: ONLINE
  status: One or more devices has experienced an unrecoverable error.  An
          attempt was made to correct the error.  Applications are unaffected.
  action: Determine <span class="k">if </span>the device needs to be replaced, and clear the errors
          using <span class="s1">&#39;zpool clear&#39;</span> or replace the device with <span class="s1">&#39;zpool replace&#39;</span>.
     see: http://illumos.org/msg/ZFS-8000-4J
    scan: none requested
  config:

      NAME        STATE     READ WRITE CKSUM
      healer      ONLINE       0     0     0
        mirror-0  ONLINE       0     0     0
         ada0     ONLINE       0     0     0
         ada1     ONLINE       0     0     1

errors: No known data errors</code></pre>
</div>
</div>
<div class="paragraph">
<p>ZFS detected the error and handled it by using the redundancy present in the unaffected <span class="filename">ada0</span> mirror disk. A checksum comparison with the original one will reveal whether the pool is consistent again.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sha1 /healer &gt;&gt; checksum.txt</span>
<span class="c"># cat checksum.txt</span>
SHA1 <span class="o">(</span>/healer<span class="o">)</span> <span class="o">=</span> 2753eff56d77d9a536ece6694bf0a82740344d1f
SHA1 <span class="o">(</span>/healer<span class="o">)</span> <span class="o">=</span> 2753eff56d77d9a536ece6694bf0a82740344d1f</code></pre>
</div>
</div>
<div class="paragraph">
<p>Generate checksums before and after the intentional tampering while the pool data still matches. This shows how ZFS is capable of detecting and correcting any errors automatically when the checksums differ. Note this is possible with enough redundancy present in the pool. A pool consisting of a single device has no self-healing capabilities. That is also the reason why checksums are so important in ZFS; do not disable them for any reason. ZFS requires no <a href="https://man.freebsd.org/cgi/man.cgi?query=fsck&amp;sektion=8&amp;format=html">fsck(8)</a> or similar file system consistency check program to detect and correct this, and keeps the pool available while there is a problem. A scrub operation is now required to overwrite the corrupted data on <span class="filename">ada1</span>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zpool scrub healer</span>
<span class="c"># zpool status healer</span>
  pool: healer
 state: ONLINE
status: One or more devices has experienced an unrecoverable error.  An
            attempt was made to correct the error.  Applications are unaffected.
action: Determine <span class="k">if </span>the device needs to be replaced, and clear the errors
            using <span class="s1">&#39;zpool clear&#39;</span> or replace the device with <span class="s1">&#39;zpool replace&#39;</span>.
   see: http://illumos.org/msg/ZFS-8000-4J
  scan: scrub <span class="k">in </span>progress since Mon Dec 10 12:23:30 2012
        10.4M scanned out of 67.0M at 267K/s, 0h3m to go
        9.63M repaired, 15.56% <span class="k">done
</span>config:

    NAME        STATE     READ WRITE CKSUM
    healer      ONLINE       0     0     0
      mirror-0  ONLINE       0     0     0
       ada0     ONLINE       0     0     0
       ada1     ONLINE       0     0   627  <span class="o">(</span>repairing<span class="o">)</span>

errors: No known data errors</code></pre>
</div>
</div>
<div class="paragraph">
<p>The scrub operation reads data from <span class="filename">ada0</span> and rewrites any data with a wrong checksum on <span class="filename">ada1</span>, shown by the <code>(repairing)</code> output from <code>zpool status</code>. After the operation is complete, the pool status changes to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zpool status healer</span>
  pool: healer
 state: ONLINE
status: One or more devices has experienced an unrecoverable error.  An
        attempt was made to correct the error.  Applications are unaffected.
action: Determine <span class="k">if </span>the device needs to be replaced, and clear the errors
             using <span class="s1">&#39;zpool clear&#39;</span> or replace the device with <span class="s1">&#39;zpool replace&#39;</span>.
   see: http://illumos.org/msg/ZFS-8000-4J
  scan: scrub repaired 66.5M <span class="k">in </span>0h2m with 0 errors on Mon Dec 10 12:26:25 2012
config:

    NAME        STATE     READ WRITE CKSUM
    healer      ONLINE       0     0     0
      mirror-0  ONLINE       0     0     0
       ada0     ONLINE       0     0     0
       ada1     ONLINE       0     0 2.72K

errors: No known data errors</code></pre>
</div>
</div>
<div class="paragraph">
<p>After the scrubbing operation completes with all the data synchronized from <span class="filename">ada0</span> to <span class="filename">ada1</span>, <a href="#zfs-zpool-clear">clear</a> the error messages from the pool status by running <code>zpool clear</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zpool clear healer</span>
<span class="c"># zpool status healer</span>
  pool: healer
 state: ONLINE
  scan: scrub repaired 66.5M <span class="k">in </span>0h2m with 0 errors on Mon Dec 10 12:26:25 2012
config:

    NAME        STATE     READ WRITE CKSUM
    healer      ONLINE       0     0     0
      mirror-0  ONLINE       0     0     0
       ada0     ONLINE       0     0     0
       ada1     ONLINE       0     0     0

errors: No known data errors</code></pre>
</div>
</div>
<div class="paragraph">
<p>The pool is now back to a fully working state, with all error counts now zero.</p>
</div>
</div>
<div class="sect3">
<h4 id="zfs-zpool-online">22.3.9. Growing a Pool<a class="anchor" href="#zfs-zpool-online"></a></h4>
<div class="paragraph">
<p>The smallest device in each vdev limits the usable size of a redundant pool. Replace the smallest device with a larger device. After completing a <a href="#zfs-zpool-replace">replace</a> or <a href="#zfs-term-resilver">resilver</a> operation, the pool can grow to use the capacity of the new device. For example, consider a mirror of a 1 TB drive and a 2 TB drive. The usable space is 1 TB. When replacing the 1 TB drive with another 2 TB drive, the resilvering process copies the existing data onto the new drive. As both of the devices now have 2 TB capacity, the mirror’s available space grows to 2 TB.</p>
</div>
<div class="paragraph">
<p>Start expansion by using <code>zpool online -e</code> on each device. After expanding all devices, the extra space becomes available to the pool.</p>
</div>
</div>
<div class="sect3">
<h4 id="zfs-zpool-import">22.3.10. Importing and Exporting Pools<a class="anchor" href="#zfs-zpool-import"></a></h4>
<div class="paragraph">
<p><em>Export</em> pools before moving them to another system. ZFS unmounts all datasets, marking each device as exported but still locked to prevent use by other disks. This allows pools to be <em>imported</em> on other machines, other operating systems that support ZFS, and even different hardware architectures (with some caveats, see <a href="https://man.freebsd.org/cgi/man.cgi?query=zpool&amp;sektion=8&amp;format=html">zpool(8)</a>). When a dataset has open files, use <code>zpool export -f</code> to force exporting the pool. Use this with caution. The datasets are forcibly unmounted, potentially resulting in unexpected behavior by the applications which had open files on those datasets.</p>
</div>
<div class="paragraph">
<p>Export a pool that is not in use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zpool export mypool</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Importing a pool automatically mounts the datasets. If this is undesired behavior, use <code>zpool import -N</code> to prevent it. <code>zpool import -o</code> sets temporary properties for this specific import. <code>zpool import altroot=</code> allows importing a pool with a base mount point instead of the root of the file system. If the pool was last used on a different system and was not properly exported, force the import using <code>zpool import -f</code>. <code>zpool import -a</code> imports all pools that do not appear to be in use by another system.</p>
</div>
<div class="paragraph">
<p>List all available pools for import:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zpool import</span>
   pool: mypool
     id: 9930174748043525076
  state: ONLINE
 action: The pool can be imported using its name or numeric identifier.
 config:

        mypool      ONLINE
          ada2p3    ONLINE</code></pre>
</div>
</div>
<div class="paragraph">
<p>Import the pool with an alternative root directory:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zpool import -o altroot=/mnt mypool</span>
<span class="c"># zfs list</span>
zfs list
NAME                 USED  AVAIL  REFER  MOUNTPOINT
mypool               110K  47.0G    31K  /mnt/mypool</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="zfs-zpool-upgrade">22.3.11. Upgrading a Storage Pool<a class="anchor" href="#zfs-zpool-upgrade"></a></h4>
<div class="paragraph">
<p>After upgrading FreeBSD, or if importing a pool from a system using an older version, manually upgrade the pool to the latest ZFS version to support newer features. Consider whether the pool may ever need importing on an older system before upgrading. Upgrading is a one-way process. Upgrade older pools is possible, but downgrading pools with newer features is not.</p>
</div>
<div class="paragraph">
<p>Upgrade a v28 pool to support <code>Feature Flags</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zpool status</span>
  pool: mypool
 state: ONLINE
status: The pool is formatted using a legacy on-disk format.  The pool can
        still be used, but some features are unavailable.
action: Upgrade the pool using <span class="s1">&#39;zpool upgrade&#39;</span>.  Once this is <span class="k">done</span>, the
        pool will no longer be accessible on software that does not support feat
        flags.
  scan: none requested
config:

        NAME        STATE     READ WRITE CKSUM
        mypool      ONLINE       0     0     0
          mirror-0  ONLINE       0     0     0
	    ada0    ONLINE       0     0     0
	    ada1    ONLINE       0     0     0

errors: No known data errors
<span class="c"># zpool upgrade</span>
This system supports ZFS pool feature flags.

The following pools are formatted with legacy version numbers and are upgraded to use feature flags.
After being upgraded, these pools will no longer be accessible by software that does not support feature flags.

VER  POOL
---  ------------
28   mypool

Use <span class="s1">&#39;zpool upgrade -v&#39;</span> <span class="k">for </span>a list of available legacy versions.
Every feature flags pool has all supported features enabled.
<span class="c"># zpool upgrade mypool</span>
This system supports ZFS pool feature flags.

Successfully upgraded <span class="s1">&#39;mypool&#39;</span> from version 28 to feature flags.
Enabled the following features on <span class="s1">&#39;mypool&#39;</span>:
  async_destroy
  empty_bpobj
  lz4_compress
  multi_vdev_crash_dump</code></pre>
</div>
</div>
<div class="paragraph">
<p>The newer features of ZFS will not be available until <code>zpool upgrade</code> has completed. Use <code>zpool upgrade -v</code> to see what new features the upgrade provides, as well as which features are already supported.</p>
</div>
<div class="paragraph">
<p>Upgrade a pool to support new feature flags:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zpool status</span>
  pool: mypool
 state: ONLINE
status: Some supported features are not enabled on the pool. The pool can
        still be used, but some features are unavailable.
action: Enable all features using <span class="s1">&#39;zpool upgrade&#39;</span>. Once this is <span class="k">done</span>,
        the pool may no longer be accessible by software that does not support
        the features. See zpool-features<span class="o">(</span>7<span class="o">)</span> <span class="k">for </span>details.
  scan: none requested
config:

        NAME        STATE     READ WRITE CKSUM
        mypool      ONLINE       0     0     0
          mirror-0  ONLINE       0     0     0
	    ada0    ONLINE       0     0     0
	    ada1    ONLINE       0     0     0

errors: No known data errors
<span class="c"># zpool upgrade</span>
This system supports ZFS pool feature flags.

All pools are formatted using feature flags.

Some supported features are not enabled on the following pools. Once a
feature is enabled the pool may become incompatible with software
that does not support the feature. See zpool-features<span class="o">(</span>7<span class="o">)</span> <span class="k">for </span>details.

POOL  FEATURE
---------------
zstore
      multi_vdev_crash_dump
      spacemap_histogram
      enabled_txg
      hole_birth
      extensible_dataset
      bookmarks
      filesystem_limits
<span class="c"># zpool upgrade mypool</span>
This system supports ZFS pool feature flags.

Enabled the following features on <span class="s1">&#39;mypool&#39;</span>:
  spacemap_histogram
  enabled_txg
  hole_birth
  extensible_dataset
  bookmarks
  filesystem_limits</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Update the boot code on systems that boot from a pool to support the new pool version. Use <code>gpart bootcode</code> on the partition that contains the boot code. Two types of bootcode are available, depending on way the system boots: GPT (the most common option) and EFI (for more modern systems).</p>
</div>
<div class="paragraph">
<p>For legacy boot using GPT, use the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># gpart bootcode -b /boot/pmbr -p /boot/gptzfsboot -i 1 ada1</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For systems using EFI to boot, execute the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># gpart bootcode -p /boot/boot1.efifat -i 1 ada1</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Apply the bootcode to all bootable disks in the pool. See <a href="https://man.freebsd.org/cgi/man.cgi?query=gpart&amp;sektion=8&amp;format=html">gpart(8)</a> for more information.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect3">
<h4 id="zfs-zpool-history">22.3.12. Displaying Recorded Pool History<a class="anchor" href="#zfs-zpool-history"></a></h4>
<div class="paragraph">
<p>ZFS records commands that change the pool, including creating datasets, changing properties, or replacing a disk. Reviewing history about a pool’s creation is useful, as is checking which user performed a specific action and when. History is not kept in a log file, but is part of the pool itself. The command to review this history is aptly named <code>zpool history</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zpool history</span>
History <span class="k">for</span> <span class="s1">&#39;tank&#39;</span>:
2013-02-26.23:02:35 zpool create tank mirror /dev/ada0 /dev/ada1
2013-02-27.18:50:58 zfs <span class="nb">set </span><span class="nv">atime</span><span class="o">=</span>off tank
2013-02-27.18:51:09 zfs <span class="nb">set </span><span class="nv">checksum</span><span class="o">=</span>fletcher4 tank
2013-02-27.18:51:18 zfs create tank/backup</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output shows <code>zpool</code> and <code>zfs</code> commands altering the pool in some way along with a timestamp. Commands like <code>zfs list</code> are not included. When specifying no pool name, ZFS displays history of all pools.</p>
</div>
<div class="paragraph">
<p><code>zpool history</code> can show even more information when providing the options <code>-i</code> or <code>-l</code>. <code>-i</code> displays user-initiated events as well as internally logged ZFS events.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zpool history -i</span>
History <span class="k">for</span> <span class="s1">&#39;tank&#39;</span>:
2013-02-26.23:02:35 <span class="o">[</span>internal pool create txg:5] pool spa 28; zfs spa 28; zpl 5;uts  9.1-RELEASE 901000 amd64
2013-02-27.18:50:53 <span class="o">[</span>internal property <span class="nb">set </span>txg:50] <span class="nv">atime</span><span class="o">=</span>0 dataset <span class="o">=</span> 21
2013-02-27.18:50:58 zfs <span class="nb">set </span><span class="nv">atime</span><span class="o">=</span>off tank
2013-02-27.18:51:04 <span class="o">[</span>internal property <span class="nb">set </span>txg:53] <span class="nv">checksum</span><span class="o">=</span>7 dataset <span class="o">=</span> 21
2013-02-27.18:51:09 zfs <span class="nb">set </span><span class="nv">checksum</span><span class="o">=</span>fletcher4 tank
2013-02-27.18:51:13 <span class="o">[</span>internal create txg:55] dataset <span class="o">=</span> 39
2013-02-27.18:51:18 zfs create tank/backup</code></pre>
</div>
</div>
<div class="paragraph">
<p>Show more details by adding <code>-l</code>. Showing history records in a long format, including information like the name of the user who issued the command and the hostname on which the change happened.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zpool history -l</span>
History <span class="k">for</span> <span class="s1">&#39;tank&#39;</span>:
2013-02-26.23:02:35 zpool create tank mirror /dev/ada0 /dev/ada1 <span class="o">[</span>user 0 <span class="o">(</span>root<span class="o">)</span> on :global]
2013-02-27.18:50:58 zfs <span class="nb">set </span><span class="nv">atime</span><span class="o">=</span>off tank <span class="o">[</span>user 0 <span class="o">(</span>root<span class="o">)</span> on myzfsbox:global]
2013-02-27.18:51:09 zfs <span class="nb">set </span><span class="nv">checksum</span><span class="o">=</span>fletcher4 tank <span class="o">[</span>user 0 <span class="o">(</span>root<span class="o">)</span> on myzfsbox:global]
2013-02-27.18:51:18 zfs create tank/backup <span class="o">[</span>user 0 <span class="o">(</span>root<span class="o">)</span> on myzfsbox:global]</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output shows that the <code>root</code> user created the mirrored pool with disks <span class="filename">/dev/ada0</span> and <span class="filename">/dev/ada1</span>. The hostname <code>myzfsbox</code> is also shown in the commands after the pool’s creation. The hostname display becomes important when exporting the pool from one system and importing on another. It’s possible to distinguish the commands issued on the other system by the hostname recorded for each command.</p>
</div>
<div class="paragraph">
<p>Combine both options to <code>zpool history</code> to give the most detailed information possible for any given pool. Pool history provides valuable information when tracking down the actions performed or when needing more detailed output for debugging.</p>
</div>
</div>
<div class="sect3">
<h4 id="zfs-zpool-iostat">22.3.13. Performance Monitoring<a class="anchor" href="#zfs-zpool-iostat"></a></h4>
<div class="paragraph">
<p>A built-in monitoring system can display pool I/O statistics in real time. It shows the amount of free and used space on the pool, read and write operations performed per second, and I/O bandwidth used. By default, ZFS monitors and displays all pools in the system. Provide a pool name to limit monitoring to that pool. A basic example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zpool iostat</span>
               capacity     operations    bandwidth
pool        alloc   free   <span class="nb">read  </span>write   <span class="nb">read  </span>write
----------  -----  -----  -----  -----  -----  -----
data         288G  1.53T      2     11  11.3K  57.1K</code></pre>
</div>
</div>
<div class="paragraph">
<p>To continuously see I/O activity, specify a number as the last parameter, indicating an interval in seconds to wait between updates. The next statistic line prints after each interval. Press <span class="keyseq"><kbd>Ctrl</kbd>+<kbd>C</kbd></span> to stop this continuous monitoring. Give a second number on the command line after the interval to specify the total number of statistics to display.</p>
</div>
<div class="paragraph">
<p>Display even more detailed I/O statistics with <code>-v</code>. Each device in the pool appears with a statistics line. This is useful for seeing read and write operations performed on each device, and can help determine if any individual device is slowing down the pool. This example shows a mirrored pool with two devices:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zpool iostat -v</span>
                            capacity     operations    bandwidth
pool                     alloc   free   <span class="nb">read  </span>write   <span class="nb">read  </span>write
-----------------------  -----  -----  -----  -----  -----  -----
data                      288G  1.53T      2     12  9.23K  61.5K
  mirror                  288G  1.53T      2     12  9.23K  61.5K
    ada1                     -      -      0      4  5.61K  61.7K
    ada2                     -      -      1      4  5.04K  61.7K
-----------------------  -----  -----  -----  -----  -----  -----</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="zfs-zpool-split">22.3.14. Splitting a Storage Pool<a class="anchor" href="#zfs-zpool-split"></a></h4>
<div class="paragraph">
<p>ZFS can split a pool consisting of one or more mirror vdevs into two pools. Unless otherwise specified, ZFS detaches the last member of each mirror and creates a new pool containing the same data. Be sure to make a dry run of the operation with <code>-n</code> first. This displays the details of the requested operation without actually performing it. This helps confirm that the operation will do what the user intends.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="zfs-zfs">22.4. <code>zfs</code> Administration<a class="anchor" href="#zfs-zfs"></a></h3>
<div class="paragraph">
<p>The <code>zfs</code> utility can create, destroy, and manage all existing ZFS datasets within a pool. To manage the pool itself, use <a href="#zfs-zpool"><code>zpool</code></a>.</p>
</div>
<div class="sect3">
<h4 id="zfs-zfs-create">22.4.1. Creating and Destroying Datasets<a class="anchor" href="#zfs-zfs-create"></a></h4>
<div class="paragraph">
<p>Unlike traditional disks and volume managers, space in ZFS is <em>not</em> preallocated. With traditional file systems, after partitioning and assigning the space, there is no way to add a new file system without adding a new disk. With ZFS, creating new file systems is possible at any time. Each <a href="#zfs-term-dataset"><em>dataset</em></a> has properties including features like compression, deduplication, caching, and quotas, as well as other useful properties like readonly, case sensitivity, network file sharing, and a mount point. Nesting datasets within each other is possible and child datasets will inherit properties from their ancestors. <a href="#zfs-zfs-allow">Delegate</a>, <a href="#zfs-zfs-send">replicate</a>, <a href="#zfs-zfs-snapshot">snapshot</a>, <a href="#zfs-zfs-jail">jail</a> allows administering and destroying each dataset as a unit. Creating a separate dataset for each different type or set of files has advantages. The drawbacks to having a large number of datasets are that some commands like <code>zfs list</code> will be slower, and that mounting of hundreds or even thousands of datasets will slow the FreeBSD boot process.</p>
</div>
<div class="paragraph">
<p>Create a new dataset and enable <a href="#zfs-term-compression-lz4">LZ4 compression</a> on it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zfs list</span>
NAME                  USED  AVAIL  REFER  MOUNTPOINT
mypool                781M  93.2G   144K  none
mypool/ROOT           777M  93.2G   144K  none
mypool/ROOT/default   777M  93.2G   777M  /
mypool/tmp            176K  93.2G   176K  /tmp
mypool/usr            616K  93.2G   144K  /usr
mypool/usr/home       184K  93.2G   184K  /usr/home
mypool/usr/ports      144K  93.2G   144K  /usr/ports
mypool/usr/src        144K  93.2G   144K  /usr/src
mypool/var           1.20M  93.2G   608K  /var
mypool/var/crash      148K  93.2G   148K  /var/crash
mypool/var/log        178K  93.2G   178K  /var/log
mypool/var/mail       144K  93.2G   144K  /var/mail
mypool/var/tmp        152K  93.2G   152K  /var/tmp
<span class="c"># zfs create -o compress=lz4 mypool/usr/mydataset</span>
<span class="c"># zfs list</span>
NAME                   USED  AVAIL  REFER  MOUNTPOINT
mypool                 781M  93.2G   144K  none
mypool/ROOT            777M  93.2G   144K  none
mypool/ROOT/default    777M  93.2G   777M  /
mypool/tmp             176K  93.2G   176K  /tmp
mypool/usr             704K  93.2G   144K  /usr
mypool/usr/home        184K  93.2G   184K  /usr/home
mypool/usr/mydataset  87.5K  93.2G  87.5K  /usr/mydataset
mypool/usr/ports       144K  93.2G   144K  /usr/ports
mypool/usr/src         144K  93.2G   144K  /usr/src
mypool/var            1.20M  93.2G   610K  /var
mypool/var/crash       148K  93.2G   148K  /var/crash
mypool/var/log         178K  93.2G   178K  /var/log
mypool/var/mail        144K  93.2G   144K  /var/mail
mypool/var/tmp         152K  93.2G   152K  /var/tmp</code></pre>
</div>
</div>
<div class="paragraph">
<p>Destroying a dataset is much quicker than deleting the files on the dataset, as it does not involve scanning the files and updating the corresponding metadata.</p>
</div>
<div class="paragraph">
<p>Destroy the created dataset:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zfs list</span>
NAME                   USED  AVAIL  REFER  MOUNTPOINT
mypool                 880M  93.1G   144K  none
mypool/ROOT            777M  93.1G   144K  none
mypool/ROOT/default    777M  93.1G   777M  /
mypool/tmp             176K  93.1G   176K  /tmp
mypool/usr             101M  93.1G   144K  /usr
mypool/usr/home        184K  93.1G   184K  /usr/home
mypool/usr/mydataset   100M  93.1G   100M  /usr/mydataset
mypool/usr/ports       144K  93.1G   144K  /usr/ports
mypool/usr/src         144K  93.1G   144K  /usr/src
mypool/var            1.20M  93.1G   610K  /var
mypool/var/crash       148K  93.1G   148K  /var/crash
mypool/var/log         178K  93.1G   178K  /var/log
mypool/var/mail        144K  93.1G   144K  /var/mail
mypool/var/tmp         152K  93.1G   152K  /var/tmp
<span class="c"># zfs destroy mypool/usr/mydataset</span>
<span class="c"># zfs list</span>
NAME                  USED  AVAIL  REFER  MOUNTPOINT
mypool                781M  93.2G   144K  none
mypool/ROOT           777M  93.2G   144K  none
mypool/ROOT/default   777M  93.2G   777M  /
mypool/tmp            176K  93.2G   176K  /tmp
mypool/usr            616K  93.2G   144K  /usr
mypool/usr/home       184K  93.2G   184K  /usr/home
mypool/usr/ports      144K  93.2G   144K  /usr/ports
mypool/usr/src        144K  93.2G   144K  /usr/src
mypool/var           1.21M  93.2G   612K  /var
mypool/var/crash      148K  93.2G   148K  /var/crash
mypool/var/log        178K  93.2G   178K  /var/log
mypool/var/mail       144K  93.2G   144K  /var/mail
mypool/var/tmp        152K  93.2G   152K  /var/tmp</code></pre>
</div>
</div>
<div class="paragraph">
<p>In modern versions of ZFS, <code>zfs destroy</code> is asynchronous, and the free space might take minutes to appear in the pool. Use <code>zpool get freeing <em>poolname</em></code> to see the <code>freeing</code> property, that shows which datasets are having their blocks freed in the background. If there are child datasets, like <a href="#zfs-term-snapshot">snapshots</a> or other datasets, destroying the parent is impossible. To destroy a dataset and its children, use <code>-r</code> to recursively destroy the dataset and its children. Use <code>-n -v</code> to list datasets and snapshots destroyed by this operation, without actually destroy anything. Space reclaimed by destroying snapshots is also shown.</p>
</div>
</div>
<div class="sect3">
<h4 id="zfs-zfs-volume">22.4.2. Creating and Destroying Volumes<a class="anchor" href="#zfs-zfs-volume"></a></h4>
<div class="paragraph">
<p>A volume is a special dataset type. Rather than mounting as a file system, expose it as a block device under <span class="filename">/dev/zvol/poolname/dataset</span>. This allows using the volume for other file systems, to back the disks of a virtual machine, or to make it available to other network hosts using protocols like iSCSI or HAST.</p>
</div>
<div class="paragraph">
<p>Format a volume with any file system or without a file system to store raw data. To the user, a volume appears to be a regular disk. Putting ordinary file systems on these <em>zvols</em> provides features that ordinary disks or file systems do not have. For example, using the compression property on a 250 MB volume allows creation of a compressed FAT file system.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zfs create -V 250m -o compression=on tank/fat32</span>
<span class="c"># zfs list tank</span>
NAME USED AVAIL REFER MOUNTPOINT
tank 258M  670M   31K /tank
<span class="c"># newfs_msdos -F32 /dev/zvol/tank/fat32</span>
<span class="c"># mount -t msdosfs /dev/zvol/tank/fat32 /mnt</span>
<span class="c"># df -h /mnt | grep fat32</span>
Filesystem           Size Used Avail Capacity Mounted on
/dev/zvol/tank/fat32 249M  24k  249M     0%   /mnt
<span class="c"># mount | grep fat32</span>
/dev/zvol/tank/fat32 on /mnt <span class="o">(</span>msdosfs, <span class="nb">local</span><span class="o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Destroying a volume is much the same as destroying a regular file system dataset. The operation is nearly instantaneous, but it may take minutes to reclaim the free space in the background.</p>
</div>
</div>
<div class="sect3">
<h4 id="zfs-zfs-rename">22.4.3. Renaming a Dataset<a class="anchor" href="#zfs-zfs-rename"></a></h4>
<div class="paragraph">
<p>To change the name of a dataset, use <code>zfs rename</code>. To change the parent of a dataset, use this command as well. Renaming a dataset to have a different parent dataset will change the value of those properties inherited from the parent dataset. Renaming a dataset unmounts then remounts it in the new location (inherited from the new parent dataset). To prevent this behavior, use <code>-u</code>.</p>
</div>
<div class="paragraph">
<p>Rename a dataset and move it to be under a different parent dataset:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zfs list</span>
NAME                   USED  AVAIL  REFER  MOUNTPOINT
mypool                 780M  93.2G   144K  none
mypool/ROOT            777M  93.2G   144K  none
mypool/ROOT/default    777M  93.2G   777M  /
mypool/tmp             176K  93.2G   176K  /tmp
mypool/usr             704K  93.2G   144K  /usr
mypool/usr/home        184K  93.2G   184K  /usr/home
mypool/usr/mydataset  87.5K  93.2G  87.5K  /usr/mydataset
mypool/usr/ports       144K  93.2G   144K  /usr/ports
mypool/usr/src         144K  93.2G   144K  /usr/src
mypool/var            1.21M  93.2G   614K  /var
mypool/var/crash       148K  93.2G   148K  /var/crash
mypool/var/log         178K  93.2G   178K  /var/log
mypool/var/mail        144K  93.2G   144K  /var/mail
mypool/var/tmp         152K  93.2G   152K  /var/tmp
<span class="c"># zfs rename mypool/usr/mydataset mypool/var/newname</span>
<span class="c"># zfs list</span>
NAME                  USED  AVAIL  REFER  MOUNTPOINT
mypool                780M  93.2G   144K  none
mypool/ROOT           777M  93.2G   144K  none
mypool/ROOT/default   777M  93.2G   777M  /
mypool/tmp            176K  93.2G   176K  /tmp
mypool/usr            616K  93.2G   144K  /usr
mypool/usr/home       184K  93.2G   184K  /usr/home
mypool/usr/ports      144K  93.2G   144K  /usr/ports
mypool/usr/src        144K  93.2G   144K  /usr/src
mypool/var           1.29M  93.2G   614K  /var
mypool/var/crash      148K  93.2G   148K  /var/crash
mypool/var/log        178K  93.2G   178K  /var/log
mypool/var/mail       144K  93.2G   144K  /var/mail
mypool/var/newname   87.5K  93.2G  87.5K  /var/newname
mypool/var/tmp        152K  93.2G   152K  /var/tmp</code></pre>
</div>
</div>
<div class="paragraph">
<p>Renaming snapshots uses the same command. Due to the nature of snapshots, rename cannot change their parent dataset. To rename a recursive snapshot, specify <code>-r</code>; this will also rename all snapshots with the same name in child datasets.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zfs list -t snapshot</span>
NAME                                USED  AVAIL  REFER  MOUNTPOINT
mypool/var/newname@first_snapshot      0      -  87.5K  -
<span class="c"># zfs rename mypool/var/newname@first_snapshot new_snapshot_name</span>
<span class="c"># zfs list -t snapshot</span>
NAME                                   USED  AVAIL  REFER  MOUNTPOINT
mypool/var/newname@new_snapshot_name      0      -  87.5K  -</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="zfs-zfs-set">22.4.4. Setting Dataset Properties<a class="anchor" href="#zfs-zfs-set"></a></h4>
<div class="paragraph">
<p>Each ZFS dataset has properties that control its behavior. Most properties are automatically inherited from the parent dataset, but can be overridden locally. Set a property on a dataset with <code>zfs set <em>property=value dataset</em></code>. Most properties have a limited set of valid values, <code>zfs get</code> will display each possible property and valid values. Using <code>zfs inherit</code> reverts most properties to their inherited values. User-defined properties are also possible. They become part of the dataset configuration and provide further information about the dataset or its contents. To distinguish these custom properties from the ones supplied as part of ZFS, use a colon (<code>:</code>) to create a custom namespace for the property.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zfs set custom:costcenter=1234 tank</span>
<span class="c"># zfs get custom:costcenter tank</span>
NAME PROPERTY           VALUE SOURCE
tank custom:costcenter  1234  <span class="nb">local</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To remove a custom property, use <code>zfs inherit</code> with <code>-r</code>. If the custom property is not defined in any of the parent datasets, this option removes it (but the pool’s history still records the change).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zfs inherit -r custom:costcenter tank</span>
<span class="c"># zfs get custom:costcenter tank</span>
NAME    PROPERTY           VALUE              SOURCE
tank    custom:costcenter  -                  -
<span class="c"># zfs get all tank | grep custom:costcenter</span>
<span class="c">#</span></code></pre>
</div>
</div>
<div class="sect4">
<h5 id="zfs-zfs-set-share">22.4.4.1. Getting and Setting Share Properties<a class="anchor" href="#zfs-zfs-set-share"></a></h5>
<div class="paragraph">
<p>Two commonly used and useful dataset properties are the NFS and SMB share options. Setting these defines if and how ZFS shares datasets on the network. At present, FreeBSD supports setting NFS sharing alone. To get the current status of a share, enter:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zfs get sharenfs mypool/usr/home</span>
NAME             PROPERTY  VALUE    SOURCE
mypool/usr/home  sharenfs  on       <span class="nb">local</span>
<span class="c"># zfs get sharesmb mypool/usr/home</span>
NAME             PROPERTY  VALUE    SOURCE
mypool/usr/home  sharesmb  off      <span class="nb">local</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To enable sharing of a dataset, enter:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c">#  zfs set sharenfs=on mypool/usr/home</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Set other options for sharing datasets through NFS, such as <code>-alldirs</code>, <code>-maproot</code> and <code>-network</code>. To set options on a dataset shared through NFS, enter:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c">#  zfs set sharenfs=&#34;-alldirs,-maproot=root,-network=192.168.1.0/24&#34; mypool/usr/home</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="zfs-zfs-snapshot">22.4.5. Managing Snapshots<a class="anchor" href="#zfs-zfs-snapshot"></a></h4>
<div class="paragraph">
<p><a href="#zfs-term-snapshot">Snapshots</a> are one of the most powerful features of ZFS. A snapshot provides a read-only, point-in-time copy of the dataset. With Copy-On-Write (COW), ZFS creates snapshots fast by preserving older versions of the data on disk. If no snapshots exist, ZFS reclaims space for future use when data is rewritten or deleted. Snapshots preserve disk space by recording just the differences between the current dataset and a previous version. Allowing snapshots on whole datasets, not on individual files or directories. A snapshot from a dataset duplicates everything contained in it. This includes the file system properties, files, directories, permissions, and so on. Snapshots use no extra space when first created, but consume space as the blocks they reference change. Recursive snapshots taken with <code>-r</code> create snapshots with the same name on the dataset and its children, providing a consistent moment-in-time snapshot of the file systems. This can be important when an application has files on related datasets or that depend upon each other. Without snapshots, a backup would have copies of the files from different points in time.</p>
</div>
<div class="paragraph">
<p>Snapshots in ZFS provide a variety of features that even other file systems with snapshot functionality lack. A typical example of snapshot use is as a quick way of backing up the current state of the file system when performing a risky action like a software installation or a system upgrade. If the action fails, rolling back to the snapshot returns the system to the same state when creating the snapshot. If the upgrade was successful, delete the snapshot to free up space. Without snapshots, a failed upgrade often requires restoring backups, which is tedious, time consuming, and may require downtime during which the system is unusable. Rolling back to snapshots is fast, even while the system is running in normal operation, with little or no downtime. The time savings are enormous with multi-terabyte storage systems considering the time required to copy the data from backup. Snapshots are not a replacement for a complete backup of a pool, but offer a quick and easy way to store a dataset copy at a specific time.</p>
</div>
<div class="sect4">
<h5 id="zfs-zfs-snapshot-creation">22.4.5.1. Creating Snapshots<a class="anchor" href="#zfs-zfs-snapshot-creation"></a></h5>
<div class="paragraph">
<p>To create snapshots, use <code>zfs snapshot <em>dataset</em>@<em>snapshotname</em></code>. Adding <code>-r</code> creates a snapshot recursively, with the same name on all child datasets.</p>
</div>
<div class="paragraph">
<p>Create a recursive snapshot of the entire pool:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zfs list -t all</span>
NAME                                   USED  AVAIL  REFER  MOUNTPOINT
mypool                                 780M  93.2G   144K  none
mypool/ROOT                            777M  93.2G   144K  none
mypool/ROOT/default                    777M  93.2G   777M  /
mypool/tmp                             176K  93.2G   176K  /tmp
mypool/usr                             616K  93.2G   144K  /usr
mypool/usr/home                        184K  93.2G   184K  /usr/home
mypool/usr/ports                       144K  93.2G   144K  /usr/ports
mypool/usr/src                         144K  93.2G   144K  /usr/src
mypool/var                            1.29M  93.2G   616K  /var
mypool/var/crash                       148K  93.2G   148K  /var/crash
mypool/var/log                         178K  93.2G   178K  /var/log
mypool/var/mail                        144K  93.2G   144K  /var/mail
mypool/var/newname                    87.5K  93.2G  87.5K  /var/newname
mypool/var/newname@new_snapshot_name      0      -  87.5K  -
mypool/var/tmp                         152K  93.2G   152K  /var/tmp
<span class="c"># zfs snapshot -r mypool@my_recursive_snapshot</span>
<span class="c"># zfs list -t snapshot</span>
NAME                                        USED  AVAIL  REFER  MOUNTPOINT
mypool@my_recursive_snapshot                   0      -   144K  -
mypool/ROOT@my_recursive_snapshot              0      -   144K  -
mypool/ROOT/default@my_recursive_snapshot      0      -   777M  -
mypool/tmp@my_recursive_snapshot               0      -   176K  -
mypool/usr@my_recursive_snapshot               0      -   144K  -
mypool/usr/home@my_recursive_snapshot          0      -   184K  -
mypool/usr/ports@my_recursive_snapshot         0      -   144K  -
mypool/usr/src@my_recursive_snapshot           0      -   144K  -
mypool/var@my_recursive_snapshot               0      -   616K  -
mypool/var/crash@my_recursive_snapshot         0      -   148K  -
mypool/var/log@my_recursive_snapshot           0      -   178K  -
mypool/var/mail@my_recursive_snapshot          0      -   144K  -
mypool/var/newname@new_snapshot_name           0      -  87.5K  -
mypool/var/newname@my_recursive_snapshot       0      -  87.5K  -
mypool/var/tmp@my_recursive_snapshot           0      -   152K  -</code></pre>
</div>
</div>
<div class="paragraph">
<p>Snapshots are not shown by a normal <code>zfs list</code> operation. To list snapshots, append <code>-t snapshot</code> to <code>zfs list</code>. <code>-t all</code> displays both file systems and snapshots.</p>
</div>
<div class="paragraph">
<p>Snapshots are not mounted directly, showing no path in the <code>MOUNTPOINT</code> column. ZFS does not mention available disk space in the <code>AVAIL</code> column, as snapshots are read-only after their creation. Compare the snapshot to the original dataset:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zfs list -rt all mypool/usr/home</span>
NAME                                    USED  AVAIL  REFER  MOUNTPOINT
mypool/usr/home                         184K  93.2G   184K  /usr/home
mypool/usr/home@my_recursive_snapshot      0      -   184K  -</code></pre>
</div>
</div>
<div class="paragraph">
<p>Displaying both the dataset and the snapshot together reveals how snapshots work in <a href="#zfs-term-cow">COW</a> fashion. They save the changes (<em>delta</em>) made and not the complete file system contents all over again. This means that snapshots take little space when making changes. Observe space usage even more by copying a file to the dataset, then creating a second snapshot:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># cp /etc/passwd /var/tmp</span>
<span class="c"># zfs snapshot mypool/var/tmp@after_cp</span>
<span class="c"># zfs list -rt all mypool/var/tmp</span>
NAME                                   USED  AVAIL  REFER  MOUNTPOINT
mypool/var/tmp                         206K  93.2G   118K  /var/tmp
mypool/var/tmp@my_recursive_snapshot    88K      -   152K  -
mypool/var/tmp@after_cp                   0      -   118K  -</code></pre>
</div>
</div>
<div class="paragraph">
<p>The second snapshot contains the changes to the dataset after the copy operation. This yields enormous space savings. Notice that the size of the snapshot <code><em>mypool/var/tmp@my_recursive_snapshot</em></code> also changed in the <code>USED</code> column to show the changes between itself and the snapshot taken afterwards.</p>
</div>
</div>
<div class="sect4">
<h5 id="zfs-zfs-snapshot-diff">22.4.5.2. Comparing Snapshots<a class="anchor" href="#zfs-zfs-snapshot-diff"></a></h5>
<div class="paragraph">
<p>ZFS provides a built-in command to compare the differences in content between two snapshots. This is helpful with a lot of snapshots taken over time when the user wants to see how the file system has changed over time. For example, <code>zfs diff</code> lets a user find the latest snapshot that still contains a file deleted by accident. Doing this for the two snapshots created in the previous section yields this output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zfs list -rt all mypool/var/tmp</span>
NAME                                   USED  AVAIL  REFER  MOUNTPOINT
mypool/var/tmp                         206K  93.2G   118K  /var/tmp
mypool/var/tmp@my_recursive_snapshot    88K      -   152K  -
mypool/var/tmp@after_cp                   0      -   118K  -
<span class="c"># zfs diff mypool/var/tmp@my_recursive_snapshot</span>
M       /var/tmp/
+       /var/tmp/passwd</code></pre>
</div>
</div>
<div class="paragraph">
<p>The command lists the changes between the specified snapshot (in this case <code><em>mypool/var/tmp@my_recursive_snapshot</em></code>) and the live file system. The first column shows the change type:</p>
</div>
<table class="tableblock frame-all grid-all stretch informaltable">
<colgroup>
<col style="width: 20%;"/>
<col style="width: 80%;"/>
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">+</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Adding the path or file.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Deleting the path or file.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">M</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Modifying the path or file.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">R</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Renaming the path or file.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Comparing the output with the table, it becomes clear that ZFS added <span class="filename">passwd</span> after creating the snapshot <code><em>mypool/var/tmp@my_recursive_snapshot</em></code>. This also resulted in a modification to the parent directory mounted at <code><em>/var/tmp</em></code>.</p>
</div>
<div class="paragraph">
<p>Comparing two snapshots is helpful when using the ZFS replication feature to transfer a dataset to a different host for backup purposes.</p>
</div>
<div class="paragraph">
<p>Compare two snapshots by providing the full dataset name and snapshot name of both datasets:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># cp /var/tmp/passwd /var/tmp/passwd.copy</span>
<span class="c"># zfs snapshot mypool/var/tmp@diff_snapshot</span>
<span class="c"># zfs diff mypool/var/tmp@my_recursive_snapshot mypool/var/tmp@diff_snapshot</span>
M       /var/tmp/
+       /var/tmp/passwd
+       /var/tmp/passwd.copy
<span class="c"># zfs diff mypool/var/tmp@my_recursive_snapshot mypool/var/tmp@after_cp</span>
M       /var/tmp/
+       /var/tmp/passwd</code></pre>
</div>
</div>
<div class="paragraph">
<p>A backup administrator can compare two snapshots received from the sending host and determine the actual changes in the dataset. See the <a href="#zfs-zfs-send">Replication</a> section for more information.</p>
</div>
</div>
<div class="sect4">
<h5 id="zfs-zfs-snapshot-rollback">22.4.5.3. Snapshot Rollback<a class="anchor" href="#zfs-zfs-snapshot-rollback"></a></h5>
<div class="paragraph">
<p>When at least one snapshot is available, roll back to it at any time. Most often this is the case when the current state of the dataset is no longer and if preferring an older version. Scenarios such as local development tests gone wrong, botched system updates hampering the system functionality, or the need to restore deleted files or directories are all too common occurrences. To roll back a snapshot, use <code>zfs rollback <em>snapshotname</em></code>. If a lot of changes are present, the operation will take a long time. During that time, the dataset always remains in a consistent state, much like a database that conforms to ACID principles is performing a rollback. This is happening while the dataset is live and accessible without requiring a downtime. Once the snapshot rolled back, the dataset has the same state as it had when the snapshot was originally taken. Rolling back to a snapshot discards all other data in that dataset not part of the snapshot. Taking a snapshot of the current state of the dataset before rolling back to a previous one is a good idea when requiring some data later. This way, the user can roll back and forth between snapshots without losing data that is still valuable.</p>
</div>
<div class="paragraph">
<p>In the first example, roll back a snapshot because of a careless <code>rm</code> operation that removes too much data than intended.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zfs list -rt all mypool/var/tmp</span>
NAME                                   USED  AVAIL  REFER  MOUNTPOINT
mypool/var/tmp                         262K  93.2G   120K  /var/tmp
mypool/var/tmp@my_recursive_snapshot    88K      -   152K  -
mypool/var/tmp@after_cp               53.5K      -   118K  -
mypool/var/tmp@diff_snapshot              0      -   120K  -
<span class="c"># ls /var/tmp</span>
passwd          passwd.copy     vi.recover
<span class="c"># rm /var/tmp/passwd*</span>
<span class="c"># ls /var/tmp</span>
vi.recover</code></pre>
</div>
</div>
<div class="paragraph">
<p>At this point, the user notices the removal of extra files and wants them back. ZFS provides an easy way to get them back using rollbacks, when performing snapshots of important data on a regular basis. To get the files back and start over from the last snapshot, issue the command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zfs rollback mypool/var/tmp@diff_snapshot</span>
<span class="c"># ls /var/tmp</span>
passwd          passwd.copy     vi.recover</code></pre>
</div>
</div>
<div class="paragraph">
<p>The rollback operation restored the dataset to the state of the last snapshot. Rolling back to a snapshot taken much earlier with other snapshots taken afterwards is also possible. When trying to do this, ZFS will issue this warning:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zfs list -rt snapshot mypool/var/tmp</span>
AME                                   USED  AVAIL  REFER  MOUNTPOINT
mypool/var/tmp@my_recursive_snapshot    88K      -   152K  -
mypool/var/tmp@after_cp               53.5K      -   118K  -
mypool/var/tmp@diff_snapshot              0      -   120K  -
<span class="c"># zfs rollback mypool/var/tmp@my_recursive_snapshot</span>
cannot rollback to <span class="s1">&#39;mypool/var/tmp@my_recursive_snapshot&#39;</span>: more recent snapshots exist
use <span class="s1">&#39;-r&#39;</span> to force deletion of the following snapshots:
mypool/var/tmp@after_cp
mypool/var/tmp@diff_snapshot</code></pre>
</div>
</div>
<div class="paragraph">
<p>This warning means that snapshots exist between the current state of the dataset and the snapshot to which the user wants to roll back. To complete the rollback delete these snapshots. ZFS cannot track all the changes between different states of the dataset, because snapshots are read-only. ZFS will not delete the affected snapshots unless the user specifies <code>-r</code> to confirm that this is the desired action. If that is the intention, and understanding the consequences of losing all intermediate snapshots, issue the command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zfs rollback -r mypool/var/tmp@my_recursive_snapshot</span>
<span class="c"># zfs list -rt snapshot mypool/var/tmp</span>
NAME                                   USED  AVAIL  REFER  MOUNTPOINT
mypool/var/tmp@my_recursive_snapshot     8K      -   152K  -
<span class="c"># ls /var/tmp</span>
vi.recover</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output from <code>zfs list -t snapshot</code> confirms the removal of the intermediate snapshots as a result of <code>zfs rollback -r</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="zfs-zfs-snapshot-snapdir">22.4.5.4. Restoring Individual Files from Snapshots<a class="anchor" href="#zfs-zfs-snapshot-snapdir"></a></h5>
<div class="paragraph">
<p>Snapshots live in a hidden directory under the parent dataset: <span class="filename">.zfs/snapshots/snapshotname</span>. By default, these directories will not show even when executing a standard <code>ls -a</code> . Although the directory doesn’t show, access it like any normal directory. The property named <code>snapdir</code> controls whether these hidden directories show up in a directory listing. Setting the property to <code>visible</code> allows them to appear in the output of <code>ls</code> and other commands that deal with directory contents.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zfs get snapdir mypool/var/tmp</span>
NAME            PROPERTY  VALUE    SOURCE
mypool/var/tmp  snapdir   hidden   default
<span class="c"># ls -a /var/tmp</span>
.               ..              passwd          vi.recover
<span class="c"># zfs set snapdir=visible mypool/var/tmp</span>
<span class="c"># ls -a /var/tmp</span>
.               ..              .zfs            passwd          vi.recover</code></pre>
</div>
</div>
<div class="paragraph">
<p>Restore individual files to a previous state by copying them from the snapshot back to the parent dataset. The directory structure below <span class="filename">.zfs/snapshot</span> has a directory named like the snapshots taken earlier to make it easier to identify them. The next example shows how to restore a file from the hidden <span class="filename">.zfs</span> directory by copying it from the snapshot containing the latest version of the file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># rm /var/tmp/passwd</span>
<span class="c"># ls -a /var/tmp</span>
.               ..              .zfs            vi.recover
<span class="c"># ls /var/tmp/.zfs/snapshot</span>
after_cp                my_recursive_snapshot
<span class="c"># ls /var/tmp/.zfs/snapshot/after_cp</span>
passwd          vi.recover
<span class="c"># cp /var/tmp/.zfs/snapshot/after_cp/passwd /var/tmp</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Even if the <code>snapdir</code> property is set to hidden, running <code>ls .zfs/snapshot</code> will still list the contents of that directory. The administrator decides whether to display these directories. This is a per-dataset setting. Copying files or directories from this hidden <span class="filename">.zfs/snapshot</span> is simple enough. Trying it the other way around results in this error:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># cp /etc/rc.conf /var/tmp/.zfs/snapshot/after_cp/</span>
cp: /var/tmp/.zfs/snapshot/after_cp/rc.conf: Read-only file system</code></pre>
</div>
</div>
<div class="paragraph">
<p>The error reminds the user that snapshots are read-only and cannot change after creation. Copying files into and removing them from snapshot directories are both disallowed because that would change the state of the dataset they represent.</p>
</div>
<div class="paragraph">
<p>Snapshots consume space based on how much the parent file system has changed since the time of the snapshot. The <code>written</code> property of a snapshot tracks the space the snapshot uses.</p>
</div>
<div class="paragraph">
<p>To destroy snapshots and reclaim the space, use <code>zfs destroy <em>dataset</em>@<em>snapshot</em></code>. Adding <code>-r</code> recursively removes all snapshots with the same name under the parent dataset. Adding <code>-n -v</code> to the command displays a list of the snapshots to be deleted and an estimate of the space it would reclaim without performing the actual destroy operation.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="zfs-zfs-clones">22.4.6. Managing Clones<a class="anchor" href="#zfs-zfs-clones"></a></h4>
<div class="paragraph">
<p>A clone is a copy of a snapshot treated more like a regular dataset. Unlike a snapshot, a clone is writeable and mountable, and has its own properties. After creating a clone using <code>zfs clone</code>, destroying the originating snapshot is impossible. To reverse the child/parent relationship between the clone and the snapshot use <code>zfs promote</code>. Promoting a clone makes the snapshot become a child of the clone, rather than of the original parent dataset. This will change how ZFS accounts for the space, but not actually change the amount of space consumed. Mounting the clone anywhere within the ZFS file system hierarchy is possible, not only below the original location of the snapshot.</p>
</div>
<div class="paragraph">
<p>To show the clone feature use this example dataset:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zfs list -rt all camino/home/joe</span>
NAME                    USED  AVAIL  REFER  MOUNTPOINT
camino/home/joe         108K   1.3G    87K  /usr/home/joe
camino/home/joe@plans    21K      -  85.5K  -
camino/home/joe@backup    0K      -    87K  -</code></pre>
</div>
</div>
<div class="paragraph">
<p>A typical use for clones is to experiment with a specific dataset while keeping the snapshot around to fall back to in case something goes wrong. Since snapshots cannot change, create a read/write clone of a snapshot. After achieving the desired result in the clone, promote the clone to a dataset and remove the old file system. Removing the parent dataset is not strictly necessary, as the clone and dataset can coexist without problems.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zfs clone camino/home/joe@backup camino/home/joenew</span>
<span class="c"># ls /usr/home/joe*</span>
/usr/home/joe:
backup.txz     plans.txt

/usr/home/joenew:
backup.txz     plans.txt
<span class="c"># df -h /usr/home</span>
Filesystem          Size    Used   Avail Capacity  Mounted on
usr/home/joe        1.3G     31k    1.3G     0%    /usr/home/joe
usr/home/joenew     1.3G     31k    1.3G     0%    /usr/home/joenew</code></pre>
</div>
</div>
<div class="paragraph">
<p>Creating a clone makes it an exact copy of the state the dataset was in when taking the snapshot. Changing the clone independently from its originating dataset is possible now. The connection between the two is the snapshot. ZFS records this connection in the property <code>origin</code>. Promoting the clone with <code>zfs promote</code> makes the clone an independent dataset. This removes the value of the <code>origin</code> property and disconnects the newly independent dataset from the snapshot. This example shows it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zfs get origin camino/home/joenew</span>
NAME                  PROPERTY  VALUE                     SOURCE
camino/home/joenew    origin    camino/home/joe@backup    -
<span class="c"># zfs promote camino/home/joenew</span>
<span class="c"># zfs get origin camino/home/joenew</span>
NAME                  PROPERTY  VALUE   SOURCE
camino/home/joenew    origin    -       -</code></pre>
</div>
</div>
<div class="paragraph">
<p>After making some changes like copying <span class="filename">loader.conf</span> to the promoted clone, for example, the old directory becomes obsolete in this case. Instead, the promoted clone can replace it. To do this, <code>zfs destroy</code> the old dataset first and then <code>zfs rename</code> the clone to the old dataset name (or to an entirely different name).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># cp /boot/defaults/loader.conf /usr/home/joenew</span>
<span class="c"># zfs destroy -f camino/home/joe</span>
<span class="c"># zfs rename camino/home/joenew camino/home/joe</span>
<span class="c"># ls /usr/home/joe</span>
backup.txz     loader.conf     plans.txt
<span class="c"># df -h /usr/home</span>
Filesystem          Size    Used   Avail Capacity  Mounted on
usr/home/joe        1.3G    128k    1.3G     0%    /usr/home/joe</code></pre>
</div>
</div>
<div class="paragraph">
<p>The cloned snapshot is now an ordinary dataset. It contains all the data from the original snapshot plus the files added to it like <span class="filename">loader.conf</span>. Clones provide useful features to ZFS users in different scenarios. For example, provide jails as snapshots containing different sets of installed applications. Users can clone these snapshots and add their own applications as they see fit. Once satisfied with the changes, promote the clones to full datasets and provide them to end users to work with like they would with a real dataset. This saves time and administrative overhead when providing these jails.</p>
</div>
</div>
<div class="sect3">
<h4 id="zfs-zfs-send">22.4.7. Replication<a class="anchor" href="#zfs-zfs-send"></a></h4>
<div class="paragraph">
<p>Keeping data on a single pool in one location exposes it to risks like theft and natural or human disasters. Making regular backups of the entire pool is vital. ZFS provides a built-in serialization feature that can send a stream representation of the data to standard output. Using this feature, storing this data on another pool connected to the local system is possible, as is sending it over a network to another system. Snapshots are the basis for this replication (see the section on <a href="#zfs-zfs-snapshot">ZFS snapshots</a>). The commands used for replicating data are <code>zfs send</code> and <code>zfs receive</code>.</p>
</div>
<div class="paragraph">
<p>These examples show ZFS replication with these two pools:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zpool list</span>
NAME    SIZE  ALLOC   FREE   CKPOINT  EXPANDSZ   FRAG   CAP  DEDUP  HEALTH  ALTROOT
backup  960M    77K   896M         -         -     0%    0%  1.00x  ONLINE  -
mypool  984M  43.7M   940M         -         -     0%    4%  1.00x  ONLINE  -</code></pre>
</div>
</div>
<div class="paragraph">
<p>The pool named <em>mypool</em> is the primary pool where writing and reading data happens on a regular basis. Using a second standby pool <em>backup</em> in case the primary pool becomes unavailable. Note that this fail-over is not done automatically by ZFS, but must be manually done by a system administrator when needed. Use a snapshot to provide a consistent file system version to replicate. After creating a snapshot of <em>mypool</em>, copy it to the <em>backup</em> pool by replicating snapshots. This does not include changes made since the most recent snapshot.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zfs snapshot mypool@backup1</span>
<span class="c"># zfs list -t snapshot</span>
NAME                    USED  AVAIL  REFER  MOUNTPOINT
mypool@backup1             0      -  43.6M  -</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now that a snapshot exists, use <code>zfs send</code> to create a stream representing the contents of the snapshot. Store this stream as a file or receive it on another pool. Write the stream to standard output, but redirect to a file or pipe or an error appears:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zfs send mypool@backup1</span>
Error: Stream can not be written to a terminal.
You must redirect standard output.</code></pre>
</div>
</div>
<div class="paragraph">
<p>To back up a dataset with <code>zfs send</code>, redirect to a file located on the mounted backup pool. Ensure that the pool has enough free space to accommodate the size of the sent snapshot, which means the data contained in the snapshot, not the changes from the previous snapshot.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zfs send mypool@backup1 &gt; /backup/backup1</span>
<span class="c"># zpool list</span>
NAME    SIZE  ALLOC   FREE   CKPOINT  EXPANDSZ   FRAG    CAP  DEDUP  HEALTH  ALTROOT
backup  960M  63.7M   896M         -         -     0%     6%  1.00x  ONLINE  -
mypool  984M  43.7M   940M         -         -     0%     4%  1.00x  ONLINE  -</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>zfs send</code> transferred all the data in the snapshot called <em>backup1</em> to the pool named <em>backup</em>. To create and send these snapshots automatically, use a <a href="https://man.freebsd.org/cgi/man.cgi?query=cron&amp;sektion=8&amp;format=html">cron(8)</a> job.</p>
</div>
<div class="paragraph">
<p>Instead of storing the backups as archive files, ZFS can receive them as a live file system, allowing direct access to the backed up data. To get to the actual data contained in those streams, use <code>zfs receive</code> to transform the streams back into files and directories. The example below combines <code>zfs send</code> and <code>zfs receive</code> using a pipe to copy the data from one pool to another. Use the data directly on the receiving pool after the transfer is complete. It is only possible to replicate a dataset to an empty dataset.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zfs snapshot mypool@replica1</span>
<span class="c"># zfs send -v mypool@replica1 | zfs receive backup/mypool</span>
send from @ to mypool@replica1 estimated size is 50.1M
total estimated size is 50.1M
TIME        SENT   SNAPSHOT

<span class="c"># zpool list</span>
NAME    SIZE  ALLOC   FREE   CKPOINT  EXPANDSZ   FRAG    CAP  DEDUP  HEALTH  ALTROOT
backup  960M  63.7M   896M         -         -     0%     6%  1.00x  ONLINE  -
mypool  984M  43.7M   940M         -         -     0%     4%  1.00x  ONLINE  -</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="zfs-send-incremental">22.4.7.1. Incremental Backups<a class="anchor" href="#zfs-send-incremental"></a></h5>
<div class="paragraph">
<p><code>zfs send</code> can also determine the difference between two snapshots and send individual differences between the two. This saves disk space and transfer time. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zfs snapshot mypool@replica2</span>
<span class="c"># zfs list -t snapshot</span>
NAME                    USED  AVAIL  REFER  MOUNTPOINT
mypool@replica1         5.72M      -  43.6M  -
mypool@replica2             0      -  44.1M  -
<span class="c"># zpool list</span>
NAME    SIZE  ALLOC   FREE   CKPOINT  EXPANDSZ   FRAG   CAP  DEDUP  HEALTH  ALTROOT
backup  960M  61.7M   898M         -         -     0%    6%  1.00x  ONLINE  -
mypool  960M  50.2M   910M         -         -     0%    5%  1.00x  ONLINE  -</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create a second snapshot called <em>replica2</em>. This second snapshot contains changes made to the file system between now and the previous snapshot, <em>replica1</em>. Using <code>zfs send -i</code> and indicating the pair of snapshots generates an incremental replica stream containing the changed data. This succeeds if the initial snapshot already exists on the receiving side.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zfs send -v -i mypool@replica1 mypool@replica2 | zfs receive /backup/mypool</span>
send from @replica1 to mypool@replica2 estimated size is 5.02M
total estimated size is 5.02M
TIME        SENT   SNAPSHOT

<span class="c"># zpool list</span>
NAME    SIZE  ALLOC   FREE   CKPOINT  EXPANDSZ   FRAG  CAP  DEDUP  HEALTH  ALTROOT
backup  960M  80.8M   879M         -         -     0%   8%  1.00x  ONLINE  -
mypool  960M  50.2M   910M         -         -     0%   5%  1.00x  ONLINE  -

<span class="c"># zfs list</span>
NAME                         USED  AVAIL  REFER  MOUNTPOINT
backup                      55.4M   240G   152K  /backup
backup/mypool               55.3M   240G  55.2M  /backup/mypool
mypool                      55.6M  11.6G  55.0M  /mypool

<span class="c"># zfs list -t snapshot</span>
NAME                                         USED  AVAIL  REFER  MOUNTPOINT
backup/mypool@replica1                       104K      -  50.2M  -
backup/mypool@replica2                          0      -  55.2M  -
mypool@replica1                             29.9K      -  50.0M  -
mypool@replica2                                 0      -  55.0M  -</code></pre>
</div>
</div>
<div class="paragraph">
<p>The incremental stream replicated the changed data rather than the entirety of <em>replica1</em>. Sending the differences alone took much less time to transfer and saved disk space by not copying the whole pool each time. This is useful when replicating over a slow network or one charging per transferred byte.</p>
</div>
<div class="paragraph">
<p>A new file system, <em>backup/mypool</em>, is available with the files and data from the pool <em>mypool</em>. Specifying <code>-p</code> copies the dataset properties including compression settings, quotas, and mount points. Specifying <code>-R</code> copies all child datasets of the dataset along with their properties. Automate sending and receiving to create regular backups on the second pool.</p>
</div>
</div>
<div class="sect4">
<h5 id="zfs-send-ssh">22.4.7.2. Sending Encrypted Backups over SSH<a class="anchor" href="#zfs-send-ssh"></a></h5>
<div class="paragraph">
<p>Sending streams over the network is a good way to keep a remote backup, but it does come with a drawback. Data sent over the network link is not encrypted, allowing anyone to intercept and transform the streams back into data without the knowledge of the sending user. This is undesirable when sending the streams over the internet to a remote host. Use SSH to securely encrypt data sent over a network connection. Since ZFS requires redirecting the stream from standard output, piping it through SSH is easy. To keep the contents of the file system encrypted in transit and on the remote system, consider using <a href="https://wiki.freebsd.org/PEFS">PEFS</a>.</p>
</div>
<div class="paragraph">
<p>Change some settings and take security precautions first. This describes the necessary steps required for the <code>zfs send</code> operation; for more information on SSH, see <a href="./#openssh">OpenSSH</a>.</p>
</div>
<div class="paragraph">
<p>Change the configuration as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Passwordless SSH access between sending and receiving host using SSH keys</p>
</li>
<li>
<p>ZFS requires the privileges of the <code>root</code> user to send and receive streams. This requires logging in to the receiving system as <code>root</code>.</p>
</li>
<li>
<p>Security reasons prevent <code>root</code> from logging in by default.</p>
</li>
<li>
<p>Use the <a href="#zfs-zfs-allow">ZFS Delegation</a> system to allow a non-<code>root</code> user on each system to perform the respective send and receive operations. On the sending system:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zfs allow -u someuser send,snapshot mypool</span></code></pre>
</div>
</div>
</li>
<li>
<p>To mount the pool, the unprivileged user must own the directory, and regular users need permission to mount file systems.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>On the receiving system:</p>
</div>
<div class="paragraph">
<p>+</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysctl vfs.usermount=1</span>
vfs.usermount: 0 -&gt; 1
<span class="c"># echo vfs.usermount=1 &gt;&gt; /etc/sysctl.conf</span>
<span class="c"># zfs create recvpool/backup</span>
<span class="c"># zfs allow -u someuser create,mount,receive recvpool/backup</span>
<span class="c"># chown someuser /recvpool/backup</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The unprivileged user can receive and mount datasets now, and replicates the <em>home</em> dataset to the remote system:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>zfs snapshot -r mypool/home@monday
<span class="gp">% </span>zfs send -R mypool/home@monday | ssh someuser@backuphost zfs recv -dvu recvpool/backup</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create a recursive snapshot called <em>monday</em> of the file system dataset <em>home</em> on the pool <em>mypool</em>. Then <code>zfs send -R</code> includes the dataset, all child datasets, snapshots, clones, and settings in the stream. Pipe the output through SSH to the waiting <code>zfs receive</code> on the remote host <em>backuphost</em>. Using an IP address or fully qualified domain name is good practice. The receiving machine writes the data to the <em>backup</em> dataset on the <em>recvpool</em> pool. Adding <code>-d</code> to <code>zfs recv</code> overwrites the name of the pool on the receiving side with the name of the snapshot. <code>-u</code> causes the file systems to not mount on the receiving side. Using <code>-v</code> shows more details about the transfer, including the elapsed time and the amount of data transferred.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="zfs-zfs-quota">22.4.8. Dataset, User, and Group Quotas<a class="anchor" href="#zfs-zfs-quota"></a></h4>
<div class="paragraph">
<p>Use <a href="#zfs-term-quota">Dataset quotas</a> to restrict the amount of space consumed by a particular dataset. <a href="#zfs-term-refquota">Reference Quotas</a> work in much the same way, but count the space used by the dataset itself, excluding snapshots and child datasets. Similarly, use <a href="#zfs-term-userquota">user</a> and <a href="#zfs-term-groupquota">group</a> quotas to prevent users or groups from using up all the space in the pool or dataset.</p>
</div>
<div class="paragraph">
<p>The following examples assume that the users already exist in the system. Before adding a user to the system, make sure to create their home dataset first and set the <code>mountpoint</code> to <code>/home/<em>bob</em></code>. Then, create the user and make the home directory point to the dataset’s <code>mountpoint</code> location. This will properly set owner and group permissions without shadowing any pre-existing home directory paths that might exist.</p>
</div>
<div class="paragraph">
<p>To enforce a dataset quota of 10 GB for <span class="filename">storage/home/bob</span>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zfs set quota=10G storage/home/bob</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To enforce a reference quota of 10 GB for <span class="filename">storage/home/bob</span>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zfs set refquota=10G storage/home/bob</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To remove a quota of 10 GB for <span class="filename">storage/home/bob</span>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zfs set quota=none storage/home/bob</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The general format is <code>userquota@<em>user</em>=<em>size</em></code>, and the user’s name must be in one of these formats:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>POSIX compatible name such as <em>joe</em>.</p>
</li>
<li>
<p>POSIX numeric ID such as <em>789</em>.</p>
</li>
<li>
<p>SID name such as <em>joe.bloggs@example.com</em>.</p>
</li>
<li>
<p>SID numeric ID such as <em>S-1-123-456-789</em>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For example, to enforce a user quota of 50 GB for the user named <em>joe</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zfs set userquota@joe=50G</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To remove any quota:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zfs set userquota@joe=none</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>User quota properties are not displayed by <code>zfs get all</code>. Non-<code>root</code> users can’t see other’s quotas unless granted the <code>userquota</code> privilege. Users with this privilege are able to view and set everyone’s quota.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>The general format for setting a group quota is: <code>groupquota@<em>group</em>=<em>size</em></code>.</p>
</div>
<div class="paragraph">
<p>To set the quota for the group <em>firstgroup</em> to 50 GB, use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zfs set groupquota@firstgroup=50G</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To remove the quota for the group <em>firstgroup</em>, or to make sure that one is not set, instead use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zfs set groupquota@firstgroup=none</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As with the user quota property, non-<code>root</code> users can see the quotas associated with the groups to which they belong. A user with the <code>groupquota</code> privilege or <code>root</code> can view and set all quotas for all groups.</p>
</div>
<div class="paragraph">
<p>To display the amount of space used by each user on a file system or snapshot along with any quotas, use <code>zfs userspace</code>. For group information, use <code>zfs groupspace</code>. For more information about supported options or how to display specific options alone, refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=zfs&amp;sektion=1&amp;format=html">zfs(1)</a>.</p>
</div>
<div class="paragraph">
<p>Privileged users and <code>root</code> can list the quota for <span class="filename">storage/home/bob</span> using:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zfs get quota storage/home/bob</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="zfs-zfs-reservation">22.4.9. Reservations<a class="anchor" href="#zfs-zfs-reservation"></a></h4>
<div class="paragraph">
<p><a href="#zfs-term-reservation">Reservations</a> guarantee an always-available amount of space on a dataset. The reserved space will not be available to any other dataset. This useful feature ensures that free space is available for an important dataset or log files.</p>
</div>
<div class="paragraph">
<p>The general format of the <code>reservation</code> property is <code>reservation=<em>size</em></code>, so to set a reservation of 10 GB on <span class="filename">storage/home/bob</span>, use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zfs set reservation=10G storage/home/bob</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To clear any reservation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zfs set reservation=none storage/home/bob</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The same principle applies to the <code>refreservation</code> property for setting a <a href="#zfs-term-refreservation">Reference Reservation</a>, with the general format <code>refreservation=<em>size</em></code>.</p>
</div>
<div class="paragraph">
<p>This command shows any reservations or refreservations that exist on <span class="filename">storage/home/bob</span>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zfs get reservation storage/home/bob</span>
<span class="c"># zfs get refreservation storage/home/bob</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="zfs-zfs-compression">22.4.10. Compression<a class="anchor" href="#zfs-zfs-compression"></a></h4>
<div class="paragraph">
<p>ZFS provides transparent compression. Compressing data written at the block level saves space and also increases disk throughput. If data compresses by 25% the compressed data writes to the disk at the same rate as the uncompressed version, resulting in an effective write speed of 125%. Compression can also be a great alternative to <a href="#zfs-zfs-deduplication">Deduplication</a> because it does not require extra memory.</p>
</div>
<div class="paragraph">
<p>ZFS offers different compression algorithms, each with different trade-offs. The introduction of LZ4 compression in ZFS v5000 enables compressing the entire pool without the large performance trade-off of other algorithms. The biggest advantage to LZ4 is the <em>early abort</em> feature. If LZ4 does not achieve at least 12.5% compression in the header part of the data, ZFS writes the block uncompressed to avoid wasting CPU cycles trying to compress data that is either already compressed or uncompressible. For details about the different compression algorithms available in ZFS, see the <a href="#zfs-term-compression">Compression</a> entry in the terminology section.</p>
</div>
<div class="paragraph">
<p>The administrator can see the effectiveness of compression using dataset properties.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zfs get used,compressratio,compression,logicalused mypool/compressed_dataset</span>
NAME        PROPERTY          VALUE     SOURCE
mypool/compressed_dataset  used              449G      -
mypool/compressed_dataset  compressratio     1.11x     -
mypool/compressed_dataset  compression       lz4       <span class="nb">local
</span>mypool/compressed_dataset  logicalused       496G      -</code></pre>
</div>
</div>
<div class="paragraph">
<p>The dataset is using 449 GB of space (the used property). Without compression, it would have taken 496 GB of space (the <code>logicalused</code> property). This results in a 1.11:1 compression ratio.</p>
</div>
<div class="paragraph">
<p>Compression can have an unexpected side effect when combined with <a href="#zfs-term-userquota">User Quotas</a>. User quotas restrict how much actual space a user consumes on a dataset <em>after compression</em>. If a user has a quota of 10 GB, and writes 10 GB of compressible data, they will still be able to store more data. If they later update a file, say a database, with more or less compressible data, the amount of space available to them will change. This can result in the odd situation where a user did not increase the actual amount of data (the <code>logicalused</code> property), but the change in compression caused them to reach their quota limit.</p>
</div>
<div class="paragraph">
<p>Compression can have a similar unexpected interaction with backups. Quotas are often used to limit data storage to ensure there is enough backup space available. Since quotas do not consider compression ZFS may write more data than would fit with uncompressed backups.</p>
</div>
</div>
<div class="sect3">
<h4 id="zfs-zfs-compression-zstd">22.4.11. Zstandard Compression<a class="anchor" href="#zfs-zfs-compression-zstd"></a></h4>
<div class="paragraph">
<p>OpenZFS 2.0 added a new compression algorithm. Zstandard (Zstd) offers higher compression ratios than the default LZ4 while offering much greater speeds than the alternative, gzip. OpenZFS 2.0 is available starting with FreeBSD 12.1-RELEASE via <a class="package" href="https://cgit.freebsd.org/ports/tree/sysutils/openzfs/">sysutils/openzfs</a> and has been the default in since FreeBSD 13.0-RELEASE.</p>
</div>
<div class="paragraph">
<p>Zstd provides a large selection of compression levels, providing fine-grained control over performance versus compression ratio. One of the main advantages of Zstd is that the decompression speed is independent of the compression level. For data written once but read often, Zstd allows the use of the highest compression levels without a read performance penalty.</p>
</div>
<div class="paragraph">
<p>Even with frequent data updates, enabling compression often provides higher performance. One of the biggest advantages comes from the compressed ARC feature. ZFS’s Adaptive Replacement Cache (ARC) caches the compressed version of the data in RAM, decompressing it each time. This allows the same amount of RAM to store more data and metadata, increasing the cache hit ratio.</p>
</div>
<div class="paragraph">
<p>ZFS offers 19 levels of Zstd compression, each offering incrementally more space savings in exchange for slower compression. The default level is <code>zstd-3</code> and offers greater compression than LZ4 without being much slower. Levels above 10 require large amounts of memory to compress each block and systems with less than 16 GB of RAM should not use them. ZFS uses a selection of the Zstd_fast_ levels also, which get correspondingly faster but supports lower compression ratios. ZFS supports <code>zstd-fast-1</code> through <code>zstd-fast-10</code>, <code>zstd-fast-20</code> through <code>zstd-fast-100</code> in increments of 10, and <code>zstd-fast-500</code> and <code>zstd-fast-1000</code> which provide minimal compression, but offer high performance.</p>
</div>
<div class="paragraph">
<p>If ZFS is not able to get the required memory to compress a block with Zstd, it will fall back to storing the block uncompressed. This is unlikely to happen except at the highest levels of Zstd on memory constrained systems. ZFS counts how often this has occurred since loading the ZFS module with <code>kstat.zfs.misc.zstd.compress_alloc_fail</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="zfs-zfs-deduplication">22.4.12. Deduplication<a class="anchor" href="#zfs-zfs-deduplication"></a></h4>
<div class="paragraph">
<p>When enabled, <a href="#zfs-term-deduplication">deduplication</a> uses the checksum of each block to detect duplicate blocks. When a new block is a duplicate of an existing block, ZFS writes a new reference to the existing data instead of the whole duplicate block. Tremendous space savings are possible if the data contains a lot of duplicated files or repeated information. Warning: deduplication requires a large amount of memory, and enabling compression instead provides most of the space savings without the extra cost.</p>
</div>
<div class="paragraph">
<p>To activate deduplication, set the <code>dedup</code> property on the target pool:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zfs set dedup=on pool</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Deduplicating only affects new data written to the pool. Merely activating this option will not deduplicate data already written to the pool. A pool with a freshly activated deduplication property will look like this example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zpool list</span>
NAME  SIZE ALLOC  FREE   CKPOINT  EXPANDSZ   FRAG   CAP   DEDUP   HEALTH   ALTROOT
pool 2.84G 2.19M 2.83G         -         -     0%    0%   1.00x   ONLINE   -</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>DEDUP</code> column shows the actual rate of deduplication for the pool. A value of <code>1.00x</code> shows that data has not deduplicated yet. The next example copies some system binaries three times into different directories on the deduplicated pool created above.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># for d in dir1 dir2 dir3; do</span>
<span class="gp">&gt; </span>mkdir <span class="nv">$d</span> <span class="o">&amp;&amp;</span> cp -R /usr/bin <span class="nv">$d</span> &amp;
<span class="gp">&gt; </span><span class="k">done</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To observe deduplicating of redundant data, use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zpool list</span>
NAME SIZE  ALLOC  FREE   CKPOINT  EXPANDSZ   FRAG  CAP   DEDUP   HEALTH   ALTROOT
pool 2.84G 20.9M 2.82G         -         -     0%   0%   3.00x   ONLINE   -</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>DEDUP</code> column shows a factor of <code>3.00x</code>. Detecting and deduplicating copies of the data uses a third of the space. The potential for space savings can be enormous, but comes at the cost of having enough memory to keep track of the deduplicated blocks.</p>
</div>
<div class="paragraph">
<p>Deduplication is not always beneficial when the data in a pool is not redundant. ZFS can show potential space savings by simulating deduplication on an existing pool:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zdb -S pool</span>
Simulated DDT histogram:

bucket              allocated                       referenced
______   ______________________________   ______________________________
refcnt   blocks   LSIZE   PSIZE   DSIZE   blocks   LSIZE   PSIZE   DSIZE
------   ------   -----   -----   -----   ------   -----   -----   -----
     1    2.58M    289G    264G    264G    2.58M    289G    264G    264G
     2     206K   12.6G   10.4G   10.4G     430K   26.4G   21.6G   21.6G
     4    37.6K    692M    276M    276M     170K   3.04G   1.26G   1.26G
     8    2.18K   45.2M   19.4M   19.4M    20.0K    425M    176M    176M
    16      174   2.83M   1.20M   1.20M    3.33K   48.4M   20.4M   20.4M
    32       40   2.17M    222K    222K    1.70K   97.2M   9.91M   9.91M
    64        9     56K   10.5K   10.5K      865   4.96M    948K    948K
   128        2   9.50K      2K      2K      419   2.11M    438K    438K
   256        5   61.5K     12K     12K    1.90K   23.0M   4.47M   4.47M
    1K        2      1K      1K      1K    2.98K   1.49M   1.49M   1.49M
 Total    2.82M    303G    275G    275G    3.20M    319G    287G    287G

dedup <span class="o">=</span> 1.05, compress <span class="o">=</span> 1.11, copies <span class="o">=</span> 1.00, dedup <span class="k">*</span> compress / copies <span class="o">=</span> 1.16</code></pre>
</div>
</div>
<div class="paragraph">
<p>After <code>zdb -S</code> finishes analyzing the pool, it shows the space reduction ratio that activating deduplication would achieve. In this case, <code>1.16</code> is a poor space saving ratio mainly provided by compression. Activating deduplication on this pool would not save any amount of space, and is not worth the amount of memory required to enable deduplication. Using the formula <em>ratio = dedup * compress / copies</em>, system administrators can plan the storage allocation, deciding whether the workload will contain enough duplicate blocks to justify the memory requirements. If the data is reasonably compressible, the space savings may be good. Good practice is to enable compression first as compression also provides greatly increased performance. Enable deduplication in cases where savings are considerable and with enough available memory for the <a href="#zfs-term-deduplication">DDT</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="zfs-zfs-jail">22.4.13. ZFS and Jails<a class="anchor" href="#zfs-zfs-jail"></a></h4>
<div class="paragraph">
<p>Use <code>zfs jail</code> and the corresponding <code>jailed</code> property to delegate a ZFS dataset to a <a href="./#jails">Jail</a>. <code>zfs jail <em>jailid</em></code> attaches a dataset to the specified jail, and <code>zfs unjail</code> detaches it. To control the dataset from within a jail, set the <code>jailed</code> property. ZFS forbids mounting a jailed dataset on the host because it may have mount points that would compromise the security of the host.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="zfs-zfs-allow">22.5. Delegated Administration<a class="anchor" href="#zfs-zfs-allow"></a></h3>
<div class="paragraph">
<p>A comprehensive permission delegation system allows unprivileged users to perform ZFS administration functions. For example, if each user’s home directory is a dataset, users need permission to create and destroy snapshots of their home directories. A user performing backups can get permission to use replication features. ZFS allows a usage statistics script to run with access to only the space usage data for all users. Delegating the ability to delegate permissions is also possible. Permission delegation is possible for each subcommand and most properties.</p>
</div>
<div class="sect3">
<h4 id="zfs-zfs-allow-create">22.5.1. Delegating Dataset Creation<a class="anchor" href="#zfs-zfs-allow-create"></a></h4>
<div class="paragraph">
<p><code>zfs allow <em>someuser</em> create <em>mydataset</em></code> gives the specified user permission to create child datasets under the selected parent dataset. A caveat: creating a new dataset involves mounting it. That requires setting the FreeBSD <code>vfs.usermount</code> <a href="https://man.freebsd.org/cgi/man.cgi?query=sysctl&amp;sektion=8&amp;format=html">sysctl(8)</a> to <code>1</code> to allow non-root users to mount a file system. Another restriction aimed at preventing abuse: non-<code>root</code> users must own the mountpoint where mounting the file system.</p>
</div>
</div>
<div class="sect3">
<h4 id="zfs-zfs-allow-allow">22.5.2. Delegating Permission Delegation<a class="anchor" href="#zfs-zfs-allow-allow"></a></h4>
<div class="paragraph">
<p><code>zfs allow <em>someuser</em> allow <em>mydataset</em></code> gives the specified user the ability to assign any permission they have on the target dataset, or its children, to other users. If a user has the <code>snapshot</code> permission and the <code>allow</code> permission, that user can then grant the <code>snapshot</code> permission to other users.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="zfs-advanced">22.6. Advanced Topics<a class="anchor" href="#zfs-advanced"></a></h3>
<div class="sect3">
<h4 id="zfs-advanced-tuning">22.6.1. Tuning<a class="anchor" href="#zfs-advanced-tuning"></a></h4>
<div class="paragraph">
<p>Adjust tunables to make ZFS perform best for different workloads.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a id="zfs-advanced-tuning-arc_max"></a> <code><em>vfs.zfs.arc.max</em></code> starting with 13.x (<code>vfs.zfs.arc_max</code> for 12.x) - Upper size of the <a href="#zfs-term-arc">ARC</a>. The default is all RAM but 1 GB, or 5/8 of all RAM, whichever is more. Use a lower value if the system runs any other daemons or processes that may require memory. Adjust this value at runtime with <a href="https://man.freebsd.org/cgi/man.cgi?query=sysctl&amp;sektion=8&amp;format=html">sysctl(8)</a> and set it in <span class="filename">/boot/loader.conf</span> or <span class="filename">/etc/sysctl.conf</span>.</p>
</li>
<li>
<p><a id="zfs-advanced-tuning-arc_meta_limit"></a> <code><em>vfs.zfs.arc.meta_limit</em></code> starting with 13.x (<code>vfs.zfs.arc_meta_limit</code> for 12.x)` - Limit the amount of the <a href="#zfs-term-arc">ARC</a> used to store metadata. The default is one fourth of <code>vfs.zfs.arc.max</code>. Increasing this value will improve performance if the workload involves operations on a large number of files and directories, or frequent metadata operations, at the cost of less file data fitting in the <a href="#zfs-term-arc">ARC</a>. Adjust this value at runtime with <a href="https://man.freebsd.org/cgi/man.cgi?query=sysctl&amp;sektion=8&amp;format=html">sysctl(8)</a> in <span class="filename">/boot/loader.conf</span> or <span class="filename">/etc/sysctl.conf</span>.</p>
</li>
<li>
<p><a id="zfs-advanced-tuning-arc_min"></a> <code><em>vfs.zfs.arc.min</em></code> starting with 13.x (<code>vfs.zfs.arc_min</code> for 12.x) - Lower size of the <a href="#zfs-term-arc">ARC</a>. The default is one half of <code>vfs.zfs.arc.meta_limit</code>. Adjust this value to prevent other applications from pressuring out the entire <a href="#zfs-term-arc">ARC</a>. Adjust this value at runtime with <a href="https://man.freebsd.org/cgi/man.cgi?query=sysctl&amp;sektion=8&amp;format=html">sysctl(8)</a> and in <span class="filename">/boot/loader.conf</span> or <span class="filename">/etc/sysctl.conf</span>.</p>
</li>
<li>
<p><a id="zfs-advanced-tuning-vdev-cache-size"></a> <code><em>vfs.zfs.vdev.cache.size</em></code> - A preallocated amount of memory reserved as a cache for each device in the pool. The total amount of memory used will be this value multiplied by the number of devices. Set this value at boot time and in <span class="filename">/boot/loader.conf</span>.</p>
</li>
<li>
<p><a id="zfs-advanced-tuning-min-auto-ashift"></a> <code><em>vfs.zfs.min_auto_ashift</em></code> - Lower <code>ashift</code> (sector size) used automatically at pool creation time. The value is a power of two. The default value of <code>9</code> represents <code>2^9 = 512</code>, a sector size of 512 bytes. To avoid <em>write amplification</em> and get the best performance, set this value to the largest sector size used by a device in the pool.</p>
<div class="paragraph">
<p>Common drives have 4 KB sectors. Using the default <code>ashift</code> of <code>9</code> with these drives results in write amplification on these devices. Data contained in a single 4 KB write is instead written in eight 512-byte writes. ZFS tries to read the native sector size from all devices when creating a pool, but drives with 4 KB sectors report that their sectors are 512 bytes for compatibility. Setting <code>vfs.zfs.min_auto_ashift</code> to <code>12</code> (<code>2^12 = 4096</code>) before creating a pool forces ZFS to use 4 KB blocks for best performance on these drives.</p>
</div>
<div class="paragraph">
<p>Forcing 4 KB blocks is also useful on pools with planned disk upgrades. Future disks use 4 KB sectors, and <code>ashift</code> values cannot change after creating a pool.</p>
</div>
<div class="paragraph">
<p>In some specific cases, the smaller 512-byte block size might be preferable. When used with 512-byte disks for databases or as storage for virtual machines, less data transfers during small random reads. This can provide better performance when using a smaller ZFS record size.</p>
</div>
</li>
<li>
<p><a id="zfs-advanced-tuning-prefetch_disable"></a> <code><em>vfs.zfs.prefetch_disable</em></code> - Disable prefetch. A value of <code>0</code> enables and <code>1</code> disables it. The default is <code>0</code>, unless the system has less than 4 GB of RAM. Prefetch works by reading larger blocks than requested into the <a href="#zfs-term-arc">ARC</a> in hopes to soon need the data. If the workload has a large number of random reads, disabling prefetch may actually improve performance by reducing unnecessary reads. Adjust this value at any time with <a href="https://man.freebsd.org/cgi/man.cgi?query=sysctl&amp;sektion=8&amp;format=html">sysctl(8)</a>.</p>
</li>
<li>
<p><a id="zfs-advanced-tuning-vdev-trim_on_init"></a> <code><em>vfs.zfs.vdev.trim_on_init</em></code> - Control whether new devices added to the pool have the <code>TRIM</code> command run on them. This ensures the best performance and longevity for SSDs, but takes extra time. If the device has already been secure erased, disabling this setting will make the addition of the new device faster. Adjust this value at any time with <a href="https://man.freebsd.org/cgi/man.cgi?query=sysctl&amp;sektion=8&amp;format=html">sysctl(8)</a>.</p>
</li>
<li>
<p><a id="zfs-advanced-tuning-vdev-max_pending"></a> <code><em>vfs.zfs.vdev.max_pending</em></code> - Limit the number of pending I/O requests per device. A higher value will keep the device command queue full and may give higher throughput. A lower value will reduce latency. Adjust this value at any time with <a href="https://man.freebsd.org/cgi/man.cgi?query=sysctl&amp;sektion=8&amp;format=html">sysctl(8)</a>.</p>
</li>
<li>
<p><a id="zfs-advanced-tuning-top_maxinflight"></a> <code><em>vfs.zfs.top_maxinflight</em></code> - Upper number of outstanding I/Os per top-level <a href="#zfs-term-vdev">vdev</a>. Limits the depth of the command queue to prevent high latency. The limit is per top-level vdev, meaning the limit applies to each <a href="#zfs-term-vdev-mirror">mirror</a>, <a href="#zfs-term-vdev-raidz">RAID-Z</a>, or other vdev independently. Adjust this value at any time with <a href="https://man.freebsd.org/cgi/man.cgi?query=sysctl&amp;sektion=8&amp;format=html">sysctl(8)</a>.</p>
</li>
<li>
<p><a id="zfs-advanced-tuning-l2arc_write_max"></a> <code><em>vfs.zfs.l2arc_write_max</em></code> - Limit the amount of data written to the <a href="#zfs-term-l2arc">L2ARC</a> per second. This tunable extends the longevity of SSDs by limiting the amount of data written to the device. Adjust this value at any time with <a href="https://man.freebsd.org/cgi/man.cgi?query=sysctl&amp;sektion=8&amp;format=html">sysctl(8)</a>.</p>
</li>
<li>
<p><a id="zfs-advanced-tuning-l2arc_write_boost"></a> <code><em>vfs.zfs.l2arc_write_boost</em></code> - Adds the value of this tunable to <a href="#zfs-advanced-tuning-l2arc_write_max"><code>vfs.zfs.l2arc_write_max</code></a> and increases the write speed to the SSD until evicting the first block from the <a href="#zfs-term-l2arc">L2ARC</a>. This &#34;Turbo Warmup Phase&#34; reduces the performance loss from an empty <a href="#zfs-term-l2arc">L2ARC</a> after a reboot. Adjust this value at any time with <a href="https://man.freebsd.org/cgi/man.cgi?query=sysctl&amp;sektion=8&amp;format=html">sysctl(8)</a>.</p>
</li>
<li>
<p><a id="zfs-advanced-tuning-scrub_delay"></a><code><em>vfs.zfs.scrub_delay</em></code> - Number of ticks to delay between each I/O during a <a href="#zfs-term-scrub"><code>scrub</code></a>. To ensure that a <code>scrub</code> does not interfere with the normal operation of the pool, if any other I/O is happening the <code>scrub</code> will delay between each command. This value controls the limit on the total IOPS (I/Os Per Second) generated by the <code>scrub</code>. The granularity of the setting is determined by the value of <code>kern.hz</code> which defaults to 1000 ticks per second. Changing this setting results in a different effective IOPS limit. The default value is <code>4</code>, resulting in a limit of: 1000 ticks/sec / 4 = 250 IOPS. Using a value of <em>20</em> would give a limit of: 1000 ticks/sec / 20 = 50 IOPS. Recent activity on the pool limits the speed of <code>scrub</code>, as determined by <a href="#zfs-advanced-tuning-scan_idle"><code>vfs.zfs.scan_idle</code></a>. Adjust this value at any time with <a href="https://man.freebsd.org/cgi/man.cgi?query=sysctl&amp;sektion=8&amp;format=html">sysctl(8)</a>.</p>
</li>
<li>
<p><a id="zfs-advanced-tuning-resilver_delay"></a> <code><em>vfs.zfs.resilver_delay</em></code> - Number of milliseconds of delay inserted between each I/O during a <a href="#zfs-term-resilver">resilver</a>. To ensure that a resilver does not interfere with the normal operation of the pool, if any other I/O is happening the resilver will delay between each command. This value controls the limit of total IOPS (I/Os Per Second) generated by the resilver. ZFS determins the granularity of the setting by the value of <code>kern.hz</code> which defaults to 1000 ticks per second. Changing this setting results in a different effective IOPS limit. The default value is 2, resulting in a limit of: 1000 ticks/sec / 2 = 500 IOPS. Returning the pool to an <a href="#zfs-term-online">Online</a> state may be more important if another device failing could <a href="#zfs-term-faulted">Fault</a> the pool, causing data loss. A value of 0 will give the resilver operation the same priority as other operations, speeding the healing process. Other recent activity on the pool limits the speed of resilver, as determined by <a href="#zfs-advanced-tuning-scan_idle"><code>vfs.zfs.scan_idle</code></a>. Adjust this value at any time with <a href="https://man.freebsd.org/cgi/man.cgi?query=sysctl&amp;sektion=8&amp;format=html">sysctl(8)</a>.</p>
</li>
<li>
<p><a id="zfs-advanced-tuning-scan_idle"></a> <code><em>vfs.zfs.scan_idle</em></code> - Number of milliseconds since the last operation before considering the pool is idle. ZFS disables the rate limiting for <a href="#zfs-term-scrub"><code>scrub</code></a> and <a href="#zfs-term-resilver">resilver</a> when the pool is idle. Adjust this value at any time with <a href="https://man.freebsd.org/cgi/man.cgi?query=sysctl&amp;sektion=8&amp;format=html">sysctl(8)</a>.</p>
</li>
<li>
<p><a id="zfs-advanced-tuning-txg-timeout"></a> <code><em>vfs.zfs.txg.timeout</em></code> - Upper number of seconds between <a href="#zfs-term-txg">transaction group</a>s. The current transaction group writes to the pool and a fresh transaction group starts if this amount of time elapsed since the previous transaction group. A transaction group may trigger earlier if writing enough data. The default value is 5 seconds. A larger value may improve read performance by delaying asynchronous writes, but this may cause uneven performance when writing the transaction group. Adjust this value at any time with <a href="https://man.freebsd.org/cgi/man.cgi?query=sysctl&amp;sektion=8&amp;format=html">sysctl(8)</a>.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="zfs-advanced-i386">22.6.2. ZFS on i386<a class="anchor" href="#zfs-advanced-i386"></a></h4>
<div class="paragraph">
<p>Some of the features provided by ZFS are memory intensive, and may require tuning for upper efficiency on systems with limited RAM.</p>
</div>
<div class="sect4">
<h5 id="_memory">22.6.2.1. Memory<a class="anchor" href="#_memory"></a></h5>
<div class="paragraph">
<p>As a lower value, the total system memory should be at least one gigabyte. The amount of recommended RAM depends upon the size of the pool and which features ZFS uses. A general rule of thumb is 1 GB of RAM for every 1 TB of storage. If using the deduplication feature, a general rule of thumb is 5 GB of RAM per TB of storage to deduplicate. While some users use ZFS with less RAM, systems under heavy load may panic due to memory exhaustion. ZFS may require further tuning for systems with less than the recommended RAM requirements.</p>
</div>
</div>
<div class="sect4">
<h5 id="_kernel_configuration">22.6.2.2. Kernel Configuration<a class="anchor" href="#_kernel_configuration"></a></h5>
<div class="paragraph">
<p>Due to the address space limitations of the i386™ platform, ZFS users on the i386™ architecture must add this option to a custom kernel configuration file, rebuild the kernel, and reboot:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>options        KVA_PAGES=512</pre>
</div>
</div>
<div class="paragraph">
<p>This expands the kernel address space, allowing the <code>vm.kvm_size</code> tunable to push beyond the imposed limit of 1 GB, or the limit of 2 GB for PAE. To find the most suitable value for this option, divide the desired address space in megabytes by four. In this example <code>512</code> for 2 GB.</p>
</div>
</div>
<div class="sect4">
<h5 id="_loader_tunables">22.6.2.3. Loader Tunables<a class="anchor" href="#_loader_tunables"></a></h5>
<div class="paragraph">
<p>Increases the <span class="filename">kmem</span> address space on all FreeBSD architectures. A test system with 1 GB of physical memory benefitted from adding these options to <span class="filename">/boot/loader.conf</span> and then restarting:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>vm.kmem_size=&#34;330M&#34;
vm.kmem_size_max=&#34;330M&#34;
vfs.zfs.arc.max=&#34;40M&#34;
vfs.zfs.vdev.cache.size=&#34;5M&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>For a more detailed list of recommendations for ZFS-related tuning, see <a href="https://wiki.freebsd.org/ZFSTuningGuide" class="bare">https://wiki.freebsd.org/ZFSTuningGuide</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="zfs-links">22.7. Further Resources<a class="anchor" href="#zfs-links"></a></h3>
<div class="ulist">
<ul>
<li>
<p><a href="https://openzfs.org/">OpenZFS</a></p>
</li>
<li>
<p><a href="https://wiki.freebsd.org/ZFSTuningGuide">FreeBSD Wiki - ZFS Tuning</a></p>
</li>
<li>
<p><a href="https://calomel.org/zfs_raid_speed_capacity.html">Calomel Blog - ZFS Raidz Performance, Capacity and Integrity</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="zfs-term">22.8. ZFS Features and Terminology<a class="anchor" href="#zfs-term"></a></h3>
<div class="paragraph">
<p>More than a file system, ZFS is fundamentally different. ZFS combines the roles of file system and volume manager, enabling new storage devices to add to a live system and having the new space available on the existing file systems in that pool at once. By combining the traditionally separate roles, ZFS is able to overcome previous limitations that prevented RAID groups being able to grow. A <em>vdev</em> is a top level device in a pool and can be a simple disk or a RAID transformation such as a mirror or RAID-Z array. ZFS file systems (called <em>datasets</em>) each have access to the combined free space of the entire pool. Used blocks from the pool decrease the space available to each file system. This approach avoids the common pitfall with extensive partitioning where free space becomes fragmented across the partitions.</p>
</div>
<table class="tableblock frame-all grid-all stretch informaltable">
<colgroup>
<col style="width: 10%;"/>
<col style="width: 90%;"/>
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a id="zfs-term-pool"></a>pool</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A storage <em>pool</em> is the most basic building block of ZFS. A pool consists of one or more vdevs, the underlying devices that store the data. A pool is then used to create one or more file systems (datasets) or block devices (volumes).
These datasets and volumes share the pool of remaining free space. Each pool is uniquely identified by a name and a GUID. The ZFS version number on the pool determines the features available.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a id="zfs-term-vdev"></a>vdev Types</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>A pool consists of one or more vdevs, which themselves are a single disk or a group of disks, transformed to a RAID. When using a lot of vdevs, ZFS spreads data across the vdevs to increase performance and maximize usable space. All vdevs must be at least 128 MB in size.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a id="zfs-term-vdev-disk"></a> <em>Disk</em> - The most basic vdev type is a standard block device. This can be an entire disk (such as <span class="filename">/dev/ada0</span> or <span class="filename">/dev/da0</span>) or a partition (<span class="filename">/dev/ada0p3</span>). On FreeBSD, there is no performance penalty for using a partition rather than the entire disk. This differs from recommendations made by the Solaris documentation.</p>
<div class="admonitionblock caution">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Using an entire disk as part of a bootable pool is strongly discouraged, as this may render the pool unbootable.
Likewise, you should not use an entire disk as part of a mirror or RAID-Z vdev.
Reliably determining the size of an unpartitioned disk at boot time is impossible and there’s no place to put in boot code.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
</li>
<li>
<p><a id="zfs-term-vdev-file"></a> <em>File</em> - Regular files may make up ZFS pools, which is useful for testing and experimentation. Use the full path to the file as the device path in <code>zpool create</code>.</p>
</li>
<li>
<p><a id="zfs-term-vdev-mirror"></a> <em>Mirror</em> - When creating a mirror, specify the <code>mirror</code> keyword followed by the list of member devices for the mirror. A mirror consists of two or more devices, writing all data to all member devices. A mirror vdev will hold as much data as its smallest member. A mirror vdev can withstand the failure of all but one of its members without losing any data.</p>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>To upgrade a regular single disk vdev to a mirror vdev at any time, use <code>zpool <a href="#zfs-zpool-attach">attach</a></code>.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
</li>
<li>
<p><a id="zfs-term-vdev-raidz"></a> <em>RAID-Z</em> - ZFS uses RAID-Z, a variation on standard RAID-5 that offers better distribution of parity and eliminates the &#34;RAID-5 write hole&#34; in which the data and parity information become inconsistent after an unexpected restart. ZFS supports three levels of RAID-Z which provide varying levels of redundancy in exchange for decreasing levels of usable storage. ZFS uses RAID-Z1 through RAID-Z3 based on the number of parity devices in the array and the number of disks which can fail before the pool stops  being operational.</p>
<div class="paragraph">
<p>In a RAID-Z1 configuration with four disks, each 1 TB, usable storage is 3 TB and the pool will still be able to operate in degraded mode with one faulted disk. If another disk goes offline before replacing and resilvering the faulted disk would result in losing all pool data.</p>
</div>
<div class="paragraph">
<p>In a RAID-Z3 configuration with eight disks of 1 TB, the volume will provide 5 TB of usable space and still be able to operate with three faulted disks. Sun™ recommends no more than nine disks in a single vdev. If more disks make up the configuration, the recommendation is to divide them into separate vdevs and stripe the pool data across them.</p>
</div>
<div class="paragraph">
<p>A configuration of two RAID-Z2 vdevs consisting of 8 disks each would create something like a RAID-60 array. A RAID-Z group’s storage capacity is about the size of the smallest disk multiplied by the number of non-parity disks. Four 1 TB disks in RAID-Z1 has an effective size of about 3 TB, and an array of eight 1 TB disks in RAID-Z3 will yield 5 TB of usable space.</p>
</div>
</li>
<li>
<p><a id="zfs-term-vdev-spare"></a> <em>Spare</em> - ZFS has a special pseudo-vdev type for keeping track of available hot spares. Note that installed hot spares are not deployed automatically; manually configure them to replace the failed device using <code>zfs replace</code>.</p>
</li>
<li>
<p><a id="zfs-term-vdev-log"></a> <em>Log</em> - ZFS Log Devices, also known as ZFS Intent Log (<a href="#zfs-term-zil">ZIL</a>) move the intent log from the regular pool devices to a dedicated device, typically an SSD. Having a dedicated log device improves the performance of applications with a high volume of synchronous writes like databases. Mirroring of log devices is possible, but RAID-Z is not supported. If using a lot of log devices, writes will be load-balanced across them.</p>
</li>
<li>
<p><a id="zfs-term-vdev-cache"></a> <em>Cache</em> - Adding a cache vdev to a pool will add the storage of the cache to the <a href="#zfs-term-l2arc">L2ARC</a>. Mirroring cache devices is impossible. Since a cache device stores only new copies of existing data, there is no risk of data loss.</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a id="zfs-term-txg"></a> Transaction Group (TXG)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Transaction Groups are the way ZFS groups blocks changes together and writes them to the pool. Transaction groups are the atomic unit that ZFS uses to ensure consistency. ZFS assigns each transaction group a unique 64-bit consecutive identifier. There can be up to three active transaction groups at a time, one in each of these three states:</p>
<p class="tableblock">* <em>Open</em> - A new transaction group begins in the open state and accepts new writes. There is always a transaction group in the open state, but the transaction group may refuse new writes if it has reached a limit. Once the open transaction group has reached a limit, or reaching the <a href="#zfs-advanced-tuning-txg-timeout"><code>vfs.zfs.txg.timeout</code></a>, the transaction group advances to the next state.
* <em>Quiescing</em> - A short state that allows any pending operations to finish without blocking the creation of a new open transaction group. Once all the transactions in the group have completed, the transaction group advances to the final state.
* <em>Syncing</em> - Write all the data in the transaction group to stable storage. This process will in turn change other data, such as metadata and space maps, that ZFS will also write to stable storage. The process of syncing involves several passes. On the first and biggest, all the changed data blocks; next come the metadata, which may take several passes to complete. Since allocating space for the data blocks generates new metadata, the syncing state cannot finish until a pass completes that does not use any new space. The syncing state is also where <em>synctasks</em> complete. Synctasks are administrative operations such as creating or destroying snapshots and datasets that complete the uberblock change. Once the sync state completes the transaction group in the quiescing state advances to the syncing state. All administrative functions, such as <a href="#zfs-term-snapshot"><code>snapshot</code></a> write as part of the transaction group. ZFS adds a created synctask to the open transaction group, and that group advances as fast as possible to the syncing state to reduce the latency of administrative commands.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a id="zfs-term-arc"></a>Adaptive Replacement Cache (ARC)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ZFS uses an Adaptive Replacement Cache (ARC), rather than a more traditional Least Recently Used (LRU) cache. An LRU cache is a simple list of items in the cache, sorted by how recently object was used, adding new items to the head of the list. When the cache is full, evicting items from the tail of the list makes room for more active objects. An ARC consists of four lists; the Most Recently Used (MRU) and Most Frequently Used (MFU) objects, plus a ghost list for each. These ghost lists track evicted objects to prevent adding them back to the cache. This increases the cache hit ratio by avoiding objects that have a history of occasional use. Another advantage of using both an MRU and MFU is that scanning an entire file system would evict all data from an MRU or LRU cache in favor of this freshly accessed content. With ZFS, there is also an MFU that tracks the most frequently used objects, and the cache of the most commonly accessed blocks remains.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a id="zfs-term-l2arc"></a>L2ARC</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">L2ARC is the second level of the ZFS caching system. RAM stores the primary ARC. Since the amount of available RAM is often limited, ZFS can also use <a href="#zfs-term-vdev-cache">cache vdevs</a>. Solid State Disks (SSDs) are often used as these cache devices due to their higher speed and lower latency compared to traditional spinning disks. L2ARC is entirely optional, but having one will increase read speeds for cached files on the SSD instead of having to read from the regular disks. L2ARC can also speed up <a href="#zfs-term-deduplication">deduplication</a> because a deduplication table (DDT) that does not fit in RAM but does fit in the L2ARC will be much faster than a DDT that must read from disk. Limits on the data rate added to the cache devices prevents prematurely wearing out SSDs with extra writes. Until the cache is full (the first block evicted to make room), writes to the L2ARC limit to the sum of the write limit and the boost limit, and afterwards limit to the write limit. A pair of <a href="https://man.freebsd.org/cgi/man.cgi?query=sysctl&amp;sektion=8&amp;format=html">sysctl(8)</a> values control these rate limits. <a href="#zfs-advanced-tuning-l2arc_write_max"><code>vfs.zfs.l2arc_write_max</code></a> controls the number of bytes written to the cache per second, while <a href="#zfs-advanced-tuning-l2arc_write_boost"><code>vfs.zfs.l2arc_write_boost</code></a> adds to this limit during the &#34;Turbo Warmup Phase&#34; (Write Boost).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a id="zfs-term-zil"></a>ZIL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ZIL accelerates synchronous transactions by using storage devices like SSDs that are faster than those used in the main storage pool. When an application requests a synchronous write (a guarantee that the data is stored to disk rather than merely cached for later writes), writing the data to the faster ZIL storage then later flushing it out to the regular disks greatly reduces latency and improves performance. Synchronous workloads like databases will profit from a ZIL alone. Regular asynchronous writes such as copying files will not use the ZIL at all.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a id="zfs-term-cow"></a>Copy-On-Write</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unlike a traditional file system, ZFS writes a different block rather than overwriting the old data in place. When completing this write the metadata updates to point to the new location. When a shorn write (a system crash or power loss in the middle of writing a file) occurs, the entire original contents of the file are still available and ZFS discards the incomplete write. This also means that ZFS does not require a <a href="https://man.freebsd.org/cgi/man.cgi?query=fsck&amp;sektion=8&amp;format=html">fsck(8)</a> after an unexpected shutdown.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a id="zfs-term-dataset"></a>Dataset</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Dataset</em> is the generic term for a ZFS file system, volume, snapshot or clone. Each dataset has a unique name in the format <em>poolname/path@snapshot</em>. The root of the pool is a dataset as well. Child datasets have hierarchical names like directories. For example, <em>mypool/home</em>, the home dataset, is a child of <em>mypool</em> and inherits properties from it. Expand this further by creating <em>mypool/home/user</em>. This grandchild dataset will inherit properties from the parent and grandparent. Set properties on a child to override the defaults inherited from the parent and grandparent. Administration of datasets and their children can be <a href="#zfs-zfs-allow">delegated</a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a id="zfs-term-filesystem"></a>File system</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A ZFS dataset is most often used as a file system. Like most other file systems, a ZFS file system mounts somewhere in the systems directory hierarchy and contains files and directories of its own with permissions, flags, and other metadata.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a id="zfs-term-volume"></a>Volume</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ZFS can also create volumes, which appear as disk devices. Volumes have a lot of the same features as datasets, including copy-on-write, snapshots, clones, and checksumming. Volumes can be useful for running other file system formats on top of ZFS, such as UFS virtualization, or exporting iSCSI extents.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a id="zfs-term-snapshot"></a>Snapshot</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The <a href="#zfs-term-cow">copy-on-write</a> (COW) design of ZFS allows for nearly instantaneous, consistent snapshots with arbitrary names. After taking a snapshot of a dataset, or a recursive snapshot of a parent dataset that will include all child datasets, new data goes to new blocks, but without reclaiming the old blocks as free space. The snapshot contains the original file system version and the live file system contains any changes made since taking the snapshot using no other space. New data written to the live file system uses new blocks to store this data. The snapshot will grow as the blocks are no longer used in the live file system, but in the snapshot alone. Mount these snapshots read-only allows recovering of previous file versions. A <a href="#zfs-zfs-snapshot">rollback</a> of a live file system to a specific snapshot is possible, undoing any changes that took place after taking the snapshot. Each block in the pool has a reference counter which keeps track of the snapshots, clones, datasets, or volumes use that block. As files and snapshots get deleted, the reference count  decreases, reclaiming the free space when no longer referencing a block. Marking snapshots with a <a href="#zfs-zfs-snapshot">hold</a> results in any attempt to destroy it will  returns an <code>EBUSY</code> error. Each snapshot can have holds with a unique name each. The <a href="#zfs-zfs-snapshot">release</a> command removes the hold so the snapshot can deleted. Snapshots, cloning, and rolling back works on volumes, but independently mounting does not.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a id="zfs-term-clone"></a>Clone</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cloning a snapshot is also possible. A clone is a writable version of a snapshot, allowing the file system to fork as a new dataset. As with a snapshot, a clone initially consumes no new space. As new data written to a clone uses new blocks, the size of the clone grows. When blocks are overwritten in the cloned file system or volume, the reference count on the previous block decreases. Removing the snapshot upon which a clone bases is impossible because the clone depends on it. The snapshot is the parent, and the clone is the child. Clones can be <em>promoted</em>, reversing this dependency and making the clone the parent and the previous parent the child. This operation requires no new space. Since the amount of space used by the parent and child reverses, it may affect existing quotas and reservations.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a id="zfs-term-checksum"></a>Checksum</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Every block is also checksummed. The checksum algorithm used is a per-dataset property, see <a href="#zfs-zfs-set"><code>set</code></a>. The checksum of each block is transparently validated when read, allowing ZFS to detect silent corruption. If the data read does not match the expected checksum, ZFS will attempt to recover the data from any available redundancy, like mirrors or RAID-Z. Triggering a validation of all checksums with <a href="#zfs-term-scrub"><code>scrub</code></a>. Checksum algorithms include:</p>
<p class="tableblock">* <code>fletcher2</code>
* <code>fletcher4</code>
* <code>sha256</code>
 The <code>fletcher</code> algorithms are faster, but <code>sha256</code> is a strong cryptographic hash and has a much lower chance of collisions at the  cost of some performance. Deactivating checksums is possible, but  strongly discouraged.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a id="zfs-term-compression"></a>Compression</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Each dataset has a compression property, which defaults to off. Set this property to an available compression algorithm. This causes compression of all new data written to the dataset. Beyond a reduction in space used, read and write throughput often increases because fewer blocks need reading or writing.</p>
<p class="tableblock"><a id="zfs-term-compression-lz4"></a>
* <em>LZ4</em> - Added in ZFS pool version 5000 (feature flags), LZ4 is now the recommended compression algorithm. LZ4 works about 50% faster than LZJB when operating on compressible data, and is over three times faster when operating on uncompressible data. LZ4 also decompresses about 80% faster than LZJB. On modern CPUs, LZ4 can often compress at over 500 MB/s, and decompress at over 1.5 GB/s (per single CPU core).</p>
<p class="tableblock"><a id="zfs-term-compression-lzjb"></a>
* <em>LZJB</em> - The default compression algorithm. Created by Jeff Bonwick (one of the original creators of ZFS). LZJB offers good compression with less CPU overhead compared to GZIP. In the future, the default compression algorithm will change to LZ4.</p>
<p class="tableblock"><a id="zfs-term-compression-gzip"></a>
* <em>GZIP</em> - A popular stream compression algorithm available in ZFS. One of the main advantages of using GZIP is its configurable level of compression. When setting the <code>compress</code> property, the administrator can choose the level of compression, ranging from <code>gzip1</code>, the lowest level of compression, to <code>gzip9</code>, the highest level of compression. This gives the administrator control over how much CPU time to trade for saved disk space.</p>
<p class="tableblock"><a id="zfs-term-compression-zle"></a>
* <em>ZLE</em> - Zero Length Encoding is a special compression algorithm that compresses continuous runs of zeros alone. This compression algorithm is useful when the dataset contains large blocks of zeros.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a id="zfs-term-copies"></a>Copies</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">When set to a value greater than 1, the <code>copies</code> property instructs ZFS to maintain copies of each block in the <a href="#zfs-term-filesystem">file system</a> or <a href="#zfs-term-volume">volume</a>. Setting this property on important datasets provides added redundancy from which to recover a block that does not match its checksum. In pools without redundancy, the copies feature is the single form of redundancy. The copies feature can recover from a single bad sector or other forms of minor corruption, but it does not protect the pool from the loss of an entire disk.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a id="zfs-term-deduplication"></a>Deduplication</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Checksums make it possible to detect duplicate blocks when writing data. With deduplication, the reference count of an existing, identical block increases, saving storage space. ZFS keeps a deduplication table (DDT) in memory to detect duplicate blocks. The table contains a list of unique checksums, the location of those blocks, and a reference count. When writing new data, ZFS calculates checksums and compares them to the list. When finding a match it uses the existing block. Using the SHA256 checksum algorithm with deduplication provides a secure cryptographic hash. Deduplication is tunable. If <code>dedup</code> is <code>on</code>, then a matching checksum means that the data is identical. Setting <code>dedup</code> to <code>verify</code>, ZFS performs a byte-for-byte check on the data ensuring they are actually identical. If the data is not identical, ZFS will note the hash collision and store the two blocks separately. As the DDT must store the hash of each unique block, it consumes a large amount of memory. A general rule of thumb is 5-6 GB of ram per 1 TB of deduplicated data). In situations not practical to have enough RAM to keep the entire DDT in memory, performance will suffer greatly as the DDT must read from disk before writing each new block. Deduplication can use L2ARC to store the DDT, providing a middle ground between fast system memory and slower disks. Consider using compression instead, which often provides nearly as much space savings without the increased memory.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a id="zfs-term-scrub"></a>Scrub</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Instead of a consistency check like <a href="https://man.freebsd.org/cgi/man.cgi?query=fsck&amp;sektion=8&amp;format=html">fsck(8)</a>, ZFS has <code>scrub</code>. <code>scrub</code> reads all data blocks stored on the pool and verifies their checksums against the known good checksums stored in the metadata. A periodic check of all the data stored on the pool ensures the recovery of any corrupted blocks before needing them. A scrub is not required after an unclean shutdown, but good practice is at least once every three months. ZFS verifies the checksum of each block during normal use, but a scrub makes certain to check even infrequently used blocks for silent corruption. ZFS improves data security in archival storage situations. Adjust the relative priority of <code>scrub</code> with <a href="#zfs-advanced-tuning-scrub_delay"><code>vfs.zfs.scrub_delay</code></a> to prevent the scrub from degrading the performance of other workloads on the pool.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a id="zfs-term-quota"></a>Dataset Quota</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ZFS provides fast and accurate dataset, user, and group space accounting as well as quotas and space reservations. This gives the administrator fine grained control over space allocation and allows reserving space for critical file systems.</p>
<p class="tableblock">ZFS supports different types of quotas: the dataset quota, the <a href="#zfs-term-refquota">reference quota (refquota)</a>, the <a href="#zfs-term-userquota">user quota</a>, and the <a href="#zfs-term-groupquota">group quota</a>.</p>
<p class="tableblock">Quotas limit the total size of a dataset and its descendants, including snapshots of the dataset, child datasets, and the snapshots of those datasets.</p>
<p class="tableblock">[NOTE]
====
Volumes do not support quotas, as the <code>volsize</code> property acts as an implicit quota.
====</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a id="zfs-term-refquota"></a>Reference Quota</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A reference quota limits the amount of space a dataset can consume by enforcing a hard limit. This hard limit includes space referenced by the dataset alone and does not include space used by descendants, such as file systems or snapshots.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a id="zfs-term-userquota"></a>User Quota</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">User quotas are useful to limit the amount of space used by the specified user.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a id="zfs-term-groupquota"></a>Group Quota</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The group quota limits the amount of space that a specified group can consume.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a id="zfs-term-reservation"></a>Dataset Reservation</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The <code>reservation</code> property makes it possible to guarantee an amount of space for a specific dataset and its descendants. This means that setting a 10 GB reservation on <span class="filename">storage/home/bob</span> prevents other datasets from using up all free space, reserving at least 10 GB of space for this dataset. Unlike a regular <a href="#zfs-term-refreservation"><code>refreservation</code></a>, space used by snapshots and descendants is not counted against the reservation. For example, if taking a snapshot of <span class="filename">storage/home/bob</span>, enough disk space other than the <code>refreservation</code> amount must exist for the operation to succeed. Descendants of the main data set are not counted in the <code>refreservation</code> amount and so do not encroach on the space set.</p>
<p class="tableblock">Reservations of any sort are useful in situations such as planning and testing the suitability of disk space allocation in a new system, or ensuring that enough space is available on file systems for audio logs or system recovery procedures and files.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a id="zfs-term-refreservation"></a>Reference Reservation</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The <code>refreservation</code> property makes it possible to guarantee an amount of space for the use of a specific dataset <em>excluding</em> its descendants. This means that setting a 10 GB reservation on <span class="filename">storage/home/bob</span>, and another dataset tries to use the free space, reserving at least 10 GB of space  for this dataset. In contrast to a regular <a href="#zfs-term-reservation">reservation</a>, space used by snapshots and descendant datasets is not counted against the reservation. For example, if taking a snapshot of <span class="filename">storage/home/bob</span>, enough disk space other than the <code>refreservation</code> amount must exist for the operation to succeed. Descendants of the  main data set are not counted in the <code>refreservation</code> amount and so do not encroach on the space set.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a id="zfs-term-resilver"></a>Resilver</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">When replacing a failed disk, ZFS must fill the new disk with the lost data. <em>Resilvering</em> is the process of using the parity information distributed across the remaining drives to calculate and write the missing data to the new drive.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a id="zfs-term-online"></a>Online</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A pool or vdev in the <code>Online</code> state has its member devices connected and fully operational. Individual devices in the <code>Online</code> state are functioning.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a id="zfs-term-offline"></a>Offline</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The administrator puts individual devices in an <code>Offline</code> state if enough redundancy exists to avoid putting the pool or vdev into a <a href="#zfs-term-faulted">Faulted</a> state. An administrator may choose to offline a disk in preparation for replacing it, or to make it easier to identify.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a id="zfs-term-degraded"></a>Degraded</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A pool or vdev in the <code>Degraded</code> state has one or more disks that disappeared or failed. The pool is still usable, but if other devices fail, the pool may become unrecoverable. Reconnecting the missing devices or replacing the failed disks will return the pool to an <a href="#zfs-term-online">Online</a> state after the reconnected or new device has completed the <a href="#zfs-term-resilver">Resilver</a> process.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a id="zfs-term-faulted"></a>Faulted</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A pool or vdev in the <code>Faulted</code> state is no longer operational. Accessing the data is no longer possible. A pool or vdev enters the <code>Faulted</code> state when the number of missing or failed devices exceeds the level of redundancy in the vdev. If reconnecting missing devices the pool will return to an <a href="#zfs-term-online">Online</a> state. Insufficient redundancy to compensate for the number of failed disks loses the pool contents and requires restoring from backups.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="filesystems">Chapter 23. Other File Systems<a class="anchor" href="#filesystems"></a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="filesystems-synopsis">23.1. Synopsis<a class="anchor" href="#filesystems-synopsis"></a></h3>
<div class="paragraph">
<p>File systems are an integral part of any operating system. They allow users to upload and store files, provide access to data, and make hard drives useful. Different operating systems differ in their native file system. Traditionally, the native FreeBSD file system has been the Unix File System UFS which has been modernized as UFS2. Since FreeBSD 7.0, the Z File System (ZFS) is also available as a native file system. See <a href="./#zfs">The Z File System (ZFS)</a> for more information.</p>
</div>
<div class="paragraph">
<p>In addition to its native file systems, FreeBSD supports a multitude of other file systems so that data from other operating systems can be accessed locally, such as data stored on locally attached USB storage devices, flash drives, and hard disks. This includes support for the Linux® Extended File System (EXT).</p>
</div>
<div class="paragraph">
<p>There are different levels of FreeBSD support for the various file systems. Some require a kernel module to be loaded and others may require a toolset to be installed. Some non-native file system support is full read-write while others are read-only.</p>
</div>
<div class="paragraph">
<p>After reading this chapter, you will know:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The difference between native and supported file systems.</p>
</li>
<li>
<p>Which file systems are supported by FreeBSD.</p>
</li>
<li>
<p>How to enable, configure, access, and make use of non-native file systems.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Before reading this chapter, you should:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Understand UNIX® and <a href="./#basics">FreeBSD basics</a>.</p>
</li>
<li>
<p>Be familiar with the basics of <a href="./#kernelconfig">kernel configuration and compilation</a>.</p>
</li>
<li>
<p>Feel comfortable <a href="./#ports">installing software</a> in FreeBSD.</p>
</li>
<li>
<p>Have some familiarity with <a href="./#disks">disks</a>, storage, and device names in FreeBSD.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="filesystems-linux">23.2. Linux® File Systems<a class="anchor" href="#filesystems-linux"></a></h3>
<div class="paragraph">
<p>FreeBSD provides built-in support for several Linux® file systems. This section demonstrates how to load support for and how to mount the supported Linux® file systems.</p>
</div>
<div class="sect3">
<h4 id="_ext2_ext3_ext4">23.2.1. ext2 / ext3 / ext4<a class="anchor" href="#_ext2_ext3_ext4"></a></h4>
<div class="paragraph">
<p>Kernel support for ext2 file systems has been available since FreeBSD 2.2. The <a href="https://man.freebsd.org/cgi/man.cgi?query=ext2fs&amp;sektion=5&amp;format=html">ext2fs(5)</a> driver allows the FreeBSD kernel to both read and write to ext2, ext3, and ext4 file systems.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Journalling and encryption are not supported yet.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>To access an ext file system, mount the ext volume by specifying its FreeBSD partition name and an existing mount point. This example mounts <span class="filename">/dev/ada1s1</span> on <span class="filename">/mnt</span>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># mount -t ext2fs /dev/ada1s1 /mnt</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="virtualization">Chapter 24. Virtualization<a class="anchor" href="#virtualization"></a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="virtualization-synopsis">24.1. Synopsis<a class="anchor" href="#virtualization-synopsis"></a></h3>
<div class="paragraph">
<p>Virtualization software allows multiple operating systems to run simultaneously on the same computer. Such software systems for PCs often involve a host operating system which runs the virtualization software and supports any number of guest operating systems.</p>
</div>
<div class="paragraph">
<p>After reading this chapter, you will know:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The difference between a host operating system and a guest operating system.</p>
</li>
<li>
<p>How to install FreeBSD on the following virtualization platforms:</p>
<div class="ulist">
<ul>
<li>
<p>Parallels Desktop(Apple® macOS®)</p>
</li>
<li>
<p>VMware Fusion(Apple® macOS®)</p>
</li>
<li>
<p>VirtualBox™(Microsoft® Windows®, Intel®-based Apple® macOS®, Linux)</p>
</li>
<li>
<p>bhyve(FreeBSD)</p>
</li>
</ul>
</div>
</li>
<li>
<p>How to tune a FreeBSD system for best performance under virtualization.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Before reading this chapter, you should:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Understand the <a href="./#basics">basics of UNIX® and FreeBSD</a>.</p>
</li>
<li>
<p>Know how to <a href="./#bsdinstall">install FreeBSD</a>.</p>
</li>
<li>
<p>Know how to <a href="./#advanced-networking">set up a network connection</a>.</p>
</li>
<li>
<p>Know how to <a href="./#ports">install additional third-party software</a>.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="virtualization-guest-parallelsdesktop">24.2. FreeBSD as a Guest on Parallels Desktop for macOS®<a class="anchor" href="#virtualization-guest-parallelsdesktop"></a></h3>
<div class="paragraph">
<p>Parallels Desktop for Mac® is a commercial software product available for Apple® Mac® computers running macOS® 10.14.6 or higher. FreeBSD is a fully supported guest operating system. Once Parallels has been installed on macOS®, the user must configure a virtual machine and then install the desired guest operating system.</p>
</div>
<div class="sect3">
<h4 id="virtualization-guest-parallelsdesktop-install">24.2.1. Installing FreeBSD on Parallels Desktop on Mac®<a class="anchor" href="#virtualization-guest-parallelsdesktop-install"></a></h4>
<div class="paragraph">
<p>The first step in installing FreeBSD on Parallels is to create a new virtual machine for installing FreeBSD.</p>
</div>
<div class="paragraph">
<p>Choose <b class="menuref">Install Windows or another OS from a DVD or image file</b> and proceed.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/virtualization/parallels-freebsd1.png" alt="Parallels setup wizard showing Install Windows or another OS from a DVD or image file chosen"/>
</div>
</div>
<div class="paragraph">
<p>Select the FreeBSD image file.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/virtualization/parallels-freebsd2.png" alt="Parallels setup wizard showing FreeBSD image file selected"/>
</div>
</div>
<div class="paragraph">
<p>Choose <b class="menuref">Other as operating system</b>.</p>
</div>
<div class="admonitionblock warning">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Choosing FreeBSD will cause boot error on startup.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/virtualization/parallels-freebsd3.png" alt="Parallels setup wizard showing Other selected as operating system"/>
</div>
</div>
<div class="paragraph">
<p>Name the virtual machine and check <b class="menuref">Customize settings before installation</b></p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/virtualization/parallels-freebsd4.png" alt="Parallels setup wizard showing the checkbox checked for customizing settings before installation"/>
</div>
</div>
<div class="paragraph">
<p>When the configuration window pops up, go to <b class="menuref">Hardware</b> tab, choose <b class="menuref">Boot order</b>, and click <b class="menuref">Advanced</b>. Then, choose <strong>EFI 64-bit</strong> as <b class="menuref">BIOS</b>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/virtualization/parallels-freebsd5.png" alt="Parallels setup wizard showing EFI 64-bit chosen as BIOS"/>
</div>
</div>
<div class="paragraph">
<p>Click <b class="menuref">OK</b>, close the configuration window, and click <b class="menuref">Continue</b>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/virtualization/parallels-freebsd6.png" alt="Parallels setup wizard showing the summary of the new virtual machine"/>
</div>
</div>
<div class="paragraph">
<p>The virtual machine will automatically boot. Install FreeBSD following the general steps.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/virtualization/parallels-freebsd7.png" alt="FreeBSD booted on Parallels"/>
</div>
</div>
</div>
<div class="sect3">
<h4 id="virtualization-guest-parallels-configure">24.2.2. Configuring FreeBSD on Parallels<a class="anchor" href="#virtualization-guest-parallels-configure"></a></h4>
<div class="paragraph">
<p>After FreeBSD has been successfully installed on macOS® X with Parallels, there are a number of configuration steps that can be taken to optimize the system for virtualized operation.</p>
</div>
<div class="olist arabic procedure">
<ol class="arabic">
<li>
<p>Set Boot Loader Variables</p>
<div class="paragraph">
<p>The most important step is to reduce the <code>kern.hz</code> tunable to reduce the CPU utilization of FreeBSD under the Parallels environment. This is accomplished by adding the following line to <span class="filename">/boot/loader.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>kern.hz=100</pre>
</div>
</div>
<div class="paragraph">
<p>Without this setting, an idle FreeBSD Parallels guest will use roughly 15% of the CPU of a single processor iMac®. After this change the usage will be closer to 5%.</p>
</div>
</li>
<li>
<p>Create a New Kernel Configuration File</p>
<div class="paragraph">
<p>All of the SCSI, FireWire, and USB device drivers can be removed from a custom kernel configuration file. Parallels provides a virtual network adapter used by the <a href="https://man.freebsd.org/cgi/man.cgi?query=ed&amp;sektion=4&amp;format=html">ed(4)</a> driver, so all network devices except for <a href="https://man.freebsd.org/cgi/man.cgi?query=ed&amp;sektion=4&amp;format=html">ed(4)</a> and <a href="https://man.freebsd.org/cgi/man.cgi?query=miibus&amp;sektion=4&amp;format=html">miibus(4)</a> can be removed from the kernel.</p>
</div>
</li>
<li>
<p>Configure Networking</p>
<div class="paragraph">
<p>The most basic networking setup uses DHCP to connect the virtual machine to the same local area network as the host Mac®. This can be accomplished by adding <code>ifconfig_ed0=&#34;DHCP&#34;</code> to <span class="filename">/etc/rc.conf</span>. More advanced networking setups are described in <a href="./#advanced-networking">Advanced Networking</a>.</p>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="virtualization-guest-vmware">24.3. FreeBSD as a Guest on VMware Fusion for macOS®<a class="anchor" href="#virtualization-guest-vmware"></a></h3>
<div class="paragraph">
<p>VMware Fusion for Mac® is a commercial software product available for Apple® Mac® computers running macOS® 12 or higher. FreeBSD is a fully supported guest operating system. Once VMware Fusion has been installed on macOS®, the user can configure a virtual machine and then install the desired guest operating system.</p>
</div>
<div class="sect3">
<h4 id="virtualization-guest-vmware-install">24.3.1. Installing FreeBSD on VMware Fusion<a class="anchor" href="#virtualization-guest-vmware-install"></a></h4>
<div class="paragraph">
<p>The first step is to start VMware Fusion which will load the Virtual Machine Library. Click <span class="guimenuitem">+→New</span> to create the virtual machine:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/virtualization/vmware-freebsd01.png" alt="vmware freebsd01"/>
</div>
</div>
<div class="paragraph">
<p>This will load the New Virtual Machine Assistant. Choose <span class="guimenuitem">Create a custom virtual machine</span> and click <span class="guimenuitem">Continue</span> to proceed:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/virtualization/vmware-freebsd02.png" alt="vmware freebsd02"/>
</div>
</div>
<div class="paragraph">
<p>Select <span class="guimenuitem">Other</span> as the <span class="guimenuitem">Operating System</span> and either <span class="guimenuitem">FreeBSD X</span> or <span class="guimenuitem">FreeBSD X 64-bit</span>, as the <b class="menuref">Version</b> when prompted:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/virtualization/vmware-freebsd03.png" alt="vmware freebsd03"/>
</div>
</div>
<div class="paragraph">
<p>Choose the firmware(UEFI is recommended):</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/virtualization/vmware-freebsd04.png" alt="vmware freebsd04"/>
</div>
</div>
<div class="paragraph">
<p>Choose <span class="guimenuitem">Create a new virtual disk</span> and click <span class="guimenuitem">Continue</span>:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/virtualization/vmware-freebsd05.png" alt="vmware freebsd05"/>
</div>
</div>
<div class="paragraph">
<p>Check the configuration and click <span class="guimenuitem">Finish</span>:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/virtualization/vmware-freebsd06.png" alt="vmware freebsd06"/>
</div>
</div>
<div class="paragraph">
<p>Choose the name of the virtual machine and the directory where it should be saved:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/virtualization/vmware-freebsd07.png" alt="vmware freebsd07"/>
</div>
</div>
<div class="paragraph">
<p>Press command+E to open virtual machine settings and click <span class="guimenuitem">CD/DVD</span>:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/virtualization/vmware-freebsd08.png" alt="vmware freebsd08"/>
</div>
</div>
<div class="paragraph">
<p>Choose FreeBSD ISO image or from a CD/DVD:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/virtualization/vmware-freebsd09.png" alt="vmware freebsd09"/>
</div>
</div>
<div class="paragraph">
<p>Start the virtual machine:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/virtualization/vmware-freebsd10.png" alt="vmware freebsd10"/>
</div>
</div>
<div class="paragraph">
<p>Install FreeBSD as usual:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/virtualization/vmware-freebsd11.png" alt="vmware freebsd11"/>
</div>
</div>
<div class="paragraph">
<p>Once the install is complete, the settings of the virtual machine can be modified, such as memory usage and the number of CPUs the virtual machine will have access to:</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The System Hardware settings of the virtual machine cannot be modified while the virtual machine is running.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/virtualization/vmware-freebsd12.png" alt="vmware freebsd12"/>
</div>
</div>
<div class="paragraph">
<p>The status of the CD-ROM device. Normally the CD/DVD/ISO is disconnected from the virtual machine when it is no longer needed.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/virtualization/vmware-freebsd09.png" alt="vmware freebsd09"/>
</div>
</div>
<div class="paragraph">
<p>The last thing to change is how the virtual machine will connect to the network. To allow connections to the virtual machine from other machines besides the host, choose <span class="guimenuitem">Connect directly to the physical network (Bridged)</span>. Otherwise, <span class="guimenuitem">Share the host’s internet connection (NAT)</span> is preferred so that the virtual machine can have access to the Internet, but the network cannot access the virtual machine.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/virtualization/vmware-freebsd13.png" alt="vmware freebsd13"/>
</div>
</div>
<div class="paragraph">
<p>After modifying the settings, boot the newly installed FreeBSD virtual machine.</p>
</div>
</div>
<div class="sect3">
<h4 id="virtualization-guest-vmware-configure">24.3.2. Configuring FreeBSD on VMware Fusion<a class="anchor" href="#virtualization-guest-vmware-configure"></a></h4>
<div class="paragraph">
<p>After FreeBSD has been successfully installed on macOS® X with VMware Fusion, there are a number of configuration steps that can be taken to optimize the system for virtualized operation.</p>
</div>
<div class="olist arabic procedure">
<ol class="arabic">
<li>
<p>Set Boot Loader Variables</p>
<div class="paragraph">
<p>The most important step is to reduce the <code>kern.hz</code> tunable to reduce the CPU utilization of FreeBSD under the VMware Fusion environment. This is accomplished by adding the following line to <span class="filename">/boot/loader.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>kern.hz=100</pre>
</div>
</div>
<div class="paragraph">
<p>Without this setting, an idle FreeBSD VMware Fusion guest will use roughly 15% of the CPU of a single processor iMac®. After this change, the usage will be closer to 5%.</p>
</div>
</li>
<li>
<p>Create a New Kernel Configuration File</p>
<div class="paragraph">
<p>All of the FireWire, and USB device drivers can be removed from a custom kernel configuration file. VMware Fusion provides a virtual network adapter used by the <a href="https://man.freebsd.org/cgi/man.cgi?query=em&amp;sektion=4&amp;format=html">em(4)</a> driver, so all network devices except for <a href="https://man.freebsd.org/cgi/man.cgi?query=em&amp;sektion=4&amp;format=html">em(4)</a> can be removed from the kernel.</p>
</div>
</li>
<li>
<p>Configure Networking</p>
<div class="paragraph">
<p>The most basic networking setup uses DHCP to connect the virtual machine to the same local area network as the host Mac®. This can be accomplished by adding <code>ifconfig_em0=&#34;DHCP&#34;</code> to <span class="filename">/etc/rc.conf</span>. More advanced networking setups are described in <a href="./#advanced-networking">Advanced Networking</a>.</p>
</div>
</li>
<li>
<p>Install drivers and open-vm-tools</p>
<div class="paragraph">
<p>To run FreeBSD smoothly on VMWare, drivers should be installed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install xf86-video-vmware xf86-input-vmmouse open-vm-tools</span></code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="virtualization-guest-virtualbox">24.4. FreeBSD as a Guest on VirtualBox™<a class="anchor" href="#virtualization-guest-virtualbox"></a></h3>
<div class="paragraph">
<p>FreeBSD works well as a guest in VirtualBox™. The virtualization software is available for most common operating systems, including FreeBSD itself.</p>
</div>
<div class="paragraph">
<p>The VirtualBox™ guest additions provide support for:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Clipboard sharing.</p>
</li>
<li>
<p>Mouse pointer integration.</p>
</li>
<li>
<p>Host time synchronization.</p>
</li>
<li>
<p>Window scaling.</p>
</li>
<li>
<p>Seamless mode.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>These commands are run in the FreeBSD guest.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>First, install the <a class="package" href="https://cgit.freebsd.org/ports/tree/emulators/virtualbox-ose-additions/">emulators/virtualbox-ose-additions</a> package or port in the FreeBSD guest. This will install the port:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># cd /usr/ports/emulators/virtualbox-ose-additions &amp;&amp; make install clean</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Add these lines to <span class="filename">/etc/rc.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>vboxguest_enable=&#34;YES&#34;
vboxservice_enable=&#34;YES&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>If <a href="https://man.freebsd.org/cgi/man.cgi?query=ntpd&amp;sektion=8&amp;format=html">ntpd(8)</a> or <a href="https://man.freebsd.org/cgi/man.cgi?query=ntpdate&amp;sektion=8&amp;format=html">ntpdate(8)</a> is used, disable host time synchronization:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>vboxservice_flags=&#34;--disable-timesync&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>Xorg will automatically recognize the <code>vboxvideo</code> driver. It can also be manually entered in <span class="filename">/etc/X11/xorg.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>Section &#34;Device&#34;
	Identifier &#34;Card0&#34;
	Driver &#34;vboxvideo&#34;
	VendorName &#34;InnoTek Systemberatung GmbH&#34;
	BoardName &#34;VirtualBox Graphics Adapter&#34;
EndSection</pre>
</div>
</div>
<div class="paragraph">
<p>To use the <code>vboxmouse</code> driver, adjust the mouse section in <span class="filename">/etc/X11/xorg.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>Section &#34;InputDevice&#34;
	Identifier &#34;Mouse0&#34;
	Driver &#34;vboxmouse&#34;
EndSection</pre>
</div>
</div>
<div class="paragraph">
<p>Shared folders for file transfers between host and VM are accessible by mounting them using <code>mount_vboxvfs</code>. A shared folder can be created on the host using the VirtualBox GUI or via <code>vboxmanage</code>. For example, to create a shared folder called <em>myshare</em> under <span class="filename">/mnt/bsdboxshare</span> for the VM named <em>BSDBox</em>, run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># vboxmanage sharedfolder add &#39;BSDBox&#39; --name myshare --hostpath /mnt/bsdboxshare</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the shared folder name must not contain spaces. Mount the shared folder from within the guest system like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># mount_vboxvfs -w myshare /mnt</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="virtualization-host-virtualbox">24.5. FreeBSD as a Host with VirtualBox™<a class="anchor" href="#virtualization-host-virtualbox"></a></h3>
<div class="paragraph">
<p>VirtualBox™ is an actively developed, complete virtualization package, that is available for most operating systems including Windows®, macOS®, Linux® and FreeBSD. It is equally capable of running Windows® or UNIX®-like guests. It is released as open source software, but with closed-source components available in a separate extension pack. These components include support for USB 2.0 devices. More information may be found on the <a href="http://www.virtualbox.org/wiki/Downloads">Downloads page of the VirtualBox™ wiki</a>. Currently, these extensions are not available for FreeBSD.</p>
</div>
<div class="sect3">
<h4 id="virtualization-virtualbox-install">24.5.1. Installing VirtualBox™<a class="anchor" href="#virtualization-virtualbox-install"></a></h4>
<div class="paragraph">
<p>VirtualBox™ is available as a FreeBSD package or port in <a class="package" href="https://cgit.freebsd.org/ports/tree/emulators/virtualbox-ose/">emulators/virtualbox-ose</a>. The port can be installed using these commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># cd /usr/ports/emulators/virtualbox-ose</span>
<span class="c"># make install clean</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>One useful option in the port’s configuration menu is the <code>GuestAdditions</code> suite of programs. These provide a number of useful features in guest operating systems, like mouse pointer integration (allowing the mouse to be shared between host and guest without the need to press a special keyboard shortcut to switch) and faster video rendering, especially in Windows® guests. The guest additions are available in the <b class="menuref">Devices</b> menu, after the installation of the guest is finished.</p>
</div>
<div class="paragraph">
<p>A few configuration changes are needed before VirtualBox™ is started for the first time. The port installs a kernel module in <span class="filename">/boot/modules</span> which must be loaded into the running kernel:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># kldload vboxdrv</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To ensure the module is always loaded after a reboot, add this line to <span class="filename">/boot/loader.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>vboxdrv_load=&#34;YES&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>To use the kernel modules that allow bridged or host-only networking, add this line to <span class="filename">/etc/rc.conf</span> and reboot the computer:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>vboxnet_enable=&#34;YES&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>vboxusers</code> group is created during installation of VirtualBox™. All users that need access to VirtualBox™ will have to be added as members of this group. <code>pw</code> can be used to add new members:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pw groupmod vboxusers -m yourusername</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The default permissions for <span class="filename">/dev/vboxnetctl</span> are restrictive and need to be changed for bridged networking:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># chown root:vboxusers /dev/vboxnetctl</span>
<span class="c"># chmod 0660 /dev/vboxnetctl</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To make this permissions change permanent, add these lines to <span class="filename">/etc/devfs.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>own     vboxnetctl root:vboxusers
perm    vboxnetctl 0660</pre>
</div>
</div>
<div class="paragraph">
<p>To launch VirtualBox™, type from an Xorg session:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>VirtualBox</code></pre>
</div>
</div>
<div class="paragraph">
<p>For more information on configuring and using VirtualBox™, refer to the <a href="http://www.virtualbox.org">official website</a>. For FreeBSD-specific information and troubleshooting instructions, refer to the <a href="http://wiki.FreeBSD.org/VirtualBox">relevant page in the FreeBSD wiki</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="virtualization-virtualbox-usb-support">24.5.2. VirtualBox™ USB Support<a class="anchor" href="#virtualization-virtualbox-usb-support"></a></h4>
<div class="paragraph">
<p>VirtualBox™ can be configured to pass USB devices through to the guest operating system. The host controller of the OSE version is limited to emulating USB 1.1 devices until the extension pack supporting USB 2.0 and 3.0 devices becomes available on FreeBSD.</p>
</div>
<div class="paragraph">
<p>For VirtualBox™ to be aware of USB devices attached to the machine, the user needs to be a member of the <code>operator</code> group.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pw groupmod operator -m yourusername</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, add the following to <span class="filename">/etc/devfs.rules</span>, or create this file if it does not exist yet:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>[system=10]
add path &#39;usb/*&#39; mode 0660 group operator</pre>
</div>
</div>
<div class="paragraph">
<p>To load these new rules, add the following to <span class="filename">/etc/rc.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>devfs_system_ruleset=&#34;system&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>Then, restart devfs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># service devfs restart</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Restart the login session and VirtualBox™ for these changes to take effect, and create USB filters as necessary.</p>
</div>
</div>
<div class="sect3">
<h4 id="virtualization-virtualbox-host-dvd-cd-access">24.5.3. VirtualBox™ Host DVD/CD Access<a class="anchor" href="#virtualization-virtualbox-host-dvd-cd-access"></a></h4>
<div class="paragraph">
<p>Access to the host DVD/CD drives from guests is achieved through the sharing of the physical drives. Within VirtualBox™, this is set up from the Storage window in the Settings of the virtual machine. If needed, create an empty IDECD/DVD device first. Then choose the Host Drive from the popup menu for the virtual CD/DVD drive selection. A checkbox labeled <code>Passthrough</code> will appear. This allows the virtual machine to use the hardware directly. For example, audio CDs or the burner will only function if this option is selected.</p>
</div>
<div class="paragraph">
<p>In order for users to be able to use VirtualBox™DVD/CD functions, they need access to <span class="filename">/dev/xpt0</span>, <span class="filename">/dev/cdN</span>, and <span class="filename">/dev/passN</span>. This is usually achieved by making the user a member of <code>operator</code>. Permissions to these devices have to be corrected by adding these lines to <span class="filename">/etc/devfs.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>perm cd* 0660
perm xpt0 0660
perm pass* 0660</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># service devfs restart</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="virtualization-host-bhyve">24.6. FreeBSD as a Host with bhyve<a class="anchor" href="#virtualization-host-bhyve"></a></h3>
<div class="paragraph">
<p>The bhyve BSD-licensed hypervisor became part of the base system with FreeBSD 10.0-RELEASE. This hypervisor supports a number of guests, including FreeBSD, OpenBSD, and many Linux® distributions. By default, bhyve provides access to serial console and does not emulate a graphical console. Virtualization offload features of newer CPUs are used to avoid the legacy methods of translating instructions and manually managing memory mappings.</p>
</div>
<div class="paragraph">
<p>The bhyve design requires a processor that supports Intel® Extended Page Tables (EPT) or AMD® Rapid Virtualization Indexing (RVI) or Nested Page Tables (NPT). Hosting Linux® guests or FreeBSD guests with more than one vCPU requires VMX unrestricted mode support (UG). Most newer processors, specifically the Intel® Core™ i3/i5/i7 and Intel® Xeon™ E3/E5/E7, support these features. UG support was introduced with Intel’s Westmere micro-architecture. For a complete list of Intel® processors that support EPT, refer to <a href="https://ark.intel.com/content/www/us/en/ark/search/featurefilter.html?productType=873&amp;0_ExtendedPageTables=True" class="bare">https://ark.intel.com/content/www/us/en/ark/search/featurefilter.html?productType=873&amp;0_ExtendedPageTables=True</a>. RVI is found on the third generation and later of the AMD Opteron™ (Barcelona) processors. The easiest way to tell if a processor supports bhyve is to run <code>dmesg</code> or look in <span class="filename">/var/run/dmesg.boot</span> for the <code>POPCNT</code> processor feature flag on the <code>Features2</code> line for AMD® processors or <code>EPT</code> and <code>UG</code> on the <code>VT-x</code> line for Intel® processors.</p>
</div>
<div class="sect3">
<h4 id="virtualization-bhyve-prep">24.6.1. Preparing the Host<a class="anchor" href="#virtualization-bhyve-prep"></a></h4>
<div class="paragraph">
<p>The first step to creating a virtual machine in bhyve is configuring the host system. First, load the bhyve kernel module:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># kldload vmm</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, create a <span class="filename">tap</span> interface for the network device in the virtual machine to attach to. In order for the network device to participate in the network, also create a bridge interface containing the <span class="filename">tap</span> interface and the physical interface as members. In this example, the physical interface is <em>igb0</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ifconfig tap0 create</span>
<span class="c"># sysctl net.link.tap.up_on_open=1</span>
net.link.tap.up_on_open: 0 -&gt; 1
<span class="c"># ifconfig bridge0 create</span>
<span class="c"># ifconfig bridge0 addm igb0 addm tap0</span>
<span class="c"># ifconfig bridge0 up</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="virtualization-bhyve-freebsd">24.6.2. Creating a FreeBSD Guest<a class="anchor" href="#virtualization-bhyve-freebsd"></a></h4>
<div class="paragraph">
<p>Create a file to use as the virtual disk for the guest machine. Specify the size and name of the virtual disk:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># truncate -s 16G guest.img</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Download an installation image of FreeBSD to install:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># fetch https://download.freebsd.org/releases/ISO-IMAGES/13.1/FreeBSD-13.1-RELEASE-amd64-bootonly.iso</span>
FreeBSD-13.1-RELEASE-amd64-bootonly.iso                366 MB   16 MBps    22s</code></pre>
</div>
</div>
<div class="paragraph">
<p>FreeBSD comes with an example script for running a virtual machine in bhyve. The script will start the virtual machine and run it in a loop, so it will automatically restart if it crashes. The script takes a number of options to control the configuration of the machine: <code>-c</code> controls the number of virtual CPUs, <code>-m</code> limits the amount of memory available to the guest, <code>-t</code> defines which <span class="filename">tap</span> device to use, <code>-d</code> indicates which disk image to use, <code>-i</code> tells bhyve to boot from the CD image instead of the disk, and <code>-I</code> defines which CD image to use. The last parameter is the name of the virtual machine, used to track the running machines. This example starts the virtual machine in installation mode:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sh /usr/share/examples/bhyve/vmrun.sh -c 1 -m 1024M -t tap0 -d guest.img -i -I FreeBSD-13.1-RELEASE-amd64-bootonly.iso guestname</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The virtual machine will boot and start the installer. After installing a system in the virtual machine, when the system asks about dropping in to a shell at the end of the installation, choose <b class="button">Yes</b>.</p>
</div>
<div class="paragraph">
<p>Reboot the virtual machine. While rebooting the virtual machine causes bhyve to exit, the <span class="filename">vmrun.sh</span> script runs <code>bhyve</code> in a loop and will automatically restart it. When this happens, choose the reboot option from the boot loader menu in order to escape the loop. Now the guest can be started from the virtual disk:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sh /usr/share/examples/bhyve/vmrun.sh -c 4 -m 1024M -t tap0 -d guest.img guestname</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="virtualization-bhyve-linux">24.6.3. Creating a Linux® Guest<a class="anchor" href="#virtualization-bhyve-linux"></a></h4>
<div class="paragraph">
<p>In order to boot operating systems other than FreeBSD, the <a class="package" href="https://cgit.freebsd.org/ports/tree/sysutils/grub2-bhyve/">sysutils/grub2-bhyve</a> port must be first installed.</p>
</div>
<div class="paragraph">
<p>Next, create a file to use as the virtual disk for the guest machine:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># truncate -s 16G linux.img</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Starting a virtual machine with bhyve is a two step process. First a kernel must be loaded, then the guest can be started. The Linux® kernel is loaded with <a class="package" href="https://cgit.freebsd.org/ports/tree/sysutils/grub2-bhyve/">sysutils/grub2-bhyve</a>. Create a <span class="filename">device.map</span> that grub will use to map the virtual devices to the files on the host system:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>(hd0) ./linux.img
(cd0) ./somelinux.iso</pre>
</div>
</div>
<div class="paragraph">
<p>Use <a class="package" href="https://cgit.freebsd.org/ports/tree/sysutils/grub2-bhyve/">sysutils/grub2-bhyve</a> to load the Linux® kernel from the ISO image:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># grub-bhyve -m device.map -r cd0 -M 1024M linuxguest</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This will start grub. If the installation CD contains a <span class="filename">grub.cfg</span>, a menu will be displayed. If not, the <code>vmlinuz</code> and <code>initrd</code> files must be located and loaded manually:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">grub&gt; </span>ls
<span class="o">(</span>hd0<span class="o">)</span> <span class="o">(</span>cd0<span class="o">)</span> <span class="o">(</span>cd0,msdos1<span class="o">)</span> <span class="o">(</span>host<span class="o">)</span>
<span class="gp">grub&gt; </span>ls <span class="o">(</span>cd0<span class="o">)</span>/isolinux
boot.cat boot.msg grub.conf initrd.img isolinux.bin isolinux.cfg memtest
splash.jpg TRANS.TBL vesamenu.c32 vmlinuz
<span class="gp">grub&gt; </span>linux <span class="o">(</span>cd0<span class="o">)</span>/isolinux/vmlinuz
<span class="gp">grub&gt; </span>initrd <span class="o">(</span>cd0<span class="o">)</span>/isolinux/initrd.img
<span class="gp">grub&gt; </span>boot</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now that the Linux® kernel is loaded, the guest can be started:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># bhyve -A -H -P -s 0:0,hostbridge -s 1:0,lpc -s 2:0,virtio-net,tap0 -s 3:0,virtio-blk,./linux.img \</span>
    -s 4:0,ahci-cd,./somelinux.iso -l com1,stdio -c 4 -m 1024M linuxguest</code></pre>
</div>
</div>
<div class="paragraph">
<p>The system will boot and start the installer. After installing a system in the virtual machine, reboot the virtual machine. This will cause bhyve to exit. The instance of the virtual machine needs to be destroyed before it can be started again:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># bhyvectl --destroy --vm=linuxguest</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now the guest can be started directly from the virtual disk. Load the kernel:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># grub-bhyve -m device.map -r hd0,msdos1 -M 1024M linuxguest</span>
<span class="gp">grub&gt; </span>ls
<span class="o">(</span>hd0<span class="o">)</span> <span class="o">(</span>hd0,msdos2<span class="o">)</span> <span class="o">(</span>hd0,msdos1<span class="o">)</span> <span class="o">(</span>cd0<span class="o">)</span> <span class="o">(</span>cd0,msdos1<span class="o">)</span> <span class="o">(</span>host<span class="o">)</span>
<span class="o">(</span>lvm/VolGroup-lv_swap<span class="o">)</span> <span class="o">(</span>lvm/VolGroup-lv_root<span class="o">)</span>
<span class="gp">grub&gt; </span>ls <span class="o">(</span>hd0,msdos1<span class="o">)</span>/
lost+found/ grub/ efi/ System.map-2.6.32-431.el6.x86_64 config-2.6.32-431.el6.x
86_64 symvers-2.6.32-431.el6.x86_64.gz vmlinuz-2.6.32-431.el6.x86_64
initramfs-2.6.32-431.el6.x86_64.img
<span class="gp">grub&gt; </span>linux <span class="o">(</span>hd0,msdos1<span class="o">)</span>/vmlinuz-2.6.32-431.el6.x86_64 <span class="nv">root</span><span class="o">=</span>/dev/mapper/VolGroup-lv_root
<span class="gp">grub&gt; </span>initrd <span class="o">(</span>hd0,msdos1<span class="o">)</span>/initramfs-2.6.32-431.el6.x86_64.img
<span class="gp">grub&gt; </span>boot</code></pre>
</div>
</div>
<div class="paragraph">
<p>Boot the virtual machine:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># bhyve -A -H -P -s 0:0,hostbridge -s 1:0,lpc -s 2:0,virtio-net,tap0 \</span>
    -s 3:0,virtio-blk,./linux.img -l com1,stdio -c 4 -m 1024M linuxguest</code></pre>
</div>
</div>
<div class="paragraph">
<p>Linux® will now boot in the virtual machine and eventually present you with the login prompt. Login and use the virtual machine. When you are finished, reboot the virtual machine to exit bhyve. Destroy the virtual machine instance:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># bhyvectl --destroy --vm=linuxguest</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="virtualization-bhyve-uefi">24.6.4. Booting bhyve Virtual Machines with UEFI Firmware<a class="anchor" href="#virtualization-bhyve-uefi"></a></h4>
<div class="paragraph">
<p>In addition to bhyveload and grub-bhyve, the bhyve hypervisor can also boot virtual machines using the UEFI userspace firmware. This option may support guest operating systems that are not supported by the other loaders.</p>
</div>
<div class="paragraph">
<p>In order to make use of the UEFI support in bhyve, first obtain the UEFI firmware images. This can be done by installing <a class="package" href="https://cgit.freebsd.org/ports/tree/sysutils/bhyve-firmware/">sysutils/bhyve-firmware</a> port or package.</p>
</div>
<div class="paragraph">
<p>With the firmware in place, add the flags <code>-l bootrom,<em>/path/to/firmware</em></code> to your bhyve command line. The actual bhyve command may look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># bhyve -AHP -s 0:0,hostbridge -s 1:0,lpc \</span>
-s 2:0,virtio-net,tap1 -s 3:0,virtio-blk,./disk.img <span class="se">\</span>
-s 4:0,ahci-cd,./install.iso -c 4 -m 1024M <span class="se">\</span>
-l bootrom,/usr/local/share/uefi-firmware/BHYVE_UEFI.fd <span class="se">\</span>
guest</code></pre>
</div>
</div>
<div class="paragraph">
<p><a class="package" href="https://cgit.freebsd.org/ports/tree/sysutils/bhyve-firmware/">sysutils/bhyve-firmware</a> also contains a CSM-enabled firmware, to boot guests with no UEFI support in legacy BIOS mode:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># bhyve -AHP -s 0:0,hostbridge -s 1:0,lpc \</span>
-s 2:0,virtio-net,tap1 -s 3:0,virtio-blk,./disk.img <span class="se">\</span>
-s 4:0,ahci-cd,./install.iso -c 4 -m 1024M <span class="se">\</span>
-l bootrom,/usr/local/share/uefi-firmware/BHYVE_UEFI_CSM.fd <span class="se">\</span>
guest</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="virtualization-bhyve-framebuffer">24.6.5. Graphical UEFI Framebuffer for bhyve Guests<a class="anchor" href="#virtualization-bhyve-framebuffer"></a></h4>
<div class="paragraph">
<p>The UEFI firmware support is particularly useful with predominantly graphical guest operating systems such as Microsoft Windows®.</p>
</div>
<div class="paragraph">
<p>Support for the UEFI-GOP framebuffer may also be enabled with the <code>-s 29,fbuf,tcp=<em>0.0.0.0:5900</em></code> flags. The framebuffer resolution may be configured with <code>w=<em>800</em></code> and <code>h=<em>600</em></code>, and bhyve can be instructed to wait for a VNC connection before booting the guest by adding <code>wait</code>. The framebuffer may be accessed from the host or over the network via the VNC protocol. Additionally, <code>-s 30,xhci,tablet</code> can be added to achieve precise mouse cursor synchronization with the host.</p>
</div>
<div class="paragraph">
<p>The resulting bhyve command would look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># bhyve -AHP -s 0:0,hostbridge -s 31:0,lpc \</span>
-s 2:0,virtio-net,tap1 -s 3:0,virtio-blk,./disk.img <span class="se">\</span>
-s 4:0,ahci-cd,./install.iso -c 4 -m 1024M <span class="se">\</span>
-s 29,fbuf,tcp<span class="o">=</span>0.0.0.0:5900,w<span class="o">=</span>800,h<span class="o">=</span>600,wait <span class="se">\</span>
-s 30,xhci,tablet <span class="se">\</span>
-l bootrom,/usr/local/share/uefi-firmware/BHYVE_UEFI.fd <span class="se">\</span>
guest</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note, in BIOS emulation mode, the framebuffer will cease receiving updates once control is passed from firmware to guest operating system.</p>
</div>
</div>
<div class="sect3">
<h4 id="virtualization-bhyve-zfs">24.6.6. Using ZFS with bhyve Guests<a class="anchor" href="#virtualization-bhyve-zfs"></a></h4>
<div class="paragraph">
<p>If ZFS is available on the host machine, using ZFS volumes instead of disk image files can provide significant performance benefits for the guest VMs. A ZFS volume can be created by:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zfs create -V16G -o volmode=dev zroot/linuxdisk0</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When starting the VM, specify the ZFS volume as the disk drive:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># bhyve -A -H -P -s 0:0,hostbridge -s 1:0,lpc -s 2:0,virtio-net,tap0 -s3:0,virtio-blk,/dev/zvol/zroot/linuxdisk0 \</span>
    -l com1,stdio -c 4 -m 1024M linuxguest</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="virtualization-bhyve-nmdm">24.6.7. Virtual Machine Consoles<a class="anchor" href="#virtualization-bhyve-nmdm"></a></h4>
<div class="paragraph">
<p>It is advantageous to wrap the bhyve console in a session management tool such as <a class="package" href="https://cgit.freebsd.org/ports/tree/sysutils/tmux/">sysutils/tmux</a> or <a class="package" href="https://cgit.freebsd.org/ports/tree/sysutils/screen/">sysutils/screen</a> in order to detach and reattach to the console. It is also possible to have the console of bhyve be a null modem device that can be accessed with <code>cu</code>. To do this, load the <span class="filename">nmdm</span> kernel module and replace <code>-l com1,stdio</code> with <code>-l com1,/dev/nmdm0A</code>. The <span class="filename">/dev/nmdm</span> devices are created automatically as needed, where each is a pair, corresponding to the two ends of the null modem cable (<span class="filename">/dev/nmdm0A</span> and <span class="filename">/dev/nmdm0B</span>). See <a href="https://man.freebsd.org/cgi/man.cgi?query=nmdm&amp;sektion=4&amp;format=html">nmdm(4)</a> for more information.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># kldload nmdm</span>
<span class="c"># bhyve -A -H -P -s 0:0,hostbridge -s 1:0,lpc -s 2:0,virtio-net,tap0 -s 3:0,virtio-blk,./linux.img \</span>
    -l com1,/dev/nmdm0A -c 4 -m 1024M linuxguest
<span class="c"># cu -l /dev/nmdm0B</span>
Connected

Ubuntu 13.10 handbook ttyS0

handbook login:</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="virtualization-bhyve-managing">24.6.8. Managing Virtual Machines<a class="anchor" href="#virtualization-bhyve-managing"></a></h4>
<div class="paragraph">
<p>A device node is created in <span class="filename">/dev/vmm</span> for each virtual machine. This allows the administrator to easily see a list of the running virtual machines:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ls -al /dev/vmm</span>
total 1
dr-xr-xr-x   2 root  wheel    512 Mar 17 12:19 ./
dr-xr-xr-x  14 root  wheel    512 Mar 17 06:38 ../
crw-------   1 root  wheel  0x1a2 Mar 17 12:20 guestname
crw-------   1 root  wheel  0x19f Mar 17 12:19 linuxguest
crw-------   1 root  wheel  0x1a1 Mar 17 12:19 otherguest</code></pre>
</div>
</div>
<div class="paragraph">
<p>A specified virtual machine can be destroyed using <code>bhyvectl</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># bhyvectl --destroy --vm=guestname</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="virtualization-bhyve-onboot">24.6.9. Persistent Configuration<a class="anchor" href="#virtualization-bhyve-onboot"></a></h4>
<div class="paragraph">
<p>In order to configure the system to start bhyve guests at boot time, the following configurations must be made in the specified files:</p>
</div>
<div class="olist arabic procedure">
<ol class="arabic">
<li>
<p><span class="filename">/etc/sysctl.conf</span></p>
<div class="literalblock programlisting">
<div class="content">
<pre>net.link.tap.up_on_open=1</pre>
</div>
</div>
</li>
<li>
<p><span class="filename">/etc/rc.conf</span></p>
<div class="literalblock programlisting">
<div class="content">
<pre>cloned_interfaces=&#34;bridge0 tap0&#34;
ifconfig_bridge0=&#34;addm igb0 addm tap0&#34;
kld_list=&#34;nmdm vmm&#34;</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="virtualization-host-xen">24.7. FreeBSD as a Xen™-Host<a class="anchor" href="#virtualization-host-xen"></a></h3>
<div class="paragraph">
<p>Xen is a GPLv2-licensed <a href="https://en.wikipedia.org/wiki/Hypervisor#Classification">type 1 hypervisor</a> for Intel® and ARM® architectures. FreeBSD has included i386™ and AMD® 64-Bit <a href="https://wiki.xenproject.org/wiki/DomU">DomU</a> and <a href="https://en.wikipedia.org/wiki/Amazon_Elastic_Compute_Cloud">Amazon EC2</a> unprivileged domain (virtual machine) support since FreeBSD 8.0 and includes Dom0 control domain (host) support in FreeBSD 11.0. Support for para-virtualized (PV) domains has been removed from FreeBSD 11 in favor of hardware virtualized (HVM) domains, which provides better performance.</p>
</div>
<div class="paragraph">
<p>Xen™ is a bare-metal hypervisor, which means that it is the first program loaded after the BIOS. A special privileged guest called the Domain-0 (<code>Dom0</code> for short) is then started. The Dom0 uses its special privileges to directly access the underlying physical hardware, making it a high-performance solution. It is able to access the disk controllers and network adapters directly. The Xen™ management tools to manage and control the Xen™ hypervisor are also used by the Dom0 to create, list, and destroy VMs. Dom0 provides virtual disks and networking for unprivileged domains, often called <code>DomU</code>. Xen™ Dom0 can be compared to the service console of other hypervisor solutions, while the DomU is where individual guest VMs are run.</p>
</div>
<div class="paragraph">
<p>Xen™ can migrate VMs between different Xen™ servers. When the two xen hosts share the same underlying storage, the migration can be done without having to shut the VM down first. Instead, the migration is performed live while the DomU is running and there is no need to restart it or plan a downtime. This is useful in maintenance scenarios or upgrade windows to ensure that the services provided by the DomU are still provided. Many more features of Xen™ are listed on the <a href="https://wiki.xenproject.org/wiki/Category:Overview">Xen Wiki Overview page</a>. Note that not all features are supported on FreeBSD yet.</p>
</div>
<div class="sect3">
<h4 id="virtualization-host-xen-requirements">24.7.1. Hardware Requirements for Xen™ Dom0<a class="anchor" href="#virtualization-host-xen-requirements"></a></h4>
<div class="paragraph">
<p>To run the Xen™ hypervisor on a host, certain hardware functionality is required. Hardware virtualized domains require Extended Page Table (<a href="http://en.wikipedia.org/wiki/Extended_Page_Table">EPT</a>) and Input/Output Memory Management Unit (<a href="http://en.wikipedia.org/wiki/List_of_IOMMU-supporting_hardware">IOMMU</a>) support in the host processor.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In order to run a FreeBSD Xen™ Dom0 the box must be booted using legacy boot (BIOS).</p>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect3">
<h4 id="virtualization-host-xen-dom0-setup">24.7.2. Xen™ Dom0 Control Domain Setup<a class="anchor" href="#virtualization-host-xen-dom0-setup"></a></h4>
<div class="paragraph">
<p>Users of FreeBSD 11 should install the <a class="package" href="https://cgit.freebsd.org/ports/tree/emulators/xen-kernel47/">emulators/xen-kernel47</a> and <a class="package" href="https://cgit.freebsd.org/ports/tree/sysutils/xen-tools47/">sysutils/xen-tools47</a> packages that are based on Xen version 4.7. Systems running on FreeBSD-12.0 or newer can use Xen 4.11 provided by <a class="package" href="https://cgit.freebsd.org/ports/tree/emulators/xen-kernel411/">emulators/xen-kernel411</a> and <a class="package" href="https://cgit.freebsd.org/ports/tree/sysutils/xen-tools411/">sysutils/xen-tools411</a>, respectively.</p>
</div>
<div class="paragraph">
<p>Configuration files must be edited to prepare the host for the Dom0 integration after the Xen packages are installed. An entry to <span class="filename">/etc/sysctl.conf</span> disables the limit on how many pages of memory are allowed to be wired. Otherwise, DomU VMs with higher memory requirements will not run.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># echo &#39;vm.max_wired=-1&#39; &gt;&gt; /etc/sysctl.conf</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Another memory-related setting involves changing <span class="filename">/etc/login.conf</span>, setting the <code>memorylocked</code> option to <code>unlimited</code>. Otherwise, creating DomU domains may fail with <code>Cannot allocate memory</code> errors. After making the change to <span class="filename">/etc/login.conf</span>, run <code>cap_mkdb</code> to update the capability database. See <a href="./#security-resourcelimits">Resource Limits</a> for details.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sed -i &#39;&#39; -e &#39;s/memorylocked=64K/memorylocked=unlimited/&#39; /etc/login.conf</span>
<span class="c"># cap_mkdb /etc/login.conf</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Add an entry for the Xen™ console to <span class="filename">/etc/ttys</span>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># echo &#39;xc0     &#34;/usr/libexec/getty Pc&#34;         xterm   onifconsole  secure&#39; &gt;&gt; /etc/ttys</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Selecting a Xen™ kernel in <span class="filename">/boot/loader.conf</span> activates the Dom0. Xen™ also requires resources like CPU and memory from the host machine for itself and other DomU domains. How much CPU and memory depends on the individual requirements and hardware capabilities. In this example, 8 GB of memory and 4 virtual CPUs are made available for the Dom0. The serial console is also activated and logging options are defined.</p>
</div>
<div class="paragraph">
<p>The following command is used for Xen 4.7 packages:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># echo &#39;hw.pci.mcfg=0&#39; &gt;&gt; /boot/loader.conf</span>
<span class="c"># echo &#39;if_tap_load=&#34;YES&#34;&#39; &gt;&gt; /boot/loader.conf</span>
<span class="c"># echo &#39;xen_kernel=&#34;/boot/xen&#34;&#39; &gt;&gt; /boot/loader.conf</span>
<span class="c"># echo &#39;xen_cmdline=&#34;dom0_mem=8192M dom0_max_vcpus=4 dom0pvh=1 console=com1,vga com1=115200,8n1 guest_loglvl=all loglvl=all&#34;&#39; &gt;&gt; /boot/loader.conf</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For Xen versions 4.11 and higher, the following command should be used instead:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># echo &#39;if_tap_load=&#34;YES&#34;&#39; &gt;&gt; /boot/loader.conf</span>
<span class="c"># echo &#39;xen_kernel=&#34;/boot/xen&#34;&#39; &gt;&gt; /boot/loader.conf</span>
<span class="c"># echo &#39;xen_cmdline=&#34;dom0_mem=8192M dom0_max_vcpus=4 dom0=pvh console=com1,vga com1=115200,8n1 guest_loglvl=all loglvl=all&#34;&#39; &gt;&gt; /boot/loader.conf</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Log files that Xen™ creates for the DomU VMs are stored in <span class="filename">/var/log/xen</span>. Please be sure to check the contents of that directory if experiencing issues.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Activate the xencommons service during system startup:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysrc xencommons_enable=yes</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>These settings are enough to start a Dom0-enabled system. However, it lacks network functionality for the DomU machines. To fix that, define a bridged interface with the main NIC of the system which the DomU VMs can use to connect to the network. Replace <em>em0</em> with the host network interface name.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysrc cloned_interfaces=&#34;bridge0&#34;</span>
<span class="c"># sysrc ifconfig_bridge0=&#34;addm em0 SYNCDHCP&#34;</span>
<span class="c"># sysrc ifconfig_em0=&#34;up&#34;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Restart the host to load the Xen™ kernel and start the Dom0.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># reboot</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>After successfully booting the Xen™ kernel and logging into the system again, the Xen™ management tool <code>xl</code> is used to show information about the domains.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># xl list</span>
Name                                        ID   Mem VCPUs      State   Time<span class="o">(</span>s<span class="o">)</span>
Domain-0                                     0  8192     4     r-----     962.0</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output confirms that the Dom0 (called <code>Domain-0</code>) has the ID <code>0</code> and is running. It also has the memory and virtual CPUs that were defined in <span class="filename">/boot/loader.conf</span> earlier. More information can be found in the <a href="https://www.xenproject.org/help/documentation.html">Xen™ Documentation</a>. DomU guest VMs can now be created.</p>
</div>
</div>
<div class="sect3">
<h4 id="virtualization-host-xen-domu-setup">24.7.3. Xen™ DomU Guest VM Configuration<a class="anchor" href="#virtualization-host-xen-domu-setup"></a></h4>
<div class="paragraph">
<p>Unprivileged domains consist of a configuration file and virtual or physical hard disks. Virtual disk storage for the DomU can be files created by <a href="https://man.freebsd.org/cgi/man.cgi?query=truncate&amp;sektion=1&amp;format=html">truncate(1)</a> or ZFS volumes as described in <a href="./#zfs-zfs-volume">“Creating and Destroying Volumes”</a>. In this example, a 20 GB volume is used. A VM is created with the ZFS volume, a FreeBSD ISO image, 1 GB of RAM and two virtual CPUs. The ISO installation file is retrieved with <a href="https://man.freebsd.org/cgi/man.cgi?query=fetch&amp;sektion=1&amp;format=html">fetch(1)</a> and saved locally in a file called <span class="filename">freebsd.iso</span>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># fetch https://download.freebsd.org/releases/ISO-IMAGES/13.1/FreeBSD-13.1-RELEASE-amd64-bootonly.iso -o freebsd.iso</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A ZFS volume of 20 GB called <span class="filename">xendisk0</span> is created to serve as the disk space for the VM.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># zfs create -V20G -o volmode=dev zroot/xendisk0</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The new DomU guest VM is defined in a file. Some specific definitions like name, keymap, and VNC connection details are also defined. The following <span class="filename">freebsd.cfg</span> contains a minimum DomU configuration for this example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># cat freebsd.cfg</span>
builder <span class="o">=</span> <span class="s2">&#34;hvm&#34;</span> <i class="conum" data-value="1"></i><b>(1)</b>
name <span class="o">=</span> <span class="s2">&#34;freebsd&#34;</span> <i class="conum" data-value="2"></i><b>(2)</b>
memory <span class="o">=</span> 1024 <i class="conum" data-value="3"></i><b>(3)</b>
vcpus <span class="o">=</span> 2 <i class="conum" data-value="4"></i><b>(4)</b>
vif <span class="o">=</span> <span class="o">[</span> <span class="s1">&#39;mac=00:16:3E:74:34:32,bridge=bridge0&#39;</span> <span class="o">]</span> <i class="conum" data-value="5"></i><b>(5)</b>
disk <span class="o">=</span> <span class="o">[</span>
<span class="s1">&#39;/dev/zvol/tank/xendisk0,raw,hda,rw&#39;</span>, <i class="conum" data-value="6"></i><b>(6)</b>
<span class="s1">&#39;/root/freebsd.iso,raw,hdc:cdrom,r&#39;</span> <i class="conum" data-value="7"></i><b>(7)</b>
  <span class="o">]</span>
vnc <span class="o">=</span> 1 <i class="conum" data-value="8"></i><b>(8)</b>
vnclisten <span class="o">=</span> <span class="s2">&#34;0.0.0.0&#34;</span>
serial <span class="o">=</span> <span class="s2">&#34;pty&#34;</span>
usbdevice <span class="o">=</span> <span class="s2">&#34;tablet&#34;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>These lines are explained in more detail:</p>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This defines what kind of virtualization to use. <code>hvm</code> refers to hardware-assisted virtualization or hardware virtual machine. Guest operating systems can run unmodified on CPUs with virtualization extensions, providing nearly the same performance as running on physical hardware. <code>generic</code> is the default value and creates a PV domain. &lt;.&gt; Name of this virtual machine to distinguish it from others running on the same Dom0. Required. &lt;.&gt; Quantity of RAM in megabytes to make available to the VM. This amount is subtracted from the hypervisor’s total available memory, not the memory of the Dom0. &lt;.&gt; Number of virtual CPUs available to the guest VM. For best performance, do not create guests with more virtual CPUs than the number of physical CPUs on the host. &lt;.&gt; Virtual network adapter. This is the bridge connected to the network interface of the host. The <code>mac</code> parameter is the MAC address set on the virtual network interface. This parameter is optional, if no MAC is provided Xen™ will generate a random one. &lt;.&gt; Full path to the disk, file, or ZFS volume of the disk storage for this VM. Options and multiple disk definitions are separated by commas. &lt;.&gt; Defines the Boot medium from which the initial operating system is installed. In this example, it is the ISO image downloaded earlier. Consult the Xen™ documentation for other kinds of devices and options to set. &lt;.&gt; Options controlling VNC connectivity to the serial console of the DomU. In order, these are: active VNC support, define IP address on which to listen, device node for the serial console, and the input method for precise positioning of the mouse and other input methods. <code>keymap</code> defines which keymap to use, and is <code>english</code> by default.</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>After the file has been created with all the necessary options, the DomU is created by passing it to <code>xl create</code> as a parameter.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># xl create freebsd.cfg</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Each time the Dom0 is restarted, the configuration file must be passed to <code>xl create</code> again to re-create the DomU. By default, only the Dom0 is created after a reboot, not the individual VMs. The VMs can continue where they left off as they stored the operating system on the virtual disk. The virtual machine configuration can change over time (for example, when adding more memory). The virtual machine configuration files must be properly backed up and kept available to be able to re-create the guest VM when needed.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>The output of <code>xl list</code> confirms that the DomU has been created.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># xl list</span>
Name                                        ID   Mem VCPUs      State   Time<span class="o">(</span>s<span class="o">)</span>
Domain-0                                     0  8192     4     r-----  1653.4
freebsd                                      1  1024     1     -b----   663.9</code></pre>
</div>
</div>
<div class="paragraph">
<p>To begin the installation of the base operating system, start the VNC client, directing it to the main network address of the host or to the IP address defined on the <code>vnclisten</code> line of <span class="filename">freebsd.cfg</span>. After the operating system has been installed, shut down the DomU and disconnect the VNC viewer. Edit <span class="filename">freebsd.cfg</span>, removing the line with the <code>cdrom</code> definition or commenting it out by inserting a <code>#</code> character at the beginning of the line. To load this new configuration, it is necessary to remove the old DomU with <code>xl destroy</code>, passing either the name or the id as the parameter. Afterwards, recreate it using the modified <strong class="filename">freebsd.cfg</strong>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># xl destroy freebsd</span>
<span class="c"># xl create freebsd.cfg</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The machine can then be accessed again using the VNC viewer. This time, it will boot from the virtual disk where the operating system has been installed and can be used as a virtual machine.</p>
</div>
</div>
<div class="sect3">
<h4 id="virtualization-host-xen-troubleshooting">24.7.4. Troubleshooting<a class="anchor" href="#virtualization-host-xen-troubleshooting"></a></h4>
<div class="paragraph">
<p>This section contains basic information in order to help troubleshoot issues found when using FreeBSD as a Xen™ host or guest.</p>
</div>
<div class="sect4">
<h5 id="virtualization-host-xen-troubleshooting-host">24.7.4.1. Host Boot Troubleshooting<a class="anchor" href="#virtualization-host-xen-troubleshooting-host"></a></h5>
<div class="paragraph">
<p>Please note that the following troubleshooting tips are intended for Xen™ 4.11 or newer. If you are still using Xen™ 4.7 and having issues consider migrating to a newer version of Xen™.</p>
</div>
<div class="paragraph">
<p>In order to troubleshoot host boot issues you will likely need a serial cable, or a debug USB cable. Verbose Xen™ boot output can be obtained by adding options to the <code>xen_cmdline</code> option found in <span class="filename">loader.conf</span>. A couple of relevant debug options are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>iommu=debug</code>: can be used to print additional diagnostic information about the iommu.</p>
</li>
<li>
<p><code>dom0=verbose</code>: can be used to print additional diagnostic information about the dom0 build process.</p>
</li>
<li>
<p><code>sync_console</code>: flag to force synchronous console output. Useful for debugging to avoid losing messages due to rate limiting. Never use this option in production environments since it can allow malicious guests to perform DoS attacks against Xen™ using the console.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>FreeBSD should also be booted in verbose mode in order to identify any issues. To activate verbose booting, run this command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># echo &#39;boot_verbose=&#34;YES&#34;&#39; &gt;&gt; /boot/loader.conf</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If none of these options help solving the problem, please send the serial boot log to <a href="mailto:freebsd-xen@FreeBSD.org">freebsd-xen@FreeBSD.org</a> and <a href="mailto:xen-devel@lists.xenproject.org">xen-devel@lists.xenproject.org</a> for further analysis.</p>
</div>
</div>
<div class="sect4">
<h5 id="virtualization-host-xen-troubleshooting-guest">24.7.4.2. Guest Creation Troubleshooting<a class="anchor" href="#virtualization-host-xen-troubleshooting-guest"></a></h5>
<div class="paragraph">
<p>Issues can also arise when creating guests, the following attempts to provide some help for those trying to diagnose guest creation issues.</p>
</div>
<div class="paragraph">
<p>The most common cause of guest creation failures is the <code>xl</code> command spitting some error and exiting with a return code different than 0. If the error provided is not enough to help identify the issue, more verbose output can also be obtained from <code>xl</code> by using the <code>v</code> option repeatedly.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># xl -vvv create freebsd.cfg</span>
Parsing config from freebsd.cfg
libxl: debug: libxl_create.c:1693:do_domain_create: Domain 0:ao 0x800d750a0: create: <span class="nv">how</span><span class="o">=</span>0x0 <span class="nv">callback</span><span class="o">=</span>0x0 <span class="nv">poller</span><span class="o">=</span>0x800d6f0f0
libxl: debug: libxl_device.c:397:libxl__device_disk_set_backend: Disk <span class="nv">vdev</span><span class="o">=</span>xvda spec.backend<span class="o">=</span>unknown
libxl: debug: libxl_device.c:432:libxl__device_disk_set_backend: Disk <span class="nv">vdev</span><span class="o">=</span>xvda, using backend phy
libxl: debug: libxl_create.c:1018:initiate_domain_create: Domain 1:running bootloader
libxl: debug: libxl_bootloader.c:328:libxl__bootloader_run: Domain 1:not a PV/PVH domain, skipping bootloader
libxl: debug: libxl_event.c:689:libxl__ev_xswatch_deregister: watch <span class="nv">w</span><span class="o">=</span>0x800d96b98: deregister unregistered
domainbuilder: detail: xc_dom_allocate: <span class="nv">cmdline</span><span class="o">=</span><span class="s2">&#34;&#34;</span>, <span class="nv">features</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
domainbuilder: detail: xc_dom_kernel_file: <span class="nv">filename</span><span class="o">=</span><span class="s2">&#34;/usr/local/lib/xen/boot/hvmloader&#34;</span>
domainbuilder: detail: xc_dom_malloc_filemap    : 326 kB
libxl: debug: libxl_dom.c:988:libxl__load_hvm_firmware_module: Loading BIOS: /usr/local/share/seabios/bios.bin
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the verbose output does not help diagnose the issue there are also QEMU and Xen™ toolstack logs in <span class="filename">/var/log/xen</span>. Note that the name of the domain is appended to the log name, so if the domain is named <code>freebsd</code> you should find a <span class="filename">/var/log/xen/xl-freebsd.log</span> and likely a <span class="filename">/var/log/xen/qemu-dm-freebsd.log</span>. Both log files can contain useful information for debugging. If none of this helps solve the issue, please send the description of the issue you are facing and as much information as possible to <a href="mailto:freebsd-xen@FreeBSD.org">freebsd-xen@FreeBSD.org</a> and <a href="mailto:xen-devel@lists.xenproject.org">xen-devel@lists.xenproject.org</a> in order to get help.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="l10n">Chapter 25. Localization - i18n/L10n Usage and Setup<a class="anchor" href="#l10n"></a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="l10n-synopsis">25.1. Synopsis<a class="anchor" href="#l10n-synopsis"></a></h3>
<div class="paragraph">
<p>FreeBSD is a distributed project with users and contributors located all over the world. As such, FreeBSD supports localization into many languages, allowing users to view, input, or process data in non-English languages. One can choose from most of the major languages, including, but not limited to: Chinese, German, Japanese, Korean, French, Russian, and Vietnamese.</p>
</div>
<div class="paragraph">
<p>The term internationalization has been shortened to i18n, which represents the number of letters between the first and the last letters of <code>internationalization</code>. L10n uses the same naming scheme, but from <code>localization</code>. The i18n/L10n methods, protocols, and applications allow users to use languages of their choice.</p>
</div>
<div class="paragraph">
<p>This chapter discusses the internationalization and localization features of FreeBSD. After reading this chapter, you will know:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>How locale names are constructed.</p>
</li>
<li>
<p>How to set the locale for a login shell.</p>
</li>
<li>
<p>How to configure the console for non-English languages.</p>
</li>
<li>
<p>How to configure Xorg for different languages.</p>
</li>
<li>
<p>How to find i18n-compliant applications.</p>
</li>
<li>
<p>Where to find more information for configuring specific languages.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Before reading this chapter, you should:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Know how to <a href="./#ports">install additional third-party applications</a>.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="using-localization">25.2. Using Localization<a class="anchor" href="#using-localization"></a></h3>
<div class="paragraph">
<p>Localization settings are based on three components: the language code, country code, and encoding. Locale names are constructed from these parts as follows:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>LanguageCode_CountryCode.Encoding</pre>
</div>
</div>
<div class="paragraph">
<p>The <em>LanguageCode</em> and <em>CountryCode</em> are used to determine the country and the specific language variation. <a href="#locale-lang-country">Common Language and Country Codes</a> provides some examples of <em>LanguageCode_CountryCode</em>:</p>
</div>
<table id="locale-lang-country" class="tableblock frame-none grid-all stretch">
<caption class="title">表 33. Common Language and Country Codes</caption>
<colgroup>
<col style="width: 50%;"/>
<col style="width: 50%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">LanguageCode_Country Code</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">en_US</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">English, United States</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ru_RU</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Russian, Russia</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">zh_TW</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Traditional Chinese, Taiwan</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>A complete listing of available locales can be found by typing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>locale -a | more</code></pre>
</div>
</div>
<div class="paragraph">
<p>To determine the current locale setting:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>locale</code></pre>
</div>
</div>
<div class="paragraph">
<p>Language specific character sets, such as ISO8859-1, ISO8859-15, KOI8-R, and CP437, are described in <a href="https://man.freebsd.org/cgi/man.cgi?query=multibyte&amp;sektion=3&amp;format=html">multibyte(3)</a>. The active list of character sets can be found at the <a href="http://www.iana.org/assignments/character-sets">IANA Registry</a>.</p>
</div>
<div class="paragraph">
<p>Some languages, such as Chinese or Japanese, cannot be represented using ASCII characters and require an extended language encoding using either wide or multibyte characters. Examples of wide or multibyte encodings include EUC and Big5. Older applications may mistake these encodings for control characters while newer applications usually recognize these characters. Depending on the implementation, users may be required to compile an application with wide or multibyte character support, or to configure it correctly.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>FreeBSD uses Xorg-compatible locale encodings.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>The rest of this section describes the various methods for configuring the locale on a FreeBSD system. The next section will discuss the considerations for finding and compiling applications with i18n support.</p>
</div>
<div class="sect3">
<h4 id="setting-locale">25.2.1. Setting Locale for Login Shell<a class="anchor" href="#setting-locale"></a></h4>
<div class="paragraph">
<p>Locale settings are configured either in a user’s <span class="filename">~/.login_conf</span> or in the startup file of the user’s shell: <span class="filename">~/.profile</span>, <span class="filename">~/.bashrc</span>, or <span class="filename">~/.cshrc</span>.</p>
</div>
<div class="paragraph">
<p>Two environment variables should be set:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>LANG</code>, which sets the locale</p>
</li>
<li>
<p><code>MM_CHARSET</code>, which sets the MIME character set used by applications</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In addition to the user’s shell configuration, these variables should also be set for specific application configuration and Xorg configuration.</p>
</div>
<div class="paragraph">
<p>Two methods are available for making the needed variable assignments: the <a href="#login-class">login class</a> method, which is the recommended method, and the <a href="#startup-file">startup file</a> method. The next two sections demonstrate how to use both methods.</p>
</div>
<div class="sect4">
<h5 id="login-class">25.2.1.1. Login Classes Method<a class="anchor" href="#login-class"></a></h5>
<div class="paragraph">
<p>This first method is the recommended method as it assigns the required environment variables for locale name and MIME character sets for every possible shell. This setup can either be performed by each user or it can be configured for all users by the superuser.</p>
</div>
<div class="paragraph">
<p>This minimal example sets both variables for Latin-1 encoding in the <span class="filename">.login_conf</span> of an individual user’s home directory:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>me:\
	:charset=ISO-8859-1:\
	:lang=de_DE.ISO8859-1:</pre>
</div>
</div>
<div class="paragraph">
<p>Here is an example of a user’s <span class="filename">~/.login_conf</span> that sets the variables for Traditional Chinese in BIG-5 encoding. More variables are needed because some applications do not correctly respect locale variables for Chinese, Japanese, and Korean:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>#Users who do not wish to use monetary units or time formats
#of Taiwan can manually change each variable
me:\
	:lang=zh_TW.Big5:\
	:setenv=LC_ALL=zh_TW.Big5,LC_COLLATE=zh_TW.Big5,LC_CTYPE=zh_TW.Big5,LC_MESSAGES=zh_TW.Big5,LC_MONETARY=zh_TW.Big5,LC_NUMERIC=zh_TW.Big5,LC_TIME=zh_TW.Big5:\
	:charset=big5:\
	:xmodifiers=&#34;@im=gcin&#34;: #Set gcin as the XIM Input Server</pre>
</div>
</div>
<div class="paragraph">
<p>Alternately, the superuser can configure all users of the system for localization. The following variables in <span class="filename">/etc/login.conf</span> are used to set the locale and MIME character set:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>language_name|Account Type Description:\
	:charset=MIME_charset:\
	:lang=locale_name:\
	:tc=default:</pre>
</div>
</div>
<div class="paragraph">
<p>So, the previous Latin-1 example would look like this:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>german|German Users Accounts:\
	:charset=ISO-8859-1:\
	:lang=de_DE.ISO8859-1:\
	:tc=default:</pre>
</div>
</div>
<div class="paragraph">
<p>See <a href="https://man.freebsd.org/cgi/man.cgi?query=login.conf&amp;sektion=5&amp;format=html">login.conf(5)</a> for more details about these variables. Note that it already contains pre-defined <em>russian</em> class.</p>
</div>
<div class="paragraph">
<p>Whenever <span class="filename">/etc/login.conf</span> is edited, remember to execute the following command to update the capability database:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># cap_mkdb /etc/login.conf</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>For an end user, the <code>cap_mkdb</code> command will need to be run on their <span class="filename">~/.login_conf</span> for any changes to take effect.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="sect5">
<h6 id="_utilities_which_change_login_classes">25.2.1.1.1. Utilities Which Change Login Classes<a class="anchor" href="#_utilities_which_change_login_classes"></a></h6>
<div class="paragraph">
<p>In addition to manually editing <span class="filename">/etc/login.conf</span>, several utilities are available for setting the locale for newly created users.</p>
</div>
<div class="paragraph">
<p>When using <code>vipw</code> to add new users, specify the <em>language</em> to set the locale:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>user:password:1111:11:language:0:0:User Name:/home/user:/bin/sh</pre>
</div>
</div>
<div class="paragraph">
<p>When using <code>adduser</code> to add new users, the default language can be pre-configured for all new users or specified for an individual user.</p>
</div>
<div class="paragraph">
<p>If all new users use the same language, set <code>defaultclass=<em>language</em></code> in <span class="filename">/etc/adduser.conf</span>.</p>
</div>
<div class="paragraph">
<p>To override this setting when creating a user, either input the required locale at this prompt:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">Enter login class: default <span class="o">[]</span>:</code></pre>
</div>
</div>
<div class="paragraph">
<p>or specify the locale to set when invoking <code>adduser</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># adduser -class language</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If <code>pw</code> is used to add new users, specify the locale as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pw useradd user_name -L language</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To change the login class of an existing user, <code>chpass</code> can be used. Invoke it as superuser and provide the username to edit as the argument.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># chpass user_name</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="startup-file">25.2.1.2. Shell Startup File Method<a class="anchor" href="#startup-file"></a></h5>
<div class="paragraph">
<p>This second method is not recommended as each shell that is used requires manual configuration, where each shell has a different configuration file and differing syntax. As an example, to set the German language for the <code>sh</code> shell, these lines could be added to <span class="filename">~/.profile</span> to set the shell for that user only. These lines could also be added to <span class="filename">/etc/profile</span> or <span class="filename">/usr/share/skel/dot.profile</span> to set that shell for all users:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>LANG=de_DE.ISO8859-1; export LANG
MM_CHARSET=ISO-8859-1; export MM_CHARSET</pre>
</div>
</div>
<div class="paragraph">
<p>However, the name of the configuration file and the syntax used differs for the <code>csh</code> shell. These are the equivalent settings for <span class="filename">~/.login</span>, <span class="filename">/etc/csh.login</span>, or <span class="filename">/usr/share/skel/dot.login</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>setenv LANG de_DE.ISO8859-1
setenv MM_CHARSET ISO-8859-1</pre>
</div>
</div>
<div class="paragraph">
<p>To complicate matters, the syntax needed to configure Xorg in <span class="filename">~/.xinitrc</span> also depends upon the shell. The first example is for the <code>sh</code> shell and the second is for the <code>csh</code> shell:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>LANG=de_DE.ISO8859-1; export LANG</pre>
</div>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>setenv LANG de_DE.ISO8859-1</pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="setting-console">25.2.2. Console Setup<a class="anchor" href="#setting-console"></a></h4>
<div class="paragraph">
<p>Several localized fonts are available for the console. To see a listing of available fonts, type <code>ls /usr/share/syscons/fonts</code>. To configure the console font, specify the <em>font_name</em>, without the <span class="filename">.fnt</span> suffix, in <span class="filename">/etc/rc.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>font8x16=font_name
font8x14=font_name
font8x8=font_name</pre>
</div>
</div>
<div class="paragraph">
<p>The keymap and screenmap can be set by adding the following to <span class="filename">/etc/rc.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>scrnmap=screenmap_name
keymap=keymap_name
keychange=&#34;fkey_number sequence&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>To see the list of available screenmaps, type <code>ls /usr/share/syscons/scrnmaps</code>. Do not include the <span class="filename">.scm</span> suffix when specifying <em>screenmap_name</em>. A screenmap with a corresponding mapped font is usually needed as a workaround for expanding bit 8 to bit 9 on a VGA adapter’s font character matrix so that letters are moved out of the pseudographics area if the screen font uses a bit 8 column.</p>
</div>
<div class="paragraph">
<p>To see the list of available keymaps, type <code>ls /usr/share/syscons/keymaps</code>. When specifying the <em>keymap_name</em>, do not include the <span class="filename">.kbd</span> suffix. To test keymaps without rebooting, use <a href="https://man.freebsd.org/cgi/man.cgi?query=kbdmap&amp;sektion=1&amp;format=html">kbdmap(1)</a>.</p>
</div>
<div class="paragraph">
<p>The <code>keychange</code> entry is usually needed to program function keys to match the selected terminal type because function key sequences cannot be defined in the keymap.</p>
</div>
<div class="paragraph">
<p>Next, set the correct console terminal type in <span class="filename">/etc/ttys</span> for all virtual terminal entries. <a href="#locale-charset">Defined Terminal Types for Character Sets</a> summarizes the available terminal types.:</p>
</div>
<table id="locale-charset" class="tableblock frame-none grid-all stretch">
<caption class="title">表 34. Defined Terminal Types for Character Sets</caption>
<colgroup>
<col style="width: 50%;"/>
<col style="width: 50%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Character Set</th>
<th class="tableblock halign-left valign-top">Terminal Type</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ISO8859-1 or ISO8859-15</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>cons25l1</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ISO8859-2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>cons25l2</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ISO8859-7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>cons25l7</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">KOI8-R</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>cons25r</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">KOI8-U</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>cons25u</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CP437 (VGA default)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>cons25</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">US-ASCII</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>cons25w</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>For languages with wide or multibyte characters, install a console for that language from the FreeBSD Ports Collection. The available ports are summarized in <a href="#locale-console">Available Console from Ports Collection</a>. Once installed, refer to the port’s <span class="filename">pkg-message</span> or man pages for configuration and usage instructions.</p>
</div>
<table id="locale-console" class="tableblock frame-none grid-all stretch">
<caption class="title">表 35. Available Console from Ports Collection</caption>
<colgroup>
<col style="width: 50%;"/>
<col style="width: 50%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Language</th>
<th class="tableblock halign-left valign-top">Port Location</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Traditional Chinese (BIG-5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a class="package" href="https://cgit.freebsd.org/ports/tree/chinese/big5con/">chinese/big5con</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Chinese/Japanese/Korean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a class="package" href="https://cgit.freebsd.org/ports/tree/chinese/cce/">chinese/cce</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Chinese/Japanese/Korean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a class="package" href="https://cgit.freebsd.org/ports/tree/chinese/zhcon/">chinese/zhcon</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Japanese</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a class="package" href="https://cgit.freebsd.org/ports/tree/chinese/kon2/">chinese/kon2</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Japanese</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a class="package" href="https://cgit.freebsd.org/ports/tree/japanese/kon2-14dot/">japanese/kon2-14dot</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Japanese</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a class="package" href="https://cgit.freebsd.org/ports/tree/japanese/kon2-16dot/">japanese/kon2-16dot</a></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>If moused is enabled in <span class="filename">/etc/rc.conf</span>, additional configuration may be required. By default, the mouse cursor of the <a href="https://man.freebsd.org/cgi/man.cgi?query=syscons&amp;sektion=4&amp;format=html">syscons(4)</a> driver occupies the <code>0xd0</code>-<code>0xd3</code> range in the character set. If the language uses this range, move the cursor’s range by adding the following line to <span class="filename">/etc/rc.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>mousechar_start=3</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_xorg_setup">25.2.3. Xorg Setup<a class="anchor" href="#_xorg_setup"></a></h4>
<div class="paragraph">
<p><a href="./#x11">The X Window System</a> describes how to install and configure Xorg. When configuring Xorg for localization, additional fonts and input methods are available from the FreeBSD Ports Collection. Application specific i18n settings such as fonts and menus can be tuned in <span class="filename">~/.Xresources</span> and should allow users to view their selected language in graphical application menus.</p>
</div>
<div class="paragraph">
<p>The X Input Method (XIM) protocol is an Xorg standard for inputting non-English characters. <a href="#locale-xim">Available Input Methods</a> summarizes the input method applications which are available in the FreeBSD Ports Collection. Additional Fcitx and Uim applications are also available.</p>
</div>
<table id="locale-xim" class="tableblock frame-none grid-all stretch">
<caption class="title">表 36. Available Input Methods</caption>
<colgroup>
<col style="width: 50%;"/>
<col style="width: 50%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Language</th>
<th class="tableblock halign-left valign-top">Input Method</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Chinese</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a class="package" href="https://cgit.freebsd.org/ports/tree/chinese/gcin/">chinese/gcin</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Chinese</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a class="package" href="https://cgit.freebsd.org/ports/tree/chinese/ibus-chewing/">chinese/ibus-chewing</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Chinese</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a class="package" href="https://cgit.freebsd.org/ports/tree/chinese/ibus-pinyin/">chinese/ibus-pinyin</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Chinese</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a class="package" href="https://cgit.freebsd.org/ports/tree/chinese/oxim/">chinese/oxim</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Chinese</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a class="package" href="https://cgit.freebsd.org/ports/tree/chinese/scim-fcitx/">chinese/scim-fcitx</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Chinese</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a class="package" href="https://cgit.freebsd.org/ports/tree/chinese/scim-pinyin/">chinese/scim-pinyin</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Chinese</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a class="package" href="https://cgit.freebsd.org/ports/tree/chinese/scim-tables/">chinese/scim-tables</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Japanese</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a class="package" href="https://cgit.freebsd.org/ports/tree/japanese/ibus-anthy/">japanese/ibus-anthy</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Japanese</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a class="package" href="https://cgit.freebsd.org/ports/tree/japanese/ibus-mozc/">japanese/ibus-mozc</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Japanese</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a class="package" href="https://cgit.freebsd.org/ports/tree/japanese/ibus-skk/">japanese/ibus-skk</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Japanese</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a class="package" href="https://cgit.freebsd.org/ports/tree/japanese/im-ja/">japanese/im-ja</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Japanese</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a class="package" href="https://cgit.freebsd.org/ports/tree/japanese/kinput2/">japanese/kinput2</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Japanese</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a class="package" href="https://cgit.freebsd.org/ports/tree/japanese/scim-anthy/">japanese/scim-anthy</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Japanese</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a class="package" href="https://cgit.freebsd.org/ports/tree/japanese/scim-canna/">japanese/scim-canna</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Japanese</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a class="package" href="https://cgit.freebsd.org/ports/tree/japanese/scim-honoka/">japanese/scim-honoka</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Japanese</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a class="package" href="https://cgit.freebsd.org/ports/tree/japanese/scim-honoka-plugin-romkan/">japanese/scim-honoka-plugin-romkan</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Japanese</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a class="package" href="https://cgit.freebsd.org/ports/tree/japanese/scim-honoka-plugin-wnn/">japanese/scim-honoka-plugin-wnn</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Japanese</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a class="package" href="https://cgit.freebsd.org/ports/tree/japanese/scim-prime/">japanese/scim-prime</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Japanese</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a class="package" href="https://cgit.freebsd.org/ports/tree/japanese/scim-skk/">japanese/scim-skk</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Japanese</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a class="package" href="https://cgit.freebsd.org/ports/tree/japanese/scim-tables/">japanese/scim-tables</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Japanese</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a class="package" href="https://cgit.freebsd.org/ports/tree/japanese/scim-tomoe/">japanese/scim-tomoe</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Japanese</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a class="package" href="https://cgit.freebsd.org/ports/tree/japanese/scim-uim/">japanese/scim-uim</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Japanese</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a class="package" href="https://cgit.freebsd.org/ports/tree/japanese/skkinput/">japanese/skkinput</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Japanese</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a class="package" href="https://cgit.freebsd.org/ports/tree/japanese/skkinput3/">japanese/skkinput3</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Japanese</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a class="package" href="https://cgit.freebsd.org/ports/tree/japanese/uim-anthy/">japanese/uim-anthy</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Korean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a class="package" href="https://cgit.freebsd.org/ports/tree/korean/ibus-hangul/">korean/ibus-hangul</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Korean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a class="package" href="https://cgit.freebsd.org/ports/tree/korean/imhangul/">korean/imhangul</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Korean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a class="package" href="https://cgit.freebsd.org/ports/tree/korean/nabi/">korean/nabi</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Korean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a class="package" href="https://cgit.freebsd.org/ports/tree/korean/scim-hangul/">korean/scim-hangul</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Korean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a class="package" href="https://cgit.freebsd.org/ports/tree/korean/scim-tables/">korean/scim-tables</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Vietnamese</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a class="package" href="https://cgit.freebsd.org/ports/tree/vietnamese/xvnkb/">vietnamese/xvnkb</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Vietnamese</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a class="package" href="https://cgit.freebsd.org/ports/tree/vietnamese/x-unikey/">vietnamese/x-unikey</a></p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect2">
<h3 id="l10n-compiling">25.3. Finding i18n Applications<a class="anchor" href="#l10n-compiling"></a></h3>
<div class="paragraph">
<p>i18n applications are programmed using i18n kits under libraries. These allow developers to write a simple file and translate displayed menus and texts to each language.</p>
</div>
<div class="paragraph">
<p>The <a href="https://www.FreeBSD.org/ports/">FreeBSD Ports Collection</a> contains many applications with built-in support for wide or multibyte characters for several languages. Such applications include <code>i18n</code> in their names for easy identification. However, they do not always support the language needed.</p>
</div>
<div class="paragraph">
<p>Some applications can be compiled with the specific charset. This is usually done in the port’s <span class="filename">Makefile</span> or by passing a value to configure. Refer to the i18n documentation in the respective FreeBSD port’s source for more information on how to determine the needed configure value or the port’s <span class="filename">Makefile</span> to determine which compile options to use when building the port.</p>
</div>
</div>
<div class="sect2">
<h3 id="lang-setup">25.4. Locale Configuration for Specific Languages<a class="anchor" href="#lang-setup"></a></h3>
<div class="paragraph">
<p>This section provides configuration examples for localizing a FreeBSD system for the Russian language. It then provides some additional resources for localizing other languages.</p>
</div>
<div class="sect3">
<h4 id="ru-localize">25.4.1. Russian Language (KOI8-R Encoding)<a class="anchor" href="#ru-localize"></a></h4>
<div class="paragraph">
<p>This section shows the specific settings needed to localize a FreeBSD system for the Russian language. Refer to <a href="#using-localization">Using Localization</a> for a more complete description of each type of setting.</p>
</div>
<div class="paragraph">
<p>To set this locale for the login shell, add the following lines to each user’s <span class="filename">~/.login_conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>me:My Account:\
	:charset=KOI8-R:\
	:lang=ru_RU.KOI8-R:</pre>
</div>
</div>
<div class="paragraph">
<p>To configure the console, add the following lines to <span class="filename">/etc/rc.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>keymap=&#34;ru.utf-8&#34;
scrnmap=&#34;utf-82cp866&#34;
font8x16=&#34;cp866b-8x16&#34;
font8x14=&#34;cp866-8x14&#34;
font8x8=&#34;cp866-8x8&#34;
mousechar_start=3</pre>
</div>
</div>
<div class="paragraph">
<p>For each <code>ttyv</code> entry in <span class="filename">/etc/ttys</span>, use <code>cons25r</code> as the terminal type.</p>
</div>
<div class="paragraph">
<p>To configure printing, a special output filter is needed to convert from KOI8-R to CP866 since most printers with Russian characters come with hardware code page CP866. FreeBSD includes a default filter for this purpose, <span class="filename">/usr/libexec/lpr/ru/koi2alt</span>. To use this filter, add this entry to <span class="filename">/etc/printcap</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>lp|Russian local line printer:\
	:sh:of=/usr/libexec/lpr/ru/koi2alt:\
	:lp=/dev/lpt0:sd=/var/spool/output/lpd:lf=/var/log/lpd-errs:</pre>
</div>
</div>
<div class="paragraph">
<p>Refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=printcap&amp;sektion=5&amp;format=html">printcap(5)</a> for a more detailed explanation.</p>
</div>
<div class="paragraph">
<p>To configure support for Russian filenames in mounted MS-DOS® file systems, include <code>-L</code> and the locale name when adding an entry to <span class="filename">/etc/fstab</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>/dev/ad0s2      /dos/c  msdos   rw,-Lru_RU.KOI8-R 0 0</pre>
</div>
</div>
<div class="paragraph">
<p>Refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=mount_msdosfs&amp;sektion=8&amp;format=html">mount_msdosfs(8)</a> for more details.</p>
</div>
<div class="paragraph">
<p>To configure Russian fonts for Xorg, install the <a class="package" href="https://cgit.freebsd.org/ports/tree/x11-fonts/xorg-fonts-cyrillic/">x11-fonts/xorg-fonts-cyrillic</a> package. Then, check the <code>&#34;Files&#34;</code> section in <span class="filename">/etc/X11/xorg.conf</span>. The following line must be added <em>before</em> any other <code>FontPath</code> entries:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>FontPath   &#34;/usr/local/lib/X11/fonts/cyrillic&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>Additional Cyrillic fonts are available in the Ports Collection.</p>
</div>
<div class="paragraph">
<p>To activate a Russian keyboard, add the following to the <code>&#34;Keyboard&#34;</code> section of <span class="filename">/etc/xorg.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>Option &#34;XkbLayout&#34;   &#34;us,ru&#34;
Option &#34;XkbOptions&#34;  &#34;grp:toggle&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>Make sure that <code>XkbDisable</code> is commented out in that file.</p>
</div>
<div class="paragraph">
<p>For <code>grp:toggle</code> use <kbd>Right Alt</kbd>, for <code>grp:ctrl_shift_toggle</code> use <span class="keyseq"><kbd>Ctrl</kbd>+<kbd>Shift</kbd></span>. For <code>grp:caps_toggle</code> use <kbd>CapsLock</kbd>. The old <kbd>CapsLock</kbd> function is still available in LAT mode only using <span class="keyseq"><kbd>Shift</kbd>+<kbd>CapsLock</kbd></span>. <code>grp:caps_toggle</code> does not work in Xorg for some unknown reason.</p>
</div>
<div class="paragraph">
<p>If the keyboard has &#34;Windows®&#34; keys, and some non-alphabetical keys are mapped incorrectly, add the following line to <span class="filename">/etc/xorg.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>Option &#34;XkbVariant&#34; &#34;,winkeys&#34;</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The Russian XKB keyboard may not work with non-localized applications. Minimally localized applications should call a <code>XtSetLanguageProc (NULL, NULL, NULL);</code> function early in the program.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>See <a href="http://koi8.pp.ru/xwin.html">http://koi8.pp.ru/xwin.html</a> for more instructions on localizing Xorg applications. For more general information about KOI8-R encoding, refer to <a href="http://koi8.pp.ru/">http://koi8.pp.ru/</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_additional_language_specific_resources">25.4.2. Additional Language-Specific Resources<a class="anchor" href="#_additional_language_specific_resources"></a></h4>
<div class="paragraph">
<p>This section lists some additional resources for configuring other locales.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Traditional Chinese for Taiwan</dt>
<dd>
<p>The FreeBSD-Taiwan Project has a Chinese HOWTO for FreeBSD at <a href="http://netlab.cse.yzu.edu.tw/~statue/freebsd/zh-tut/">http://netlab.cse.yzu.edu.tw/~statue/freebsd/zh-tut/</a>.</p>
</dd>
<dt class="hdlist1">Greek Language Localization</dt>
<dd>
<p>A complete article on Greek support in FreeBSD is available <a href="https://www.FreeBSD.org/doc/gr/articles/greek-language-support/">here</a>, in Greek only, as part of the official FreeBSD Greek documentation.</p>
</dd>
<dt class="hdlist1">Japanese and Korean Language Localization</dt>
<dd>
<p>For Japanese, refer to <a href="http://www.jp.FreeBSD.org/">http://www.jp.FreeBSD.org/</a>, and for Korean, refer to <a href="http://www.kr.FreeBSD.org/">http://www.kr.FreeBSD.org/</a>.</p>
</dd>
<dt class="hdlist1">Non-English FreeBSD Documentation</dt>
<dd>
<p>Some FreeBSD contributors have translated parts of the FreeBSD documentation to other languages. They are available through links on the <a href="https://www.FreeBSD.org/">FreeBSD web site</a> or in <span class="filename">/usr/share/doc</span>.</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="updating-upgrading">Chapter 26. Updating and Upgrading FreeBSD<a class="anchor" href="#updating-upgrading"></a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="updating-upgrading-synopsis">26.1. Synopsis<a class="anchor" href="#updating-upgrading-synopsis"></a></h3>
<div class="paragraph">
<p>FreeBSD is under constant development between releases. Some people prefer to use the officially released versions, while others prefer to keep in sync with the latest developments. However, even official releases are often updated with security and other critical fixes. Regardless of the version used, FreeBSD provides all the necessary tools to keep the system updated, and allows for easy upgrades between versions. This chapter describes how to track the development system and the basic tools for keeping a FreeBSD system up-to-date.</p>
</div>
<div class="paragraph">
<p>After reading this chapter, you will know:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>How to keep a FreeBSD system up-to-date with freebsd-update or Git.</p>
</li>
<li>
<p>How to compare the state of an installed system against a known pristine copy.</p>
</li>
<li>
<p>How to keep the installed documentation up-to-date with Git or documentation ports.</p>
</li>
<li>
<p>The difference between the two development branches: FreeBSD-STABLE and FreeBSD-CURRENT.</p>
</li>
<li>
<p>How to rebuild and reinstall the entire base system.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Before reading this chapter, you should:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Properly set up the network connection (<a href="./#advanced-networking">Advanced Networking</a>).</p>
</li>
<li>
<p>Know how to install additional third-party software (<a href="./#ports">Installing Applications: Packages and Ports</a>).</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Throughout this chapter, <code>git</code> is used to obtain and update FreeBSD sources. Optionally, the <a class="package" href="https://cgit.freebsd.org/ports/tree/devel/git/">devel/git</a> port or package may be used.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect2">
<h3 id="updating-upgrading-freebsdupdate">26.2. FreeBSD Update<a class="anchor" href="#updating-upgrading-freebsdupdate"></a></h3>
<div class="paragraph">
<p>Applying security patches in a timely manner and upgrading to a newer release of an operating system are important aspects of ongoing system administration. FreeBSD includes a utility called <code>freebsd-update</code> which can be used to perform both these tasks.</p>
</div>
<div class="paragraph">
<p>This utility supports binary security and errata updates to FreeBSD, without the need to manually compile and install the patch or a new kernel. Binary updates are available for all architectures and releases currently supported by the security team. The list of supported releases and their estimated end-of-life dates are listed at <a href="https://www.FreeBSD.org/security/">https://www.FreeBSD.org/security/</a>.</p>
</div>
<div class="paragraph">
<p>This utility also supports operating system upgrades to minor point releases as well as upgrades to another release branch. Before upgrading to a new release, review its release announcement as it contains important information pertinent to the release. Release announcements are available from <a href="https://www.FreeBSD.org/releases/">https://www.FreeBSD.org/releases/</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If a <a href="https://man.freebsd.org/cgi/man.cgi?query=crontab&amp;sektion=5&amp;format=html">crontab(5)</a> utilizing the features of <a href="https://man.freebsd.org/cgi/man.cgi?query=freebsd-update&amp;sektion=8&amp;format=html">freebsd-update(8)</a> exists, it must be disabled before upgrading the operating system.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>This section describes the configuration file used by <code>freebsd-update</code>, demonstrates how to apply a security patch and how to upgrade to a minor or major operating system release, and discusses some of the considerations when upgrading the operating system.</p>
</div>
<div class="sect3">
<h4 id="freebsdupdate-config-file">26.2.1. The Configuration File<a class="anchor" href="#freebsdupdate-config-file"></a></h4>
<div class="paragraph">
<p>The default configuration file for <code>freebsd-update</code> works as-is. Some users may wish to tweak the default configuration in <span class="filename">/etc/freebsd-update.conf</span>, allowing better control of the process. The comments in this file explain the available options, but the following may require a bit more explanation:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre># Components of the base system which should be kept updated.
Components world kernel</pre>
</div>
</div>
<div class="paragraph">
<p>This parameter controls which parts of FreeBSD will be kept up-to-date. The default is to update the entire base system and the kernel. Individual components can instead be specified, such as <code>src/base</code> or <code>src/sys</code>. However, the best option is to leave this at the default as changing it to include specific items requires every needed item to be listed. Over time, this could have disastrous consequences as source code and binaries may become out of sync.</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre># Paths which start with anything matching an entry in an IgnorePaths
# statement will be ignored.
IgnorePaths /boot/kernel/linker.hints</pre>
</div>
</div>
<div class="paragraph">
<p>To leave specified directories, such as <span class="filename">/bin</span> or <span class="filename">/sbin</span>, untouched during the update process, add their paths to this statement. This option may be used to prevent <code>freebsd-update</code> from overwriting local modifications.</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre># Paths which start with anything matching an entry in an UpdateIfUnmodified
# statement will only be updated if the contents of the file have not been
# modified by the user (unless changes are merged; see below).
UpdateIfUnmodified /etc/ /var/ /root/ /.cshrc /.profile</pre>
</div>
</div>
<div class="paragraph">
<p>This option will only update unmodified configuration files in the specified directories. Any changes made by the user will prevent the automatic updating of these files. There is another option, <code>KeepModifiedMetadata</code>, which will instruct <code>freebsd-update</code> to save the changes during the merge.</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre># When upgrading to a new FreeBSD release, files which match MergeChanges
# will have any local changes merged into the version from the new release.
MergeChanges /etc/ /var/named/etc/ /boot/device.hints</pre>
</div>
</div>
<div class="paragraph">
<p>List of directories with configuration files that <code>freebsd-update</code> should attempt to merge. The file merge process is a series of <a href="https://man.freebsd.org/cgi/man.cgi?query=diff&amp;sektion=1&amp;format=html">diff(1)</a> patches similar to <a href="https://man.freebsd.org/cgi/man.cgi?query=mergemaster&amp;sektion=8&amp;format=html">mergemaster(8)</a>, but with fewer options. Merges are either accepted, open an editor, or cause <code>freebsd-update</code> to abort. When in doubt, backup <span class="filename">/etc</span> and just accept the merges. See <a href="https://man.freebsd.org/cgi/man.cgi?query=mergemaster&amp;sektion=8&amp;format=html">mergemaster(8)</a> for more information about <code>mergemaster</code>.</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre># Directory in which to store downloaded updates and temporary
# files used by FreeBSD Update.
# WorkDir /var/db/freebsd-update</pre>
</div>
</div>
<div class="paragraph">
<p>This directory is where all patches and temporary files are placed. In cases where the user is doing a version upgrade, this location should have at least a gigabyte of disk space available.</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre># When upgrading between releases, should the list of Components be
# read strictly (StrictComponents yes) or merely as a list of components
# which *might* be installed of which FreeBSD Update should figure out
# which actually are installed and upgrade those (StrictComponents no)?
# StrictComponents no</pre>
</div>
</div>
<div class="paragraph">
<p>When this option is set to <code>yes</code>, <code>freebsd-update</code> will assume that the <code>Components</code> list is complete and will not attempt to make changes outside of the list. Effectively, <code>freebsd-update</code> will attempt to update every file which belongs to the <code>Components</code> list.</p>
</div>
<div class="paragraph">
<p>Refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=freebsd-update.conf&amp;sektion=5&amp;format=html">freebsd-update.conf(5)</a> for more details.</p>
</div>
</div>
<div class="sect3">
<h4 id="freebsdupdate-security-patches">26.2.2. Applying Security Patches<a class="anchor" href="#freebsdupdate-security-patches"></a></h4>
<div class="paragraph">
<p>The process of applying FreeBSD security patches has been simplified, allowing an administrator to keep a system fully patched using <code>freebsd-update</code>. More information about FreeBSD security advisories can be found in <a href="./#security-advisories">FreeBSD Security Advisories</a>.</p>
</div>
<div class="paragraph">
<p>FreeBSD security patches may be downloaded and installed using the following commands. The first command will determine if any outstanding patches are available, and if so, will list the files that will be modifed if the patches are applied. The second command will apply the patches.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># freebsd-update fetch</span>
<span class="c"># freebsd-update install</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If the update applies any kernel patches, the system will need a reboot in order to boot into the patched kernel. If the patch was applied to any running binaries, the affected applications should be restarted so that the patched version of the binary is used.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Usually, the user needs to be prepared to reboot the system. To know if the system requires a reboot due to a kernel update, execute the commands <code>freebsd-version -k</code> and <code>uname -r</code>. Reboot the system if the outputs differ.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>The system can be configured to automatically check for updates once every day by adding this entry to <span class="filename">/etc/crontab</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>@daily                                  root    freebsd-update cron</pre>
</div>
</div>
<div class="paragraph">
<p>If patches exist, they will automatically be downloaded but will not be applied. The <code>root</code> user will be sent an email so that the patches may be reviewed and manually installed with <code>freebsd-update install</code>.</p>
</div>
<div class="paragraph">
<p>If anything goes wrong, <code>freebsd-update</code> has the ability to roll back the last set of changes with the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># freebsd-update rollback</span>
Uninstalling updates... <span class="k">done</span>.</code></pre>
</div>
</div>
<div class="paragraph">
<p>Again, the system should be restarted if the kernel or any kernel modules were modified and any affected binaries should be restarted.</p>
</div>
<div class="paragraph">
<p>Only the <span class="filename">GENERIC</span> kernel can be automatically updated by <code>freebsd-update</code>. If a custom kernel is installed, it will have to be rebuilt and reinstalled after <code>freebsd-update</code> finishes installing the updates. The default kernel name is <em>GENERIC</em>. The <a href="https://man.freebsd.org/cgi/man.cgi?query=uname&amp;sektion=1&amp;format=html">uname(1)</a> command may be used to verify its installation.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Always keep a copy of the <span class="filename">GENERIC</span> kernel in <span class="filename">/boot/GENERIC</span>. It will be helpful in diagnosing a variety of problems and in performing version upgrades. Refer to <a href="#freebsd-update-custom-kernel-9x">Custom Kernels with FreeBSD 9.X and Later</a> for instructions on how to get a copy of the <span class="filename">GENERIC</span> kernel.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Unless the default configuration in <span class="filename">/etc/freebsd-update.conf</span> has been changed, <code>freebsd-update</code> will install the updated kernel sources along with the rest of the updates. Rebuilding and reinstalling a new custom kernel can then be performed in the usual way.</p>
</div>
<div class="paragraph">
<p>The updates distributed by <code>freebsd-update</code> do not always involve the kernel. It is not necessary to rebuild a custom kernel if the kernel sources have not been modified by <code>freebsd-update install</code>. However, <code>freebsd-update</code> will always update <span class="filename">/usr/src/sys/conf/newvers.sh</span>. The current patch level, as indicated by the <code>-p</code> number reported by <code>uname -r</code>, is obtained from this file. Rebuilding a custom kernel, even if nothing else changed, allows <code>uname</code> to accurately report the current patch level of the system. This is particularly helpful when maintaining multiple systems, as it allows for a quick assessment of the updates installed in each one.</p>
</div>
</div>
<div class="sect3">
<h4 id="freebsdupdate-upgrade">26.2.3. Performing Minor and Major Version Upgrades<a class="anchor" href="#freebsdupdate-upgrade"></a></h4>
<div class="paragraph">
<p>Upgrades from one minor version of FreeBSD to another are called <em>minor version</em> upgrades. An example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>FreeBSD 13.1 to 13.2.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><em>Major version</em> upgrades increase the major version number. An example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>FreeBSD 13.2 to 14.0.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Both types of upgrade can be performed by providing <code>freebsd-update</code> with a release version target.</p>
</div>
<div class="admonitionblock warning">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>After each new <code>RELEASE</code>, FreeBSD package build servers will, for a limited period, <strong>not</strong> use the newer version of the operating system. This provides continuity for the many users who do not upgrade immediately after a release announcement. For example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>packages for users of 13.1 and 13.2 will be built on a server running 13.1, until 13.1 reaches end of life</p>
</li>
</ul>
</div>
<div class="paragraph">
<p> — and, critically:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a kernel module that is built on 13.1 might <strong>not</strong> be suitable for 13.2.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>So, with any minor or major OS upgrade, if your package requirements include any kernel module:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>be prepared to build the module from source</strong>.</p>
</li>
</ul>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If the system is running a custom kernel, make sure that a copy of the <span class="filename">GENERIC</span> kernel exists in <span class="filename">/boot/GENERIC</span> before starting the upgrade. Refer to <a href="#freebsd-update-custom-kernel-9x">Custom Kernels with FreeBSD 9.X and Later</a> for instructions on how to get a copy of the <span class="filename">GENERIC</span> kernel.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>The following command, when run on a FreeBSD 13.1 system, will upgrade it to FreeBSD 13.2:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># freebsd-update -r 13.2-RELEASE upgrade</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>After the command has been received, <code>freebsd-update</code> will evaluate the configuration file and current system in an attempt to gather the information necessary to perform the upgrade. A screen listing will display which components have and have not been detected. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">Looking up update.FreeBSD.org mirrors... 1 mirrors found.
Fetching metadata signature <span class="k">for </span>13.1-RELEASE from update1.FreeBSD.org... <span class="k">done</span>.
Fetching metadata index... <span class="k">done</span>.
Inspecting system... <span class="k">done</span>.

The following components of FreeBSD seem to be installed:
kernel/smp src/base src/bin src/contrib src/crypto src/etc src/games
src/gnu src/include src/krb5 src/lib src/libexec src/release src/rescue
src/sbin src/secure src/share src/sys src/tools src/ubin src/usbin
world/base world/info world/lib32 world/manpages

The following components of FreeBSD <span class="k">do </span>not seem to be installed:
kernel/generic world/catpages world/dict world/doc world/games
world/proflibs

Does this look reasonable <span class="o">(</span>y/n<span class="o">)</span>? y</code></pre>
</div>
</div>
<div class="paragraph">
<p>At this point, <code>freebsd-update</code> will attempt to download all files required for the upgrade. In some cases, the user may be prompted with questions regarding what to install or how to proceed.</p>
</div>
<div class="paragraph">
<p>When using a custom kernel, the above step will produce a warning similar to the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">WARNING: This system is running a <span class="s2">&#34;MYKERNEL&#34;</span> kernel, which is not a
kernel configuration distributed as part of FreeBSD 13.1-RELEASE.
This kernel will not be updated: you MUST update the kernel manually
before running <span class="s2">&#34;/usr/sbin/freebsd-update install&#34;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This warning may be safely ignored at this point. The updated <span class="filename">GENERIC</span> kernel will be used as an intermediate step in the upgrade process.</p>
</div>
<div class="paragraph">
<p>Once all the patches have been downloaded to the local system, they will be applied. This process may take a while, depending on the speed and workload of the machine. Configuration files will then be merged. The merging process requires some user intervention as a file may be merged or an editor may appear on screen for a manual merge. The results of every successful merge will be shown to the user as the process continues. A failed or ignored merge will cause the process to abort. Users may wish to make a backup of <span class="filename">/etc</span> and manually merge important files, such as <span class="filename">master.passwd</span> or <span class="filename">group</span> at a later time.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The system is not being altered yet as all patching and merging is happening in another directory. Once all patches have been applied successfully, all configuration files have been merged and it seems the process will go smoothly, the changes can be committed to disk by the user using the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># freebsd-update install</span></code></pre>
</div>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>The kernel and kernel modules will be patched first. If the system is running with a custom kernel, use <a href="https://man.freebsd.org/cgi/man.cgi?query=nextboot&amp;sektion=8&amp;format=html">nextboot(8)</a> to set the kernel for the next boot to the updated <span class="filename">/boot/GENERIC</span>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># nextboot -k GENERIC</span></code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Before rebooting with the <span class="filename">GENERIC</span> kernel, make sure it contains all the drivers required for the system to boot properly and connect to the network, if the machine being updated is accessed remotely. In particular, if the running custom kernel contains built-in functionality usually provided by kernel modules, make sure to temporarily load these modules into the <span class="filename">GENERIC</span> kernel using the <span class="filename">/boot/loader.conf</span> facility. It is recommended to disable non-essential services as well as any disk and network mounts until the upgrade process is complete.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>The machine should now be restarted with the updated kernel:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># shutdown -r now</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Once the system has come back online, restart <code>freebsd-update</code> using the following command. Since the state of the process has been saved, <code>freebsd-update</code> will not start from the beginning, but will instead move on to the next phase and remove all old shared libraries and object files.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># freebsd-update install</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Depending upon whether any library version numbers were bumped, there may only be two install phases instead of three.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>The upgrade is now complete. If this was a major version upgrade, reinstall all ports and packages as described in <a href="#freebsdupdate-portsrebuild">Upgrading Packages After a Major Version Upgrade</a>.</p>
</div>
<div class="sect4">
<h5 id="freebsd-update-custom-kernel-9x">26.2.3.1. Custom Kernels with FreeBSD 9.X and Later<a class="anchor" href="#freebsd-update-custom-kernel-9x"></a></h5>
<div class="paragraph">
<p>Before using <code>freebsd-update</code>, ensure that a copy of the <span class="filename">GENERIC</span> kernel exists in <span class="filename">/boot/GENERIC</span>. If a custom kernel has only been built once, the kernel in <span class="filename">/boot/kernel.old</span> is the <code>GENERIC</code> kernel. Simply rename this directory to <span class="filename">/boot/GENERIC</span>.</p>
</div>
<div class="paragraph">
<p>If a custom kernel has been built more than once or if it is unknown how many times the custom kernel has been built, obtain a copy of the <code>GENERIC</code> kernel that matches the current version of the operating system. If physical access to the system is available, a copy of the <code>GENERIC</code> kernel can be installed from the installation media:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># mount /cdrom</span>
<span class="c"># cd /cdrom/usr/freebsd-dist</span>
<span class="c"># tar -C/ -xvf kernel.txz boot/kernel/kernel</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternately, the <code>GENERIC</code> kernel may be rebuilt and installed from source:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># cd /usr/src</span>
<span class="c"># make kernel __MAKE_CONF=/dev/null SRCCONF=/dev/null</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For this kernel to be identified as the <code>GENERIC</code> kernel by <code>freebsd-update</code>, the <span class="filename">GENERIC</span> configuration file must not have been modified in any way. It is also suggested that the kernel is built without any other special options.</p>
</div>
<div class="paragraph">
<p>Rebooting into the <span class="filename">GENERIC</span> kernel is not required as <code>freebsd-update</code> only needs <span class="filename">/boot/GENERIC</span> to exist.</p>
</div>
</div>
<div class="sect4">
<h5 id="freebsdupdate-portsrebuild">26.2.3.2. Upgrading Packages After a Major Version Upgrade<a class="anchor" href="#freebsdupdate-portsrebuild"></a></h5>
<div class="paragraph">
<p>Generally, installed applications will continue to work without problems after minor version upgrades. Major versions use different Application Binary Interfaces (ABIs), which will break most third-party applications. After a major version upgrade, all installed packages and ports need to be upgraded. Packages can be upgraded using <code>pkg upgrade</code>. To upgrade installed ports, use a utility such as <a class="package" href="https://cgit.freebsd.org/ports/tree/ports-mgmt/portmaster/">ports-mgmt/portmaster</a>.</p>
</div>
<div class="paragraph">
<p>A forced upgrade of all installed packages will replace the packages with fresh versions from the repository even if the version number has not increased. This is required because of the ABI version change when upgrading between major versions of FreeBSD. The forced upgrade can be accomplished by performing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg-static upgrade -f</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A rebuild of all installed applications can be accomplished with this command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># portmaster -af</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This command will display the configuration screens for each application that has configurable options and wait for the user to interact with those screens. To prevent this behavior, and use only the default options, include <code>-G</code> in the above command.</p>
</div>
<div class="paragraph">
<p>Once the software upgrades are complete, finish the upgrade process with a final call to <code>freebsd-update</code> in order to tie up all the loose ends in the upgrade process:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># freebsd-update install</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If the <span class="filename">GENERIC</span> kernel was temporarily used, this is the time to build and install a new custom kernel using the instructions in <a href="./#kernelconfig">Configuring the FreeBSD Kernel</a>.</p>
</div>
<div class="paragraph">
<p>Reboot the machine into the new FreeBSD version. The upgrade process is now complete.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="freebsdupdate-system-comparison">26.2.4. System State Comparison<a class="anchor" href="#freebsdupdate-system-comparison"></a></h4>
<div class="paragraph">
<p>The state of the installed FreeBSD version against a known good copy can be tested using <code>freebsd-update IDS</code>. This command evaluates the current version of system utilities, libraries, and configuration files and can be used as a built-in Intrusion Detection System (IDS).</p>
</div>
<div class="admonitionblock warning">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This command is not a replacement for a real IDS such as <a class="package" href="https://cgit.freebsd.org/ports/tree/security/snort/">security/snort</a>. As <code>freebsd-update</code> stores data on disk, the possibility of tampering is evident. While this possibility may be reduced using <code>kern.securelevel</code> and by storing the <code>freebsd-update</code> data on a read-only file system when not in use, a better solution would be to compare the system against a secure disk, such as a DVD or securely stored external USB disk device. An alternative method for providing IDS functionality using a built-in utility is described in <a href="./#security-ids">Binary Verification</a></p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>To begin the comparison, specify the output file to save the results to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># freebsd-update IDS &gt;&gt; outfile.ids</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The system will now be inspected and a lengthy listing of files, along with the SHA256 hash values for both the known value in the release and the current installation, will be sent to the specified output file.</p>
</div>
<div class="paragraph">
<p>The entries in the listing are extremely long, but the output format may be easily parsed. For instance, to obtain a list of all files which differ from those in the release, issue the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># cat outfile.ids | awk &#39;{ print $1 }&#39; | more</span>
/etc/master.passwd
/etc/motd
/etc/passwd
/etc/pf.conf</code></pre>
</div>
</div>
<div class="paragraph">
<p>This sample output has been truncated as many more files exist. Some files have natural modifications. For example, <span class="filename">/etc/passwd</span> will be modified if users have been added to the system. Kernel modules may differ as <code>freebsd-update</code> may have updated them. To exclude specific files or directories, add them to the <code>IDSIgnorePaths</code> option in <span class="filename">/etc/freebsd-update.conf</span>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="updating-bootcode">26.3. Updating Bootcode<a class="anchor" href="#updating-bootcode"></a></h3>
<div class="paragraph">
<p>The following manuals describe the upgrade process of bootcode and boot loaders: <a href="https://man.freebsd.org/cgi/man.cgi?query=gpart&amp;sektion=8&amp;format=html">gpart(8)</a>, <a href="https://man.freebsd.org/cgi/man.cgi?query=gptboot&amp;sektion=8&amp;format=html">gptboot(8)</a>, <a href="https://man.freebsd.org/cgi/man.cgi?query=gptzfsboot&amp;sektion=8&amp;format=html">gptzfsboot(8)</a>, and <a href="https://man.freebsd.org/cgi/man.cgi?query=loader.efi&amp;sektion=8&amp;format=html">loader.efi(8)</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="updating-upgrading-documentation">26.4. Updating the Documentation Set<a class="anchor" href="#updating-upgrading-documentation"></a></h3>
<div class="paragraph">
<p>Documentation is an integral part of the FreeBSD operating system. While an up-to-date version of the FreeBSD documentation is always available on the FreeBSD web site (<a href="https://docs.FreeBSD.org">Documentation Portal</a>), it can be handy to have an up-to-date, local copy of the FreeBSD website, handbooks, FAQ, and articles.</p>
</div>
<div class="paragraph">
<p>This section describes how to use either source or the FreeBSD Ports Collection to keep a local copy of the FreeBSD documentation up-to-date.</p>
</div>
<div class="paragraph">
<p>For information on editing and submitting corrections to the documentation, refer to the FreeBSD Documentation Project Primer for New Contributors (<a href="{fdp-primer}">FreeBSD Documentation Project Primer for New Contributors</a>).</p>
</div>
<div class="sect3">
<h4 id="updating-installed-documentation">26.4.1. Updating Documentation from Source<a class="anchor" href="#updating-installed-documentation"></a></h4>
<div class="paragraph">
<p>Rebuilding the FreeBSD documentation from source requires a collection of tools which are not part of the FreeBSD base system. The required tools can be installed following <a href="{fdp-primer}#overview-quick-start">these steps</a> from the FreeBSD Documentation Project Primer.</p>
</div>
<div class="paragraph">
<p>Once installed, use <code>git</code> to fetch a clean copy of the documentation source:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># git clone https://git.FreeBSD.org/doc.git /usr/doc</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The initial download of the documentation sources may take a while. Let it run until it completes.</p>
</div>
<div class="paragraph">
<p>Future updates of the documentation sources may be fetched by running:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># git pull</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Once an up-to-date snapshot of the documentation sources has been fetched to <span class="filename">/usr/doc</span>, everything is ready for an update of the installed documentation.</p>
</div>
<div class="paragraph">
<p>A full update may be performed by typing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># cd /usr/doc</span>
<span class="c"># make</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="current-stable">26.5. Tracking a Development Branch<a class="anchor" href="#current-stable"></a></h3>
<div class="paragraph">
<p>FreeBSD has two development branches: FreeBSD-CURRENT and FreeBSD-STABLE.</p>
</div>
<div class="paragraph">
<p>This section provides an explanation of each branch and its intended audience, as well as how to keep a system up-to-date with each respective branch.</p>
</div>
<div class="sect3">
<h4 id="current">26.5.1. Using FreeBSD-CURRENT<a class="anchor" href="#current"></a></h4>
<div class="paragraph">
<p>FreeBSD-CURRENT is the &#34;bleeding edge&#34; of FreeBSD development and FreeBSD-CURRENT users are expected to have a high degree of technical skill. Less technical users who wish to track a development branch should track FreeBSD-STABLE instead.</p>
</div>
<div class="paragraph">
<p>FreeBSD-CURRENT is the very latest source code for FreeBSD and includes works in progress, experimental changes, and transitional mechanisms that might or might not be present in the next official release. While many FreeBSD developers compile the FreeBSD-CURRENT source code daily, there are short periods of time when the source may not be buildable. These problems are resolved as quickly as possible, but whether or not FreeBSD-CURRENT brings disaster or new functionality can be a matter of when the source code was synced.</p>
</div>
<div class="paragraph">
<p>FreeBSD-CURRENT is made available for three primary interest groups:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Members of the FreeBSD community who are actively working on some part of the source tree.</p>
</li>
<li>
<p>Members of the FreeBSD community who are active testers. They are willing to spend time solving problems, making topical suggestions on changes and the general direction of FreeBSD, and submitting patches.</p>
</li>
<li>
<p>Users who wish to keep an eye on things, use the current source for reference purposes, or make the occasional comment or code contribution.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>FreeBSD-CURRENT should <em>not</em> be considered a fast-track to getting new features before the next release as pre-release features are not yet fully tested and most likely contain bugs. It is not a quick way of getting bug fixes as any given commit is just as likely to introduce new bugs as to fix existing ones. FreeBSD-CURRENT is not in any way &#34;officially supported&#34;.</p>
</div>
<div class="paragraph">
<p>To track FreeBSD-CURRENT:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Join the {freebsd-current} and the {dev-commits-src-main} lists. This is <em>essential</em> in order to see the comments that people are making about the current state of the system and to receive important bulletins about the current state of FreeBSD-CURRENT.</p>
<div class="paragraph">
<p>The {dev-commits-src-main} list records the commit log entry for each change as it is made, along with any pertinent information on possible side effects.</p>
</div>
<div class="paragraph">
<p>To join these lists, go to {mailing-lists}, click on the list to subscribe to, and follow the instructions. In order to track changes to the whole source tree, not just the changes to FreeBSD-CURRENT, subscribe to the {dev-commits-src-all}.</p>
</div>
</li>
<li>
<p>Synchronize with the FreeBSD-CURRENT sources. Typically, <code>git</code> is used to check out the -CURRENT code from the <code>main</code> branch of the FreeBSD Git repository (see <a href="./#git">“Using Git”</a> for details).</p>
</li>
<li>
<p>Due to the size of the repository, some users choose to only synchronize the sections of source that interest them or which they are contributing patches to. However, users that plan to compile the operating system from source must download <em>all</em> of FreeBSD-CURRENT, not just selected portions.</p>
<div class="paragraph">
<p>Before compiling FreeBSD-CURRENT, read <span class="filename">/usr/src/Makefile</span> very carefully and follow the instructions in <a href="#makeworld">Updating FreeBSD from Source</a>. Read the {freebsd-current} and <span class="filename">/usr/src/UPDATING</span> to stay up-to-date on other bootstrapping procedures that sometimes become necessary on the road to the next release.</p>
</div>
</li>
<li>
<p>Be active! FreeBSD-CURRENT users are encouraged to submit their suggestions for enhancements or bug fixes. Suggestions with accompanying code are always welcome.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="stable">26.5.2. Using FreeBSD-STABLE<a class="anchor" href="#stable"></a></h4>
<div class="paragraph">
<p>FreeBSD-STABLE is the development branch from which major releases are made. Changes go into this branch at a slower pace and with the general assumption that they have first been tested in FreeBSD-CURRENT. This is <em>still</em> a development branch and, at any given time, the sources for FreeBSD-STABLE may or may not be suitable for general use. It is simply another engineering development track, not a resource for end-users. Users who do not have the resources to perform testing should instead run the most recent release of FreeBSD.</p>
</div>
<div class="paragraph">
<p>Those interested in tracking or contributing to the FreeBSD development process, especially as it relates to the next release of FreeBSD, should consider following FreeBSD-STABLE.</p>
</div>
<div class="paragraph">
<p>While the FreeBSD-STABLE branch should compile and run at all times, this cannot be guaranteed. Since more people run FreeBSD-STABLE than FreeBSD-CURRENT, it is inevitable that bugs and corner cases will sometimes be found in FreeBSD-STABLE that were not apparent in FreeBSD-CURRENT. For this reason, one should not blindly track FreeBSD-STABLE. It is particularly important <em>not</em> to update any production servers to FreeBSD-STABLE without thoroughly testing the code in a development or testing environment.</p>
</div>
<div class="paragraph">
<p>To track FreeBSD-STABLE:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Join the {freebsd-stable} in order to stay informed of build dependencies that may appear in FreeBSD-STABLE or any other issues requiring special attention. Developers will also make announcements in this mailing list when they are contemplating some controversial fix or update, giving the users a chance to respond if they have any issues to raise concerning the proposed change.</p>
<div class="paragraph">
<p>Join the relevant git list for the branch being tracked. For example, users tracking the 13-STABLE branch should join the {dev-commits-src-branches}. This list records the commit log entry for each change as it is made, along with any pertinent information on possible side effects.</p>
</div>
<div class="paragraph">
<p>To join these lists, go to {mailing-lists}, click on the list to subscribe to, and follow the instructions. In order to track changes for the whole source tree, subscribe to {dev-commits-src-all}.</p>
</div>
</li>
<li>
<p>To install a new FreeBSD-STABLE system, install the most recent FreeBSD-STABLE release from the <a href="./#mirrors">FreeBSD mirror sites</a> or use a monthly snapshot built from FreeBSD-STABLE. Refer to <a href="https://www.FreeBSD.org/snapshots/">www.freebsd.org/snapshots</a> for more information about snapshots.</p>
<div class="paragraph">
<p>To compile or upgrade an existing FreeBSD system to FreeBSD-STABLE, use <code>git</code> to check out the source for the desired branch. Branch names, such as <code>stable/13</code>, are listed at <a href="https://www.FreeBSD.org/releng/">www.freebsd.org/releng</a>.</p>
</div>
</li>
<li>
<p>Before compiling or upgrading to FreeBSD-STABLE , read <span class="filename">/usr/src/Makefile</span> carefully and follow the instructions in <a href="#makeworld">Updating FreeBSD from Source</a>. Read the {freebsd-stable} and <span class="filename">/usr/src/UPDATING</span> to keep up-to-date on other bootstrapping procedures that sometimes become necessary on the road to the next release.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="translate-n-number">26.5.3. The N-number<a class="anchor" href="#translate-n-number"></a></h4>
<div class="paragraph">
<p>When tracking down bugs it is important to know which versions of the source code have been used to create the system exhibiting an issue. FreeBSD provides version information compiled into the kernel. <a href="https://man.freebsd.org/cgi/man.cgi?query=uname&amp;sektion=1&amp;format=html">uname(1)</a> retrieves this information, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>uname -v
FreeBSD 14.0-CURRENT <span class="c">#112 main-n247514-031260d64c18: Tue Jun 22 20:43:19 MDT 2021     fred@machine:/usr/home/fred/obj/usr/home/fred/git/head/amd64.amd64/sys/FRED</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The final field gives information regarding the kernel name, the person that built it, and the location that it was compiled in. Looking at the 4th field, it is made up of several parts:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">main-n247514-031260d64c18

main		<i class="conum" data-value="1"></i><b>(1)</b>
n247514		<i class="conum" data-value="2"></i><b>(2)</b>
031260d64c18	<i class="conum" data-value="3"></i><b>(3)</b>
		<i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Git branch name. Note: comparisons of n-numbers are only valid on branches published by the project (<code>main</code>, <code>stable/XX</code> and <code>releng/XX</code>). Local branches will have n-numbers that will overlap commits of their parent branch. &lt;.&gt; The n-number is a linear count of commits back to the start of the Git repository starting with the Git hash included in the line. &lt;.&gt; Git hash of the checked out tree &lt;.&gt; Sometimes a suffix of <code>-dirty</code> is present when the kernel was built in a tree with uncommitted changes. It is absent in this example because the FRED kernel was built from a pristine checkout.</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>The <code>git rev-list</code> command is used to find the n-number corresponding to a Git hash. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>git rev-list --first-parent --count 031260d64c18 <i class="conum" data-value="1"></i><b>(1)</b>
247514 <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>git hash to translate (the hash from the above example is reused) &lt;.&gt; The n-number.</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Usually this number is not all that important. However, when bug fixes are committed, this number makes it easy to quickly determine whether the fix is present in the currently running system. Developers will often refer to the hash of the commit (or provide a URL which has that hash), but not the n-number since the hash is the easily visible identifier for a change while the n-number is not. Security advisories and errata notices will also note an n-number, which can be directly compared against your system. When you need to use shallow Git clones, you cannot compare n-numbers reliably as the <code>git rev-list</code> command counts all the revisions in the repository which a shallow clone omits.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="makeworld">26.6. Updating FreeBSD from Source<a class="anchor" href="#makeworld"></a></h3>
<div class="paragraph">
<p>Updating FreeBSD by compiling from source offers several advantages over binary updates. Code can be built with options to take advantage of specific hardware. Parts of the base system can be built with non-default settings, or left out entirely where they are not needed or desired. The build process takes longer to update a system than just installing binary updates, but allows complete customization to produce a tailored version of FreeBSD.</p>
</div>
<div class="sect3">
<h4 id="updating-src-quick-start">26.6.1. Quick Start<a class="anchor" href="#updating-src-quick-start"></a></h4>
<div class="paragraph">
<p>This is a quick reference for the typical steps used to update FreeBSD by building from source. Later sections describe the process in more detail.</p>
</div>
<div class="admonitionblock warning">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When switching from <a href="https://man.freebsd.org/cgi/man.cgi?query=mergemaster&amp;sektion=8&amp;format=html">mergemaster(8)</a> to <a href="https://man.freebsd.org/cgi/man.cgi?query=etcupdate&amp;sektion=8&amp;format=html">etcupdate(8)</a>, the first run might merge changes incorrectly generating spurious conflicts. To prevent this, perform the following steps <strong>before</strong> updating sources and building the new world:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># etcupdate extract </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="c"># etcupdate diff </span><i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Bootstrap the database of stock <span class="filename">/etc</span> files; for more information see <a href="https://man.freebsd.org/cgi/man.cgi?query=etcupdate&amp;sektion=8&amp;format=html">etcupdate(8)</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Check the diff after bootstrapping. Trim any local changes that are no longer needed to reduce the chance of conflicts in future updates.</td>
</tr>
</tbody></table>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="exampleblock procedure">
<div class="content">
<div class="ulist">
<ul>
<li>
<p>Update and Build</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># git pull /usr/src  </span><i class="conum" data-value="1"></i><b>(1)</b>
check /usr/src/UPDATING  <i class="conum" data-value="2"></i><b>(2)</b>
<span class="c"># cd /usr/src          </span><i class="conum" data-value="3"></i><b>(3)</b>
<span class="c"># make -j4 buildworld  </span><i class="conum" data-value="4"></i><b>(4)</b>
<span class="c"># make -j4 kernel      </span><i class="conum" data-value="5"></i><b>(5)</b>
<span class="c"># shutdown -r now      </span><i class="conum" data-value="6"></i><b>(6)</b>
<span class="c"># etcupdate -p         </span><i class="conum" data-value="7"></i><b>(7)</b>
<span class="c"># cd /usr/src          </span><i class="conum" data-value="8"></i><b>(8)</b>
<span class="c"># make installworld    </span><i class="conum" data-value="9"></i><b>(9)</b>
<span class="c"># etcupdate -B         </span><i class="conum" data-value="10"></i><b>(10)</b>
<span class="c"># shutdown -r now      </span><i class="conum" data-value="11"></i><b>(11)</b></code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Get the latest version of the source. See <a href="#updating-src-obtaining-src">Updating the Source</a> for more information on obtaining and updating source.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Check <span class="filename">/usr/src/UPDATING</span> for any manual steps required before or after building from source.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Go to the source directory.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Compile the world, everything except the kernel.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Compile and install the kernel. This is equivalent to <code>make buildkernel installkernel</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Reboot the system to the new kernel.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Update and merge configuration files in <span class="filename">/etc/</span> required before installworld.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Go to the source directory.</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>Install the world.</td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>Update and merge configuration files in <span class="filename">/etc/</span>.</td>
</tr>
<tr>
<td><i class="conum" data-value="11"></i><b>11</b></td>
<td>Restart the system to use the newly-built world and kernel.</td>
</tr>
</tbody></table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="updating-src-preparing">26.6.2. Preparing for a Source Update<a class="anchor" href="#updating-src-preparing"></a></h4>
<div class="paragraph">
<p>Read <span class="filename">/usr/src/UPDATING</span>. Any manual steps that must be performed before or after an update are described in this file.</p>
</div>
</div>
<div class="sect3">
<h4 id="updating-src-obtaining-src">26.6.3. Updating the Source<a class="anchor" href="#updating-src-obtaining-src"></a></h4>
<div class="paragraph">
<p>FreeBSD source code is located in <span class="filename">/usr/src/</span>. The preferred method of updating this source is through the Git version control system. Verify that the source code is under version control:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># cd /usr/src</span>
<span class="c"># git remote --v</span>
origin  https://git.freebsd.org/src.git <span class="o">(</span>fetch<span class="o">)</span>
origin  https://git.freebsd.org/src.git <span class="o">(</span>push<span class="o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This indicates that <span class="filename">/usr/src/</span> is under version control and can be updated with <a href="https://man.freebsd.org/cgi/man.cgi?query=git&amp;sektion=1&amp;format=html">git(1)</a>:</p>
</div>
<div id="synching" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># git pull /usr/src</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The update process can take some time if the directory has not been updated recently. After it finishes, the source code is up to date and the build process described in the next section can begin.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Obtaining the source:</p>
</div>
<div class="paragraph">
<p>If the output says <code>fatal: not a git repository</code>, the files there are missing or were installed with a different method. A new checkout of the source is required.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<table id="updating-src-obtaining-src-repopath" class="tableblock frame-all grid-all stretch">
<caption class="title">表 37. FreeBSD Versions and Repository Branches</caption>
<colgroup>
<col style="width: 10%;"/>
<col style="width: 10%;"/>
<col style="width: 80%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">uname ‑r Output</th>
<th class="tableblock halign-left valign-top">Repository Path</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><em>X.Y</em>-RELEASE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>releng/<em>X.Y</em></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The Release version plus only critical security and bug fix patches. This branch is recommended for most users.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><em>X.Y</em>-STABLE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>stable/<em>X</em></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The Release version plus all additional development on that branch. <em>STABLE</em> refers to the Applications Binary Interface (ABI) not changing, so software compiled for earlier versions still runs. For example, software compiled to run on FreeBSD 10.1 will still run on FreeBSD 10-STABLE compiled later.</p>
<p class="tableblock">STABLE branches occasionally have bugs or incompatibilities which might affect users, although these are typically fixed quickly.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><em>X</em>-CURRENT</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>main</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The latest unreleased development version of FreeBSD. The CURRENT branch can have major bugs or incompatibilities and is recommended only for advanced users.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Determine which version of FreeBSD is being used with <a href="https://man.freebsd.org/cgi/man.cgi?query=uname&amp;sektion=1&amp;format=html">uname(1)</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># uname -r</span>
13.2-RELEASE</code></pre>
</div>
</div>
<div class="paragraph">
<p>Based on <a href="#updating-src-obtaining-src-repopath">FreeBSD Versions and Repository Branches</a>, the source used to update <code>13.2-RELEASE</code> has a repository path of <code>releng/13.2</code>. That path is used when checking out the source:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># mv /usr/src /usr/src.bak </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="c"># git clone --branch releng/13.2 https://git.FreeBSD.org/src.git /usr/src </span><i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Move the old directory out of the way. If there are no local modifications in this directory, it can be deleted.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The path from <a href="#updating-src-obtaining-src-repopath">FreeBSD Versions and Repository Branches</a> is added to the repository URL. The third parameter is the destination directory for the source code on the local system.</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect3">
<h4 id="updating-src-building">26.6.4. Building from Source<a class="anchor" href="#updating-src-building"></a></h4>
<div class="paragraph">
<p>The <em>world</em>, or all of the operating system except the kernel, is compiled. This is done first to provide up-to-date tools to build the kernel. Then the kernel itself is built:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># cd /usr/src</span>
<span class="c"># make buildworld</span>
<span class="c"># make buildkernel</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The compiled code is written to <span class="filename">/usr/obj</span>.</p>
</div>
<div class="paragraph">
<p>These are the basic steps. Additional options to control the build are described below.</p>
</div>
<div class="sect4">
<h5 id="updating-src-building-clean-build">26.6.4.1. Performing a Clean Build<a class="anchor" href="#updating-src-building-clean-build"></a></h5>
<div class="paragraph">
<p>Some versions of the FreeBSD build system leave previously-compiled code in the temporary object directory, <span class="filename">/usr/obj</span>. This can speed up later builds by avoiding recompiling code that has not changed. To force a clean rebuild of everything, use <code>cleanworld</code> before starting a build:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># make cleanworld</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="updating-src-building-jobs">26.6.4.2. Setting the Number of Jobs<a class="anchor" href="#updating-src-building-jobs"></a></h5>
<div class="paragraph">
<p>Increasing the number of build jobs on multi-core processors can improve build speed. Determine the number of cores with <code>sysctl hw.ncpu</code>. Processors vary, as do the build systems used with different versions of FreeBSD, so testing is the only sure method to tell how a different number of jobs affects the build speed. For a starting point, consider values between half and double the number of cores. The number of jobs is specified with <code>-j</code>.</p>
</div>
<div id="updating-src-building-jobs-example" class="exampleblock">
<div class="title">例 33. Increasing the Number of Build Jobs</div>
<div class="content">
<div class="paragraph">
<p>Building the world and kernel with four jobs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># make -j4 buildworld buildkernel</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="updating-src-building-only-kernel">26.6.4.3. Building Only the Kernel<a class="anchor" href="#updating-src-building-only-kernel"></a></h5>
<div class="paragraph">
<p>A <code>buildworld</code> must be completed if the source code has changed. After that, a <code>buildkernel</code> to build a kernel can be run at any time. To build just the kernel:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># cd /usr/src</span>
<span class="c"># make buildkernel</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="updating-src-building-custom-kernel">26.6.4.4. Building a Custom Kernel<a class="anchor" href="#updating-src-building-custom-kernel"></a></h5>
<div class="paragraph">
<p>The standard FreeBSD kernel is based on a <em>kernel config file</em> called <span class="filename">GENERIC</span>. The <span class="filename">GENERIC</span> kernel includes the most commonly-needed device drivers and options. Sometimes it is useful or necessary to build a custom kernel, adding or removing device drivers or options to fit a specific need.</p>
</div>
<div class="paragraph">
<p>For example, someone developing a small embedded computer with severely limited RAM could remove unneeded device drivers or options to make the kernel slightly smaller.</p>
</div>
<div class="paragraph">
<p>Kernel config files are located in <span class="filename">/usr/src/sys/arch/conf/</span>, where <em>arch</em> is the output from <code>uname -m</code>. On most computers, that is <code>amd64</code>, giving a config file directory of <span class="filename">/usr/src/sys/amd64/conf/</span>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p><span class="filename">/usr/src</span> can be deleted or recreated, so it is preferable to keep custom kernel config files in a separate directory, like <span class="filename">/root</span>. Link the kernel config file into the <span class="filename">conf</span> directory. If that directory is deleted or overwritten, the kernel config can be re-linked into the new one.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>A custom config file can be created by copying the <span class="filename">GENERIC</span> config file. In this example, the new custom kernel is for a storage server, so is named <span class="filename">STORAGESERVER</span>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># cp /usr/src/sys/amd64/conf/GENERIC /root/STORAGESERVER</span>
<span class="c"># cd /usr/src/sys/amd64/conf</span>
<span class="c"># ln -s /root/STORAGESERVER .</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><span class="filename">/root/STORAGESERVER</span> is then edited, adding or removing devices or options as shown in <a href="https://man.freebsd.org/cgi/man.cgi?query=config&amp;sektion=5&amp;format=html">config(5)</a>.</p>
</div>
<div class="paragraph">
<p>The custom kernel is built by setting <code>KERNCONF</code> to the kernel config file on the command line:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># make buildkernel KERNCONF=STORAGESERVER</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="updating-src-installing">26.6.5. Installing the Compiled Code<a class="anchor" href="#updating-src-installing"></a></h4>
<div class="paragraph">
<p>After the <code>buildworld</code> and <code>buildkernel</code> steps have been completed, the new kernel and world are installed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># cd /usr/src</span>
<span class="c"># make installkernel</span>
<span class="c"># shutdown -r now</span>
<span class="c"># cd /usr/src</span>
<span class="c"># make installworld</span>
<span class="c"># shutdown -r now</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If a custom kernel was built, <code>KERNCONF</code> must also be set to use the new custom kernel:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># cd /usr/src</span>
<span class="c"># make installkernel KERNCONF=STORAGESERVER</span>
<span class="c"># shutdown -r now</span>
<span class="c"># cd /usr/src</span>
<span class="c"># make installworld</span>
<span class="c"># shutdown -r now</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="updating-src-completing">26.6.6. Completing the Update<a class="anchor" href="#updating-src-completing"></a></h4>
<div class="paragraph">
<p>A few final tasks complete the update. Any modified configuration files are merged with the new versions, outdated libraries are located and removed, then the system is restarted.</p>
</div>
<div class="sect4">
<h5 id="updating-src-completing-merge-etcupdate">26.6.6.1. Merging Configuration Files with <a href="https://man.freebsd.org/cgi/man.cgi?query=etcupdate&amp;sektion=8&amp;format=html">etcupdate(8)</a><a class="anchor" href="#updating-src-completing-merge-etcupdate"></a></h5>
<div class="paragraph">
<p><a href="https://man.freebsd.org/cgi/man.cgi?query=etcupdate&amp;sektion=8&amp;format=html">etcupdate(8)</a> is a tool for managing updates to files that are not updated as part of an installworld such as files located in <span class="filename">/etc/</span>. It manages updates by doing a three-way merge of changes made to these files against the local versions. It is also designed to minimize the amount of user intervention, in contrast to <a href="https://man.freebsd.org/cgi/man.cgi?query=mergemaster&amp;sektion=8&amp;format=html">mergemaster(8)</a>&#39;s interactive prompts.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In general, <a href="https://man.freebsd.org/cgi/man.cgi?query=etcupdate&amp;sektion=8&amp;format=html">etcupdate(8)</a> does not need any specific arguments for its job. There is however a handy in between command for sanity checking what will be done the first time <a href="https://man.freebsd.org/cgi/man.cgi?query=etcupdate&amp;sektion=8&amp;format=html">etcupdate(8)</a> is used:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># etcupdate diff</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This command allows the user to audit configuration changes.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>If <a href="https://man.freebsd.org/cgi/man.cgi?query=etcupdate&amp;sektion=8&amp;format=html">etcupdate(8)</a> is not able to merge a file automatically, the merge conflicts can be resolved with manual interaction by issuing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># etcupdate resolve</span></code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When switching from <a href="https://man.freebsd.org/cgi/man.cgi?query=mergemaster&amp;sektion=8&amp;format=html">mergemaster(8)</a> to <a href="https://man.freebsd.org/cgi/man.cgi?query=etcupdate&amp;sektion=8&amp;format=html">etcupdate(8)</a>, the first run might merge changes incorrectly generating spurious conflicts. To prevent this, perform the following steps <strong>before</strong> updating sources and building the new world:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># etcupdate extract </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="c"># etcupdate diff </span><i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Bootstrap the database of stock <span class="filename">/etc</span> files; for more information see <a href="https://man.freebsd.org/cgi/man.cgi?query=etcupdate&amp;sektion=8&amp;format=html">etcupdate(8)</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Check the diff after bootstrapping. Trim any local changes that are no longer needed to reduce the chance of conflicts in future updates.</td>
</tr>
</tbody></table>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect4">
<h5 id="updating-src-completing-merge-mergemaster">26.6.6.2. Merging Configuration Files with <a href="https://man.freebsd.org/cgi/man.cgi?query=mergemaster&amp;sektion=8&amp;format=html">mergemaster(8)</a><a class="anchor" href="#updating-src-completing-merge-mergemaster"></a></h5>
<div class="paragraph">
<p><a href="https://man.freebsd.org/cgi/man.cgi?query=mergemaster&amp;sektion=8&amp;format=html">mergemaster(8)</a> provides a way to merge changes that have been made to system configuration files with new versions of those files. <a href="https://man.freebsd.org/cgi/man.cgi?query=mergemaster&amp;sektion=8&amp;format=html">mergemaster(8)</a> is an alternative to the preferred <a href="https://man.freebsd.org/cgi/man.cgi?query=etcupdate&amp;sektion=8&amp;format=html">etcupdate(8)</a> With <code>-Ui</code>, <a href="https://man.freebsd.org/cgi/man.cgi?query=mergemaster&amp;sektion=8&amp;format=html">mergemaster(8)</a> automatically updates files that have not been user-modified and installs new files that are not already present:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># mergemaster -Ui</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If a file must be manually merged, an interactive display allows the user to choose which portions of the files are kept. See <a href="https://man.freebsd.org/cgi/man.cgi?query=mergemaster&amp;sektion=8&amp;format=html">mergemaster(8)</a> for more information.</p>
</div>
<div class="paragraph">
<p>If the standard <span class="filename">/usr/src</span> was not used, another parameter must be passed to <a href="https://man.freebsd.org/cgi/man.cgi?query=mergemaster&amp;sektion=8&amp;format=html">mergemaster(8)</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># mergemaster -Ui PATH_TO_SRC</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="updating-src-completing-check-old">26.6.6.3. Checking for Outdated Files and Libraries<a class="anchor" href="#updating-src-completing-check-old"></a></h5>
<div class="paragraph">
<p>Some obsolete files or directories can remain after an update. These files can be located:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># make check-old</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>and deleted:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># make delete-old</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Some obsolete libraries can also remain. These can be detected with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># make check-old-libs</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>and deleted with</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># make delete-old-libs</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Programs which were still using those old libraries will stop working when the library has been deleted. These programs must be rebuilt or replaced after deleting the old libraries.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When all the old files or directories are known to be safe to delete, pressing <kbd>y</kbd> and <kbd>Enter</kbd> to delete each file can be avoided by setting <code>BATCH_DELETE_OLD_FILES</code> in the command. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># make BATCH_DELETE_OLD_FILES=yes delete-old-libs</span></code></pre>
</div>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect4">
<h5 id="updating-src-completing-restart">26.6.6.4. Restarting After the Update<a class="anchor" href="#updating-src-completing-restart"></a></h5>
<div class="paragraph">
<p>The last step after updating is to restart the computer so all the changes take effect:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># shutdown -r now</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="small-lan">26.7. Tracking for Multiple Machines<a class="anchor" href="#small-lan"></a></h3>
<div class="paragraph">
<p>When multiple machines need to track the same source tree, it is a waste of disk space, network bandwidth, and CPU cycles to have each system download the sources and rebuild everything. The solution is to have one machine do most of the work, while the rest of the machines mount that work via NFS. This section outlines a method of doing so. For more information about using NFS, refer to <a href="./#network-nfs">Network File System (NFS)</a>.</p>
</div>
<div class="paragraph">
<p>First, identify a set of machines which will run the same set of binaries, known as a <em>build set</em>. Each machine can have a custom kernel, but will run the same userland binaries. From that set, choose a machine to be the <em>build machine</em> that the world and kernel are built on. Ideally, this is a fast machine that has sufficient spare CPU to run <code>make buildworld</code> and <code>make buildkernel</code>.</p>
</div>
<div class="paragraph">
<p>Select a machine to be the <em>test machine</em>, which will test software updates before they are put into production. This <em>must</em> be a machine that can afford to be down for an extended period of time. It can be the build machine, but need not be.</p>
</div>
<div class="paragraph">
<p>All the machines in this build set need to mount <span class="filename">/usr/obj</span> and <span class="filename">/usr/src</span> from the build machine via NFS. For multiple build sets, <span class="filename">/usr/src</span> should be on one build machine, and NFS mounted on the rest.</p>
</div>
<div class="paragraph">
<p>Ensure that <span class="filename">/etc/make.conf</span> and <span class="filename">/etc/src.conf</span> on all the machines in the build set agree with the build machine. That means that the build machine must build all the parts of the base system that any machine in the build set is going to install. Also, each build machine should have its kernel name set with <code>KERNCONF</code> in <span class="filename">/etc/make.conf</span>, and the build machine should list them all in its <code>KERNCONF</code>, listing its own kernel first. The build machine must have the kernel configuration files for each machine in its <span class="filename">/usr/src/sys/arch/conf</span>.</p>
</div>
<div class="paragraph">
<p>On the build machine, build the kernel and world as described in <a href="#makeworld">Updating FreeBSD from Source</a>, but do not install anything on the build machine. Instead, install the built kernel on the test machine. On the test machine, mount <span class="filename">/usr/src</span> and <span class="filename">/usr/obj</span> via NFS. Then, run <code>shutdown now</code> to go to single-user mode in order to install the new kernel and world and run <code>mergemaster</code> as usual. When done, reboot to return to normal multi-user operations.</p>
</div>
<div class="paragraph">
<p>After verifying that everything on the test machine is working properly, use the same procedure to install the new software on each of the other machines in the build set.</p>
</div>
<div class="paragraph">
<p>The same methodology can be used for the ports tree. The first step is to share <span class="filename">/usr/ports</span> via NFS to all the machines in the build set. To configure <span class="filename">/etc/make.conf</span> to share distfiles, set <code>DISTDIR</code> to a common shared directory that is writable by whichever user <code>root</code> is mapped to by the NFS mount. Each machine should set <code>WRKDIRPREFIX</code> to a local build directory, if ports are to be built locally. Alternately, if the build system is to build and distribute packages to the machines in the build set, set <code>PACKAGES</code> on the build system to a directory similar to <code>DISTDIR</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="building-on-non-freebsd-hosts">26.8. Building on non-FreeBSD Hosts<a class="anchor" href="#building-on-non-freebsd-hosts"></a></h3>
<div class="paragraph">
<p>Historically, building FreeBSD required a FreeBSD host. Nowadays, the FreeBSD can be build on Linux distributions and macOS.</p>
</div>
<div class="paragraph">
<p>To build FreeBSD on non-FreeBSD hosts, the recommendation is to use the <code>tools/build/make.py</code> script. This script acts as a wrapper around <code>bmake</code>, which is the make implementation used by FreeBSD. It ensures that the necessary tooling, including the actual FreeBSD’s <a href="https://man.freebsd.org/cgi/man.cgi?query=make&amp;sektion=1&amp;format=html">make(1)</a>, is bootstrapped and that the build environment is properly configured. In particular, it sets the external toolchain variables, such as <code>XCC</code>, <code>XLD</code>, and others. Additionally, the script can pass any additional command arguments, such as <code>-j 4</code> for parallel builds or specific make targets, to <code>bmake</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A recent version of <code>bmake</code> can be used instead of the <code>tools/build/make.py</code> script as well. In that case, however, required environment variables need to be set manually (the easiest way to obtain a list of them is by running <code>tools/build/make.py --debug</code>).</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Otherwise, the list of prerequisites for building FreeBSD is rather short. In fact, it boils down to installing a couple of dependencies.</p>
</div>
<div class="paragraph">
<p>On macOS, the only dependency LLVM. The necessary dependencies can be installed with package manager (e.g., <a href="https://brew.sh/">Homebrew</a>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">brew install llvm</code></pre>
</div>
</div>
<div class="paragraph">
<p>On a Linux distributions, install <a href="https://clang.llvm.org/">Clang</a> version 10.0 or newer and the headers for libarchive and libbz2 (often packaged as libarchive-dev and libbz2-dev).</p>
</div>
<div class="paragraph">
<p>Once the dependencies are installed, the host should be able to build FreeBSD.</p>
</div>
<div class="paragraph">
<p>For example, the following <code>tools/build/make.py</code> invocation builds the world:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nv">MAKEOBJDIRPREFIX</span><span class="o">=</span>/tmp/obj tools/build/make.py -j 8 <span class="nv">TARGET</span><span class="o">=</span>arm64 <span class="nv">TARGET_ARCH</span><span class="o">=</span>aarch64 buildworld</code></pre>
</div>
</div>
<div class="paragraph">
<p>It builds the world for target <code>aarch64:arm64</code> on 8 CPUs and uses <span class="filename">/tmp/obj</span> for object files. Note that the variables <code>MAKEOBJDIRPREFIX</code>, <code>TARGET</code>, and <code>TARGET_ARCH</code> are mandatory when building on non-FreeBSD hosts. Also, make sure to create the object directory pointed to by the <code>MAKEOBJDIRPREFIX</code> environment variable.</p>
</div>
<div class="paragraph">
<p>Refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=arch&amp;sektion=7&amp;format=html">arch(7)</a> and <a href="https://man.freebsd.org/cgi/man.cgi?query=build&amp;sektion=7&amp;format=html">build(7)</a> for more details.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="dtrace">Chapter 27. DTrace<a class="anchor" href="#dtrace"></a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="dtrace-synopsis">27.1. Synopsis<a class="anchor" href="#dtrace-synopsis"></a></h3>
<div class="paragraph">
<p>DTrace, also known as Dynamic Tracing, was developed by Sun™ as a tool for locating performance bottlenecks in production and pre-production systems. In addition to diagnosing performance problems, DTrace can be used to help investigate and debug unexpected behavior in both the FreeBSD kernel and in userland programs.</p>
</div>
<div class="paragraph">
<p>DTrace is a remarkable profiling tool, with an impressive array of features for diagnosing system issues. It may also be used to run pre-written scripts to take advantage of its capabilities. Users can author their own utilities using the DTrace D Language, allowing them to customize their profiling based on specific needs.</p>
</div>
<div class="paragraph">
<p>The FreeBSD implementation provides full support for kernel DTrace and experimental support for userland DTrace. Userland DTrace allows users to perform function boundary tracing for userland programs using the <code>pid</code> provider, and to insert static probes into userland programs for later tracing. Some ports, such as <a class="package" href="https://cgit.freebsd.org/ports/tree/databases/postgresql12-server/">databases/postgresql12-server</a> and <a class="package" href="https://cgit.freebsd.org/ports/tree/lang/php74/">lang/php74</a> have a DTrace option to enable static probes.</p>
</div>
<div class="paragraph">
<p>The official guide to DTrace is maintained by the Illumos project at <a href="http://dtrace.org/guide">DTrace Guide</a>.</p>
</div>
<div class="paragraph">
<p>After reading this chapter, you will know:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>What DTrace is and what features it provides.</p>
</li>
<li>
<p>Differences between the Solaris™ DTrace implementation and the one provided by FreeBSD.</p>
</li>
<li>
<p>How to enable and use DTrace on FreeBSD.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Before reading this chapter, you should:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Understand UNIX® and FreeBSD basics (<a href="./#basics">FreeBSD Basics</a>).</p>
</li>
<li>
<p>Have some familiarity with security and how it pertains to FreeBSD (<a href="./#security">Security</a>).</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="dtrace-implementation">27.2. Implementation Differences<a class="anchor" href="#dtrace-implementation"></a></h3>
<div class="paragraph">
<p>While the DTrace in FreeBSD is similar to that found in Solaris™, differences do exist. The primary difference is that in FreeBSD, DTrace is implemented as a set of kernel modules and DTrace can not be used until the modules are loaded. To load all of the necessary modules:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># kldload dtraceall</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Beginning with FreeBSD 10.0-RELEASE, the modules are automatically loaded when <code>dtrace</code> is run.</p>
</div>
<div class="paragraph">
<p>FreeBSD uses the <code>DDB_CTF</code> kernel option to enable support for loading <code>CTF</code> data from kernel modules and the kernel itself. <code>CTF</code> is the Solaris™ Compact C Type Format which encapsulates a reduced form of debugging information similar to <code>DWARF</code> and the venerable stabs. <code>CTF</code> data is added to binaries by the <code>ctfconvert</code> and <code>ctfmerge</code> build tools. The <code>ctfconvert</code> utility parses <code>DWARF<code>ELF</code> debug sections created by the compiler and <code>ctfmerge</code> merges <code>CTF</code>ELF</code> sections from objects into either executables or shared libraries.</p>
</div>
<div class="paragraph">
<p>Some different providers exist for FreeBSD than for Solaris™. Most notable is the <code>dtmalloc</code> provider, which allows tracing <code>malloc()</code> by type in the FreeBSD kernel. Some of the providers found in Solaris™, such as <code>cpc</code> and <code>mib</code>, are not present in FreeBSD. These may appear in future versions of FreeBSD. Moreover, some of the providers available in both operating systems are not compatible, in the sense that their probes have different argument types. Thus, <code>D</code> scripts written on Solaris™ may or may not work unmodified on FreeBSD, and vice versa.</p>
</div>
<div class="paragraph">
<p>Due to security differences, only <code>root</code> may use DTrace on FreeBSD. Solaris™ has a few low level security checks which do not yet exist in FreeBSD. As such, the <span class="filename">/dev/dtrace/dtrace</span> is strictly limited to <code>root</code>.</p>
</div>
<div class="paragraph">
<p>DTrace falls under the Common Development and Distribution License (<code>CDDL</code>) license. To view this license on FreeBSD, see <span class="filename">/usr/src/cddl/contrib/opensolaris/OPENSOLARIS.LICENSE</span> or view it online at <a href="http://opensource.org/licenses/CDDL-1.0">http://opensource.org/licenses/CDDL-1.0</a>. While a FreeBSD kernel with DTrace support is <code>BSD</code> licensed, the <code>CDDL</code> is used when the modules are distributed in binary form or the binaries are loaded.</p>
</div>
</div>
<div class="sect2">
<h3 id="dtrace-enable">27.3. Enabling DTrace Support<a class="anchor" href="#dtrace-enable"></a></h3>
<div class="paragraph">
<p>In FreeBSD 9.2 and 10.0, DTrace support is built into the <span class="filename">GENERIC</span> kernel. Users of earlier versions of FreeBSD or who prefer to statically compile in DTrace support should add the following lines to a custom kernel configuration file and recompile the kernel using the instructions in <a href="./#kernelconfig">Configuring the FreeBSD Kernel</a>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>options         KDTRACE_HOOKS
options         DDB_CTF
makeoptions	DEBUG=-g
makeoptions	WITH_CTF=1</pre>
</div>
</div>
<div class="paragraph">
<p>Users of the AMD64 architecture should also add this line:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>options         KDTRACE_FRAME</pre>
</div>
</div>
<div class="paragraph">
<p>This option provides support for <code>FBT</code>. While DTrace will work without this option, there will be limited support for function boundary tracing.</p>
</div>
<div class="paragraph">
<p>Once the FreeBSD system has rebooted into the new kernel, or the DTrace kernel modules have been loaded using <code>kldload dtraceall</code>, the system will need support for the Korn shell as the DTrace Toolkit has several utilities written in <code>ksh</code>. Make sure that the <a class="package" href="https://cgit.freebsd.org/ports/tree/shells/ksh93/">shells/ksh93</a> package or port is installed. It is also possible to run these tools under <a class="package" href="https://cgit.freebsd.org/ports/tree/shells/pdksh/">shells/pdksh</a> or <a class="package" href="https://cgit.freebsd.org/ports/tree/shells/mksh/">shells/mksh</a>.</p>
</div>
<div class="paragraph">
<p>Finally, install the current DTrace Toolkit, a collection of ready-made scripts for collecting system information. There are scripts to check open files, memory, <code>CPU</code> usage, and a lot more. FreeBSD 10 installs a few of these scripts into <span class="filename">/usr/share/dtrace</span>. On other FreeBSD versions, or to install the full DTrace Toolkit, use the <a class="package" href="https://cgit.freebsd.org/ports/tree/sysutils/dtrace-toolkit/">sysutils/dtrace-toolkit</a> package or port.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The scripts found in <span class="filename">/usr/share/dtrace</span> have been specifically ported to FreeBSD. Not all of the scripts found in the DTrace Toolkit will work as-is on FreeBSD and some scripts may require some effort in order for them to work on FreeBSD.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>The DTrace Toolkit includes many scripts in the special language of DTrace. This language is called the D language and it is very similar to C++. An in depth discussion of the language is beyond the scope of this document. It is covered extensively in the <a href="http://www.dtrace.org/guide">Illumos Dynamic Tracing Guide</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="dtrace-using">27.4. Using DTrace<a class="anchor" href="#dtrace-using"></a></h3>
<div class="paragraph">
<p>DTrace scripts consist of a list of one or more <em>probes</em>, or instrumentation points, where each probe is associated with an action. Whenever the condition for a probe is met, the associated action is executed. For example, an action may occur when a file is opened, a process is started, or a line of code is executed. The action might be to log some information or to modify context variables. The reading and writing of context variables allows probes to share information and to cooperatively analyze the correlation of different events.</p>
</div>
<div class="paragraph">
<p>To view all probes, the administrator can execute the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># dtrace -l | more</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Each probe has an <code>ID</code>, a <code>PROVIDER</code> (dtrace or fbt), a <code>MODULE</code>, and a <code>FUNCTION NAME</code>. Refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=dtrace&amp;sektion=1&amp;format=html">dtrace(1)</a> for more information about this command.</p>
</div>
<div class="paragraph">
<p>The examples in this section provide an overview of how to use two of the fully supported scripts from the DTrace Toolkit: the <span class="filename">hotkernel</span> and <span class="filename">procsystime</span> scripts.</p>
</div>
<div class="paragraph">
<p>The <span class="filename">hotkernel</span> script is designed to identify which function is using the most kernel time. It will produce output similar to the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># cd /usr/local/share/dtrace-toolkit</span>
<span class="c"># ./hotkernel</span>
Sampling... Hit Ctrl-C to end.</code></pre>
</div>
</div>
<div class="paragraph">
<p>As instructed, use the <span class="keyseq"><kbd>Ctrl</kbd>+<kbd>C</kbd></span> key combination to stop the process. Upon termination, the script will display a list of kernel functions and timing information, sorting the output in increasing order of time:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">kernel<span class="sb">`</span>_thread_lock_flags                                   2   0.0%
0xc1097063                                                  2   0.0%
kernel<span class="sb">`</span>sched_userret                                        2   0.0%
kernel<span class="sb">`</span>kern_select                                          2   0.0%
kernel<span class="sb">`</span>generic_copyin                                       3   0.0%
kernel<span class="sb">`</span>_mtx_assert                                          3   0.0%
kernel<span class="sb">`</span>vm_fault                                             3   0.0%
kernel<span class="sb">`</span>sopoll_generic                                       3   0.0%
kernel<span class="sb">`</span>fixup_filename                                       4   0.0%
kernel<span class="sb">`</span>_isitmyx                                             4   0.0%
kernel<span class="sb">`</span>find_instance                                        4   0.0%
kernel<span class="sb">`</span>_mtx_unlock_flags                                    5   0.0%
kernel<span class="sb">`</span>syscall                                              5   0.0%
kernel<span class="sb">`</span>DELAY                                                5   0.0%
0xc108a253                                                  6   0.0%
kernel<span class="sb">`</span>witness_lock                                         7   0.0%
kernel<span class="sb">`</span>read_aux_data_no_wait                                7   0.0%
kernel<span class="sb">`</span>Xint0x80_syscall                                     7   0.0%
kernel<span class="sb">`</span>witness_checkorder                                   7   0.0%
kernel<span class="sb">`</span>sse2_pagezero                                        8   0.0%
kernel<span class="sb">`</span>strncmp                                              9   0.0%
kernel<span class="sb">`</span>spinlock_exit                                       10   0.0%
kernel<span class="sb">`</span>_mtx_lock_flags                                     11   0.0%
kernel<span class="sb">`</span>witness_unlock                                      15   0.0%
kernel<span class="sb">`</span>sched_idletd                                       137   0.3%
0xc10981a5                                              42139  99.3%</code></pre>
</div>
</div>
<div class="paragraph">
<p>This script will also work with kernel modules. To use this feature, run the script with <code>-m</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ./hotkernel -m</span>
Sampling... Hit Ctrl-C to end.
^C
MODULE                                                  COUNT   PCNT
0xc107882e                                                  1   0.0%
0xc10e6aa4                                                  1   0.0%
0xc1076983                                                  1   0.0%
0xc109708a                                                  1   0.0%
0xc1075a5d                                                  1   0.0%
0xc1077325                                                  1   0.0%
0xc108a245                                                  1   0.0%
0xc107730d                                                  1   0.0%
0xc1097063                                                  2   0.0%
0xc108a253                                                 73   0.0%
kernel                                                    874   0.4%
0xc10981a5                                             213781  99.6%</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <span class="filename">procsystime</span> script captures and prints the system call time usage for a given process <code>ID</code> (<code>PID</code>) or process name. In the following example, a new instance of <span class="filename">/bin/csh</span> was spawned. Then, <span class="filename">procsystime</span> was executed and remained waiting while a few commands were typed on the other incarnation of <code>csh</code>. These are the results of this test:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ./procsystime -n csh</span>
Tracing... Hit Ctrl-C to end...
^C

Elapsed Times <span class="k">for </span>processes csh,

         SYSCALL          TIME <span class="o">(</span>ns<span class="o">)</span>
          getpid               6131
       sigreturn               8121
           close              19127
           fcntl              19959
             dup              26955
         setpgid              28070
            stat              31899
       setitimer              40938
           wait4              62717
       sigaction              67372
     sigprocmask             119091
    gettimeofday             183710
           write             263242
          execve             492547
           ioctl             770073
           vfork            3258923
      sigsuspend            6985124
            <span class="nb">read         </span>3988049784</code></pre>
</div>
</div>
<div class="paragraph">
<p>As shown, the <code>read()</code> system call used the most time in nanoseconds while the <code>getpid()</code> system call used the least amount of time.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="usb-device-mode">Chapter 28. USB Device Mode / USB OTG<a class="anchor" href="#usb-device-mode"></a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="usb-device-mode-synopsis">28.1. Synopsis<a class="anchor" href="#usb-device-mode-synopsis"></a></h3>
<div class="paragraph">
<p>This chapter covers the use of USB Device Mode and USB On The Go (USB OTG) in FreeBSD. This includes virtual serial consoles, virtual network interfaces, and virtual USB drives.</p>
</div>
<div class="paragraph">
<p>When running on hardware that supports USB device mode or USB OTG, like that built into many embedded boards, the FreeBSD USB stack can run in <em>device mode</em>. Device mode makes it possible for the computer to present itself as different kinds of USB device classes, including serial ports, network adapters, and mass storage, or a combination thereof. A USB host like a laptop or desktop computer is able to access them just like physical USB devices. Device mode is sometimes called the &#34;USB gadget mode&#34;.</p>
</div>
<div class="paragraph">
<p>There are two basic ways the hardware can provide the device mode functionality: with a separate &#34;client port&#34;, which only supports the device mode, and with a USB OTG port, which can provide both device and host mode. For USB OTG ports, the USB stack switches between host-side and device-side automatically, depending on what is connected to the port. Connecting a USB device like a memory stick to the port causes FreeBSD to switch to host mode. Connecting a USB host like a computer causes FreeBSD to switch to device mode. Single purpose &#34;client ports&#34; always work in device mode.</p>
</div>
<div class="paragraph">
<p>What FreeBSD presents to the USB host depends on the <code>hw.usb.template</code> sysctl. Some templates provide a single device, such as a serial terminal; others provide multiple ones, which can all be used at the same time. An example is the template 10, which provides a mass storage device, a serial console, and a network interface. See <a href="https://man.freebsd.org/cgi/man.cgi?query=usb_template&amp;sektion=4&amp;format=html">usb_template(4)</a> for the list of available values.</p>
</div>
<div class="paragraph">
<p>Note that in some cases, depending on the hardware and the hosts operating system, for the host to notice the configuration change, it must be either physically disconnected and reconnected, or forced to rescan the USB bus in a system-specific way. When FreeBSD is running on the host, <a href="https://man.freebsd.org/cgi/man.cgi?query=usbconfig&amp;sektion=8&amp;format=html">usbconfig(8)</a> <code>reset</code> can be used. This also must be done after loading <span class="filename">usb_template.ko</span> if the USB host was already connected to the USBOTG socket.</p>
</div>
<div class="paragraph">
<p>After reading this chapter, you will know:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>How to set up USB Device Mode functionality on FreeBSD.</p>
</li>
<li>
<p>How to configure the virtual serial port on FreeBSD.</p>
</li>
<li>
<p>How to connect to the virtual serial port from various operating systems.</p>
</li>
<li>
<p>How to configure FreeBSD to provide a virtual USB network interface.</p>
</li>
<li>
<p>How to configure FreeBSD to provide a virtual USB storage device.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="usb-device-mode-terminals">28.2. USB Virtual Serial Ports<a class="anchor" href="#usb-device-mode-terminals"></a></h3>
<div class="sect3">
<h4 id="_configuring_usb_device_mode_serial_ports">28.2.1. Configuring USB Device Mode Serial Ports<a class="anchor" href="#_configuring_usb_device_mode_serial_ports"></a></h4>
<div class="paragraph">
<p>Virtual serial port support is provided by templates number 3, 8, and 10. Note that template 3 works with Microsoft Windows 10 without the need for special drivers and INF files. Other host operating systems work with all three templates. Both <a href="https://man.freebsd.org/cgi/man.cgi?query=usb_template&amp;sektion=4&amp;format=html">usb_template(4)</a> and <a href="https://man.freebsd.org/cgi/man.cgi?query=umodem&amp;sektion=4&amp;format=html">umodem(4)</a> kernel modules must be loaded.</p>
</div>
<div class="paragraph">
<p>To enable USB device mode serial ports, add those lines to <span class="filename">/etc/ttys</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>ttyU0	&#34;/usr/libexec/getty 3wire&#34;	vt100	onifconsole secure
ttyU1	&#34;/usr/libexec/getty 3wire&#34;	vt100	onifconsole secure</pre>
</div>
</div>
<div class="paragraph">
<p>Then add these lines to <span class="filename">/etc/devd.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>notify 100 {
	match &#34;system&#34;		&#34;DEVFS&#34;;
	match &#34;subsystem&#34;	&#34;CDEV&#34;;
	match &#34;type&#34;		&#34;CREATE&#34;;
	match &#34;cdev&#34;		&#34;ttyU[0-9]+&#34;;
	action &#34;/sbin/init q&#34;;
};</pre>
</div>
</div>
<div class="paragraph">
<p>Reload the configuration if <a href="https://man.freebsd.org/cgi/man.cgi?query=devd&amp;sektion=8&amp;format=html">devd(8)</a> is already running:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># service devd restart</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Make sure the necessary modules are loaded and the correct template is set at boot by adding those lines to <span class="filename">/boot/loader.conf</span>, creating it if it does not already exist:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nv">umodem_load</span><span class="o">=</span><span class="s2">&#34;YES&#34;</span>
hw.usb.template<span class="o">=</span>3</code></pre>
</div>
</div>
<div class="paragraph">
<p>To load the module and set the template without rebooting use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># kldload umodem</span>
<span class="c"># sysctl hw.usb.template=3</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_connecting_to_usb_device_mode_serial_ports_from_freebsd">28.2.2. Connecting to USB Device Mode Serial Ports from FreeBSD<a class="anchor" href="#_connecting_to_usb_device_mode_serial_ports_from_freebsd"></a></h4>
<div class="paragraph">
<p>To connect to a board configured to provide USB device mode serial ports, connect the USB host, such as a laptop, to the boards USB OTG or USB client port. Use <code>pstat -t</code> on the host to list the terminal lines. Near the end of the list you should see a USB serial port, e.g. &#34;ttyU0&#34;. To open the connection, use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># cu -l /dev/ttyU0</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>After pressing the <kbd>Enter</kbd> key a few times you will see a login prompt.</p>
</div>
</div>
<div class="sect3">
<h4 id="_connecting_to_usb_device_mode_serial_ports_from_macos">28.2.3. Connecting to USB Device Mode Serial Ports from macOS<a class="anchor" href="#_connecting_to_usb_device_mode_serial_ports_from_macos"></a></h4>
<div class="paragraph">
<p>To connect to a board configured to provide USB device mode serial ports, connect the USB host, such as a laptop, to the boards USB OTG or USB client port. To open the connection, use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># cu -l /dev/cu.usbmodemFreeBSD1</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_connecting_to_usb_device_mode_serial_ports_from_linux">28.2.4. Connecting to USB Device Mode Serial Ports from Linux<a class="anchor" href="#_connecting_to_usb_device_mode_serial_ports_from_linux"></a></h4>
<div class="paragraph">
<p>To connect to a board configured to provide USB device mode serial ports, connect the USB host, such as a laptop, to the boards USB OTG or USB client port. To open the connection, use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># minicom -D /dev/ttyACM0</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_connecting_to_usb_device_mode_serial_ports_from_microsoft_windows_10">28.2.5. Connecting to USB Device Mode Serial Ports from Microsoft Windows 10<a class="anchor" href="#_connecting_to_usb_device_mode_serial_ports_from_microsoft_windows_10"></a></h4>
<div class="paragraph">
<p>To connect to a board configured to provide USB device mode serial ports, connect the USB host, such as a laptop, to the boards USB OTG or USB client port. To open a connection you will need a serial terminal program, such as PuTTY. To check the COM port name used by Windows, run Device Manager, expand &#34;Ports (COM &amp; LPT)&#34;. You will see a name similar to &#34;USB Serial Device (COM4)&#34;. Run serial terminal program of your choice, for example PuTTY. In the PuTTY dialog set &#34;Connection type&#34; to &#34;Serial&#34;, type the COMx obtained from Device Manager in the &#34;Serial line&#34; dialog box and click Open.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="usb-device-mode-network">28.3. USB Device Mode Network Interfaces<a class="anchor" href="#usb-device-mode-network"></a></h3>
<div class="paragraph">
<p>Virtual network interfaces support is provided by templates number 1, 8, and 10. Note that none of them works with Microsoft Windows. Other host operating systems work with all three templates. Both <a href="https://man.freebsd.org/cgi/man.cgi?query=usb_template&amp;sektion=4&amp;format=html">usb_template(4)</a> and <a href="https://man.freebsd.org/cgi/man.cgi?query=if_cdce&amp;sektion=4&amp;format=html">if_cdce(4)</a> kernel modules must be loaded.</p>
</div>
<div class="paragraph">
<p>Make sure the necessary modules are loaded and the correct template is set at boot by adding those lines to <span class="filename">/boot/loader.conf</span>, creating it if it does not already exist:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>if_cdce_load=&#34;YES&#34;
hw.usb.template=1</pre>
</div>
</div>
<div class="paragraph">
<p>To load the module and set the template without rebooting use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># kldload if_cdce</span>
<span class="c"># sysctl hw.usb.template=1</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="usb-device-mode-storage">28.4. USB Virtual Storage Device<a class="anchor" href="#usb-device-mode-storage"></a></h3>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <a href="https://man.freebsd.org/cgi/man.cgi?query=cfumass&amp;sektion=4&amp;format=html">cfumass(4)</a> driver is a USB device mode driver first available in FreeBSD 12.0.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Mass Storage target is provided by templates 0 and 10. Both <a href="https://man.freebsd.org/cgi/man.cgi?query=usb_template&amp;sektion=4&amp;format=html">usb_template(4)</a> and <a href="https://man.freebsd.org/cgi/man.cgi?query=cfumass&amp;sektion=4&amp;format=html">cfumass(4)</a> kernel modules must be loaded. <a href="https://man.freebsd.org/cgi/man.cgi?query=cfumass&amp;sektion=4&amp;format=html">cfumass(4)</a> interfaces to the CTL subsystem, the same one that is used for iSCSI or Fibre Channel targets. On the host side, USB Mass Storage initiators can only access a single LUN, LUN 0.</p>
</div>
<div class="sect3">
<h4 id="_configuring_usb_mass_storage_target_using_the_cfumass_startup_script">28.4.1. Configuring USB Mass Storage Target Using the cfumass Startup Script<a class="anchor" href="#_configuring_usb_mass_storage_target_using_the_cfumass_startup_script"></a></h4>
<div class="paragraph">
<p>The simplest way to set up a read-only USB storage target is to use the <span class="filename">cfumass</span> rc script. To configure it this way, copy the files to be presented to the USB host machine into the <code>/var/cfumass</code> directory, and add this line to <span class="filename">/etc/rc.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>cfumass_enable=&#34;YES&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>To configure the target without restarting, run this command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># service cfumass start</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Differently from serial and network functionality, the template should not be set to 0 or 10 in <span class="filename">/boot/loader.conf</span>. This is because the LUN must be set up before setting the template. The cfumass startup script sets the correct template number automatically when started.</p>
</div>
</div>
<div class="sect3">
<h4 id="_configuring_usb_mass_storage_using_other_means">28.4.2. Configuring USB Mass Storage Using Other Means<a class="anchor" href="#_configuring_usb_mass_storage_using_other_means"></a></h4>
<div class="paragraph">
<p>The rest of this chapter provides detailed description of setting the target without using the cfumass rc file. This is necessary if e.g. one wants to provide a writeable LUN.</p>
</div>
<div class="paragraph">
<p>USB Mass Storage does not require the <a href="https://man.freebsd.org/cgi/man.cgi?query=ctld&amp;sektion=8&amp;format=html">ctld(8)</a> daemon to be running, although it can be used if desired. This is different from iSCSI. Thus, there are two ways to configure the target: <a href="https://man.freebsd.org/cgi/man.cgi?query=ctladm&amp;sektion=8&amp;format=html">ctladm(8)</a>, or <a href="https://man.freebsd.org/cgi/man.cgi?query=ctld&amp;sektion=8&amp;format=html">ctld(8)</a>. Both require the <span class="filename">cfumass.ko</span> kernel module to be loaded. The module can be loaded manually:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># kldload cfumass</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If <span class="filename">cfumass.ko</span> has not been built into the kernel, <span class="filename">/boot/loader.conf</span> can be set to load the module at boot:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>cfumass_load=&#34;YES&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>A LUN can be created without the <a href="https://man.freebsd.org/cgi/man.cgi?query=ctld&amp;sektion=8&amp;format=html">ctld(8)</a> daemon:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ctladm create -b block -o file=/data/target0</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This presents the contents of the image file <span class="filename">/data/target0</span> as a LUN to the USB host. The file must exist before executing the command. To configure the LUN at system startup, add the command to <span class="filename">/etc/rc.local</span>.</p>
</div>
<div class="paragraph">
<p><a href="https://man.freebsd.org/cgi/man.cgi?query=ctld&amp;sektion=8&amp;format=html">ctld(8)</a> can also be used to manage LUNs. Create <span class="filename">/etc/ctl.conf</span>, add a line to <span class="filename">/etc/rc.conf</span> to make sure <a href="https://man.freebsd.org/cgi/man.cgi?query=ctld&amp;sektion=8&amp;format=html">ctld(8)</a> is automatically started at boot, and then start the daemon.</p>
</div>
<div class="paragraph">
<p>This is an example of a simple <span class="filename">/etc/ctl.conf</span> configuration file. Refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=ctl.conf&amp;sektion=5&amp;format=html">ctl.conf(5)</a> for a more complete description of the options.</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>target naa.50015178f369f092 {
	lun 0 {
		path /data/target0
		size 4G
	}
}</pre>
</div>
</div>
<div class="paragraph">
<p>The example creates a single target with a single LUN. The <code>naa.50015178f369f092</code> is a device identifier composed of 32 random hexadecimal digits. The <code>path</code> line defines the full path to a file or zvol backing the LUN. That file must exist before starting <a href="https://man.freebsd.org/cgi/man.cgi?query=ctld&amp;sektion=8&amp;format=html">ctld(8)</a>. The second line is optional and specifies the size of the LUN.</p>
</div>
<div class="paragraph">
<p>To make sure the <a href="https://man.freebsd.org/cgi/man.cgi?query=ctld&amp;sektion=8&amp;format=html">ctld(8)</a> daemon is started at boot, add this line to <span class="filename">/etc/rc.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>ctld_enable=&#34;YES&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>To start <a href="https://man.freebsd.org/cgi/man.cgi?query=ctld&amp;sektion=8&amp;format=html">ctld(8)</a> now, run this command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># service ctld start</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As the <a href="https://man.freebsd.org/cgi/man.cgi?query=ctld&amp;sektion=8&amp;format=html">ctld(8)</a> daemon is started, it reads <span class="filename">/etc/ctl.conf</span>. If this file is edited after the daemon starts, reload the changes so they take effect immediately:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># service ctld reload</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<h1 id="network-communication" class="sect0">Part IV: 网络通信<a class="anchor" href="#network-communication"></a></h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>FreeBSD 是最广泛部署的高性能网络服务器操作系统之一。本部分的章节内容包括：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>串行通信</p>
</li>
<li>
<p>PPP 和以太网上的 PPP</p>
</li>
<li>
<p>电子邮件</p>
</li>
<li>
<p>运行网络服务器</p>
</li>
<li>
<p>防火墙</p>
</li>
<li>
<p>其他高级网络主题</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>这些章节的设计是在需要信息时阅读。它们不需要按照特定的顺序阅读，也不需要在使用 FreeBSD 在网络环境中之前阅读所有章节。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="serialcomms">Chapter 29. Serial Communications<a class="anchor" href="#serialcomms"></a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="serial-synopsis">29.1. Synopsis<a class="anchor" href="#serial-synopsis"></a></h3>
<div class="paragraph">
<p>UNIX® has always had support for serial communications as the very first UNIX® machines relied on serial lines for user input and output. Things have changed a lot from the days when the average terminal consisted of a 10-character-per-second serial printer and a keyboard. This chapter covers some of the ways serial communications can be used on FreeBSD.</p>
</div>
<div class="paragraph">
<p>After reading this chapter, you will know:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>How to connect terminals to a FreeBSD system.</p>
</li>
<li>
<p>How to use a modem to dial out to remote hosts.</p>
</li>
<li>
<p>How to allow remote users to login to a FreeBSD system with a modem.</p>
</li>
<li>
<p>How to boot a FreeBSD system from a serial console.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Before reading this chapter, you should:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Know how to <a href="./#kernelconfig">configure and install a custom kernel</a>.</p>
</li>
<li>
<p>Understand <a href="./#basics">FreeBSD permissions and processes</a>.</p>
</li>
<li>
<p>Have access to the technical manual for the serial hardware to be used with FreeBSD.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="serial">29.2. Serial Terminology and Hardware<a class="anchor" href="#serial"></a></h3>
<div class="paragraph">
<p>The following terms are often used in serial communications:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">bps</dt>
<dd>
<p>Bits per Second (bps) is the rate at which data is transmitted.</p>
</dd>
<dt class="hdlist1">DTE</dt>
<dd>
<p>Data Terminal Equipment (DTE) is one of two endpoints in a serial communication. An example would be a computer.</p>
</dd>
<dt class="hdlist1">DCE</dt>
<dd>
<p>Data Communications Equipment (DCE) is the other endpoint in a serial communication. Typically, it is a modem or serial terminal.</p>
</dd>
<dt class="hdlist1">RS-232</dt>
<dd>
<p>The original standard which defined hardware serial communications. It has since been renamed to TIA-232.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>When referring to communication data rates, this section does not use the term <em>baud</em>. Baud refers to the number of electrical state transitions made in a period of time, while bps is the correct term to use.</p>
</div>
<div class="paragraph">
<p>To connect a serial terminal to a FreeBSD system, a serial port on the computer and the proper cable to connect to the serial device are needed. Users who are already familiar with serial hardware and cabling can safely skip this section.</p>
</div>
<div class="sect3">
<h4 id="term-cables-null">29.2.1. Serial Cables and Ports<a class="anchor" href="#term-cables-null"></a></h4>
<div class="paragraph">
<p>There are several different kinds of serial cables. The two most common types are null-modem cables and standard RS-232 cables. The documentation for the hardware should describe the type of cable required.</p>
</div>
<div class="paragraph">
<p>These two types of cables differ in how the wires are connected to the connector. Each wire represents a signal, with the defined signals summarized in <a href="#serialcomms-signal-names">RS-232C Signal Names</a>. A standard serial cable passes all of the RS-232C signals straight through. For example, the &#34;Transmitted Data&#34; pin on one end of the cable goes to the &#34;Transmitted Data&#34; pin on the other end. This is the type of cable used to connect a modem to the FreeBSD system, and is also appropriate for some terminals.</p>
</div>
<div class="paragraph">
<p>A null-modem cable switches the &#34;Transmitted Data&#34; pin of the connector on one end with the &#34;Received Data&#34; pin on the other end. The connector can be either a DB-25 or a DB-9.</p>
</div>
<div class="paragraph">
<p>A null-modem cable can be constructed using the pin connections summarized in <a href="#nullmodem-db25">DB-25 to DB-25 Null-Modem Cable</a>, <a href="#nullmodem-db9">DB-9 to DB-9 Null-Modem Cable</a>, and <a href="#nullmodem-db9-25">DB-9 to DB-25 Null-Modem Cable</a>. While the standard calls for a straight-through pin 1 to pin 1 &#34;Protective Ground&#34; line, it is often omitted. Some terminals work using only pins 2, 3, and 7, while others require different configurations. When in doubt, refer to the documentation for the hardware.</p>
</div>
<table id="serialcomms-signal-names" class="tableblock frame-none grid-all stretch">
<caption class="title">表 38. RS-232C Signal Names</caption>
<colgroup>
<col style="width: 50%;"/>
<col style="width: 50%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Acronyms</th>
<th class="tableblock halign-left valign-top">Names</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">RD</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Received Data</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">TD</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Transmitted Data</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">DTR</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Data Terminal Ready</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">DSR</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Data Set Ready</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">DCD</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Data Carrier Detect</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SG</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Signal Ground</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">RTS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Request to Send</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CTS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Clear to Send</p></td>
</tr>
</tbody>
</table>
<table id="nullmodem-db25" class="tableblock frame-none grid-all stretch">
<caption class="title">表 39. DB-25 to DB-25 Null-Modem Cable</caption>
<colgroup>
<col style="width: 20%;"/>
<col style="width: 20%;"/>
<col style="width: 20%;"/>
<col style="width: 20%;"/>
<col style="width: 20%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Signal</th>
<th class="tableblock halign-left valign-top">Pin #</th>
<th class="tableblock halign-left valign-top"></th>
<th class="tableblock halign-left valign-top">Pin #</th>
<th class="tableblock halign-left valign-top">Signal</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SG</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">connects to</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SG</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">TD</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">connects to</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">RD</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">RD</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">connects to</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TD</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">RTS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">connects to</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CTS</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CTS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">connects to</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">RTS</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">DTR</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">20</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">connects to</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">6</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DSR</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">DTR</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">20</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">connects to</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DCD</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">DSR</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">6</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">connects to</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">20</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DTR</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">DCD</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">connects to</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">20</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DTR</p></td>
</tr>
</tbody>
</table>
<table id="nullmodem-db9" class="tableblock frame-none grid-all stretch">
<caption class="title">表 40. DB-9 to DB-9 Null-Modem Cable</caption>
<colgroup>
<col style="width: 20%;"/>
<col style="width: 20%;"/>
<col style="width: 20%;"/>
<col style="width: 20%;"/>
<col style="width: 20%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Signal</th>
<th class="tableblock halign-left valign-top">Pin #</th>
<th class="tableblock halign-left valign-top"></th>
<th class="tableblock halign-left valign-top">Pin #</th>
<th class="tableblock halign-left valign-top">Signal</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">RD</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">connects to</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TD</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">TD</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">connects to</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">RD</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">DTR</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">connects to</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">6</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DSR</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">DTR</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">connects to</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DCD</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SG</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">connects to</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SG</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">DSR</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">6</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">connects to</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DTR</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">DCD</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">connects to</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DTR</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">RTS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">connects to</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CTS</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CTS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">connects to</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">RTS</p></td>
</tr>
</tbody>
</table>
<table id="nullmodem-db9-25" class="tableblock frame-none grid-all stretch">
<caption class="title">表 41. DB-9 to DB-25 Null-Modem Cable</caption>
<colgroup>
<col style="width: 20%;"/>
<col style="width: 20%;"/>
<col style="width: 20%;"/>
<col style="width: 20%;"/>
<col style="width: 20%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Signal</th>
<th class="tableblock halign-left valign-top">Pin #</th>
<th class="tableblock halign-left valign-top"></th>
<th class="tableblock halign-left valign-top">Pin #</th>
<th class="tableblock halign-left valign-top">Signal</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">RD</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">connects to</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TD</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">TD</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">connects to</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">RD</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">DTR</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">connects to</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">6</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DSR</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">DTR</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">connects to</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DCD</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SG</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">connects to</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SG</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">DSR</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">6</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">connects to</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">20</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DTR</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">DCD</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">connects to</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">20</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DTR</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">RTS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">connects to</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CTS</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CTS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">connects to</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">RTS</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When one pin at one end connects to a pair of pins at the other end, it is usually implemented with one short wire between the pair of pins in their connector and a long wire to the other single pin.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Serial ports are the devices through which data is transferred between the FreeBSD host computer and the terminal. Several kinds of serial ports exist. Before purchasing or constructing a cable, make sure it will fit the ports on the terminal and on the FreeBSD system.</p>
</div>
<div class="paragraph">
<p>Most terminals have DB-25 ports. Personal computers may have DB-25 or DB-9 ports. A multiport serial card may have RJ-12 or RJ-45/ ports. See the documentation that accompanied the hardware for specifications on the kind of port or visually verify the type of port.</p>
</div>
<div class="paragraph">
<p>In FreeBSD, each serial port is accessed through an entry in <span class="filename">/dev</span>. There are two different kinds of entries:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Call-in ports are named <span class="filename">/dev/ttyuN</span> where <em>N</em> is the port number, starting from zero. If a terminal is connected to the first serial port (<span class="filename">COM1</span>), use <span class="filename">/dev/ttyu0</span> to refer to the terminal. If the terminal is on the second serial port (<span class="filename">COM2</span>), use <span class="filename">/dev/ttyu1</span>, and so forth. Generally, the call-in port is used for terminals. Call-in ports require that the serial line assert the &#34;Data Carrier Detect&#34; signal to work correctly.</p>
</li>
<li>
<p>Call-out ports are named <span class="filename">/dev/cuauN</span> on FreeBSD versions 8.X and higher and <span class="filename">/dev/cuadN</span> on FreeBSD versions 7.X and lower. Call-out ports are usually not used for terminals, but are used for modems. The call-out port can be used if the serial cable or the terminal does not support the &#34;Data Carrier Detect&#34; signal.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>FreeBSD also provides initialization devices (<span class="filename">/dev/ttyuN.init</span> and <span class="filename">/dev/cuauN.init</span> or <span class="filename">/dev/cuadN.init</span>) and locking devices (<span class="filename">/dev/ttyuN.lock</span> and <span class="filename">/dev/cuauN.lock</span> or <span class="filename">/dev/cuadN.lock</span>). The initialization devices are used to initialize communications port parameters each time a port is opened, such as <code>crtscts</code> for modems which use <code>RTS/CTS</code> signaling for flow control. The locking devices are used to lock flags on ports to prevent users or programs changing certain parameters. Refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=termios&amp;sektion=4&amp;format=html">termios(4)</a>, <a href="https://man.freebsd.org/cgi/man.cgi?query=uart&amp;sektion=4&amp;format=html">uart(4)</a>, and <a href="https://man.freebsd.org/cgi/man.cgi?query=stty&amp;sektion=1&amp;format=html">stty(1)</a> for information on terminal settings, locking and initializing devices, and setting terminal options, respectively.</p>
</div>
</div>
<div class="sect3">
<h4 id="serial-hw-config">29.2.2. Serial Port Configuration<a class="anchor" href="#serial-hw-config"></a></h4>
<div class="paragraph">
<p>By default, FreeBSD supports four serial ports which are commonly known as <span class="filename">COM1</span>, <span class="filename">COM2</span>, <span class="filename">COM3</span>, and <span class="filename">COM4</span>. FreeBSD also supports dumb multi-port serial interface cards, such as the BocaBoard 1008 and 2016, as well as more intelligent multi-port cards such as those made by Digiboard. However, the default kernel only looks for the standard <span class="filename">COM</span> ports.</p>
</div>
<div class="paragraph">
<p>To see if the system recognizes the serial ports, look for system boot messages that start with <code>uart</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># grep uart /var/run/dmesg.boot</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If the system does not recognize all of the needed serial ports, additional entries can be added to <span class="filename">/boot/device.hints</span>. This file already contains <code>hint.uart.0.*</code> entries for <span class="filename">COM1</span> and <code>hint.uart.1.*</code> entries for <span class="filename">COM2</span>. When adding a port entry for <span class="filename">COM3</span> use <code>0x3E8</code>, and for <span class="filename">COM4</span> use <code>0x2E8</code>. Common IRQ addresses are <code>5</code> for <span class="filename">COM3</span> and <code>9</code> for <span class="filename">COM4</span>.</p>
</div>
<div class="paragraph">
<p>To determine the default set of terminal I/O settings used by the port, specify its device name. This example determines the settings for the call-in port on <span class="filename">COM2</span>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># stty -a -f /dev/ttyu1</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>System-wide initialization of serial devices is controlled by <span class="filename">/etc/rc.d/serial</span>. This file affects the default settings of serial devices. To change the settings for a device, use <code>stty</code>. By default, the changed settings are in effect until the device is closed and when the device is reopened, it goes back to the default set. To permanently change the default set, open and adjust the settings of the initialization device. For example, to turn on <code>CLOCAL</code> mode, 8 bit communication, and <code>XON/XOFF</code> flow control for <span class="filename">ttyu5</span>, type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># stty -f /dev/ttyu5.init clocal cs8 ixon ixoff</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To prevent certain settings from being changed by an application, make adjustments to the locking device. For example, to lock the speed of <span class="filename">ttyu5</span> to 57600 bps, type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># stty -f /dev/ttyu5.lock 57600</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, any application that opens <span class="filename">ttyu5</span> and tries to change the speed of the port will be stuck with 57600 bps.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="term">29.3. Terminals<a class="anchor" href="#term"></a></h3>
<div class="paragraph">
<p>Terminals provide a convenient and low-cost way to access a FreeBSD system when not at the computer’s console or on a connected network. This section describes how to use terminals with FreeBSD.</p>
</div>
<div class="paragraph">
<p>The original UNIX® systems did not have consoles. Instead, users logged in and ran programs through terminals that were connected to the computer’s serial ports.</p>
</div>
<div class="paragraph">
<p>The ability to establish a login session on a serial port still exists in nearly every UNIX®-like operating system today, including FreeBSD. By using a terminal attached to an unused serial port, a user can log in and run any text program that can normally be run on the console or in an <code>xterm</code> window.</p>
</div>
<div class="paragraph">
<p>Many terminals can be attached to a FreeBSD system. An older spare computer can be used as a terminal wired into a more powerful computer running FreeBSD. This can turn what might otherwise be a single-user computer into a powerful multiple-user system.</p>
</div>
<div class="paragraph">
<p>FreeBSD supports three types of terminals:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Dumb terminals</dt>
<dd>
<p>Dumb terminals are specialized hardware that connect to computers over serial lines. They are called &#34;dumb&#34; because they have only enough computational power to display, send, and receive text. No programs can be run on these devices. Instead, dumb terminals connect to a computer that runs the needed programs.</p>
<div class="paragraph">
<p>There are hundreds of kinds of dumb terminals made by many manufacturers, and just about any kind will work with FreeBSD. Some high-end terminals can even display graphics, but only certain software packages can take advantage of these advanced features.</p>
</div>
<div class="paragraph">
<p>Dumb terminals are popular in work environments where workers do not need access to graphical applications.</p>
</div>
</dd>
<dt class="hdlist1">Computers Acting as Terminals</dt>
<dd>
<p>Since a dumb terminal has just enough ability to display, send, and receive text, any spare computer can be a dumb terminal. All that is needed is the proper cable and some <em>terminal emulation</em> software to run on the computer.</p>
<div class="paragraph">
<p>This configuration can be useful. For example, if one user is busy working at the FreeBSD system’s console, another user can do some text-only work at the same time from a less powerful personal computer hooked up as a terminal to the FreeBSD system.</p>
</div>
<div class="paragraph">
<p>There are at least two utilities in the base-system of FreeBSD that can be used to work through a serial connection: <a href="https://man.freebsd.org/cgi/man.cgi?query=cu&amp;sektion=1&amp;format=html">cu(1)</a> and <a href="https://man.freebsd.org/cgi/man.cgi?query=tip&amp;sektion=1&amp;format=html">tip(1)</a>.</p>
</div>
<div class="paragraph">
<p>For example, to connect from a client system that runs FreeBSD to the serial connection of another system:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># cu -l /dev/cuauN</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ports are numbered starting from zero. This means that <span class="filename">COM1</span> is <span class="filename">/dev/cuau0</span>.</p>
</div>
<div class="paragraph">
<p>Additional programs are available through the Ports Collection, such as <a class="package" href="https://cgit.freebsd.org/ports/tree/comms/minicom/">comms/minicom</a>.</p>
</div>
</dd>
<dt class="hdlist1">X Terminals</dt>
<dd>
<p>X terminals are the most sophisticated kind of terminal available. Instead of connecting to a serial port, they usually connect to a network like Ethernet. Instead of being relegated to text-only applications, they can display any Xorg application.</p>
<div class="paragraph">
<p>This chapter does not cover the setup, configuration, or use of X terminals.</p>
</div>
</dd>
</dl>
</div>
<div class="sect3">
<h4 id="term-config">29.3.1. Terminal Configuration<a class="anchor" href="#term-config"></a></h4>
<div class="paragraph">
<p>This section describes how to configure a FreeBSD system to enable a login session on a serial terminal. It assumes that the system recognizes the serial port to which the terminal is connected and that the terminal is connected with the correct cable.</p>
</div>
<div class="paragraph">
<p>In FreeBSD, <code>init</code> reads <span class="filename">/etc/ttys</span> and starts a <code>getty</code> process on the available terminals. The <code>getty</code> process is responsible for reading a login name and starting the <code>login</code> program. The ports on the FreeBSD system which allow logins are listed in <span class="filename">/etc/ttys</span>. For example, the first virtual console, <span class="filename">ttyv0</span>, has an entry in this file, allowing logins on the console. This file also contains entries for the other virtual consoles, serial ports, and pseudo-ttys. For a hardwired terminal, the serial port’s <span class="filename">/dev</span> entry is listed without the <code>/dev</code> part. For example, <span class="filename">/dev/ttyv0</span> is listed as <code>ttyv0</code>.</p>
</div>
<div class="paragraph">
<p>The default <span class="filename">/etc/ttys</span> configures support for the first four serial ports, <span class="filename">ttyu0</span> through <span class="filename">ttyu3</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>ttyu0   &#34;/usr/libexec/getty std.9600&#34;   dialup  off secure
ttyu1   &#34;/usr/libexec/getty std.9600&#34;   dialup  off secure
ttyu2   &#34;/usr/libexec/getty std.9600&#34;   dialup  off secure
ttyu3   &#34;/usr/libexec/getty std.9600&#34;   dialup  off secure</pre>
</div>
</div>
<div class="paragraph">
<p>When attaching a terminal to one of those ports, modify the default entry to set the required speed and terminal type, to turn the device <code>on</code> and, if needed, to change the port’s <code>secure</code> setting. If the terminal is connected to another port, add an entry for the port.</p>
</div>
<div class="paragraph">
<p><a href="#ex-etc-ttys">Configuring Terminal Entries</a> configures two terminals in <span class="filename">/etc/ttys</span>. The first entry configures a Wyse-50 connected to <span class="filename">COM2</span>. The second entry configures an old computer running Procomm terminal software emulating a VT-100 terminal. The computer is connected to the sixth serial port on a multi-port serial card.</p>
</div>
<div id="ex-etc-ttys" class="exampleblock">
<div class="title">例 34. Configuring Terminal Entries</div>
<div class="content">
<div class="literalblock programlisting">
<div class="content">
<pre>ttyu1  &#34;/usr/libexec/getty std.38400&#34;  wy50   on insecure
ttyu5   &#34;/usr/libexec/getty std.19200&#34;  vt100  on insecure</pre>
</div>
</div>
<div class="paragraph">
<p>The first field specifies the device name of the serial terminal.</p>
</div>
<div class="paragraph">
<p>The second field tells <code>getty</code> to initialize and open the line, set the line speed, prompt for a user name, and then execute the <code>login</code> program. The optional <em>getty type</em> configures characteristics on the terminal line, like bps rate and parity. The available getty types are listed in <span class="filename">/etc/gettytab</span>. In almost all cases, the getty types that start with <code>std</code> will work for hardwired terminals as these entries ignore parity. There is a <code>std</code> entry for each bps rate from 110 to 115200. Refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=gettytab&amp;sektion=5&amp;format=html">gettytab(5)</a> for more information. When setting the getty type, make sure to match the communications settings used by the terminal. For this example, the Wyse-50 uses no parity and connects at 38400 bps. The computer uses no parity and connects at 19200 bps.</p>
</div>
<div class="paragraph">
<p>The third field is the type of terminal. For dial-up ports, <code>unknown</code> or <code>dialup</code> is typically used since users may dial up with practically any type of terminal or software. Since the terminal type does not change for hardwired terminals, a real terminal type from <span class="filename">/etc/termcap</span> can be specified. For this example, the Wyse-50 uses the real terminal type while the computer running Procomm is set to emulate a VT-100.</p>
</div>
<div class="paragraph">
<p>The fourth field specifies if the port should be enabled. To enable logins on this port, this field must be set to <code>on</code>.</p>
</div>
<div class="paragraph">
<p>The final field is used to specify whether the port is secure. Marking a port as <code>secure</code> means that it is trusted enough to allow <code>root</code> to login from that port. Insecure ports do not allow <code>root</code> logins. On an insecure port, users must login from unprivileged accounts and then use <code>su</code> or a similar mechanism to gain superuser privileges, as described in <a href="./#users-superuser">“The Superuser Account”</a>. For security reasons, it is recommended to change this setting to <code>insecure</code>.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>After making any changes to <span class="filename">/etc/ttys</span>, send a SIGHUP (hangup) signal to the <code>init</code> process to force it to re-read its configuration file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># kill -HUP 1</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Since <code>init</code> is always the first process run on a system, it always has a process ID of <code>1</code>.</p>
</div>
<div class="paragraph">
<p>If everything is set up correctly, all cables are in place, and the terminals are powered up, a <code>getty</code> process should now be running on each terminal and login prompts should be available on each terminal.</p>
</div>
</div>
<div class="sect3">
<h4 id="term-debug">29.3.2. Troubleshooting the Connection<a class="anchor" href="#term-debug"></a></h4>
<div class="paragraph">
<p>Even with the most meticulous attention to detail, something could still go wrong while setting up a terminal. Here is a list of common symptoms and some suggested fixes.</p>
</div>
<div class="paragraph">
<p>If no login prompt appears, make sure the terminal is plugged in and powered up. If it is a personal computer acting as a terminal, make sure it is running terminal emulation software on the correct serial port.</p>
</div>
<div class="paragraph">
<p>Make sure the cable is connected firmly to both the terminal and the FreeBSD computer. Make sure it is the right kind of cable.</p>
</div>
<div class="paragraph">
<p>Make sure the terminal and FreeBSD agree on the bps rate and parity settings. For a video display terminal, make sure the contrast and brightness controls are turned up. If it is a printing terminal, make sure paper and ink are in good supply.</p>
</div>
<div class="paragraph">
<p>Use <code>ps</code> to make sure that a <code>getty</code> process is running and serving the terminal. For example, the following listing shows that a <code>getty</code> is running on the second serial port, <span class="filename">ttyu1</span>, and is using the <code>std.38400</code> entry in <span class="filename">/etc/gettytab</span>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ps -axww|grep ttyu</span>
22189  d1  Is+    0:00.03 /usr/libexec/getty std.38400 ttyu1</code></pre>
</div>
</div>
<div class="paragraph">
<p>If no <code>getty</code> process is running, make sure the port is enabled in <span class="filename">/etc/ttys</span>. Remember to run <code>kill -HUP 1</code> after modifying <span class="filename">/etc/ttys</span>.</p>
</div>
<div class="paragraph">
<p>If the <code>getty</code> process is running but the terminal still does not display a login prompt, or if it displays a prompt but will not accept typed input, the terminal or cable may not support hardware handshaking. Try changing the entry in <span class="filename">/etc/ttys</span> from <code>std.38400</code> to <code>3wire.38400</code>, then run <code>kill -HUP 1</code> after modifying <span class="filename">/etc/ttys</span>. The <code>3wire</code> entry is similar to <code>std</code>, but ignores hardware handshaking. The bps may also need to be reduced or software flow control enabled when using <code>3wire</code> to prevent buffer overflows.</p>
</div>
<div class="paragraph">
<p>If garbage appears instead of a login prompt, make sure the terminal and FreeBSD agree on the bps rate and parity settings. Check the <code>getty</code> processes to make sure the correct <em>getty</em> type is in use. If not, edit <span class="filename">/etc/ttys</span> and run <code>kill -HUP 1</code>.</p>
</div>
<div class="paragraph">
<p>If characters appear doubled and the password appears when typed, switch the terminal, or the terminal emulation software, from &#34;half duplex&#34; or &#34;local echo&#34; to &#34;full duplex.&#34;</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="dialup">29.4. Dial-in Service<a class="anchor" href="#dialup"></a></h3>
<div class="paragraph">
<p>Configuring a FreeBSD system for dial-in service is similar to configuring terminals, except that modems are used instead of terminal devices. FreeBSD supports both external and internal modems.</p>
</div>
<div class="paragraph">
<p>External modems are more convenient because they often can be configured via parameters stored in non-volatile RAM and they usually provide lighted indicators that display the state of important RS-232 signals, indicating whether the modem is operating properly.</p>
</div>
<div class="paragraph">
<p>Internal modems usually lack non-volatile RAM, so their configuration may be limited to setting DIP switches. If the internal modem has any signal indicator lights, they are difficult to view when the system’s cover is in place.</p>
</div>
<div class="paragraph">
<p>When using an external modem, a proper cable is needed. A standard RS-232C serial cable should suffice.</p>
</div>
<div class="paragraph">
<p>FreeBSD needs the RTS and CTS signals for flow control at speeds above 2400 bps, the CD signal to detect when a call has been answered or the line has been hung up, and the DTR signal to reset the modem after a session is complete. Some cables are wired without all of the needed signals, so if a login session does not go away when the line hangs up, there may be a problem with the cable. Refer to <a href="#term-cables-null">Serial Cables and Ports</a> for more information about these signals.</p>
</div>
<div class="paragraph">
<p>Like other UNIX®-like operating systems, FreeBSD uses the hardware signals to find out when a call has been answered or a line has been hung up and to hangup and reset the modem after a call. FreeBSD avoids sending commands to the modem or watching for status reports from the modem.</p>
</div>
<div class="paragraph">
<p>FreeBSD supports the NS8250, NS16450, NS16550, and NS16550A-based RS-232C (CCITT V.24) communications interfaces. The 8250 and 16450 devices have single-character buffers. The 16550 device provides a 16-character buffer, which allows for better system performance. Bugs in plain 16550 devices prevent the use of the 16-character buffer, so use 16550A devices if possible. As single-character-buffer devices require more work by the operating system than the 16-character-buffer devices, 16550A-based serial interface cards are preferred. If the system has many active serial ports or will have a heavy load, 16550A-based cards are better for low-error-rate communications.</p>
</div>
<div class="paragraph">
<p>The rest of this section demonstrates how to configure a modem to receive incoming connections, how to communicate with the modem, and offers some troubleshooting tips.</p>
</div>
<div class="sect3">
<h4 id="dialup-ttys">29.4.1. Modem Configuration<a class="anchor" href="#dialup-ttys"></a></h4>
<div class="paragraph">
<p>As with terminals, <code>init</code> spawns a <code>getty</code> process for each configured serial port used for dial-in connections. When a user dials the modem’s line and the modems connect, the &#34;Carrier Detect&#34; signal is reported by the modem. The kernel notices that the carrier has been detected and instructs <code>getty</code> to open the port and display a <code>login:</code> prompt at the specified initial line speed. In a typical configuration, if garbage characters are received, usually due to the modem’s connection speed being different than the configured speed, <code>getty</code> tries adjusting the line speeds until it receives reasonable characters. After the user enters their login name, <code>getty</code> executes <code>login</code>, which completes the login process by asking for the user’s password and then starting the user’s shell.</p>
</div>
<div class="paragraph">
<p>There are two schools of thought regarding dial-up modems. One configuration method is to set the modems and systems so that no matter at what speed a remote user dials in, the dial-in RS-232 interface runs at a locked speed. The benefit of this configuration is that the remote user always sees a system login prompt immediately. The downside is that the system does not know what a user’s true data rate is, so full-screen programs like Emacs will not adjust their screen-painting methods to make their response better for slower connections.</p>
</div>
<div class="paragraph">
<p>The second method is to configure the RS-232 interface to vary its speed based on the remote user’s connection speed. As <code>getty</code> does not understand any particular modem’s connection speed reporting, it gives a <code>login:</code> message at an initial speed and watches the characters that come back in response. If the user sees junk, they should press <kbd>Enter</kbd> until they see a recognizable prompt. If the data rates do not match, <code>getty</code> sees anything the user types as junk, tries the next speed, and gives the <code>login:</code> prompt again. This procedure normally only takes a keystroke or two before the user sees a good prompt. This login sequence does not look as clean as the locked-speed method, but a user on a low-speed connection should receive better interactive response from full-screen programs.</p>
</div>
<div class="paragraph">
<p>When locking a modem’s data communications rate at a particular speed, no changes to <span class="filename">/etc/gettytab</span> should be needed. However, for a matching-speed configuration, additional entries may be required in order to define the speeds to use for the modem. This example configures a 14.4 Kbps modem with a top interface speed of 19.2 Kbps using 8-bit, no parity connections. It configures <code>getty</code> to start the communications rate for a V.32bis connection at 19.2 Kbps, then cycles through 9600 bps, 2400 bps, 1200 bps, 300 bps, and back to 19.2 Kbps. Communications rate cycling is implemented with the <code>nx=</code> (next table) capability. Each line uses a <code>tc=</code> (table continuation) entry to pick up the rest of the settings for a particular data rate.</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>#
# Additions for a V.32bis Modem
#
um|V300|High Speed Modem at 300,8-bit:\
        :nx=V19200:tc=std.300:
un|V1200|High Speed Modem at 1200,8-bit:\
        :nx=V300:tc=std.1200:
uo|V2400|High Speed Modem at 2400,8-bit:\
        :nx=V1200:tc=std.2400:
up|V9600|High Speed Modem at 9600,8-bit:\
        :nx=V2400:tc=std.9600:
uq|V19200|High Speed Modem at 19200,8-bit:\
        :nx=V9600:tc=std.19200:</pre>
</div>
</div>
<div class="paragraph">
<p>For a 28.8 Kbps modem, or to take advantage of compression on a 14.4 Kbps modem, use a higher communications rate, as seen in this example:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>#
# Additions for a V.32bis or V.34 Modem
# Starting at 57.6 Kbps
#
vm|VH300|Very High Speed Modem at 300,8-bit:\
        :nx=VH57600:tc=std.300:
vn|VH1200|Very High Speed Modem at 1200,8-bit:\
        :nx=VH300:tc=std.1200:
vo|VH2400|Very High Speed Modem at 2400,8-bit:\
        :nx=VH1200:tc=std.2400:
vp|VH9600|Very High Speed Modem at 9600,8-bit:\
        :nx=VH2400:tc=std.9600:
vq|VH57600|Very High Speed Modem at 57600,8-bit:\
        :nx=VH9600:tc=std.57600:</pre>
</div>
</div>
<div class="paragraph">
<p>For a slow CPU or a heavily loaded system without 16550A-based serial ports, this configuration may produce <code>uart</code> &#34;silo&#34; errors at 57.6 Kbps.</p>
</div>
<div class="paragraph">
<p>The configuration of <span class="filename">/etc/ttys</span> is similar to <a href="#ex-etc-ttys">Configuring Terminal Entries</a>, but a different argument is passed to <code>getty</code> and <code>dialup</code> is used for the terminal type. Replace <em>xxx</em> with the process <code>init</code> will run on the device:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>ttyu0   &#34;/usr/libexec/getty xxx&#34;   dialup on</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>dialup</code> terminal type can be changed. For example, setting <code>vt102</code> as the default terminal type allows users to use VT102 emulation on their remote systems.</p>
</div>
<div class="paragraph">
<p>For a locked-speed configuration, specify the speed with a valid type listed in <span class="filename">/etc/gettytab</span>. This example is for a modem whose port speed is locked at 19.2 Kbps:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>ttyu0   &#34;/usr/libexec/getty std.19200&#34;   dialup on</pre>
</div>
</div>
<div class="paragraph">
<p>In a matching-speed configuration, the entry needs to reference the appropriate beginning &#34;auto-baud&#34; entry in <span class="filename">/etc/gettytab</span>. To continue the example for a matching-speed modem that starts at 19.2 Kbps, use this entry:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>ttyu0   &#34;/usr/libexec/getty V19200&#34;   dialup on</pre>
</div>
</div>
<div class="paragraph">
<p>After editing <span class="filename">/etc/ttys</span>, wait until the modem is properly configured and connected before signaling <code>init</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># kill -HUP 1</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>High-speed modems, like V.32, V.32bis, and V.34 modems, use hardware (<code>RTS/CTS</code>) flow control. Use <code>stty</code> to set the hardware flow control flag for the modem port. This example sets the <code>crtscts</code> flag on <span class="filename">COM2</span>&#39;s dial-in and dial-out initialization devices:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># stty -f /dev/ttyu1.init crtscts</span>
<span class="c"># stty -f /dev/cuau1.init crtscts</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_troubleshooting_2">29.4.2. Troubleshooting<a class="anchor" href="#_troubleshooting_2"></a></h4>
<div class="paragraph">
<p>This section provides a few tips for troubleshooting a dial-up modem that will not connect to a FreeBSD system.</p>
</div>
<div class="paragraph">
<p>Hook up the modem to the FreeBSD system and boot the system. If the modem has status indication lights, watch to see whether the modem’s DTR indicator lights when the <code>login:</code> prompt appears on the system’s console. If it lights up, that should mean that FreeBSD has started a <code>getty</code> process on the appropriate communications port and is waiting for the modem to accept a call.</p>
</div>
<div class="paragraph">
<p>If the DTR indicator does not light, login to the FreeBSD system through the console and type <code>ps ax</code> to see if FreeBSD is running a <code>getty</code> process on the correct port:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">  114 ??  I      0:00.10 /usr/libexec/getty V19200 ttyu0</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the second column contains a <code>d0</code> instead of a <code>??</code> and the modem has not accepted a call yet, this means that <code>getty</code> has completed its open on the communications port. This could indicate a problem with the cabling or a misconfigured modem because <code>getty</code> should not be able to open the communications port until the carrier detect signal has been asserted by the modem.</p>
</div>
<div class="paragraph">
<p>If no <code>getty</code> processes are waiting to open the port, double-check that the entry for the port is correct in <span class="filename">/etc/ttys</span>. Also, check <span class="filename">/var/log/messages</span> to see if there are any log messages from <code>init</code> or <code>getty</code>.</p>
</div>
<div class="paragraph">
<p>Next, try dialing into the system. Be sure to use 8 bits, no parity, and 1 stop bit on the remote system. If a prompt does not appear right away, or the prompt shows garbage, try pressing <kbd>Enter</kbd> about once per second. If there is still no <code>login:</code> prompt, try sending a <code>BREAK</code>. When using a high-speed modem, try dialing again after locking the dialing modem’s interface speed.</p>
</div>
<div class="paragraph">
<p>If there is still no <code>login:</code> prompt, check <span class="filename">/etc/gettytab</span> again and double-check that:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The initial capability name specified in the entry in <span class="filename">/etc/ttys</span> matches the name of a capability in <span class="filename">/etc/gettytab</span>.</p>
</li>
<li>
<p>Each <code>nx=</code> entry matches another <span class="filename">gettytab</span> capability name.</p>
</li>
<li>
<p>Each <code>tc=</code> entry matches another <span class="filename">gettytab</span> capability name.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If the modem on the FreeBSD system will not answer, make sure that the modem is configured to answer the phone when DTR is asserted. If the modem seems to be configured correctly, verify that the DTR line is asserted by checking the modem’s indicator lights.</p>
</div>
<div class="paragraph">
<p>If it still does not work, try sending an email to the {freebsd-questions} describing the modem and the problem.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="dialout">29.5. Dial-out Service<a class="anchor" href="#dialout"></a></h3>
<div class="paragraph">
<p>The following are tips for getting the host to connect over the modem to another computer. This is appropriate for establishing a terminal session with a remote host.</p>
</div>
<div class="paragraph">
<p>This kind of connection can be helpful to get a file on the Internet if there are problems using PPP. If PPP is not working, use the terminal session to FTP the needed file. Then use zmodem to transfer it to the machine.</p>
</div>
<div class="sect3">
<h4 id="hayes-unsupported">29.5.1. Using a Stock Hayes Modem<a class="anchor" href="#hayes-unsupported"></a></h4>
<div class="paragraph">
<p>A generic Hayes dialer is built into <code>tip</code>. Use <code>at=hayes</code> in <span class="filename">/etc/remote</span>.</p>
</div>
<div class="paragraph">
<p>The Hayes driver is not smart enough to recognize some of the advanced features of newer modems messages like <code>BUSY</code>, <code>NO DIALTONE</code>, or <code>CONNECT 115200</code>. Turn those messages off when using <code>tip</code> with <code>ATX0&amp;W</code>.</p>
</div>
<div class="paragraph">
<p>The dial timeout for <code>tip</code> is 60 seconds. The modem should use something less, or else <code>tip</code> will think there is a communication problem. Try <code>ATS7=45&amp;W</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="direct-at">29.5.2. Using <code>AT</code> Commands<a class="anchor" href="#direct-at"></a></h4>
<div class="paragraph">
<p>Create a &#34;direct&#34; entry in <span class="filename">/etc/remote</span>. For example, if the modem is hooked up to the first serial port, <span class="filename">/dev/cuau0</span>, use the following line:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>cuau0:dv=/dev/cuau0:br#19200:pa=none</pre>
</div>
</div>
<div class="paragraph">
<p>Use the highest bps rate the modem supports in the <code>br</code> capability. Then, type <code>tip cuau0</code> to connect to the modem.</p>
</div>
<div class="paragraph">
<p>Or, use <code>cu</code> as <code>root</code> with the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># cu -lline -sspeed</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>line</em> is the serial port, such as <span class="filename">/dev/cuau0</span>, and <em>speed</em> is the speed, such as <code>57600</code>. When finished entering the AT commands, type <code>~.</code> to exit.</p>
</div>
</div>
<div class="sect3">
<h4 id="gt-failure">29.5.3. The <code>@</code> Sign Does Not Work<a class="anchor" href="#gt-failure"></a></h4>
<div class="paragraph">
<p>The <code>@</code> sign in the phone number capability tells <code>tip</code> to look in <span class="filename">/etc/phones</span> for a phone number. But, the <code>@</code> sign is also a special character in capability files like <span class="filename">/etc/remote</span>, so it needs to be escaped with a backslash:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>pn=\@</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="dial-command-line">29.5.4. Dialing from the Command Line<a class="anchor" href="#dial-command-line"></a></h4>
<div class="paragraph">
<p>Put a &#34;generic&#34; entry in <span class="filename">/etc/remote</span>. For example:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>tip115200|Dial any phone number at 115200 bps:\
        :dv=/dev/cuau0:br#115200:at=hayes:pa=none:du:
tip57600|Dial any phone number at 57600 bps:\
        :dv=/dev/cuau0:br#57600:at=hayes:pa=none:du:</pre>
</div>
</div>
<div class="paragraph">
<p>This should now work:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># tip -115200 5551234</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Users who prefer <code>cu</code> over <code>tip</code>, can use a generic <code>cu</code> entry:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>cu115200|Use cu to dial any number at 115200bps:\
        :dv=/dev/cuau1:br#57600:at=hayes:pa=none:du:</pre>
</div>
</div>
<div class="paragraph">
<p>and type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># cu 5551234 -s 115200</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="set-bps">29.5.5. Setting the bps Rate<a class="anchor" href="#set-bps"></a></h4>
<div class="paragraph">
<p>Put in an entry for <code>tip1200</code> or <code>cu1200</code>, but go ahead and use whatever bps rate is appropriate with the <code>br</code> capability. <code>tip</code> thinks a good default is 1200 bps which is why it looks for a <code>tip1200</code> entry. 1200 bps does not have to be used, though.</p>
</div>
</div>
<div class="sect3">
<h4 id="terminal-server">29.5.6. Accessing a Number of Hosts Through a Terminal Server<a class="anchor" href="#terminal-server"></a></h4>
<div class="paragraph">
<p>Rather than waiting until connected and typing <code>CONNECT <em>host</em></code> each time, use <code>tip</code>&#39;s <code>cm</code> capability. For example, these entries in <span class="filename">/etc/remote</span> will let you type <code>tip pain</code> or <code>tip muffin</code> to connect to the hosts <code>pain</code> or <code>muffin</code>, and <code>tip deep13</code> to connect to the terminal server.</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>pain|pain.deep13.com|Forrester&#39;s machine:\
        :cm=CONNECT pain\n:tc=deep13:
muffin|muffin.deep13.com|Frank&#39;s machine:\
        :cm=CONNECT muffin\n:tc=deep13:
deep13:Gizmonics Institute terminal server:\
        :dv=/dev/cuau2:br#38400:at=hayes:du:pa=none:pn=5551234:</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="tip-multiline">29.5.7. Using More Than One Line with <code>tip</code><a class="anchor" href="#tip-multiline"></a></h4>
<div class="paragraph">
<p>This is often a problem where a university has several modem lines and several thousand students trying to use them.</p>
</div>
<div class="paragraph">
<p>Make an entry in <span class="filename">/etc/remote</span> and use <code>@</code> for the <code>pn</code> capability:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>big-university:\
        :pn=\@:tc=dialout
dialout:\
        :dv=/dev/cuau3:br#9600:at=courier:du:pa=none:</pre>
</div>
</div>
<div class="paragraph">
<p>Then, list the phone numbers in <span class="filename">/etc/phones</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>big-university 5551111
big-university 5551112
big-university 5551113
big-university 5551114</pre>
</div>
</div>
<div class="paragraph">
<p><code>tip</code> will try each number in the listed order, then give up. To keep retrying, run <code>tip</code> in a <code>while</code> loop.</p>
</div>
</div>
<div class="sect3">
<h4 id="multi-controlp">29.5.8. Using the Force Character<a class="anchor" href="#multi-controlp"></a></h4>
<div class="paragraph">
<p><span class="keyseq"><kbd>Ctrl</kbd>+<kbd>P</kbd></span> is the default &#34;force&#34; character, used to tell <code>tip</code> that the next character is literal data. The force character can be set to any other character with the <code>~s</code> escape, which means &#34;set a variable.&#34;</p>
</div>
<div class="paragraph">
<p>Type <code>~sforce=<em>single-char</em></code> followed by a newline. <em>single-char</em> is any single character. If <em>single-char</em> is left out, then the force character is the null character, which is accessed by typing <span class="keyseq"><kbd>Ctrl</kbd>+<kbd>2</kbd></span> or <span class="keyseq"><kbd>Ctrl</kbd>+<kbd>Space</kbd></span>. A pretty good value for <em>single-char</em> is <span class="keyseq"><kbd>Shift</kbd>+<kbd>Ctrl</kbd>+<kbd>6</kbd></span>, which is only used on some terminal servers.</p>
</div>
<div class="paragraph">
<p>To change the force character, specify the following in <span class="filename">~/.tiprc</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>force=single-char</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="uppercase">29.5.9. Upper Case Characters<a class="anchor" href="#uppercase"></a></h4>
<div class="paragraph">
<p>This happens when <span class="keyseq"><kbd>Ctrl</kbd>+<kbd>A</kbd></span> is pressed, which is <code>tip</code>&#39;s &#34;raise character&#34;, specially designed for people with broken caps-lock keys. Use <code>~s</code> to set <code>raisechar</code> to something reasonable. It can be set to be the same as the force character, if neither feature is used.</p>
</div>
<div class="paragraph">
<p>Here is a sample <span class="filename">~/.tiprc</span> for Emacs users who need to type <span class="keyseq"><kbd>Ctrl</kbd>+<kbd>2</kbd></span> and <span class="keyseq"><kbd>Ctrl</kbd>+<kbd>A</kbd></span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>force=^^
raisechar=^^</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>^^</code> is <span class="keyseq"><kbd>Shift</kbd>+<kbd>Ctrl</kbd>+<kbd>6</kbd></span>.</p>
</div>
</div>
<div class="sect3">
<h4 id="tip-filetransfer">29.5.10. File Transfers with <code>tip</code><a class="anchor" href="#tip-filetransfer"></a></h4>
<div class="paragraph">
<p>When talking to another UNIX®-like operating system, files can be sent and received using <code>~p</code> (put) and <code>~t</code> (take). These commands run <code>cat</code> and <code>echo</code> on the remote system to accept and send files. The syntax is: <code>~p</code> local-file [ remote-file ] <code>~t</code> remote-file [ local-file ]</p>
</div>
<div class="paragraph">
<p>There is no error checking, so another protocol, like zmodem, should probably be used.</p>
</div>
</div>
<div class="sect3">
<h4 id="zmodem-tip">29.5.11. Using zmodem with <code>tip</code>?<a class="anchor" href="#zmodem-tip"></a></h4>
<div class="paragraph">
<p>To receive files, start the sending program on the remote end. Then, type <code>~C rz</code> to begin receiving them locally.</p>
</div>
<div class="paragraph">
<p>To send files, start the receiving program on the remote end. Then, type <code>~C sz <em>files</em></code> to send them to the remote system.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="serialconsole-setup">29.6. Setting Up the Serial Console<a class="anchor" href="#serialconsole-setup"></a></h3>
<div class="paragraph">
<p>FreeBSD has the ability to boot a system with a dumb terminal on a serial port as a console. This configuration is useful for system administrators who wish to install FreeBSD on machines that have no keyboard or monitor attached, and developers who want to debug the kernel or device drivers.</p>
</div>
<div class="paragraph">
<p>As described in <a href="./#boot">The FreeBSD Booting Process</a>, FreeBSD employs a three stage bootstrap. The first two stages are in the boot block code which is stored at the beginning of the FreeBSD slice on the boot disk. The boot block then loads and runs the boot loader as the third stage code.</p>
</div>
<div class="paragraph">
<p>In order to set up booting from a serial console, the boot block code, the boot loader code, and the kernel need to be configured.</p>
</div>
<div class="sect3">
<h4 id="serialconsole-howto-fast">29.6.1. Quick Serial Console Configuration<a class="anchor" href="#serialconsole-howto-fast"></a></h4>
<div class="paragraph">
<p>This section provides a fast overview of setting up the serial console. This procedure can be used when the dumb terminal is connected to <span class="filename">COM1</span>.</p>
</div>
<div class="olist arabic procedure">
<div class="title">Procedure: Configuring a Serial Console on <span class="filename">COM1</span></div>
<ol class="arabic">
<li>
<p>Connect the serial cable to <span class="filename">COM1</span> and the controlling terminal.</p>
</li>
<li>
<p>To configure boot messages to display on the serial console, issue the following command as the superuser:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># echo &#39;console=&#34;comconsole&#34;&#39; &gt;&gt; /boot/loader.conf</span></code></pre>
</div>
</div>
</li>
<li>
<p>Edit <span class="filename">/etc/ttys</span> and change <code>off</code> to <code>on</code> and <code>dialup</code> to <code>vt100</code> for the <span class="filename">ttyu0</span> entry. Otherwise, a password will not be required to connect via the serial console, resulting in a potential security hole.</p>
</li>
<li>
<p>Reboot the system to see if the changes took effect.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>If a different configuration is required, see the next section for a more in-depth configuration explanation.</p>
</div>
</div>
<div class="sect3">
<h4 id="serialconsole-howto">29.6.2. In-Depth Serial Console Configuration<a class="anchor" href="#serialconsole-howto"></a></h4>
<div class="paragraph">
<p>This section provides a more detailed explanation of the steps needed to setup a serial console in FreeBSD.</p>
</div>
<div class="olist arabic procedure">
<div class="title">Procedure: Configuring a Serial Console</div>
<ol class="arabic">
<li>
<p>Prepare a serial cable.</p>
<div class="paragraph">
<p>Use either a null-modem cable or a standard serial cable and a null-modem adapter. See <a href="#term-cables-null">Serial Cables and Ports</a> for a discussion on serial cables.</p>
</div>
</li>
<li>
<p>Unplug the keyboard.</p>
<div class="paragraph">
<p>Many systems probe for the keyboard during the Power-On Self-Test (POST) and will generate an error if the keyboard is not detected. Some machines will refuse to boot until the keyboard is plugged in.</p>
</div>
<div class="paragraph">
<p>If the computer complains about the error, but boots anyway, no further configuration is needed.</p>
</div>
<div class="paragraph">
<p>If the computer refuses to boot without a keyboard attached, configure the BIOS so that it ignores this error. Consult the motherboard’s manual for details on how to do this.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Try setting the keyboard to &#34;Not installed&#34; in the BIOS. This setting tells the BIOS not to probe for a keyboard at power-on so it should not complain if the keyboard is absent. If that option is not present in the BIOS, look for an &#34;Halt on Error&#34; option instead. Setting this to &#34;All but Keyboard&#34; or to &#34;No Errors&#34; will have the same effect.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>If the system has a PS/2® mouse, unplug it as well. PS/2® mice share some hardware with the keyboard and leaving the mouse plugged in can fool the keyboard probe into thinking the keyboard is still there.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>While most systems will boot without a keyboard, quite a few will not boot without a graphics adapter. Some systems can be configured to boot with no graphics adapter by changing the &#34;graphics adapter&#34; setting in the BIOS configuration to &#34;Not installed&#34;. Other systems do not support this option and will refuse to boot if there is no display hardware in the system. With these machines, leave some kind of graphics card plugged in, even if it is just a junky mono board. A monitor does not need to be attached.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
</li>
<li>
<p>Plug a dumb terminal, an old computer with a modem program, or the serial port on another UNIX® box into the serial port.</p>
</li>
<li>
<p>Add the appropriate <code>hint.uart.*</code> entries to <span class="filename">/boot/device.hints</span> for the serial port. Some multi-port cards also require kernel configuration options. Refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=uart&amp;sektion=4&amp;format=html">uart(4)</a> for the required options and device hints for each supported serial port.</p>
</li>
<li>
<p>Create <span class="filename">boot.config</span> in the root directory of the <code>a</code> partition on the boot drive.</p>
<div class="paragraph">
<p>This file instructs the boot block code how to boot the system. In order to activate the serial console, one or more of the following options are needed. When using multiple options, include them all on the same line:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>-h</code></dt>
<dd>
<p>Toggles between the internal and serial consoles. Use this to switch console devices. For instance, to boot from the internal (video) console, use <code>-h</code> to direct the boot loader and the kernel to use the serial port as its console device. Alternatively, to boot from the serial port, use <code>-h</code> to tell the boot loader and the kernel to use the video display as the console instead.</p>
</dd>
<dt class="hdlist1"><code>-D</code></dt>
<dd>
<p>Toggles between the single and dual console configurations. In the single configuration, the console will be either the internal console (video display) or the serial port, depending on the state of <code>-h</code>. In the dual console configuration, both the video display and the serial port will become the console at the same time, regardless of the state of <code>-h</code>. However, the dual console configuration takes effect only while the boot block is running. Once the boot loader gets control, the console specified by <code>-h</code> becomes the only console.</p>
</dd>
<dt class="hdlist1"><code>-P</code></dt>
<dd>
<p>Makes the boot block probe the keyboard. If no keyboard is found, the <code>-D</code> and <code>-h</code> options are automatically set.</p>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Due to space constraints in the current version of the boot blocks, <code>-P</code> is capable of detecting extended keyboards only. Keyboards with less than 101 keys and without F11 and F12 keys may not be detected. Keyboards on some laptops may not be properly found because of this limitation. If this is the case, do not use <code>-P</code>.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Use either <code>-P</code> to select the console automatically or <code>-h</code> to activate the serial console. Refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=boot&amp;sektion=8&amp;format=html">boot(8)</a> and <a href="https://man.freebsd.org/cgi/man.cgi?query=boot.config&amp;sektion=5&amp;format=html">boot.config(5)</a> for more details.</p>
</div>
<div class="paragraph">
<p>The options, except for <code>-P</code>, are passed to the boot loader. The boot loader will determine whether the internal video or the serial port should become the console by examining the state of <code>-h</code>. This means that if <code>-D</code> is specified but <code>-h</code> is not specified in <span class="filename">/boot.config</span>, the serial port can be used as the console only during the boot block as the boot loader will use the internal video display as the console.</p>
</div>
</dd>
</dl>
</div>
</li>
<li>
<p>Boot the machine.</p>
<div class="paragraph">
<p>When FreeBSD starts, the boot blocks echo the contents of <span class="filename">/boot.config</span> to the console. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">/boot.config: -P
Keyboard: no</code></pre>
</div>
</div>
<div class="paragraph">
<p>The second line appears only if <code>-P</code> is in <span class="filename">/boot.config</span> and indicates the presence or absence of the keyboard. These messages go to either the serial or internal console, or both, depending on the option in <span class="filename">/boot.config</span>:</p>
</div>
<table class="tableblock frame-none grid-all stretch informaltable">
<colgroup>
<col style="width: 50%;"/>
<col style="width: 50%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Options</th>
<th class="tableblock halign-left valign-top">Message goes to</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">none</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">internal console</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>-h</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">serial console</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>-D</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">serial and internal consoles</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>-Dh</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">serial and internal consoles</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>-P</code>, keyboard present</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">internal console</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>-P</code>, keyboard absent</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">serial console</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>After the message, there will be a small pause before the boot blocks continue loading the boot loader and before any further messages are printed to the console. Under normal circumstances, there is no need to interrupt the boot blocks, but one can do so in order to make sure things are set up correctly.</p>
</div>
<div class="paragraph">
<p>Press any key, other than <kbd>Enter</kbd>, at the console to interrupt the boot process. The boot blocks will then prompt for further action:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">&gt;&gt; </span>FreeBSD/i386 BOOT
Default: 0:ad<span class="o">(</span>0,a<span class="o">)</span>/boot/loader
boot:</code></pre>
</div>
</div>
<div class="paragraph">
<p>Verify that the above message appears on either the serial or internal console, or both, according to the options in <span class="filename">/boot.config</span>. If the message appears in the correct console, press <kbd>Enter</kbd> to continue the boot process.</p>
</div>
<div class="paragraph">
<p>If there is no prompt on the serial terminal, something is wrong with the settings. Enter <code>-h</code> then <kbd>Enter</kbd> or <kbd>Return</kbd> to tell the boot block (and then the boot loader and the kernel) to choose the serial port for the console. Once the system is up, go back and check what went wrong.</p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>During the third stage of the boot process, one can still switch between the internal console and the serial console by setting appropriate environment variables in the boot loader. See <a href="https://man.freebsd.org/cgi/man.cgi?query=loader&amp;sektion=8&amp;format=html">loader(8)</a> for more information.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This line in <span class="filename">/boot/loader.conf</span> or <span class="filename">/boot/loader.conf.local</span> configures the boot loader and the kernel to send their boot messages to the serial console, regardless of the options in <span class="filename">/boot.config</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>console=&#34;comconsole&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>That line should be the first line of <span class="filename">/boot/loader.conf</span> so that boot messages are displayed on the serial console as early as possible.</p>
</div>
<div class="paragraph">
<p>If that line does not exist, or if it is set to <code>console=&#34;vidconsole&#34;</code>, the boot loader and the kernel will use whichever console is indicated by <code>-h</code> in the boot block. See <a href="https://man.freebsd.org/cgi/man.cgi?query=loader.conf&amp;sektion=5&amp;format=html">loader.conf(5)</a> for more information.</p>
</div>
<div class="paragraph">
<p>At the moment, the boot loader has no option equivalent to <code>-P</code> in the boot block, and there is no provision to automatically select the internal console and the serial console based on the presence of the keyboard.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>While it is not required, it is possible to provide a <code>login</code> prompt over the serial line. To configure this, edit the entry for the serial port in <span class="filename">/etc/ttys</span> using the instructions in <a href="#term-config">Terminal Configuration</a>. If the speed of the serial port has been changed, change <code>std.9600</code> to match the new setting.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect3">
<h4 id="_setting_a_faster_serial_port_speed">29.6.3. Setting a Faster Serial Port Speed<a class="anchor" href="#_setting_a_faster_serial_port_speed"></a></h4>
<div class="paragraph">
<p>By default, the serial port settings are 9600 baud, 8 bits, no parity, and 1 stop bit. To change the default console speed, use one of the following options:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Edit <span class="filename">/etc/make.conf</span> and set <code>BOOT_COMCONSOLE_SPEED</code> to the new console speed. Then, recompile and install the boot blocks and the boot loader:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># cd /sys/boot</span>
<span class="c"># make clean</span>
<span class="c"># make</span>
<span class="c"># make install</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If the serial console is configured in some other way than by booting with <code>-h</code>, or if the serial console used by the kernel is different from the one used by the boot blocks, add the following option, with the desired speed, to a custom kernel configuration file and compile a new kernel:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>options CONSPEED=19200</pre>
</div>
</div>
</li>
<li>
<p>Add the <code>-S<em>19200</em></code> boot option to <span class="filename">/boot.config</span>, replacing <code><em>19200</em></code> with the speed to use.</p>
</li>
<li>
<p>Add the following options to <span class="filename">/boot/loader.conf</span>. Replace <code><em>115200</em></code> with the speed to use.</p>
<div class="literalblock programlisting">
<div class="content">
<pre>boot_multicons=&#34;YES&#34;
boot_serial=&#34;YES&#34;
comconsole_speed=&#34;115200&#34;
console=&#34;comconsole,vidconsole&#34;</pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="serialconsole-ddb">29.6.4. Entering the DDB Debugger from the Serial Line<a class="anchor" href="#serialconsole-ddb"></a></h4>
<div class="paragraph">
<p>To configure the ability to drop into the kernel debugger from the serial console, add the following options to a custom kernel configuration file and compile the kernel using the instructions in <a href="./#kernelconfig">Configuring the FreeBSD Kernel</a>. Note that while this is useful for remote diagnostics, it is also dangerous if a spurious BREAK is generated on the serial port. Refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=ddb&amp;sektion=4&amp;format=html">ddb(4)</a> and <a href="https://man.freebsd.org/cgi/man.cgi?query=ddb&amp;sektion=8&amp;format=html">ddb(8)</a> for more information about the kernel debugger.</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>options BREAK_TO_DEBUGGER
options DDB</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ppp-and-slip">Chapter 30. PPP<a class="anchor" href="#ppp-and-slip"></a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="ppp-and-slip-synopsis">30.1. Synopsis<a class="anchor" href="#ppp-and-slip-synopsis"></a></h3>
<div class="paragraph">
<p>FreeBSD supports the Point-to-Point (PPP) protocol which can be used to establish a network or Internet connection using a dial-up modem. This chapter describes how to configure modem-based communication services in FreeBSD.</p>
</div>
<div class="paragraph">
<p>After reading this chapter, you will know:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>How to configure, use, and troubleshoot a PPP connection.</p>
</li>
<li>
<p>How to set up PPP over Ethernet (PPPoE).</p>
</li>
<li>
<p>How to set up PPP over ATM (PPPoA).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Before reading this chapter, you should:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Be familiar with basic network terminology.</p>
</li>
<li>
<p>Understand the basics and purpose of a dial-up connection and PPP.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="userppp">30.2. Configuring PPP<a class="anchor" href="#userppp"></a></h3>
<div class="paragraph">
<p>FreeBSD provides built-in support for managing dial-up PPP connections using <a href="https://man.freebsd.org/cgi/man.cgi?query=ppp&amp;sektion=8&amp;format=html">ppp(8)</a>. The default FreeBSD kernel provides support for <span class="filename">tun</span> which is used to interact with a modem hardware. Configuration is performed by editing at least one configuration file, and configuration files containing examples are provided. Finally, <code>ppp</code> is used to start and manage connections.</p>
</div>
<div class="paragraph">
<p>In order to use a PPP connection, the following items are needed:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A dial-up account with an Internet Service Provider (ISP).</p>
</li>
<li>
<p>A dial-up modem.</p>
</li>
<li>
<p>The dial-up number for the ISP.</p>
</li>
<li>
<p>The login name and password assigned by the ISP.</p>
</li>
<li>
<p>The IP address of one or more DNS servers. Normally, the ISP provides these addresses. If it did not, FreeBSD can be configured to use DNS negotiation.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If any of the required information is missing, contact the ISP.</p>
</div>
<div class="paragraph">
<p>The following information may be supplied by the ISP, but is not necessary:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The IP address of the default gateway. If this information is unknown, the ISP will automatically provide the correct value during connection setup. When configuring PPP on FreeBSD, this address is referred to as <code>HISADDR</code>.</p>
</li>
<li>
<p>The subnet mask. If the ISP has not provided one, <code>255.255.255.255</code> will be used in the <a href="https://man.freebsd.org/cgi/man.cgi?query=ppp&amp;sektion=8&amp;format=html">ppp(8)</a> configuration file. *</p>
<div class="paragraph">
<p>If the ISP has assigned a static IP address and hostname, it should be input into the configuration file. Otherwise, this information will be automatically provided during connection setup.</p>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>The rest of this section demonstrates how to configure FreeBSD for common PPP connection scenarios. The required configuration file is <span class="filename">/etc/ppp/ppp.conf</span> and additional files and examples are available in <span class="filename">/usr/share/examples/ppp/</span>.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Throughout this section, many of the file examples display line numbers. These line numbers have been added to make it easier to follow the discussion and are not meant to be placed in the actual file.</p>
</div>
<div class="paragraph">
<p>When editing a configuration file, proper indentation is important. Lines that end in a <code>:</code> start in the first column (beginning of the line) while all other lines should be indented as shown using spaces or tabs.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="sect3">
<h4 id="userppp-staticIP">30.2.1. Basic Configuration<a class="anchor" href="#userppp-staticIP"></a></h4>
<div class="paragraph">
<p>In order to configure a PPP connection, first edit <span class="filename">/etc/ppp/ppp.conf</span> with the dial-in information for the ISP. This file is described as follows:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>1     default:
2       set log Phase Chat LCP IPCP CCP tun command
3       ident user-ppp VERSION
4       set device /dev/cuau0
5       set speed 115200
6       set dial &#34;ABORT BUSY ABORT NO\\sCARRIER TIMEOUT 5 \
7                 \&#34;\&#34; AT OK-AT-OK ATE1Q0 OK \\dATDT\\T TIMEOUT 40 CONNECT&#34;
8       set timeout 180
9       enable dns
10
11    provider:
12      set phone &#34;(123) 456 7890&#34;
13      set authname foo
14      set authkey bar
15      set timeout 300
16      set ifaddr x.x.x.x/0 y.y.y.y/0 255.255.255.255 0.0.0.0
17      add default HISADDR</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Line 1</dt>
<dd>
<p>Identifies the <code>default</code> entry. Commands in this entry (lines 2 through 9) are executed automatically when <code>ppp</code> is run.</p>
</dd>
<dt class="hdlist1">Line 2</dt>
<dd>
<p>Enables verbose logging parameters for testing the connection. Once the configuration is working satisfactorily, this line should be reduced to:</p>
<div class="literalblock programlisting">
<div class="content">
<pre>set log phase tun</pre>
</div>
</div>
</dd>
<dt class="hdlist1">Line 3</dt>
<dd>
<p>Displays the version of <a href="https://man.freebsd.org/cgi/man.cgi?query=ppp&amp;sektion=8&amp;format=html">ppp(8)</a> to the PPP software running on the other side of the connection.</p>
</dd>
<dt class="hdlist1">Line 4</dt>
<dd>
<p>Identifies the device to which the modem is connected, where <span class="filename">COM1</span> is <span class="filename">/dev/cuau0</span> and <span class="filename">COM2</span> is <span class="filename">/dev/cuau1</span>.</p>
</dd>
<dt class="hdlist1">Line 5</dt>
<dd>
<p>Sets the connection speed. If <code>115200</code> does not work on an older modem, try <code>38400</code> instead.</p>
</dd>
<dt class="hdlist1">Lines 6 &amp; 7</dt>
<dd>
<p>The dial string written as an expect-send syntax. Refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=chat&amp;sektion=8&amp;format=html">chat(8)</a> for more information.</p>
<div class="paragraph">
<p>Note that this command continues onto the next line for readability. Any command in <span class="filename">ppp.conf</span> may do this if the last character on the line is <code>\</code>.</p>
</div>
</dd>
<dt class="hdlist1">Line 8</dt>
<dd>
<p>Sets the idle timeout for the link in seconds.</p>
</dd>
<dt class="hdlist1">Line 9</dt>
<dd>
<p>Instructs the peer to confirm the DNS settings. If the local network is running its own DNS server, this line should be commented out, by adding a <code>#</code> at the beginning of the line, or removed.</p>
</dd>
<dt class="hdlist1">Line 10</dt>
<dd>
<p>A blank line for readability. Blank lines are ignored by <a href="https://man.freebsd.org/cgi/man.cgi?query=ppp&amp;sektion=8&amp;format=html">ppp(8)</a>.</p>
</dd>
<dt class="hdlist1">Line 11</dt>
<dd>
<p>Identifies an entry called <code>provider</code>. This could be changed to the name of the ISP so that <code>load <em>ISP</em></code> can be used to start the connection.</p>
</dd>
<dt class="hdlist1">Line 12</dt>
<dd>
<p>Use the phone number for the ISP. Multiple phone numbers may be specified using the colon (<code>:</code>) or pipe character (<code>|</code>) as a separator. To rotate through the numbers, use a colon. To always attempt to dial the first number first and only use the other numbers if the first number fails, use the pipe character. Always enclose the entire set of phone numbers between quotation marks (<code>&#34;</code>) to prevent dialing failures.</p>
</dd>
<dt class="hdlist1">Lines 13 &amp; 14</dt>
<dd>
<p>Use the user name and password for the ISP.</p>
</dd>
<dt class="hdlist1">Line 15</dt>
<dd>
<p>Sets the default idle timeout in seconds for the connection. In this example, the connection will be closed automatically after 300 seconds of inactivity. To prevent a timeout, set this value to zero.</p>
</dd>
<dt class="hdlist1">Line 16</dt>
<dd>
<p>Sets the interface addresses. The values used depend upon whether a static IP address has been obtained from the ISP or if it instead negotiates a dynamic IP address during connection.</p>
<div class="paragraph">
<p>If the ISP has allocated a static IP address and default gateway, replace <em>x.x.x.x</em> with the static IP address and replace <em>y.y.y.y</em> with the IP address of the default gateway. If the ISP has only provided a static IP address without a gateway address, replace <em>y.y.y.y</em> with <code>10.0.0.2/0</code>.</p>
</div>
<div class="paragraph">
<p>If the IP address changes whenever a connection is made, change this line to the following value. This tells <a href="https://man.freebsd.org/cgi/man.cgi?query=ppp&amp;sektion=8&amp;format=html">ppp(8)</a> to use the IP Configuration Protocol (IPCP) to negotiate a dynamic IP address:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>set ifaddr 10.0.0.1/0 10.0.0.2/0 255.255.255.255 0.0.0.0</pre>
</div>
</div>
</dd>
<dt class="hdlist1">Line 17</dt>
<dd>
<p>Keep this line as-is as it adds a default route to the gateway. The <code>HISADDR</code> will automatically be replaced with the gateway address specified on line 16. It is important that this line appears after line 16.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Depending upon whether <a href="https://man.freebsd.org/cgi/man.cgi?query=ppp&amp;sektion=8&amp;format=html">ppp(8)</a> is started manually or automatically, a <span class="filename">/etc/ppp/ppp.linkup</span> may also need to be created which contains the following lines. This file is required when running <code>ppp</code> in <code>-auto</code> mode. This file is used after the connection has been established. At this point, the IP address will have been assigned and it is now possible to add the routing table entries. When creating this file, make sure that <em>provider</em> matches the value demonstrated in line 11 of <span class="filename">ppp.conf</span>.</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>provider:
      add default HISADDR</pre>
</div>
</div>
<div class="paragraph">
<p>This file is also needed when the default gateway address is &#34;guessed&#34; in a static IP address configuration. In this case, remove line 17 from <span class="filename">ppp.conf</span> and create <span class="filename">/etc/ppp/ppp.linkup</span> with the above two lines. More examples for this file can be found in <span class="filename">/usr/share/examples/ppp/</span>.</p>
</div>
<div class="paragraph">
<p>By default, <code>ppp</code> must be run as <code>root</code>. To change this default, add the account of the user who should run <code>ppp</code> to the <code>network</code> group in <span class="filename">/etc/group</span>.</p>
</div>
<div class="paragraph">
<p>Then, give the user access to one or more entries in <span class="filename">/etc/ppp/ppp.conf</span> with <code>allow</code>. For example, to give <code>fred</code> and <code>mary</code> permission to only the <code>provider:</code> entry, add this line to the <code>provider:</code> section:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>allow users fred mary</pre>
</div>
</div>
<div class="paragraph">
<p>To give the specified users access to all entries, put that line in the <code>default</code> section instead.</p>
</div>
</div>
<div class="sect3">
<h4 id="_advanced_configuration">30.2.2. Advanced Configuration<a class="anchor" href="#_advanced_configuration"></a></h4>
<div class="paragraph">
<p>It is possible to configure PPP to supply DNS and NetBIOS nameserver addresses on demand.</p>
</div>
<div class="paragraph">
<p>To enable these extensions with PPP version 1.x, the following lines might be added to the relevant section of <span class="filename">/etc/ppp/ppp.conf</span>.</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>enable msext
set ns 203.14.100.1 203.14.100.2
set nbns 203.14.100.5</pre>
</div>
</div>
<div class="paragraph">
<p>And for PPP version 2 and above:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>accept dns
set dns 203.14.100.1 203.14.100.2
set nbns 203.14.100.5</pre>
</div>
</div>
<div class="paragraph">
<p>This will tell the clients the primary and secondary name server addresses, and a NetBIOS nameserver host.</p>
</div>
<div class="paragraph">
<p>In version 2 and above, if the <code>set dns</code> line is omitted, PPP will use the values found in <span class="filename">/etc/resolv.conf</span>.</p>
</div>
<div class="sect4">
<h5 id="userppp-PAPnCHAP">30.2.2.1. PAP and CHAP Authentication<a class="anchor" href="#userppp-PAPnCHAP"></a></h5>
<div class="paragraph">
<p>Some ISPs set their system up so that the authentication part of the connection is done using either of the PAP or CHAP authentication mechanisms. If this is the case, the ISP will not give a <code>login:</code> prompt at connection, but will start talking PPP immediately.</p>
</div>
<div class="paragraph">
<p>PAP is less secure than CHAP, but security is not normally an issue here as passwords, although being sent as plain text with PAP, are being transmitted down a serial line only. There is not much room for crackers to &#34;eavesdrop&#34;.</p>
</div>
<div class="paragraph">
<p>The following alterations must be made:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>13      set authname MyUserName
14      set authkey MyPassword
15      set login</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Line 13</dt>
<dd>
<p>This line specifies the PAP/CHAP user name.Insert the correct value for <em>MyUserName</em>.</p>
</dd>
<dt class="hdlist1">Line 14</dt>
<dd>
<p>This line specifies the PAP/CHAP password. Insert the correct value for <em>MyPassword</em>. You may want to add an additional line, such as:</p>
<div class="literalblock programlisting">
<div class="content">
<pre>16      accept PAP</pre>
</div>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>16      accept CHAP</pre>
</div>
</div>
<div class="paragraph">
<p>to make it obvious that this is the intention, but PAP and CHAP are both accepted by default.</p>
</div>
</dd>
<dt class="hdlist1">Line 15</dt>
<dd>
<p>The ISP will not normally require a login to the server when using PAP or CHAP. Therefore, disable the &#34;set login&#34; string.</p>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="userppp-nat">30.2.2.2. Using PPP Network Address Translation Capability<a class="anchor" href="#userppp-nat"></a></h5>
<div class="paragraph">
<p>PPP has ability to use internal NAT without kernel diverting capabilities. This functionality may be enabled by the following line in <span class="filename">/etc/ppp/ppp.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>nat enable yes</pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, NAT may be enabled by command-line option <code>-nat</code>. There is also <span class="filename">/etc/rc.conf</span> knob named <code>ppp_nat</code>, which is enabled by default.</p>
</div>
<div class="paragraph">
<p>When using this feature, it may be useful to include the following <span class="filename">/etc/ppp/ppp.conf</span> options to enable incoming connections forwarding:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>nat port tcp 10.0.0.2:ftp ftp
nat port tcp 10.0.0.2:http http</pre>
</div>
</div>
<div class="paragraph">
<p>or do not trust the outside at all</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>nat deny_incoming yes</pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="userppp-final">30.2.3. Final System Configuration<a class="anchor" href="#userppp-final"></a></h4>
<div class="paragraph">
<p>While <code>ppp</code> is now configured, some edits still need to be made to <span class="filename">/etc/rc.conf</span>.</p>
</div>
<div class="paragraph">
<p>Working from the top down in this file, make sure the <code>hostname=</code> line is set:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>hostname=&#34;foo.example.com&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>If the ISP has supplied a static IP address and name, use this name as the host name.</p>
</div>
<div class="paragraph">
<p>Look for the <code>network_interfaces</code> variable. To configure the system to dial the ISP on demand, make sure the <span class="filename">tun0</span> device is added to the list, otherwise remove it.</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>network_interfaces=&#34;lo0 tun0&#34;
ifconfig_tun0=</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>ifconfig_tun0</code> variable should be empty, and a file called <span class="filename">/etc/start_if.tun0</span> should be created. This file should contain the line:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>ppp -auto mysystem</pre>
</div>
</div>
<div class="paragraph">
<p>This script is executed at network configuration time, starting the ppp daemon in automatic mode. If this machine acts as a gateway, consider including <code>-alias</code>. Refer to the manual page for further details.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Make sure that the router program is set to <code>NO</code> with the following line in <span class="filename">/etc/rc.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>router_enable=&#34;NO&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>It is important that the <code>routed</code> daemon is not started, as <code>routed</code> tends to delete the default routing table entries created by <code>ppp</code>.</p>
</div>
<div class="paragraph">
<p>It is probably a good idea to ensure that the <code>sendmail_flags</code> line does not include the <code>-q</code> option, otherwise <code>sendmail</code> will attempt to do a network lookup every now and then, possibly causing your machine to dial out. You may try:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>sendmail_flags=&#34;-bd&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>The downside is that <code>sendmail</code> is forced to re-examine the mail queue whenever the ppp link. To automate this, include <code>!bg</code> in <span class="filename">ppp.linkup</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>1     provider:
2       delete ALL
3       add 0 0 HISADDR
4       !bg sendmail -bd -q30m</pre>
</div>
</div>
<div class="paragraph">
<p>An alternative is to set up a &#34;dfilter&#34; to block SMTP traffic. Refer to the sample files for further details.</p>
</div>
</div>
<div class="sect3">
<h4 id="_using_ppp">30.2.4. Using <code>ppp</code><a class="anchor" href="#_using_ppp"></a></h4>
<div class="paragraph">
<p>All that is left is to reboot the machine. After rebooting, either type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ppp</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>and then <code>dial provider</code> to start the PPP session, or, to configure <code>ppp</code> to establish sessions automatically when there is outbound traffic and <span class="filename">start_if.tun0</span> does not exist, type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ppp -auto provider</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>It is possible to talk to the <code>ppp</code> program while it is running in the background, but only if a suitable diagnostic port has been set up. To do this, add the following line to the configuration:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>set server /var/run/ppp-tun%d DiagnosticPassword 0177</pre>
</div>
</div>
<div class="paragraph">
<p>This will tell PPP to listen to the specified UNIX® domain socket, asking clients for the specified password before allowing access. The <code>%d</code> in the name is replaced with the <span class="filename">tun</span> device number that is in use.</p>
</div>
<div class="paragraph">
<p>Once a socket has been set up, the <a href="https://man.freebsd.org/cgi/man.cgi?query=pppctl&amp;sektion=8&amp;format=html">pppctl(8)</a> program may be used in scripts that wish to manipulate the running program.</p>
</div>
</div>
<div class="sect3">
<h4 id="userppp-mgetty">30.2.5. Configuring Dial-in Services<a class="anchor" href="#userppp-mgetty"></a></h4>
<div class="paragraph">
<p><a href="./#dialup">“Dial-in Service”</a> provides a good description on enabling dial-up services using <a href="https://man.freebsd.org/cgi/man.cgi?query=getty&amp;sektion=8&amp;format=html">getty(8)</a>.</p>
</div>
<div class="paragraph">
<p>An alternative to <code>getty</code> is <a class="package" href="https://cgit.freebsd.org/ports/tree/comms/mgetty+sendfax/">comms/mgetty+sendfax</a> port), a smarter version of <code>getty</code> designed with dial-up lines in mind.</p>
</div>
<div class="paragraph">
<p>The advantages of using <code>mgetty</code> is that it actively <em>talks</em> to modems, meaning if port is turned off in <span class="filename">/etc/ttys</span> then the modem will not answer the phone.</p>
</div>
<div class="paragraph">
<p>Later versions of <code>mgetty</code> (from 0.99beta onwards) also support the automatic detection of PPP streams, allowing clients scriptless access to the server.</p>
</div>
<div class="paragraph">
<p>Refer to <a href="http://mgetty.greenie.net/doc/mgetty_toc.html">http://mgetty.greenie.net/doc/mgetty_toc.html</a> for more information on <code>mgetty</code>.</p>
</div>
<div class="paragraph">
<p>By default the <a class="package" href="https://cgit.freebsd.org/ports/tree/comms/mgetty+sendfax/">comms/mgetty+sendfax</a> port comes with the <code>AUTO_PPP</code> option enabled allowing <code>mgetty</code> to detect the LCP phase of PPP connections and automatically spawn off a ppp shell. However, since the default login/password sequence does not occur it is necessary to authenticate users using either PAP or CHAP.</p>
</div>
<div class="paragraph">
<p>This section assumes the user has successfully compiled, and installed the <a class="package" href="https://cgit.freebsd.org/ports/tree/comms/mgetty+sendfax/">comms/mgetty+sendfax</a> port on his system.</p>
</div>
<div class="paragraph">
<p>Ensure that <span class="filename">/usr/local/etc/mgetty+sendfax/login.config</span> has the following:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>/AutoPPP/ -     - /etc/ppp/ppp-pap-dialup</pre>
</div>
</div>
<div class="paragraph">
<p>This tells <code>mgetty</code> to run <span class="filename">ppp-pap-dialup</span> for detected PPP connections.</p>
</div>
<div class="paragraph">
<p>Create an executable file called <span class="filename">/etc/ppp/ppp-pap-dialup</span> containing the following:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>#!/bin/sh
exec /usr/sbin/ppp -direct pap$IDENT</pre>
</div>
</div>
<div class="paragraph">
<p>For each dial-up line enabled in <span class="filename">/etc/ttys</span>, create a corresponding entry in <span class="filename">/etc/ppp/ppp.conf</span>. This will happily co-exist with the definitions we created above.</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>pap:
  enable pap
  set ifaddr 203.14.100.1 203.14.100.20-203.14.100.40
  enable proxy</pre>
</div>
</div>
<div class="paragraph">
<p>Each user logging in with this method will need to have a username/password in <span class="filename">/etc/ppp/ppp.secret</span>, or alternatively add the following option to authenticate users via PAP from <span class="filename">/etc/passwd</span>.</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>enable passwdauth</pre>
</div>
</div>
<div class="paragraph">
<p>To assign some users a static IP number, specify the number as the third argument in <span class="filename">/etc/ppp/ppp.secret</span>. See <span class="filename">/usr/share/examples/ppp/ppp.secret.sample</span> for examples.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="ppp-troubleshoot">30.3. Troubleshooting PPP Connections<a class="anchor" href="#ppp-troubleshoot"></a></h3>
<div class="paragraph">
<p>This section covers a few issues which may arise when using PPP over a modem connection. Some ISPs present the <code>ssword</code> prompt while others present <code>password</code>. If the <code>ppp</code> script is not written accordingly, the login attempt will fail. The most common way to debug <code>ppp</code> connections is by connecting manually as described in this section.</p>
</div>
<div class="sect3">
<h4 id="_check_the_device_nodes">30.3.1. Check the Device Nodes<a class="anchor" href="#_check_the_device_nodes"></a></h4>
<div class="paragraph">
<p>When using a custom kernel, make sure to include the following line in the kernel configuration file:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>device   uart</pre>
</div>
</div>
<div class="paragraph">
<p>The <span class="filename">uart</span> device is already included in the <code>GENERIC</code> kernel, so no additional steps are necessary in this case. Just check the <code>dmesg</code> output for the modem device with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># dmesg | grep uart</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This should display some pertinent output about the <span class="filename">uart</span> devices. These are the COM ports we need. If the modem acts like a standard serial port, it should be listed on <span class="filename">uart1</span>, or <span class="filename">COM2</span>. If so, a kernel rebuild is not required. When matching up, if the modem is on <span class="filename">uart1</span>, the modem device would be <span class="filename">/dev/cuau1</span>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_connecting_manually">30.3.2. Connecting Manually<a class="anchor" href="#_connecting_manually"></a></h4>
<div class="paragraph">
<p>Connecting to the Internet by manually controlling <code>ppp</code> is quick, easy, and a great way to debug a connection or just get information on how the ISP treats <code>ppp</code> client connections. Lets start PPP from the command line. Note that in all of our examples we will use <em>example</em> as the hostname of the machine running PPP. To start <code>ppp</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ppp</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">ppp ON example&gt; <span class="nb">set </span>device /dev/cuau1</code></pre>
</div>
</div>
<div class="paragraph">
<p>This second command sets the modem device to <span class="filename">cuau1</span>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">ppp ON example&gt; <span class="nb">set </span>speed 115200</code></pre>
</div>
</div>
<div class="paragraph">
<p>This sets the connection speed to 115,200 kbps.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">ppp ON example&gt; <span class="nb">enable </span>dns</code></pre>
</div>
</div>
<div class="paragraph">
<p>This tells <code>ppp</code> to configure the resolver and add the nameserver lines to <span class="filename">/etc/resolv.conf</span>. If <code>ppp</code> cannot determine the hostname, it can manually be set later.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">ppp ON example&gt; term</code></pre>
</div>
</div>
<div class="paragraph">
<p>This switches to &#34;terminal&#34; mode in order to manually control the modem.</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>deflink: Entering terminal mode on /dev/cuau1
type &#39;~h&#39; for help</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">at
OK
atdt123456789</code></pre>
</div>
</div>
<div class="paragraph">
<p>Use <code>at</code> to initialize the modem, then use <code>atdt</code> and the number for the ISP to begin the dial in process.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">CONNECT</code></pre>
</div>
</div>
<div class="paragraph">
<p>Confirmation of the connection, if we are going to have any connection problems, unrelated to hardware, here is where we will attempt to resolve them.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">ISP Login:myusername</code></pre>
</div>
</div>
<div class="paragraph">
<p>At this prompt, return the prompt with the username that was provided by the ISP.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">ISP Pass:mypassword</code></pre>
</div>
</div>
<div class="paragraph">
<p>At this prompt, reply with the password that was provided by the ISP. Just like logging into FreeBSD, the password will not echo.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">Shell or PPP:ppp</code></pre>
</div>
</div>
<div class="paragraph">
<p>Depending on the ISP, this prompt might not appear. If it does, it is asking whether to use a shell on the provider or to start <code>ppp</code>. In this example, <code>ppp</code> was selected in order to establish an Internet connection.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">Ppp ON example&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that in this example the first <code>p</code> has been capitalized. This shows that we have successfully connected to the ISP.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">Ppp ON example&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>We have successfully authenticated with our ISP and are waiting for the assigned IP address.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">PPP ON example&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>We have made an agreement on an IP address and successfully completed our connection.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">PPP ON example&gt;add default HISADDR</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here we add our default route, we need to do this before we can talk to the outside world as currently the only established connection is with the peer. If this fails due to existing routes, put a bang character <code>!</code> in front of the <code>add</code>. Alternatively, set this before making the actual connection and it will negotiate a new route accordingly.</p>
</div>
<div class="paragraph">
<p>If everything went good we should now have an active connection to the Internet, which could be thrown into the background using <span class="keyseq"><kbd>CTRL</kbd>+<kbd>z</kbd></span>. If <code>PPP</code> returns to <code>ppp</code> the connection has been lost. This is good to know because it shows the connection status. Capital P’s represent a connection to the ISP and lowercase p’s show that the connection has been lost.</p>
</div>
</div>
<div class="sect3">
<h4 id="_debugging">30.3.3. Debugging<a class="anchor" href="#_debugging"></a></h4>
<div class="paragraph">
<p>If a connection cannot be established, turn hardware flow CTS/RTS to off using <code>set ctsrts off</code>. This is mainly the case when connected to some PPP-capable terminal servers, where PPP hangs when it tries to write data to the communication link, and waits for a Clear To Send (CTS) signal which may never come. When using this option, include <code>set accmap</code> as it may be required to defeat hardware dependent on passing certain characters from end to end, most of the time XON/XOFF. Refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=ppp&amp;sektion=8&amp;format=html">ppp(8)</a> for more information on this option and how it is used.</p>
</div>
<div class="paragraph">
<p>An older modem may need <code>set parity even</code>. Parity is set at none be default, but is used for error checking with a large increase in traffic, on older modems.</p>
</div>
<div class="paragraph">
<p>PPP may not return to the command mode, which is usually a negotiation error where the ISP is waiting for negotiating to begin. At this point, using <code>~p</code> will force ppp to start sending the configuration information.</p>
</div>
<div class="paragraph">
<p>If a login prompt never appears, PAP or CHAP authentication is most likely required. To use PAP or CHAP, add the following options to PPP before going into terminal mode:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">ppp ON example&gt; <span class="nb">set </span>authname myusername</code></pre>
</div>
</div>
<div class="paragraph">
<p>Where <em>myusername</em> should be replaced with the username that was assigned by the ISP.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">ppp ON example&gt; <span class="nb">set </span>authkey mypassword</code></pre>
</div>
</div>
<div class="paragraph">
<p>Where <em>mypassword</em> should be replaced with the password that was assigned by the ISP.</p>
</div>
<div class="paragraph">
<p>If a connection is established, but cannot seem to find any domain name, try to <a href="https://man.freebsd.org/cgi/man.cgi?query=ping&amp;sektion=8&amp;format=html">ping(8)</a> an IP address. If there is 100 percent (100%) packet loss, it is likely that a default route was not assigned. Double check that <code>add default HISADDR</code> was set during the connection. If a connection can be made to a remote IP address, it is possible that a resolver address has not been added to <span class="filename">/etc/resolv.conf</span>. This file should look like:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>domain example.com
nameserver x.x.x.x
nameserver y.y.y.y</pre>
</div>
</div>
<div class="paragraph">
<p>Where <em>x.x.x.x</em> and <em>y.y.y.y</em> should be replaced with the IP address of the ISP’s DNS servers.</p>
</div>
<div class="paragraph">
<p>To configure <a href="https://man.freebsd.org/cgi/man.cgi?query=syslog&amp;sektion=3&amp;format=html">syslog(3)</a> to provide logging for the PPP connection, make sure this line exists in <span class="filename">/etc/syslog.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>!ppp
*.*     /var/log/ppp.log</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="pppoe">30.4. Using PPP over Ethernet (PPPoE)<a class="anchor" href="#pppoe"></a></h3>
<div class="paragraph">
<p>This section describes how to set up PPP over Ethernet (PPPoE).</p>
</div>
<div class="paragraph">
<p>Here is an example of a working <span class="filename">ppp.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>default:
  set log Phase tun command # you can add more detailed logging if you wish
  set ifaddr 10.0.0.1/0 10.0.0.2/0

name_of_service_provider:
  set device PPPoE:xl1 # replace xl1 with your Ethernet device
  set authname YOURLOGINNAME
  set authkey YOURPASSWORD
  set dial
  set login
  add default HISADDR</pre>
</div>
</div>
<div class="paragraph">
<p>As <code>root</code>, run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ppp -ddial name_of_service_provider</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Add the following to <span class="filename">/etc/rc.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>ppp_enable=&#34;YES&#34;
ppp_mode=&#34;ddial&#34;
ppp_nat=&#34;YES&#34;	# if you want to enable nat for your local network, otherwise NO
ppp_profile=&#34;name_of_service_provider&#34;</pre>
</div>
</div>
<div class="sect3">
<h4 id="_using_a_pppoe_service_tag">30.4.1. Using a PPPoE Service Tag<a class="anchor" href="#_using_a_pppoe_service_tag"></a></h4>
<div class="paragraph">
<p>Sometimes it will be necessary to use a service tag to establish the connection. Service tags are used to distinguish between different PPPoE servers attached to a given network.</p>
</div>
<div class="paragraph">
<p>Any required service tag information should be in the documentation provided by the ISP.</p>
</div>
<div class="paragraph">
<p>As a last resort, one could try installing the <a class="package" href="https://cgit.freebsd.org/ports/tree/net/rr-pppoe/">net/rr-pppoe</a> package or port. Bear in mind however, this may de-program your modem and render it useless, so think twice before doing it. Simply install the program shipped with the modem. Then, access the <b class="menuref">System</b> menu from the program. The name of the profile should be listed there. It is usually <em>ISP</em>.</p>
</div>
<div class="paragraph">
<p>The profile name (service tag) will be used in the PPPoE configuration entry in <span class="filename">ppp.conf</span> as the provider part for <code>set device</code>. Refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=ppp&amp;sektion=8&amp;format=html">ppp(8)</a> for full details. It should look like this:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>set device PPPoE:xl1:ISP</pre>
</div>
</div>
<div class="paragraph">
<p>Do not forget to change <em>xl1</em> to the proper device for the Ethernet card.</p>
</div>
<div class="paragraph">
<p>Do not forget to change <em>ISP</em> to the profile.</p>
</div>
<div class="paragraph">
<p>For additional information, refer to <a href="http://renaud.waldura.com/doc/freebsd/pppoe/">Cheaper Broadband with FreeBSD on DSL</a> by Renaud Waldura.</p>
</div>
</div>
<div class="sect3">
<h4 id="ppp-3com">30.4.2. PPPoE with a 3Com® HomeConnect™ ADSL Modem Dual Link<a class="anchor" href="#ppp-3com"></a></h4>
<div class="paragraph">
<p>This modem does not follow the PPPoE specification defined in <a href="http://www.faqs.org/rfcs/rfc2516.html">RFC 2516</a>.</p>
</div>
<div class="paragraph">
<p>In order to make FreeBSD capable of communicating with this device, a sysctl must be set. This can be done automatically at boot time by updating <span class="filename">/etc/sysctl.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>net.graph.nonstandard_pppoe=1</pre>
</div>
</div>
<div class="paragraph">
<p>or can be done immediately with the command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysctl net.graph.nonstandard_pppoe=1</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Unfortunately, because this is a system-wide setting, it is not possible to talk to a normal PPPoE client or server and a 3Com® HomeConnect™ ADSL Modem at the same time.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="pppoa">30.5. Using PPP over ATM (PPPoA)<a class="anchor" href="#pppoa"></a></h3>
<div class="paragraph">
<p>The following describes how to set up PPP over ATM (PPPoA). PPPoA is a popular choice among European DSL providers.</p>
</div>
<div class="sect3">
<h4 id="_using_mpd">30.5.1. Using mpd<a class="anchor" href="#_using_mpd"></a></h4>
<div class="paragraph">
<p>The mpd application can be used to connect to a variety of services, in particular PPTP services. It can be installed using the <a class="package" href="https://cgit.freebsd.org/ports/tree/net/mpd5/">net/mpd5</a> package or port. Many ADSL modems require that a PPTP tunnel is created between the modem and computer.</p>
</div>
<div class="paragraph">
<p>Once installed, configure mpd to suit the provider’s settings. The port places a set of sample configuration files which are well documented in <span class="filename">/usr/local/etc/mpd/</span>. A complete guide to configure mpd is available in HTML format in <span class="filename">/usr/ports/shared/doc/mpd/</span>. Here is a sample configuration for connecting to an ADSL service with mpd. The configuration is spread over two files, first the <span class="filename">mpd.conf</span>:</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This example <span class="filename">mpd.conf</span> only works with mpd 4.x.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>default:
    load adsl

adsl:
    new -i ng0 adsl adsl
    set bundle authname username <i class="conum" data-value="1"></i><b>(1)</b>
    set bundle password password <i class="conum" data-value="2"></i><b>(2)</b>
    set bundle disable multilink

    set link no pap acfcomp protocomp
    set link disable chap
    set link accept chap
    set link keep-alive 30 10

    set ipcp no vjcomp
    set ipcp ranges 0.0.0.0/0 0.0.0.0/0

    set iface route default
    set iface disable on-demand
    set iface enable proxy-arp
    set iface idle 0

    open</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The username used to authenticate with your ISP. &lt;.&gt; The password used to authenticate with your ISP.</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Information about the link, or links, to establish is found in <span class="filename">mpd.links</span>. An example <span class="filename">mpd.links</span> to accompany the above example is given beneath:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>adsl:
    set link type pptp
    set pptp mode active
    set pptp enable originate outcall
    set pptp self 10.0.0.1 <i class="conum" data-value="1"></i><b>(1)</b>
    set pptp peer 10.0.0.138 <i class="conum" data-value="2"></i><b>(2)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The IP address of FreeBSD computer running mpd. &lt;.&gt; The IP address of the ADSL modem. The Alcatel SpeedTouch™ Home defaults to <code>10.0.0.138</code>.</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>It is possible to initialize the connection easily by issuing the following command as <code>root</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># mpd -b adsl</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To view the status of the connection:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>ifconfig ng0
ng0: <span class="nv">flags</span><span class="o">=</span>88d1&lt;UP,POINTOPOINT,RUNNING,NOARP,SIMPLEX,MULTICAST&gt; mtu 1500
     inet 216.136.204.117 --&gt; 204.152.186.171 netmask 0xffffffff</code></pre>
</div>
</div>
<div class="paragraph">
<p>Using mpd is the recommended way to connect to an ADSL service with FreeBSD.</p>
</div>
</div>
<div class="sect3">
<h4 id="_using_pptpclient">30.5.2. Using pptpclient<a class="anchor" href="#_using_pptpclient"></a></h4>
<div class="paragraph">
<p>It is also possible to use FreeBSD to connect to other PPPoA services using <a class="package" href="https://cgit.freebsd.org/ports/tree/net/pptpclient/">net/pptpclient</a>.</p>
</div>
<div class="paragraph">
<p>To use <a class="package" href="https://cgit.freebsd.org/ports/tree/net/pptpclient/">net/pptpclient</a> to connect to a DSL service, install the port or package, then edit <span class="filename">/etc/ppp/ppp.conf</span>. An example section of <span class="filename">ppp.conf</span> is given below. For further information on <span class="filename">ppp.conf</span> options consult <a href="https://man.freebsd.org/cgi/man.cgi?query=ppp&amp;sektion=8&amp;format=html">ppp(8)</a>.</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>adsl:
 set log phase chat lcp ipcp ccp tun command
 set timeout 0
 enable dns
 set authname username <i class="conum" data-value="1"></i><b>(1)</b>
 set authkey password <i class="conum" data-value="2"></i><b>(2)</b>
 set ifaddr 0 0
 add default HISADDR</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The username for the DSL provider. &lt;.&gt; The password for your account.</td>
</tr>
</tbody></table>
</div>
<div class="admonitionblock warning">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Since the account’s password is added to <span class="filename">ppp.conf</span> in plain text form, make sure nobody can read the contents of this file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># chown root:wheel /etc/ppp/ppp.conf</span>
<span class="c"># chmod 600 /etc/ppp/ppp.conf</span></code></pre>
</div>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>This will open a tunnel for a PPP session to the DSL router. Ethernet DSL modems have a preconfigured LAN IP address to connect to. In the case of the Alcatel SpeedTouch™ Home, this address is <code>10.0.0.138</code>. The router’s documentation should list the address the device uses. To open the tunnel and start a PPP session:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pptp address adsl</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If an ampersand (&#34;&amp;&#34;) is added to the end of this command, pptp will return the prompt.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>A <span class="filename">tun</span> virtual tunnel device will be created for interaction between the pptp and ppp processes. Once the prompt is returned, or the pptp process has confirmed a connection, examine the tunnel:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>ifconfig tun0
tun0: <span class="nv">flags</span><span class="o">=</span>8051&lt;UP,POINTOPOINT,RUNNING,MULTICAST&gt; mtu 1500
        inet 216.136.204.21 --&gt; 204.152.186.171 netmask 0xffffff00
	Opened by PID 918</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the connection fails, check the configuration of the router, which is usually accessible using a web browser. Also, examine the output of <code>pptp</code> and the contents of the log file, <span class="filename">/var/log/ppp.log</span> for clues.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="mail">Chapter 31. Electronic Mail<a class="anchor" href="#mail"></a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="mail-synopsis">31.1. Synopsis<a class="anchor" href="#mail-synopsis"></a></h3>
<div class="paragraph">
<p>&#34;Electronic Mail&#34;, better known as email, is one of the most widely used forms of communication today. This chapter provides a basic introduction to running a mail server on FreeBSD, as well as an introduction to sending and receiving email using FreeBSD. For more complete coverage of this subject, refer to the books listed in <a href="./#bibliography">Bibliography</a>.</p>
</div>
<div class="paragraph">
<p>This chapter covers:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Which software components are involved in sending and receiving electronic mail.</p>
</li>
<li>
<p>How to configure DragonFly Mail Agent.</p>
</li>
<li>
<p>Where basic Sendmail configuration files are located in FreeBSD.</p>
</li>
<li>
<p>The difference between remote and local mailboxes.</p>
</li>
<li>
<p>How to install and configure an alternate Mail Transfer Agent, replacing DragonFly Mail Agent or Sendmail.</p>
</li>
<li>
<p>How to troubleshoot common mail server problems.</p>
</li>
<li>
<p>How to configure Sendmail to only send mail.</p>
</li>
<li>
<p>How to configure SMTP authentication for added security in Sendmail.</p>
</li>
<li>
<p>How to install and use a Mail User Agent, such as mutt, to send and receive email.</p>
</li>
<li>
<p>How to download mail from a remote POP or IMAP server.</p>
</li>
<li>
<p>How to automatically apply filters and rules to incoming email.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="mail-using">31.2. Mail Components<a class="anchor" href="#mail-using"></a></h3>
<div class="paragraph">
<p>There are five major parts involved in an email exchange: the Mail User Agent (MUA), the Mail Transfer Agent (MTA), a mail host, a remote or local mailbox, and DNS. This section provides an overview of these components.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Mail User Agent (MUA)</dt>
<dd>
<p>The Mail User Agent (MUA) is an application which is used to compose, send, and receive emails. This application can be a command line program, such as the built-in <code>mail</code> utility or a third-party application from the Ports Collection, such as alpine, elm, or mutt. Dozens of graphical programs are also available in the Ports Collection, including Claws Mail, Evolution, and Thunderbird. Some organizations provide a web mail program which can be accessed through a web browser. More information about installing and using a MUA on FreeBSD can be found in <a href="#mail-agents">Mail User Agents</a>.</p>
</dd>
<dt class="hdlist1">Mail Transfer Agent (MTA)</dt>
<dd>
<p>The Mail Transfer Agent (MTA) is responsible for receiving incoming mail and delivering outgoing mail. Starting with FreeBSD version 14.0, the default MTA is DragonFly Mail Agent (<a href="https://man.freebsd.org/cgi/man.cgi?query=dma&amp;sektion=8&amp;format=html">dma(8)</a>); in earlier versions, it is <a href="https://man.freebsd.org/cgi/man.cgi?query=sendmail&amp;sektion=8&amp;format=html">sendmail(8)</a>. Other MTAs, including Exim, Postfix, and qmail, may be installed to replace the default MTA.</p>
</dd>
<dt class="hdlist1">Mail Host and Mailboxes</dt>
<dd>
<p>The mail host is a server that is responsible for delivering and receiving mail for a host or a network. The mail host collects all mail sent to the domain and stores it either in the default <code>mbox</code> or the alternative Maildir format, depending on the configuration. Once mail has been stored, it may either be read locally using a MUA or remotely accessed and collected using protocols such as POP or IMAP. If mail is read locally, a POP or IMAP server does not need to be installed.</p>
</dd>
<dt class="hdlist1">Domain Name System (DNS)</dt>
<dd>
<p>The Domain Name System (DNS) and its daemon <a href="https://man.freebsd.org/cgi/man.cgi?query=named&amp;sektion=8&amp;format=html">named(8)</a> play a large role in the delivery of mail. In order to deliver mail from one site to another, the MTA will look up the remote site in DNS to determine which host will receive mail for the destination. This process also occurs when mail is sent from a remote host to the MTA.</p>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="dragonFly-mail-agent">31.3. DragonFly Mail Agent (DMA)<a class="anchor" href="#dragonFly-mail-agent"></a></h3>
<div class="paragraph">
<p>DragonFly Mail Agent (DMA) is the default MTA in FreeBSD starting with version 14.0. <a href="https://man.freebsd.org/cgi/man.cgi?query=dma&amp;sektion=8&amp;format=html">dma(8)</a> is a small Mail Transport Agent (MTA), designed for home and office use. It accepts mails from locally installed Mail User Agents (MUA) and delivers the mails either locally or to a remote destination. Remote delivery includes several features like TLS/SSL support and SMTP authentication.</p>
</div>
<div class="paragraph">
<p><a href="https://man.freebsd.org/cgi/man.cgi?query=dma&amp;sektion=8&amp;format=html">dma(8)</a> is not intended as a replacement for real, big MTAs like <a href="https://man.freebsd.org/cgi/man.cgi?query=sendmail&amp;sektion=8&amp;format=html">sendmail(8)</a> or <a href="https://man.freebsd.org/cgi/man.cgi?query=postfix&amp;sektion=1&amp;format=html">postfix(1)</a>. Consequently, <a href="https://man.freebsd.org/cgi/man.cgi?query=dma&amp;sektion=8&amp;format=html">dma(8)</a> does not listen on port 25 for incoming connections.</p>
</div>
<div class="sect3">
<h4 id="configuring-dragonfly-mail-agent">31.3.1. Configuring DragonFly Mail Agent (DMA)<a class="anchor" href="#configuring-dragonfly-mail-agent"></a></h4>
<div class="paragraph">
<p>DMA comes with a default configuration that will be suitable for many deployments. Custom settings are defined in <span class="filename">/etc/dma/dma.conf</span>, and SMTP authentication is configured in <span class="filename">/etc/dma/auth.conf</span>.</p>
</div>
<div class="sect4">
<h5 id="configuring-gmail-dma">31.3.1.1. Using DMA to Route Outgoing Mail through Gmail (STARTTLS:SMTP example)<a class="anchor" href="#configuring-gmail-dma"></a></h5>
<div class="paragraph">
<p>This example <span class="filename">/etc/dma/dma.conf</span> can be used to send mail using Google’s SMTP servers.</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>SMARTHOST smtp.gmail.com
PORT 587
AUTHPATH /etc/dma/auth.conf
SECURETRANSFER
STARTTLS
MASQUERADE username@gmail.com</pre>
</div>
</div>
<div class="paragraph">
<p>Authentication can be set with one line in <span class="filename">/etc/dma/auth.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>username@gmail.com|smtp.gmail.com:password</pre>
</div>
</div>
<div class="paragraph">
<p>Execute the following command to test the configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span><span class="nb">echo </span>this is a <span class="nb">test</span> | mail -v -s testing-email username@gmail.com</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="configuring-fastmail-dma">31.3.1.2. Using DMA to Route Outgoing Mail through Fastmail (SSL/TLS example)<a class="anchor" href="#configuring-fastmail-dma"></a></h5>
<div class="paragraph">
<p>This example <span class="filename">/etc/dma/dma.conf</span> can be used to send mail using Fastmail’s SMTP servers.</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>SMARTHOST smtp.fastmail.com
PORT 465
AUTHPATH /etc/dma/auth.conf
SECURETRANSFER
MAILNAME example.server.com</pre>
</div>
</div>
<div class="paragraph">
<p>Authentication can be set with one line in <span class="filename">/etc/dma/auth.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>username@fastmail.com|smtp.fastmail.com:password</pre>
</div>
</div>
<div class="paragraph">
<p>Execute the following command to test the configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span><span class="nb">echo </span>this is a <span class="nb">test</span> | mail -v -s testing-email username@fastmail.com</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="configuring-custom-dma">31.3.1.3. Using DMA to Route Outgoing Mail through a Custom Mail Host<a class="anchor" href="#configuring-custom-dma"></a></h5>
<div class="paragraph">
<p>This example <span class="filename">/etc/dma/dma.conf</span> can be used to send mail using a custom mail host.</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>SMARTHOST mail.example.org
PORT 587
AUTHPATH /etc/dma/auth.conf
SECURETRANSFER
STARTTLS</pre>
</div>
</div>
<div class="paragraph">
<p>Authentication can be set with one line in <span class="filename">/etc/dma/auth.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>username@example.org|mail.example.org:password</pre>
</div>
</div>
<div class="paragraph">
<p>Execute the following command to test the configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span><span class="nb">echo </span>this is a <span class="nb">test</span> | mail -v -s testing-email username@example.org</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sendmail">31.4. Sendmail<a class="anchor" href="#sendmail"></a></h3>
<div class="paragraph">
<p>Sendmail is a venerable and versatile Mail Transfer Agent (MTA) with a long history in UNIX® and UNIX-like systems. It was a part of the FreeBSD base system until FreeBSD 13, offering robust email transport capabilities, extensive customization options, and support for complex routing and filtering.</p>
</div>
<div class="sect3">
<h4 id="configuring-sendmail">31.4.1. Configuration Files<a class="anchor" href="#configuring-sendmail"></a></h4>
<div class="paragraph">
<p>The configuration files for Sendmail are located in <span class="filename">/etc/mail/</span>.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><span class="filename">/etc/mail/access</span></dt>
<dd>
<p>This access database file defines which hosts or IP addresses have access to the local mail server and what kind of access they have. Hosts listed as <code>OK</code>, which is the default option, are allowed to send mail to this host as long as the mail’s final destination is the local machine. Hosts listed as <code>REJECT</code> are rejected for all mail connections. Hosts listed as <code>RELAY</code> are allowed to send mail for any destination using this mail server. Hosts listed as <code>ERROR</code> will have their mail returned with the specified mail error. If a host is listed as <code>SKIP</code>, Sendmail will abort the current search for this entry without accepting or rejecting the mail. Hosts listed as <code>QUARANTINE</code> will have their messages held and will receive the specified text as the reason for the hold.</p>
<div class="paragraph">
<p>Examples of using these options for both IPv4 and IPv6 addresses can be found in the FreeBSD sample configuration, <span class="filename">/etc/mail/access.sample</span>:</p>
</div>
<div class="paragraph">
<p>To configure the access database, use the format shown in the sample to make entries in <span class="filename">/etc/mail/access</span>, but do not put a comment symbol (<code>#</code>) in front of the entries. Create an entry for each host or network whose access should be configured. Mail senders that match the left side of the table are affected by the action on the right side of the table.</p>
</div>
<div class="paragraph">
<p>Whenever this file is updated, update its database and restart Sendmail:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># makemap hash /etc/mail/access &lt; /etc/mail/access</span>
<span class="c"># service sendmail restart</span></code></pre>
</div>
</div>
</dd>
<dt class="hdlist1"><span class="filename">/etc/mail/aliases</span></dt>
<dd>
<p>This database file contains a list of virtual mailboxes that are expanded to users, files, programs, or other aliases. Here are a few entries to illustrate the file format:</p>
<div class="literalblock programlisting">
<div class="content">
<pre>root: localuser
ftp-bugs: joe,eric,paul
bit.bucket:  /dev/null
procmail: &#34;|/usr/local/bin/procmail&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>The mailbox name on the left side of the colon is expanded to the target(s) on the right. The first entry expands the <code>root</code> mailbox to the <code>localuser</code> mailbox, which is then looked up in the <span class="filename">/etc/mail/aliases</span> database. If no match is found, the message is delivered to <code>localuser</code>. The second entry shows a mail list. Mail to <code>ftp-bugs</code> is expanded to the three local mailboxes <code>joe</code>, <code>eric</code>, and <code>paul</code>. A remote mailbox could be specified as <em>user@example.com</em>. The third entry shows how to write mail to a file, in this case <span class="filename">/dev/null</span>. The last entry demonstrates how to send mail to a program, <span class="filename">/usr/local/bin/procmail</span>, through a UNIX® pipe. Refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=aliases&amp;sektion=5&amp;format=html">aliases(5)</a> for more information about the format of this file.</p>
</div>
<div class="paragraph">
<p>Whenever this file is updated, run <code>newaliases</code> to update and initialize the aliases database.</p>
</div>
</dd>
<dt class="hdlist1"><span class="filename">/etc/mail/sendmail.cf</span></dt>
<dd>
<p>This is the master configuration file for Sendmail. It controls the overall behavior of Sendmail, including everything from rewriting email addresses to printing rejection messages to remote mail servers. Accordingly, this configuration file is quite complex. Fortunately, this file rarely needs to be changed for standard mail servers.</p>
<div class="paragraph">
<p>The master Sendmail configuration file can be built from <a href="https://man.freebsd.org/cgi/man.cgi?query=m4&amp;sektion=1&amp;format=html">m4(1)</a> macros that define the features and behavior of Sendmail. Refer to <span class="filename">/usr/src/contrib/sendmail/cf/README</span> for some of the details.</p>
</div>
<div class="paragraph">
<p>Whenever changes to this file are made, Sendmail needs to be restarted for the changes to take effect.</p>
</div>
</dd>
<dt class="hdlist1"><span class="filename">/etc/mail/virtusertable</span></dt>
<dd>
<p>This database file maps mail addresses for virtual domains and users to real mailboxes. These mailboxes can be local, remote, aliases defined in <span class="filename">/etc/mail/aliases</span>, or files. This allows multiple virtual domains to be hosted on one machine.</p>
<div class="paragraph">
<p>FreeBSD provides a sample configuration file in <span class="filename">/etc/mail/virtusertable.sample</span> to further demonstrate its format. The following example demonstrates how to create custom entries using that format:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>root@example.com                root
postmaster@example.com          postmaster@noc.example.net
@example.com                    joe</pre>
</div>
</div>
<div class="paragraph">
<p>This file is processed in a first match order. When an email address matches the address on the left, it is mapped to the local mailbox listed on the right. The format of the first entry in this example maps a specific email address to a local mailbox, whereas the format of the second entry maps a specific email address to a remote mailbox. Finally, any email address from <code>example.com</code> which has not matched any of the previous entries will match the last mapping and be sent to the local mailbox <code>joe</code>. When creating custom entries, use this format and add them to <span class="filename">/etc/mail/virtusertable</span>. Whenever this file is edited, update its database and restart Sendmail:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># makemap hash /etc/mail/virtusertable &lt; /etc/mail/virtusertable</span>
<span class="c"># service sendmail restart</span></code></pre>
</div>
</div>
</dd>
<dt class="hdlist1"><span class="filename">/etc/mail/relay-domains</span></dt>
<dd>
<p>In a default FreeBSD installation, Sendmail is configured to only send mail from the host it is running on. For example, if a POP server is available, users will be able to check mail from remote locations but they will not be able to send outgoing emails from outside locations. Typically, a few moments after the attempt, an email will be sent from <code>MAILER-DAEMON</code> with a <code>5.7 Relaying Denied</code> message.</p>
<div class="paragraph">
<p>The most straightforward solution is to add the ISP’s FQDN to <span class="filename">/etc/mail/relay-domains</span>. If multiple addresses are needed, add them one per line:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>your.isp.example.com
other.isp.example.net
users-isp.example.org
www.example.org</pre>
</div>
</div>
<div class="paragraph">
<p>After creating or editing this file, restart Sendmail with <code>service sendmail restart</code>.</p>
</div>
<div class="paragraph">
<p>Now any mail sent through the system by any host in this list, provided the user has an account on the system, will succeed. This allows users to send mail from the system remotely without opening the system up to relaying SPAM from the Internet.</p>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mail-changingmta">31.5. Changing the Mail Transfer Agent<a class="anchor" href="#mail-changingmta"></a></h3>
<div class="paragraph">
<p>Starting with FreeBSD version 14.0, <a href="https://man.freebsd.org/cgi/man.cgi?query=dma&amp;sektion=8&amp;format=html">dma(8)</a> is the default MTA, and before 14.0, the default MTA is <a href="https://man.freebsd.org/cgi/man.cgi?query=sendmail&amp;sektion=8&amp;format=html">sendmail(8)</a>. However, the system administrator can change the system’s MTA. A wide choice of alternative MTAs is available from the <code>mail</code> category of the FreeBSD Ports Collection.</p>
</div>
<div class="admonitionblock warning">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If the default’s outgoing mail service is disabled, it is important that it is replaced with an alternative mail delivery system. Otherwise, system functions such as <a href="https://man.freebsd.org/cgi/man.cgi?query=periodic&amp;sektion=8&amp;format=html">periodic(8)</a> will be unable to deliver their results by email. Many parts of the system expect a functional MTA. If applications continue to use the default binaries to try to send email after they are disabled, mail could go into an inactive queue and never be delivered.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="sect3">
<h4 id="replace-sendmail-dma">31.5.1. Replacing Sendmail with Other MTA<a class="anchor" href="#replace-sendmail-dma"></a></h4>
<div class="paragraph">
<p>In order to completely disable <a href="https://man.freebsd.org/cgi/man.cgi?query=sendmail&amp;sektion=8&amp;format=html">sendmail(8)</a> execute the following commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysrc sendmail_enable=&#34;NO&#34;</span>
<span class="c"># sysrc sendmail_submit_enable=&#34;NO&#34;</span>
<span class="c"># sysrc sendmail_outbound_enable=&#34;NO&#34;</span>
<span class="c"># sysrc sendmail_msp_queue_enable=&#34;NO&#34;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To only disable <a href="https://man.freebsd.org/cgi/man.cgi?query=sendmail&amp;sektion=8&amp;format=html">sendmail(8)</a>&#39;s incoming mail service execute the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysrc sendmail_enable=&#34;NO&#34;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then stop the <a href="https://man.freebsd.org/cgi/man.cgi?query=sendmail&amp;sektion=8&amp;format=html">sendmail(8)</a> service:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># service sendmail onestop</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Some extra configuration is needed as <a href="https://man.freebsd.org/cgi/man.cgi?query=sendmail&amp;sektion=8&amp;format=html">sendmail(8)</a> is so ubiquitous that some software assumes it is already installed and configured. Check <span class="filename">/etc/periodic.conf</span> and make sure that these values are set to <code>NO</code>. If this file does not exist, create it with these entries:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>daily_clean_hoststat_enable=&#34;NO&#34;
daily_status_mail_rejects_enable=&#34;NO&#34;
daily_status_include_submit_mailq=&#34;NO&#34;
daily_submit_queuerun=&#34;NO&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>The next step is to install another MTA, <a href="https://man.freebsd.org/cgi/man.cgi?query=dma&amp;sektion=8&amp;format=html">dma(8)</a> will be used in this example. As pointed above, <a href="https://man.freebsd.org/cgi/man.cgi?query=dma&amp;sektion=8&amp;format=html">dma(8)</a> is the default MTA in FreeBSD starting with version 14.0. Therefore, it is only necessary to install it from the ports if you are using a previous version.</p>
</div>
<div class="paragraph">
<p>To install it execute the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install dma</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Perform the configuration as indicated in <a href="#configuring-dragonfly-mail-agent">Configuring DragonFly Mail Agent (DMA)</a>.</p>
</div>
<div class="paragraph">
<p>Then change all the entries in the file <span class="filename">/etc/mail/mailer.conf</span> to <a href="https://man.freebsd.org/cgi/man.cgi?query=dma&amp;sektion=8&amp;format=html">dma(8)</a>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre># $FreeBSD$
#
# Execute the &#34;real&#34; sendmail program, named /usr/libexec/sendmail/sendmail
#
# If dma(8) is installed, an example mailer.conf that uses dma(8) instead can
# be found in /usr/share/examples/dma
#
sendmail        /usr/local/libexec/dma
mailq           /usr/local/libexec/dma
newaliases      /usr/local/libexec/dma</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When using the version of <a href="https://man.freebsd.org/cgi/man.cgi?query=dma&amp;sektion=8&amp;format=html">dma(8)</a> included in the base system, the paths will change to <span class="filename">/usr/libexec/dma</span>.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>To ensure that anything in the queue is flushed at boot or before shutdown, execute the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysrc dma_flushq_enable=&#34;YES&#34;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Once everything is configured, it is recommended to reboot the system. Rebooting provides the opportunity to ensure that the system is correctly configured to start the new MTA automatically on boot.</p>
</div>
</div>
<div class="sect3">
<h4 id="replace-dma">31.5.2. Replacing DragonFly Mail Agent (DMA) with Other MTA<a class="anchor" href="#replace-dma"></a></h4>
<div class="paragraph">
<p>As noted above, starting with FreeBSD version 14.0, the default MTA is DMA. In this example, <a class="package" href="https://cgit.freebsd.org/ports/tree/mail/postfix/">mail/postfix</a> will be used as the alternative MTA.</p>
</div>
<div class="paragraph">
<p>Before installing <a class="package" href="https://cgit.freebsd.org/ports/tree/mail/postfix/">mail/postfix</a> some extra configuration is needed. Check <span class="filename">/etc/periodic.conf</span> and make sure that these values are set to <code>NO</code>. If this file does not exist, create it with these entries:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>daily_clean_hoststat_enable=&#34;NO&#34;
daily_status_mail_rejects_enable=&#34;NO&#34;
daily_status_include_submit_mailq=&#34;NO&#34;
daily_submit_queuerun=&#34;NO&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>Then install <a class="package" href="https://cgit.freebsd.org/ports/tree/mail/postfix/">mail/postfix</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install postfix</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To start <a class="package" href="https://cgit.freebsd.org/ports/tree/mail/postfix/">mail/postfix</a> at system boot execute the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysrc postfix_enable=&#34;YES&#34;</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>It is good practice to read the installation message after installing an application. Provides useful information about settings, etc.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>If postfix is <strong>not</strong> already activated in <span class="filename">/usr/local/etc/mail/mailer.conf</span> execute the following commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">mv /usr/local/etc/mail/mailer.conf /usr/local/etc/mail/mailer.conf.old
install -d /usr/local/etc/mail
install -m 0644 /usr/local/share/postfix/mailer.conf.postfix /usr/local/etc/mail/mailer.conf</code></pre>
</div>
</div>
<div class="paragraph">
<p>When employing SASL, ensure that postfix has access to read the sasldb file. This is accomplished by adding postfix to group mail and making the <span class="filename">/usr/local/etc/sasldb*</span> file(s) readable by group mail (this should be the default for new installs).</p>
</div>
<div class="paragraph">
<p>Once everything is configured, it is recommended to reboot the system. Rebooting provides the opportunity to ensure that the system is correctly configured to start the new MTA automatically on boot.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mail-agents">31.6. Mail User Agents<a class="anchor" href="#mail-agents"></a></h3>
<div class="paragraph">
<p>A MUA is an application that is used to send and receive email. As email &#34;evolves&#34; and becomes more complex, MUAs are becoming increasingly powerful and provide users increased functionality and flexibility. The <code>mail</code> category of the FreeBSD Ports Collection contains numerous MUAs. These include graphical email clients such as Evolution or Balsa and console based clients such as mutt or alpine.</p>
</div>
<div class="sect3">
<h4 id="mail-command">31.6.1. mail<a class="anchor" href="#mail-command"></a></h4>
<div class="paragraph">
<p><a href="https://man.freebsd.org/cgi/man.cgi?query=mail&amp;sektion=1&amp;format=html">mail(1)</a> is the default MUA installed with FreeBSD. It is a console based MUA that offers the basic functionality required to send and receive text-based email. It provides limited attachment support and can only access local mailboxes.</p>
</div>
<div class="paragraph">
<p>Although <a href="https://man.freebsd.org/cgi/man.cgi?query=mail&amp;sektion=1&amp;format=html">mail(1)</a> does not natively support interaction with POP or IMAP servers, these mailboxes may be downloaded to a local <code>mbox</code> using an application such as fetchmail or getmail.</p>
</div>
<div class="paragraph">
<p>In order to send and receive email, run <a href="https://man.freebsd.org/cgi/man.cgi?query=mail&amp;sektion=1&amp;format=html">mail(1)</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>mail</code></pre>
</div>
</div>
<div class="paragraph">
<p>The contents of the user’s mailbox in <span class="filename">/var/mail</span> are automatically read by <a href="https://man.freebsd.org/cgi/man.cgi?query=mail&amp;sektion=1&amp;format=html">mail(1)</a>. Should the mailbox be empty, the utility exits with a message indicating that no mail could be found. If mail exists, the application interface starts, and a list of messages will be displayed.</p>
</div>
<div class="paragraph">
<p>Messages are automatically numbered, as can be seen in the following example:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>Mail version 8.1 6/6/93.  Type ? for help.
&#34;/var/mail/username&#34;: 3 messages 3 new
&gt;N  1 root@localhost        Mon Mar  8 14:05  14/510   &#34;test&#34;
 N  2 root@localhost        Mon Mar  8 14:05  14/509   &#34;user account&#34;
 N  3 root@localhost        Mon Mar  8 14:05  14/509   &#34;sample&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>Messages can now be read by typing <kbd>t</kbd> followed by the message number.</p>
</div>
<div class="paragraph">
<p>This example reads the first email:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>&amp; t 1
Message 1:
From root@localhost  Mon Mar  8 14:05:52 2004
X-Original-To: username@localhost
Delivered-To: username@localhost
To: username@localhost
Subject: test
Date: Mon,  8 Mar 2004 14:05:52 +0200 (SAST)
From: root@localhost (Charlie Root)

This is a test message, please reply if you receive it.</pre>
</div>
</div>
<div class="paragraph">
<p>As seen in this example, the message will be displayed with full headers.</p>
</div>
<div class="paragraph">
<p>To display the list of messages again, press <kbd>h</kbd>.</p>
</div>
<div class="paragraph">
<p>If the email requires a reply, press either <kbd>R</kbd> or <kbd>r</kbd> <a href="https://man.freebsd.org/cgi/man.cgi?query=mail&amp;sektion=1&amp;format=html">mail(1)</a> keys. <kbd>R</kbd> instructs <a href="https://man.freebsd.org/cgi/man.cgi?query=mail&amp;sektion=1&amp;format=html">mail(1)</a> to reply only to the sender of the email, while <kbd>r</kbd> replies to all other recipients of the message. These commands can be suffixed with the mail number of the message to reply to. After typing the response, the end of the message should be marked by a single <kbd>.</kbd> on its own line.</p>
</div>
<div class="paragraph">
<p>An example can be seen below:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>&amp; R 1
To: root@localhost
Subject: Re: test

Thank you, I did get your email.
.
EOT</pre>
</div>
</div>
<div class="paragraph">
<p>In order to send a new email, press <kbd>m</kbd>, followed by the recipient email address. Multiple recipients may be specified by separating each address with the <kbd>,</kbd> delimiter. The subject of the message may then be entered, followed by the message contents. The end of the message should be specified by putting a single <kbd>.</kbd> on its own line.</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>&amp; mail root@localhost
Subject: I mastered mail

Now I can send and receive email using mail ... :)
.
EOT</pre>
</div>
</div>
<div class="paragraph">
<p>While using <a href="https://man.freebsd.org/cgi/man.cgi?query=mail&amp;sektion=1&amp;format=html">mail(1)</a>, press <kbd>?</kbd> to display help at any time. Refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=mail&amp;sektion=1&amp;format=html">mail(1)</a> for more help on how to use <a href="https://man.freebsd.org/cgi/man.cgi?query=mail&amp;sektion=1&amp;format=html">mail(1)</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><a href="https://man.freebsd.org/cgi/man.cgi?query=mail&amp;sektion=1&amp;format=html">mail(1)</a> was not designed to handle attachments and thus deals with them poorly. Newer MUAs handle attachments in a more intelligent way.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect3">
<h4 id="mutt-command">31.6.2. Mutt<a class="anchor" href="#mutt-command"></a></h4>
<div class="paragraph">
<p>Mutt is a powerful MUA, with many features, including:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The ability to thread messages.</p>
</li>
<li>
<p>PGP support for digital signing and encryption of email.</p>
</li>
<li>
<p>MIME support.</p>
</li>
<li>
<p>Maildir support.</p>
</li>
<li>
<p>Highly customizable.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Refer to <a href="http://www.mutt.org">http://www.mutt.org</a> for more information on Mutt.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A Mutt fork called NeoMutt is worth mentioning, which brings added features. See more on the <a href="https://neomutt.org/about.html">NeoMutt website</a>. If NeoMutt was chosen, replace the following command examples from <code>mutt</code> to <code>neomutt</code>.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Mutt may be installed using the <a class="package" href="https://cgit.freebsd.org/ports/tree/mail/mutt/">mail/mutt</a> port. After the port has been installed, Mutt can be started by issuing the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>mutt</code></pre>
</div>
</div>
<div class="paragraph">
<p>Mutt will automatically read and display the contents of the user mailbox in <span class="filename">/var/mail</span>. If no mails are found, Mutt will wait for commands from the user. The example below shows Mutt displaying a list of messages:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/mail/mutt1.png" alt="Mutt email client showing a list of messages"/>
</div>
</div>
<div class="paragraph">
<p>To read an email, select it using the cursor keys and press <kbd>Enter</kbd>. An example of Mutt displaying email can be seen below:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/mail/mutt2.png" alt="Mutt email client displaying an email"/>
</div>
</div>
<div class="paragraph">
<p>Similar to <a href="https://man.freebsd.org/cgi/man.cgi?query=mail&amp;sektion=1&amp;format=html">mail(1)</a>, Mutt can be used to reply only to the sender of the message as well as to all recipients. To reply only to the sender of the email, press <kbd>r</kbd>. To send a group reply to the original sender as well as all the message recipients, press <kbd>g</kbd>.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>By default, Mutt uses the <a href="https://man.freebsd.org/cgi/man.cgi?query=vi&amp;sektion=1&amp;format=html">vi(1)</a> editor for creating and replying to emails. Each user can customize this by creating or editing the <span class="filename">.muttrc</span> in their home directory and setting the <code>editor</code> variable or by setting the <code>EDITOR</code> environment variable. Refer to <a href="http://www.mutt.org/">http://www.mutt.org/</a> for more information about configuring Mutt.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>To compose a new mail message, press <kbd>m</kbd>. After a valid subject has been given, Mutt will start <a href="https://man.freebsd.org/cgi/man.cgi?query=vi&amp;sektion=1&amp;format=html">vi(1)</a> so the email can be written. Once the contents of the email are complete, save and quit from <code>vi</code>. Mutt will resume, displaying a summary screen of the mail that is to be delivered. In order to send the mail, press <kbd>y</kbd>. An example of the summary screen can be seen below:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/mail/mutt3.png" alt="Mutt email client showing the summary screen"/>
</div>
</div>
<div class="paragraph">
<p>Mutt contains extensive help which can be accessed from most of the menus by pressing <kbd>?</kbd>. The top line also displays the keyboard shortcuts where appropriate.</p>
</div>
</div>
<div class="sect3">
<h4 id="alpine-command">31.6.3. alpine<a class="anchor" href="#alpine-command"></a></h4>
<div class="paragraph">
<p>alpine is aimed at a beginner user, but also includes some advanced features.</p>
</div>
<div class="admonitionblock warning">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>alpine has had several remote vulnerabilities discovered in the past, which allowed remote attackers to execute arbitrary code as users on the local system, by the action of sending a specially-prepared email. While <em>known</em> problems have been fixed, alpine code is written in an insecure style and the FreeBSD Security Officer believes there are likely to be other undiscovered vulnerabilities. Users install alpine at their own risk.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>The current version of alpine may be installed using the <a class="package" href="https://cgit.freebsd.org/ports/tree/mail/alpine/">mail/alpine</a> port. Once the port has installed, alpine can be started by issuing the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>alpine</code></pre>
</div>
</div>
<div class="paragraph">
<p>The first time alpine runs, it displays a greeting page with a brief introduction, as well as a request from the alpine development team to send an anonymous email message allowing them to judge how many users are using their client. To send this anonymous message, press <kbd>Enter</kbd>. Alternatively, press <kbd>E</kbd> to exit the greeting without sending an anonymous message. An example of the greeting page is shown below:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/mail/pine1.png" alt="alpine email client showing the greeting page"/>
</div>
</div>
<div class="paragraph">
<p>The main menu is then presented, which can be navigated using the cursor keys. This main menu provides shortcuts for the composing new mails, browsing mail directories, and administering address book entries. Below the main menu, relevant keyboard shortcuts to perform functions specific to the task at hand are shown.</p>
</div>
<div class="paragraph">
<p>The default directory opened by alpine is <span class="filename">inbox</span>. To view the message index, press <kbd>I</kbd>, or select the <span class="guimenuitem">MESSAGE INDEX</span> option shown below:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/mail/pine2.png" alt="alpine email client showing the default directory"/>
</div>
</div>
<div class="paragraph">
<p>The message index shows messages in the current directory and can be navigated by using the cursor keys. Highlighted messages can be read by pressing <kbd>Enter</kbd>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/mail/pine3.png" alt="alpine email client showing the message index"/>
</div>
</div>
<div class="paragraph">
<p>In the screenshot below, a sample message is displayed by alpine. Contextual keyboard shortcuts are displayed at the bottom of the screen. An example of one of a shortcut is <kbd>r</kbd>, which tells the MUA to reply to the current message being displayed.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/mail/pine4.png" alt="alpine email client showing an email"/>
</div>
</div>
<div class="paragraph">
<p>Replying to an email in alpine is done using the pico editor, which is installed by default with alpine. pico makes it easy to navigate the message and is easier for novice users to use than <a href="https://man.freebsd.org/cgi/man.cgi?query=vi&amp;sektion=1&amp;format=html">vi(1)</a> or <a href="https://man.freebsd.org/cgi/man.cgi?query=mail&amp;sektion=1&amp;format=html">mail(1)</a>. Once the reply is complete, the message can be sent by pressing <span class="keyseq"><kbd>Ctrl</kbd>+<kbd>X</kbd></span>. alpine will ask for confirmation before sending the message.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/mail/pine5.png" alt="alpine email client showing the message compose window"/>
</div>
</div>
<div class="paragraph">
<p>alpine can be customized using the <span class="guimenuitem">SETUP</span> option from the main menu.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mail-advanced">31.7. Advanced Topics<a class="anchor" href="#mail-advanced"></a></h3>
<div class="paragraph">
<p>This section covers more involved topics such as mail configuration and setting up mail for an entire domain.</p>
</div>
<div class="sect3">
<h4 id="mail-config">31.7.1. Basic Configuration<a class="anchor" href="#mail-config"></a></h4>
<div class="paragraph">
<p>Out of the box, one can send email to external hosts as long as <span class="filename">/etc/resolv.conf</span> is configured or the network has access to a configured DNS server. To have email delivered to the MTA on the FreeBSD host, do one of the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Run a DNS server for the domain.</p>
</li>
<li>
<p>Get mail delivered directly to the FQDN for the machine.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In order to have mail delivered directly to a host, it must have a permanent static IP address, not a dynamic IP address. If the system is behind a firewall, it must be configured to allow SMTP traffic. To receive mail directly at a host, one of these two must be configured:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Make sure that the lowest-numbered MX record in DNS points to the host’s static IP address.</p>
</li>
<li>
<p>Make sure there is no MX entry in the DNS for the host.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Either of the above will allow mail to be received directly at the host.</p>
</div>
<div class="paragraph">
<p>Try this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># hostname</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should be similar to the following:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>example.FreeBSD.org</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># host example.FreeBSD.org</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should be similar to the following:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>example.FreeBSD.org has address 204.216.27.XX</pre>
</div>
</div>
<div class="paragraph">
<p>In this example, mail sent directly to <a href="mailto:yourlogin@example.FreeBSD.org">yourlogin@example.FreeBSD.org</a> should work without problems, assuming a full-featured MTA is running correctly on <code>example.FreeBSD.org</code>. Note that <a href="https://man.freebsd.org/cgi/man.cgi?query=dma&amp;sektion=8&amp;format=html">dma(8)</a> does not listen on port 25 for incoming connections and cannot be used in this scenario.</p>
</div>
<div class="paragraph">
<p>For this example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># host example.FreeBSD.org</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should be similar to the following:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>example.FreeBSD.org has address 204.216.27.XX
example.FreeBSD.org mail is handled (pri=10) by nevdull.FreeBSD.org</pre>
</div>
</div>
<div class="paragraph">
<p>All mail sent to <code>example.FreeBSD.org</code> will be collected on <code>nevdull</code> under the same username instead of being sent directly to your host.</p>
</div>
<div class="paragraph">
<p>The above information is handled by the DNS server. The DNS record that carries mail routing information is the <a href="https://en.wikipedia.org/wiki/MX_record">mail exchanger record (MX record)</a>. If no MX record exists, mail will be delivered directly to the host by way of its IP address.</p>
</div>
<div class="paragraph">
<p>The MX entry for <code>freefall.FreeBSD.org</code> at one time looked like this:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>freefall		MX	30	mail.crl.net
freefall		MX	40	agora.rdrop.com
freefall		MX	10	freefall.FreeBSD.org
freefall		MX	20	who.cdrom.com</pre>
</div>
</div>
<div class="paragraph">
<p><code>freefall</code> had many MX entries. The lowest MX number is the host that receives mail directly, if available. If it is not accessible for some reason, the next lower-numbered host will accept messages temporarily, and pass it along when a lower-numbered host becomes available.</p>
</div>
<div class="paragraph">
<p>Alternate MX sites should have separate Internet connections in order to be most useful. Your ISP can provide this service.</p>
</div>
</div>
<div class="sect3">
<h4 id="mail-domain">31.7.2. Mail for a Domain<a class="anchor" href="#mail-domain"></a></h4>
<div class="paragraph">
<p>When configuring an MTA for a network, any mail sent to hosts in its domain should be diverted to the MTA so that users can receive their mail on the master mail server.</p>
</div>
<div class="paragraph">
<p>To make life easiest, a user account with the same <em>username</em> should exist on both the MTA and the system with the MUA. Use <a href="https://man.freebsd.org/cgi/man.cgi?query=adduser&amp;sektion=8&amp;format=html">adduser(8)</a> to create the user accounts.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In addition to adding local users to the host, there are alternative methods known as virtual users. Programs like <a href="https://www.cyrusimap.org/">Cyrus</a> and <a href="https://www.dovecot.org/">Dovecot</a> can be integrated into MTAs to handle users, mail storage, and also provide access via POP3 and IMAP.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>The MTA must be the designated mail exchanger for each workstation on the network. This is done in the DNS configuration with an MX record:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>example.FreeBSD.org	A	204.216.27.XX		; Workstation
			MX	10 nevdull.FreeBSD.org	; Mailhost</pre>
</div>
</div>
<div class="paragraph">
<p>This will redirect mail for the workstation to the MTA no matter where the A record points. The mail is sent to the MX host.</p>
</div>
<div class="paragraph">
<p>This must be configured on a DNS server. If the network does not run its own DNS server, talk to the ISP or DNS provider.</p>
</div>
<div class="paragraph">
<p>The following is an example of virtual email hosting.</p>
</div>
<div class="paragraph">
<p>Consider a customer with the domain <code>customer1.org</code>, where all the mail for <code>customer1.org</code> should be sent to <code>mail.myhost.com</code>.</p>
</div>
<div class="paragraph">
<p>The DNS entry should look like this:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>customer1.org		MX	10	mail.myhost.com</pre>
</div>
</div>
<div class="paragraph">
<p>An <code>A</code> record is <em>not</em> needed for <code>customer1.org</code> in order to only handle email for that domain. However, running <code>ping</code> against <code>customer1.org</code> will not work unless an <code>A</code> record exists for it.</p>
</div>
<div class="paragraph">
<p>Tell the MTA which domains and/or hostnames it should accept mail for. Either of the following will work for Sendmail:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Add the hosts to <span class="filename">/etc/mail/local-host-names</span> when using the <code>FEATURE(use_cw_file)</code>.</p>
</li>
<li>
<p>Add a <code>Cwyour.host.com</code> line to <span class="filename">/etc/sendmail.cf</span>.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="outgoing-only">31.7.3. Setting Up to Send Only<a class="anchor" href="#outgoing-only"></a></h4>
<div class="paragraph">
<p>There are many instances where one may only want to send mail through a relay. Some examples are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The computer is a desktop machine that needs to use programs such as <a href="https://man.freebsd.org/cgi/man.cgi?query=mail&amp;sektion=1&amp;format=html">mail(1)</a>, using the ISP’s mail relay.</p>
</li>
<li>
<p>The computer is a server that does not handle mail locally, but needs to pass off all mail to a relay for processing.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>While any MTA is capable of filling this particular niche, it can be difficult to properly configure a full-featured MTA just to handle offloading mail. Programs such as Sendmail and Postfix are overkill for this use.</p>
</div>
<div class="paragraph">
<p>Additionally, a typical Internet access service agreement may forbid one from running a &#34;mail server&#34;.</p>
</div>
<div class="paragraph">
<p>The easiest way to fulfill those needs is to use the <a href="https://man.freebsd.org/cgi/man.cgi?query=dma&amp;sektion=8&amp;format=html">dma(8)</a> MTA included in the <a href="#configuring-dragonfly-mail-agent">base system</a>. For systems up to 13.2, need be to installed from ports.</p>
</div>
<div class="paragraph">
<p>In addition to <a href="https://man.freebsd.org/cgi/man.cgi?query=dma&amp;sektion=8&amp;format=html">dma(8)</a>, third-party software can be used to achieve the same, like <a class="package" href="https://cgit.freebsd.org/ports/tree/mail/ssmtp/">mail/ssmtp</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># cd /usr/ports/mail/ssmtp</span>
<span class="c"># make install replace clean</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Once installed, <a class="package" href="https://cgit.freebsd.org/ports/tree/mail/ssmtp/">mail/ssmtp</a> can be configured with <span class="filename">/usr/local/etc/ssmtp/ssmtp.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>root=yourrealemail@example.com
mailhub=mail.example.com
rewriteDomain=example.com
hostname=_HOSTNAME_</pre>
</div>
</div>
<div class="paragraph">
<p>Use the real email address for <code>root</code>. Enter the ISP’s outgoing mail relay in place of <code>mail.example.com</code>. Some ISPs call this the &#34;outgoing mail server&#34; or &#34;SMTP server&#34;.</p>
</div>
<div class="paragraph">
<p>Make sure to disable Sendmail, including the outgoing mail service. See <a href="#mail-disable-sendmail">[mail-disable-sendmail]</a> for details.</p>
</div>
<div class="paragraph">
<p><a class="package" href="https://cgit.freebsd.org/ports/tree/mail/ssmtp/">mail/ssmtp</a> has some other options available. Refer to the examples in <span class="filename">/usr/local/etc/ssmtp</span> or the manual page of ssmtp for more information.</p>
</div>
<div class="paragraph">
<p>Setting up ssmtp in this manner allows any software on the computer that needs to send mail to function properly, while not violating the ISP’s usage policy or allowing the computer to be hijacked for spamming.</p>
</div>
</div>
<div class="sect3">
<h4 id="SMTP-Auth">31.7.4. SMTP Authentication in Sendmail<a class="anchor" href="#SMTP-Auth"></a></h4>
<div class="paragraph">
<p>Configuring SMTP authentication on the MTA provides a number of benefits. SMTP authentication adds a layer of security to Sendmail, and provides mobile users who switch hosts the ability to use the same MTA without the need to reconfigure their mail client’s settings each time.</p>
</div>
<div class="paragraph">
<p>Install <a class="package" href="https://cgit.freebsd.org/ports/tree/security/cyrus-sasl2/">security/cyrus-sasl2</a> from the Ports Collection. This port supports a number of compile-time options. For the SMTP authentication method demonstrated in this example, make sure that <code>LOGIN</code> is not disabled.</p>
</div>
<div class="paragraph">
<p>After installing <a class="package" href="https://cgit.freebsd.org/ports/tree/security/cyrus-sasl2/">security/cyrus-sasl2</a>, edit <span class="filename">/usr/local/lib/sasl2/Sendmail.conf</span>, or create it if it does not exist, and add the following line:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>pwcheck_method: saslauthd</pre>
</div>
</div>
<div class="paragraph">
<p>Next, install <a class="package" href="https://cgit.freebsd.org/ports/tree/security/cyrus-sasl2-saslauthd/">security/cyrus-sasl2-saslauthd</a> and add execute the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysrc saslauthd_enable=&#34;YES&#34;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, start the saslauthd daemon:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># service saslauthd start</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This daemon serves as a broker for Sendmail to authenticate against the FreeBSD <a href="https://man.freebsd.org/cgi/man.cgi?query=passwd&amp;sektion=5&amp;format=html">passwd(5)</a> database. This saves the trouble of creating a new set of usernames and passwords for each user that needs to use SMTP authentication, and keeps the login and mail password the same.</p>
</div>
<div class="paragraph">
<p>Next, edit <span class="filename">/etc/make.conf</span> and add the following lines:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>SENDMAIL_CFLAGS=-I/usr/local/include/sasl -DSASL
SENDMAIL_LDADD=/usr/local/lib/libsasl2.so</pre>
</div>
</div>
<div class="paragraph">
<p>These lines provide Sendmail the proper configuration options for linking to <a class="package" href="https://cgit.freebsd.org/ports/tree/cyrus-sasl2/">cyrus-sasl2</a> at compile time. Make sure that <a class="package" href="https://cgit.freebsd.org/ports/tree/cyrus-sasl2/">cyrus-sasl2</a> has been installed before recompiling Sendmail.</p>
</div>
<div class="paragraph">
<p>Recompile Sendmail by executing the following commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># cd /usr/src/lib/libsmutil</span>
<span class="c"># make cleandir &amp;&amp; make obj &amp;&amp; make</span>
<span class="c"># cd /usr/src/lib/libsm</span>
<span class="c"># make cleandir &amp;&amp; make obj &amp;&amp; make</span>
<span class="c"># cd /usr/src/usr.sbin/sendmail</span>
<span class="c"># make cleandir &amp;&amp; make obj &amp;&amp; make &amp;&amp; make install</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This compile should not have any problems if <span class="filename">/usr/src</span> has not changed extensively and the shared libraries it needs are available.</p>
</div>
<div class="paragraph">
<p>After Sendmail has been compiled and reinstalled, edit <span class="filename">/etc/mail/freebsd.mc</span> or the local <span class="filename">.mc</span>. Many administrators choose to use the output from <a href="https://man.freebsd.org/cgi/man.cgi?query=hostname&amp;sektion=1&amp;format=html">hostname(1)</a> as the name of <span class="filename">.mc</span> for uniqueness.</p>
</div>
<div class="paragraph">
<p>Add these lines:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>dnl set SASL options
TRUST_AUTH_MECH(`GSSAPI DIGEST-MD5 CRAM-MD5 LOGIN&#39;)dnl
define(`confAUTH_MECHANISMS&#39;, `GSSAPI DIGEST-MD5 CRAM-MD5 LOGIN&#39;)dnl</pre>
</div>
</div>
<div class="paragraph">
<p>These options configure the different methods available to Sendmail for authenticating users. To use a method other than pwcheck, refer to the Sendmail documentation.</p>
</div>
<div class="paragraph">
<p>Finally, run <a href="https://man.freebsd.org/cgi/man.cgi?query=make&amp;sektion=1&amp;format=html">make(1)</a> while in <span class="filename">/etc/mail</span>. That will run the new <span class="filename">.mc</span> and create a <span class="filename">.cf</span> named either <span class="filename">freebsd.cf</span> or the name used for the local <span class="filename">.mc</span>.</p>
</div>
<div class="paragraph">
<p>Then, run <code>make install restart</code>, which will copy the file to <span class="filename">sendmail.cf</span>, and properly restart Sendmail.</p>
</div>
<div class="paragraph">
<p>For more information about this process, refer to <span class="filename">/etc/mail/Makefile</span>.</p>
</div>
<div class="paragraph">
<p>To test the configuration, use a MUA to send a test message. For further investigation, set the <code>LogLevel</code> of Sendmail to <code>13</code> and watch <span class="filename">/var/log/maillog</span> for any errors.</p>
</div>
<div class="paragraph">
<p>For more information, refer to <a href="http://www.sendmail.org/~ca/email/auth.html">SMTP authentication</a>.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="network-servers">Chapter 32. Network Servers<a class="anchor" href="#network-servers"></a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="network-servers-synopsis">32.1. Synopsis<a class="anchor" href="#network-servers-synopsis"></a></h3>
<div class="paragraph">
<p>This chapter covers some of the more frequently used network services on UNIX® systems. This includes installing, configuring, testing, and maintaining many different types of network services. Example configuration files are included throughout this chapter for reference.</p>
</div>
<div class="paragraph">
<p>By the end of this chapter, readers will know:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>How to manage the inetd daemon.</p>
</li>
<li>
<p>How to set up the Network File System (NFS).</p>
</li>
<li>
<p>How to set up the Network Information Server (NIS) for centralizing and sharing user accounts.</p>
</li>
<li>
<p>How to set FreeBSD up to act as an LDAP server or client</p>
</li>
<li>
<p>How to set up automatic network settings using DHCP.</p>
</li>
<li>
<p>How to set up a Domain Name Server (DNS).</p>
</li>
<li>
<p>How to set up the Apache HTTP Server.</p>
</li>
<li>
<p>How to set up a File Transfer Protocol (FTP) server.</p>
</li>
<li>
<p>How to set up a file and print server for Windows® clients using Samba.</p>
</li>
<li>
<p>How to synchronize the time and date, and set up a time server using the Network Time Protocol (NTP).</p>
</li>
<li>
<p>How to set up iSCSI.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This chapter assumes a basic knowledge of:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="filename">/etc/rc</span> scripts.</p>
</li>
<li>
<p>Network terminology.</p>
</li>
<li>
<p>Installation of additional third-party software (<a href="./#ports">Installing Applications: Packages and Ports</a>).</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="network-inetd">32.2. The inetd Super-Server<a class="anchor" href="#network-inetd"></a></h3>
<div class="paragraph">
<p>The <a href="https://man.freebsd.org/cgi/man.cgi?query=inetd&amp;sektion=8&amp;format=html">inetd(8)</a> daemon is sometimes referred to as a Super-Server because it manages connections for many services. Instead of starting multiple applications, only the inetd service needs to be started. When a connection is received for a service that is managed by inetd, it determines which program the connection is destined for, spawns a process for that program, and delegates the program a socket. Using inetd for services that are not heavily used can reduce system load, when compared to running each daemon individually in stand-alone mode.</p>
</div>
<div class="paragraph">
<p>Primarily, inetd is used to spawn other daemons, but several trivial protocols are handled internally, such as chargen, auth, time, echo, discard, and daytime.</p>
</div>
<div class="paragraph">
<p>This section covers the basics of configuring inetd.</p>
</div>
<div class="sect3">
<h4 id="network-inetd-conf">32.2.1. Configuration File<a class="anchor" href="#network-inetd-conf"></a></h4>
<div class="paragraph">
<p>Configuration of inetd is done by editing <span class="filename">/etc/inetd.conf</span>. Each line of this configuration file represents an application which can be started by inetd. By default, every line starts with a comment (<code>#</code>), meaning that inetd is not listening for any applications. To configure inetd to listen for an application’s connections, remove the <code>#</code> at the beginning of the line for that application.</p>
</div>
<div class="paragraph">
<p>After saving your edits, configure inetd to start at system boot by editing <span class="filename">/etc/rc.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>inetd_enable=&#34;YES&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>To start inetd now, so that it listens for the service you configured, type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># service inetd start</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Once inetd is started, it needs to be notified whenever a modification is made to <span class="filename">/etc/inetd.conf</span>:</p>
</div>
<div id="network-inetd-reread" class="exampleblock">
<div class="title">例 35. Reloading the inetd Configuration File</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># service inetd reload</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Typically, the default entry for an application does not need to be edited beyond removing the <code>#</code>. In some situations, it may be appropriate to edit the default entry.</p>
</div>
<div class="paragraph">
<p>As an example, this is the default entry for <a href="https://man.freebsd.org/cgi/man.cgi?query=ftpd&amp;sektion=8&amp;format=html">ftpd(8)</a> over IPv4:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>ftp     stream  tcp     nowait  root    /usr/libexec/ftpd       ftpd -l</pre>
</div>
</div>
<div class="paragraph">
<p>The seven columns in an entry are as follows:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>service-name
socket-type
protocol
{wait|nowait}[/max-child[/max-connections-per-ip-per-minute[/max-child-per-ip]]]
user[:group][/login-class]
server-program
server-program-arguments</pre>
</div>
</div>
<div class="paragraph">
<p>where:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">service-name</dt>
<dd>
<p>The service name of the daemon to start. It must correspond to a service listed in <span class="filename">/etc/services</span>. This determines which port inetd listens on for incoming connections to that service. When using a custom service, it must first be added to <span class="filename">/etc/services</span>.</p>
</dd>
<dt class="hdlist1">socket-type</dt>
<dd>
<p>Either <code>stream</code>, <code>dgram</code>, <code>raw</code>, or <code>seqpacket</code>. Use <code>stream</code> for TCP connections and <code>dgram</code> for UDP services.</p>
</dd>
<dt class="hdlist1">protocol</dt>
<dd>
<p>Use one of the following protocol names:</p>
<table class="tableblock frame-none grid-all stretch informaltable">
<colgroup>
<col style="width: 50%;"/>
<col style="width: 50%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Protocol Name</th>
<th class="tableblock halign-left valign-top">Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">tcp or tcp4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TCP IPv4</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">udp or udp4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">UDP IPv4</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">tcp6</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TCP IPv6</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">udp6</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">UDP IPv6</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">tcp46</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Both TCP IPv4 and IPv6</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">udp46</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Both UDP IPv4 and IPv6</p></td>
</tr>
</tbody>
</table>
</dd>
<dt class="hdlist1">{wait|nowait}[/max-child[/max-connections-per-ip-per-minute[/max-child-per-ip]]]</dt>
<dd>
<p>In this field, <code>wait</code> or <code>nowait</code> must be specified. <code>max-child</code>, <code>max-connections-per-ip-per-minute</code> and <code>max-child-per-ip</code> are optional.</p>
<div class="paragraph">
<p><code>wait|nowait</code> indicates whether or not the service is able to handle its own socket. <code>dgram</code> socket types must use <code>wait</code> while <code>stream</code> daemons, which are usually multi-threaded, should use <code>nowait</code>. <code>wait</code> usually hands off multiple sockets to a single daemon, while <code>nowait</code> spawns a child daemon for each new socket.</p>
</div>
<div class="paragraph">
<p>The maximum number of child daemons inetd may spawn is set by <code>max-child</code>. For example, to limit ten instances of the daemon, place a <code>/10</code> after <code>nowait</code>. Specifying <code>/0</code> allows an unlimited number of children.</p>
</div>
<div class="paragraph">
<p><code>max-connections-per-ip-per-minute</code> limits the number of connections from any particular IP address per minute. Once the limit is reached, further connections from this IP address will be dropped until the end of the minute. For example, a value of <code>/10</code> would limit any particular IP address to ten connection attempts per minute. <code>max-child-per-ip</code> limits the number of child processes that can be started on behalf on any single IP address at any moment. These options can limit excessive resource consumption and help to prevent Denial of Service attacks.</p>
</div>
<div class="paragraph">
<p>An example can be seen in the default settings for <a href="https://man.freebsd.org/cgi/man.cgi?query=fingerd&amp;sektion=8&amp;format=html">fingerd(8)</a>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>finger stream  tcp     nowait/3/10 nobody /usr/libexec/fingerd fingerd -k -s</pre>
</div>
</div>
</dd>
<dt class="hdlist1">user</dt>
<dd>
<p>The username the daemon will run as. Daemons typically run as <code>root</code>, <code>daemon</code>, or <code>nobody</code>.</p>
</dd>
<dt class="hdlist1">server-program</dt>
<dd>
<p>The full path to the daemon. If the daemon is a service provided by inetd internally, use <code>internal</code>.</p>
</dd>
<dt class="hdlist1">server-program-arguments</dt>
<dd>
<p>Used to specify any command arguments to be passed to the daemon on invocation. If the daemon is an internal service, use <code>internal</code>.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="network-inetd-cmdline">32.2.2. Command-Line Options<a class="anchor" href="#network-inetd-cmdline"></a></h4>
<div class="paragraph">
<p>Like most server daemons, inetd has a number of options that can be used to modify its behavior. By default, inetd is started with <code>-wW -C 60</code>. These options enable TCP wrappers for all services, including internal services, and prevent any IP address from requesting any service more than 60 times per minute.</p>
</div>
<div class="paragraph">
<p>To change the default options which are passed to inetd, add an entry for <code>inetd_flags</code> in <span class="filename">/etc/rc.conf</span>. If inetd is already running, restart it with <code>service inetd restart</code>.</p>
</div>
<div class="paragraph">
<p>The available rate limiting options are:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">-c maximum</dt>
<dd>
<p>Specify the default maximum number of simultaneous invocations of each service, where the default is unlimited. May be overridden on a per-service basis by using <code>max-child</code> in <span class="filename">/etc/inetd.conf</span>.</p>
</dd>
<dt class="hdlist1">-C rate</dt>
<dd>
<p>Specify the default maximum number of times a service can be invoked from a single IP address per minute. May be overridden on a per-service basis by using <code>max-connections-per-ip-per-minute</code> in <span class="filename">/etc/inetd.conf</span>.</p>
</dd>
<dt class="hdlist1">-R rate</dt>
<dd>
<p>Specify the maximum number of times a service can be invoked in one minute, where the default is <code>256</code>. A rate of <code>0</code> allows an unlimited number.</p>
</dd>
<dt class="hdlist1">-s maximum</dt>
<dd>
<p>Specify the maximum number of times a service can be invoked from a single IP address at any one time, where the default is unlimited. May be overridden on a per-service basis by using <code>max-child-per-ip</code> in <span class="filename">/etc/inetd.conf</span>.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Additional options are available. Refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=inetd&amp;sektion=8&amp;format=html">inetd(8)</a> for the full list of options.</p>
</div>
</div>
<div class="sect3">
<h4 id="network-inetd-security">32.2.3. Security Considerations<a class="anchor" href="#network-inetd-security"></a></h4>
<div class="paragraph">
<p>Many of the daemons which can be managed by inetd are not security-conscious. Some daemons, such as fingerd, can provide information that may be useful to an attacker. Only enable the services which are needed and monitor the system for excessive connection attempts. <code>max-connections-per-ip-per-minute</code>, <code>max-child</code> and <code>max-child-per-ip</code> can be used to limit such attacks.</p>
</div>
<div class="paragraph">
<p>By default, TCP wrappers are enabled. Consult <a href="https://man.freebsd.org/cgi/man.cgi?query=hosts_access&amp;sektion=5&amp;format=html">hosts_access(5)</a> for more information on placing TCP restrictions on various inetd invoked daemons.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="network-nfs">32.3. Network File System (NFS)<a class="anchor" href="#network-nfs"></a></h3>
<div class="paragraph">
<p>FreeBSD supports the Network File System (NFS), which allows a server to share directories and files with clients over a network. With NFS, users and programs can access files on remote systems as if they were stored locally.</p>
</div>
<div class="paragraph">
<p>NFS has many practical uses. Some of the more common uses include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Data that would otherwise be duplicated on each client can be kept in a single location and accessed by clients on the network.</p>
</li>
<li>
<p>Several clients may need access to the <span class="filename">/usr/ports/distfiles</span> directory. Sharing that directory allows for quick access to the source files without having to download them to each client.</p>
</li>
<li>
<p>On large networks, it is often more convenient to configure a central NFS server on which all user home directories are stored. Users can log into a client anywhere on the network and have access to their home directories.</p>
</li>
<li>
<p>Administration of NFS exports is simplified. For example, there is only one file system where security or backup policies must be set.</p>
</li>
<li>
<p>Removable media storage devices can be used by other machines on the network. This reduces the number of devices throughout the network and provides a centralized location to manage their security. It is often more convenient to install software on multiple machines from a centralized installation media.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>NFS consists of a server and one or more clients. The client remotely accesses the data that is stored on the server machine. In order for this to function properly, a few processes have to be configured and running.</p>
</div>
<div class="paragraph">
<p>These daemons must be running on the server:</p>
</div>
<table class="tableblock frame-none grid-all stretch informaltable">
<colgroup>
<col style="width: 50%;"/>
<col style="width: 50%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Daemon</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">nfsd</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The NFS daemon which services requests from NFS clients.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">mountd</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The NFS mount daemon which carries out requests received from nfsd.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">rpcbind</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This daemon allows NFS clients to discover which port the NFS server is using.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Running <a href="https://man.freebsd.org/cgi/man.cgi?query=nfsiod&amp;sektion=8&amp;format=html">nfsiod(8)</a> on the client can improve performance, but is not required.</p>
</div>
<div class="sect3">
<h4 id="network-configuring-nfs">32.3.1. Configuring the Server<a class="anchor" href="#network-configuring-nfs"></a></h4>
<div class="paragraph">
<p>The file systems which the NFS server will share are specified in <span class="filename">/etc/exports</span>. Each line in this file specifies a file system to be exported, which clients have access to that file system, and any access options. When adding entries to this file, each exported file system, its properties, and allowed hosts must occur on a single line. If no clients are listed in the entry, then any client on the network can mount that file system.</p>
</div>
<div class="paragraph">
<p>The following <span class="filename">/etc/exports</span> entries demonstrate how to export file systems. The examples can be modified to match the file systems and client names on the reader’s network. There are many options that can be used in this file, but only a few will be mentioned here. See <a href="https://man.freebsd.org/cgi/man.cgi?query=exports&amp;sektion=5&amp;format=html">exports(5)</a> for the full list of options.</p>
</div>
<div class="paragraph">
<p>This example shows how to export <span class="filename">/cdrom</span> to three hosts named <em>alpha</em>, <em>bravo</em>, and <em>charlie</em>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>/cdrom -ro alpha bravo charlie</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>-ro</code> flag makes the file system read-only, preventing clients from making any changes to the exported file system. This example assumes that the host names are either in DNS or in <span class="filename">/etc/hosts</span>. Refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=hosts&amp;sektion=5&amp;format=html">hosts(5)</a> if the network does not have a DNS server.</p>
</div>
<div class="paragraph">
<p>The next example exports <span class="filename">/home</span> to three clients by IP address. This can be useful for networks without DNS or <span class="filename">/etc/hosts</span> entries. The <code>-alldirs</code> flag allows subdirectories to be mount points. In other words, it will not automatically mount the subdirectories, but will permit the client to mount the directories that are required as needed.</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>/usr/home  -alldirs  10.0.0.2 10.0.0.3 10.0.0.4</pre>
</div>
</div>
<div class="paragraph">
<p>This next example exports <span class="filename">/a</span> so that two clients from different domains may access that file system. The <code>-maproot=root</code> allows <code>root</code> on the remote system to write data on the exported file system as <code>root</code>. If <code>-maproot=root</code> is not specified, the client’s <code>root</code> user will be mapped to the server’s <code>nobody</code> account and will be subject to the access limitations defined for <code>nobody</code>.</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>/a  -maproot=root  host.example.com box.example.org</pre>
</div>
</div>
<div class="paragraph">
<p>A client can only be specified once per file system. For example, if <span class="filename">/usr</span> is a single file system, these entries would be invalid as both entries specify the same host:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre># Invalid when /usr is one file system
/usr/src   client
/usr/ports client</pre>
</div>
</div>
<div class="paragraph">
<p>The correct format for this situation is to use one entry:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>/usr/src /usr/ports  client</pre>
</div>
</div>
<div class="paragraph">
<p>The following is an example of a valid export list, where <span class="filename">/usr</span> and <span class="filename">/exports</span> are local file systems:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre># Export src and ports to client01 and client02, but only
# client01 has root privileges on it
/usr/src /usr/ports -maproot=root    client01
/usr/src /usr/ports               client02
# The client machines have root and can mount anywhere
# on /exports. Anyone in the world can mount /exports/obj read-only
/exports -alldirs -maproot=root      client01 client02
/exports/obj -ro</pre>
</div>
</div>
<div class="paragraph">
<p>To enable the processes required by the NFS server at boot time, add these options to <span class="filename">/etc/rc.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>rpcbind_enable=&#34;YES&#34;
nfs_server_enable=&#34;YES&#34;
mountd_enable=&#34;YES&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>The server can be started now by running this command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># service nfsd start</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Whenever the NFS server is started, mountd also starts automatically. However, mountd only reads <span class="filename">/etc/exports</span> when it is started. To make subsequent <span class="filename">/etc/exports</span> edits take effect immediately, force mountd to reread it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># service mountd reload</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=nfsv4&amp;sektion=4&amp;format=html">nfsv4(4)</a> for a description of an NFS Version 4 setup.</p>
</div>
</div>
<div class="sect3">
<h4 id="_configuring_the_client">32.3.2. Configuring the Client<a class="anchor" href="#_configuring_the_client"></a></h4>
<div class="paragraph">
<p>To enable NFS clients, set this option in each client’s <span class="filename">/etc/rc.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>nfs_client_enable=&#34;YES&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>Then, run this command on each NFS client:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># service nfsclient start</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The client now has everything it needs to mount a remote file system. In these examples, the server’s name is <code>server</code> and the client’s name is <code>client</code>. To mount <span class="filename">/home</span> on <code>server</code> to the <span class="filename">/mnt</span> mount point on <code>client</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># mount server:/home /mnt</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The files and directories in <span class="filename">/home</span> will now be available on <code>client</code>, in the <span class="filename">/mnt</span> directory.</p>
</div>
<div class="paragraph">
<p>To mount a remote file system each time the client boots, add it to <span class="filename">/etc/fstab</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>server:/home	/mnt	nfs	rw	0	0</pre>
</div>
</div>
<div class="paragraph">
<p>Refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=fstab&amp;sektion=5&amp;format=html">fstab(5)</a> for a description of all available options.</p>
</div>
</div>
<div class="sect3">
<h4 id="_locking">32.3.3. Locking<a class="anchor" href="#_locking"></a></h4>
<div class="paragraph">
<p>Some applications require file locking to operate correctly. To enable locking, execute the following command on both the client and server:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysrc rpc_lockd_enable=&#34;YES&#34;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then start the service:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># service lockd start</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If locking is not required on the server, the NFS client can be configured to lock locally by including <code>-L</code> when running mount. Refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=mount_nfs&amp;sektion=8&amp;format=html">mount_nfs(8)</a> for further details.</p>
</div>
</div>
<div class="sect3">
<h4 id="network-autofs">32.3.4. Automating Mounts with <a href="https://man.freebsd.org/cgi/man.cgi?query=autofs&amp;sektion=5&amp;format=html">autofs(5)</a><a class="anchor" href="#network-autofs"></a></h4>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <a href="https://man.freebsd.org/cgi/man.cgi?query=autofs&amp;sektion=5&amp;format=html">autofs(5)</a> automount facility is supported starting with FreeBSD 10.1-RELEASE. To use the automounter functionality in older versions of FreeBSD, use <a href="https://man.freebsd.org/cgi/man.cgi?query=amd&amp;sektion=8&amp;format=html">amd(8)</a> instead. This chapter only describes the <a href="https://man.freebsd.org/cgi/man.cgi?query=autofs&amp;sektion=5&amp;format=html">autofs(5)</a> automounter.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>The <a href="https://man.freebsd.org/cgi/man.cgi?query=autofs&amp;sektion=5&amp;format=html">autofs(5)</a> facility is a common name for several components that, together, allow for automatic mounting of remote and local filesystems whenever a file or directory within that file system is accessed. It consists of the kernel component, <a href="https://man.freebsd.org/cgi/man.cgi?query=autofs&amp;sektion=5&amp;format=html">autofs(5)</a>, and several userspace applications: <a href="https://man.freebsd.org/cgi/man.cgi?query=automount&amp;sektion=8&amp;format=html">automount(8)</a>, <a href="https://man.freebsd.org/cgi/man.cgi?query=automountd&amp;sektion=8&amp;format=html">automountd(8)</a> and <a href="https://man.freebsd.org/cgi/man.cgi?query=autounmountd&amp;sektion=8&amp;format=html">autounmountd(8)</a>. It serves as an alternative for <a href="https://man.freebsd.org/cgi/man.cgi?query=amd&amp;sektion=8&amp;format=html">amd(8)</a> from previous FreeBSD releases. amd is still provided for backward compatibility purposes, as the two use different map formats; the one used by autofs is the same as with other SVR4 automounters, such as the ones in Solaris, MacOS X, and Linux.</p>
</div>
<div class="paragraph">
<p>The <a href="https://man.freebsd.org/cgi/man.cgi?query=autofs&amp;sektion=5&amp;format=html">autofs(5)</a> virtual filesystem is mounted on specified mountpoints by <a href="https://man.freebsd.org/cgi/man.cgi?query=automount&amp;sektion=8&amp;format=html">automount(8)</a>, usually invoked during boot.</p>
</div>
<div class="paragraph">
<p>Whenever a process attempts to access a file within the <a href="https://man.freebsd.org/cgi/man.cgi?query=autofs&amp;sektion=5&amp;format=html">autofs(5)</a> mountpoint, the kernel will notify <a href="https://man.freebsd.org/cgi/man.cgi?query=automountd&amp;sektion=8&amp;format=html">automountd(8)</a> daemon and pause the triggering process. The <a href="https://man.freebsd.org/cgi/man.cgi?query=automountd&amp;sektion=8&amp;format=html">automountd(8)</a> daemon will handle kernel requests by finding the proper map and mounting the filesystem according to it, then signal the kernel to release blocked process. The <a href="https://man.freebsd.org/cgi/man.cgi?query=autounmountd&amp;sektion=8&amp;format=html">autounmountd(8)</a> daemon automatically unmounts automounted filesystems after some time, unless they are still being used.</p>
</div>
<div class="paragraph">
<p>The primary autofs configuration file is <span class="filename">/etc/auto_master</span>. It assigns individual maps to top-level mounts. For an explanation of <span class="filename">auto_master</span> and the map syntax, refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=auto_master&amp;sektion=5&amp;format=html">auto_master(5)</a>.</p>
</div>
<div class="paragraph">
<p>There is a special automounter map mounted on <span class="filename">/net</span>. When a file is accessed within this directory, <a href="https://man.freebsd.org/cgi/man.cgi?query=autofs&amp;sektion=5&amp;format=html">autofs(5)</a> looks up the corresponding remote mount and automatically mounts it. For instance, an attempt to access a file within <span class="filename">/net/foobar/usr</span> would tell <a href="https://man.freebsd.org/cgi/man.cgi?query=automountd&amp;sektion=8&amp;format=html">automountd(8)</a> to mount the <span class="filename">/usr</span> export from the host <code>foobar</code>.</p>
</div>
<div class="exampleblock">
<div class="title">例 36. Mounting an Export with <a href="https://man.freebsd.org/cgi/man.cgi?query=autofs&amp;sektion=5&amp;format=html">autofs(5)</a></div>
<div class="content">
<div class="paragraph">
<p>In this example, <code>showmount -e</code> shows the exported file systems that can be mounted from the NFS server, <code>foobar</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>showmount -e foobar
Exports list on foobar:
/usr                               10.10.10.0
/a                                 10.10.10.0
<span class="gp">% </span><span class="nb">cd</span> /net/foobar/usr</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The output from <code>showmount</code> shows <span class="filename">/usr</span> as an export. When changing directories to <span class="filename">/host/foobar/usr</span>, <a href="https://man.freebsd.org/cgi/man.cgi?query=automountd&amp;sektion=8&amp;format=html">automountd(8)</a> intercepts the request and attempts to resolve the hostname <code>foobar</code>. If successful, <a href="https://man.freebsd.org/cgi/man.cgi?query=automountd&amp;sektion=8&amp;format=html">automountd(8)</a> automatically mounts the source export.</p>
</div>
<div class="paragraph">
<p>To enable <a href="https://man.freebsd.org/cgi/man.cgi?query=autofs&amp;sektion=5&amp;format=html">autofs(5)</a> at boot time, add this line to <span class="filename">/etc/rc.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>autofs_enable=&#34;YES&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>Then <a href="https://man.freebsd.org/cgi/man.cgi?query=autofs&amp;sektion=5&amp;format=html">autofs(5)</a> can be started by running:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># service automount start</span>
<span class="c"># service automountd start</span>
<span class="c"># service autounmountd start</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <a href="https://man.freebsd.org/cgi/man.cgi?query=autofs&amp;sektion=5&amp;format=html">autofs(5)</a> map format is the same as in other operating systems. Information about this format from other sources can be useful, like the <a href="http://web.archive.org/web/20160813071113/http://images.apple.com/business/docs/Autofs.pdf">Mac OS X document</a>.</p>
</div>
<div class="paragraph">
<p>Consult the <a href="https://man.freebsd.org/cgi/man.cgi?query=automount&amp;sektion=8&amp;format=html">automount(8)</a>, <a href="https://man.freebsd.org/cgi/man.cgi?query=automountd&amp;sektion=8&amp;format=html">automountd(8)</a>, <a href="https://man.freebsd.org/cgi/man.cgi?query=autounmountd&amp;sektion=8&amp;format=html">autounmountd(8)</a>, and <a href="https://man.freebsd.org/cgi/man.cgi?query=auto_master&amp;sektion=5&amp;format=html">auto_master(5)</a> manual pages for more information.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="network-nis">32.4. Network Information System (NIS)<a class="anchor" href="#network-nis"></a></h3>
<div class="paragraph">
<p>Network Information System (NIS) is designed to centralize administration of UNIX®-like systems such as Solaris™, HP-UX, AIX®, Linux, NetBSD, OpenBSD, and FreeBSD. NIS was originally known as Yellow Pages but the name was changed due to trademark issues. This is the reason why NIS commands begin with <code>yp</code>.</p>
</div>
<div class="paragraph">
<p>NIS is a Remote Procedure Call (RPC)-based client/server system that allows a group of machines within an NIS domain to share a common set of configuration files. This permits a system administrator to set up NIS client systems with only minimal configuration data and to add, remove, or modify configuration data from a single location.</p>
</div>
<div class="paragraph">
<p>FreeBSD uses version 2 of the NIS protocol.</p>
</div>
<div class="sect3">
<h4 id="_nis_terms_and_processes">32.4.1. NIS Terms and Processes<a class="anchor" href="#_nis_terms_and_processes"></a></h4>
<div class="paragraph">
<p>Table 28.1 summarizes the terms and important processes used by NIS:</p>
</div>
<table class="tableblock frame-none grid-all stretch">
<caption class="title">表 42. NIS Terminology</caption>
<colgroup>
<col style="width: 50%;"/>
<col style="width: 50%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Term</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">NIS domain name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NIS servers and clients share an NIS domain name. Typically, this name does not have anything to do with DNS.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://man.freebsd.org/cgi/man.cgi?query=rpcbind&amp;sektion=8&amp;format=html">rpcbind(8)</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This service enables RPC and must be running in order to run an NIS server or act as an NIS client.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://man.freebsd.org/cgi/man.cgi?query=ypbind&amp;sektion=8&amp;format=html">ypbind(8)</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This service binds an NIS client to its NIS server. It will take the NIS domain name and use RPC to connect to the server. It is the core of client/server communication in an NIS environment. If this service is not running on a client machine, it will not be able to access the NIS server.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://man.freebsd.org/cgi/man.cgi?query=ypserv&amp;sektion=8&amp;format=html">ypserv(8)</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This is the process for the NIS server. If this service stops running, the server will no longer be able to respond to NIS requests so hopefully, there is a slave server to take over. Some non-FreeBSD clients will not try to reconnect using a slave server and the ypbind process may need to be restarted on these clients.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://man.freebsd.org/cgi/man.cgi?query=rpc.yppasswdd&amp;sektion=8&amp;format=html">rpc.yppasswdd(8)</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This process only runs on NIS master servers. This daemon allows NIS clients to change their NIS passwords. If this daemon is not running, users will have to login to the NIS master server and change their passwords there.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_machine_types">32.4.2. Machine Types<a class="anchor" href="#_machine_types"></a></h4>
<div class="paragraph">
<p>There are three types of hosts in an NIS environment:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>NIS master server</p>
<div class="paragraph">
<p>This server acts as a central repository for host configuration information and maintains the authoritative copy of the files used by all of the NIS clients. The <span class="filename">passwd</span>, <span class="filename">group</span>, and other various files used by NIS clients are stored on the master server. While it is possible for one machine to be an NIS master server for more than one NIS domain, this type of configuration will not be covered in this chapter as it assumes a relatively small-scale NIS environment.</p>
</div>
</li>
<li>
<p>NIS slave servers</p>
<div class="paragraph">
<p>NIS slave servers maintain copies of the NIS master’s data files in order to provide redundancy. Slave servers also help to balance the load of the master server as NIS clients always attach to the NIS server which responds first.</p>
</div>
</li>
<li>
<p>NIS clients</p>
<div class="paragraph">
<p>NIS clients authenticate against the NIS server during log on.</p>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Information in many files can be shared using NIS. The <span class="filename">master.passwd</span>, <span class="filename">group</span>, and <span class="filename">hosts</span> files are commonly shared via NIS. Whenever a process on a client needs information that would normally be found in these files locally, it makes a query to the NIS server that it is bound to instead.</p>
</div>
</div>
<div class="sect3">
<h4 id="_planning_considerations">32.4.3. Planning Considerations<a class="anchor" href="#_planning_considerations"></a></h4>
<div class="paragraph">
<p>This section describes a sample NIS environment which consists of 15 FreeBSD machines with no centralized point of administration. Each machine has its own <span class="filename">/etc/passwd</span> and <span class="filename">/etc/master.passwd</span>. These files are kept in sync with each other only through manual intervention. Currently, when a user is added to the lab, the process must be repeated on all 15 machines.</p>
</div>
<div class="paragraph">
<p>The configuration of the lab will be as follows:</p>
</div>
<table class="tableblock frame-none grid-all stretch informaltable">
<colgroup>
<col style="width: 33.3333%;"/>
<col style="width: 33.3333%;"/>
<col style="width: 33.3334%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Machine name</th>
<th class="tableblock halign-left valign-top">IP address</th>
<th class="tableblock halign-left valign-top">Machine role</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ellington</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>10.0.0.2</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NIS master</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>coltrane</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>10.0.0.3</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NIS slave</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>basie</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>10.0.0.4</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Faculty workstation</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>bird</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>10.0.0.5</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Client machine</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>cli[1-11]</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>10.0.0.[6-17]</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Other client machines</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>If this is the first time an NIS scheme is being developed, it should be thoroughly planned ahead of time. Regardless of network size, several decisions need to be made as part of the planning process.</p>
</div>
<div class="sect4">
<h5 id="_choosing_a_nis_domain_name">32.4.3.1. Choosing a NIS Domain Name<a class="anchor" href="#_choosing_a_nis_domain_name"></a></h5>
<div class="paragraph">
<p>When a client broadcasts its requests for info, it includes the name of the NIS domain that it is part of. This is how multiple servers on one network can tell which server should answer which request. Think of the NIS domain name as the name for a group of hosts.</p>
</div>
<div class="paragraph">
<p>Some organizations choose to use their Internet domain name for their NIS domain name. This is not recommended as it can cause confusion when trying to debug network problems. The NIS domain name should be unique within the network and it is helpful if it describes the group of machines it represents. For example, the Art department at Acme Inc. might be in the &#34;acme-art&#34; NIS domain. This example will use the domain name <code>test-domain</code>.</p>
</div>
<div class="paragraph">
<p>However, some non-FreeBSD operating systems require the NIS domain name to be the same as the Internet domain name. If one or more machines on the network have this restriction, the Internet domain name <em>must</em> be used as the NIS domain name.</p>
</div>
</div>
<div class="sect4">
<h5 id="_physical_server_requirements">32.4.3.2. Physical Server Requirements<a class="anchor" href="#_physical_server_requirements"></a></h5>
<div class="paragraph">
<p>There are several things to keep in mind when choosing a machine to use as a NIS server. Since NIS clients depend upon the availability of the server, choose a machine that is not rebooted frequently. The NIS server should ideally be a stand alone machine whose sole purpose is to be an NIS server. If the network is not heavily used, it is acceptable to put the NIS server on a machine running other services. However, if the NIS server becomes unavailable, it will adversely affect all NIS clients.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_configuring_the_nis_master_server">32.4.4. Configuring the NIS Master Server<a class="anchor" href="#_configuring_the_nis_master_server"></a></h4>
<div class="paragraph">
<p>The canonical copies of all NIS files are stored on the master server. The databases used to store the information are called NIS maps. In FreeBSD, these maps are stored in <span class="filename">/var/yp/[domainname]</span> where <span class="filename">[domainname]</span> is the name of the NIS domain. Since multiple domains are supported, it is possible to have several directories, one for each domain. Each domain will have its own independent set of maps.</p>
</div>
<div class="paragraph">
<p>NIS master and slave servers handle all NIS requests through <a href="https://man.freebsd.org/cgi/man.cgi?query=ypserv&amp;sektion=8&amp;format=html">ypserv(8)</a>. This daemon is responsible for receiving incoming requests from NIS clients, translating the requested domain and map name to a path to the corresponding database file, and transmitting data from the database back to the client.</p>
</div>
<div class="paragraph">
<p>Setting up a master NIS server can be relatively straight forward, depending on environmental needs. Since FreeBSD provides built-in NIS support, it only needs to be enabled by adding the following lines to <span class="filename">/etc/rc.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>nisdomainname=&#34;test-domain&#34;	<i class="conum" data-value="1"></i><b>(1)</b>
nis_server_enable=&#34;YES&#34;		<i class="conum" data-value="2"></i><b>(2)</b>
nis_yppasswdd_enable=&#34;YES&#34;	<i class="conum" data-value="3"></i><b>(3)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This line sets the NIS domain name to <code>test-domain</code>. &lt;.&gt; This automates the start up of the NIS server processes when the system boots. &lt;.&gt; This enables the <a href="https://man.freebsd.org/cgi/man.cgi?query=rpc.yppasswdd&amp;sektion=8&amp;format=html">rpc.yppasswdd(8)</a> daemon so that users can change their NIS password from a client machine.</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Care must be taken in a multi-server domain where the server machines are also NIS clients. It is generally a good idea to force the servers to bind to themselves rather than allowing them to broadcast bind requests and possibly become bound to each other. Strange failure modes can result if one server goes down and others are dependent upon it. Eventually, all the clients will time out and attempt to bind to other servers, but the delay involved can be considerable and the failure mode is still present since the servers might bind to each other all over again.</p>
</div>
<div class="paragraph">
<p>A server that is also a client can be forced to bind to a particular server by adding these additional lines to <span class="filename">/etc/rc.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>nis_client_enable=&#34;YES&#34;				<i class="conum" data-value="1"></i><b>(1)</b>
nis_client_flags=&#34;-S test-domain,server&#34;	<i class="conum" data-value="2"></i><b>(2)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This enables running client stuff as well. &lt;.&gt; This line sets the NIS domain name to <code>test-domain</code> and bind to itself.</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>After saving the edits, type <code>/etc/netstart</code> to restart the network and apply the values defined in <span class="filename">/etc/rc.conf</span>. Before initializing the NIS maps, start <a href="https://man.freebsd.org/cgi/man.cgi?query=ypserv&amp;sektion=8&amp;format=html">ypserv(8)</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># service ypserv start</span></code></pre>
</div>
</div>
<div class="sect4">
<h5 id="_initializing_the_nis_maps">32.4.4.1. Initializing the NIS Maps<a class="anchor" href="#_initializing_the_nis_maps"></a></h5>
<div class="paragraph">
<p>NIS maps are generated from the configuration files in <span class="filename">/etc</span> on the NIS master, with one exception: <span class="filename">/etc/master.passwd</span>. This is to prevent the propagation of passwords to all the servers in the NIS domain. Therefore, before the NIS maps are initialized, configure the primary password files:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># cp /etc/master.passwd /var/yp/master.passwd</span>
<span class="c"># cd /var/yp</span>
<span class="c"># vi master.passwd</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>It is advisable to remove all entries for system accounts as well as any user accounts that do not need to be propagated to the NIS clients, such as the <code>root</code> and any other administrative accounts.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Ensure that the <span class="filename">/var/yp/master.passwd</span> is neither group or world readable by setting its permissions to <code>600</code>.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>After completing this task, initialize the NIS maps. FreeBSD includes the <a href="https://man.freebsd.org/cgi/man.cgi?query=ypinit&amp;sektion=8&amp;format=html">ypinit(8)</a> script to do this. When generating maps for the master server, include <code>-m</code> and specify the NIS domain name:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">ellington# </span>ypinit -m <span class="nb">test</span>-domain
Server Type: MASTER Domain: <span class="nb">test</span>-domain
Creating an YP server will require that you answer a few questions.
Questions will all be asked at the beginning of the procedure.
Do you want this procedure to quit on non-fatal errors? <span class="o">[</span>y/n: n] n
Ok, please remember to go back and redo manually whatever fails.
If not, something might not work.
At this point, we have to construct a list of this domains YP servers.
rod.darktech.org is already known as master server.
Please <span class="k">continue </span>to add any slave servers, one per line. When you are
<span class="k">done </span>with the list, <span class="nb">type </span>a &lt;control D&gt;.
master server   :  ellington
next host to add:  coltrane
next host to add:  ^D
The current list of NIS servers looks like this:
ellington
coltrane
Is this correct?  <span class="o">[</span>y/n: y] y

<span class="o">[</span>..output from map generation..]

NIS Map update completed.
ellington has been setup as an YP master server without any errors.</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will create <span class="filename">/var/yp/Makefile</span> from <span class="filename">/var/yp/Makefile.dist</span>. By default, this file assumes that the environment has a single NIS server with only FreeBSD clients. Since <code>test-domain</code> has a slave server, edit this line in <span class="filename">/var/yp/Makefile</span> so that it begins with a comment (<code>#</code>):</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>NOPUSH = &#34;True&#34;</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_adding_new_users">32.4.4.2. Adding New Users<a class="anchor" href="#_adding_new_users"></a></h5>
<div class="paragraph">
<p>Every time a new user is created, the user account must be added to the master NIS server and the NIS maps rebuilt. Until this occurs, the new user will not be able to login anywhere except on the NIS master. For example, to add the new user <code>jsmith</code> to the <code>test-domain</code> domain, run these commands on the master server:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pw useradd jsmith</span>
<span class="c"># cd /var/yp</span>
<span class="c"># make test-domain</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The user could also be added using <code>adduser jsmith</code> instead of <code>pw useradd smith</code>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_setting_up_a_nis_slave_server">32.4.5. Setting up a NIS Slave Server<a class="anchor" href="#_setting_up_a_nis_slave_server"></a></h4>
<div class="paragraph">
<p>To set up an NIS slave server, log on to the slave server and edit <span class="filename">/etc/rc.conf</span> as for the master server. Do not generate any NIS maps, as these already exist on the master server. When running <code>ypinit</code> on the slave server, use <code>-s</code> (for slave) instead of <code>-m</code> (for master). This option requires the name of the NIS master in addition to the domain name, as seen in this example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">coltrane# </span>ypinit -s ellington <span class="nb">test</span>-domain

Server Type: SLAVE Domain: <span class="nb">test</span>-domain Master: ellington

Creating an YP server will require that you answer a few questions.
Questions will all be asked at the beginning of the procedure.

Do you want this procedure to quit on non-fatal errors? <span class="o">[</span>y/n: n]  n

Ok, please remember to go back and redo manually whatever fails.
If not, something might not work.
There will be no further questions. The remainder of the procedure
should take a few minutes, to copy the databases from ellington.
Transferring netgroup...
ypxfr: Exiting: Map successfully transferred
Transferring netgroup.byuser...
ypxfr: Exiting: Map successfully transferred
Transferring netgroup.byhost...
ypxfr: Exiting: Map successfully transferred
Transferring master.passwd.byuid...
ypxfr: Exiting: Map successfully transferred
Transferring passwd.byuid...
ypxfr: Exiting: Map successfully transferred
Transferring passwd.byname...
ypxfr: Exiting: Map successfully transferred
Transferring group.bygid...
ypxfr: Exiting: Map successfully transferred
Transferring group.byname...
ypxfr: Exiting: Map successfully transferred
Transferring services.byname...
ypxfr: Exiting: Map successfully transferred
Transferring rpc.bynumber...
ypxfr: Exiting: Map successfully transferred
Transferring rpc.byname...
ypxfr: Exiting: Map successfully transferred
Transferring protocols.byname...
ypxfr: Exiting: Map successfully transferred
Transferring master.passwd.byname...
ypxfr: Exiting: Map successfully transferred
Transferring networks.byname...
ypxfr: Exiting: Map successfully transferred
Transferring networks.byaddr...
ypxfr: Exiting: Map successfully transferred
Transferring netid.byname...
ypxfr: Exiting: Map successfully transferred
Transferring hosts.byaddr...
ypxfr: Exiting: Map successfully transferred
Transferring protocols.bynumber...
ypxfr: Exiting: Map successfully transferred
Transferring ypservers...
ypxfr: Exiting: Map successfully transferred
Transferring hosts.byname...
ypxfr: Exiting: Map successfully transferred

coltrane has been setup as an YP slave server without any errors.
Remember to update map ypservers on ellington.</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will generate a directory on the slave server called <span class="filename">/var/yp/test-domain</span> which contains copies of the NIS master server’s maps. Adding these <span class="filename">/etc/crontab</span> entries on each slave server will force the slaves to sync their maps with the maps on the master server:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>20      *       *       *       *       root   /usr/libexec/ypxfr passwd.byname
21      *       *       *       *       root   /usr/libexec/ypxfr passwd.byuid</pre>
</div>
</div>
<div class="paragraph">
<p>These entries are not mandatory because the master server automatically attempts to push any map changes to its slaves. However, since clients may depend upon the slave server to provide correct password information, it is recommended to force frequent password map updates. This is especially important on busy networks where map updates might not always complete.</p>
</div>
<div class="paragraph">
<p>To finish the configuration, run <code>/etc/netstart</code> on the slave server in order to start the NIS services.</p>
</div>
</div>
<div class="sect3">
<h4 id="_setting_up_an_nis_client">32.4.6. Setting Up an NIS Client<a class="anchor" href="#_setting_up_an_nis_client"></a></h4>
<div class="paragraph">
<p>An NIS client binds to an NIS server using <a href="https://man.freebsd.org/cgi/man.cgi?query=ypbind&amp;sektion=8&amp;format=html">ypbind(8)</a>. This daemon broadcasts RPC requests on the local network. These requests specify the domain name configured on the client. If an NIS server in the same domain receives one of the broadcasts, it will respond to ypbind, which will record the server’s address. If there are several servers available, the client will use the address of the first server to respond and will direct all of its NIS requests to that server. The client will automatically ping the server on a regular basis to make sure it is still available. If it fails to receive a reply within a reasonable amount of time, ypbind will mark the domain as unbound and begin broadcasting again in the hopes of locating another server.</p>
</div>
<div class="paragraph">
<p>To configure a FreeBSD machine to be an NIS client:</p>
</div>
<div class="exampleblock procedure">
<div class="content">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Edit <span class="filename">/etc/rc.conf</span> and add the following lines in order to set the NIS domain name and start <a href="https://man.freebsd.org/cgi/man.cgi?query=ypbind&amp;sektion=8&amp;format=html">ypbind(8)</a> during network startup:</p>
<div class="literalblock programlisting">
<div class="content">
<pre>nisdomainname=&#34;test-domain&#34;
nis_client_enable=&#34;YES&#34;</pre>
</div>
</div>
</li>
<li>
<p>To import all possible password entries from the NIS server, use <code>vipw</code> to remove all user accounts except one from <span class="filename">/etc/master.passwd</span>. When removing the accounts, keep in mind that at least one local account should remain and this account should be a member of <code>wheel</code>. If there is a problem with NIS, this local account can be used to log in remotely, become the superuser, and fix the problem. Before saving the edits, add the following line to the end of the file:</p>
<div class="literalblock programlisting">
<div class="content">
<pre>+:::::::::</pre>
</div>
</div>
<div class="paragraph">
<p>This line configures the client to provide anyone with a valid account in the NIS server’s password maps an account on the client. There are many ways to configure the NIS client by modifying this line. One method is described in <a href="#network-netgroups">Using Netgroups</a>. For more detailed reading, refer to the book <code>Managing NFS and NIS</code>, published by O’Reilly Media.</p>
</div>
</li>
<li>
<p>To import all possible group entries from the NIS server, add this line to <span class="filename">/etc/group</span>:</p>
<div class="literalblock programlisting">
<div class="content">
<pre>+:*::</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="paragraph">
<p>To start the NIS client immediately, execute the following commands as the superuser:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># /etc/netstart</span>
<span class="c"># service ypbind start</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>After completing these steps, running <code>ypcat passwd</code> on the client should show the server’s <span class="filename">passwd</span> map.</p>
</div>
</div>
<div class="sect3">
<h4 id="_nis_security">32.4.7. NIS Security<a class="anchor" href="#_nis_security"></a></h4>
<div class="paragraph">
<p>Since RPC is a broadcast-based service, any system running ypbind within the same domain can retrieve the contents of the NIS maps. To prevent unauthorized transactions, <a href="https://man.freebsd.org/cgi/man.cgi?query=ypserv&amp;sektion=8&amp;format=html">ypserv(8)</a> supports a feature called &#34;securenets&#34; which can be used to restrict access to a given set of hosts. By default, this information is stored in <span class="filename">/var/yp/securenets</span>, unless <a href="https://man.freebsd.org/cgi/man.cgi?query=ypserv&amp;sektion=8&amp;format=html">ypserv(8)</a> is started with <code>-p</code> and an alternate path. This file contains entries that consist of a network specification and a network mask separated by white space. Lines starting with <code>&#34;#&#34;</code> are considered to be comments. A sample <span class="filename">securenets</span> might look like this:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre># allow connections from local host -- mandatory
127.0.0.1     255.255.255.255
# allow connections from any host
# on the 192.168.128.0 network
192.168.128.0 255.255.255.0
# allow connections from any host
# between 10.0.0.0 to 10.0.15.255
# this includes the machines in the testlab
10.0.0.0      255.255.240.0</pre>
</div>
</div>
<div class="paragraph">
<p>If <a href="https://man.freebsd.org/cgi/man.cgi?query=ypserv&amp;sektion=8&amp;format=html">ypserv(8)</a> receives a request from an address that matches one of these rules, it will process the request normally. If the address fails to match a rule, the request will be ignored and a warning message will be logged. If the <span class="filename">securenets</span> does not exist, <code>ypserv</code> will allow connections from any host.</p>
</div>
<div class="paragraph">
<p><a href="./#tcpwrappers">TCP Wrapper</a> is an alternate mechanism for providing access control instead of <span class="filename">securenets</span>. While either access control mechanism adds some security, they are both vulnerable to &#34;IP spoofing&#34; attacks. All NIS-related traffic should be blocked at the firewall.</p>
</div>
<div class="paragraph">
<p>Servers using <span class="filename">securenets</span> may fail to serve legitimate NIS clients with archaic TCP/IP implementations. Some of these implementations set all host bits to zero when doing broadcasts or fail to observe the subnet mask when calculating the broadcast address. While some of these problems can be fixed by changing the client configuration, other problems may force the retirement of these client systems or the abandonment of <span class="filename">securenets</span>.</p>
</div>
<div class="paragraph">
<p>The use of TCP Wrapper increases the latency of the NIS server. The additional delay may be long enough to cause timeouts in client programs, especially in busy networks with slow NIS servers. If one or more clients suffer from latency, convert those clients into NIS slave servers and force them to bind to themselves.</p>
</div>
<div class="sect4">
<h5 id="_barring_some_users">32.4.7.1. Barring Some Users<a class="anchor" href="#_barring_some_users"></a></h5>
<div class="paragraph">
<p>In this example, the <code>basie</code> system is a faculty workstation within the NIS domain. The <span class="filename">passwd</span> map on the master NIS server contains accounts for both faculty and students. This section demonstrates how to allow faculty logins on this system while refusing student logins.</p>
</div>
<div class="paragraph">
<p>To prevent specified users from logging on to a system, even if they are present in the NIS database, use <code>vipw</code> to add <code>-<em>username</em></code> with the correct number of colons towards the end of <span class="filename">/etc/master.passwd</span> on the client, where <em>username</em> is the username of a user to bar from logging in. The line with the blocked user must be before the <code>+</code> line that allows NIS users. In this example, <code>bill</code> is barred from logging on to <code>basie</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">basie# </span>cat /etc/master.passwd
root:[password]:0:0::0:0:The super-user:/root:/bin/csh
toor:[password]:0:0::0:0:The other super-user:/root:/bin/sh
daemon:<span class="k">*</span>:1:1::0:0:Owner of many system processes:/root:/usr/sbin/nologin
operator:<span class="k">*</span>:2:5::0:0:System &amp;:/:/usr/sbin/nologin
bin:<span class="k">*</span>:3:7::0:0:Binaries Commands and Source,,,:/:/usr/sbin/nologin
tty:<span class="k">*</span>:4:65533::0:0:Tty Sandbox:/:/usr/sbin/nologin
kmem:<span class="k">*</span>:5:65533::0:0:KMem Sandbox:/:/usr/sbin/nologin
games:<span class="k">*</span>:7:13::0:0:Games pseudo-user:/usr/games:/usr/sbin/nologin
news:<span class="k">*</span>:8:8::0:0:News Subsystem:/:/usr/sbin/nologin
man:<span class="k">*</span>:9:9::0:0:Mister Man Pages:/usr/share/man:/usr/sbin/nologin
<span class="nb">bind</span>:<span class="k">*</span>:53:53::0:0:Bind Sandbox:/:/usr/sbin/nologin
uucp:<span class="k">*</span>:66:66::0:0:UUCP pseudo-user:/var/spool/uucppublic:/usr/libexec/uucp/uucico
xten:<span class="k">*</span>:67:67::0:0:X-10 daemon:/usr/local/xten:/usr/sbin/nologin
pop:<span class="k">*</span>:68:6::0:0:Post Office Owner:/nonexistent:/usr/sbin/nologin
nobody:<span class="k">*</span>:65534:65534::0:0:Unprivileged user:/nonexistent:/usr/sbin/nologin
-bill:::::::::
+:::::::::

basie#</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="network-netgroups">32.4.8. Using Netgroups<a class="anchor" href="#network-netgroups"></a></h4>
<div class="paragraph">
<p>Barring specified users from logging on to individual systems becomes unscaleable on larger networks and quickly loses the main benefit of NIS: <em>centralized</em> administration.</p>
</div>
<div class="paragraph">
<p>Netgroups were developed to handle large, complex networks with hundreds of users and machines. Their use is comparable to UNIX® groups, where the main difference is the lack of a numeric ID and the ability to define a netgroup by including both user accounts and other netgroups.</p>
</div>
<div class="paragraph">
<p>To expand on the example used in this chapter, the NIS domain will be extended to add the users and systems shown in Tables 28.2 and 28.3:</p>
</div>
<table class="tableblock frame-none grid-all stretch">
<caption class="title">表 43. Additional Users</caption>
<colgroup>
<col style="width: 50%;"/>
<col style="width: 50%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">User Name(s)</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>alpha</code>, <code>beta</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">IT department employees</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>charlie</code>, <code>delta</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">IT department apprentices</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>echo</code>, <code>foxtrott</code>, <code>golf</code>, …​</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">employees</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>able</code>, <code>baker</code>, …​</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">interns</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-none grid-all stretch">
<caption class="title">表 44. Additional Systems</caption>
<colgroup>
<col style="width: 50%;"/>
<col style="width: 50%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Machine Name(s)</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>war</code>, <code>death</code>, <code>famine</code>, <code>pollution</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Only IT employees are allowed to log onto these servers.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>pride</code>, <code>greed</code>, <code>envy</code>, <code>wrath</code>, <code>lust</code>, <code>sloth</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">All members of the IT department are allowed to login onto these servers.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>one</code>, <code>two</code>, <code>three</code>, <code>four</code>, …​</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ordinary workstations used by employees.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>trashcan</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A very old machine without any critical data. Even interns are allowed to use this system.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>When using netgroups to configure this scenario, each user is assigned to one or more netgroups and logins are then allowed or forbidden for all members of the netgroup. When adding a new machine, login restrictions must be defined for all netgroups. When a new user is added, the account must be added to one or more netgroups. If the NIS setup is planned carefully, only one central configuration file needs modification to grant or deny access to machines.</p>
</div>
<div class="paragraph">
<p>The first step is the initialization of the NIS`netgroup` map. In FreeBSD, this map is not created by default. On the NIS master server, use an editor to create a map named <span class="filename">/var/yp/netgroup</span>.</p>
</div>
<div class="paragraph">
<p>This example creates four netgroups to represent IT employees, IT apprentices, employees, and interns:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>IT_EMP  (,alpha,test-domain)    (,beta,test-domain)
IT_APP  (,charlie,test-domain)  (,delta,test-domain)
USERS   (,echo,test-domain)     (,foxtrott,test-domain) \
        (,golf,test-domain)
INTERNS (,able,test-domain)     (,baker,test-domain)</pre>
</div>
</div>
<div class="paragraph">
<p>Each entry configures a netgroup. The first column in an entry is the name of the netgroup. Each set of parentheses represents either a group of one or more users or the name of another netgroup. When specifying a user, the three comma-delimited fields inside each group represent:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The name of the host(s) where the other fields representing the user are valid. If a hostname is not specified, the entry is valid on all hosts.</p>
</li>
<li>
<p>The name of the account that belongs to this netgroup.</p>
</li>
<li>
<p>The NIS domain for the account. Accounts may be imported from other NIS domains into a netgroup.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>If a group contains multiple users, separate each user with whitespace. Additionally, each field may contain wildcards. See <a href="https://man.freebsd.org/cgi/man.cgi?query=netgroup&amp;sektion=5&amp;format=html">netgroup(5)</a> for details.</p>
</div>
<div class="paragraph">
<p>Netgroup names longer than 8 characters should not be used. The names are case sensitive and using capital letters for netgroup names is an easy way to distinguish between user, machine and netgroup names.</p>
</div>
<div class="paragraph">
<p>Some non-FreeBSD NIS clients cannot handle netgroups containing more than 15 entries. This limit may be circumvented by creating several sub-netgroups with 15 users or fewer and a real netgroup consisting of the sub-netgroups, as seen in this example:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>BIGGRP1  (,joe1,domain)  (,joe2,domain)  (,joe3,domain) [...]
BIGGRP2  (,joe16,domain)  (,joe17,domain) [...]
BIGGRP3  (,joe31,domain)  (,joe32,domain)
BIGGROUP  BIGGRP1 BIGGRP2 BIGGRP3</pre>
</div>
</div>
<div class="paragraph">
<p>Repeat this process if more than 225 (15 times 15) users exist within a single netgroup.</p>
</div>
<div class="paragraph">
<p>To activate and distribute the new NIS map:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">ellington# </span><span class="nb">cd</span> /var/yp
<span class="gp">ellington# </span>make</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will generate the three NIS maps <span class="filename">netgroup</span>, <span class="filename">netgroup.byhost</span> and <span class="filename">netgroup.byuser</span>. Use the map key option of <a href="https://man.freebsd.org/cgi/man.cgi?query=ypcat&amp;sektion=1&amp;format=html">ypcat(1)</a> to check if the new NIS maps are available:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">ellington% </span>ypcat -k netgroup
<span class="gp">ellington% </span>ypcat -k netgroup.byhost
<span class="gp">ellington% </span>ypcat -k netgroup.byuser</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output of the first command should resemble the contents of <span class="filename">/var/yp/netgroup</span>. The second command only produces output if host-specific netgroups were created. The third command is used to get the list of netgroups for a user.</p>
</div>
<div class="paragraph">
<p>To configure a client, use <a href="https://man.freebsd.org/cgi/man.cgi?query=vipw&amp;sektion=8&amp;format=html">vipw(8)</a> to specify the name of the netgroup. For example, on the server named <code>war</code>, replace this line:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>+:::::::::</pre>
</div>
</div>
<div class="paragraph">
<p>with</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>+@IT_EMP:::::::::</pre>
</div>
</div>
<div class="paragraph">
<p>This specifies that only the users defined in the netgroup <code>IT_EMP</code> will be imported into this system’s password database and only those users are allowed to login to this system.</p>
</div>
<div class="paragraph">
<p>This configuration also applies to the <code>~</code> function of the shell and all routines which convert between user names and numerical user IDs. In other words, <code>cd ~<em>user</em></code> will not work, <code>ls -l</code> will show the numerical ID instead of the username, and <code>find . -user joe -print</code> will fail with the message <code>No such user</code>. To fix this, import all user entries without allowing them to login into the servers. This can be achieved by adding an extra line:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>+:::::::::/usr/sbin/nologin</pre>
</div>
</div>
<div class="paragraph">
<p>This line configures the client to import all entries but to replace the shell in those entries with <span class="filename">/usr/sbin/nologin</span>.</p>
</div>
<div class="paragraph">
<p>Make sure that extra line is placed <em>after</em> <code>+@IT_EMP:::::::::</code>. Otherwise, all user accounts imported from NIS will have <span class="filename">/usr/sbin/nologin</span> as their login shell and no one will be able to login to the system.</p>
</div>
<div class="paragraph">
<p>To configure the less important servers, replace the old <code>+:::::::::</code> on the servers with these lines:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>+@IT_EMP:::::::::
+@IT_APP:::::::::
+:::::::::/usr/sbin/nologin</pre>
</div>
</div>
<div class="paragraph">
<p>The corresponding lines for the workstations would be:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>+@IT_EMP:::::::::
+@USERS:::::::::
+:::::::::/usr/sbin/nologin</pre>
</div>
</div>
<div class="paragraph">
<p>NIS supports the creation of netgroups from other netgroups which can be useful if the policy regarding user access changes. One possibility is the creation of role-based netgroups. For example, one might create a netgroup called <code>BIGSRV</code> to define the login restrictions for the important servers, another netgroup called <code>SMALLSRV</code> for the less important servers, and a third netgroup called <code>USERBOX</code> for the workstations. Each of these netgroups contains the netgroups that are allowed to login onto these machines. The new entries for the NIS`netgroup` map would look like this:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>BIGSRV    IT_EMP  IT_APP
SMALLSRV  IT_EMP  IT_APP  ITINTERN
USERBOX   IT_EMP  ITINTERN USERS</pre>
</div>
</div>
<div class="paragraph">
<p>This method of defining login restrictions works reasonably well when it is possible to define groups of machines with identical restrictions. Unfortunately, this is the exception and not the rule. Most of the time, the ability to define login restrictions on a per-machine basis is required.</p>
</div>
<div class="paragraph">
<p>Machine-specific netgroup definitions are another possibility to deal with the policy changes. In this scenario, the <span class="filename">/etc/master.passwd</span> of each system contains two lines starting with &#34;+&#34;. The first line adds a netgroup with the accounts allowed to login onto this machine and the second line adds all other accounts with <span class="filename">/usr/sbin/nologin</span> as shell. It is recommended to use the &#34;ALL-CAPS&#34; version of the hostname as the name of the netgroup:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>+@BOXNAME:::::::::
+:::::::::/usr/sbin/nologin</pre>
</div>
</div>
<div class="paragraph">
<p>Once this task is completed on all the machines, there is no longer a need to modify the local versions of <span class="filename">/etc/master.passwd</span> ever again. All further changes can be handled by modifying the NIS map. Here is an example of a possible <code>netgroup</code> map for this scenario:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre># Define groups of users first
IT_EMP    (,alpha,test-domain)    (,beta,test-domain)
IT_APP    (,charlie,test-domain)  (,delta,test-domain)
DEPT1     (,echo,test-domain)     (,foxtrott,test-domain)
DEPT2     (,golf,test-domain)     (,hotel,test-domain)
DEPT3     (,india,test-domain)    (,juliet,test-domain)
ITINTERN  (,kilo,test-domain)     (,lima,test-domain)
D_INTERNS (,able,test-domain)     (,baker,test-domain)
#
# Now, define some groups based on roles
USERS     DEPT1   DEPT2     DEPT3
BIGSRV    IT_EMP  IT_APP
SMALLSRV  IT_EMP  IT_APP    ITINTERN
USERBOX   IT_EMP  ITINTERN  USERS
#
# And a groups for a special tasks
# Allow echo and golf to access our anti-virus-machine
SECURITY  IT_EMP  (,echo,test-domain)  (,golf,test-domain)
#
# machine-based netgroups
# Our main servers
WAR       BIGSRV
FAMINE    BIGSRV
# User india needs access to this server
POLLUTION  BIGSRV  (,india,test-domain)
#
# This one is really important and needs more access restrictions
DEATH     IT_EMP
#
# The anti-virus-machine mentioned above
ONE       SECURITY
#
# Restrict a machine to a single user
TWO       (,hotel,test-domain)
# [...more groups to follow]</pre>
</div>
</div>
<div class="paragraph">
<p>It may not always be advisable to use machine-based netgroups. When deploying a couple of dozen or hundreds of systems, role-based netgroups instead of machine-based netgroups may be used to keep the size of the NIS map within reasonable limits.</p>
</div>
</div>
<div class="sect3">
<h4 id="_password_formats">32.4.9. Password Formats<a class="anchor" href="#_password_formats"></a></h4>
<div class="paragraph">
<p>NIS requires that all hosts within an NIS domain use the same format for encrypting passwords. If users have trouble authenticating on an NIS client, it may be due to a differing password format. In a heterogeneous network, the format must be supported by all operating systems, where DES is the lowest common standard.</p>
</div>
<div class="paragraph">
<p>To check which format a server or client is using, look at this section of <span class="filename">/etc/login.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>default:\
	:passwd_format=des:\
	:copyright=/etc/COPYRIGHT:\
	[Further entries elided]</pre>
</div>
</div>
<div class="paragraph">
<p>In this example, the system is using the DES format for password hashing. Other possible values include <code>blf</code> for Blowfish, <code>md5</code> for MD5, <code>sha256</code> and <code>sha512</code> for SHA-256 and SHA-512 respectively. For more information and the up to date list of what is available on your system, consult the <a href="https://man.freebsd.org/cgi/man.cgi?query=crypt&amp;sektion=3&amp;format=html">crypt(3)</a> manpage.</p>
</div>
<div class="paragraph">
<p>If the format on a host needs to be edited to match the one being used in the NIS domain, the login capability database must be rebuilt after saving the change:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># cap_mkdb /etc/login.conf</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The format of passwords for existing user accounts will not be updated until each user changes their password <em>after</em> the login capability database is rebuilt.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="network-ldap">32.5. Lightweight Directory Access Protocol (LDAP)<a class="anchor" href="#network-ldap"></a></h3>
<div class="paragraph">
<p>The Lightweight Directory Access Protocol (LDAP) is an application layer protocol used to access, modify, and authenticate objects using a distributed directory information service. Think of it as a phone or record book which stores several levels of hierarchical, homogeneous information. It is used in Active Directory and OpenLDAP networks and allows users to access to several levels of internal information utilizing a single account. For example, email authentication, pulling employee contact information, and internal website authentication might all make use of a single user account in the LDAP server’s record base.</p>
</div>
<div class="paragraph">
<p>This section provides a quick start guide for configuring an LDAP server on a FreeBSD system. It assumes that the administrator already has a design plan which includes the type of information to store, what that information will be used for, which users should have access to that information, and how to secure this information from unauthorized access.</p>
</div>
<div class="sect3">
<h4 id="_ldap_terminology_and_structure">32.5.1. LDAP Terminology and Structure<a class="anchor" href="#_ldap_terminology_and_structure"></a></h4>
<div class="paragraph">
<p>LDAP uses several terms which should be understood before starting the configuration. All directory entries consist of a group of <em>attributes</em>. Each of these attribute sets contains a unique identifier known as a <em>Distinguished Name</em> (DN) which is normally built from several other attributes such as the common or <em>Relative Distinguished Name</em> (RDN). Similar to how directories have absolute and relative paths, consider a DN as an absolute path and the RDN as the relative path.</p>
</div>
<div class="paragraph">
<p>An example LDAP entry looks like the following. This example searches for the entry for the specified user account (<code>uid</code>), organizational unit (<code>ou</code>), and organization (<code>o</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>ldapsearch -xb <span class="s2">&#34;uid=trhodes,ou=users,o=example.com&#34;</span>
<span class="c"># extended LDIF</span>
<span class="c">#</span>
<span class="c"># LDAPv3</span>
<span class="c"># base &lt;uid=trhodes,ou=users,o=example.com&gt; with scope subtree</span>
<span class="c"># filter: (objectclass=*)</span>
<span class="c"># requesting: ALL</span>
<span class="c">#</span>

<span class="c"># trhodes, users, example.com</span>
dn: <span class="nv">uid</span><span class="o">=</span>trhodes,ou<span class="o">=</span>users,o<span class="o">=</span>example.com
mail: trhodes@example.com
cn: Tom Rhodes
uid: trhodes
telephoneNumber: <span class="o">(</span>123<span class="o">)</span> 456-7890

<span class="c"># search result</span>
search: 2
result: 0 Success

<span class="c"># numResponses: 2</span>
<span class="c"># numEntries: 1</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This example entry shows the values for the <code>dn</code>, <code>mail</code>, <code>cn</code>, <code>uid</code>, and <code>telephoneNumber</code> attributes. The cn attribute is the RDN.</p>
</div>
<div class="paragraph">
<p>More information about LDAP and its terminology can be found at <a href="http://www.openldap.org/doc/admin24/intro.html">http://www.openldap.org/doc/admin24/intro.html</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="ldap-config">32.5.2. Configuring an LDAP Server<a class="anchor" href="#ldap-config"></a></h4>
<div class="paragraph">
<p>FreeBSD does not provide a built-in LDAP server. Begin the configuration by installing <a class="package" href="https://cgit.freebsd.org/ports/tree/net/openldap-server/">net/openldap-server</a> package or port:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install openldap-server</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>There is a large set of default options enabled in the <a href="{linux-users}#software">package</a>. Review them by running <code>pkg info openldap-server</code>. If they are not sufficient (for example if SQL support is needed), please consider recompiling the port using the appropriate <a href="./#ports-using">framework</a>.</p>
</div>
<div class="paragraph">
<p>The installation creates the directory <span class="filename">/var/db/openldap-data</span> to hold the data. The directory to store the certificates must be created:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># mkdir /usr/local/etc/openldap/private</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The next phase is to configure the Certificate Authority. The following commands must be executed from <span class="filename">/usr/local/etc/openldap/private</span>. This is important as the file permissions need to be restrictive and users should not have access to these files. More detailed information about certificates and their parameters can be found in <a href="./#openssl">OpenSSL</a>. To create the Certificate Authority, start with this command and follow the prompts:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># openssl req -days 365 -nodes -new -x509 -keyout ca.key -out ../ca.crt</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The entries for the prompts may be generic <em>except</em> for the <code>Common Name</code>. This entry must be <em>different</em> than the system hostname. If this will be a self signed certificate, prefix the hostname with <code>CA</code> for Certificate Authority.</p>
</div>
<div class="paragraph">
<p>The next task is to create a certificate signing request and a private key. Input this command and follow the prompts:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># openssl req -days 365 -nodes -new -keyout server.key -out server.csr</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>During the certificate generation process, be sure to correctly set the <code>Common Name</code> attribute. The Certificate Signing Request must be signed with the Certificate Authority in order to be used as a valid certificate:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># openssl x509 -req -days 365 -in server.csr -out ../server.crt -CA ../ca.crt -CAkey ca.key -CAcreateserial</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The final part of the certificate generation process is to generate and sign the client certificates:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># openssl req -days 365 -nodes -new -keyout client.key -out client.csr</span>
<span class="c"># openssl x509 -req -days 3650 -in client.csr -out ../client.crt -CA ../ca.crt -CAkey ca.key</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Remember to use the same <code>Common Name</code> attribute when prompted. When finished, ensure that a total of eight (8) new files have been generated through the proceeding commands.</p>
</div>
<div class="paragraph">
<p>The daemon running the OpenLDAP server is <span class="filename">slapd</span>. Its configuration is performed through <span class="filename">slapd.ldif</span>: the old <span class="filename">slapd.conf</span> has been deprecated by OpenLDAP.</p>
</div>
<div class="paragraph">
<p><a href="http://www.openldap.org/doc/admin24/slapdconf2.html">Configuration examples</a> for <span class="filename">slapd.ldif</span> are available and can also be found in <span class="filename">/usr/local/etc/openldap/slapd.ldif.sample</span>. Options are documented in slapd-config(5). Each section of <span class="filename">slapd.ldif</span>, like all the other LDAP attribute sets, is uniquely identified through a DN. Be sure that no blank lines are left between the <code>dn:</code> statement and the desired end of the section. In the following example, TLS will be used to implement a secure channel. The first section represents the global configuration:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>#
# See slapd-config(5) for details on configuration options.
# This file should NOT be world readable.
#
dn: cn=config
objectClass: olcGlobal
cn: config
#
#
# Define global ACLs to disable default read access.
#
olcArgsFile: /var/run/openldap/slapd.args
olcPidFile: /var/run/openldap/slapd.pid
olcTLSCertificateFile: /usr/local/etc/openldap/server.crt
olcTLSCertificateKeyFile: /usr/local/etc/openldap/private/server.key
olcTLSCACertificateFile: /usr/local/etc/openldap/ca.crt
#olcTLSCipherSuite: HIGH
olcTLSProtocolMin: 3.1
olcTLSVerifyClient: never</pre>
</div>
</div>
<div class="paragraph">
<p>The Certificate Authority, server certificate and server private key files must be specified here. It is recommended to let the clients choose the security cipher and omit option <code>olcTLSCipherSuite</code> (incompatible with TLS clients other than <span class="filename">openssl</span>). Option <code>olcTLSProtocolMin</code> lets the server require a minimum security level: it is recommended. While verification is mandatory for the server, it is not for the client: <code>olcTLSVerifyClient: never</code>.</p>
</div>
<div class="paragraph">
<p>The second section is about the backend modules and can be configured as follows:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>#
# Load dynamic backend modules:
#
dn: cn=module,cn=config
objectClass: olcModuleList
cn: module
olcModulepath:	/usr/local/libexec/openldap
olcModuleload:	back_mdb.la
#olcModuleload:	back_bdb.la
#olcModuleload:	back_hdb.la
#olcModuleload:	back_ldap.la
#olcModuleload:	back_passwd.la
#olcModuleload:	back_shell.la</pre>
</div>
</div>
<div class="paragraph">
<p>The third section is devoted to load the needed <code>ldif</code> schemas to be used by the databases: they are essential.</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>dn: cn=schema,cn=config
objectClass: olcSchemaConfig
cn: schema

include: file:///usr/local/etc/openldap/schema/core.ldif
include: file:///usr/local/etc/openldap/schema/cosine.ldif
include: file:///usr/local/etc/openldap/schema/inetorgperson.ldif
include: file:///usr/local/etc/openldap/schema/nis.ldif</pre>
</div>
</div>
<div class="paragraph">
<p>Next, the frontend configuration section:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre># Frontend settings
#
dn: olcDatabase={-1}frontend,cn=config
objectClass: olcDatabaseConfig
objectClass: olcFrontendConfig
olcDatabase: {-1}frontend
olcAccess: to * by * read
#
# Sample global access control policy:
#	Root DSE: allow anyone to read it
#	Subschema (sub)entry DSE: allow anyone to read it
#	Other DSEs:
#		Allow self write access
#		Allow authenticated users read access
#		Allow anonymous users to authenticate
#
#olcAccess: to dn.base=&#34;&#34; by * read
#olcAccess: to dn.base=&#34;cn=Subschema&#34; by * read
#olcAccess: to *
#	by self write
#	by users read
#	by anonymous auth
#
# if no access controls are present, the default policy
# allows anyone and everyone to read anything but restricts
# updates to rootdn.  (e.g., &#34;access to * by * read&#34;)
#
# rootdn can always read and write EVERYTHING!
#
olcPasswordHash: {SSHA}
# {SSHA} is already the default for olcPasswordHash</pre>
</div>
</div>
<div class="paragraph">
<p>Another section is devoted to the <em>configuration backend</em>, the only way to later access the OpenLDAP server configuration is as a global super-user.</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>dn: olcDatabase={0}config,cn=config
objectClass: olcDatabaseConfig
olcDatabase: {0}config
olcAccess: to * by * none
olcRootPW: {SSHA}iae+lrQZILpiUdf16Z9KmDmSwT77Dj4U</pre>
</div>
</div>
<div class="paragraph">
<p>The default administrator username is <code>cn=config</code>. Type <span class="filename">slappasswd</span> in a shell, choose a password and use its hash in <code>olcRootPW</code>. If this option is not specified now, before <span class="filename">slapd.ldif</span> is imported, no one will be later able to modify the <em>global configuration</em> section.</p>
</div>
<div class="paragraph">
<p>The last section is about the database backend:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>#######################################################################
# LMDB database definitions
#######################################################################
#
dn: olcDatabase=mdb,cn=config
objectClass: olcDatabaseConfig
objectClass: olcMdbConfig
olcDatabase: mdb
olcDbMaxSize: 1073741824
olcSuffix: dc=domain,dc=example
olcRootDN: cn=mdbadmin,dc=domain,dc=example
# Cleartext passwords, especially for the rootdn, should
# be avoided.  See slappasswd(8) and slapd-config(5) for details.
# Use of strong authentication encouraged.
olcRootPW: {SSHA}X2wHvIWDk6G76CQyCMS1vDCvtICWgn0+
# The database directory MUST exist prior to running slapd AND
# should only be accessible by the slapd and slap tools.
# Mode 700 recommended.
olcDbDirectory:	/var/db/openldap-data
# Indices to maintain
olcDbIndex: objectClass eq</pre>
</div>
</div>
<div class="paragraph">
<p>This database hosts the <em>actual contents</em> of the LDAP directory. Types other than <code>mdb</code> are available. Its super-user, not to be confused with the global one, is configured here: a (possibly custom) username in <code>olcRootDN</code> and the password hash in <code>olcRootPW</code>; <span class="filename">slappasswd</span> can be used as before.</p>
</div>
<div class="paragraph">
<p>This <a href="http://www.openldap.org/devel/gitweb.cgi?p=openldap.git;a=tree;f=tests/data/regressions/its8444;h=8a5e808e63b0de3d2bdaf2cf34fecca8577ca7fd;hb=HEAD">repository</a> contains four examples of <span class="filename">slapd.ldif</span>. To convert an existing <span class="filename">slapd.conf</span> into <span class="filename">slapd.ldif</span>, refer to <a href="http://www.openldap.org/doc/admin24/slapdconf2.html">this page</a> (please note that this may introduce some unuseful options).</p>
</div>
<div class="paragraph">
<p>When the configuration is completed, <span class="filename">slapd.ldif</span> must be placed in an empty directory. It is recommended to create it as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># mkdir /usr/local/etc/openldap/slapd.d/</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Import the configuration database:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># /usr/local/sbin/slapadd -n0 -F /usr/local/etc/openldap/slapd.d/ -l /usr/local/etc/openldap/slapd.ldif</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Start the <span class="filename">slapd</span> daemon:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># /usr/local/libexec/slapd -F /usr/local/etc/openldap/slapd.d/</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Option <code>-d</code> can be used for debugging, as specified in slapd(8). To verify that the server is running and working:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ldapsearch -x -b &#39;&#39; -s base &#39;(objectclass=*)&#39; namingContexts</span>
<span class="c"># extended LDIF</span>
<span class="c">#</span>
<span class="c"># LDAPv3</span>
<span class="c"># base &lt;&gt; with scope baseObject</span>
<span class="c"># filter: (objectclass=*)</span>
<span class="c"># requesting: namingContexts</span>
<span class="c">#</span>

<span class="c">#</span>
dn:
namingContexts: <span class="nv">dc</span><span class="o">=</span>domain,dc<span class="o">=</span>example

<span class="c"># search result</span>
search: 2
result: 0 Success

<span class="c"># numResponses: 2</span>
<span class="c"># numEntries: 1</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The server must still be trusted. If that has never been done before, follow these instructions. Install the OpenSSL package or port:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install openssl</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>From the directory where <span class="filename">ca.crt</span> is stored (in this example, <span class="filename">/usr/local/etc/openldap</span>), run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># c_rehash .</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Both the CA and the server certificate are now correctly recognized in their respective roles. To verify this, run this command from the <span class="filename">server.crt</span> directory:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># openssl verify -verbose -CApath . server.crt</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If <span class="filename">slapd</span> was running, restart it. As stated in <span class="filename">/usr/local/etc/rc.d/slapd</span>, to properly run <span class="filename">slapd</span> at boot the following lines must be added to <span class="filename">/etc/rc.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>slapd_enable=&#34;YES&#34;
slapd_flags=&#39;-h &#34;ldapi://%2fvar%2frun%2fopenldap%2fldapi/
ldap://0.0.0.0/&#34;&#39;
slapd_sockets=&#34;/var/run/openldap/ldapi&#34;
slapd_cn_config=&#34;YES&#34;</pre>
</div>
</div>
<div class="paragraph">
<p><span class="filename">slapd</span> does not provide debugging at boot. Check <span class="filename">/var/log/debug.log</span>, <span class="filename">dmesg -a</span> and <span class="filename">/var/log/messages</span> for this purpose.</p>
</div>
<div class="paragraph">
<p>The following example adds the group <code>team</code> and the user <code>john</code> to the <code>domain.example</code> LDAP database, which is still empty. First, create the file <span class="filename">domain.ldif</span>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># cat domain.ldif</span>
dn: <span class="nv">dc</span><span class="o">=</span>domain,dc<span class="o">=</span>example
objectClass: dcObject
objectClass: organization
o: domain.example
dc: domain

dn: <span class="nv">ou</span><span class="o">=</span>groups,dc<span class="o">=</span>domain,dc<span class="o">=</span>example
objectClass: top
objectClass: organizationalunit
ou: groups

dn: <span class="nv">ou</span><span class="o">=</span>users,dc<span class="o">=</span>domain,dc<span class="o">=</span>example
objectClass: top
objectClass: organizationalunit
ou: users

dn: <span class="nv">cn</span><span class="o">=</span>team,ou<span class="o">=</span>groups,dc<span class="o">=</span>domain,dc<span class="o">=</span>example
objectClass: top
objectClass: posixGroup
cn: team
gidNumber: 10001

dn: <span class="nv">uid</span><span class="o">=</span>john,ou<span class="o">=</span>users,dc<span class="o">=</span>domain,dc<span class="o">=</span>example
objectClass: top
objectClass: account
objectClass: posixAccount
objectClass: shadowAccount
cn: John McUser
uid: john
uidNumber: 10001
gidNumber: 10001
homeDirectory: /home/john/
loginShell: /usr/bin/bash
userPassword: secret</code></pre>
</div>
</div>
<div class="paragraph">
<p>See the OpenLDAP documentation for more details. Use <span class="filename">slappasswd</span> to replace the plain text password <code>secret</code> with a hash in <code>userPassword</code>. The path specified as <code>loginShell</code> must exist in all the systems where <code>john</code> is allowed to login. Finally, use the <code>mdb</code> administrator to modify the database:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ldapadd -W -D &#34;cn=mdbadmin,dc=domain,dc=example&#34; -f domain.ldif</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Modifications to the <em>global configuration</em> section can only be performed by the global super-user. For example, assume that the option <code>olcTLSCipherSuite: HIGH:MEDIUM:SSLv3</code> was initially specified and must now be deleted. First, create a file that contains the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># cat global_mod</span>
dn: <span class="nv">cn</span><span class="o">=</span>config
changetype: modify
delete: olcTLSCipherSuite</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, apply the modifications:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ldapmodify -f global_mod -x -D &#34;cn=config&#34; -W</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When asked, provide the password chosen in the <em>configuration backend</em> section. The username is not required: here, <code>cn=config</code> represents the DN of the database section to be modified. Alternatively, use <code>ldapmodify</code> to delete a single line of the database, <code>ldapdelete</code> to delete a whole entry.</p>
</div>
<div class="paragraph">
<p>If something goes wrong, or if the global super-user cannot access the configuration backend, it is possible to delete and re-write the whole configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># rm -rf /usr/local/etc/openldap/slapd.d/</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><span class="filename">slapd.ldif</span> can then be edited and imported again. Please, follow this procedure only when no other solution is available.</p>
</div>
<div class="paragraph">
<p>This is the configuration of the server only. The same machine can also host an LDAP client, with its own separate configuration.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="network-dhcp">32.6. Dynamic Host Configuration Protocol (DHCP)<a class="anchor" href="#network-dhcp"></a></h3>
<div class="paragraph">
<p>The Dynamic Host Configuration Protocol (DHCP) allows a system to connect to a network in order to be assigned the necessary addressing information for communication on that network. FreeBSD includes the OpenBSD version of <code>dhclient</code> which is used by the client to obtain the addressing information. FreeBSD does not install a DHCP server, but several servers are available in the FreeBSD Ports Collection. The DHCP protocol is fully described in <a href="http://www.freesoft.org/CIE/RFC/2131/">RFC 2131</a>. Informational resources are also available at <a href="http://www.isc.org/downloads/dhcp/">isc.org/downloads/dhcp/</a>.</p>
</div>
<div class="paragraph">
<p>This section describes how to use the built-in DHCP client. It then describes how to install and configure a DHCP server.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In FreeBSD, the <a href="https://man.freebsd.org/cgi/man.cgi?query=bpf&amp;sektion=4&amp;format=html">bpf(4)</a> device is needed by both the DHCP server and DHCP client. This device is included in the <span class="filename">GENERIC</span> kernel that is installed with FreeBSD. Users who prefer to create a custom kernel need to keep this device if DHCP is used.</p>
</div>
<div class="paragraph">
<p>It should be noted that <span class="filename">bpf</span> also allows privileged users to run network packet sniffers on that system.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="sect3">
<h4 id="_configuring_a_dhcp_client">32.6.1. Configuring a DHCP Client<a class="anchor" href="#_configuring_a_dhcp_client"></a></h4>
<div class="paragraph">
<p>DHCP client support is included in the FreeBSD installer, making it easy to configure a newly installed system to automatically receive its networking addressing information from an existing DHCP server. Refer to <a href="./#bsdinstall-post">Accounts, Time Zone, Services and Hardening</a> for examples of network configuration.</p>
</div>
<div class="paragraph">
<p>When <code>dhclient</code> is executed on the client machine, it begins broadcasting requests for configuration information. By default, these requests use UDP port 68. The server replies on UDP port 67, giving the client an IP address and other relevant network information such as a subnet mask, default gateway, and DNS server addresses. This information is in the form of a DHCP &#34;lease&#34; and is valid for a configurable time. This allows stale IP addresses for clients no longer connected to the network to automatically be reused. DHCP clients can obtain a great deal of information from the server. An exhaustive list may be found in <a href="https://man.freebsd.org/cgi/man.cgi?query=dhcp-options&amp;sektion=5&amp;format=html">dhcp-options(5)</a>.</p>
</div>
<div class="paragraph">
<p>By default, when a FreeBSD system boots, its DHCP client runs in the background, or <em>asynchronously</em>. Other startup scripts continue to run while the DHCP process completes, which speeds up system startup.</p>
</div>
<div class="paragraph">
<p>Background DHCP works well when the DHCP server responds quickly to the client’s requests. However, DHCP may take a long time to complete on some systems. If network services attempt to run before DHCP has assigned the network addressing information, they will fail. Using DHCP in <em>synchronous</em> mode prevents this problem as it pauses startup until the DHCP configuration has completed.</p>
</div>
<div class="paragraph">
<p>This line in <span class="filename">/etc/rc.conf</span> is used to configure background or asynchronous mode:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>ifconfig_fxp0=&#34;DHCP&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>This line may already exist if the system was configured to use DHCP during installation. Replace the <em>fxp0</em> shown in these examples with the name of the interface to be dynamically configured, as described in <a href="./#config-network-setup">“Setting Up Network Interface Cards”</a>.</p>
</div>
<div class="paragraph">
<p>To instead configure the system to use synchronous mode, and to pause during startup while DHCP completes, use “SYNCDHCP”:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>ifconfig_fxp0=&#34;SYNCDHCP&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>Additional client options are available. Search for <code>dhclient</code> in <a href="https://man.freebsd.org/cgi/man.cgi?query=rc.conf&amp;sektion=5&amp;format=html">rc.conf(5)</a> for details.</p>
</div>
<div class="paragraph">
<p>The DHCP client uses the following files:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="filename">/etc/dhclient.conf</span></p>
<div class="paragraph">
<p>The configuration file used by <code>dhclient</code>. Typically, this file contains only comments as the defaults are suitable for most clients. This configuration file is described in <a href="https://man.freebsd.org/cgi/man.cgi?query=dhclient.conf&amp;sektion=5&amp;format=html">dhclient.conf(5)</a>.</p>
</div>
</li>
<li>
<p><span class="filename">/sbin/dhclient</span></p>
<div class="paragraph">
<p>More information about the command itself can be found in <a href="https://man.freebsd.org/cgi/man.cgi?query=dhclient&amp;sektion=8&amp;format=html">dhclient(8)</a>.</p>
</div>
</li>
<li>
<p><span class="filename">/sbin/dhclient-script</span></p>
<div class="paragraph">
<p>The FreeBSD-specific DHCP client configuration script. It is described in <a href="https://man.freebsd.org/cgi/man.cgi?query=dhclient-script&amp;sektion=8&amp;format=html">dhclient-script(8)</a>, but should not need any user modification to function properly.</p>
</div>
</li>
<li>
<p><span class="filename">/var/db/dhclient.leases.interface</span></p>
<div class="paragraph">
<p>The DHCP client keeps a database of valid leases in this file, which is written as a log and is described in <a href="https://man.freebsd.org/cgi/man.cgi?query=dhclient.leases&amp;sektion=5&amp;format=html">dhclient.leases(5)</a>.</p>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="network-dhcp-server">32.6.2. Installing and Configuring a DHCP Server<a class="anchor" href="#network-dhcp-server"></a></h4>
<div class="paragraph">
<p>This section demonstrates how to configure a FreeBSD system to act as a DHCP server using the Internet Systems Consortium (ISC) implementation of the DHCP server. This implementation and its documentation can be installed using the <a class="package" href="https://cgit.freebsd.org/ports/tree/net/isc-dhcp44-server/">net/isc-dhcp44-server</a> package or port.</p>
</div>
<div class="paragraph">
<p>The installation of <a class="package" href="https://cgit.freebsd.org/ports/tree/net/isc-dhcp44-server/">net/isc-dhcp44-server</a> installs a sample configuration file. Copy <span class="filename">/usr/local/etc/dhcpd.conf.example</span> to <span class="filename">/usr/local/etc/dhcpd.conf</span> and make any edits to this new file.</p>
</div>
<div class="paragraph">
<p>The configuration file is comprised of declarations for subnets and hosts which define the information that is provided to DHCP clients. For example, these lines configure the following:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>option domain-name &#34;example.org&#34;;<i class="conum" data-value="1"></i><b>(1)</b>
option domain-name-servers ns1.example.org;<i class="conum" data-value="2"></i><b>(2)</b>
option subnet-mask 255.255.255.0;<i class="conum" data-value="3"></i><b>(3)</b>

default-lease-time 600;<i class="conum" data-value="4"></i><b>(4)</b>
max-lease-time 72400;<i class="conum" data-value="5"></i><b>(5)</b>
ddns-update-style none;<i class="conum" data-value="6"></i><b>(6)</b>

subnet 10.254.239.0 netmask 255.255.255.224 {
  range 10.254.239.10 10.254.239.20;<i class="conum" data-value="7"></i><b>(7)</b>
  option routers rtr-239-0-1.example.org, rtr-239-0-2.example.org;<i class="conum" data-value="8"></i><b>(8)</b>
}

host fantasia {
  hardware ethernet 08:00:07:26:c0:a5;<i class="conum" data-value="9"></i><b>(9)</b>
  fixed-address fantasia.fugue.com;<i class="conum" data-value="10"></i><b>(10)</b>
}</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This option specifies the default search domain that will be provided to clients. Refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=resolv.conf&amp;sektion=5&amp;format=html">resolv.conf(5)</a> for more information. &lt;.&gt; This option specifies a comma separated list of DNS servers that the client should use. They can be listed by their Fully Qualified Domain Names (FQDN), as seen in the example, or by their IP addresses. &lt;.&gt; The subnet mask that will be provided to clients. &lt;.&gt; The default lease expiry time in seconds. A client can be configured to override this value. &lt;.&gt; The maximum allowed length of time, in seconds, for a lease. Should a client request a longer lease, a lease will still be issued, but it will only be valid for <code>max-lease-time</code>. &lt;.&gt; The default of <code>none</code> disables dynamic DNS updates. Changing this to <code>interim</code> configures the DHCP server to update a DNS server whenever it hands out a lease so that the DNS server knows which IP addresses are associated with which computers in the network. Do not change the default setting unless the DNS server has been configured to support dynamic DNS. &lt;.&gt; This line creates a pool of available IP addresses which are reserved for allocation to DHCP clients. The range of addresses must be valid for the network or subnet specified in the previous line. &lt;.&gt; Declares the default gateway that is valid for the network or subnet specified before the opening <code>{</code> bracket. &lt;.&gt; Specifies the hardware MAC address of a client so that the DHCP server can recognize the client when it makes a request. &lt;.&gt; Specifies that this host should always be given the same IP address. Using the hostname is correct, since the DHCP server will resolve the hostname before returning the lease information.</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>This configuration file supports many more options. Refer to dhcpd.conf(5), installed with the server, for details and examples.</p>
</div>
<div class="paragraph">
<p>Once the configuration of <span class="filename">dhcpd.conf</span> is complete, enable the DHCP server in <span class="filename">/etc/rc.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>dhcpd_enable=&#34;YES&#34;
dhcpd_ifaces=&#34;dc0&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>Replace the <code>dc0</code> with the interface (or interfaces, separated by whitespace) that the DHCP server should listen on for DHCP client requests.</p>
</div>
<div class="paragraph">
<p>Start the server by issuing the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># service isc-dhcpd start</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Any future changes to the configuration of the server will require the dhcpd service to be stopped and then started using <a href="https://man.freebsd.org/cgi/man.cgi?query=service&amp;sektion=8&amp;format=html">service(8)</a>.</p>
</div>
<div class="paragraph">
<p>The DHCP server uses the following files. Note that the manual pages are installed with the server software.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="filename">/usr/local/sbin/dhcpd</span></p>
<div class="paragraph">
<p>More information about the dhcpd server can be found in dhcpd(8).</p>
</div>
</li>
<li>
<p><span class="filename">/usr/local/etc/dhcpd.conf</span></p>
<div class="paragraph">
<p>The server configuration file needs to contain all the information that should be provided to clients, along with information regarding the operation of the server. This configuration file is described in dhcpd.conf(5).</p>
</div>
</li>
<li>
<p><span class="filename">/var/db/dhcpd.leases</span></p>
<div class="paragraph">
<p>The DHCP server keeps a database of leases it has issued in this file, which is written as a log. Refer to dhcpd.leases(5), which gives a slightly longer description.</p>
</div>
</li>
<li>
<p><span class="filename">/usr/local/sbin/dhcrelay</span></p>
<div class="paragraph">
<p>This daemon is used in advanced environments where one DHCP server forwards a request from a client to another DHCP server on a separate network. If this functionality is required, install the <a class="package" href="https://cgit.freebsd.org/ports/tree/net/isc-dhcp44-relay/">net/isc-dhcp44-relay</a> package or port. The installation includes dhcrelay(8) which provides more detail.</p>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="network-dns">32.7. Domain Name System (DNS)<a class="anchor" href="#network-dns"></a></h3>
<div class="paragraph">
<p>Domain Name System (DNS) is the protocol through which domain names are mapped to IP addresses, and vice versa. DNS is coordinated across the Internet through a somewhat complex system of authoritative root, Top Level Domain (TLD), and other smaller-scale name servers, which host and cache individual domain information. It is not necessary to run a name server to perform DNS lookups on a system.</p>
</div>
<div class="paragraph">
<p>The following table describes some of the terms associated with DNS:</p>
</div>
<table class="tableblock frame-none grid-all stretch">
<caption class="title">表 45. DNS Terminology</caption>
<colgroup>
<col style="width: 50%;"/>
<col style="width: 50%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Term</th>
<th class="tableblock halign-left valign-top">Definition</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Forward DNS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mapping of hostnames to IP addresses.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Origin</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Refers to the domain covered in a particular zone file.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Resolver</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A system process through which a machine queries a name server for zone information.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Reverse DNS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mapping of IP addresses to hostnames.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Root zone</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The beginning of the Internet zone hierarchy. All zones fall under the root zone, similar to how all files in a file system fall under the root directory.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Zone</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An individual domain, subdomain, or portion of the DNS administered by the same authority.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Examples of zones:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>.</code> is how the root zone is usually referred to in documentation.</p>
</li>
<li>
<p><code>org.</code> is a Top Level Domain (TLD) under the root zone.</p>
</li>
<li>
<p><code>example.org.</code> is a zone under the `org.`TLD.</p>
</li>
<li>
<p><code>1.168.192.in-addr.arpa</code> is a zone referencing all IP addresses which fall under the `192.168.1.*`IP address space.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>As one can see, the more specific part of a hostname appears to its left. For example, <code>example.org.</code> is more specific than <code>org.</code>, as <code>org.</code> is more specific than the root zone. The layout of each part of a hostname is much like a file system: the <span class="filename">/dev</span> directory falls within the root, and so on.</p>
</div>
<div class="sect3">
<h4 id="_reasons_to_run_a_name_server">32.7.1. Reasons to Run a Name Server<a class="anchor" href="#_reasons_to_run_a_name_server"></a></h4>
<div class="paragraph">
<p>Name servers generally come in two forms: authoritative name servers, and caching (also known as resolving) name servers.</p>
</div>
<div class="paragraph">
<p>An authoritative name server is needed when:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>One wants to serve DNS information to the world, replying authoritatively to queries.</p>
</li>
<li>
<p>A domain, such as <code>example.org</code>, is registered and IP addresses need to be assigned to hostnames under it.</p>
</li>
<li>
<p>An IP address block requires reverse DNS entries (IP to hostname).</p>
</li>
<li>
<p>A backup or second name server, called a slave, will reply to queries.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A caching name server is needed when:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A local DNS server may cache and respond more quickly than querying an outside name server.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When one queries for <code>www.FreeBSD.org</code>, the resolver usually queries the uplink ISP’s name server, and retrieves the reply. With a local, caching DNS server, the query only has to be made once to the outside world by the caching DNS server. Additional queries will not have to go outside the local network, since the information is cached locally.</p>
</div>
</div>
<div class="sect3">
<h4 id="_dns_server_configuration">32.7.2. DNS Server Configuration<a class="anchor" href="#_dns_server_configuration"></a></h4>
<div class="paragraph">
<p>Unbound is provided in the FreeBSD base system. By default, it will provide DNS resolution to the local machine only. While the base system package can be configured to provide resolution services beyond the local machine, it is recommended that such requirements be addressed by installing Unbound from the FreeBSD Ports Collection.</p>
</div>
<div class="paragraph">
<p>To enable Unbound, add the following to <span class="filename">/etc/rc.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>local_unbound_enable=&#34;YES&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>Any existing nameservers in <span class="filename">/etc/resolv.conf</span> will be configured as forwarders in the new Unbound configuration.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If any of the listed nameservers do not support DNSSEC, local DNS resolution will fail. Be sure to test each nameserver and remove any that fail the test. The following command will show the trust tree or a failure for a nameserver running on <code>192.168.1.1</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>drill -S FreeBSD.org @192.168.1.1</code></pre>
</div>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Once each nameserver is confirmed to support DNSSEC, start Unbound:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># service local_unbound onestart</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This will take care of updating <span class="filename">/etc/resolv.conf</span> so that queries for DNSSEC secured domains will now work. For example, run the following to validate the FreeBSD.org DNSSEC trust tree:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>drill -S FreeBSD.org
;; Number of trusted keys: 1
;; Chasing: freebsd.org. A

DNSSEC Trust tree:
freebsd.org. <span class="o">(</span>A<span class="o">)</span>
|---freebsd.org. <span class="o">(</span>DNSKEY keytag: 36786 alg: 8 flags: 256<span class="o">)</span>
    |---freebsd.org. <span class="o">(</span>DNSKEY keytag: 32659 alg: 8 flags: 257<span class="o">)</span>
    |---freebsd.org. <span class="o">(</span>DS keytag: 32659 digest <span class="nb">type</span>: 2<span class="o">)</span>
        |---org. <span class="o">(</span>DNSKEY keytag: 49587 alg: 7 flags: 256<span class="o">)</span>
            |---org. <span class="o">(</span>DNSKEY keytag: 9795 alg: 7 flags: 257<span class="o">)</span>
            |---org. <span class="o">(</span>DNSKEY keytag: 21366 alg: 7 flags: 257<span class="o">)</span>
            |---org. <span class="o">(</span>DS keytag: 21366 digest <span class="nb">type</span>: 1<span class="o">)</span>
            |   |---. <span class="o">(</span>DNSKEY keytag: 40926 alg: 8 flags: 256<span class="o">)</span>
            |       |---. <span class="o">(</span>DNSKEY keytag: 19036 alg: 8 flags: 257<span class="o">)</span>
            |---org. <span class="o">(</span>DS keytag: 21366 digest <span class="nb">type</span>: 2<span class="o">)</span>
                |---. <span class="o">(</span>DNSKEY keytag: 40926 alg: 8 flags: 256<span class="o">)</span>
                    |---. <span class="o">(</span>DNSKEY keytag: 19036 alg: 8 flags: 257<span class="o">)</span>
;; Chase successful</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_authoritative_name_server_configuration">32.7.3. Authoritative Name Server Configuration<a class="anchor" href="#_authoritative_name_server_configuration"></a></h4>
<div class="paragraph">
<p>FreeBSD does not provide authoritative name server software in the base system. Users are encouraged to install third party applications, like <a class="package" href="https://cgit.freebsd.org/ports/tree/dns/nsd/">dns/nsd</a> or <a class="package" href="https://cgit.freebsd.org/ports/tree/dns/bind918/">dns/bind918</a> package or port.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="network-apache">32.8. Apache HTTP Server<a class="anchor" href="#network-apache"></a></h3>
<div class="paragraph">
<p>The open source Apache HTTP Server is the most widely used web server. FreeBSD does not install this web server by default, but it can be installed from the <a class="package" href="https://cgit.freebsd.org/ports/tree/www/apache24/">www/apache24</a> package or port.</p>
</div>
<div class="paragraph">
<p>This section summarizes how to configure and start version 2.<em>x</em> of the Apache HTTP Server on FreeBSD. For more detailed information about Apache 2.X and its configuration directives, refer to <a href="http://httpd.apache.org/">httpd.apache.org</a>.</p>
</div>
<div class="sect3">
<h4 id="_configuring_and_starting_apache">32.8.1. Configuring and Starting Apache<a class="anchor" href="#_configuring_and_starting_apache"></a></h4>
<div class="paragraph">
<p>In FreeBSD, the main Apache HTTP Server configuration file is installed as <span class="filename">/usr/local/etc/apache2x/httpd.conf</span>, where <em>x</em> represents the version number. This ASCII text file begins comment lines with a <code>#</code>. The most frequently modified directives are:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>ServerRoot &#34;/usr/local&#34;</code></dt>
<dd>
<p>Specifies the default directory hierarchy for the Apache installation. Binaries are stored in the <span class="filename">bin</span> and <span class="filename">sbin</span> subdirectories of the server root and configuration files are stored in the <span class="filename">etc/apache2x</span> subdirectory.</p>
</dd>
<dt class="hdlist1"><code>ServerAdmin <a href="mailto:you@example.com">you@example.com</a></code></dt>
<dd>
<p>Change this to the email address to receive problems with the server. This address also appears on some server-generated pages, such as error documents.</p>
</dd>
<dt class="hdlist1"><code>ServerName www.example.com:80</code></dt>
<dd>
<p>Allows an administrator to set a hostname which is sent back to clients for the server. For example, <code>www</code> can be used instead of the actual hostname. If the system does not have a registered DNS name, enter its IP address instead. If the server will listen on an alternate report, change <code>80</code> to the alternate port number.</p>
</dd>
<dt class="hdlist1"><code>DocumentRoot &#34;/usr/local/www/apache2_x_/data&#34;</code></dt>
<dd>
<p>The directory where documents will be served from. By default, all requests are taken from this directory, but symbolic links and aliases may be used to point to other locations.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>It is always a good idea to make a backup copy of the default Apache configuration file before making changes. When the configuration of Apache is complete, save the file and verify the configuration using <code>apachectl</code>. Running <code>apachectl configtest</code> should return <code>Syntax OK</code>.</p>
</div>
<div class="paragraph">
<p>To launch Apache at system startup, add the following line to <span class="filename">/etc/rc.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>apache24_enable=&#34;YES&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>If Apache should be started with non-default options, the following line may be added to <span class="filename">/etc/rc.conf</span> to specify the needed flags:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>apache24_flags=&#34;&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>If apachectl does not report configuration errors, start <code>httpd</code> now:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># service apache24 start</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>httpd</code> service can be tested by entering <code>http://<em>localhost</em></code> in a web browser, replacing <em>localhost</em> with the fully-qualified domain name of the machine running <code>httpd</code>. The default web page that is displayed is <span class="filename">/usr/local/www/apache24/data/index.html</span>.</p>
</div>
<div class="paragraph">
<p>The Apache configuration can be tested for errors after making subsequent configuration changes while <code>httpd</code> is running using the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># service apache24 configtest</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>It is important to note that <code>configtest</code> is not an <a href="https://man.freebsd.org/cgi/man.cgi?query=rc&amp;sektion=8&amp;format=html">rc(8)</a> standard, and should not be expected to work for all startup scripts.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect3">
<h4 id="_virtual_hosting">32.8.2. Virtual Hosting<a class="anchor" href="#_virtual_hosting"></a></h4>
<div class="paragraph">
<p>Virtual hosting allows multiple websites to run on one Apache server. The virtual hosts can be <em>IP-based</em> or <em>name-based</em>. IP-based virtual hosting uses a different IP address for each website. Name-based virtual hosting uses the clients HTTP/1.1 headers to figure out the hostname, which allows the websites to share the same IP address.</p>
</div>
<div class="paragraph">
<p>To setup Apache to use name-based virtual hosting, add a <code>VirtualHost</code> block for each website. For example, for the webserver named <code>www.domain.tld</code> with a virtual domain of <code>www.someotherdomain.tld</code>, add the following entries to <span class="filename">httpd.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>&lt;VirtualHost *&gt;
    ServerName www.domain.tld
    DocumentRoot /www/domain.tld
&lt;/VirtualHost&gt;

&lt;VirtualHost *&gt;
    ServerName www.someotherdomain.tld
    DocumentRoot /www/someotherdomain.tld
&lt;/VirtualHost&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>For each virtual host, replace the values for <code>ServerName</code> and <code>DocumentRoot</code> with the values to be used.</p>
</div>
<div class="paragraph">
<p>For more information about setting up virtual hosts, consult the official Apache documentation at: <a href="http://httpd.apache.org/docs/vhosts/">http://httpd.apache.org/docs/vhosts/</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_apache_modules">32.8.3. Apache Modules<a class="anchor" href="#_apache_modules"></a></h4>
<div class="paragraph">
<p>Apache uses modules to augment the functionality provided by the basic server. Refer to <a href="http://httpd.apache.org/docs/current/mod/">http://httpd.apache.org/docs/current/mod/</a> for a complete listing of and the configuration details for the available modules.</p>
</div>
<div class="paragraph">
<p>In FreeBSD, some modules can be compiled with the <a class="package" href="https://cgit.freebsd.org/ports/tree/www/apache24/">www/apache24</a> port. Type <code>make config</code> within <span class="filename">/usr/ports/www/apache24</span> to see which modules are available and which are enabled by default. If the module is not compiled with the port, the FreeBSD Ports Collection provides an easy way to install many modules. This section describes three of the most commonly used modules.</p>
</div>
<div class="sect4">
<h5 id="_ssl_support">32.8.3.1. SSL support<a class="anchor" href="#_ssl_support"></a></h5>
<div class="paragraph">
<p>At one in point in time, support for SSL inside of Apache required a secondary module called <span class="filename">mod_ssl</span>. This is no longer the case and the default install of Apache comes with SSL built into the web server. An example of how to enable support for SSL websites is available in the installed file, <span class="filename">httpd-ssl.conf</span> inside of the <span class="filename">/usr/local/etc/apache24/extra</span> directory Inside this directory is also a sample file called named <span class="filename">ssl.conf-sample</span>. It is recommended that both files be evaluated to properly set up secure websites in the Apache web server.</p>
</div>
<div class="paragraph">
<p>After the configuration of SSL is complete, the following line must be uncommented in the main <span class="filename">http.conf</span> to activate the changes on the next restart or reload of Apache:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>#Include etc/apache24/extra/httpd-ssl.conf</pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>SSL version two and version three have known vulnerability issues. It is highly recommended TLS version 1.2 and 1.3 be enabled in place of the older SSL options. This can be accomplished by setting the following options in the <span class="filename">ssl.conf</span>:</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>SSLProtocol all -SSLv3 -SSLv2 +TLSv1.2 +TLSv1.3
SSLProxyProtocol all -SSLv2 -SSLv3 -TLSv1 -TLSv1.1</pre>
</div>
</div>
<div class="paragraph">
<p>To complete the configuration of SSL in the web server, uncomment the following line to ensure that the configuration will be pulled into Apache during restart or reload:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre># Secure (SSL/TLS) connections
Include etc/apache24/extra/httpd-ssl.conf</pre>
</div>
</div>
<div class="paragraph">
<p>The following lines must also be uncommented in the <span class="filename">httpd.conf</span> to fully support SSL in Apache:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>LoadModule authn_socache_module libexec/apache24/mod_authn_socache.so
LoadModule socache_shmcb_module libexec/apache24/mod_socache_shmcb.so
LoadModule ssl_module libexec/apache24/mod_ssl.so</pre>
</div>
</div>
<div class="paragraph">
<p>The next step is to work with a certificate authority to have the appropriate certificates installed on the system. This will set up a chain of trust for the site and prevent any warnings of self-signed certificates.</p>
</div>
</div>
<div class="sect4">
<h5 id="_mod_perl">32.8.3.2. <span class="filename">mod_perl</span><a class="anchor" href="#_mod_perl"></a></h5>
<div class="paragraph">
<p>The <span class="filename">mod_perl</span> module makes it possible to write Apache modules in Perl. In addition, the persistent interpreter embedded in the server avoids the overhead of starting an external interpreter and the penalty of Perl start-up time.</p>
</div>
<div class="paragraph">
<p>The <span class="filename">mod_perl</span> can be installed using the <a class="package" href="https://cgit.freebsd.org/ports/tree/www/mod_perl2/">www/mod_perl2</a> package or port. Documentation for using this module can be found at <a href="http://perl.apache.org/docs/2.0/index.html">http://perl.apache.org/docs/2.0/index.html</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="_mod_php">32.8.3.3. <span class="filename">mod_php</span><a class="anchor" href="#_mod_php"></a></h5>
<div class="paragraph">
<p><em>PHP: Hypertext Preprocessor</em> (PHP) is a general-purpose scripting language that is especially suited for web development. Capable of being embedded into HTML, its syntax draws upon C, Java™, and Perl with the intention of allowing web developers to write dynamically generated webpages quickly.</p>
</div>
<div class="paragraph">
<p>Support for PHP for Apache and any other feature written in the language, can be added by installing the appropriate port.</p>
</div>
<div class="paragraph">
<p>For all supported versions, search the package database using <code>pkg</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg search php</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A list will be displayed including the versions and additional features they provide. The components are completely modular, meaning features are enabled by installing the appropriate port. To install PHP version 7.4 for Apache, issue the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install mod_php74</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If any dependency packages need to be installed, they will be installed as well.</p>
</div>
<div class="paragraph">
<p>By default, PHP will not be enabled. The following lines will need to be added to the Apache configuration file located in <span class="filename">/usr/local/etc/apache24</span> to make it active:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>&lt;FilesMatch &#34;\.php$&#34;&gt;
    SetHandler application/x-httpd-php
&lt;/FilesMatch&gt;
&lt;FilesMatch &#34;\.phps$&#34;&gt;
    SetHandler application/x-httpd-php-source
&lt;/FilesMatch&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>In addition, the <code>DirectoryIndex</code> in the configuration file will also need to be updated and Apache will either need to be restarted or reloaded for the changes to take effect.</p>
</div>
<div class="paragraph">
<p>Support for many of the PHP features may also be installed by using <code>pkg</code>. For example, to install support for XML or SSL, install their respective ports:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install php74-xml php74-openssl</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As before, the Apache configuration will need to be reloaded for the changes to take effect, even in cases where it was just a module install.</p>
</div>
<div class="paragraph">
<p>To perform a graceful restart to reload the configuration, issue the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># apachectl graceful</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Once the install is complete, there are two methods of obtaining the installed PHP support modules and the environmental information of the build. The first is to install the full PHP binary and running the command to gain the information:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install php74</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># php -i |less</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>It is necessary to pass the output to a pager, such as the <code>more</code> or <code>less</code> to easier digest the amount of output.</p>
</div>
<div class="paragraph">
<p>Finally, to make any changes to the global configuration of PHP there is a well documented file installed into <span class="filename">/usr/local/etc/php.ini</span>. At the time of install, this file will not exist because there are two versions to choose from, one is <span class="filename">php.ini-development</span> and the other is <span class="filename">php.ini-production</span>. These are starting points to assist administrators in their deployment.</p>
</div>
</div>
<div class="sect4">
<h5 id="_http2_support">32.8.3.4. HTTP2 Support<a class="anchor" href="#_http2_support"></a></h5>
<div class="paragraph">
<p>Apache support for the HTTP2 protocol is included by default when installing the port with <code>pkg</code>. The new version of HTTP includes many improvements over the previous version, including utilizing a single connection to a website, reducing overall roundtrips of TCP connections. Also, packet header data is compressed and HTTP2 requires encryption by default.</p>
</div>
<div class="paragraph">
<p>When Apache is configured to only use HTTP2, web browsers will require secure, encrypted HTTPS connections. When Apache is configured to use both versions, HTTP1.1 will be considered a fall back option if any issues arise during the connection.</p>
</div>
<div class="paragraph">
<p>While this change does require administrators to make changes, they are positive and equate to a more secure Internet for everyone. The changes are only required for sites not currently implementing SSL and TLS.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This configuration depends on the previous sections, including TLS support. It is recommended those instructions be followed before continuing with this configuration.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Start the process by enabling the http2 module by uncommenting the line in <span class="filename">/usr/local/etc/apache24/httpd.conf</span> and replace the mpm_prefork module with mpm_event as the former does not support HTTP2.</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>LoadModule http2_module libexec/apache24/mod_http2.so
LoadModule mpm_event_module libexec/apache24/mod_mpm_event.so</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>There is a separate <span class="filename">mod_http2</span> port that is available. It exists to deliver security and bug fixes quicker than the module installed with the bundled <span class="filename">apache24</span> port. It is not required for HTTP2 support but is available. When installed, the <span class="filename">mod_h2.so</span> should be used in place of <span class="filename">mod_http2.so</span> in the Apache configuration.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>There are two methods to implement HTTP2 in Apache; one way is globally for all sites and each VirtualHost running on the system. To enable HTTP2 globally, add the following line under the ServerName directive:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>Protocols h2 http/1.1</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>To enable HTTP2 over plaintext, use h2h2chttp/1.1 in the <span class="filename">httpd.conf</span>.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Having the h2c here will allow plaintext HTTP2 data to pass on the system but is not recommended. In addition, using the http/1.1 here will allow fallback to the HTTP1.1 version of the protocol should it be needed by the system.</p>
</div>
<div class="paragraph">
<p>To enable HTTP2 for individual VirtualHosts, add the same line within the VirtualHost directive in either <span class="filename">httpd.conf</span> or <span class="filename">httpd-ssl.conf</span>.</p>
</div>
<div class="paragraph">
<p>Reload the configuration using the <code>apachectl</code><span class="parameter">reload</span> command and test the configuration either by using either of the following methods after visiting one of the hosted pages:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># grep &#34;HTTP/2.0&#34; /var/log/httpd-access.log</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This should return something similar to the following:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>192.168.1.205 - - [18/Oct/2020:18:34:36 -0400] &#34;GET / HTTP/2.0&#34; 304 -
192.0.2.205 - - [18/Oct/2020:19:19:57 -0400] &#34;GET / HTTP/2.0&#34; 304 -
192.0.0.205 - - [18/Oct/2020:19:20:52 -0400] &#34;GET / HTTP/2.0&#34; 304 -
192.0.2.205 - - [18/Oct/2020:19:23:10 -0400] &#34;GET / HTTP/2.0&#34; 304 -</pre>
</div>
</div>
<div class="paragraph">
<p>The other method is using the web browser’s built in site debugger or <code>tcpdump</code>; however, using either method is beyond the scope of this document.</p>
</div>
<div class="paragraph">
<p>Support for HTTP2 reverse proxy connections by using the <span class="filename">mod_proxy_http2.so</span> module. When configuring the ProxyPass or RewriteRules [P] statements, they should use h2:// for the connection.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_dynamic_websites">32.8.4. Dynamic Websites<a class="anchor" href="#_dynamic_websites"></a></h4>
<div class="paragraph">
<p>In addition to mod_perl and mod_php, other languages are available for creating dynamic web content. These include Django and Ruby on Rails.</p>
</div>
<div class="sect4">
<h5 id="_django">32.8.4.1. Django<a class="anchor" href="#_django"></a></h5>
<div class="paragraph">
<p>Django is a BSD-licensed framework designed to allow developers to write high performance, elegant web applications quickly. It provides an object-relational mapper so that data types are developed as Python objects. A rich dynamic database-access API is provided for those objects without the developer ever having to write SQL. It also provides an extensible template system so that the logic of the application is separated from the HTML presentation.</p>
</div>
<div class="paragraph">
<p>Django depends on <span class="filename">mod_python</span>, and an SQL database engine. In FreeBSD, the <a class="package" href="https://cgit.freebsd.org/ports/tree/www/py-django/">www/py-django</a> port automatically installs <span class="filename">mod_python</span> and supports the PostgreSQL, MySQL, or SQLite databases, with the default being SQLite. To change the database engine, type <code>make config</code> within <span class="filename">/usr/ports/www/py-django</span>, then install the port.</p>
</div>
<div class="paragraph">
<p>Once Django is installed, the application will need a project directory along with the Apache configuration in order to use the embedded Python interpreter. This interpreter is used to call the application for specific URLs on the site.</p>
</div>
<div class="paragraph">
<p>To configure Apache to pass requests for certain URLs to the web application, add the following to <span class="filename">httpd.conf</span>, specifying the full path to the project directory:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>&lt;Location &#34;/&#34;&gt;
    SetHandler python-program
    PythonPath &#34;[&#39;/dir/to/the/django/packages/&#39;] + sys.path&#34;
    PythonHandler django.core.handlers.modpython
    SetEnv DJANGO_SETTINGS_MODULE mysite.settings
    PythonAutoReload On
    PythonDebug On
&lt;/Location&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>Refer to <a href="https://docs.djangoproject.com">https://docs.djangoproject.com</a> for more information on how to use Django.</p>
</div>
</div>
<div class="sect4">
<h5 id="_ruby_on_rails">32.8.4.2. Ruby on Rails<a class="anchor" href="#_ruby_on_rails"></a></h5>
<div class="paragraph">
<p>Ruby on Rails is another open source web framework that provides a full development stack. It is optimized to make web developers more productive and capable of writing powerful applications quickly. On FreeBSD, it can be installed using the <a class="package" href="https://cgit.freebsd.org/ports/tree/www/rubygem-rails/">www/rubygem-rails</a> package or port.</p>
</div>
<div class="paragraph">
<p>Refer to <a href="http://guides.rubyonrails.org">http://guides.rubyonrails.org</a> for more information on how to use Ruby on Rails.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="network-ftp">32.9. File Transfer Protocol (FTP)<a class="anchor" href="#network-ftp"></a></h3>
<div class="paragraph">
<p>The File Transfer Protocol (FTP) provides users with a simple way to transfer files to and from an FTP server. FreeBSD includes FTP server software, ftpd, in the base system.</p>
</div>
<div class="paragraph">
<p>FreeBSD provides several configuration files for controlling access to the FTP server. This section summarizes these files. Refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=ftpd&amp;sektion=8&amp;format=html">ftpd(8)</a> for more details about the built-in FTP server.</p>
</div>
<div class="sect3">
<h4 id="_configuration_2">32.9.1. Configuration<a class="anchor" href="#_configuration_2"></a></h4>
<div class="paragraph">
<p>The most important configuration step is deciding which accounts will be allowed access to the FTP server. A FreeBSD system has a number of system accounts which should not be allowed FTP access. The list of users disallowed any FTP access can be found in <span class="filename">/etc/ftpusers</span>. By default, it includes system accounts. Additional users that should not be allowed access to FTP can be added.</p>
</div>
<div class="paragraph">
<p>In some cases it may be desirable to restrict the access of some users without preventing them completely from using FTP. This can be accomplished be creating <span class="filename">/etc/ftpchroot</span> as described in <a href="https://man.freebsd.org/cgi/man.cgi?query=ftpchroot&amp;sektion=5&amp;format=html">ftpchroot(5)</a>. This file lists users and groups subject to FTP access restrictions.</p>
</div>
<div class="paragraph">
<p>To enable anonymous FTP access to the server, create a user named <code>ftp</code> on the FreeBSD system. Users will then be able to log on to the FTP server with a username of <code>ftp</code> or <code>anonymous</code>. When prompted for the password, any input will be accepted, but by convention, an email address should be used as the password. The FTP server will call <a href="https://man.freebsd.org/cgi/man.cgi?query=chroot&amp;sektion=2&amp;format=html">chroot(2)</a> when an anonymous user logs in, to restrict access to only the home directory of the <code>ftp</code> user.</p>
</div>
<div class="paragraph">
<p>There are two text files that can be created to specify welcome messages to be displayed to FTP clients. The contents of <span class="filename">/etc/ftpwelcome</span> will be displayed to users before they reach the login prompt. After a successful login, the contents of <span class="filename">/etc/ftpmotd</span> will be displayed. Note that the path to this file is relative to the login environment, so the contents of <span class="filename">~ftp/etc/ftpmotd</span> would be displayed for anonymous users.</p>
</div>
<div class="paragraph">
<p>Once the FTP server has been configured, set the appropriate variable in <span class="filename">/etc/rc.conf</span> to start the service during boot:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>ftpd_enable=&#34;YES&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>To start the service now:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># service ftpd start</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Test the connection to the FTP server by typing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>ftp localhost</code></pre>
</div>
</div>
<div class="paragraph">
<p>The ftpd daemon uses <a href="https://man.freebsd.org/cgi/man.cgi?query=syslog&amp;sektion=3&amp;format=html">syslog(3)</a> to log messages. By default, the system log daemon will write messages related to FTP in <span class="filename">/var/log/xferlog</span>. The location of the FTP log can be modified by changing the following line in <span class="filename">/etc/syslog.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>ftp.info      /var/log/xferlog</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Be aware of the potential problems involved with running an anonymous FTP server. In particular, think twice about allowing anonymous users to upload files. It may turn out that the FTP site becomes a forum for the trade of unlicensed commercial software or worse. If anonymous FTP uploads are required, then verify the permissions so that these files cannot be read by other anonymous users until they have been reviewed by an administrator.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="network-samba">32.10. File and Print Services for Microsoft® Windows® Clients (Samba)<a class="anchor" href="#network-samba"></a></h3>
<div class="paragraph">
<p>Samba is a popular open source software package that provides file and print services using the SMB/CIFS protocol. This protocol is built into Microsoft® Windows® systems. It can be added to non-Microsoft® Windows® systems by installing the Samba client libraries. The protocol allows clients to access shared data and printers. These shares can be mapped as a local disk drive and shared printers can be used as if they were local printers.</p>
</div>
<div class="paragraph">
<p>On FreeBSD, the Samba client libraries can be installed using the <a class="package" href="https://cgit.freebsd.org/ports/tree/net/samba413/">net/samba413</a> port or package. The client provides the ability for a FreeBSD system to access SMB/CIFS shares in a Microsoft® Windows® network.</p>
</div>
<div class="paragraph">
<p>A FreeBSD system can also be configured to act as a Samba server by installing the same <a class="package" href="https://cgit.freebsd.org/ports/tree/net/samba413/">net/samba413</a> port or package. This allows the administrator to create SMB/CIFS shares on the FreeBSD system which can be accessed by clients running Microsoft® Windows® or the Samba client libraries.</p>
</div>
<div class="sect3">
<h4 id="_server_configuration">32.10.1. Server Configuration<a class="anchor" href="#_server_configuration"></a></h4>
<div class="paragraph">
<p>Samba is configured in <span class="filename">/usr/local/etc/smb4.conf</span>. This file must be created before Samba can be used.</p>
</div>
<div class="paragraph">
<p>A simple <span class="filename">smb4.conf</span> to share directories and printers with Windows® clients in a workgroup is shown here. For more complex setups involving LDAP or Active Directory, it is easier to use <a href="https://man.freebsd.org/cgi/man.cgi?query=samba-tool&amp;sektion=8&amp;format=html">samba-tool(8)</a> to create the initial <span class="filename">smb4.conf</span>.</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>[global]
workgroup = WORKGROUP
server string = Samba Server Version %v
netbios name = ExampleMachine
wins support = Yes
security = user
passdb backend = tdbsam

# Example: share /usr/src accessible only to &#39;developer&#39; user
[src]
path = /usr/src
valid users = developer
writable  = yes
browsable = yes
read only = no
guest ok = no
public = no
create mask = 0666
directory mask = 0755</pre>
</div>
</div>
<div class="sect4">
<h5 id="_global_settings">32.10.1.1. Global Settings<a class="anchor" href="#_global_settings"></a></h5>
<div class="paragraph">
<p>Settings that describe the network are added in <span class="filename">/usr/local/etc/smb4.conf</span>:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>workgroup</code></dt>
<dd>
<p>The name of the workgroup to be served.</p>
</dd>
<dt class="hdlist1"><code>netbios name</code></dt>
<dd>
<p>The NetBIOS name by which a Samba server is known. By default, it is the same as the first component of the host’s DNS name.</p>
</dd>
<dt class="hdlist1"><code>server string</code></dt>
<dd>
<p>The string that will be displayed in the output of <code>net view</code> and some other networking tools that seek to display descriptive text about the server.</p>
</dd>
<dt class="hdlist1"><code>wins support</code></dt>
<dd>
<p>Whether Samba will act as a WINS server. Do not enable support for WINS on more than one server on the network.</p>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="_security_settings">32.10.1.2. Security Settings<a class="anchor" href="#_security_settings"></a></h5>
<div class="paragraph">
<p>The most important settings in <span class="filename">/usr/local/etc/smb4.conf</span> are the security model and the backend password format. These directives control the options:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>security</code></dt>
<dd>
<p>The most common settings are <code>security = share</code> and <code>security = user</code>. If the clients use usernames that are the same as their usernames on the FreeBSD machine, user level security should be used. This is the default security policy and it requires clients to first log on before they can access shared resources.</p>
<div class="paragraph">
<p>In share level security, clients do not need to log onto the server with a valid username and password before attempting to connect to a shared resource. This was the default security model for older versions of Samba.</p>
</div>
</dd>
<dt class="hdlist1"><code>passdb backend</code></dt>
<dd>
<p>Samba has several different backend authentication models. Clients may be authenticated with LDAP, NIS+, an SQL database, or a modified password file. The recommended authentication method, <code>tdbsam</code>, is ideal for simple networks and is covered here. For larger or more complex networks, <code>ldapsam</code> is recommended. <code>smbpasswd</code> was the former default and is now obsolete.</p>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="_samba_users">32.10.1.3. Samba Users<a class="anchor" href="#_samba_users"></a></h5>
<div class="paragraph">
<p>FreeBSD user accounts must be mapped to the <code>SambaSAMAccount</code> database for Windows® clients to access the share. Map existing FreeBSD user accounts using <a href="https://man.freebsd.org/cgi/man.cgi?query=pdbedit&amp;sektion=8&amp;format=html">pdbedit(8)</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pdbedit -a -u username</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This section has only mentioned the most commonly used settings. Refer to the <a href="https://wiki.samba.org">Official Samba Wiki</a> for additional information about the available configuration options.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_starting_samba">32.10.2. Starting Samba<a class="anchor" href="#_starting_samba"></a></h4>
<div class="paragraph">
<p>To enable Samba at boot time, add the following line to <span class="filename">/etc/rc.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>samba_server_enable=&#34;YES&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>To start Samba now:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># service samba_server start</span>
Performing sanity check on Samba configuration: OK
Starting nmbd.
Starting smbd.</code></pre>
</div>
</div>
<div class="paragraph">
<p>Samba consists of three separate daemons. Both the nmbd and smbd daemons are started by <code>samba_enable</code>. If winbind name resolution is also required, set:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>winbindd_enable=&#34;YES&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>Samba can be stopped at any time by typing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># service samba_server stop</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Samba is a complex software suite with functionality that allows broad integration with Microsoft® Windows® networks. For more information about functionality beyond the basic configuration described here, refer to <a href="https://www.samba.org">https://www.samba.org</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="network-ntp">32.11. Clock Synchronization with NTP<a class="anchor" href="#network-ntp"></a></h3>
<div class="paragraph">
<p>Over time, a computer’s clock is prone to drift. This is problematic as many network services require the computers on a network to share the same accurate time. Accurate time is also needed to ensure that file timestamps stay consistent. The Network Time Protocol (NTP) is one way to provide clock accuracy in a network.</p>
</div>
<div class="paragraph">
<p>FreeBSD includes <a href="https://man.freebsd.org/cgi/man.cgi?query=ntpd&amp;sektion=8&amp;format=html">ntpd(8)</a> which can be configured to query other NTP servers to synchronize the clock on that machine or to provide time services to other computers in the network.</p>
</div>
<div class="paragraph">
<p>This section describes how to configure ntpd on FreeBSD. Further documentation can be found in <span class="filename">/usr/share/doc/ntp/</span> in HTML format.</p>
</div>
<div class="sect3">
<h4 id="_ntp_configuration">32.11.1. NTP Configuration<a class="anchor" href="#_ntp_configuration"></a></h4>
<div class="paragraph">
<p>On FreeBSD, the built-in ntpd can be used to synchronize a system’s clock. ntpd is configured using <a href="https://man.freebsd.org/cgi/man.cgi?query=rc.conf&amp;sektion=5&amp;format=html">rc.conf(5)</a> variables and <span class="filename">/etc/ntp.conf</span>, as detailed in the following sections.</p>
</div>
<div class="paragraph">
<p>ntpd communicates with its network peers using UDP packets. Any firewalls between your machine and its NTP peers must be configured to allow UDP packets in and out on port 123.</p>
</div>
<div class="sect4">
<h5 id="_the_etcntp_conf_file">32.11.1.1. The <span class="filename">/etc/ntp.conf</span> file<a class="anchor" href="#_the_etcntp_conf_file"></a></h5>
<div class="paragraph">
<p>ntpd reads <span class="filename">/etc/ntp.conf</span> to determine which NTP servers to query. Choosing several NTP servers is recommended in case one of the servers becomes unreachable or its clock proves unreliable. As ntpd receives responses, it favors reliable servers over the less reliable ones. The servers which are queried can be local to the network, provided by an ISP, or selected from an <a href="http://support.ntp.org/bin/view/Servers/WebHome"> online list of publicly accessible NTP servers</a>. When choosing a public NTP server, select one that is geographically close and review its usage policy. The <code>pool</code> configuration keyword selects one or more servers from a pool of servers. An <a href="http://support.ntp.org/bin/view/Servers/NTPPoolServers"> online list of publicly accessible NTP pools</a> is available, organized by geographic area. In addition, FreeBSD provides a project-sponsored pool, <code>0.freebsd.pool.ntp.org</code>.</p>
</div>
<div class="exampleblock">
<div class="title">例 37. Sample <span class="filename">/etc/ntp.conf</span></div>
<div class="content">
<div class="paragraph">
<p>This is a simple example of an <span class="filename">ntp.conf</span> file. It can safely be used as-is; it contains the recommended <code>restrict</code> options for operation on a publicly-accessible network connection.</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre># Disallow ntpq control/query access.  Allow peers to be added only
# based on pool and server statements in this file.
restrict default limited kod nomodify notrap noquery nopeer
restrict source  limited kod nomodify notrap noquery

# Allow unrestricted access from localhost for queries and control.
restrict 127.0.0.1
restrict ::1

# Add a specific server.
server ntplocal.example.com iburst

# Add FreeBSD pool servers until 3-6 good servers are available.
tos minclock 3 maxclock 6
pool 0.freebsd.pool.ntp.org iburst

# Use a local leap-seconds file.
leapfile &#34;/var/db/ntpd.leap-seconds.list&#34;</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The format of this file is described in <a href="https://man.freebsd.org/cgi/man.cgi?query=ntp.conf&amp;sektion=5&amp;format=html">ntp.conf(5)</a>. The descriptions below provide a quick overview of just the keywords used in the sample file above.</p>
</div>
<div class="paragraph">
<p>By default, an NTP server is accessible to any network host. The <code>restrict</code> keyword controls which systems can access the server. Multiple <code>restrict</code> entries are supported, each one refining the restrictions given in previous statements. The values shown in the example grant the local system full query and control access, while allowing remote systems only the ability to query the time. For more details, refer to the <code>Access Control Support</code> subsection of <a href="https://man.freebsd.org/cgi/man.cgi?query=ntp.conf&amp;sektion=5&amp;format=html">ntp.conf(5)</a>.</p>
</div>
<div class="paragraph">
<p>The <code>server</code> keyword specifies a single server to query. The file can contain multiple server keywords, with one server listed on each line. The <code>pool</code> keyword specifies a pool of servers. ntpd will add one or more servers from this pool as needed to reach the number of peers specified using the <code>tos minclock</code> value. The <code>iburst</code> keyword directs ntpd to perform a burst of eight quick packet exchanges with a server when contact is first established, to help quickly synchronize system time.</p>
</div>
<div class="paragraph">
<p>The <code>leapfile</code> keyword specifies the location of a file containing information about leap seconds. The file is updated automatically by <a href="https://man.freebsd.org/cgi/man.cgi?query=periodic&amp;sektion=8&amp;format=html">periodic(8)</a>. The file location specified by this keyword must match the location set in the <code>ntp_db_leapfile</code> variable in <span class="filename">/etc/rc.conf</span>.</p>
</div>
</div>
<div class="sect4">
<h5 id="_ntp_entries_in_etcrc_conf">32.11.1.2. NTP entries in <span class="filename">/etc/rc.conf</span><a class="anchor" href="#_ntp_entries_in_etcrc_conf"></a></h5>
<div class="paragraph">
<p>Set <code>ntpd_enable=YES</code> to start ntpd at boot time. Once <code>ntpd_enable=YES</code> has been added to <span class="filename">/etc/rc.conf</span>, ntpd can be started immediately without rebooting the system by typing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># service ntpd start</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Only <code>ntpd_enable</code> must be set to use ntpd. The <span class="filename">rc.conf</span> variables listed below may also be set as needed.</p>
</div>
<div class="paragraph">
<p>Set <code>ntpd_sync_on_start=YES</code> to allow ntpd to step the clock any amount, one time at startup. Normally ntpd will log an error message and exit if the clock is off by more than 1000 seconds. This option is especially useful on systems without a battery-backed realtime clock.</p>
</div>
<div class="paragraph">
<p>Set <code>ntpd_oomprotect=YES</code> to protect the ntpd daemon from being killed by the system attempting to recover from an Out Of Memory (OOM) condition.</p>
</div>
<div class="paragraph">
<p>Set <code>ntpd_config=</code> to the location of an alternate <span class="filename">ntp.conf</span> file.</p>
</div>
<div class="paragraph">
<p>Set <code>ntpd_flags=</code> to contain any other ntpd flags as needed, but avoid using these flags which are managed internally by <span class="filename">/etc/rc.d/ntpd</span>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>-p</code> (pid file location)</p>
</li>
<li>
<p><code>-c</code> (set <code>ntpd_config=</code> instead)</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_ntpd_and_the_unpriveleged_ntpd_user">32.11.1.3. ntpd and the unpriveleged <code>ntpd</code> user<a class="anchor" href="#_ntpd_and_the_unpriveleged_ntpd_user"></a></h5>
<div class="paragraph">
<p>ntpd on FreeBSD can start and run as an unpriveleged user. Doing so requires the <a href="https://man.freebsd.org/cgi/man.cgi?query=mac_ntpd&amp;sektion=4&amp;format=html">mac_ntpd(4)</a> policy module. The <span class="filename">/etc/rc.d/ntpd</span> startup script first examines the NTP configuration. If possible, it loads the <code>mac_ntpd</code> module, then starts ntpd as unpriveleged user <code>ntpd</code> (user id 123). To avoid problems with file and directory access, the startup script will not automatically start ntpd as <code>ntpd</code> when the configuration contains any file-related options.</p>
</div>
<div class="paragraph">
<p>The presence of any of the following in <code>ntpd_flags</code> requires manual configuration as described below to run as the <code>ntpd</code> user:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>-f or --driftfile</p>
</li>
<li>
<p>-i or --jaildir</p>
</li>
<li>
<p>-k or --keyfile</p>
</li>
<li>
<p>-l or --logfile</p>
</li>
<li>
<p>-s or --statsdir</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The presence of any of the following keywords in <span class="filename">ntp.conf</span> requires manual configuration as described below to run as the <code>ntpd</code> user:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>crypto</p>
</li>
<li>
<p>driftfile</p>
</li>
<li>
<p>key</p>
</li>
<li>
<p>logdir</p>
</li>
<li>
<p>statsdir</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To manually configure ntpd to run as user <code>ntpd</code> you must:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Ensure that the <code>ntpd</code> user has access to all the files and directories specified in the configuration.</p>
</li>
<li>
<p>Arrange for the <code>mac_ntpd</code> module to be loaded or compiled into the kernel. See <a href="https://man.freebsd.org/cgi/man.cgi?query=mac_ntpd&amp;sektion=4&amp;format=html">mac_ntpd(4)</a> for details.</p>
</li>
<li>
<p>Set <code>ntpd_user=&#34;ntpd&#34;</code> in <span class="filename">/etc/rc.conf</span></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_using_ntp_with_a_ppp_connection">32.11.2. Using NTP with a PPP Connection<a class="anchor" href="#_using_ntp_with_a_ppp_connection"></a></h4>
<div class="paragraph">
<p>ntpd does not need a permanent connection to the Internet to function properly. However, if a PPP connection is configured to dial out on demand, NTP traffic should be prevented from triggering a dial out or keeping the connection alive. This can be configured with <code>filter</code> directives in <span class="filename">/etc/ppp/ppp.conf</span>. For example:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>set filter dial 0 deny udp src eq 123
# Prevent NTP traffic from initiating dial out
set filter dial 1 permit 0 0
set filter alive 0 deny udp src eq 123
# Prevent incoming NTP traffic from keeping the connection open
set filter alive 1 deny udp dst eq 123
# Prevent outgoing NTP traffic from keeping the connection open
set filter alive 2 permit 0/0 0/0</pre>
</div>
</div>
<div class="paragraph">
<p>For more details, refer to the <code>PACKET FILTERING</code> section in <a href="https://man.freebsd.org/cgi/man.cgi?query=ppp&amp;sektion=8&amp;format=html">ppp(8)</a> and the examples in <span class="filename">/usr/share/examples/ppp/</span>.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Some Internet access providers block low-numbered ports, preventing NTP from functioning since replies never reach the machine.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="network-iscsi">32.12. iSCSI Initiator and Target Configuration<a class="anchor" href="#network-iscsi"></a></h3>
<div class="paragraph">
<p>iSCSI is a way to share storage over a network. Unlike NFS, which works at the file system level, iSCSI works at the block device level.</p>
</div>
<div class="paragraph">
<p>In iSCSI terminology, the system that shares the storage is known as the <em>target</em>. The storage can be a physical disk, or an area representing multiple disks or a portion of a physical disk. For example, if the disk(s) are formatted with ZFS, a zvol can be created to use as the iSCSI storage.</p>
</div>
<div class="paragraph">
<p>The clients which access the iSCSI storage are called <em>initiators</em>. To initiators, the storage available through iSCSI appears as a raw, unformatted disk known as a LUN. Device nodes for the disk appear in <span class="filename">/dev/</span> and the device must be separately formatted and mounted.</p>
</div>
<div class="paragraph">
<p>FreeBSD provides a native, kernel-based iSCSI target and initiator. This section describes how to configure a FreeBSD system as a target or an initiator.</p>
</div>
<div class="sect3">
<h4 id="network-iscsi-target">32.12.1. Configuring an iSCSI Target<a class="anchor" href="#network-iscsi-target"></a></h4>
<div class="paragraph">
<p>To configure an iSCSI target, create the <span class="filename">/etc/ctl.conf</span> configuration file, add a line to <span class="filename">/etc/rc.conf</span> to make sure the <a href="https://man.freebsd.org/cgi/man.cgi?query=ctld&amp;sektion=8&amp;format=html">ctld(8)</a> daemon is automatically started at boot, and then start the daemon.</p>
</div>
<div class="paragraph">
<p>The following is an example of a simple <span class="filename">/etc/ctl.conf</span> configuration file. Refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=ctl.conf&amp;sektion=5&amp;format=html">ctl.conf(5)</a> for a more complete description of this file’s available options.</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>portal-group pg0 {
	discovery-auth-group no-authentication
	listen 0.0.0.0
	listen [::]
}

target iqn.2012-06.com.example:target0 {
	auth-group no-authentication
	portal-group pg0

	lun 0 {
		path /data/target0-0
		size 4G
	}
}</pre>
</div>
</div>
<div class="paragraph">
<p>The first entry defines the <code>pg0</code> portal group. Portal groups define which network addresses the <a href="https://man.freebsd.org/cgi/man.cgi?query=ctld&amp;sektion=8&amp;format=html">ctld(8)</a> daemon will listen on. The <code>discovery-auth-group no-authentication</code> entry indicates that any initiator is allowed to perform iSCSI target discovery without authentication. Lines three and four configure <a href="https://man.freebsd.org/cgi/man.cgi?query=ctld&amp;sektion=8&amp;format=html">ctld(8)</a> to listen on all IPv4 (<code>listen 0.0.0.0</code>) and IPv6 (<code>listen [::]</code>) addresses on the default port of 3260.</p>
</div>
<div class="paragraph">
<p>It is not necessary to define a portal group as there is a built-in portal group called <code>default</code>. In this case, the difference between <code>default</code> and <code>pg0</code> is that with <code>default</code>, target discovery is always denied, while with <code>pg0</code>, it is always allowed.</p>
</div>
<div class="paragraph">
<p>The second entry defines a single target. Target has two possible meanings: a machine serving iSCSI or a named group of LUNs. This example uses the latter meaning, where <code>iqn.2012-06.com.example:target0</code> is the target name. This target name is suitable for testing purposes. For actual use, change <code>com.example</code> to the real domain name, reversed. The <code>2012-06</code> represents the year and month of acquiring control of that domain name, and <code>target0</code> can be any value. Any number of targets can be defined in this configuration file.</p>
</div>
<div class="paragraph">
<p>The <code>auth-group no-authentication</code> line allows all initiators to connect to the specified target and <code>portal-group pg0</code> makes the target reachable through the <code>pg0</code> portal group.</p>
</div>
<div class="paragraph">
<p>The next section defines the LUN. To the initiator, each LUN will be visible as a separate disk device. Multiple LUNs can be defined for each target. Each LUN is identified by a number, where LUN 0 is mandatory. The <code>path /data/target0-0</code> line defines the full path to a file or zvol backing the LUN. That path must exist before starting <a href="https://man.freebsd.org/cgi/man.cgi?query=ctld&amp;sektion=8&amp;format=html">ctld(8)</a>. The second line is optional and specifies the size of the LUN.</p>
</div>
<div class="paragraph">
<p>Next, to make sure the <a href="https://man.freebsd.org/cgi/man.cgi?query=ctld&amp;sektion=8&amp;format=html">ctld(8)</a> daemon is started at boot, add this line to <span class="filename">/etc/rc.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>ctld_enable=&#34;YES&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>To start <a href="https://man.freebsd.org/cgi/man.cgi?query=ctld&amp;sektion=8&amp;format=html">ctld(8)</a> now, run this command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># service ctld start</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As the <a href="https://man.freebsd.org/cgi/man.cgi?query=ctld&amp;sektion=8&amp;format=html">ctld(8)</a> daemon is started, it reads <span class="filename">/etc/ctl.conf</span>. If this file is edited after the daemon starts, use this command so that the changes take effect immediately:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># service ctld reload</span></code></pre>
</div>
</div>
<div class="sect4">
<h5 id="_authentication">32.12.1.1. Authentication<a class="anchor" href="#_authentication"></a></h5>
<div class="paragraph">
<p>The previous example is inherently insecure as it uses no authentication, granting anyone full access to all targets. To require a username and password to access targets, modify the configuration as follows:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>auth-group ag0 {
	chap username1 secretsecret
	chap username2 anothersecret
}

portal-group pg0 {
	discovery-auth-group no-authentication
	listen 0.0.0.0
	listen [::]
}

target iqn.2012-06.com.example:target0 {
	auth-group ag0
	portal-group pg0
	lun 0 {
		path /data/target0-0
		size 4G
	}
}</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>auth-group</code> section defines username and password pairs. An initiator trying to connect to <code>iqn.2012-06.com.example:target0</code> must first specify a defined username and secret. However, target discovery is still permitted without authentication. To require target discovery authentication, set <code>discovery-auth-group</code> to a defined <code>auth-group</code> name instead of <code>no-authentication</code>.</p>
</div>
<div class="paragraph">
<p>It is common to define a single exported target for every initiator. As a shorthand for the syntax above, the username and password can be specified directly in the target entry:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>target iqn.2012-06.com.example:target0 {
	portal-group pg0
	chap username1 secretsecret

	lun 0 {
		path /data/target0-0
		size 4G
	}
}</pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="network-iscsi-initiator">32.12.2. Configuring an iSCSI Initiator<a class="anchor" href="#network-iscsi-initiator"></a></h4>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The iSCSI initiator described in this section is supported starting with FreeBSD 10.0-RELEASE. To use the iSCSI initiator available in older versions, refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=iscontrol&amp;sektion=8&amp;format=html">iscontrol(8)</a>.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>The iSCSI initiator requires that the <a href="https://man.freebsd.org/cgi/man.cgi?query=iscsid&amp;sektion=8&amp;format=html">iscsid(8)</a> daemon is running. This daemon does not use a configuration file. To start it automatically at boot, add this line to <span class="filename">/etc/rc.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>iscsid_enable=&#34;YES&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>To start <a href="https://man.freebsd.org/cgi/man.cgi?query=iscsid&amp;sektion=8&amp;format=html">iscsid(8)</a> now, run this command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># service iscsid start</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Connecting to a target can be done with or without an <span class="filename">/etc/iscsi.conf</span> configuration file. This section demonstrates both types of connections.</p>
</div>
<div class="sect4">
<h5 id="_connecting_to_a_target_without_a_configuration_file">32.12.2.1. Connecting to a Target Without a Configuration File<a class="anchor" href="#_connecting_to_a_target_without_a_configuration_file"></a></h5>
<div class="paragraph">
<p>To connect an initiator to a single target, specify the IP address of the portal and the name of the target:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># iscsictl -A -p 10.10.10.10 -t iqn.2012-06.com.example:target0</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To verify if the connection succeeded, run <code>iscsictl</code> without any arguments. The output should look similar to this:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>Target name                                     Target portal   State
iqn.2012-06.com.example:target0                 10.10.10.10     Connected: da0</pre>
</div>
</div>
<div class="paragraph">
<p>In this example, the iSCSI session was successfully established, with <span class="filename">/dev/da0</span> representing the attached LUN. If the <code>iqn.2012-06.com.example:target0</code> target exports more than one LUN, multiple device nodes will be shown in that section of the output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">Connected: da0 da1 da2.</code></pre>
</div>
</div>
<div class="paragraph">
<p>Any errors will be reported in the output, as well as the system logs. For example, this message usually means that the <a href="https://man.freebsd.org/cgi/man.cgi?query=iscsid&amp;sektion=8&amp;format=html">iscsid(8)</a> daemon is not running:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>Target name                                     Target portal   State
iqn.2012-06.com.example:target0                 10.10.10.10     Waiting for iscsid(8)</pre>
</div>
</div>
<div class="paragraph">
<p>The following message suggests a networking problem, such as a wrong IP address or port:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>Target name                                     Target portal   State
iqn.2012-06.com.example:target0                 10.10.10.11     Connection refused</pre>
</div>
</div>
<div class="paragraph">
<p>This message means that the specified target name is wrong:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>Target name                                     Target portal   State
iqn.2012-06.com.example:target0                 10.10.10.10     Not found</pre>
</div>
</div>
<div class="paragraph">
<p>This message means that the target requires authentication:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>Target name                                     Target portal   State
iqn.2012-06.com.example:target0                 10.10.10.10     Authentication failed</pre>
</div>
</div>
<div class="paragraph">
<p>To specify a CHAP username and secret, use this syntax:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># iscsictl -A -p 10.10.10.10 -t iqn.2012-06.com.example:target0 -u user -s secretsecret</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_connecting_to_a_target_with_a_configuration_file">32.12.2.2. Connecting to a Target with a Configuration File<a class="anchor" href="#_connecting_to_a_target_with_a_configuration_file"></a></h5>
<div class="paragraph">
<p>To connect using a configuration file, create <span class="filename">/etc/iscsi.conf</span> with contents like this:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>t0 {
	TargetAddress   = 10.10.10.10
	TargetName      = iqn.2012-06.com.example:target0
	AuthMethod      = CHAP
	chapIName       = user
	chapSecret      = secretsecret
}</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>t0</code> specifies a nickname for the configuration file section. It will be used by the initiator to specify which configuration to use. The other lines specify the parameters to use during connection. The <code>TargetAddress</code> and <code>TargetName</code> are mandatory, whereas the other options are optional. In this example, the CHAP username and secret are shown.</p>
</div>
<div class="paragraph">
<p>To connect to the defined target, specify the nickname:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># iscsictl -An t0</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternately, to connect to all targets defined in the configuration file, use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># iscsictl -Aa</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To make the initiator automatically connect to all targets in <span class="filename">/etc/iscsi.conf</span>, add the following to <span class="filename">/etc/rc.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>iscsictl_enable=&#34;YES&#34;
iscsictl_flags=&#34;-Aa&#34;</pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="firewalls">Chapter 33. Firewalls<a class="anchor" href="#firewalls"></a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="firewalls-intro">33.1. Synopsis<a class="anchor" href="#firewalls-intro"></a></h3>
<div class="paragraph">
<p>Firewalls make it possible to filter the incoming and outgoing traffic that flows through a system. A firewall can use one or more sets of &#34;rules&#34; to inspect network packets as they come in or go out of network connections and either allows the traffic through or blocks it. The rules of a firewall can inspect one or more characteristics of the packets such as the protocol type, source or destination host address, and source or destination port.</p>
</div>
<div class="paragraph">
<p>Firewalls can enhance the security of a host or a network. They can be used to do one or more of the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Protect and insulate the applications, services, and machines of an internal network from unwanted traffic from the public Internet.</p>
</li>
<li>
<p>Limit or disable access from hosts of the internal network to services of the public Internet.</p>
</li>
<li>
<p>Support network address translation (NAT), which allows an internal network to use private IP addresses and share a single connection to the public Internet using either a single IP address or a shared pool of automatically assigned public addresses.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>FreeBSD has three firewalls built into the base system: PF, IPFW, and IPFILTER, also known as IPF. FreeBSD also provides two traffic shapers for controlling bandwidth usage: <a href="https://man.freebsd.org/cgi/man.cgi?query=altq&amp;sektion=4&amp;format=html">altq(4)</a> and <a href="https://man.freebsd.org/cgi/man.cgi?query=dummynet&amp;sektion=4&amp;format=html">dummynet(4)</a>. ALTQ has traditionally been closely tied with PF and dummynet with IPFW. Each firewall uses rules to control the access of packets to and from a FreeBSD system, although they go about it in different ways and each has a different rule syntax.</p>
</div>
<div class="paragraph">
<p>FreeBSD provides multiple firewalls in order to meet the different requirements and preferences for a wide variety of users. Each user should evaluate which firewall best meets their needs.</p>
</div>
<div class="paragraph">
<p>After reading this chapter, you will know:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>How to define packet filtering rules.</p>
</li>
<li>
<p>The differences between the firewalls built into FreeBSD.</p>
</li>
<li>
<p>How to use and configure the PF firewall.</p>
</li>
<li>
<p>How to use and configure the IPFW firewall.</p>
</li>
<li>
<p>How to use and configure the IPFILTER firewall.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Before reading this chapter, you should:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Understand basic FreeBSD and Internet concepts.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Since all firewalls are based on inspecting the values of selected packet control fields, the creator of the firewall ruleset must have an understanding of how TCP/IP works, what the different values in the packet control fields are, and how these values are used in a normal session conversation. For a good introduction, refer to <a href="http://www.ipprimer.com">Daryl’s TCP/IP Primer</a>.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect2">
<h3 id="firewalls-concepts">33.2. Firewall Concepts<a class="anchor" href="#firewalls-concepts"></a></h3>
<div class="paragraph">
<p>A ruleset contains a group of rules which pass or block packets based on the values contained in the packet. The bi-directional exchange of packets between hosts comprises a session conversation. The firewall ruleset processes both the packets arriving from the public Internet, as well as the packets produced by the system as a response to them. Each TCP/IP service is predefined by its protocol and listening port. Packets destined for a specific service originate from the source address using an unprivileged port and target the specific service port on the destination address. All the above parameters can be used as selection criteria to create rules which will pass or block services.</p>
</div>
<div class="paragraph">
<p>To lookup unknown port numbers, refer to <span class="filename">/etc/services</span>. Alternatively, visit <a href="http://en.wikipedia.org/wiki/List_of_TCP_and_UDP_port_numbers">http://en.wikipedia.org/wiki/List_of_TCP_and_UDP_port_numbers</a> and do a port number lookup to find the purpose of a particular port number.</p>
</div>
<div class="paragraph">
<p>Check out this link for <a href="http://web.archive.org/web/20150803024617/http://www.sans.org/security-resources/idfaq/oddports.php">port numbers used by Trojans</a>.</p>
</div>
<div class="paragraph">
<p>FTP has two modes: active mode and passive mode. The difference is in how the data channel is acquired. Passive mode is more secure as the data channel is acquired by the ordinal ftp session requester. For a good explanation of FTP and the different modes, see <a href="http://www.slacksite.com/other/ftp.html">http://www.slacksite.com/other/ftp.html</a>.</p>
</div>
<div class="paragraph">
<p>A firewall ruleset can be either &#34;exclusive&#34; or &#34;inclusive&#34;. An exclusive firewall allows all traffic through except for the traffic matching the ruleset. An inclusive firewall does the reverse as it only allows traffic matching the rules through and blocks everything else.</p>
</div>
<div class="paragraph">
<p>An inclusive firewall offers better control of the outgoing traffic, making it a better choice for systems that offer services to the public Internet. It also controls the type of traffic originating from the public Internet that can gain access to a private network. All traffic that does not match the rules is blocked and logged. Inclusive firewalls are generally safer than exclusive firewalls because they significantly reduce the risk of allowing unwanted traffic.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Unless noted otherwise, all configuration and example rulesets in this chapter create inclusive firewall rulesets.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Security can be tightened further using a &#34;stateful firewall&#34;. This type of firewall keeps track of open connections and only allows traffic which either matches an existing connection or opens a new, allowed connection.</p>
</div>
<div class="paragraph">
<p>Stateful filtering treats traffic as a bi-directional exchange of packets comprising a session. When state is specified on a matching rule the firewall dynamically generates internal rules for each anticipated packet being exchanged during the session. It has sufficient matching capabilities to determine if a packet is valid for a session. Any packets that do not properly fit the session template are automatically rejected.</p>
</div>
<div class="paragraph">
<p>When the session completes, it is removed from the dynamic state table.</p>
</div>
<div class="paragraph">
<p>Stateful filtering allows one to focus on blocking/passing new sessions. If the new session is passed, all its subsequent packets are allowed automatically and any impostor packets are automatically rejected. If a new session is blocked, none of its subsequent packets are allowed. Stateful filtering provides advanced matching abilities capable of defending against the flood of different attack methods employed by attackers.</p>
</div>
<div class="paragraph">
<p>NAT stands for <em>Network Address Translation</em>. NAT function enables the private LAN behind the firewall to share a single ISP-assigned IP address, even if that address is dynamically assigned. NAT allows each computer in the LAN to have Internet access, without having to pay the ISP for multiple Internet accounts or IP addresses.</p>
</div>
<div class="paragraph">
<p>NAT will automatically translate the private LAN IP address for each system on the LAN to the single public IP address as packets exit the firewall bound for the public Internet. It also performs the reverse translation for returning packets.</p>
</div>
<div class="paragraph">
<p>According to RFC 1918, the following IP address ranges are reserved for private networks which will never be routed directly to the public Internet, and therefore are available for use with NAT:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>10.0.0.0/8</code>.</p>
</li>
<li>
<p><code>172.16.0.0/12</code>.</p>
</li>
<li>
<p><code>192.168.0.0/16</code>.</p>
</li>
</ul>
</div>
<div class="admonitionblock warning">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When working with the firewall rules, be <em>very careful</em>. Some configurations <em>can lock the administrator out</em> of the server. To be on the safe side, consider performing the initial firewall configuration from the local console rather than doing it remotely over ssh.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect2">
<h3 id="firewalls-pf">33.3. PF<a class="anchor" href="#firewalls-pf"></a></h3>
<div class="paragraph">
<p>Since FreeBSD 5.3, a ported version of OpenBSD’s PF firewall has been included as an integrated part of the base system. PF is a complete, full-featured firewall that has optional support for ALTQ (Alternate Queuing), which provides Quality of Service (QoS).</p>
</div>
<div class="paragraph">
<p>The OpenBSD Project maintains the definitive reference for PF in the <a href="http://www.openbsd.org/faq/pf/">PF FAQ</a>. Peter Hansteen maintains a thorough PF tutorial at <a href="http://home.nuug.no/~peter/pf/">http://home.nuug.no/~peter/pf/</a>.</p>
</div>
<div class="admonitionblock warning">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When reading the <a href="http://www.openbsd.org/faq/pf/">PF FAQ</a>, keep in mind that FreeBSD’s version of PF has diverged substantially from the upstream OpenBSD version over the years. Not all features work the same way on FreeBSD as they do in OpenBSD and vice versa.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>The {freebsd-pf} is a good place to ask questions about configuring and running the PF firewall. Check the mailing list archives before asking a question as it may have already been answered.</p>
</div>
<div class="paragraph">
<p>This section of the Handbook focuses on PF as it pertains to FreeBSD. It demonstrates how to enable PF and ALTQ. It also provides several examples for creating rulesets on a FreeBSD system.</p>
</div>
<div class="sect3">
<h4 id="_enabling_pf">33.3.1. Enabling PF<a class="anchor" href="#_enabling_pf"></a></h4>
<div class="paragraph">
<p>To use PF, its kernel module must be first loaded. This section describes the entries that can be added to <span class="filename">/etc/rc.conf</span> to enable PF.</p>
</div>
<div class="paragraph">
<p>Start by adding <code>pf_enable=yes</code> to <span class="filename">/etc/rc.conf</span>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysrc pf_enable=yes</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Additional options, described in <a href="https://man.freebsd.org/cgi/man.cgi?query=pfctl&amp;sektion=8&amp;format=html">pfctl(8)</a>, can be passed to PF when it is started. Add or change this entry in <span class="filename">/etc/rc.conf</span> and specify any required flags between the two quotes (<code>&#34;&#34;</code>):</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>pf_flags=&#34;&#34;                     # additional flags for pfctl startup</pre>
</div>
</div>
<div class="paragraph">
<p>PF will not start if it cannot find its ruleset configuration file. By default, FreeBSD does not ship with a ruleset and there is no <span class="filename">/etc/pf.conf</span>. Example rulesets can be found in <span class="filename">/usr/share/examples/pf/</span>. If a custom ruleset has been saved somewhere else, add a line to <span class="filename">/etc/rc.conf</span> which specifies the full path to the file:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>pf_rules=&#34;/path/to/pf.conf&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>Logging support for PF is provided by <a href="https://man.freebsd.org/cgi/man.cgi?query=pflog&amp;sektion=4&amp;format=html">pflog(4)</a>. To enable logging support, add <code>pflog_enable=yes</code> to <span class="filename">/etc/rc.conf</span>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysrc pflog_enable=yes</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The following lines can also be added to change the default location of the log file or to specify any additional flags to pass to <a href="https://man.freebsd.org/cgi/man.cgi?query=pflog&amp;sektion=4&amp;format=html">pflog(4)</a> when it is started:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>pflog_logfile=&#34;/var/log/pflog&#34;  # where pflogd should store the logfile
pflog_flags=&#34;&#34;                  # additional flags for pflogd startup</pre>
</div>
</div>
<div class="paragraph">
<p>Finally, if there is a LAN behind the firewall and packets need to be forwarded for the computers on the LAN, or NAT is required, enable the following option:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>gateway_enable=&#34;YES&#34;            # Enable as LAN gateway</pre>
</div>
</div>
<div class="paragraph">
<p>After saving the needed edits, PF can be started with logging support by typing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># service pf start</span>
<span class="c"># service pflog start</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>By default, PF reads its configuration rules from <span class="filename">/etc/pf.conf</span> and modifies, drops, or passes packets according to the rules or definitions specified in this file. The FreeBSD installation includes several sample files located in <span class="filename">/usr/share/examples/pf/</span>. Refer to the <a href="http://www.openbsd.org/faq/pf/">PF FAQ</a> for complete coverage of PF rulesets.</p>
</div>
<div class="paragraph">
<p>To control PF, use <code>pfctl</code>. <a href="#pfctl">Useful <code>pfctl</code> Options</a> summarizes some useful options to this command. Refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=pfctl&amp;sektion=8&amp;format=html">pfctl(8)</a> for a description of all available options:</p>
</div>
<table id="pfctl" class="tableblock frame-none grid-all stretch">
<caption class="title">表 46. Useful <code>pfctl</code> Options</caption>
<colgroup>
<col style="width: 50%;"/>
<col style="width: 50%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Command</th>
<th class="tableblock halign-left valign-top">Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>pfctl -e</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enable PF.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>pfctl -d</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Disable PF.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>pfctl -F all -f /etc/pf.conf</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Flush all NAT, filter, state, and table rules and reload <span class="filename">/etc/pf.conf</span>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>pfctl -s [ rules | nat | states ]</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Report on the filter rules, NAT rules, or state table.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>pfctl -vnf /etc/pf.conf</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Check <span class="filename">/etc/pf.conf</span> for errors, but do not load ruleset.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p><a class="package" href="https://cgit.freebsd.org/ports/tree/security/sudo/">security/sudo</a> is useful for running commands like <code>pfctl</code> that require elevated privileges. It can be installed from the Ports Collection.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>To keep an eye on the traffic that passes through the PF firewall, consider installing the <a class="package" href="https://cgit.freebsd.org/ports/tree/sysutils/pftop/">sysutils/pftop</a> package or port. Once installed, pftop can be run to view a running snapshot of traffic in a format which is similar to <a href="https://man.freebsd.org/cgi/man.cgi?query=top&amp;sektion=1&amp;format=html">top(1)</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="pf-tutorial">33.3.2. PF Rulesets<a class="anchor" href="#pf-tutorial"></a></h4>
<div class="paragraph">
<p>This section demonstrates how to create a customized ruleset. It starts with the simplest of rulesets and builds upon its concepts using several examples to demonstrate real-world usage of PF’s many features.</p>
</div>
<div class="paragraph">
<p>The simplest possible ruleset is for a single machine that does not run any services and which needs access to one network, which may be the Internet. To create this minimal ruleset, edit <span class="filename">/etc/pf.conf</span> so it looks like this:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>block in all
pass out all keep state</pre>
</div>
</div>
<div class="paragraph">
<p>The first rule denies all incoming traffic by default. The second rule allows connections created by this system to pass out, while retaining state information on those connections. This state information allows return traffic for those connections to pass back and should only be used on machines that can be trusted. The ruleset can be loaded with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pfctl -e ; pfctl -f /etc/pf.conf</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In addition to keeping state, PF provides <em>lists</em> and <em>macros</em> which can be defined for use when creating rules. Macros can include lists and need to be defined before use. As an example, insert these lines at the very top of the ruleset:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>tcp_services = &#34;{ ssh, smtp, domain, www, pop3, auth, pop3s }&#34;
udp_services = &#34;{ domain }&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>PF understands port names as well as port numbers, as long as the names are listed in <span class="filename">/etc/services</span>. This example creates two macros. The first is a list of seven TCP port names and the second is one UDP port name. Once defined, macros can be used in rules. In this example, all traffic is blocked except for the connections initiated by this system for the seven specified TCP services and the one specified UDP service:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>tcp_services = &#34;{ ssh, smtp, domain, www, pop3, auth, pop3s }&#34;
udp_services = &#34;{ domain }&#34;
block all
pass out proto tcp to any port $tcp_services keep state
pass proto udp to any port $udp_services keep state</pre>
</div>
</div>
<div class="paragraph">
<p>Even though UDP is considered to be a stateless protocol, PF is able to track some state information. For example, when a UDP request is passed which asks a name server about a domain name, PF will watch for the response to pass it back.</p>
</div>
<div class="paragraph">
<p>Whenever an edit is made to a ruleset, the new rules must be loaded so they can be used:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pfctl -f /etc/pf.conf</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If there are no syntax errors, <code>pfctl</code> will not output any messages during the rule load. Rules can also be tested before attempting to load them:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pfctl -nf /etc/pf.conf</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Including <code>-n</code> causes the rules to be interpreted only, but not loaded. This provides an opportunity to correct any errors. At all times, the last valid ruleset loaded will be enforced until either PF is disabled or a new ruleset is loaded.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Adding <code>-v</code> to a <code>pfctl</code> ruleset verify or load will display the fully parsed rules exactly the way they will be loaded. This is extremely useful when debugging rules.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="sect4">
<h5 id="pftut-gateway">33.3.2.1. A Simple Gateway with NAT<a class="anchor" href="#pftut-gateway"></a></h5>
<div class="paragraph">
<p>This section demonstrates how to configure a FreeBSD system running PF to act as a gateway for at least one other machine. The gateway needs at least two network interfaces, each connected to a separate network. In this example, <span class="filename">xl0</span> is connected to the Internet and <span class="filename">xl1</span> is connected to the internal network.</p>
</div>
<div class="paragraph">
<p>First, enable the gateway to let the machine forward the network traffic it receives on one interface to another interface. This sysctl setting will forward IPv4 packets:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysctl net.inet.ip.forwarding=1</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To forward IPv6 traffic, use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysctl net.inet6.ip6.forwarding=1</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To enable these settings at system boot, use <a href="https://man.freebsd.org/cgi/man.cgi?query=sysrc&amp;sektion=8&amp;format=html">sysrc(8)</a> to add them to <span class="filename">/etc/rc.conf</span>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysrc gateway_enable=yes</span>
<span class="c"># sysrc ipv6_gateway_enable=yes</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Verify with <code>ifconfig</code> that both of the interfaces are up and running.</p>
</div>
<div class="paragraph">
<p>Next, create the PF rules to allow the gateway to pass traffic. While the following rule allows stateful traffic from hosts of the internal network to pass to the gateway, the <code>to</code> keyword does not guarantee passage all the way from source to destination:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>pass in on xl1 from xl1:network to xl0:network port $ports keep state</pre>
</div>
</div>
<div class="paragraph">
<p>That rule only lets the traffic pass in to the gateway on the internal interface. To let the packets go further, a matching rule is needed:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>pass out on xl0 from xl1:network to xl0:network port $ports keep state</pre>
</div>
</div>
<div class="paragraph">
<p>While these two rules will work, rules this specific are rarely needed. For a busy network admin, a readable ruleset is a safer ruleset. The remainder of this section demonstrates how to keep the rules as simple as possible for readability. For example, those two rules could be replaced with one rule:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>pass from xl1:network to any port $ports keep state</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>interface:network</code> notation can be replaced with a macro to make the ruleset even more readable. For example, a <code>$localnet</code> macro could be defined as the network directly attached to the internal interface (<code>$xl1:network</code>). Alternatively, the definition of <code>$localnet</code> could be changed to an <em>IP address/netmask</em> notation to denote a network, such as <code>192.168.100.1/24</code> for a subnet of private addresses.</p>
</div>
<div class="paragraph">
<p>If required, <code>$localnet</code> could even be defined as a list of networks. Whatever the specific needs, a sensible <code>$localnet</code> definition could be used in a typical pass rule as follows:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>pass from $localnet to any port $ports keep state</pre>
</div>
</div>
<div class="paragraph">
<p>The following sample ruleset allows all traffic initiated by machines on the internal network. It first defines two macros to represent the external and internal 3COM interfaces of the gateway.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>For dialup users, the external interface will use <span class="filename">tun0</span>. For an ADSL connection, specifically those using PPP over Ethernet (PPPoE), the correct external interface is <span class="filename">tun0</span>, not the physical Ethernet interface.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>ext_if = &#34;xl0&#34;	# macro for external interface - use tun0 for PPPoE
int_if = &#34;xl1&#34;	# macro for internal interface
localnet = $int_if:network
# ext_if IP address could be dynamic, hence ($ext_if)
nat on $ext_if from $localnet to any -&gt; ($ext_if)
block all
pass from { lo0, $localnet } to any keep state</pre>
</div>
</div>
<div class="paragraph">
<p>This ruleset introduces the <code>nat</code> rule which is used to handle the network address translation from the non-routable addresses inside the internal network to the IP address assigned to the external interface. The parentheses surrounding the last part of the nat rule <code>($ext_if)</code> is included when the IP address of the external interface is dynamically assigned. It ensures that network traffic runs without serious interruptions even if the external IP address changes.</p>
</div>
<div class="paragraph">
<p>Note that this ruleset probably allows more traffic to pass out of the network than is needed. One reasonable setup could create this macro:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>client_out = &#34;{ ftp-data, ftp, ssh, domain, pop3, auth, nntp, http, \
    https, cvspserver, 2628, 5999, 8000, 8080 }&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>to use in the main pass rule:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>pass inet proto tcp from $localnet to any port $client_out \
    flags S/SA keep state</pre>
</div>
</div>
<div class="paragraph">
<p>A few other pass rules may be needed. This one enables SSH on the external interface:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>pass in inet proto tcp to $ext_if port ssh</pre>
</div>
</div>
<div class="paragraph">
<p>This macro definition and rule allows DNS and NTP for internal clients:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>udp_services = &#34;{ domain, ntp }&#34;
pass quick inet proto { tcp, udp } to any port $udp_services keep state</pre>
</div>
</div>
<div class="paragraph">
<p>Note the <code>quick</code> keyword in this rule. Since the ruleset consists of several rules, it is important to understand the relationships between the rules in a ruleset. Rules are evaluated from top to bottom, in the sequence they are written. For each packet or connection evaluated by PF, <em>the last matching rule</em> in the ruleset is the one which is applied. However, when a packet matches a rule which contains the <code>quick</code> keyword, the rule processing stops and the packet is treated according to that rule. This is very useful when an exception to the general rules is needed.</p>
</div>
</div>
<div class="sect4">
<h5 id="pftut-ftp">33.3.2.2. Creating an FTP Proxy<a class="anchor" href="#pftut-ftp"></a></h5>
<div class="paragraph">
<p>Configuring working FTP rules can be problematic due to the nature of the FTP protocol. FTP pre-dates firewalls by several decades and is insecure in its design. The most common points against using FTP include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Passwords are transferred in the clear.</p>
</li>
<li>
<p>The protocol demands the use of at least two TCP connections (control and data) on separate ports.</p>
</li>
<li>
<p>When a session is established, data is communicated using randomly selected ports.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>All of these points present security challenges, even before considering any potential security weaknesses in client or server software. More secure alternatives for file transfer exist, such as <a href="https://man.freebsd.org/cgi/man.cgi?query=sftp&amp;sektion=1&amp;format=html">sftp(1)</a> or <a href="https://man.freebsd.org/cgi/man.cgi?query=scp&amp;sektion=1&amp;format=html">scp(1)</a>, which both feature authentication and data transfer over encrypted connections.</p>
</div>
<div class="paragraph">
<p>For those situations when FTP is required, PF provides redirection of FTP traffic to a small proxy program called <a href="https://man.freebsd.org/cgi/man.cgi?query=ftp-proxy&amp;sektion=8&amp;format=html">ftp-proxy(8)</a>, which is included in the base system of FreeBSD. The role of the proxy is to dynamically insert and delete rules in the ruleset, using a set of anchors, to correctly handle FTP traffic.</p>
</div>
<div class="paragraph">
<p>To enable the FTP proxy, add this line to <span class="filename">/etc/rc.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>ftpproxy_enable=&#34;YES&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>Then start the proxy by running:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="c"># service ftp-proxy start</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For a basic configuration, three elements need to be added to <span class="filename">/etc/pf.conf</span>. First, the anchors which the proxy will use to insert the rules it generates for the FTP sessions:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>nat-anchor &#34;ftp-proxy/*&#34;
rdr-anchor &#34;ftp-proxy/*&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>Second, a pass rule is needed to allow FTP traffic in to the proxy.</p>
</div>
<div class="paragraph">
<p>Third, redirection and NAT rules need to be defined before the filtering rules. Insert this <code>rdr</code> rule immediately after the <code>nat</code> rule:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>rdr pass on $int_if proto tcp from any to any port ftp -&gt; 127.0.0.1 port 8021</pre>
</div>
</div>
<div class="paragraph">
<p>Finally, allow the redirected traffic to pass:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>pass out proto tcp from $proxy to any port ftp</pre>
</div>
</div>
<div class="paragraph">
<p>where <code>$proxy</code> expands to the address the proxy daemon is bound to.</p>
</div>
<div class="paragraph">
<p>Save <span class="filename">/etc/pf.conf</span>, load the new rules, and verify from a client that FTP connections are working:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pfctl -f /etc/pf.conf</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This example covers a basic setup where the clients in the local network need to contact FTP servers elsewhere. This basic configuration should work well with most combinations of FTP clients and servers. As shown in <a href="https://man.freebsd.org/cgi/man.cgi?query=ftp-proxy&amp;sektion=8&amp;format=html">ftp-proxy(8)</a>, the proxy’s behavior can be changed in various ways by adding options to the <code>ftpproxy_flags=</code> line. Some clients or servers may have specific quirks that must be compensated for in the configuration, or there may be a need to integrate the proxy in specific ways such as assigning FTP traffic to a specific queue.</p>
</div>
<div class="paragraph">
<p>For ways to run an FTP server protected by PF and <a href="https://man.freebsd.org/cgi/man.cgi?query=ftp-proxy&amp;sektion=8&amp;format=html">ftp-proxy(8)</a>, configure a separate <code>ftp-proxy</code> in reverse mode, using <code>-R</code>, on a separate port with its own redirecting pass rule.</p>
</div>
</div>
<div class="sect4">
<h5 id="pftut-icmp">33.3.2.3. Managing ICMP<a class="anchor" href="#pftut-icmp"></a></h5>
<div class="paragraph">
<p>Many of the tools used for debugging or troubleshooting a TCP/IP network rely on the Internet Control Message Protocol (ICMP), which was designed specifically with debugging in mind.</p>
</div>
<div class="paragraph">
<p>The ICMP protocol sends and receives <em>control messages</em> between hosts and gateways, mainly to provide feedback to a sender about any unusual or difficult conditions enroute to the target host. Routers use ICMP to negotiate packet sizes and other transmission parameters in a process often referred to as <em>path MTU discovery</em>.</p>
</div>
<div class="paragraph">
<p>From a firewall perspective, some ICMP control messages are vulnerable to known attack vectors. Also, letting all diagnostic traffic pass unconditionally makes debugging easier, but it also makes it easier for others to extract information about the network. For these reasons, the following rule may not be optimal:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>pass inet proto icmp from any to any</pre>
</div>
</div>
<div class="paragraph">
<p>One solution is to let all ICMP traffic from the local network through while stopping all probes from outside the network:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>pass inet proto icmp from $localnet to any keep state
pass inet proto icmp from any to $ext_if keep state</pre>
</div>
</div>
<div class="paragraph">
<p>Additional options are available which demonstrate some of PF’s flexibility. For example, rather than allowing all ICMP messages, one can specify the messages used by <a href="https://man.freebsd.org/cgi/man.cgi?query=ping&amp;sektion=8&amp;format=html">ping(8)</a> and <a href="https://man.freebsd.org/cgi/man.cgi?query=traceroute&amp;sektion=8&amp;format=html">traceroute(8)</a>. Start by defining a macro for that type of message:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>icmp_types = &#34;echoreq&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>and a rule which uses the macro:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>pass inet proto icmp all icmp-type $icmp_types keep state</pre>
</div>
</div>
<div class="paragraph">
<p>If other types of ICMP packets are needed, expand <code>icmp_types</code> to a list of those packet types. Type <code>more /usr/src/sbin/pfctl/pfctl_parser.c</code> to see the list of ICMP message types supported by PF. Refer to <a href="http://www.iana.org/assignments/icmp-parameters/icmp-parameters.xhtml">http://www.iana.org/assignments/icmp-parameters/icmp-parameters.xhtml</a> for an explanation of each message type.</p>
</div>
<div class="paragraph">
<p>Since Unix <code>traceroute</code> uses UDP by default, another rule is needed to allow Unix <code>traceroute</code>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre># allow out the default range for traceroute(8):
pass out on $ext_if inet proto udp from any to any port 33433 &gt;&lt; 33626 keep state</pre>
</div>
</div>
<div class="paragraph">
<p>Since <code>TRACERT.EXE</code> on Microsoft Windows systems uses ICMP echo request messages, only the first rule is needed to allow network traces from those systems. Unix <code>traceroute</code> can be instructed to use other protocols as well, and will use ICMP echo request messages if <code>-I</code> is used. Check the <a href="https://man.freebsd.org/cgi/man.cgi?query=traceroute&amp;sektion=8&amp;format=html">traceroute(8)</a> man page for details.</p>
</div>
<div class="sect5">
<h6 id="pftut-pathmtudisc">33.3.2.3.1. Path MTU Discovery<a class="anchor" href="#pftut-pathmtudisc"></a></h6>
<div class="paragraph">
<p>Internet protocols are designed to be device independent, and one consequence of device independence is that the optimal packet size for a given connection cannot always be predicted reliably. The main constraint on packet size is the <em>Maximum Transmission Unit</em> (MTU) which sets the upper limit on the packet size for an interface. Type <code>ifconfig</code> to view the MTUs for a system’s network interfaces.</p>
</div>
<div class="paragraph">
<p>TCP/IP uses a process known as path MTU discovery to determine the right packet size for a connection. This process sends packets of varying sizes with the &#34;Do not fragment&#34; flag set, expecting an ICMP return packet of &#34;type 3, code 4&#34; when the upper limit has been reached. Type 3 means &#34;destination unreachable&#34;, and code 4 is short for &#34;fragmentation needed, but the do-not-fragment flag is set&#34;. To allow path MTU discovery in order to support connections to other MTUs, add the <code>destination unreachable</code> type to the <code>icmp_types</code> macro:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>icmp_types = &#34;{ echoreq, unreach }&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>Since the pass rule already uses that macro, it does not need to be modified to support the new ICMP type:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>pass inet proto icmp all icmp-type $icmp_types keep state</pre>
</div>
</div>
<div class="paragraph">
<p>PF allows filtering on all variations of ICMP types and codes. The list of possible types and codes are documented in <a href="https://man.freebsd.org/cgi/man.cgi?query=icmp&amp;sektion=4&amp;format=html">icmp(4)</a> and <a href="https://man.freebsd.org/cgi/man.cgi?query=icmp6&amp;sektion=4&amp;format=html">icmp6(4)</a>.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="pftut-tables">33.3.2.4. Using Tables<a class="anchor" href="#pftut-tables"></a></h5>
<div class="paragraph">
<p>Some types of data are relevant to filtering and redirection at a given time, but their definition is too long to be included in the ruleset file. PF supports the use of tables, which are defined lists that can be manipulated without needing to reload the entire ruleset, and which can provide fast lookups. Table names are always enclosed within <code>&lt; &gt;</code>, like this:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>table &lt;clients&gt; { 192.168.2.0/24, !192.168.2.5 }</pre>
</div>
</div>
<div class="paragraph">
<p>In this example, the <code>192.168.2.0/24</code> network is part of the table, except for the address <code>192.168.2.5</code>, which is excluded using the <code>!</code> operator. It is also possible to load tables from files where each item is on a separate line, as seen in this example <span class="filename">/etc/clients</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>192.168.2.0/24
!192.168.2.5</pre>
</div>
</div>
<div class="paragraph">
<p>To refer to the file, define the table like this:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>table &lt;clients&gt; persist file &#34;/etc/clients&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>Once the table is defined, it can be referenced by a rule:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>pass inet proto tcp from &lt;clients&gt; to any port $client_out flags S/SA keep state</pre>
</div>
</div>
<div class="paragraph">
<p>A table’s contents can be manipulated live, using <code>pfctl</code>. This example adds another network to the table:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pfctl -t clients -T add 192.168.1.0/16</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that any changes made this way will take affect now, making them ideal for testing, but will not survive a power failure or reboot. To make the changes permanent, modify the definition of the table in the ruleset or edit the file that the table refers to. One can maintain the on-disk copy of the table using a <a href="https://man.freebsd.org/cgi/man.cgi?query=cron&amp;sektion=8&amp;format=html">cron(8)</a> job which dumps the table’s contents to disk at regular intervals, using a command such as <code>pfctl -t clients -T show &gt;/etc/clients</code>. Alternatively, <span class="filename">/etc/clients</span> can be updated with the in-memory table contents:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pfctl -t clients -T replace -f /etc/clients</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="pftut-overload">33.3.2.5. Using Overload Tables to Protect SSH<a class="anchor" href="#pftut-overload"></a></h5>
<div class="paragraph">
<p>Those who run SSH on an external interface have probably seen something like this in the authentication logs:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>Sep 26 03:12:34 skapet sshd[25771]: Failed password for root from 200.72.41.31 port 40992 ssh2
Sep 26 03:12:34 skapet sshd[5279]: Failed password for root from 200.72.41.31 port 40992 ssh2
Sep 26 03:12:35 skapet sshd[5279]: Received disconnect from 200.72.41.31: 11: Bye Bye
Sep 26 03:12:44 skapet sshd[29635]: Invalid user admin from 200.72.41.31
Sep 26 03:12:44 skapet sshd[24703]: input_userauth_request: invalid user admin
Sep 26 03:12:44 skapet sshd[24703]: Failed password for invalid user admin from 200.72.41.31 port 41484 ssh2</pre>
</div>
</div>
<div class="paragraph">
<p>This is indicative of a brute force attack where somebody or some program is trying to discover the user name and password which will let them into the system.</p>
</div>
<div class="paragraph">
<p>If external SSH access is needed for legitimate users, changing the default port used by SSH can offer some protection. However, PF provides a more elegant solution. Pass rules can contain limits on what connecting hosts can do and violators can be banished to a table of addresses which are denied some or all access. It is even possible to drop all existing connections from machines which overreach the limits.</p>
</div>
<div class="paragraph">
<p>To configure this, create this table in the tables section of the ruleset:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>table &lt;bruteforce&gt; persist</pre>
</div>
</div>
<div class="paragraph">
<p>Then, somewhere early in the ruleset, add rules to block brute access while allowing legitimate access:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>block quick from &lt;bruteforce&gt;
pass inet proto tcp from any to $localnet port $tcp_services \
    flags S/SA keep state \
    (max-src-conn 100, max-src-conn-rate 15/5, \
    overload &lt;bruteforce&gt; flush global)</pre>
</div>
</div>
<div class="paragraph">
<p>The part in parentheses defines the limits and the numbers should be changed to meet local requirements. It can be read as follows:</p>
</div>
<div class="paragraph">
<p><code>max-src-conn</code> is the number of simultaneous connections allowed from one host.</p>
</div>
<div class="paragraph">
<p><code>max-src-conn-rate</code> is the rate of new connections allowed from any single host (<em>15</em>) per number of seconds (<em>5</em>).</p>
</div>
<div class="paragraph">
<p><code>overload &lt;bruteforce&gt;</code> means that any host which exceeds these limits gets its address added to the <code>bruteforce</code> table. The ruleset blocks all traffic from addresses in the <code>bruteforce</code> table.</p>
</div>
<div class="paragraph">
<p>Finally, <code>flush global</code> says that when a host reaches the limit, that all (<code>global</code>) of that host’s connections will be terminated (<code>flush</code>).</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>These rules will <em>not</em> block slow bruteforcers, as described in <a href="http://home.nuug.no/~peter/hailmary2013/">http://home.nuug.no/~peter/hailmary2013/</a>.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>This example ruleset is intended mainly as an illustration. For example, if a generous number of connections in general are wanted, but the desire is to be more restrictive when it comes to ssh, supplement the rule above with something like the one below, early on in the rule set:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>pass quick proto { tcp, udp } from any to any port ssh \
    flags S/SA keep state \
    (max-src-conn 15, max-src-conn-rate 5/3, \
    overload &lt;bruteforce&gt; flush global)</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><strong>It May Not be Necessary to Block All Overloaders:</strong><br/></p>
</div>
<div class="paragraph">
<p>It is worth noting that the overload mechanism is a general technique which does not apply exclusively to SSH, and it is not always optimal to entirely block all traffic from offenders.</p>
</div>
<div class="paragraph">
<p>For example, an overload rule could be used to protect a mail service or a web service, and the overload table could be used in a rule to assign offenders to a queue with a minimal bandwidth allocation or to redirect to a specific web page.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Over time, tables will be filled by overload rules and their size will grow incrementally, taking up more memory. Sometimes an IP address that is blocked is a dynamically assigned one, which has since been assigned to a host who has a legitimate reason to communicate with hosts in the local network.</p>
</div>
<div class="paragraph">
<p>For situations like these, pfctl provides the ability to expire table entries. For example, this command will remove <code>&lt;bruteforce&gt;</code> table entries which have not been referenced for <code>86400</code> seconds:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pfctl -t bruteforce -T expire 86400</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Similar functionality is provided by <a class="package" href="https://cgit.freebsd.org/ports/tree/security/expiretable/">security/expiretable</a>, which removes table entries which have not been accessed for a specified period of time.</p>
</div>
<div class="paragraph">
<p>Once installed, expiretable can be run to remove <code>&lt;bruteforce&gt;</code> table entries older than a specified age. This example removes all entries older than 24 hours:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>/usr/local/sbin/expiretable -v -d -t 24h bruteforce</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="pftut-spamd">33.3.2.6. Protecting Against SPAM<a class="anchor" href="#pftut-spamd"></a></h5>
<div class="paragraph">
<p>Not to be confused with the spamd daemon which comes bundled with spamassassin, <a class="package" href="https://cgit.freebsd.org/ports/tree/mail/spamd/">mail/spamd</a> can be configured with PF to provide an outer defense against SPAM. This spamd hooks into the PF configuration using a set of redirections.</p>
</div>
<div class="paragraph">
<p>Spammers tend to send a large number of messages, and SPAM is mainly sent from a few spammer friendly networks and a large number of hijacked machines, both of which are reported to <em>blocklists</em> fairly quickly.</p>
</div>
<div class="paragraph">
<p>When an SMTP connection from an address in a blocklist is received, spamd presents its banner and immediately switches to a mode where it answers SMTP traffic one byte at a time. This technique, which is intended to waste as much time as possible on the spammer’s end, is called <em>tarpitting</em>. The specific implementation which uses one byte SMTP replies is often referred to as <em>stuttering</em>.</p>
</div>
<div class="paragraph">
<p>This example demonstrates the basic procedure for setting up spamd with automatically updated blocklists. Refer to the man pages which are installed with <a class="package" href="https://cgit.freebsd.org/ports/tree/mail/spamd/">mail/spamd</a> for more information.</p>
</div>
<div class="sidebarblock procedure">
<div class="content">
<div class="olist arabic">
<div class="title">Procedure: Configuring spamd</div>
<ol class="arabic">
<li>
<p>Install the <a class="package" href="https://cgit.freebsd.org/ports/tree/mail/spamd/">mail/spamd</a> package or port. To use spamd’s greylisting features, <a href="https://man.freebsd.org/cgi/man.cgi?query=fdescfs&amp;sektion=5&amp;format=html">fdescfs(5)</a> must be mounted at <span class="filename">/dev/fd</span>. Add the following line to <span class="filename">/etc/fstab</span>:</p>
<div class="literalblock programlisting">
<div class="content">
<pre> fdescfs /dev/fd fdescfs rw 0 0</pre>
</div>
</div>
<div class="paragraph">
<p>Then, mount the filesystem:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>#  mount fdescfs</pre>
</div>
</div>
</li>
<li>
<p>Next, edit the PF ruleset to include:</p>
<div class="literalblock programlisting">
<div class="content">
<pre>table &lt;spamd&gt; persist
table &lt;spamd-white&gt; persist
rdr pass on $ext_if inet proto tcp from &lt;spamd&gt; to \
    { $ext_if, $localnet } port smtp -&gt; 127.0.0.1 port 8025
rdr pass on $ext_if inet proto tcp from !&lt;spamd-white&gt; to \
    { $ext_if, $localnet } port smtp -&gt; 127.0.0.1 port 8025</pre>
</div>
</div>
<div class="paragraph">
<p>The two tables <code>&lt;spamd&gt;</code> and <code>&lt;spamd-white&gt;</code> are essential. SMTP traffic from an address listed in <code>&lt;spamd&gt;</code> but not in <code>&lt;spamd-white&gt;</code> is redirected to the spamd daemon listening at port 8025.</p>
</div>
</li>
<li>
<p>The next step is to configure spamd in <span class="filename">/usr/local/etc/spamd.conf</span> and to add some <span class="filename">rc.conf</span> parameters.</p>
<div class="paragraph">
<p>The installation of <a class="package" href="https://cgit.freebsd.org/ports/tree/mail/spamd/">mail/spamd</a> includes a sample configuration file (<span class="filename">/usr/local/etc/spamd.conf.sample</span>) and a man page for <span class="filename">spamd.conf</span>. Refer to these for additional configuration options beyond those shown in this example.</p>
</div>
<div class="paragraph">
<p>One of the first lines in the configuration file that does not begin with a <code>#</code> comment sign contains the block which defines the <code>all</code> list, which specifies the lists to use:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>all:\
    :traplist:allowlist:</pre>
</div>
</div>
<div class="paragraph">
<p>This entry adds the desired blocklists, separated by colons (<code>:</code>). To use an allowlist to subtract addresses from a blocklist, add the name of the allowlist <em>immediately</em> after the name of that blocklist. For example: <code>:blocklist:allowlist:</code>.</p>
</div>
<div class="paragraph">
<p>This is followed by the specified blocklist’s definition:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>traplist:\
    :black:\
    :msg=&#34;SPAM. Your address %A has sent spam within the last 24 hours&#34;:\
    :method=http:\
    :file=www.openbsd.org/spamd/traplist.gz</pre>
</div>
</div>
<div class="paragraph">
<p>where the first line is the name of the blocklist and the second line specifies the list type. The <code>msg</code> field contains the message to display to blocklisted senders during the SMTP dialogue. The <code>method</code> field specifies how spamd-setup fetches the list data; supported methods are <code>http</code>, <code>ftp</code>, from a <code>file</code> in a mounted file system, and via <code>exec</code> of an external program. Finally, the <code>file</code> field specifies the name of the file spamd expects to receive.</p>
</div>
<div class="paragraph">
<p>The definition of the specified allowlist is similar, but omits the <code>msg</code> field since a message is not needed:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>allowlist:\
    :white:\
    :method=file:\
    :file=/var/mail/allowlist.txt</pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p><strong>Choose Data Sources with Care:</strong><br/></p>
</div>
<div class="paragraph">
<p>Using all the blocklists in the sample <span class="filename">spamd.conf</span> will block large blocks of the Internet. Administrators need to edit the file to create an optimal configuration which uses applicable data sources and, when necessary, uses custom lists.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Next, add this entry to <span class="filename">/etc/rc.conf</span>. Additional flags are described in the man page specified by the comment:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>spamd_flags=&#34;-v&#34; # use &#34;&#34; and see spamd-setup(8) for flags</pre>
</div>
</div>
<div class="paragraph">
<p>When finished, reload the ruleset, start spamd by typing <code>service obspamd start</code>, and complete the configuration using <code>spamd-setup</code>. Finally, create a <a href="https://man.freebsd.org/cgi/man.cgi?query=cron&amp;sektion=8&amp;format=html">cron(8)</a> job which calls <code>spamd-setup</code> to update the tables at reasonable intervals.</p>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="paragraph">
<p>On a typical gateway in front of a mail server, hosts will soon start getting trapped within a few seconds to several minutes.</p>
</div>
<div class="paragraph">
<p>PF also supports <em>greylisting</em>, which temporarily rejects messages from unknown hosts with <em>45n</em> codes. Messages from greylisted hosts which try again within a reasonable time are let through. Traffic from senders which are set up to behave within the limits set by RFC 1123 and RFC 2821 are immediately let through.</p>
</div>
<div class="paragraph">
<p>More information about greylisting as a technique can be found at the <a href="http://www.greylisting.org/">greylisting.org</a> web site. The most amazing thing about greylisting, apart from its simplicity, is that it still works. Spammers and malware writers have been very slow to adapt to bypass this technique.</p>
</div>
<div class="paragraph">
<p>The basic procedure for configuring greylisting is as follows:</p>
</div>
<div class="olist arabic procedure">
<div class="title">Procedure: Configuring Greylisting</div>
<ol class="arabic">
<li>
<p>Make sure that <a href="https://man.freebsd.org/cgi/man.cgi?query=fdescfs&amp;sektion=5&amp;format=html">fdescfs(5)</a> is mounted as described in Step 1 of the previous Procedure.</p>
</li>
<li>
<p>To run spamd in greylisting mode, add this line to <span class="filename">/etc/rc.conf</span>:</p>
<div class="literalblock programlisting">
<div class="content">
<pre>spamd_grey=&#34;YES&#34;  # use spamd greylisting if YES</pre>
</div>
</div>
<div class="paragraph">
<p>Refer to the spamd man page for descriptions of additional related parameters.</p>
</div>
</li>
<li>
<p>To complete the greylisting setup:</p>
<div class="literalblock programlisting">
<div class="content">
<pre>#  service obspamd restart
#  service obspamlogd start</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Behind the scenes, the spamdb database tool and the spamlogd whitelist updater perform essential functions for the greylisting feature. spamdb is the administrator’s main interface to managing the block, grey, and allow lists via the contents of the <span class="filename">/var/db/spamdb</span> database.</p>
</div>
</div>
<div class="sect4">
<h5 id="pftut-hygiene">33.3.2.7. Network Hygiene<a class="anchor" href="#pftut-hygiene"></a></h5>
<div class="paragraph">
<p>This section describes how <code>block-policy</code>, <code>scrub</code>, and <code>antispoof</code> can be used to make the ruleset behave sanely.</p>
</div>
<div class="paragraph">
<p>The <code>block-policy</code> is an option which can be set in the <code>options</code> part of the ruleset, which precedes the redirection and filtering rules. This option determines which feedback, if any, PF sends to hosts that are blocked by a rule. The option has two possible values: <code>drop</code> drops blocked packets with no feedback, and <code>return</code> returns a status code such as <code>Connection refused</code>.</p>
</div>
<div class="paragraph">
<p>If not set, the default policy is <code>drop</code>. To change the <code>block-policy</code>, specify the desired value:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>set block-policy return</pre>
</div>
</div>
<div class="paragraph">
<p>In PF, <code>scrub</code> is a keyword which enables network packet normalization. This process reassembles fragmented packets and drops TCP packets that have invalid flag combinations. Enabling <code>scrub</code> provides a measure of protection against certain kinds of attacks based on incorrect handling of packet fragments. A number of options are available, but the simplest form is suitable for most configurations:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>scrub in all</pre>
</div>
</div>
<div class="paragraph">
<p>Some services, such as NFS, require specific fragment handling options. Refer to <a href="https://home.nuug.no/~peter/pf/en/scrub.html">https://home.nuug.no/~peter/pf/en/scrub.html</a> for more information.</p>
</div>
<div class="paragraph">
<p>This example reassembles fragments, clears the &#34;do not fragment&#34; bit, and sets the maximum segment size to 1440 bytes:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>scrub in all fragment reassemble no-df max-mss 1440</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>antispoof</code> mechanism protects against activity from spoofed or forged IP addresses, mainly by blocking packets appearing on interfaces and in directions which are logically not possible.</p>
</div>
<div class="paragraph">
<p>These rules weed out spoofed traffic coming in from the rest of the world as well as any spoofed packets which originate in the local network:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>antispoof for $ext_if
antispoof for $int_if</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="pftut-unrouteables">33.3.2.8. Handling Non-Routable Addresses<a class="anchor" href="#pftut-unrouteables"></a></h5>
<div class="paragraph">
<p>Even with a properly configured gateway to handle network address translation, one may have to compensate for other people’s misconfigurations. A common misconfiguration is to let traffic with non-routable addresses out to the Internet. Since traffic from non-routeable addresses can play a part in several DoS attack techniques, consider explicitly blocking traffic from non-routeable addresses from entering the network through the external interface.</p>
</div>
<div class="paragraph">
<p>In this example, a macro containing non-routable addresses is defined, then used in blocking rules. Traffic to and from these addresses is quietly dropped on the gateway’s external interface.</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>martians = &#34;{ 127.0.0.0/8, 192.168.0.0/16, 172.16.0.0/12, \
	      10.0.0.0/8, 169.254.0.0/16, 192.0.2.0/24, \
	      0.0.0.0/8, 240.0.0.0/4 }&#34;

block drop in quick on $ext_if from $martians to any
block drop out quick on $ext_if from any to $martians</pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_enabling_altq">33.3.3. Enabling ALTQ<a class="anchor" href="#_enabling_altq"></a></h4>
<div class="paragraph">
<p>On FreeBSD, ALTQ can be used with PF to provide Quality of Service (QOS). Once ALTQ is enabled, queues can be defined in the ruleset which determine the processing priority of outbound packets.</p>
</div>
<div class="paragraph">
<p>Before enabling ALTQ, refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=altq&amp;sektion=4&amp;format=html">altq(4)</a> to determine if the drivers for the network cards installed on the system support it.</p>
</div>
<div class="paragraph">
<p>ALTQ is not available as a loadable kernel module. If the system’s interfaces support ALTQ, create a custom kernel using the instructions in <a href="./#kernelconfig">Configuring the FreeBSD Kernel</a>. The following kernel options are available. The first is needed to enable ALTQ. At least one of the other options is necessary to specify the queueing scheduler algorithm:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>options         ALTQ
options         ALTQ_CBQ        # Class Based Queuing (CBQ)
options         ALTQ_RED        # Random Early Detection (RED)
options         ALTQ_RIO        # RED In/Out
options         ALTQ_HFSC       # Hierarchical Packet Scheduler (HFSC)
options         ALTQ_PRIQ       # Priority Queuing (PRIQ)</pre>
</div>
</div>
<div class="paragraph">
<p>The following scheduler algorithms are available:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">CBQ</dt>
<dd>
<p>Class Based Queuing (CBQ) is used to divide a connection’s bandwidth into different classes or queues to prioritize traffic based on filter rules.</p>
</dd>
<dt class="hdlist1">RED</dt>
<dd>
<p>Random Early Detection (RED) is used to avoid network congestion by measuring the length of the queue and comparing it to the minimum and maximum thresholds for the queue. When the queue is over the maximum, all new packets are randomly dropped.</p>
</dd>
<dt class="hdlist1">RIO</dt>
<dd>
<p>In Random Early Detection In and Out (RIO) mode, RED maintains multiple average queue lengths and multiple threshold values, one for each QOS level.</p>
</dd>
<dt class="hdlist1">HFSC</dt>
<dd>
<p>Hierarchical Fair Service Curve Packet Scheduler (HFSC) is described in <a href="http://www-2.cs.cmu.edu/~hzhang/HFSC/main.html">http://www-2.cs.cmu.edu/~hzhang/HFSC/main.html</a>.</p>
</dd>
<dt class="hdlist1">PRIQ</dt>
<dd>
<p>Priority Queuing (PRIQ) always passes traffic that is in a higher queue first.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>More information about the scheduling algorithms and example rulesets are available at the <a href="https://web.archive.org/web/20151109213426/http://www.openbsd.org/faq/pf/queueing.html">OpenBSD’s web archive</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="firewalls-ipfw">33.4. IPFW<a class="anchor" href="#firewalls-ipfw"></a></h3>
<div class="paragraph">
<p>IPFW is a stateful firewall written for FreeBSD which supports both IPv4 and IPv6. It is comprised of several components: the kernel firewall filter rule processor and its integrated packet accounting facility, the logging facility, NAT, the <a href="https://man.freebsd.org/cgi/man.cgi?query=dummynet&amp;sektion=4&amp;format=html">dummynet(4)</a> traffic shaper, a forward facility, a bridge facility, and an ipstealth facility.</p>
</div>
<div class="paragraph">
<p>FreeBSD provides a sample ruleset in <span class="filename">/etc/rc.firewall</span> which defines several firewall types for common scenarios to assist novice users in generating an appropriate ruleset. IPFW provides a powerful syntax which advanced users can use to craft customized rulesets that meet the security requirements of a given environment.</p>
</div>
<div class="paragraph">
<p>This section describes how to enable IPFW, provides an overview of its rule syntax, and demonstrates several rulesets for common configuration scenarios.</p>
</div>
<div class="sect3">
<h4 id="firewalls-ipfw-enable">33.4.1. Enabling IPFW<a class="anchor" href="#firewalls-ipfw-enable"></a></h4>
<div class="paragraph">
<p>IPFW is included in the basic FreeBSD install as a kernel loadable module, meaning that a custom kernel is not needed in order to enable IPFW.</p>
</div>
<div class="paragraph">
<p>For those users who wish to statically compile IPFW support into a custom kernel, see <a href="#firewalls-ipfw-kernelconfig">IPFW Kernel Options</a>.</p>
</div>
<div class="paragraph">
<p>To configure the system to enable IPFW at boot time, add <code>firewall_enable=&#34;YES&#34;</code> to <span class="filename">/etc/rc.conf</span>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysrc firewall_enable=&#34;YES&#34;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To use one of the default firewall types provided by FreeBSD, add another line which specifies the type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysrc firewall_type=&#34;open&#34;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The available types are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>open</code>: passes all traffic.</p>
</li>
<li>
<p><code>client</code>: protects only this machine.</p>
</li>
<li>
<p><code>simple</code>: protects the whole network.</p>
</li>
<li>
<p><code>closed</code>: entirely disables IP traffic except for the loopback interface.</p>
</li>
<li>
<p><code>workstation</code>: protects only this machine using stateful rules.</p>
</li>
<li>
<p><code>UNKNOWN</code>: disables the loading of firewall rules.</p>
</li>
<li>
<p><span class="filename">filename</span>: full path of the file containing the firewall ruleset.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If <code>firewall_type</code> is set to either <code>client</code> or <code>simple</code>, modify the default rules found in <span class="filename">/etc/rc.firewall</span> to fit the configuration of the system.</p>
</div>
<div class="paragraph">
<p>Note that the <code>filename</code> type is used to load a custom ruleset.</p>
</div>
<div class="paragraph">
<p>An alternate way to load a custom ruleset is to set the <code>firewall_script</code> variable to the absolute path of an <em>executable script</em> that includes IPFW commands. The examples used in this section assume that the <code>firewall_script</code> is set to <span class="filename">/etc/ipfw.rules</span>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysrc firewall_script=&#34;/etc/ipfw.rules&#34;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To enable logging through <a href="https://man.freebsd.org/cgi/man.cgi?query=syslogd&amp;sektion=8&amp;format=html">syslogd(8)</a>, include this line:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysrc firewall_logging=&#34;YES&#34;</span></code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Only firewall rules with the <code>log</code> option will be logged. The default rules do not include this option and it must be manually added. Therefore it is advisable that the default ruleset is edited for logging. In addition, log rotation may be desired if the logs are stored in a separate file.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>There is no <span class="filename">/etc/rc.conf</span> variable to set logging limits. To limit the number of times a rule is logged per connection attempt, specify the number using this line in <span class="filename">/etc/sysctl.conf</span>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># echo &#34;net.inet.ip.fw.verbose_limit=5&#34; &gt;&gt; /etc/sysctl.conf</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To enable logging through a dedicated interface named <code>ipfw0</code>, add this line to <span class="filename">/etc/rc.conf</span> instead:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysrc firewall_logif=&#34;YES&#34;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then use tcpdump to see what is being logged:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># tcpdump -t -n -i ipfw0</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>There is no overhead due to logging unless tcpdump is attached.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>After saving the needed edits, start the firewall. To enable logging limits now, also set the <code>sysctl</code> value specified above:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># service ipfw start</span>
<span class="c"># sysctl net.inet.ip.fw.verbose_limit=5</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="firewalls-ipfw-rules">33.4.2. IPFW Rule Syntax<a class="anchor" href="#firewalls-ipfw-rules"></a></h4>
<div class="paragraph">
<p>When a packet enters the IPFW firewall, it is compared against the first rule in the ruleset and progresses one rule at a time, moving from top to bottom in sequence. When the packet matches the selection parameters of a rule, the rule’s action is executed and the search of the ruleset terminates for that packet. This is referred to as &#34;first match wins&#34;. If the packet does not match any of the rules, it gets caught by the mandatory IPFW default rule number 65535, which denies all packets and silently discards them. However, if the packet matches a rule that contains the <code>count</code>, <code>skipto</code>, or <code>tee</code> keywords, the search continues. Refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=ipfw&amp;sektion=8&amp;format=html">ipfw(8)</a> for details on how these keywords affect rule processing.</p>
</div>
<div class="paragraph">
<p>When creating an IPFW rule, keywords must be written in the following order. Some keywords are mandatory while other keywords are optional. The words shown in uppercase represent a variable and the words shown in lowercase must precede the variable that follows it. The <code>#</code> symbol is used to mark the start of a comment and may appear at the end of a rule or on its own line. Blank lines are ignored.</p>
</div>
<div class="paragraph">
<p><code><em>CMD RULE_NUMBER set SET_NUMBER ACTION log LOG_AMOUNT PROTO from SRC SRC_PORT to DST DST_PORT OPTIONS</em></code></p>
</div>
<div class="paragraph">
<p>This section provides an overview of these keywords and their options. It is not an exhaustive list of every possible option. Refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=ipfw&amp;sektion=8&amp;format=html">ipfw(8)</a> for a complete description of the rule syntax that can be used when creating IPFW rules.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">CMD</dt>
<dd>
<p>Every rule must start with <code>ipfw add</code>.</p>
</dd>
<dt class="hdlist1">RULE_NUMBER</dt>
<dd>
<p>Each rule is associated with a number from <code>1</code> to <code>65534</code>. The number is used to indicate the order of rule processing. Multiple rules can have the same number, in which case they are applied according to the order in which they have been added.</p>
</dd>
<dt class="hdlist1">SET_NUMBER</dt>
<dd>
<p>Each rule is associated with a set number from <code>0</code> to <code>31</code>. Sets can be individually disabled or enabled, making it possible to quickly add or delete a set of rules. If a SET_NUMBER is not specified, the rule will be added to set <code>0</code>.</p>
</dd>
<dt class="hdlist1">ACTION</dt>
<dd>
<p>A rule can be associated with one of the following actions. The specified action will be executed when the packet matches the selection criterion of the rule.</p>
<div class="paragraph">
<p><code>allow | accept | pass | permit</code>: these keywords are equivalent and allow packets that match the rule.</p>
</div>
<div class="paragraph">
<p><code>check-state</code>: checks the packet against the dynamic state table. If a match is found, execute the action associated with the rule which generated this dynamic rule, otherwise move to the next rule. A <code>check-state</code> rule does not have selection criterion. If no <code>check-state</code> rule is present in the ruleset, the dynamic rules table is checked at the first <code>keep-state</code> or <code>limit</code> rule.</p>
</div>
<div class="paragraph">
<p><code>count</code>: updates counters for all packets that match the rule. The search continues with the next rule.</p>
</div>
<div class="paragraph">
<p><code>deny | drop</code>: either word silently discards packets that match this rule.</p>
</div>
<div class="paragraph">
<p>Additional actions are available. Refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=ipfw&amp;sektion=8&amp;format=html">ipfw(8)</a> for details.</p>
</div>
</dd>
<dt class="hdlist1">LOG_AMOUNT</dt>
<dd>
<p>When a packet matches a rule with the <code>log</code> keyword, a message will be logged to <a href="https://man.freebsd.org/cgi/man.cgi?query=syslogd&amp;sektion=8&amp;format=html">syslogd(8)</a> with a facility name of <code>SECURITY</code>. Logging only occurs if the number of packets logged for that particular rule does not exceed a specified LOG_AMOUNT. If no LOG_AMOUNT is specified, the limit is taken from the value of <code>net.inet.ip.fw.verbose_limit</code>. A value of zero removes the logging limit. Once the limit is reached, logging can be re-enabled by clearing the logging counter or the packet counter for that rule, using <code>ipfw resetlog</code>.</p>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Logging is done after all other packet matching conditions have been met, and before performing the final action on the packet. The administrator decides which rules to enable logging on.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
</dd>
<dt class="hdlist1">PROTO</dt>
<dd>
<p>This optional value can be used to specify any protocol name or number found in <span class="filename">/etc/protocols</span>.</p>
</dd>
<dt class="hdlist1">SRC</dt>
<dd>
<p>The <code>from</code> keyword must be followed by the source address or a keyword that represents the source address. An address can be represented by <code>any</code>, <code>me</code> (any address configured on an interface on this system), <code>me6</code>, (any IPv6 address configured on an interface on this system), or <code>table</code> followed by the number of a lookup table which contains a list of addresses. When specifying an IP address, it can be optionally followed by its CIDR mask or subnet mask. For example, <code>1.2.3.4/25</code> or <code>1.2.3.4:255.255.255.128</code>.</p>
</dd>
<dt class="hdlist1">SRC_PORT</dt>
<dd>
<p>An optional source port can be specified using the port number or name from <span class="filename">/etc/services</span>.</p>
</dd>
<dt class="hdlist1">DST</dt>
<dd>
<p>The <code>to</code> keyword must be followed by the destination address or a keyword that represents the destination address. The same keywords and addresses described in the SRC section can be used to describe the destination.</p>
</dd>
<dt class="hdlist1">DST_PORT</dt>
<dd>
<p>An optional destination port can be specified using the port number or name from <span class="filename">/etc/services</span>.</p>
</dd>
<dt class="hdlist1">OPTIONS</dt>
<dd>
<p>Several keywords can follow the source and destination. As the name suggests, OPTIONS are optional. Commonly used options include <code>in</code> or <code>out</code>, which specify the direction of packet flow, <code>icmptypes</code> followed by the type of ICMP message, and <code>keep-state</code>.</p>
<div class="paragraph">
<p>When a <code>keep-state</code> rule is matched, the firewall will create a dynamic rule which matches bidirectional traffic between the source and destination addresses and ports using the same protocol.</p>
</div>
<div class="paragraph">
<p>The dynamic rules facility is vulnerable to resource depletion from a SYN-flood attack which would open a huge number of dynamic rules. To counter this type of attack with IPFW, use <code>limit</code>. This option limits the number of simultaneous sessions by checking the open dynamic rules, counting the number of times this rule and IP address combination occurred. If this count is greater than the value specified by <code>limit</code>, the packet is discarded.</p>
</div>
<div class="paragraph">
<p>Dozens of OPTIONS are available. Refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=ipfw&amp;sektion=8&amp;format=html">ipfw(8)</a> for a description of each available option.</p>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_example_ruleset">33.4.3. Example Ruleset<a class="anchor" href="#_example_ruleset"></a></h4>
<div class="paragraph">
<p>This section demonstrates how to create an example stateful firewall ruleset script named <span class="filename">/etc/ipfw.rules</span>. In this example, all connection rules use <code>in</code> or <code>out</code> to clarify the direction. They also use <code>via</code> <em>interface-name</em> to specify the interface the packet is traveling over.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When first creating or testing a firewall ruleset, consider temporarily setting this tunable:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>net.inet.ip.fw.default_to_accept=&#34;1&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>This sets the default policy of <a href="https://man.freebsd.org/cgi/man.cgi?query=ipfw&amp;sektion=8&amp;format=html">ipfw(8)</a> to be more permissive than the default <code>deny ip from any to any</code>, making it slightly more difficult to get locked out of the system right after a reboot.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>The firewall script begins by indicating that it is a Bourne shell script and flushes any existing rules. It then creates the <code>cmd</code> variable so that <code>ipfw add</code> does not have to be typed at the beginning of every rule. It also defines the <code>pif</code> variable which represents the name of the interface that is attached to the Internet.</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>#!/bin/sh
# Flush out the list before we begin.
ipfw -q -f flush

# Set rules command prefix
cmd=&#34;ipfw -q add&#34;
pif=&#34;dc0&#34;     # interface name of NIC attached to Internet</pre>
</div>
</div>
<div class="paragraph">
<p>The first two rules allow all traffic on the trusted internal interface and on the loopback interface:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre># Change xl0 to LAN NIC interface name
$cmd 00005 allow all from any to any via xl0

# No restrictions on Loopback Interface
$cmd 00010 allow all from any to any via lo0</pre>
</div>
</div>
<div class="paragraph">
<p>The next rule allows the packet through if it matches an existing entry in the dynamic rules table:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>$cmd 00101 check-state</pre>
</div>
</div>
<div class="paragraph">
<p>The next set of rules defines which stateful connections internal systems can create to hosts on the Internet:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre># Allow access to public DNS
# Replace x.x.x.x with the IP address of a public DNS server
# and repeat for each DNS server in /etc/resolv.conf
$cmd 00110 allow tcp from any to x.x.x.x 53 out via $pif setup keep-state
$cmd 00111 allow udp from any to x.x.x.x 53 out via $pif keep-state

# Allow access to ISP&#39;s DHCP server for cable/DSL configurations.
# Use the first rule and check log for IP address.
# Then, uncomment the second rule, input the IP address, and delete the first rule
$cmd 00120 allow log udp from any to any 67 out via $pif keep-state
#$cmd 00120 allow udp from any to x.x.x.x 67 out via $pif keep-state

# Allow outbound HTTP and HTTPS connections
$cmd 00200 allow tcp from any to any 80 out via $pif setup keep-state
$cmd 00220 allow tcp from any to any 443 out via $pif setup keep-state

# Allow outbound email connections
$cmd 00230 allow tcp from any to any 25 out via $pif setup keep-state
$cmd 00231 allow tcp from any to any 110 out via $pif setup keep-state

# Allow outbound ping
$cmd 00250 allow icmp from any to any out via $pif keep-state

# Allow outbound NTP
$cmd 00260 allow udp from any to any 123 out via $pif keep-state

# Allow outbound SSH
$cmd 00280 allow tcp from any to any 22 out via $pif setup keep-state

# deny and log all other outbound connections
$cmd 00299 deny log all from any to any out via $pif</pre>
</div>
</div>
<div class="paragraph">
<p>The next set of rules controls connections from Internet hosts to the internal network. It starts by denying packets typically associated with attacks and then explicitly allows specific types of connections. All the authorized services that originate from the Internet use <code>limit</code> to prevent flooding.</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre># Deny all inbound traffic from non-routable reserved address spaces
$cmd 00300 deny all from 192.168.0.0/16 to any in via $pif     #RFC 1918 private IP
$cmd 00301 deny all from 172.16.0.0/12 to any in via $pif      #RFC 1918 private IP
$cmd 00302 deny all from 10.0.0.0/8 to any in via $pif         #RFC 1918 private IP
$cmd 00303 deny all from 127.0.0.0/8 to any in via $pif        #loopback
$cmd 00304 deny all from 0.0.0.0/8 to any in via $pif          #loopback
$cmd 00305 deny all from 169.254.0.0/16 to any in via $pif     #DHCP auto-config
$cmd 00306 deny all from 192.0.2.0/24 to any in via $pif       #reserved for docs
$cmd 00307 deny all from 204.152.64.0/23 to any in via $pif    #Sun cluster interconnect
$cmd 00308 deny all from 224.0.0.0/3 to any in via $pif        #Class D &amp; E multicast

# Deny public pings
$cmd 00310 deny icmp from any to any in via $pif

# Deny ident
$cmd 00315 deny tcp from any to any 113 in via $pif

# Deny all Netbios services.
$cmd 00320 deny tcp from any to any 137 in via $pif
$cmd 00321 deny tcp from any to any 138 in via $pif
$cmd 00322 deny tcp from any to any 139 in via $pif
$cmd 00323 deny tcp from any to any 81 in via $pif

# Deny fragments
$cmd 00330 deny all from any to any frag in via $pif

# Deny ACK packets that did not match the dynamic rule table
$cmd 00332 deny tcp from any to any established in via $pif

# Allow traffic from ISP&#39;s DHCP server.
# Replace x.x.x.x with the same IP address used in rule 00120.
#$cmd 00360 allow udp from any to x.x.x.x 67 in via $pif keep-state

# Allow HTTP connections to internal web server
$cmd 00400 allow tcp from any to me 80 in via $pif setup limit src-addr 2

# Allow inbound SSH connections
$cmd 00410 allow tcp from any to me 22 in via $pif setup limit src-addr 2

# Reject and log all other incoming connections
$cmd 00499 deny log all from any to any in via $pif</pre>
</div>
</div>
<div class="paragraph">
<p>The last rule logs all packets that do not match any of the rules in the ruleset:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre># Everything else is denied and logged
$cmd 00999 deny log all from any to any</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="in-kernel-nat">33.4.4. In-kernel NAT<a class="anchor" href="#in-kernel-nat"></a></h4>
<div class="paragraph">
<p>FreeBSD’s IPFW firewall has two implementations of NAT: the userland implementation <a href="https://man.freebsd.org/cgi/man.cgi?query=natd&amp;sektion=8&amp;format=html">natd(8)</a>, and the more recent in-kernel NAT implementation. Both work in conjunction with IPFW to provide network address translation. This can be used to provide an Internet Connection Sharing solution so that several internal computers can connect to the Internet using a single public IP address.</p>
</div>
<div class="paragraph">
<p>To do this, the FreeBSD machine connected to the Internet must act as a gateway. This system must have two NICs, where one is connected to the Internet and the other is connected to the internal LAN. Each machine connected to the LAN should be assigned an IP address in the private network space, as defined by <a href="https://www.ietf.org/rfc/rfc1918.txt">RFC 1918</a>.</p>
</div>
<div class="paragraph">
<p>Some additional configuration is needed in order to enable the in-kernel NAT facility of IPFW. To enable in-kernel NAT support at boot time, the following must be set in <span class="filename">/etc/rc.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>gateway_enable=&#34;YES&#34;
firewall_enable=&#34;YES&#34;
firewall_nat_enable=&#34;YES&#34;</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When <code>firewall_nat_enable</code> is set but <code>firewall_enable</code> is not, it will have no effect and do nothing. This is because the in-kernel NAT implementation is only compatible with IPFW.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>When the ruleset contains stateful rules, the positioning of the NAT rule is critical and the <code>skipto</code> action is used. The <code>skipto</code> action requires a rule number so that it knows which rule to jump to. The example below builds upon the firewall ruleset shown in the previous section. It adds some additional entries and modifies some existing rules in order to configure the firewall for in-kernel NAT. It starts by adding some additional variables which represent the rule number to skip to, the <code>keep-state</code> option, and a list of TCP ports which will be used to reduce the number of rules.</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>#!/bin/sh
ipfw -q -f flush
cmd=&#34;ipfw -q add&#34;
skip=&#34;skipto 1000&#34;
pif=dc0
ks=&#34;keep-state&#34;
good_tcpo=&#34;22,25,37,53,80,443,110&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>With in-kernel NAT it is necessary to disable TCP segmentation offloading (TSO) due to the architecture of <a href="https://man.freebsd.org/cgi/man.cgi?query=libalias&amp;sektion=3&amp;format=html">libalias(3)</a>, a library implemented as a kernel module to provide the in-kernel NAT facility of IPFW. TSO can be disabled on a per network interface basis using <a href="https://man.freebsd.org/cgi/man.cgi?query=ifconfig&amp;sektion=8&amp;format=html">ifconfig(8)</a> or on a system wide basis using <a href="https://man.freebsd.org/cgi/man.cgi?query=sysctl&amp;sektion=8&amp;format=html">sysctl(8)</a>. To disable TSO system wide, the following must be set it <span class="filename">/etc/sysctl.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>net.inet.tcp.tso=&#34;0&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>A NAT instance will also be configured. It is possible to have multiple NAT instances each with their own configuration. For this example only one NAT instance is needed, NAT instance number 1. The configuration can take a few options such as: <code>if</code> which indicates the public interface, <code>same_ports</code> which takes care that aliased ports and local port numbers are mapped the same, <code>unreg_only</code> will result in only unregistered (private) address spaces to be processed by the NAT instance, and <code>reset</code> which will help to keep a functioning NAT instance even when the public IP address of the IPFW machine changes. For all possible options that can be passed to a single NAT instance configuration consult <a href="https://man.freebsd.org/cgi/man.cgi?query=ipfw&amp;sektion=8&amp;format=html">ipfw(8)</a>. When configuring a stateful NATing firewall, it is necessary to allow translated packets to be reinjected in the firewall for further processing. This can be achieved by disabling <code>one_pass</code> behavior at the start of the firewall script.</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>ipfw disable one_pass
ipfw -q nat 1 config if $pif same_ports unreg_only reset</pre>
</div>
</div>
<div class="paragraph">
<p>The inbound NAT rule is inserted <em>after</em> the two rules which allow all traffic on the trusted and loopback interfaces and after the reassemble rule but <em>before</em> the <code>check-state</code> rule. It is important that the rule number selected for this NAT rule, in this example <code>100</code>, is higher than the first three rules and lower than the <code>check-state</code> rule. Furthermore, because of the behavior of in-kernel NAT it is advised to place a reassemble rule just before the first NAT rule and after the rules that allow traffic on trusted interface. Normally, IP fragmentation should not happen, but when dealing with IPSEC/ESP/GRE tunneling traffic it might and the reassembling of fragments is necessary before handing the complete packet over to the in-kernel NAT facility.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The reassemble rule was not needed with userland <a href="https://man.freebsd.org/cgi/man.cgi?query=natd&amp;sektion=8&amp;format=html">natd(8)</a> because the internal workings of the IPFW <code>divert</code> action already takes care of reassembling packets before delivery to the socket as also stated in <a href="https://man.freebsd.org/cgi/man.cgi?query=ipfw&amp;sektion=8&amp;format=html">ipfw(8)</a>.</p>
</div>
<div class="paragraph">
<p>The NAT instance and rule number used in this example does not match with the default NAT instance and rule number created by <span class="filename">rc.firewall</span>. <span class="filename">rc.firewall</span> is a script that sets up the default firewall rules present in FreeBSD.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>$cmd 005 allow all from any to any via xl0  # exclude LAN traffic
$cmd 010 allow all from any to any via lo0  # exclude loopback traffic
$cmd 099 reass all from any to any in       # reassemble inbound packets
$cmd 100 nat 1 ip from any to any in via $pif # NAT any inbound packets
# Allow the packet through if it has an existing entry in the dynamic rules table
$cmd 101 check-state</pre>
</div>
</div>
<div class="paragraph">
<p>The outbound rules are modified to replace the <code>allow</code> action with the <code>$skip</code> variable, indicating that rule processing will continue at rule <code>1000</code>. The seven <code>tcp</code> rules have been replaced by rule <code>125</code> as the <code>$good_tcpo</code> variable contains the seven allowed outbound ports.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Remember that IPFW’s performance is largely determined by the number of rules present in the ruleset.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre># Authorized outbound packets
$cmd 120 $skip udp from any to x.x.x.x 53 out via $pif $ks
$cmd 121 $skip udp from any to x.x.x.x 67 out via $pif $ks
$cmd 125 $skip tcp from any to any $good_tcpo out via $pif setup $ks
$cmd 130 $skip icmp from any to any out via $pif $ks</pre>
</div>
</div>
<div class="paragraph">
<p>The inbound rules remain the same, except for the very last rule which removes the <code>via $pif</code> in order to catch both inbound and outbound rules. The NAT rule must follow this last outbound rule, must have a higher number than that last rule, and the rule number must be referenced by the <code>skipto</code> action. In this ruleset, rule number <code>1000</code> handles passing all packets to our configured instance for NAT processing. The next rule allows any packet which has undergone NAT processing to pass.</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>$cmd 999 deny log all from any to any
$cmd 1000 nat 1 ip from any to any out via $pif # skipto location for outbound stateful rules
$cmd 1001 allow ip from any to any</pre>
</div>
</div>
<div class="paragraph">
<p>In this example, rules <code>100</code>, <code>101</code>, <code>125</code>, <code>1000</code>, and <code>1001</code> control the address translation of the outbound and inbound packets so that the entries in the dynamic state table always register the private LANIP address.</p>
</div>
<div class="paragraph">
<p>Consider an internal web browser which initializes a new outbound HTTP session over port 80. When the first outbound packet enters the firewall, it does not match rule <code>100</code> because it is headed out rather than in. It passes rule <code>101</code> because this is the first packet and it has not been posted to the dynamic state table yet. The packet finally matches rule <code>125</code> as it is outbound on an allowed port and has a source IP address from the internal LAN. On matching this rule, two actions take place. First, the <code>keep-state</code> action adds an entry to the dynamic state table and the specified action, <code>skipto rule 1000</code>, is executed. Next, the packet undergoes NAT and is sent out to the Internet. This packet makes its way to the destination web server, where a response packet is generated and sent back. This new packet enters the top of the ruleset. It matches rule <code>100</code> and has its destination IP address mapped back to the original internal address. It then is processed by the <code>check-state</code> rule, is found in the table as an existing session, and is released to the LAN.</p>
</div>
<div class="paragraph">
<p>On the inbound side, the ruleset has to deny bad packets and allow only authorized services. A packet which matches an inbound rule is posted to the dynamic state table and the packet is released to the LAN. The packet generated as a response is recognized by the <code>check-state</code> rule as belonging to an existing session. It is then sent to rule <code>1000</code> to undergo NAT before being released to the outbound interface.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Transitioning from userland <a href="https://man.freebsd.org/cgi/man.cgi?query=natd&amp;sektion=8&amp;format=html">natd(8)</a> to in-kernel NAT might appear seamless at first but there is small catch. When using the GENERIC kernel, IPFW will load the <span class="filename">libalias.ko</span> kernel module, when <code>firewall_nat_enable</code> is enabled in <span class="filename">/etc/rc.conf</span>. The <span class="filename">libalias.ko</span> kernel module only provides basic NAT functionality, whereas the userland implementation <a href="https://man.freebsd.org/cgi/man.cgi?query=natd&amp;sektion=8&amp;format=html">natd(8)</a> has all NAT functionality available in its userland library without any extra configuration. All functionality refers to the following kernel modules that can additionally be loaded when needed besides the standard <span class="filename">libalias.ko</span> kernel module: <span class="filename">alias_ftp.ko</span>, <span class="filename">alias_bbt.ko</span>, <span class="filename">skinny.ko</span>, <span class="filename">irc.ko</span>, <span class="filename">alias_pptp.ko</span> and <span class="filename">alias_smedia.ko</span> using the <code>kld_list</code> directive in <span class="filename">/etc/rc.conf</span>. If a custom kernel is used, the full functionality of the userland library can be compiled in, in the kernel, using the <code>options LIBALIAS</code>.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="sect4">
<h5 id="_port_redirection">33.4.4.1. Port Redirection<a class="anchor" href="#_port_redirection"></a></h5>
<div class="paragraph">
<p>The drawback with NAT in general is that the LAN clients are not accessible from the Internet. Clients on the LAN can make outgoing connections to the world but cannot receive incoming ones. This presents a problem if trying to run Internet services on one of the LAN client machines. A simple way around this is to redirect selected Internet ports on the NAT providing machine to a LAN client.</p>
</div>
<div class="paragraph">
<p>For example, an IRC server runs on client <code>A</code> and a web server runs on client <code>B</code>. For this to work properly, connections received on ports 6667 (IRC) and 80 (HTTP) must be redirected to the respective machines.</p>
</div>
<div class="paragraph">
<p>With in-kernel NAT all configuration is done in the NAT instance configuration. For a full list of options that an in-kernel NAT instance can use, consult <a href="https://man.freebsd.org/cgi/man.cgi?query=ipfw&amp;sektion=8&amp;format=html">ipfw(8)</a>. The IPFW syntax follows the syntax of natd. The syntax for <code>redirect_port</code> is as follows:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>redirect_port proto targetIP:targetPORT[-targetPORT]
  [aliasIP:]aliasPORT[-aliasPORT]
  [remoteIP[:remotePORT[-remotePORT]]]</pre>
</div>
</div>
<div class="paragraph">
<p>To configure the above example setup, the arguments should be:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>redirect_port tcp 192.168.0.2:6667 6667
redirect_port tcp 192.168.0.3:80 80</pre>
</div>
</div>
<div class="paragraph">
<p>After adding these arguments to the configuration of NAT instance 1 in the above ruleset, the TCP ports will be port forwarded to the LAN client machines running the IRC and HTTP services.</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>ipfw -q nat 1 config if $pif same_ports unreg_only reset \
  redirect_port tcp 192.168.0.2:6667 6667 \
  redirect_port tcp 192.168.0.3:80 80</pre>
</div>
</div>
<div class="paragraph">
<p>Port ranges over individual ports can be indicated with <code>redirect_port</code>. For example, <em>tcp 192.168.0.2:2000-3000 2000-3000</em> would redirect all connections received on ports 2000 to 3000 to ports 2000 to 3000 on client <code>A</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="_address_redirection">33.4.4.2. Address Redirection<a class="anchor" href="#_address_redirection"></a></h5>
<div class="paragraph">
<p>Address redirection is useful if more than one IP address is available. Each LAN client can be assigned its own external IP address by <a href="https://man.freebsd.org/cgi/man.cgi?query=ipfw&amp;sektion=8&amp;format=html">ipfw(8)</a>, which will then rewrite outgoing packets from the LAN clients with the proper external IP address and redirects all traffic incoming on that particular IP address back to the specific LAN client. This is also known as static NAT. For example, if IP addresses <code>128.1.1.1</code>, <code>128.1.1.2</code>, and <code>128.1.1.3</code> are available, <code>128.1.1.1</code> can be used as the <a href="https://man.freebsd.org/cgi/man.cgi?query=ipfw&amp;sektion=8&amp;format=html">ipfw(8)</a> machine’s external IP address, while <code>128.1.1.2</code> and <code>128.1.1.3</code> are forwarded back to LAN clients <code>A</code> and <code>B</code>.</p>
</div>
<div class="paragraph">
<p>The <code>redirect_addr</code> syntax is as below, where <code>localIP</code> is the internal IP address of the LAN client, and <code>publicIP</code> the external IP address corresponding to the LAN client.</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>redirect_addr localIP publicIP</pre>
</div>
</div>
<div class="paragraph">
<p>In the example, the arguments would read:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>redirect_addr 192.168.0.2 128.1.1.2
redirect_addr 192.168.0.3 128.1.1.3</pre>
</div>
</div>
<div class="paragraph">
<p>Like <code>redirect_port</code>, these arguments are placed in a NAT instance configuration. With address redirection, there is no need for port redirection, as all data received on a particular IP address is redirected.</p>
</div>
<div class="paragraph">
<p>The external IP addresses on the <a href="https://man.freebsd.org/cgi/man.cgi?query=ipfw&amp;sektion=8&amp;format=html">ipfw(8)</a> machine must be active and aliased to the external interface. Refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=rc.conf&amp;sektion=5&amp;format=html">rc.conf(5)</a> for details.</p>
</div>
</div>
<div class="sect4">
<h5 id="_userspace_nat">33.4.4.3. Userspace NAT<a class="anchor" href="#_userspace_nat"></a></h5>
<div class="paragraph">
<p>Let us start with a statement: the userspace NAT implementation: <a href="https://man.freebsd.org/cgi/man.cgi?query=natd&amp;sektion=8&amp;format=html">natd(8)</a>, has more overhead than in-kernel NAT. For <a href="https://man.freebsd.org/cgi/man.cgi?query=natd&amp;sektion=8&amp;format=html">natd(8)</a> to translate packets, the packets have to be copied from the kernel to userspace and back which brings in extra overhead that is not present with in-kernel NAT.</p>
</div>
<div class="paragraph">
<p>To enable the userpace NAT daemon <a href="https://man.freebsd.org/cgi/man.cgi?query=natd&amp;sektion=8&amp;format=html">natd(8)</a> at boot time, the following is a minimum configuration in <span class="filename">/etc/rc.conf</span>. Where <code>natd_interface</code> is set to the name of the NIC attached to the Internet. The <a href="https://man.freebsd.org/cgi/man.cgi?query=rc&amp;sektion=8&amp;format=html">rc(8)</a> script of <a href="https://man.freebsd.org/cgi/man.cgi?query=natd&amp;sektion=8&amp;format=html">natd(8)</a> will automatically check if a dynamic IP address is used and configure itself to handle that.</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>gateway_enable=&#34;YES&#34;
natd_enable=&#34;YES&#34;
natd_interface=&#34;rl0&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>In general, the above ruleset as explained for in-kernel NAT can also be used together with <a href="https://man.freebsd.org/cgi/man.cgi?query=natd&amp;sektion=8&amp;format=html">natd(8)</a>. The exceptions are the configuration of the in-kernel NAT instance <code>(ipfw -q nat 1 config …​)</code> which is not needed together with reassemble rule 99 because its functionality is included in the <code>divert</code> action. Rule number 100 and 1000 will have to change sligthly as shown below.</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>$cmd 100 divert natd ip from any to any in via $pif
$cmd 1000 divert natd ip from any to any out via $pif</pre>
</div>
</div>
<div class="paragraph">
<p>To configure port or address redirection, a similar syntax as with in-kernel NAT is used. Although, now, instead of specifying the configuration in our ruleset script like with in-kernel NAT, configuration of <a href="https://man.freebsd.org/cgi/man.cgi?query=natd&amp;sektion=8&amp;format=html">natd(8)</a> is best done in a configuration file. To do this, an extra flag must be passed via <span class="filename">/etc/rc.conf</span> which specifies the path of the configuration file.</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>natd_flags=&#34;-f /etc/natd.conf&#34;</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The specified file must contain a list of configuration options, one per line. For more information about the configuration file and possible variables, consult <a href="https://man.freebsd.org/cgi/man.cgi?query=natd&amp;sektion=8&amp;format=html">natd(8)</a>. Below are two example entries, one per line:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>redirect_port tcp 192.168.0.2:6667 6667
redirect_addr 192.168.0.3 128.1.1.3</pre>
</div>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="firewalls-ipfw-cmd">33.4.5. The IPFW Command<a class="anchor" href="#firewalls-ipfw-cmd"></a></h4>
<div class="paragraph">
<p><code>ipfw</code> can be used to make manual, single rule additions or deletions to the active firewall while it is running. The problem with using this method is that all the changes are lost when the system reboots. It is recommended to instead write all the rules in a file and to use that file to load the rules at boot time and to replace the currently running firewall rules whenever that file changes.</p>
</div>
<div class="paragraph">
<p><code>ipfw</code> is a useful way to display the running firewall rules to the console screen. The IPFW accounting facility dynamically creates a counter for each rule that counts each packet that matches the rule. During the process of testing a rule, listing the rule with its counter is one way to determine if the rule is functioning as expected.</p>
</div>
<div class="paragraph">
<p>To list all the running rules in sequence:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ipfw list</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To list all the running rules with a time stamp of when the last time the rule was matched:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ipfw -t list</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The next example lists accounting information and the packet count for matched rules along with the rules themselves. The first column is the rule number, followed by the number of matched packets and bytes, followed by the rule itself.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ipfw -a list</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To list dynamic rules in addition to static rules:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ipfw -d list</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To also show the expired dynamic rules:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ipfw -d -e list</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To zero the counters:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ipfw zero</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To zero the counters for just the rule with number <em>NUM</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ipfw zero NUM</span></code></pre>
</div>
</div>
<div class="sect4">
<h5 id="_logging_firewall_messages">33.4.5.1. Logging Firewall Messages<a class="anchor" href="#_logging_firewall_messages"></a></h5>
<div class="paragraph">
<p>Even with the logging facility enabled, IPFW will not generate any rule logging on its own. The firewall administrator decides which rules in the ruleset will be logged, and adds the <code>log</code> keyword to those rules. Normally only deny rules are logged. It is customary to duplicate the &#34;ipfw default deny everything&#34; rule with the <code>log</code> keyword included as the last rule in the ruleset. This way, it is possible to see all the packets that did not match any of the rules in the ruleset.</p>
</div>
<div class="paragraph">
<p>Logging is a two edged sword. If one is not careful, an over abundance of log data or a DoS attack can fill the disk with log files. Log messages are not only written to syslogd, but also are displayed on the root console screen and soon become annoying.</p>
</div>
<div class="paragraph">
<p>The <code>IPFIREWALL_VERBOSE_LIMIT=5</code> kernel option limits the number of consecutive messages sent to <a href="https://man.freebsd.org/cgi/man.cgi?query=syslogd&amp;sektion=8&amp;format=html">syslogd(8)</a>, concerning the packet matching of a given rule. When this option is enabled in the kernel, the number of consecutive messages concerning a particular rule is capped at the number specified. There is nothing to be gained from 200 identical log messages. With this option set to five, five consecutive messages concerning a particular rule would be logged to syslogd and the remainder identical consecutive messages would be counted and posted to syslogd with a phrase like the following:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>last message repeated 45 times</pre>
</div>
</div>
<div class="paragraph">
<p>All logged packets messages are written by default to <span class="filename">/var/log/security</span>, which is defined in <span class="filename">/etc/syslog.conf</span>.</p>
</div>
</div>
<div class="sect4">
<h5 id="firewalls-ipfw-rules-script">33.4.5.2. Building a Rule Script<a class="anchor" href="#firewalls-ipfw-rules-script"></a></h5>
<div class="paragraph">
<p>Most experienced IPFW users create a file containing the rules and code them in a manner compatible with running them as a script. The major benefit of doing this is the firewall rules can be refreshed in mass without the need of rebooting the system to activate them. This method is convenient in testing new rules as the procedure can be executed as many times as needed. Being a script, symbolic substitution can be used for frequently used values to be substituted into multiple rules.</p>
</div>
<div class="paragraph">
<p>This example script is compatible with the syntax used by the <a href="https://man.freebsd.org/cgi/man.cgi?query=sh&amp;sektion=1&amp;format=html">sh(1)</a>, <a href="https://man.freebsd.org/cgi/man.cgi?query=csh&amp;sektion=1&amp;format=html">csh(1)</a>, and <a href="https://man.freebsd.org/cgi/man.cgi?query=tcsh&amp;sektion=1&amp;format=html">tcsh(1)</a> shells. Symbolic substitution fields are prefixed with a dollar sign ($). Symbolic fields do not have the $ prefix. The value to populate the symbolic field must be enclosed in double quotes (&#34;&#34;).</p>
</div>
<div class="paragraph">
<p>Start the rules file like this:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>############### start of example ipfw rules script #############
#
ipfw -q -f flush       # Delete all rules
# Set defaults
oif=&#34;tun0&#34;             # out interface
odns=&#34;192.0.2.11&#34;      # ISP&#39;s DNS server IP address
cmd=&#34;ipfw -q add &#34;     # build rule prefix
ks=&#34;keep-state&#34;        # just too lazy to key this each time
$cmd 00500 check-state
$cmd 00502 deny all from any to any frag
$cmd 00501 deny tcp from any to any established
$cmd 00600 allow tcp from any to any 80 out via $oif setup $ks
$cmd 00610 allow tcp from any to $odns 53 out via $oif setup $ks
$cmd 00611 allow udp from any to $odns 53 out via $oif $ks
################### End of example ipfw rules script ############</pre>
</div>
</div>
<div class="paragraph">
<p>The rules are not important as the focus of this example is how the symbolic substitution fields are populated.</p>
</div>
<div class="paragraph">
<p>If the above example was in <span class="filename">/etc/ipfw.rules</span>, the rules could be reloaded by the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sh /etc/ipfw.rules</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><span class="filename">/etc/ipfw.rules</span> can be located anywhere and the file can have any name.</p>
</div>
<div class="paragraph">
<p>The same thing could be accomplished by running these commands by hand:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ipfw -q -f flush</span>
<span class="c"># ipfw -q add check-state</span>
<span class="c"># ipfw -q add deny all from any to any frag</span>
<span class="c"># ipfw -q add deny tcp from any to any established</span>
<span class="c"># ipfw -q add allow tcp from any to any 80 out via tun0 setup keep-state</span>
<span class="c"># ipfw -q add allow tcp from any to 192.0.2.11 53 out via tun0 setup keep-state</span>
<span class="c"># ipfw -q add 00611 allow udp from any to 192.0.2.11 53 out via tun0 keep-state</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="firewalls-ipfw-kernelconfig">33.4.6. IPFW Kernel Options<a class="anchor" href="#firewalls-ipfw-kernelconfig"></a></h4>
<div class="paragraph">
<p>In order to statically compile IPFW support into a custom kernel, refer to the instructions in <a href="./#kernelconfig">Configuring the FreeBSD Kernel</a>. The following options are available for the custom kernel configuration file:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>options    IPFIREWALL			# enables IPFW
options    IPFIREWALL_VERBOSE		# enables logging for rules with log keyword to syslogd(8)
options    IPFIREWALL_VERBOSE_LIMIT=5	# limits number of logged packets per-entry
options    IPFIREWALL_DEFAULT_TO_ACCEPT # sets default policy to pass what is not explicitly denied
options    IPFIREWALL_NAT		# enables basic in-kernel NAT support
options    LIBALIAS			# enables full in-kernel NAT support
options    IPFIREWALL_NAT64		# enables in-kernel NAT64 support
options    IPFIREWALL_NPTV6		# enables in-kernel IPv6 NPT support
options    IPFIREWALL_PMOD		# enables protocols modification module support
options    IPDIVERT			# enables NAT through natd(8)</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>IPFW can be loaded as a kernel module: options above are built by default as modules or can be set at runtime using tunables.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="firewalls-ipf">33.5. IPFILTER (IPF)<a class="anchor" href="#firewalls-ipf"></a></h3>
<div class="paragraph">
<p>IPFILTER, also known as IPF, is a cross-platform, open source firewall which has been ported to several operating systems, including FreeBSD, NetBSD, OpenBSD, and Solaris™.</p>
</div>
<div class="paragraph">
<p>IPFILTER is a kernel-side firewall and NAT mechanism that can be controlled and monitored by userland programs. Firewall rules can be set or deleted using ipf, NAT rules can be set or deleted using ipnat, run-time statistics for the kernel parts of IPFILTER can be printed using ipfstat, and ipmon can be used to log IPFILTER actions to the system log files.</p>
</div>
<div class="paragraph">
<p>IPF was originally written using a rule processing logic of &#34;the last matching rule wins&#34; and only used stateless rules. Since then, IPF has been enhanced to include the <code>quick</code> and <code>keep state</code> options.</p>
</div>
<div class="paragraph">
<p>The IPF FAQ is at <a href="http://www.phildev.net/ipf/index.html">http://www.phildev.net/ipf/index.html</a>. A searchable archive of the IPFilter mailing list is available at <a href="http://marc.info/?l=ipfilter">http://marc.info/?l=ipfilter</a>.</p>
</div>
<div class="paragraph">
<p>This section of the Handbook focuses on IPF as it pertains to FreeBSD. It provides examples of rules that contain the <code>quick</code> and <code>keep state</code> options.</p>
</div>
<div class="sect3">
<h4 id="_enabling_ipf">33.5.1. Enabling IPF<a class="anchor" href="#_enabling_ipf"></a></h4>
<div class="paragraph">
<p>IPF is included in the basic FreeBSD install as a kernel loadable module, meaning that a custom kernel is not needed in order to enable IPF.</p>
</div>
<div class="paragraph">
<p>For users who prefer to statically compile IPF support into a custom kernel, refer to the instructions in <a href="./#kernelconfig">Configuring the FreeBSD Kernel</a>. The following kernel options are available:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>options IPFILTER
options IPFILTER_LOG
options IPFILTER_LOOKUP
options IPFILTER_DEFAULT_BLOCK</pre>
</div>
</div>
<div class="paragraph">
<p>where <code>options IPFILTER</code> enables support for IPFILTER, <code>options IPFILTER_LOG</code> enables IPF logging using the <span class="filename">ipl</span> packet logging pseudo-device for every rule that has the <code>log</code> keyword, <code>IPFILTER_LOOKUP</code> enables IP pools in order to speed up IP lookups, and <code>options IPFILTER_DEFAULT_BLOCK</code> changes the default behavior so that any packet not matching a firewall <code>pass</code> rule gets blocked.</p>
</div>
<div class="paragraph">
<p>To configure the system to enable IPF at boot time, add the following entries to <span class="filename">/etc/rc.conf</span>. These entries will also enable logging and <code>default pass all</code>. To change the default policy to <code>block all</code> without compiling a custom kernel, remember to add a <code>block all</code> rule at the end of the ruleset.</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>ipfilter_enable=&#34;YES&#34;             # Start ipf firewall
ipfilter_rules=&#34;/etc/ipf.rules&#34;   # loads rules definition text file
ipv6_ipfilter_rules=&#34;/etc/ipf6.rules&#34; # loads rules definition text file for IPv6
ipmon_enable=&#34;YES&#34;                # Start IP monitor log
ipmon_flags=&#34;-Ds&#34;                 # D = start as daemon
                                  # s = log to syslog
                                  # v = log tcp window, ack, seq
                                  # n = map IP &amp; port to names</pre>
</div>
</div>
<div class="paragraph">
<p>If NAT functionality is needed, also add these lines:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>gateway_enable=&#34;YES&#34;              # Enable as LAN gateway
ipnat_enable=&#34;YES&#34;                # Start ipnat function
ipnat_rules=&#34;/etc/ipnat.rules&#34;    # rules definition file for ipnat</pre>
</div>
</div>
<div class="paragraph">
<p>Then, to start IPF now:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>#  service ipfilter start</pre>
</div>
</div>
<div class="paragraph">
<p>To load the firewall rules, specify the name of the ruleset file using <code>ipf</code>. The following command can be used to replace the currently running firewall rules:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ipf -Fa -f /etc/ipf.rules</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>where <code>-Fa</code> flushes all the internal rules tables and <code>-f</code> specifies the file containing the rules to load.</p>
</div>
<div class="paragraph">
<p>This provides the ability to make changes to a custom ruleset and update the running firewall with a fresh copy of the rules without having to reboot the system. This method is convenient for testing new rules as the procedure can be executed as many times as needed.</p>
</div>
<div class="paragraph">
<p>Refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=ipf&amp;sektion=8&amp;format=html">ipf(8)</a> for details on the other flags available with this command.</p>
</div>
</div>
<div class="sect3">
<h4 id="_ipf_rule_syntax">33.5.2. IPF Rule Syntax<a class="anchor" href="#_ipf_rule_syntax"></a></h4>
<div class="paragraph">
<p>This section describes the IPF rule syntax used to create stateful rules. When creating rules, keep in mind that unless the <code>quick</code> keyword appears in a rule, every rule is read in order, with the <em>last matching rule</em> being the one that is applied. This means that even if the first rule to match a packet is a <code>pass</code>, if there is a later matching rule that is a <code>block</code>, the packet will be dropped. Sample rulesets can be found in <span class="filename">/usr/share/examples/ipfilter</span>.</p>
</div>
<div class="paragraph">
<p>When creating rules, a <code>#</code> character is used to mark the start of a comment and may appear at the end of a rule, to explain that rule’s function, or on its own line. Any blank lines are ignored.</p>
</div>
<div class="paragraph">
<p>The keywords which are used in rules must be written in a specific order, from left to right. Some keywords are mandatory while others are optional. Some keywords have sub-options which may be keywords themselves and also include more sub-options. The keyword order is as follows, where the words shown in uppercase represent a variable and the words shown in lowercase must precede the variable that follows it:</p>
</div>
<div class="paragraph">
<p><code><em>ACTION DIRECTION OPTIONS proto PROTO_TYPE from SRC_ADDR SRC_PORT to DST_ADDR DST_PORT TCP_FLAG|ICMP_TYPE keep state STATE</em></code></p>
</div>
<div class="paragraph">
<p>This section describes each of these keywords and their options. It is not an exhaustive list of every possible option. Refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=ipf&amp;sektion=5&amp;format=html">ipf(5)</a> for a complete description of the rule syntax that can be used when creating IPF rules and examples for using each keyword.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">ACTION</dt>
<dd>
<p>The action keyword indicates what to do with the packet if it matches that rule. Every rule <em>must</em> have an action. The following actions are recognized:</p>
<div class="paragraph">
<p><code>block</code>: drops the packet.</p>
</div>
<div class="paragraph">
<p><code>pass</code>: allows the packet.</p>
</div>
<div class="paragraph">
<p><code>log</code>: generates a log record.</p>
</div>
<div class="paragraph">
<p><code>count</code>: counts the number of packets and bytes which can provide an indication of how often a rule is used.</p>
</div>
<div class="paragraph">
<p><code>auth</code>: queues the packet for further processing by another program.</p>
</div>
<div class="paragraph">
<p><code>call</code>: provides access to functions built into IPF that allow more complex actions.</p>
</div>
<div class="paragraph">
<p><code>decapsulate</code>: removes any headers in order to process the contents of the packet.</p>
</div>
</dd>
<dt class="hdlist1">DIRECTION</dt>
<dd>
<p>Next, each rule must explicitly state the direction of traffic using one of these keywords:</p>
<div class="paragraph">
<p><code>in</code>: the rule is applied against an inbound packet.</p>
</div>
<div class="paragraph">
<p><code>out</code>: the rule is applied against an outbound packet.</p>
</div>
<div class="paragraph">
<p><code>all</code>: the rule applies to either direction.</p>
</div>
<div class="paragraph">
<p>If the system has multiple interfaces, the interface can be specified along with the direction. An example would be <code>in on fxp0</code>.</p>
</div>
</dd>
<dt class="hdlist1">OPTIONS</dt>
<dd>
<p>Options are optional. However, if multiple options are specified, they must be used in the order shown here.</p>
<div class="paragraph">
<p><code>log</code>: when performing the specified ACTION, the contents of the packet’s headers will be written to the <a href="https://man.freebsd.org/cgi/man.cgi?query=ipl&amp;sektion=4&amp;format=html">ipl(4)</a> packet log pseudo-device.</p>
</div>
<div class="paragraph">
<p><code>quick</code>: if a packet matches this rule, the ACTION specified by the rule occurs and no further processing of any following rules will occur for this packet.</p>
</div>
<div class="paragraph">
<p><code>on</code>: must be followed by the interface name as displayed by <a href="https://man.freebsd.org/cgi/man.cgi?query=ifconfig&amp;sektion=8&amp;format=html">ifconfig(8)</a>. The rule will only match if the packet is going through the specified interface in the specified direction.</p>
</div>
<div class="paragraph">
<p>When using the <code>log</code> keyword, the following qualifiers may be used in this order:</p>
</div>
<div class="paragraph">
<p><code>body</code>: indicates that the first 128 bytes of the packet contents will be logged after the headers.</p>
</div>
<div class="paragraph">
<p><code>first</code>: if the <code>log</code> keyword is being used in conjunction with a <code>keep state</code> option, this option is recommended so that only the triggering packet is logged and not every packet which matches the stateful connection.</p>
</div>
<div class="paragraph">
<p>Additional options are available to specify error return messages. Refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=ipf&amp;sektion=5&amp;format=html">ipf(5)</a> for more details.</p>
</div>
</dd>
<dt class="hdlist1">PROTO_TYPE</dt>
<dd>
<p>The protocol type is optional. However, it is mandatory if the rule needs to specify a SRC_PORT or a DST_PORT as it defines the type of protocol. When specifying the type of protocol, use the <code>proto</code> keyword followed by either a protocol number or name from <span class="filename">/etc/protocols</span>. Example protocol names include <code>tcp</code>, <code>udp</code>, or <code>icmp</code>. If PROTO_TYPE is specified but no SRC_PORT or DST_PORT is specified, all port numbers for that protocol will match that rule.</p>
</dd>
<dt class="hdlist1">SRC_ADDR</dt>
<dd>
<p>The <code>from</code> keyword is mandatory and is followed by a keyword which represents the source of the packet. The source can be a hostname, an IP address followed by the CIDR mask, an address pool, or the keyword <code>all</code>. Refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=ipf&amp;sektion=5&amp;format=html">ipf(5)</a> for examples.</p>
<div class="paragraph">
<p>There is no way to match ranges of IP addresses which do not express themselves easily using the dotted numeric form / mask-length notation. The <a class="package" href="https://cgit.freebsd.org/ports/tree/net-mgmt/ipcalc/">net-mgmt/ipcalc</a> package or port may be used to ease the calculation of the CIDR mask. Additional information is available at the utility’s web page: <a href="http://jodies.de/ipcalc">http://jodies.de/ipcalc</a>.</p>
</div>
</dd>
<dt class="hdlist1">SRC_PORT</dt>
<dd>
<p>The port number of the source is optional. However, if it is used, it requires PROTO_TYPE to be first defined in the rule. The port number must also be preceded by the <code>proto</code> keyword.</p>
<div class="paragraph">
<p>A number of different comparison operators are supported: <code>=</code> (equal to), <code>!=</code> (not equal to), <code>&lt;</code> (less than), <code>&gt;</code> (greater than), <code>⇐</code> (less than or equal to), and <code>&gt;=</code> (greater than or equal to).</p>
</div>
<div class="paragraph">
<p>To specify port ranges, place the two port numbers between <code>&lt;&gt;</code> (less than and greater than ), <code>&gt;&lt;</code> (greater than and less than ), or <code>:</code> (greater than or equal to and less than or equal to).</p>
</div>
</dd>
<dt class="hdlist1">DST_ADDR</dt>
<dd>
<p>The <code>to</code> keyword is mandatory and is followed by a keyword which represents the destination of the packet. Similar to SRC_ADDR, it can be a hostname, an IP address followed by the CIDR mask, an address pool, or the keyword <code>all</code>.</p>
</dd>
<dt class="hdlist1">DST_PORT</dt>
<dd>
<p>Similar to SRC_PORT, the port number of the destination is optional. However, if it is used, it requires PROTO_TYPE to be first defined in the rule. The port number must also be preceded by the <code>proto</code> keyword.</p>
</dd>
<dt class="hdlist1">TCP_FLAG|ICMP_TYPE</dt>
<dd>
<p>If <code>tcp</code> is specified as the PROTO_TYPE, flags can be specified as letters, where each letter represents one of the possible TCP flags used to determine the state of a connection. Possible values are: <code>S</code> (SYN), <code>A</code> (ACK), <code>P</code> (PSH), <code>F</code> (FIN), <code>U</code> (URG), <code>R</code> (RST), <code>C</code> (CWN), and <code>E</code> (ECN).</p>
<div class="paragraph">
<p>If <code>icmp</code> is specified as the PROTO_TYPE, the ICMP type to match can be specified. Refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=ipf&amp;sektion=5&amp;format=html">ipf(5)</a> for the allowable types.</p>
</div>
</dd>
<dt class="hdlist1">STATE</dt>
<dd>
<p>If a <code>pass</code> rule contains <code>keep state</code>, IPF will add an entry to its dynamic state table and allow subsequent packets that match the connection. IPF can track state for TCP, UDP, and ICMP sessions. Any packet that IPF can be certain is part of an active session, even if it is a different protocol, will be allowed.</p>
<div class="paragraph">
<p>In IPF, packets destined to go out through the interface connected to the public Internet are first checked against the dynamic state table. If the packet matches the next expected packet comprising an active session conversation, it exits the firewall and the state of the session conversation flow is updated in the dynamic state table. Packets that do not belong to an already active session are checked against the outbound ruleset. Packets coming in from the interface connected to the public Internet are first checked against the dynamic state table. If the packet matches the next expected packet comprising an active session, it exits the firewall and the state of the session conversation flow is updated in the dynamic state table. Packets that do not belong to an already active session are checked against the inbound ruleset.</p>
</div>
<div class="paragraph">
<p>Several keywords can be added after <code>keep state</code>. If used, these keywords set various options that control stateful filtering, such as setting connection limits or connection age. Refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=ipf&amp;sektion=5&amp;format=html">ipf(5)</a> for the list of available options and their descriptions.</p>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_example_ruleset_2">33.5.3. Example Ruleset<a class="anchor" href="#_example_ruleset_2"></a></h4>
<div class="paragraph">
<p>This section demonstrates how to create an example ruleset which only allows services matching <code>pass</code> rules and blocks all others.</p>
</div>
<div class="paragraph">
<p>FreeBSD uses the loopback interface (<span class="filename">lo0</span>) and the IP address <code>127.0.0.1</code> for internal communication. The firewall ruleset must contain rules to allow free movement of these internally used packets:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre># no restrictions on loopback interface
pass in quick on lo0 all
pass out quick on lo0 all</pre>
</div>
</div>
<div class="paragraph">
<p>The public interface connected to the Internet is used to authorize and control access of all outbound and inbound connections. If one or more interfaces are cabled to private networks, those internal interfaces may require rules to allow packets originating from the LAN to flow between the internal networks or to the interface attached to the Internet. The ruleset should be organized into three major sections: any trusted internal interfaces, outbound connections through the public interface, and inbound connections through the public interface.</p>
</div>
<div class="paragraph">
<p>These two rules allow all traffic to pass through a trusted LAN interface named <span class="filename">xl0</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre># no restrictions on inside LAN interface for private network
pass out quick on xl0 all
pass in quick on xl0 all</pre>
</div>
</div>
<div class="paragraph">
<p>The rules for the public interface’s outbound and inbound sections should have the most frequently matched rules placed before less commonly matched rules, with the last rule in the section blocking and logging all packets for that interface and direction.</p>
</div>
<div class="paragraph">
<p>This set of rules defines the outbound section of the public interface named <span class="filename">dc0</span>. These rules keep state and identify the specific services that internal systems are authorized for public Internet access. All the rules use <code>quick</code> and specify the appropriate port numbers and, where applicable, destination addresses.</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre># interface facing Internet (outbound)
# Matches session start requests originating from or behind the
# firewall, destined for the Internet.

# Allow outbound access to public DNS servers.
# Replace x.x.x.x with address listed in /etc/resolv.conf.
# Repeat for each DNS server.
pass out quick on dc0 proto tcp from any to x.x.x.x port = 53 flags S keep state
pass out quick on dc0 proto udp from any to x.x.x.x port = 53 keep state

# Allow access to ISP&#39;s specified DHCP server for cable or DSL networks.
# Use the first rule, then check log for the IP address of DHCP server.
# Then, uncomment the second rule, replace z.z.z.z with the IP address,
# and comment out the first rule
pass out log quick on dc0 proto udp from any to any port = 67 keep state
#pass out quick on dc0 proto udp from any to z.z.z.z port = 67 keep state

# Allow HTTP and HTTPS
pass out quick on dc0 proto tcp from any to any port = 80 flags S keep state
pass out quick on dc0 proto tcp from any to any port = 443 flags S keep state

# Allow email
pass out quick on dc0 proto tcp from any to any port = 110 flags S keep state
pass out quick on dc0 proto tcp from any to any port = 25 flags S keep state

# Allow NTP
pass out quick on dc0 proto tcp from any to any port = 37 flags S keep state

# Allow FTP
pass out quick on dc0 proto tcp from any to any port = 21 flags S keep state

# Allow SSH
pass out quick on dc0 proto tcp from any to any port = 22 flags S keep state

# Allow ping
pass out quick on dc0 proto icmp from any to any icmp-type 8 keep state

# Block and log everything else
block out log first quick on dc0 all</pre>
</div>
</div>
<div class="paragraph">
<p>This example of the rules in the inbound section of the public interface blocks all undesirable packets first. This reduces the number of packets that are logged by the last rule.</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre># interface facing Internet (inbound)
# Block all inbound traffic from non-routable or reserved address spaces
block in quick on dc0 from 192.168.0.0/16 to any    #RFC 1918 private IP
block in quick on dc0 from 172.16.0.0/12 to any     #RFC 1918 private IP
block in quick on dc0 from 10.0.0.0/8 to any        #RFC 1918 private IP
block in quick on dc0 from 127.0.0.0/8 to any       #loopback
block in quick on dc0 from 0.0.0.0/8 to any         #loopback
block in quick on dc0 from 169.254.0.0/16 to any    #DHCP auto-config
block in quick on dc0 from 192.0.2.0/24 to any      #reserved for docs
block in quick on dc0 from 204.152.64.0/23 to any   #Sun cluster interconnect
block in quick on dc0 from 224.0.0.0/3 to any       #Class D &amp; E multicast

# Block fragments and too short tcp packets
block in quick on dc0 all with frags
block in quick on dc0 proto tcp all with short

# block source routed packets
block in quick on dc0 all with opt lsrr
block in quick on dc0 all with opt ssrr

# Block OS fingerprint attempts and log first occurrence
block in log first quick on dc0 proto tcp from any to any flags FUP

# Block anything with special options
block in quick on dc0 all with ipopts

# Block public pings and ident
block in quick on dc0 proto icmp all icmp-type 8
block in quick on dc0 proto tcp from any to any port = 113

# Block incoming Netbios services
block in log first quick on dc0 proto tcp/udp from any to any port = 137
block in log first quick on dc0 proto tcp/udp from any to any port = 138
block in log first quick on dc0 proto tcp/udp from any to any port = 139
block in log first quick on dc0 proto tcp/udp from any to any port = 81</pre>
</div>
</div>
<div class="paragraph">
<p>Any time there are logged messages on a rule with the <code>log first</code> option, run <code>ipfstat -hio</code> to evaluate how many times the rule has been matched. A large number of matches may indicate that the system is under attack.</p>
</div>
<div class="paragraph">
<p>The rest of the rules in the inbound section define which connections are allowed to be initiated from the Internet. The last rule denies all connections which were not explicitly allowed by previous rules in this section.</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre># Allow traffic in from ISP&#39;s DHCP server. Replace z.z.z.z with
# the same IP address used in the outbound section.
pass in quick on dc0 proto udp from z.z.z.z to any port = 68 keep state

# Allow public connections to specified internal web server
pass in quick on dc0 proto tcp from any to x.x.x.x port = 80 flags S keep state

# Block and log only first occurrence of all remaining traffic.
block in log first quick on dc0 all</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_configuring_nat">33.5.4. Configuring NAT<a class="anchor" href="#_configuring_nat"></a></h4>
<div class="paragraph">
<p>To enable NAT, add these statements to <span class="filename">/etc/rc.conf</span> and specify the name of the file containing the NAT rules:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>gateway_enable=&#34;YES&#34;
ipnat_enable=&#34;YES&#34;
ipnat_rules=&#34;/etc/ipnat.rules&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>NAT rules are flexible and can accomplish many different things to fit the needs of both commercial and home users. The rule syntax presented here has been simplified to demonstrate common usage. For a complete rule syntax description, refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=ipnat&amp;sektion=5&amp;format=html">ipnat(5)</a>.</p>
</div>
<div class="paragraph">
<p>The basic syntax for a NAT rule is as follows, where <code>map</code> starts the rule and <em>IF</em> should be replaced with the name of the external interface:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>map IF LAN_IP_RANGE -&gt; PUBLIC_ADDRESS</pre>
</div>
</div>
<div class="paragraph">
<p>The <em>LAN_IP_RANGE</em> is the range of IP addresses used by internal clients. Usually, it is a private address range such as <code>192.168.1.0/24</code>. The <em>PUBLIC_ADDRESS</em> can either be the static external IP address or the keyword <code>0/32</code> which represents the IP address assigned to <em>IF</em>.</p>
</div>
<div class="paragraph">
<p>In IPF, when a packet arrives at the firewall from the LAN with a public destination, it first passes through the outbound rules of the firewall ruleset. Then, the packet is passed to the NAT ruleset which is read from the top down, where the first matching rule wins. IPF tests each NAT rule against the packet’s interface name and source IP address. When a packet’s interface name matches a NAT rule, the packet’s source IP address in the private LAN is checked to see if it falls within the IP address range specified in <em>LAN_IP_RANGE</em>. On a match, the packet has its source IP address rewritten with the public IP address specified by <em>PUBLIC_ADDRESS</em>. IPF posts an entry in its internal NAT table so that when the packet returns from the Internet, it can be mapped back to its original private IP address before being passed to the firewall rules for further processing.</p>
</div>
<div class="paragraph">
<p>For networks that have large numbers of internal systems or multiple subnets, the process of funneling every private IP address into a single public IP address becomes a resource problem. Two methods are available to relieve this issue.</p>
</div>
<div class="paragraph">
<p>The first method is to assign a range of ports to use as source ports. By adding the <code>portmap</code> keyword, NAT can be directed to only use source ports in the specified range:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>map dc0 192.168.1.0/24 -&gt; 0/32 portmap tcp/udp 20000:60000</pre>
</div>
</div>
<div class="paragraph">
<p>Alternately, use the <code>auto</code> keyword which tells NAT to determine the ports that are available for use:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>map dc0 192.168.1.0/24 -&gt; 0/32 portmap tcp/udp auto</pre>
</div>
</div>
<div class="paragraph">
<p>The second method is to use a pool of public addresses. This is useful when there are too many LAN addresses to fit into a single public address and a block of public IP addresses is available. These public addresses can be used as a pool from which NAT selects an IP address as a packet’s address is mapped on its way out.</p>
</div>
<div class="paragraph">
<p>The range of public IP addresses can be specified using a netmask or CIDR notation. These two rules are equivalent:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>map dc0 192.168.1.0/24 -&gt; 204.134.75.0/255.255.255.0
map dc0 192.168.1.0/24 -&gt; 204.134.75.0/24</pre>
</div>
</div>
<div class="paragraph">
<p>A common practice is to have a publically accessible web server or mail server segregated to an internal network segment. The traffic from these servers still has to undergo NAT, but port redirection is needed to direct inbound traffic to the correct server. For example, to map a web server using the internal address <code>10.0.10.25</code> to its public IP address of <code>20.20.20.5</code>, use this rule:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>rdr dc0 20.20.20.5/32 port 80 -&gt; 10.0.10.25 port 80</pre>
</div>
</div>
<div class="paragraph">
<p>If it is the only web server, this rule would also work as it redirects all external HTTP requests to <code>10.0.10.25</code>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>rdr dc0 0.0.0.0/0 port 80 -&gt; 10.0.10.25 port 80</pre>
</div>
</div>
<div class="paragraph">
<p>IPF has a built in FTP proxy which can be used with NAT. It monitors all outbound traffic for active or passive FTP connection requests and dynamically creates temporary filter rules containing the port number used by the FTP data channel. This eliminates the need to open large ranges of high order ports for FTP connections.</p>
</div>
<div class="paragraph">
<p>In this example, the first rule calls the proxy for outbound FTP traffic from the internal LAN. The second rule passes the FTP traffic from the firewall to the Internet, and the third rule handles all non-FTP traffic from the internal LAN:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>map dc0 10.0.10.0/29 -&gt; 0/32 proxy port 21 ftp/tcp
map dc0 0.0.0.0/0 -&gt; 0/32 proxy port 21 ftp/tcp
map dc0 10.0.10.0/29 -&gt; 0/32</pre>
</div>
</div>
<div class="paragraph">
<p>The FTP <code>map</code> rules go before the NAT rule so that when a packet matches an FTP rule, the FTP proxy creates temporary filter rules to let the FTP session packets pass and undergo NAT. All LAN packets that are not FTP will not match the FTP rules but will undergo NAT if they match the third rule.</p>
</div>
<div class="paragraph">
<p>Without the FTP proxy, the following firewall rules would instead be needed. Note that without the proxy, all ports above <code>1024</code> need to be allowed:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre># Allow out LAN PC client FTP to public Internet
# Active and passive modes
pass out quick on rl0 proto tcp from any to any port = 21 flags S keep state

# Allow out passive mode data channel high order port numbers
pass out quick on rl0 proto tcp from any to any port &gt; 1024 flags S keep state

# Active mode let data channel in from FTP server
pass in quick on rl0 proto tcp from any to any port = 20 flags S keep state</pre>
</div>
</div>
<div class="paragraph">
<p>Whenever the file containing the NAT rules is edited, run <code>ipnat</code> with <code>-CF</code> to delete the current NAT rules and flush the contents of the dynamic translation table. Include <code>-f</code> and specify the name of the NAT ruleset to load:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ipnat -CF -f /etc/ipnat.rules</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To display the NAT statistics:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ipnat -s</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To list the NAT table’s current mappings:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ipnat -l</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To turn verbose mode on and display information relating to rule processing and active rules and table entries:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ipnat -v</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_viewing_ipf_statistics">33.5.5. Viewing IPF Statistics<a class="anchor" href="#_viewing_ipf_statistics"></a></h4>
<div class="paragraph">
<p>IPF includes <a href="https://man.freebsd.org/cgi/man.cgi?query=ipfstat&amp;sektion=8&amp;format=html">ipfstat(8)</a> which can be used to retrieve and display statistics which are gathered as packets match rules as they go through the firewall. Statistics are accumulated since the firewall was last started or since the last time they were reset to zero using <code>ipf -Z</code>.</p>
</div>
<div class="paragraph">
<p>The default <code>ipfstat</code> output looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">input packets: blocked 99286 passed 1255609 nomatch 14686 counted 0
 output packets: blocked 4200 passed 1284345 nomatch 14687 counted 0
 input packets logged: blocked 99286 passed 0
 output packets logged: blocked 0 passed 0
 packets logged: input 0 output 0
 log failures: input 3898 output 0
 fragment state<span class="o">(</span><span class="k">in</span><span class="o">)</span>: kept 0 lost 0
 fragment state<span class="o">(</span>out<span class="o">)</span>: kept 0 lost 0
 packet state<span class="o">(</span><span class="k">in</span><span class="o">)</span>: kept 169364 lost 0
 packet state<span class="o">(</span>out<span class="o">)</span>: kept 431395 lost 0
 ICMP replies: 0 TCP RSTs sent: 0
 Result cache hits<span class="o">(</span><span class="k">in</span><span class="o">)</span>: 1215208 <span class="o">(</span>out<span class="o">)</span>: 1098963
 IN Pullups succeeded: 2 failed: 0
 OUT Pullups succeeded: 0 failed: 0
 Fastroute successes: 0 failures: 0
 TCP cksum fails<span class="o">(</span><span class="k">in</span><span class="o">)</span>: 0 <span class="o">(</span>out<span class="o">)</span>: 0
 Packet log flags <span class="nb">set</span>: <span class="o">(</span>0<span class="o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Several options are available. When supplied with either <code>-i</code> for inbound or <code>-o</code> for outbound, the command will retrieve and display the appropriate list of filter rules currently installed and in use by the kernel. To also see the rule numbers, include <code>-n</code>. For example, <code>ipfstat -on</code> displays the outbound rules table with rule numbers:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">@1 pass out on xl0 from any to any
@2 block out on dc0 from any to any
@3 pass out quick on dc0 proto tcp/udp from any to any keep state</code></pre>
</div>
</div>
<div class="paragraph">
<p>Include <code>-h</code> to prefix each rule with a count of how many times the rule was matched. For example, <code>ipfstat -oh</code> displays the outbound internal rules table, prefixing each rule with its usage count:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">2451423 pass out on xl0 from any to any
354727 block out on dc0 from any to any
430918 pass out quick on dc0 proto tcp/udp from any to any keep state</code></pre>
</div>
</div>
<div class="paragraph">
<p>To display the state table in a format similar to <a href="https://man.freebsd.org/cgi/man.cgi?query=top&amp;sektion=1&amp;format=html">top(1)</a>, use <code>ipfstat -t</code>. When the firewall is under attack, this option provides the ability to identify and see the attacking packets. The optional sub-flags give the ability to select the destination or source IP, port, or protocol to be monitored in real time. Refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=ipfstat&amp;sektion=8&amp;format=html">ipfstat(8)</a> for details.</p>
</div>
</div>
<div class="sect3">
<h4 id="_ipf_logging">33.5.6. IPF Logging<a class="anchor" href="#_ipf_logging"></a></h4>
<div class="paragraph">
<p>IPF provides <code>ipmon</code>, which can be used to write the firewall’s logging information in a human readable format. It requires that <code>options IPFILTER_LOG</code> be first added to a custom kernel using the instructions in <a href="./#kernelconfig">Configuring the FreeBSD Kernel</a>.</p>
</div>
<div class="paragraph">
<p>This command is typically run in daemon mode in order to provide a continuous system log file so that logging of past events may be reviewed. Since FreeBSD has a built in <a href="https://man.freebsd.org/cgi/man.cgi?query=syslogd&amp;sektion=8&amp;format=html">syslogd(8)</a> facility to automatically rotate system logs, the default <span class="filename">rc.conf</span> <code>ipmon_flags</code> statement uses <code>-Ds</code>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>ipmon_flags=&#34;-Ds&#34; # D = start as daemon
                  # s = log to syslog
                  # v = log tcp window, ack, seq
                  # n = map IP &amp; port to names</pre>
</div>
</div>
<div class="paragraph">
<p>Logging provides the ability to review, after the fact, information such as which packets were dropped, what addresses they came from, and where they were going. This information is useful in tracking down attackers.</p>
</div>
<div class="paragraph">
<p>Once the logging facility is enabled in <span class="filename">rc.conf</span> and started with <code>service ipmon start</code>, IPF will only log the rules which contain the <code>log</code> keyword. The firewall administrator decides which rules in the ruleset should be logged and normally only deny rules are logged. It is customary to include the <code>log</code> keyword in the last rule in the ruleset. This makes it possible to see all the packets that did not match any of the rules in the ruleset.</p>
</div>
<div class="paragraph">
<p>By default, <code>ipmon -Ds</code> mode uses <code>local0</code> as the logging facility. The following logging levels can be used to further segregate the logged data:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">LOG_INFO - packets logged using the <span class="s2">&#34;log&#34;</span> keyword as the action rather than pass or block.
LOG_NOTICE - packets logged which are also passed
LOG_WARNING - packets logged which are also blocked
LOG_ERR - packets which have been logged and which can be considered short due to an incomplete header</code></pre>
</div>
</div>
<div class="paragraph">
<p>In order to setup IPF to log all data to <span class="filename">/var/log/ipfilter.log</span>, first create the empty file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># touch /var/log/ipfilter.log</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, to write all logged messages to the specified file, add the following statement to <span class="filename">/etc/syslog.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>local0.* /var/log/ipfilter.log</pre>
</div>
</div>
<div class="paragraph">
<p>To activate the changes and instruct <a href="https://man.freebsd.org/cgi/man.cgi?query=syslogd&amp;sektion=8&amp;format=html">syslogd(8)</a> to read the modified <span class="filename">/etc/syslog.conf</span>, run <code>service syslogd reload</code>.</p>
</div>
<div class="paragraph">
<p>Do not forget to edit <span class="filename">/etc/newsyslog.conf</span> to rotate the new log file.</p>
</div>
<div class="paragraph">
<p>Messages generated by <code>ipmon</code> consist of data fields separated by white space. Fields common to all messages are:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The date of packet receipt.</p>
</li>
<li>
<p>The time of packet receipt. This is in the form HH:MM:SS.F, for hours, minutes, seconds, and fractions of a second.</p>
</li>
<li>
<p>The name of the interface that processed the packet.</p>
</li>
<li>
<p>The group and rule number of the rule in the format <code>@0:17</code>.</p>
</li>
<li>
<p>The action: <code>p</code> for passed, <code>b</code> for blocked, <code>S</code> for a short packet, <code>n</code> did not match any rules, and <code>L</code> for a log rule.</p>
</li>
<li>
<p>The addresses written as three fields: the source address and port separated by a comma, the → symbol, and the destination address and port. For example: <code>209.53.17.22,80 → 198.73.220.17,1722</code>.</p>
</li>
<li>
<p><code>PR</code> followed by the protocol name or number: for example, <code>PR tcp</code>.</p>
</li>
<li>
<p><code>len</code> followed by the header length and total length of the packet: for example, <code>len 20 40</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>If the packet is a TCP packet, there will be an additional field starting with a hyphen followed by letters corresponding to any flags that were set. Refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=ipf&amp;sektion=5&amp;format=html">ipf(5)</a> for a list of letters and their flags.</p>
</div>
<div class="paragraph">
<p>If the packet is an ICMP packet, there will be two fields at the end: the first always being &#34;icmp&#34; and the next being the ICMP message and sub-message type, separated by a slash. For example: <code>icmp 3/3</code> for a port unreachable message.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="firewalls-blacklistd">33.6. Blacklistd<a class="anchor" href="#firewalls-blacklistd"></a></h3>
<div class="paragraph">
<p>Blacklistd is a daemon listening to sockets awaiting to receive notifications from other daemons about connection attempts that failed or were successful. It is most widely used in blocking too many connection attempts on open ports. A prime example is SSH running on the internet getting a lot of requests from bots or scripts trying to guess passwords and gain access. Using blacklistd, the daemon can notify the firewall to create a filter rule to block excessive connection attempts from a single source after a number of tries. Blacklistd was first developed on NetBSD and appeared there in version 7. FreeBSD 11 imported blacklistd from NetBSD.</p>
</div>
<div class="paragraph">
<p>This chapter describes how to set up blacklistd, configure it, and provides examples on how to use it. Readers should be familiar with basic firewall concepts like rules. For details, refer to the firewall chapter. PF is used in the examples, but other firewalls available on FreeBSD should be able to work with blacklistd, too.</p>
</div>
<div class="sect3">
<h4 id="_enabling_blacklistd">33.6.1. Enabling Blacklistd<a class="anchor" href="#_enabling_blacklistd"></a></h4>
<div class="paragraph">
<p>The main configuration for blacklistd is stored in <a href="https://man.freebsd.org/cgi/man.cgi?query=blacklistd.conf&amp;sektion=5&amp;format=html">blacklistd.conf(5)</a>. Various command line options are also available to change blacklistd’s run-time behavior. Persistent configuration across reboots should be stored in <span class="filename">/etc/blacklistd.conf</span>. To enable the daemon during system boot, add a <code>blacklistd_enable</code> line to <span class="filename">/etc/rc.conf</span> like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysrc blacklistd_enable=yes</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To start the service manually, run this command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># service blacklistd start</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_creating_a_blacklistd_ruleset">33.6.2. Creating a Blacklistd Ruleset<a class="anchor" href="#_creating_a_blacklistd_ruleset"></a></h4>
<div class="paragraph">
<p>Rules for blacklistd are configured in <a href="https://man.freebsd.org/cgi/man.cgi?query=blacklistd.conf&amp;sektion=5&amp;format=html">blacklistd.conf(5)</a> with one entry per line. Each rule contains a tuple separated by spaces or tabs. Rules either belong to a <code>local</code> or a <code>remote</code>, which applies to the machine where blacklistd is running or an outside source, respectively.</p>
</div>
<div class="sect4">
<h5 id="_local_rules">33.6.2.1. Local Rules<a class="anchor" href="#_local_rules"></a></h5>
<div class="paragraph">
<p>An example blacklistd.conf entry for a local rule looks like this:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>[local]
ssh             stream  *       *               *       3       24h</pre>
</div>
</div>
<div class="paragraph">
<p>All rules that follow the <code>[local]</code> section are treated as local rules (which is the default), applying to the local machine. When a <code>[remote]</code> section is encountered, all rules that follow it are handled as remote machine rules.</p>
</div>
<div class="paragraph">
<p>Seven fields separated by either tabs or spaces define a rule. The first four fields identify the traffic that should be blocklisted. The three fields that follow define backlistd’s behavior. Wildcards are denoted as asterisks (<code>*</code>), matching anything in this field. The first field defines the location. In local rules, these are the network ports. The syntax for the location field is as follows:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>[address|interface][/mask][:port]</pre>
</div>
</div>
<div class="paragraph">
<p>Addresses can be specified as IPv4 in numeric format or IPv6 in square brackets. An interface name like <code><em>em0</em></code> can also be used.</p>
</div>
<div class="paragraph">
<p>The socket type is defined by the second field. TCP sockets are of type <code>stream</code>, whereas UDP is denoted as <code>dgram</code>. The example above uses TCP, since SSH is using that protocol.</p>
</div>
<div class="paragraph">
<p>A protocol can be used in the third field of a blacklistd rule. The following protocols can be used: <code>tcp</code>, <code>udp</code>, <code>tcp6</code>, <code>udp6</code>, or numeric. A wildcard, like in the example, is typically used to match all protocols unless there is a reason to distinguish traffic by a certain protocol.</p>
</div>
<div class="paragraph">
<p>In the fourth field, the effective user or owner of the daemon process that is reporting the event is defined. The username or UID can be used here, as well as a wildcard (see example rule above).</p>
</div>
<div class="paragraph">
<p>The packet filter rule name is declared by the fifth field, which starts the behavior part of the rule. By default, blacklistd puts all blocks under a pf anchor called <code>blacklistd</code> in <span class="filename">pf.conf</span> like this:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>anchor &#34;blacklistd/*&#34; in on $ext_if
block in
pass out</pre>
</div>
</div>
<div class="paragraph">
<p>For separate blocklists, an anchor name can be used in this field. In other cases, the wildcard will suffice. When a name starts with a hyphen (<code>-</code>) it means that an anchor with the default rule name prepended should be used. A modified example from the above using the hyphen would look like this:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>ssh             stream  *       *               -ssh       3       24h</pre>
</div>
</div>
<div class="paragraph">
<p>With such a rule, any new blocklist rules are added to an anchor called <code>blacklistd-ssh</code>.</p>
</div>
<div class="paragraph">
<p>To block whole subnets for a single rule violation, a <code>/</code> in the rule name can be used. This causes the remaining portion of the name to be interpreted as the mask to be applied to the address specified in the rule. For example, this rule would block every address adjoining <code>/24</code>.</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>22              stream  tcp       *               */24    3       24h</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>It is important to specify the proper protocol here. IPv4 and IPv6 treat /24 differently, that is the reason why <code>*</code> cannot be used in the third field for this rule.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>This rule defines that if any one host in that network is misbehaving, everything else on that network will be blocked, too.</p>
</div>
<div class="paragraph">
<p>The sixth field, called <code>nfail</code>, sets the number of login failures required to blocklist the remote IP in question. When a wildcard is used at this position, it means that blocks will never happen. In the example rule above, a limit of three is defined meaning that after three attempts to log into SSH on one connection, the IP is blocked.</p>
</div>
<div class="paragraph">
<p>The last field in a blacklistd rule definition specifies how long a host is blocklisted. The default unit is seconds, but suffixes like <code>m</code>, <code>h</code>, and <code>d</code> can also be specified for minutes, hours, and days, respectively.</p>
</div>
<div class="paragraph">
<p>The example rule in its entirety means that after three times authenticating to SSH will result in a new PF block rule for that host. Rule matches are performed by first checking local rules one after another, from most specific to least specific. When a match occurs, the <code>remote</code> rules are applied and the name, <code>nfail</code>, and disable fields are changed by the <code>remote</code> rule that matched.</p>
</div>
</div>
<div class="sect4">
<h5 id="_remote_rules">33.6.2.2. Remote Rules<a class="anchor" href="#_remote_rules"></a></h5>
<div class="paragraph">
<p>Remote rules are used to specify how blacklistd changes its behavior depending on the remote host currently being evaluated. Each field in a remote rule is the same as in a local rule. The only difference is in the way blacklistd is using them. To explain it, this example rule is used:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>[remote]
203.0.113.128/25 *      *       *               =/25    =       48h</pre>
</div>
</div>
<div class="paragraph">
<p>The address field can be an IP address (either v4 or v6), a port or both. This allows setting special rules for a specific remote address range like in this example. The fields for socket type, protocol and owner are identically interpreted as in the local rule.</p>
</div>
<div class="paragraph">
<p>The name fields is different though: the equal sign (<code>=</code>) in a remote rule tells blacklistd to use the value from the matching local rule. It means that the firewall rule entry is taken and the <code>/25</code> prefix (a netmask of <code>255.255.255.128</code>) is added. When a connection from that address range is blocklisted, the entire subnet is affected. A PF anchor name can also be used here, in which case blacklistd will add rules for this address block to the anchor of that name. The default table is used when a wildcard is specified.</p>
</div>
<div class="paragraph">
<p>A custom number of failures in the <code>nfail</code> column can be defined for an address. This is useful for exceptions to a specific rule, to maybe allow someone a less strict application of rules or a bit more leniency in login tries. Blocking is disabled when an asterisk is used in this sixth field.</p>
</div>
<div class="paragraph">
<p>Remote rules allow a stricter enforcement of limits on attempts to log in compared to attempts coming from a local network like an office.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_blacklistd_client_configuration">33.6.3. Blacklistd Client Configuration<a class="anchor" href="#_blacklistd_client_configuration"></a></h4>
<div class="paragraph">
<p>There are a few software packages in FreeBSD that can utilize blacklistd’s functionality. The two most prominent ones are <a href="https://man.freebsd.org/cgi/man.cgi?query=ftpd&amp;sektion=8&amp;format=html">ftpd(8)</a> and <a href="https://man.freebsd.org/cgi/man.cgi?query=sshd&amp;sektion=8&amp;format=html">sshd(8)</a> to block excessive connection attempts. To activate blacklistd in the SSH daemon, add the following line to <span class="filename">/etc/ssh/sshd_config</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>UseBlacklist yes</pre>
</div>
</div>
<div class="paragraph">
<p>Restart sshd afterwards to make these changes take effect.</p>
</div>
<div class="paragraph">
<p>Blacklisting for <a href="https://man.freebsd.org/cgi/man.cgi?query=ftpd&amp;sektion=8&amp;format=html">ftpd(8)</a> is enabled using <code>-B</code>, either in <span class="filename">/etc/inetd.conf</span> or as a flag in <span class="filename">/etc/rc.conf</span> like this:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>ftpd_flags=&#34;-B&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>That is all that is needed to make these programs talk to blacklistd.</p>
</div>
</div>
<div class="sect3">
<h4 id="_blacklistd_management">33.6.4. Blacklistd Management<a class="anchor" href="#_blacklistd_management"></a></h4>
<div class="paragraph">
<p>Blacklistd provides the user with a management utility called <a href="https://man.freebsd.org/cgi/man.cgi?query=blacklistctl&amp;sektion=8&amp;format=html">blacklistctl(8)</a>. It displays blocked addresses and networks that are blocklisted by the rules defined in <a href="https://man.freebsd.org/cgi/man.cgi?query=blacklistd.conf&amp;sektion=5&amp;format=html">blacklistd.conf(5)</a>. To see the list of currently blocked hosts, use <code>dump</code> combined with <code>-b</code> like this.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># blacklistctl dump -b</span>
      address/ma:port id      nfail   last access
213.0.123.128/25:22   OK      6/3     2019/06/08 14:30:19</code></pre>
</div>
</div>
<div class="paragraph">
<p>This example shows that there were 6 out of three permitted attempts on port 22 coming from the address range <code>213.0.123.128/25</code>. There are more attempts listed than are allowed because SSH allows a client to try multiple logins on a single TCP connection. A connection that is currently going on is not stopped by blacklistd. The last connection attempt is listed in the <code>last access</code> column of the output.</p>
</div>
<div class="paragraph">
<p>To see the remaining time that this host will be on the blocklist, add <code>-r</code> to the previous command.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># blacklistctl dump -br</span>
      address/ma:port id      nfail   remaining <span class="nb">time
</span>213.0.123.128/25:22   OK      6/3     36s</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example, there are 36s seconds left until this host will not be blocked any more.</p>
</div>
</div>
<div class="sect3">
<h4 id="_removing_hosts_from_the_block_list">33.6.5. Removing Hosts from the Block List<a class="anchor" href="#_removing_hosts_from_the_block_list"></a></h4>
<div class="paragraph">
<p>Sometimes it is necessary to remove a host from the block list before the remaining time expires. Unfortunately, there is no functionality in blacklistd to do that. However, it is possible to remove the address from the PF table using pfctl. For each blocked port, there is a child anchor inside the blacklistd anchor defined in <span class="filename">/etc/pf.conf</span>. For example, if there is a child anchor for blocking port 22 it is called <code>blacklistd/22</code>. There is a table inside that child anchor that contains the blocked addresses. This table is called port followed by the port number. In this example, it would be called <code>port22</code>. With that information at hand, it is now possible to use <a href="https://man.freebsd.org/cgi/man.cgi?query=pfctl&amp;sektion=8&amp;format=html">pfctl(8)</a> to display all addresses listed like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pfctl -a blacklistd/22 -t port22 -T show</span>
...
213.0.123.128/25
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>After identifying the address to be unblocked from the list, the following command removes it from the list:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pfctl -a blacklistd/22 -t port22 -T delete 213.0.123.128/25</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The address is now removed from PF, but will still show up in the blacklistctl list, since it does not know about any changes made in PF. The entry in blacklistd’s database will eventually expire and be removed from its output. The entry will be added again if the host is matching one of the block rules in blacklistd again.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="advanced-networking">Chapter 34. Advanced Networking<a class="anchor" href="#advanced-networking"></a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="advanced-networking-synopsis">34.1. Synopsis<a class="anchor" href="#advanced-networking-synopsis"></a></h3>
<div class="paragraph">
<p>This chapter covers a number of advanced networking topics.</p>
</div>
<div class="paragraph">
<p>After reading this chapter, you will know:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The basics of gateways and routes.</p>
</li>
<li>
<p>How to set up USB tethering.</p>
</li>
<li>
<p>How to set up IEEE® 802.11 and Bluetooth® devices.</p>
</li>
<li>
<p>How to make FreeBSD act as a bridge.</p>
</li>
<li>
<p>How to set up network PXE booting.</p>
</li>
<li>
<p>How to enable and utilize the features of the Common Address Redundancy Protocol (CARP) in FreeBSD.</p>
</li>
<li>
<p>How to configure multiple VLANs on FreeBSD.</p>
</li>
<li>
<p>Configure bluetooth headset.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Before reading this chapter, you should:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Understand the basics of the <span class="filename">/etc/rc</span> scripts.</p>
</li>
<li>
<p>Be familiar with basic network terminology.</p>
</li>
<li>
<p>Understand basic network configuration on FreeBSD (<a href="./#network">FreeBSD network</a>).</p>
</li>
<li>
<p>Know how to configure and install a new FreeBSD kernel (<a href="./#kernelconfig">Configuring the FreeBSD Kernel</a>).</p>
</li>
<li>
<p>Know how to install additional third-party software (<a href="./#ports">Installing Applications: Packages and Ports</a>).</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="network-routing">34.2. Gateways and Routes<a class="anchor" href="#network-routing"></a></h3>
<div class="paragraph">
<p><em>Routing</em> is the mechanism that allows a system to find the network path to another system. A <em>route</em> is a defined pair of addresses which represent the &#34;destination&#34; and a &#34;gateway&#34;. The route indicates that when trying to get to the specified destination, send the packets through the specified gateway. There are three types of destinations: individual hosts, subnets, and &#34;default&#34;. The &#34;default route&#34; is used if no other routes apply. There are also three types of gateways: individual hosts, interfaces, also called links, and Ethernet hardware (MAC) addresses. Known routes are stored in a routing table.</p>
</div>
<div class="paragraph">
<p>This section provides an overview of routing basics. It then demonstrates how to configure a FreeBSD system as a router and offers some troubleshooting tips.</p>
</div>
<div class="sect3">
<h4 id="network-routing-default">34.2.1. Routing Basics<a class="anchor" href="#network-routing-default"></a></h4>
<div class="paragraph">
<p>To view the routing table of a FreeBSD system, use <a href="https://man.freebsd.org/cgi/man.cgi?query=netstat&amp;sektion=1&amp;format=html">netstat(1)</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>netstat -r
Routing tables

Internet:
Destination      Gateway            Flags     Refs     Use     Netif Expire
default          outside-gw         UGS        37      418       em0
localhost        localhost          UH          0      181       lo0
test0            0:e0:b5:36:cf:4f   UHLW        5    63288       re0     77
10.20.30.255     link#1             UHLW        1     2421
example.com      link#1             UC          0        0
host1            0:e0:a8:37:8:1e    UHLW        3     4601       lo0
host2            0:e0:a8:37:8:1e    UHLW        0        5       lo0 <span class="o">=</span>&gt;
host2.example.com link#1            UC          0        0
224              link#1             UC          0        0</code></pre>
</div>
</div>
<div class="paragraph">
<p>The entries in this example are as follows:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">default</dt>
<dd>
<p>The first route in this table specifies the <code>default</code> route. When the local system needs to make a connection to a remote host, it checks the routing table to determine if a known path exists. If the remote host matches an entry in the table, the system checks to see if it can connect using the interface specified in that entry.</p>
<div class="paragraph">
<p>If the destination does not match an entry, or if all known paths fail, the system uses the entry for the default route. For hosts on a local area network, the <code>Gateway</code> field in the default route is set to the system which has a direct connection to the Internet. When reading this entry, verify that the <code>Flags</code> column indicates that the gateway is usable (<code>UG</code>).</p>
</div>
<div class="paragraph">
<p>The default route for a machine which itself is functioning as the gateway to the outside world will be the gateway machine at the Internet Service Provider (ISP).</p>
</div>
</dd>
<dt class="hdlist1">localhost</dt>
<dd>
<p>The second route is the <code>localhost</code> route. The interface specified in the <code>Netif</code> column for <code>localhost</code> is <span class="filename">lo0</span>, also known as the loopback device. This indicates that all traffic for this destination should be internal, rather than sending it out over the network.</p>
</dd>
<dt class="hdlist1">MAC address</dt>
<dd>
<p>The addresses beginning with <code>0:e0:</code> are MAC addresses. FreeBSD will automatically identify any hosts, <code>test0</code> in the example, on the local Ethernet and add a route for that host over the Ethernet interface, <span class="filename">re0</span>. This type of route has a timeout, seen in the <code>Expire</code> column, which is used if the host does not respond in a specific amount of time. When this happens, the route to this host will be automatically deleted. These hosts are identified using the Routing Information Protocol (RIP), which calculates routes to local hosts based upon a shortest path determination.</p>
</dd>
<dt class="hdlist1">subnet</dt>
<dd>
<p>FreeBSD will automatically add subnet routes for the local subnet. In this example, <code>10.20.30.255</code> is the broadcast address for the subnet <code>10.20.30</code> and <code>example.com</code> is the domain name associated with that subnet. The designation <code>link#1</code> refers to the first Ethernet card in the machine.</p>
<div class="paragraph">
<p>Local network hosts and local subnets have their routes automatically configured by a daemon called <a href="https://man.freebsd.org/cgi/man.cgi?query=routed&amp;sektion=8&amp;format=html">routed(8)</a>. If it is not running, only routes which are statically defined by the administrator will exist.</p>
</div>
</dd>
<dt class="hdlist1">host</dt>
<dd>
<p>The <code>host1</code> line refers to the host by its Ethernet address. Since it is the sending host, FreeBSD knows to use the loopback interface (<span class="filename">lo0</span>) rather than the Ethernet interface.</p>
<div class="paragraph">
<p>The two <code>host2</code> lines represent aliases which were created using <a href="https://man.freebsd.org/cgi/man.cgi?query=ifconfig&amp;sektion=8&amp;format=html">ifconfig(8)</a>. The <code>⇒</code> symbol after the <span class="filename">lo0</span> interface says that an alias has been set in addition to the loopback address. Such routes only show up on the host that supports the alias and all other hosts on the local network will have a <code>link#1</code> line for such routes.</p>
</div>
</dd>
<dt class="hdlist1">224</dt>
<dd>
<p>The final line (destination subnet <code>224</code>) deals with multicasting.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Various attributes of each route can be seen in the <code>Flags</code> column. <a href="#routeflags">Commonly Seen Routing Table Flags</a> summarizes some of these flags and their meanings:</p>
</div>
<table id="routeflags" class="tableblock frame-none grid-all stretch">
<caption class="title">表 47. Commonly Seen Routing Table Flags</caption>
<colgroup>
<col style="width: 50%;"/>
<col style="width: 50%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Flag</th>
<th class="tableblock halign-left valign-top">Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">U</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The route is active (up).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">H</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The route destination is a single host.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">G</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Send anything for this destination on to this gateway, which will figure out from there where to send it.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">S</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This route was statically configured.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">C</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Clones a new route based upon this route for machines to connect to. This type of route is normally used for local networks.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">W</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The route was auto-configured based upon a local area network (clone) route.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">L</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Route involves references to Ethernet (link) hardware.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>On a FreeBSD system, the default route can defined in <span class="filename">/etc/rc.conf</span> by specifying the IP address of the default gateway:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>defaultrouter=&#34;10.20.30.1&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>It is also possible to manually add the route using <code>route</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># route add default 10.20.30.1</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that manually added routes will not survive a reboot. For more information on manual manipulation of network routing tables, refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=route&amp;sektion=8&amp;format=html">route(8)</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="network-static-routes">34.2.2. Configuring a Router with Static Routes<a class="anchor" href="#network-static-routes"></a></h4>
<div class="paragraph">
<p>A FreeBSD system can be configured as the default gateway, or router, for a network if it is a dual-homed system. A dual-homed system is a host which resides on at least two different networks. Typically, each network is connected to a separate network interface, though IP aliasing can be used to bind multiple addresses, each on a different subnet, to one physical interface.</p>
</div>
<div class="paragraph">
<p>In order for the system to forward packets between interfaces, FreeBSD must be configured as a router. Internet standards and good engineering practice prevent the FreeBSD Project from enabling this feature by default, but it can be configured to start at boot by adding this line to <span class="filename">/etc/rc.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>gateway_enable=&#34;YES&#34;          # Set to YES if this host will be a gateway</pre>
</div>
</div>
<div class="paragraph">
<p>To enable routing now, set the <a href="https://man.freebsd.org/cgi/man.cgi?query=sysctl&amp;sektion=8&amp;format=html">sysctl(8)</a> variable <code>net.inet.ip.forwarding</code> to <code>1</code>. To stop routing, reset this variable to <code>0</code>.</p>
</div>
<div class="paragraph">
<p>The routing table of a router needs additional routes so it knows how to reach other networks. Routes can be either added manually using static routes or routes can be automatically learned using a routing protocol. Static routes are appropriate for small networks and this section describes how to add a static routing entry for a small network.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>For large networks, static routes quickly become unscalable. FreeBSD comes with the standard BSD routing daemon <a href="https://man.freebsd.org/cgi/man.cgi?query=routed&amp;sektion=8&amp;format=html">routed(8)</a>, which provides the routing protocols RIP, versions 1 and 2, and IRDP. Support for the BGP and OSPF routing protocols can be installed using the <a class="package" href="https://cgit.freebsd.org/ports/tree/net/quagga/">net/quagga</a> package or port.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Consider the following network:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/advanced-networking/static-routes.png" alt="static routes"/>
</div>
</div>
<div class="paragraph">
<p>In this scenario, <code>RouterA</code> is a FreeBSD machine that is acting as a router to the rest of the Internet. It has a default route set to <code>10.0.0.1</code> which allows it to connect with the outside world. <code>RouterB</code> is already configured to use <code>192.168.1.1</code> as its default gateway.</p>
</div>
<div class="paragraph">
<p>Before adding any static routes, the routing table on <code>RouterA</code> looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>netstat -nr
Routing tables

Internet:
Destination        Gateway            Flags    Refs      Use  Netif  Expire
default            10.0.0.1           UGS         0    49378    xl0
127.0.0.1          127.0.0.1          UH          0        6    lo0
10.0.0.0/24        link#1             UC          0        0    xl0
192.168.1.0/24     link#2             UC          0        0    xl1</code></pre>
</div>
</div>
<div class="paragraph">
<p>With the current routing table, <code>RouterA</code> does not have a route to the <code>192.168.2.0/24</code> network. The following command adds the <code>Internal Net 2</code> network to <code>RouterA</code>&#39;s routing table using <code>192.168.1.2</code> as the next hop:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># route add -net 192.168.2.0/24 192.168.1.2</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, <code>RouterA</code> can reach any host on the <code>192.168.2.0/24</code> network. However, the routing information will not persist if the FreeBSD system reboots. If a static route needs to be persistent, add it to <span class="filename">/etc/rc.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre># Add Internal Net 2 as a persistent static route
static_routes=&#34;internalnet2&#34;
route_internalnet2=&#34;-net 192.168.2.0/24 192.168.1.2&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>static_routes</code> configuration variable is a list of strings separated by a space, where each string references a route name. The variable <code>route_internalnet2</code> contains the static route for that route name.</p>
</div>
<div class="paragraph">
<p>Using more than one string in <code>static_routes</code> creates multiple static routes. The following shows an example of adding static routes for the <code>192.168.0.0/24</code> and <code>192.168.1.0/24</code> networks:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>static_routes=&#34;net1 net2&#34;
route_net1=&#34;-net 192.168.0.0/24 192.168.0.1&#34;
route_net2=&#34;-net 192.168.1.0/24 192.168.1.1&#34;</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="network-routing-troubleshooting">34.2.3. Troubleshooting<a class="anchor" href="#network-routing-troubleshooting"></a></h4>
<div class="paragraph">
<p>When an address space is assigned to a network, the service provider configures their routing tables so that all traffic for the network will be sent to the link for the site. But how do external sites know to send their packets to the network’s ISP?</p>
</div>
<div class="paragraph">
<p>There is a system that keeps track of all assigned address spaces and defines their point of connection to the Internet backbone, or the main trunk lines that carry Internet traffic across the country and around the world. Each backbone machine has a copy of a master set of tables, which direct traffic for a particular network to a specific backbone carrier, and from there down the chain of service providers until it reaches a particular network.</p>
</div>
<div class="paragraph">
<p>It is the task of the service provider to advertise to the backbone sites that they are the point of connection, and thus the path inward, for a site. This is known as route propagation.</p>
</div>
<div class="paragraph">
<p>Sometimes, there is a problem with route propagation and some sites are unable to connect. Perhaps the most useful command for trying to figure out where routing is breaking down is <code>traceroute</code>. It is useful when <code>ping</code> fails.</p>
</div>
<div class="paragraph">
<p>When using <code>traceroute</code>, include the address of the remote host to connect to. The output will show the gateway hosts along the path of the attempt, eventually either reaching the target host, or terminating because of a lack of connection. For more information, refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=traceroute&amp;sektion=8&amp;format=html">traceroute(8)</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="network-routing-multicast">34.2.4. Multicast Considerations<a class="anchor" href="#network-routing-multicast"></a></h4>
<div class="paragraph">
<p>FreeBSD natively supports both multicast applications and multicast routing. Multicast applications do not require any special configuration in order to run on FreeBSD. Support for multicast routing requires that the following option be compiled into a custom kernel:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>options MROUTING</pre>
</div>
</div>
<div class="paragraph">
<p>The multicast routing daemon, mrouted can be installed using the <a class="package" href="https://cgit.freebsd.org/ports/tree/net/mrouted/">net/mrouted</a> package or port. This daemon implements the DVMRP multicast routing protocol and is configured by editing <span class="filename">/usr/local/etc/mrouted.conf</span> in order to set up the tunnels and DVMRP. The installation of mrouted also installs map-mbone and mrinfo, as well as their associated man pages. Refer to these for configuration examples.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>DVMRP has largely been replaced by the PIM protocol in many multicast installations. Refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=pim&amp;sektion=4&amp;format=html">pim(4)</a> for more information.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="configtuning-virtual-hosts">34.3. Virtual Hosts<a class="anchor" href="#configtuning-virtual-hosts"></a></h3>
<div class="paragraph">
<p>A common use of FreeBSD is virtual site hosting, where one server appears to the network as many servers. This is achieved by assigning multiple network addresses to a single interface.</p>
</div>
<div class="paragraph">
<p>A given network interface has one &#34;real&#34; address, and may have any number of &#34;alias&#34; addresses. These aliases are normally added by placing alias entries in <span class="filename">/etc/rc.conf</span>, as seen in this example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysrc ifconfig_fxp0_alias0=&#34;inet xxx.xxx.xxx.xxx netmask xxx.xxx.xxx.xxx&#34;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Alias entries must start with <code>alias<em>0</em></code> using a sequential number such as <code>alias0</code>, <code>alias1</code>, and so on. The configuration process will stop at the first missing number.</p>
</div>
<div class="paragraph">
<p>The calculation of alias netmasks is important. For a given interface, there must be one address which correctly represents the network’s netmask. Any other addresses which fall within this network must have a netmask of all <code>1</code>s, expressed as either <code>255.255.255.255</code> or <code>0xffffffff</code>.</p>
</div>
<div class="paragraph">
<p>For example, consider the case where the <code>fxp0</code> interface is connected to two networks: <code>10.1.1.0</code> with a netmask of <code>255.255.255.0</code> and <code>202.0.75.16</code> with a netmask of <code>255.255.255.240</code>. The system is to be configured to appear in the ranges <code>10.1.1.1</code> through <code>10.1.1.5</code> and <code>202.0.75.17</code> through <code>202.0.75.20</code>. Only the first address in a given network range should have a real netmask. All the rest (<code>10.1.1.2</code> through <code>10.1.1.5</code> and <code>202.0.75.18</code> through <code>202.0.75.20</code>) must be configured with a netmask of <code>255.255.255.255</code>.</p>
</div>
<div class="paragraph">
<p>The following <span class="filename">/etc/rc.conf</span> entries configure the adapter correctly for this scenario:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysrc ifconfig_fxp0=&#34;inet 10.1.1.1 netmask 255.255.255.0&#34;</span>
<span class="c"># sysrc ifconfig_fxp0_alias0=&#34;inet 10.1.1.2 netmask 255.255.255.255&#34;</span>
<span class="c"># sysrc ifconfig_fxp0_alias1=&#34;inet 10.1.1.3 netmask 255.255.255.255&#34;</span>
<span class="c"># sysrc ifconfig_fxp0_alias2=&#34;inet 10.1.1.4 netmask 255.255.255.255&#34;</span>
<span class="c"># sysrc ifconfig_fxp0_alias3=&#34;inet 10.1.1.5 netmask 255.255.255.255&#34;</span>
<span class="c"># sysrc ifconfig_fxp0_alias4=&#34;inet 202.0.75.17 netmask 255.255.255.240&#34;</span>
<span class="c"># sysrc ifconfig_fxp0_alias5=&#34;inet 202.0.75.18 netmask 255.255.255.255&#34;</span>
<span class="c"># sysrc ifconfig_fxp0_alias6=&#34;inet 202.0.75.19 netmask 255.255.255.255&#34;</span>
<span class="c"># sysrc ifconfig_fxp0_alias7=&#34;inet 202.0.75.20 netmask 255.255.255.255&#34;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A simpler way to express this is with a space-separated list of IP address ranges. The first address will be given the indicated subnet mask and the additional addresses will have a subnet mask of <code>255.255.255.255</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sysrc ifconfig_fxp0_aliases=&#34;inet 10.1.1.1-5/24 inet 202.0.75.17-20/28&#34;</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="network-advanced-wireless">34.4. Wireless Advanced Authentication<a class="anchor" href="#network-advanced-wireless"></a></h3>
<div class="paragraph">
<p>FreeBSD supports different ways of connecting to a wireless network. This section describes how to perform advanced authentication to a Wireless Network.</p>
</div>
<div class="paragraph">
<p>To make a connection and basic authentication to a wireless network the section <a href="./#wireless-authentication">Connection and Authentication to a Wireless Network</a> in the Network Chapter describes how to do it.</p>
</div>
<div class="sect3">
<h4 id="network-wireless-wpa-eap-tls">34.4.1. WPA with EAP-TLS<a class="anchor" href="#network-wireless-wpa-eap-tls"></a></h4>
<div class="paragraph">
<p>The second way to use WPA is with an 802.1X backend authentication server. In this case, WPA is called WPA Enterprise to differentiate it from the less secure WPA Personal. Authentication in WPA Enterprise is based on the Extensible Authentication Protocol (EAP).</p>
</div>
<div class="paragraph">
<p>EAP does not come with an encryption method. Instead, EAP is embedded inside an encrypted tunnel. There are many EAP authentication methods, but EAP-TLS, EAP-TTLS, and EAP-PEAP are the most common.</p>
</div>
<div class="paragraph">
<p>EAP with Transport Layer Security (EAP-TLS) is a well-supported wireless authentication protocol since it was the first EAP method to be certified by the <a href="http://www.wi-fi.org/">Wi-Fi Alliance</a>. EAP-TLS requires three certificates to run: the certificate of the Certificate Authority (CA) installed on all machines, the server certificate for the authentication server, and one client certificate for each wireless client. In this EAP method, both the authentication server and wireless client authenticate each other by presenting their respective certificates, and then verify that these certificates were signed by the organization’s CA.</p>
</div>
<div class="paragraph">
<p>As previously, the configuration is done via <span class="filename">/etc/wpa_supplicant.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>network={
  ssid=&#34;freebsdap&#34; <i class="conum" data-value="1"></i><b>(1)</b>
  proto=RSN  <i class="conum" data-value="2"></i><b>(2)</b>
  key_mgmt=WPA-EAP <i class="conum" data-value="3"></i><b>(3)</b>
  eap=TLS <i class="conum" data-value="4"></i><b>(4)</b>
  identity=&#34;loader&#34; <i class="conum" data-value="5"></i><b>(5)</b>
  ca_cert=&#34;/etc/certs/cacert.pem&#34; <i class="conum" data-value="6"></i><b>(6)</b>
  client_cert=&#34;/etc/certs/clientcert.pem&#34; <i class="conum" data-value="7"></i><b>(7)</b>
  private_key=&#34;/etc/certs/clientkey.pem&#34; <i class="conum" data-value="8"></i><b>(8)</b>
  private_key_passwd=&#34;freebsdmallclient&#34; <i class="conum" data-value="9"></i><b>(9)</b>
}</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This field indicates the network name (SSID). &lt;.&gt; This example uses the RSN IEEE® 802.11i protocol, also known as WPA2. &lt;.&gt; The <code>key_mgmt</code> line refers to the key management protocol to use. In this example, it is WPA using EAP authentication. &lt;.&gt; This field indicates the EAP method for the connection. &lt;.&gt; The <code>identity</code> field contains the identity string for EAP. &lt;.&gt; The <code>ca_cert</code> field indicates the pathname of the CA certificate file. This file is needed to verify the server certificate. &lt;.&gt; The <code>client_cert</code> line gives the pathname to the client certificate file. This certificate is unique to each wireless client of the network. &lt;.&gt; The <code>private_key</code> field is the pathname to the client certificate private key file. &lt;.&gt; The <code>private_key_passwd</code> field contains the passphrase for the private key.</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Then, add the following lines to <span class="filename">/etc/rc.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>wlans_ath0=&#34;wlan0&#34;
ifconfig_wlan0=&#34;WPA DHCP&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>The next step is to bring up the interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># service netif start</span>
Starting wpa_supplicant.
DHCPREQUEST on wlan0 to 255.255.255.255 port 67 interval 7
DHCPREQUEST on wlan0 to 255.255.255.255 port 67 interval 15
DHCPACK from 192.168.0.20
bound to 192.168.0.254 -- renewal <span class="k">in </span>300 seconds.
wlan0: <span class="nv">flags</span><span class="o">=</span>8843&lt;UP,BROADCAST,RUNNING,SIMPLEX,MULTICAST&gt; mtu 1500
      ether 00:11:95:d5:43:62
      inet 192.168.0.254 netmask 0xffffff00 broadcast 192.168.0.255
      media: IEEE 802.11 Wireless Ethernet DS/11Mbps mode 11g
      status: associated
      ssid freebsdap channel 1 <span class="o">(</span>2412 Mhz 11g<span class="o">)</span> bssid 00:11:95:c3:0d:ac
      country US ecm authmode WPA2/802.11i privacy ON deftxkey UNDEF
      AES-CCM 3:128-bit txpower 21.5 bmiss 7 scanvalid 450 bgscan
      bgscanintvl 300 bgscanidle 250 roam:rssi 7 roam:rate 5 protmode CTS
      wme burst roaming MANUAL</code></pre>
</div>
</div>
<div class="paragraph">
<p>It is also possible to bring up the interface manually using <a href="https://man.freebsd.org/cgi/man.cgi?query=wpa_supplicant&amp;sektion=8&amp;format=html">wpa_supplicant(8)</a> and <a href="https://man.freebsd.org/cgi/man.cgi?query=ifconfig&amp;sektion=8&amp;format=html">ifconfig(8)</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="network-wireless-wpa-eap-ttls">34.4.2. WPA with EAP-TTLS<a class="anchor" href="#network-wireless-wpa-eap-ttls"></a></h4>
<div class="paragraph">
<p>With EAP-TLS, both the authentication server and the client need a certificate. With EAP-TTLS, a client certificate is optional. This method is similar to a web server which creates a secure SSL tunnel even if visitors do not have client-side certificates. EAP-TTLS uses an encrypted TLS tunnel for safe transport of the authentication data.</p>
</div>
<div class="paragraph">
<p>The required configuration can be added to <span class="filename">/etc/wpa_supplicant.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>network={
  ssid=&#34;freebsdap&#34;
  proto=RSN
  key_mgmt=WPA-EAP
  eap=TTLS <i class="conum" data-value="1"></i><b>(1)</b>
  identity=&#34;test&#34; <i class="conum" data-value="2"></i><b>(2)</b>
  password=&#34;test&#34; <i class="conum" data-value="3"></i><b>(3)</b>
  ca_cert=&#34;/etc/certs/cacert.pem&#34; <i class="conum" data-value="4"></i><b>(4)</b>
  phase2=&#34;auth=MD5&#34; <i class="conum" data-value="5"></i><b>(5)</b>
}</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This field specifies the EAP method for the connection. &lt;.&gt; The <code>identity</code> field contains the identity string for EAP authentication inside the encrypted TLS tunnel. &lt;.&gt; The <code>password</code> field contains the passphrase for the EAP authentication. &lt;.&gt; The <code>ca_cert</code> field indicates the pathname of the CA certificate file. This file is needed to verify the server certificate. &lt;.&gt; This field specifies the authentication method used in the encrypted TLS tunnel. In this example, EAP with MD5-Challenge is used. The &#34;inner authentication&#34; phase is often called &#34;phase2&#34;.</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Next, add the following lines to <span class="filename">/etc/rc.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>wlans_ath0=&#34;wlan0&#34;
ifconfig_wlan0=&#34;WPA DHCP&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>The next step is to bring up the interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># service netif start</span>
Starting wpa_supplicant.
DHCPREQUEST on wlan0 to 255.255.255.255 port 67 interval 7
DHCPREQUEST on wlan0 to 255.255.255.255 port 67 interval 15
DHCPREQUEST on wlan0 to 255.255.255.255 port 67 interval 21
DHCPACK from 192.168.0.20
bound to 192.168.0.254 -- renewal <span class="k">in </span>300 seconds.
wlan0: <span class="nv">flags</span><span class="o">=</span>8843&lt;UP,BROADCAST,RUNNING,SIMPLEX,MULTICAST&gt; mtu 1500
      ether 00:11:95:d5:43:62
      inet 192.168.0.254 netmask 0xffffff00 broadcast 192.168.0.255
      media: IEEE 802.11 Wireless Ethernet DS/11Mbps mode 11g
      status: associated
      ssid freebsdap channel 1 <span class="o">(</span>2412 Mhz 11g<span class="o">)</span> bssid 00:11:95:c3:0d:ac
      country US ecm authmode WPA2/802.11i privacy ON deftxkey UNDEF
      AES-CCM 3:128-bit txpower 21.5 bmiss 7 scanvalid 450 bgscan
      bgscanintvl 300 bgscanidle 250 roam:rssi 7 roam:rate 5 protmode CTS
      wme burst roaming MANUAL</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="network-wireless-wpa-eap-peap">34.4.3. WPA with EAP-PEAP<a class="anchor" href="#network-wireless-wpa-eap-peap"></a></h4>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>PEAPv0/EAP-MSCHAPv2 is the most common PEAP method. In this chapter, the term PEAP is used to refer to that method.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Protected EAP (PEAP) is designed as an alternative to EAP-TTLS and is the most used EAP standard after EAP-TLS. In a network with mixed operating systems, PEAP should be the most supported standard after EAP-TLS.</p>
</div>
<div class="paragraph">
<p>PEAP is similar to EAP-TTLS as it uses a server-side certificate to authenticate clients by creating an encrypted TLS tunnel between the client and the authentication server, which protects the ensuing exchange of authentication information. PEAP authentication differs from EAP-TTLS as it broadcasts the username in the clear and only the password is sent in the encrypted TLS tunnel. EAP-TTLS will use the TLS tunnel for both the username and password.</p>
</div>
<div class="paragraph">
<p>Add the following lines to <span class="filename">/etc/wpa_supplicant.conf</span> to configure the EAP-PEAP related settings:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>network={
  ssid=&#34;freebsdap&#34;
  proto=RSN
  key_mgmt=WPA-EAP
  eap=PEAP <i class="conum" data-value="1"></i><b>(1)</b>
  identity=&#34;test&#34; <i class="conum" data-value="2"></i><b>(2)</b>
  password=&#34;test&#34; <i class="conum" data-value="3"></i><b>(3)</b>
  ca_cert=&#34;/etc/certs/cacert.pem&#34; <i class="conum" data-value="4"></i><b>(4)</b>
  phase1=&#34;peaplabel=0&#34; <i class="conum" data-value="5"></i><b>(5)</b>
  phase2=&#34;auth=MSCHAPV2&#34; <i class="conum" data-value="6"></i><b>(6)</b>
}</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This field specifies the EAP method for the connection. &lt;.&gt; The <code>identity</code> field contains the identity string for EAP authentication inside the encrypted TLS tunnel. &lt;.&gt; The <code>password</code> field contains the passphrase for the EAP authentication. &lt;.&gt; The <code>ca_cert</code> field indicates the pathname of the CA certificate file. This file is needed to verify the server certificate. &lt;.&gt; This field contains the parameters for the first phase of authentication, the TLS tunnel. According to the authentication server used, specify a specific label for authentication. Most of the time, the label will be &#34;client EAP encryption&#34; which is set by using <code>peaplabel=0</code>. More information can be found in <a href="https://man.freebsd.org/cgi/man.cgi?query=wpa_supplicant.conf&amp;sektion=5&amp;format=html">wpa_supplicant.conf(5)</a>. &lt;.&gt; This field specifies the authentication protocol used in the encrypted TLS tunnel. In the case of PEAP, it is <code>auth=MSCHAPV2</code>.</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Add the following to <span class="filename">/etc/rc.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>wlans_ath0=&#34;wlan0&#34;
ifconfig_wlan0=&#34;WPA DHCP&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>Then, bring up the interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># service netif start</span>
Starting wpa_supplicant.
DHCPREQUEST on wlan0 to 255.255.255.255 port 67 interval 7
DHCPREQUEST on wlan0 to 255.255.255.255 port 67 interval 15
DHCPREQUEST on wlan0 to 255.255.255.255 port 67 interval 21
DHCPACK from 192.168.0.20
bound to 192.168.0.254 -- renewal <span class="k">in </span>300 seconds.
wlan0: <span class="nv">flags</span><span class="o">=</span>8843&lt;UP,BROADCAST,RUNNING,SIMPLEX,MULTICAST&gt; mtu 1500
      ether 00:11:95:d5:43:62
      inet 192.168.0.254 netmask 0xffffff00 broadcast 192.168.0.255
      media: IEEE 802.11 Wireless Ethernet DS/11Mbps mode 11g
      status: associated
      ssid freebsdap channel 1 <span class="o">(</span>2412 Mhz 11g<span class="o">)</span> bssid 00:11:95:c3:0d:ac
      country US ecm authmode WPA2/802.11i privacy ON deftxkey UNDEF
      AES-CCM 3:128-bit txpower 21.5 bmiss 7 scanvalid 450 bgscan
      bgscanintvl 300 bgscanidle 250 roam:rssi 7 roam:rate 5 protmode CTS
      wme burst roaming MANUAL</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="wireless-ad-hoc-mode">34.5. Wireless Ad-hoc Mode<a class="anchor" href="#wireless-ad-hoc-mode"></a></h3>
<div class="paragraph">
<p>IBSS mode, also called ad-hoc mode, is designed for point to point connections. For example, to establish an ad-hoc network between the machines <code>A</code> and <code>B</code>, choose two IP addresses and a SSID.</p>
</div>
<div class="paragraph">
<p>On <code>A</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ifconfig wlan0 create wlandev ath0 wlanmode adhoc</span>
<span class="c"># ifconfig wlan0 inet 192.168.0.1 netmask 255.255.255.0 ssid freebsdap</span>
<span class="c"># ifconfig wlan0</span>
  wlan0: <span class="nv">flags</span><span class="o">=</span>8843&lt;UP,BROADCAST,RUNNING,SIMPLEX,MULTICAST&gt; metric 0 mtu 1500
	  ether 00:11:95:c3:0d:ac
	  inet 192.168.0.1 netmask 0xffffff00 broadcast 192.168.0.255
	  media: IEEE 802.11 Wireless Ethernet autoselect mode 11g &lt;adhoc&gt;
	  status: running
	  ssid freebsdap channel 2 <span class="o">(</span>2417 Mhz 11g<span class="o">)</span> bssid 02:11:95:c3:0d:ac
	  country US ecm authmode OPEN privacy OFF txpower 21.5 scanvalid 60
	  protmode CTS wme burst</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>adhoc</code> parameter indicates that the interface is running in IBSS mode.</p>
</div>
<div class="paragraph">
<p><code>B</code> should now be able to detect <code>A</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ifconfig wlan0 create wlandev ath0 wlanmode adhoc</span>
<span class="c"># ifconfig wlan0 up scan</span>
  SSID/MESH ID    BSSID              CHAN RATE   S:N     INT CAPS
  freebsdap       02:11:95:c3:0d:ac    2   54M -64:-96  100 IS   WME</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>I</code> in the output confirms that <code>A</code> is in ad-hoc mode. Now, configure <code>B</code> with a different IP address:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ifconfig wlan0 inet 192.168.0.2 netmask 255.255.255.0 ssid freebsdap</span>
<span class="c"># ifconfig wlan0</span>
  wlan0: <span class="nv">flags</span><span class="o">=</span>8843&lt;UP,BROADCAST,RUNNING,SIMPLEX,MULTICAST&gt; metric 0 mtu 1500
	  ether 00:11:95:d5:43:62
	  inet 192.168.0.2 netmask 0xffffff00 broadcast 192.168.0.255
	  media: IEEE 802.11 Wireless Ethernet autoselect mode 11g &lt;adhoc&gt;
	  status: running
	  ssid freebsdap channel 2 <span class="o">(</span>2417 Mhz 11g<span class="o">)</span> bssid 02:11:95:c3:0d:ac
	  country US ecm authmode OPEN privacy OFF txpower 21.5 scanvalid 60
	  protmode CTS wme burst</code></pre>
</div>
</div>
<div class="paragraph">
<p>Both <code>A</code> and <code>B</code> are now ready to exchange information.</p>
</div>
<div class="sect3">
<h4 id="network-wireless-ap">34.5.1. FreeBSD Host Access Points<a class="anchor" href="#network-wireless-ap"></a></h4>
<div class="paragraph">
<p>FreeBSD can act as an Access Point (AP) which eliminates the need to buy a hardware AP or run an ad-hoc network. This can be particularly useful when a FreeBSD machine is acting as a gateway to another network such as the Internet.</p>
</div>
<div class="sect4">
<h5 id="network-wireless-ap-basic">34.5.1.1. Basic Settings<a class="anchor" href="#network-wireless-ap-basic"></a></h5>
<div class="paragraph">
<p>Before configuring a FreeBSD machine as an AP, the kernel must be configured with the appropriate networking support for the wireless card as well as the security protocols being used. For more details, see <a href="#network-wireless-basic">[network-wireless-basic]</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The NDIS driver wrapper for Windows® drivers does not currently support AP operation. Only native FreeBSD wireless drivers support AP mode.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Once wireless networking support is loaded, check if the wireless device supports the host-based access point mode, also known as hostap mode:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ifconfig wlan0 create wlandev ath0</span>
<span class="c"># ifconfig wlan0 list caps</span>
<span class="nv">drivercaps</span><span class="o">=</span>6f85edc1&lt;STA,FF,TURBOP,IBSS,HOSTAP,AHDEMO,TXPMGT,SHSLOT,SHPREAMBLE,MONITOR,MBSS,WPA1,WPA2,BURST,WME,WDS,BGSCAN,TXFRAG&gt;
<span class="nv">cryptocaps</span><span class="o">=</span>1f&lt;WEP,TKIP,AES,AES_CCM,TKIPMIC&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This output displays the card’s capabilities. The <code>HOSTAP</code> word confirms that this wireless card can act as an AP. Various supported ciphers are also listed: WEP, TKIP, and AES. This information indicates which security protocols can be used on the AP.</p>
</div>
<div class="paragraph">
<p>The wireless device can only be put into hostap mode during the creation of the network pseudo-device, so a previously created device must be destroyed first:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ifconfig wlan0 destroy</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>then regenerated with the correct option before setting the other parameters:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ifconfig wlan0 create wlandev ath0 wlanmode hostap</span>
<span class="c"># ifconfig wlan0 inet 192.168.0.1 netmask 255.255.255.0 ssid freebsdap mode 11g channel 1</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Use <a href="https://man.freebsd.org/cgi/man.cgi?query=ifconfig&amp;sektion=8&amp;format=html">ifconfig(8)</a> again to see the status of the <span class="filename">wlan0</span> interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ifconfig wlan0</span>
  wlan0: <span class="nv">flags</span><span class="o">=</span>8843&lt;UP,BROADCAST,RUNNING,SIMPLEX,MULTICAST&gt; metric 0 mtu 1500
	  ether 00:11:95:c3:0d:ac
	  inet 192.168.0.1 netmask 0xffffff00 broadcast 192.168.0.255
	  media: IEEE 802.11 Wireless Ethernet autoselect mode 11g &lt;hostap&gt;
	  status: running
	  ssid freebsdap channel 1 <span class="o">(</span>2412 Mhz 11g<span class="o">)</span> bssid 00:11:95:c3:0d:ac
	  country US ecm authmode OPEN privacy OFF txpower 21.5 scanvalid 60
	  protmode CTS wme burst dtimperiod 1 -dfs</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>hostap</code> parameter indicates the interface is running in the host-based access point mode.</p>
</div>
<div class="paragraph">
<p>The interface configuration can be done automatically at boot time by adding the following lines to <span class="filename">/etc/rc.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>wlans_ath0=&#34;wlan0&#34;
create_args_wlan0=&#34;wlanmode hostap&#34;
ifconfig_wlan0=&#34;inet 192.168.0.1 netmask 255.255.255.0 ssid freebsdap mode 11g channel 1&#34;</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_host_based_access_point_without_authentication_or_encryption">34.5.1.2. Host-based Access Point Without Authentication or Encryption<a class="anchor" href="#_host_based_access_point_without_authentication_or_encryption"></a></h5>
<div class="paragraph">
<p>Although it is not recommended to run an AP without any authentication or encryption, this is a simple way to check if the AP is working. This configuration is also important for debugging client issues.</p>
</div>
<div class="paragraph">
<p>Once the AP is configured, initiate a scan from another wireless machine to find the AP:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ifconfig wlan0 create wlandev ath0</span>
<span class="c"># ifconfig wlan0 up scan</span>
SSID/MESH ID    BSSID              CHAN RATE   S:N     INT CAPS
freebsdap       00:11:95:c3:0d:ac    1   54M -66:-96  100 ES   WME</code></pre>
</div>
</div>
<div class="paragraph">
<p>The client machine found the AP and can be associated with it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ifconfig wlan0 inet 192.168.0.2 netmask 255.255.255.0 ssid freebsdap</span>
<span class="c"># ifconfig wlan0</span>
  wlan0: <span class="nv">flags</span><span class="o">=</span>8843&lt;UP,BROADCAST,RUNNING,SIMPLEX,MULTICAST&gt; metric 0 mtu 1500
	  ether 00:11:95:d5:43:62
	  inet 192.168.0.2 netmask 0xffffff00 broadcast 192.168.0.255
	  media: IEEE 802.11 Wireless Ethernet OFDM/54Mbps mode 11g
	  status: associated
	  ssid freebsdap channel 1 <span class="o">(</span>2412 Mhz 11g<span class="o">)</span> bssid 00:11:95:c3:0d:ac
	  country US ecm authmode OPEN privacy OFF txpower 21.5 bmiss 7
	  scanvalid 60 bgscan bgscanintvl 300 bgscanidle 250 roam:rssi 7
	  roam:rate 5 protmode CTS wme burst</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="network-wireless-ap-wpa">34.5.1.3. WPA2 Host-based Access Point<a class="anchor" href="#network-wireless-ap-wpa"></a></h5>
<div class="paragraph">
<p>This section focuses on setting up a FreeBSD access point using the WPA2 security protocol. More details regarding WPA and the configuration of WPA-based wireless clients can be found in <a href="#network-wireless-wpa">[network-wireless-wpa]</a>.</p>
</div>
<div class="paragraph">
<p>The <a href="https://man.freebsd.org/cgi/man.cgi?query=hostapd&amp;sektion=8&amp;format=html">hostapd(8)</a> daemon is used to deal with client authentication and key management on the WPA2-enabled AP.</p>
</div>
<div class="paragraph">
<p>The following configuration operations are performed on the FreeBSD machine acting as the AP. Once the AP is correctly working, <a href="https://man.freebsd.org/cgi/man.cgi?query=hostapd&amp;sektion=8&amp;format=html">hostapd(8)</a> can be automatically started at boot with this line in <span class="filename">/etc/rc.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>hostapd_enable=&#34;YES&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>Before trying to configure <a href="https://man.freebsd.org/cgi/man.cgi?query=hostapd&amp;sektion=8&amp;format=html">hostapd(8)</a>, first configure the basic settings introduced in <a href="#network-wireless-ap-basic">Basic Settings</a>.</p>
</div>
<div class="sect5">
<h6 id="_wpa2_psk">34.5.1.3.1. WPA2-PSK<a class="anchor" href="#_wpa2_psk"></a></h6>
<div class="paragraph">
<p>WPA2-PSK is intended for small networks where the use of a backend authentication server is not possible or desired.</p>
</div>
<div class="paragraph">
<p>The configuration is done in <span class="filename">/etc/hostapd.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>interface=wlan0                  <i class="conum" data-value="1"></i><b>(1)</b>
debug=1                          <i class="conum" data-value="2"></i><b>(2)</b>
ctrl_interface=/var/run/hostapd  <i class="conum" data-value="3"></i><b>(3)</b>
ctrl_interface_group=wheel       <i class="conum" data-value="4"></i><b>(4)</b>
ssid=freebsdap                   <i class="conum" data-value="5"></i><b>(5)</b>
wpa=2                            <i class="conum" data-value="6"></i><b>(6)</b>
wpa_passphrase=freebsdmall       <i class="conum" data-value="7"></i><b>(7)</b>
wpa_key_mgmt=WPA-PSK             <i class="conum" data-value="8"></i><b>(8)</b>
wpa_pairwise=CCMP                <i class="conum" data-value="9"></i><b>(9)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Wireless interface used for the access point. &lt;.&gt; Level of verbosity used during the execution of <a href="https://man.freebsd.org/cgi/man.cgi?query=hostapd&amp;sektion=8&amp;format=html">hostapd(8)</a>. A value of <code>1</code> represents the minimal level. &lt;.&gt; Pathname of the directory used by <a href="https://man.freebsd.org/cgi/man.cgi?query=hostapd&amp;sektion=8&amp;format=html">hostapd(8)</a> to store domain socket files for communication with external programs such as <a href="https://man.freebsd.org/cgi/man.cgi?query=hostapd_cli&amp;sektion=8&amp;format=html">hostapd_cli(8)</a>. The default value is used in this example. &lt;.&gt; The group allowed to access the control interface files. &lt;.&gt; The wireless network name, or SSID, that will appear in wireless scans. &lt;.&gt; Enable WPA and specify which WPA authentication protocol will be required. A value of <code>2</code> configures the AP for WPA2 and is recommended. Set to <code>1</code> only if the obsolete WPA is required. &lt;.&gt; ASCII passphrase for WPA authentication. &lt;.&gt; The key management protocol to use. This example sets WPA-PSK. &lt;.&gt; Encryption algorithms accepted by the access point. In this example, only the CCMP (AES) cipher is accepted. CCMP is an alternative to TKIP and is strongly preferred when possible. TKIP should be allowed only when there are stations incapable of using CCMP.</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>The next step is to start <a href="https://man.freebsd.org/cgi/man.cgi?query=hostapd&amp;sektion=8&amp;format=html">hostapd(8)</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># service hostapd forcestart</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ifconfig wlan0</span>
wlan0: <span class="nv">flags</span><span class="o">=</span>8943&lt;UP,BROADCAST,RUNNING,PROMISC,SIMPLEX,MULTICAST&gt; metric 0 mtu 1500
	ether 04:f0:21:16:8e:10
	inet6 fe80::6f0:21ff:fe16:8e10%wlan0 prefixlen 64 scopeid 0x9
	nd6 <span class="nv">options</span><span class="o">=</span>21&lt;PERFORMNUD,AUTO_LINKLOCAL&gt;
	media: IEEE 802.11 Wireless Ethernet autoselect mode 11na &lt;hostap&gt;
	status: running
	ssid No5ignal channel 36 <span class="o">(</span>5180 MHz 11a ht/40+<span class="o">)</span> bssid 04:f0:21:16:8e:10
	country US ecm authmode WPA2/802.11i privacy MIXED deftxkey 2
	AES-CCM 2:128-bit AES-CCM 3:128-bit txpower 17 mcastrate 6 mgmtrate 6
	scanvalid 60 ampdulimit 64k ampdudensity 8 shortgi wme burst
	dtimperiod 1 -dfs
	groups: wlan</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once the AP is running, the clients can associate with it. See <a href="#network-wireless-wpa">[network-wireless-wpa]</a> for more details. It is possible to see the stations associated with the AP using <code>ifconfig <em>wlan0</em> list sta</code>.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="network-usb-tethering">34.6. USB Tethering<a class="anchor" href="#network-usb-tethering"></a></h3>
<div class="paragraph">
<p>Many cellphones provide the option to share their data connection over USB (often called &#34;tethering&#34;). This feature uses one of RNDIS, CDC, or a custom Apple® iPhone®/iPad® protocol.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Android™ devices generally use the <a href="https://man.freebsd.org/cgi/man.cgi?query=urndis&amp;sektion=4&amp;format=html">urndis(4)</a> driver.</p>
</li>
<li>
<p>Apple® devices use the <a href="https://man.freebsd.org/cgi/man.cgi?query=ipheth&amp;sektion=4&amp;format=html">ipheth(4)</a> driver.</p>
</li>
<li>
<p>Older devices will often use the <a href="https://man.freebsd.org/cgi/man.cgi?query=cdce&amp;sektion=4&amp;format=html">cdce(4)</a> driver.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Before attaching a device, load the appropriate driver into the kernel:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># kldload if_urndis</span>
<span class="c"># kldload if_cdce</span>
<span class="c"># kldload if_ipheth</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Once the device is attached <code>ue</code><em>0</em> will be available for use like a normal network device. Be sure that the &#34;USB tethering&#34; option is enabled on the device.</p>
</div>
<div class="paragraph">
<p>To make this change permanent and load the driver as a module at boot time, place the appropriate line of the following in <span class="filename">/boot/loader.conf</span>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nv">if_urndis_load</span><span class="o">=</span><span class="s2">&#34;YES&#34;</span>
<span class="nv">if_cdce_load</span><span class="o">=</span><span class="s2">&#34;YES&#34;</span>
<span class="nv">if_ipheth_load</span><span class="o">=</span><span class="s2">&#34;YES&#34;</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="network-bluetooth">34.7. Bluetooth<a class="anchor" href="#network-bluetooth"></a></h3>
<div class="paragraph">
<p>Bluetooth is a wireless technology for creating personal networks operating in the 2.4 GHz unlicensed band, with a range of 10 meters. Networks are usually formed ad-hoc from portable devices such as cellular phones, handhelds, and laptops. Unlike Wi-Fi wireless technology, Bluetooth offers higher level service profiles, such as FTP-like file servers, file pushing, voice transport, serial line emulation, and more.</p>
</div>
<div class="paragraph">
<p>This section describes the use of a USB Bluetooth dongle on a FreeBSD system. It then describes the various Bluetooth protocols and utilities.</p>
</div>
<div class="sect3">
<h4 id="_loading_bluetooth_support">34.7.1. Loading Bluetooth Support<a class="anchor" href="#_loading_bluetooth_support"></a></h4>
<div class="paragraph">
<p>The Bluetooth stack in FreeBSD is implemented using the <a href="https://man.freebsd.org/cgi/man.cgi?query=netgraph&amp;sektion=4&amp;format=html">netgraph(4)</a> framework. A broad variety of Bluetooth USB dongles is supported by <a href="https://man.freebsd.org/cgi/man.cgi?query=ng_ubt&amp;sektion=4&amp;format=html">ng_ubt(4)</a>. Broadcom BCM2033 based Bluetooth devices are supported by the <a href="https://man.freebsd.org/cgi/man.cgi?query=ubtbcmfw&amp;sektion=4&amp;format=html">ubtbcmfw(4)</a> and <a href="https://man.freebsd.org/cgi/man.cgi?query=ng_ubt&amp;sektion=4&amp;format=html">ng_ubt(4)</a> drivers. The 3Com Bluetooth PC Card 3CRWB60-A is supported by the <a href="https://man.freebsd.org/cgi/man.cgi?query=ng_bt3c&amp;sektion=4&amp;format=html">ng_bt3c(4)</a> driver. Serial and UART based Bluetooth devices are supported by <a href="https://man.freebsd.org/cgi/man.cgi?query=sio&amp;sektion=4&amp;format=html">sio(4)</a>, <a href="https://man.freebsd.org/cgi/man.cgi?query=ng_h4&amp;sektion=4&amp;format=html">ng_h4(4)</a>, and <a href="https://man.freebsd.org/cgi/man.cgi?query=hcseriald&amp;sektion=8&amp;format=html">hcseriald(8)</a>.</p>
</div>
<div class="paragraph">
<p>Before attaching a device, determine which of the above drivers it uses, then load the driver. For example, if the device uses the <a href="https://man.freebsd.org/cgi/man.cgi?query=ng_ubt&amp;sektion=4&amp;format=html">ng_ubt(4)</a> driver:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># kldload ng_ubt</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If the Bluetooth device will be attached to the system during system startup, the system can be configured to load the module at boot time by adding the driver to <span class="filename">/boot/loader.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>ng_ubt_load=&#34;YES&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>Once the driver is loaded, plug in the USB dongle. If the driver load was successful, output similar to the following should appear on the console and in <span class="filename">/var/log/messages</span>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">ubt0: vendor 0x0a12 product 0x0001, rev 1.10/5.25, addr 2
ubt0: Interface 0 endpoints: <span class="nv">interrupt</span><span class="o">=</span>0x81, bulk-in<span class="o">=</span>0x82, bulk-out<span class="o">=</span>0x2
ubt0: Interface 1 <span class="o">(</span>alt.config 5<span class="o">)</span> endpoints: isoc-in<span class="o">=</span>0x83, isoc-out<span class="o">=</span>0x3,
      <span class="nv">wMaxPacketSize</span><span class="o">=</span>49, <span class="nv">nframes</span><span class="o">=</span>6, buffer <span class="nv">size</span><span class="o">=</span>294</code></pre>
</div>
</div>
<div class="paragraph">
<p>To start and stop the Bluetooth stack, use its startup script. It is a good idea to stop the stack before unplugging the device. Starting the bluetooth stack might require <a href="https://man.freebsd.org/cgi/man.cgi?query=hcsecd&amp;sektion=8&amp;format=html">hcsecd(8)</a> to be started. When starting the stack, the output should be similar to the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># service bluetooth start ubt0</span>
BD_ADDR: 00:02:72:00:d4:1a
Features: 0xff 0xff 0xf 00 00 00 00 00
<span class="gp">&lt;3-Slot&gt; </span>&lt;5-Slot&gt; &lt;Encryption&gt; &lt;Slot offset&gt;
&lt;Timing accuracy&gt; &lt;Switch&gt; &lt;Hold mode&gt; &lt;Sniff mode&gt;
&lt;Park mode&gt; &lt;RSSI&gt; &lt;Channel quality&gt; &lt;SCO link&gt;
&lt;HV2 packets&gt; &lt;HV3 packets&gt; &lt;u-law log&gt; &lt;A-law log&gt; &lt;CVSD&gt;
&lt;Paging scheme&gt; &lt;Power control&gt; &lt;Transparent SCO data&gt;
Max. ACL packet size: 192 bytes
Number of ACL packets: 8
Max. SCO packet size: 64 bytes
Number of SCO packets: 8</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_finding_other_bluetooth_devices">34.7.2. Finding Other Bluetooth Devices<a class="anchor" href="#_finding_other_bluetooth_devices"></a></h4>
<div class="paragraph">
<p>The Host Controller Interface (HCI) provides a uniform method for accessing Bluetooth baseband capabilities. In FreeBSD, a netgraph HCI node is created for each Bluetooth device. For more details, refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=ng_hci&amp;sektion=4&amp;format=html">ng_hci(4)</a>.</p>
</div>
<div class="paragraph">
<p>One of the most common tasks is discovery of Bluetooth devices within RF proximity. This operation is called <em>inquiry</em>. Inquiry and other HCI related operations are done using <a href="https://man.freebsd.org/cgi/man.cgi?query=hccontrol&amp;sektion=8&amp;format=html">hccontrol(8)</a>. The example below shows how to find out which Bluetooth devices are in range. The list of devices should be displayed in a few seconds. Note that a remote device will only answer the inquiry if it is set to <em>discoverable</em> mode.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>hccontrol -n ubt0hci inquiry
Inquiry result, <span class="nv">num_responses</span><span class="o">=</span>1
Inquiry result <span class="c">#0</span>
       BD_ADDR: 00:80:37:29:19:a4
       Page Scan Rep. Mode: 0x1
       Page Scan Period Mode: 00
       Page Scan Mode: 00
       Class: 52:02:04
       Clock offset: 0x78ef
Inquiry complete. Status: No error <span class="o">[</span>00]</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>BD_ADDR</code> is the unique address of a Bluetooth device, similar to the MAC address of a network card. This address is needed for further communication with a device and it is possible to assign a human readable name to a <code>BD_ADDR</code>. Information regarding the known Bluetooth hosts is contained in <span class="filename">/etc/bluetooth/hosts</span>. The following example shows how to obtain the human readable name that was assigned to the remote device:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>hccontrol -n ubt0hci remote_name_request 00:80:37:29:19:a4
BD_ADDR: 00:80:37:29:19:a4
Name: Pav<span class="s1">&#39;s T39</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If an inquiry is performed on a remote Bluetooth device, it will find the computer as &#34;your.host.name (ubt0)&#34;. The name assigned to the local device can be changed at any time.</p>
</div>
<div class="paragraph">
<p>Remote devices can be assigned aliases in <span class="filename">/etc/bluetooth/hosts</span>. More information about <span class="filename">/etc/bluetooth/hosts</span> file might be found in <a href="https://man.freebsd.org/cgi/man.cgi?query=bluetooth.hosts&amp;sektion=5&amp;format=html">bluetooth.hosts(5)</a>.</p>
</div>
<div class="paragraph">
<p>The Bluetooth system provides a point-to-point connection between two Bluetooth units, or a point-to-multipoint connection which is shared among several Bluetooth devices. The following example shows how to create a connection to a remote device:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>hccontrol -n ubt0hci create_connection BT_ADDR</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>create_connection</code> accepts <code>BT_ADDR</code> as well as host aliases in <span class="filename">/etc/bluetooth/hosts</span>.</p>
</div>
<div class="paragraph">
<p>The following example shows how to obtain the list of active baseband connections for the local device:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>hccontrol -n ubt0hci read_connection_list
Remote BD_ADDR    Handle Type Mode Role Encrypt Pending Queue State
00:80:37:29:19:a4     41  ACL    0 MAST    NONE       0     0 OPEN</code></pre>
</div>
</div>
<div class="paragraph">
<p>A <em>connection handle</em> is useful when termination of the baseband connection is required, though it is normally not required to do this by hand. The stack will automatically terminate inactive baseband connections.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># hccontrol -n ubt0hci disconnect 41</span>
Connection handle: 41
Reason: Connection terminated by <span class="nb">local </span>host <span class="o">[</span>0x16]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Type <code>hccontrol help</code> for a complete listing of available HCI commands. Most of the HCI commands do not require superuser privileges.</p>
</div>
</div>
<div class="sect3">
<h4 id="_device_pairing">34.7.3. Device Pairing<a class="anchor" href="#_device_pairing"></a></h4>
<div class="paragraph">
<p>By default, Bluetooth communication is not authenticated, and any device can talk to any other device. A Bluetooth device, such as a cellular phone, may choose to require authentication to provide a particular service. Bluetooth authentication is normally done with a <em>PIN code</em>, an ASCII string up to 16 characters in length. The user is required to enter the same PIN code on both devices. Once the user has entered the PIN code, both devices will generate a <em>link key</em>. After that, the link key can be stored either in the devices or in a persistent storage. Next time, both devices will use the previously generated link key. This procedure is called <em>pairing</em>. Note that if the link key is lost by either device, the pairing must be repeated.</p>
</div>
<div class="paragraph">
<p>The <a href="https://man.freebsd.org/cgi/man.cgi?query=hcsecd&amp;sektion=8&amp;format=html">hcsecd(8)</a> daemon is responsible for handling Bluetooth authentication requests. The default configuration file is <span class="filename">/etc/bluetooth/hcsecd.conf</span>. An example section for a cellular phone with the PIN code set to <code>1234</code> is shown below:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>device {
        bdaddr  00:80:37:29:19:a4;
        name    &#34;Pav&#39;s T39&#34;;
        key     nokey;
        pin     &#34;1234&#34;;
      }</pre>
</div>
</div>
<div class="paragraph">
<p>The only limitation on PIN codes is length. Some devices, such as Bluetooth headsets, may have a fixed PIN code built in. The <code>-d</code> switch forces <a href="https://man.freebsd.org/cgi/man.cgi?query=hcsecd&amp;sektion=8&amp;format=html">hcsecd(8)</a> to stay in the foreground, so it is easy to see what is happening. Set the remote device to receive pairing and initiate the Bluetooth connection to the remote device. The remote device should indicate that pairing was accepted and request the PIN code. Enter the same PIN code listed in <span class="filename">hcsecd.conf</span>. Now the computer and the remote device are paired. Alternatively, pairing can be initiated on the remote device.</p>
</div>
<div class="paragraph">
<p>The following line can be added to <span class="filename">/etc/rc.conf</span> to configure <a href="https://man.freebsd.org/cgi/man.cgi?query=hcsecd&amp;sektion=8&amp;format=html">hcsecd(8)</a> to start automatically on system start:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>hcsecd_enable=&#34;YES&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>The following is a sample of the <a href="https://man.freebsd.org/cgi/man.cgi?query=hcsecd&amp;sektion=8&amp;format=html">hcsecd(8)</a> daemon output:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>hcsecd[16484]: Got Link_Key_Request event from &#39;ubt0hci&#39;, remote bdaddr 0:80:37:29:19:a4
hcsecd[16484]: Found matching entry, remote bdaddr 0:80:37:29:19:a4, name &#39;Pav&#39;s T39&#39;, link key doesn&#39;t exist
hcsecd[16484]: Sending Link_Key_Negative_Reply to &#39;ubt0hci&#39; for remote bdaddr 0:80:37:29:19:a4
hcsecd[16484]: Got PIN_Code_Request event from &#39;ubt0hci&#39;, remote bdaddr 0:80:37:29:19:a4
hcsecd[16484]: Found matching entry, remote bdaddr 0:80:37:29:19:a4, name &#39;Pav&#39;s T39&#39;, PIN code exists
hcsecd[16484]: Sending PIN_Code_Reply to &#39;ubt0hci&#39; for remote bdaddr 0:80:37:29:19:a4</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_network_access_with_ppp_profiles">34.7.4. Network Access with PPP Profiles<a class="anchor" href="#_network_access_with_ppp_profiles"></a></h4>
<div class="paragraph">
<p>A Dial-Up Networking (DUN) profile can be used to configure a cellular phone as a wireless modem for connecting to a dial-up Internet access server. It can also be used to configure a computer to receive data calls from a cellular phone.</p>
</div>
<div class="paragraph">
<p>Network access with a PPP profile can be used to provide LAN access for a single Bluetooth device or multiple Bluetooth devices. It can also provide PC to PC connection using PPP networking over serial cable emulation.</p>
</div>
<div class="paragraph">
<p>In FreeBSD, these profiles are implemented with <a href="https://man.freebsd.org/cgi/man.cgi?query=ppp&amp;sektion=8&amp;format=html">ppp(8)</a> and the <a href="https://man.freebsd.org/cgi/man.cgi?query=rfcomm_pppd&amp;sektion=8&amp;format=html">rfcomm_pppd(8)</a> wrapper which converts a Bluetooth connection into something PPP can use. Before a profile can be used, a new PPP label must be created in <span class="filename">/etc/ppp/ppp.conf</span>. Consult <a href="https://man.freebsd.org/cgi/man.cgi?query=rfcomm_pppd&amp;sektion=8&amp;format=html">rfcomm_pppd(8)</a> for examples.</p>
</div>
<div class="paragraph">
<p>In this example, <a href="https://man.freebsd.org/cgi/man.cgi?query=rfcomm_pppd&amp;sektion=8&amp;format=html">rfcomm_pppd(8)</a> is used to open a connection to a remote device with a <code>BD_ADDR</code> of <code>00:80:37:29:19:a4</code> on a DUNRFCOMM channel:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># rfcomm_pppd -a 00:80:37:29:19:a4 -c -C dun -l rfcomm-dialup</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The actual channel number will be obtained from the remote device using the SDP protocol. It is possible to specify the RFCOMM channel by hand, and in this case <a href="https://man.freebsd.org/cgi/man.cgi?query=rfcomm_pppd&amp;sektion=8&amp;format=html">rfcomm_pppd(8)</a> will not perform the SDP query. Use <a href="https://man.freebsd.org/cgi/man.cgi?query=sdpcontrol&amp;sektion=8&amp;format=html">sdpcontrol(8)</a> to find out the RFCOMM channel on the remote device.</p>
</div>
<div class="paragraph">
<p>In order to provide network access with the PPPLAN service, <a href="https://man.freebsd.org/cgi/man.cgi?query=sdpd&amp;sektion=8&amp;format=html">sdpd(8)</a> must be running and a new entry for LAN clients must be created in <span class="filename">/etc/ppp/ppp.conf</span>. Consult <a href="https://man.freebsd.org/cgi/man.cgi?query=rfcomm_pppd&amp;sektion=8&amp;format=html">rfcomm_pppd(8)</a> for examples. Finally, start the RFCOMMPPP server on a valid RFCOMM channel number. The RFCOMMPPP server will automatically register the Bluetooth LAN service with the local SDP daemon. The example below shows how to start the RFCOMMPPP server.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># rfcomm_pppd -s -C 7 -l rfcomm-server</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_bluetooth_protocols">34.7.5. Bluetooth Protocols<a class="anchor" href="#_bluetooth_protocols"></a></h4>
<div class="paragraph">
<p>This section provides an overview of the various Bluetooth protocols, their function, and associated utilities.</p>
</div>
<div class="sect4">
<h5 id="_logical_link_control_and_adaptation_protocol_l2cap">34.7.5.1. Logical Link Control and Adaptation Protocol (L2CAP)<a class="anchor" href="#_logical_link_control_and_adaptation_protocol_l2cap"></a></h5>
<div class="paragraph">
<p>The Logical Link Control and Adaptation Protocol (L2CAP) provides connection-oriented and connectionless data services to upper layer protocols. L2CAP permits higher level protocols and applications to transmit and receive L2CAP data packets up to 64 kilobytes in length.</p>
</div>
<div class="paragraph">
<p>L2CAP is based around the concept of <em>channels</em>. A channel is a logical connection on top of a baseband connection, where each channel is bound to a single protocol in a many-to-one fashion. Multiple channels can be bound to the same protocol, but a channel cannot be bound to multiple protocols. Each L2CAP packet received on a channel is directed to the appropriate higher level protocol. Multiple channels can share the same baseband connection.</p>
</div>
<div class="paragraph">
<p>In FreeBSD, a netgraph L2CAP node is created for each Bluetooth device. This node is normally connected to the downstream Bluetooth HCI node and upstream Bluetooth socket nodes. The default name for the L2CAP node is &#34;devicel2cap&#34;. For more details refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=ng_l2cap&amp;sektion=4&amp;format=html">ng_l2cap(4)</a>.</p>
</div>
<div class="paragraph">
<p>A useful command is <a href="https://man.freebsd.org/cgi/man.cgi?query=l2ping&amp;sektion=8&amp;format=html">l2ping(8)</a>, which can be used to ping other devices. Some Bluetooth implementations might not return all of the data sent to them, so <code>0 bytes</code> in the following example is normal.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># l2ping -a 00:80:37:29:19:a4</span>
0 bytes from 0:80:37:29:19:a4 <span class="nv">seq_no</span><span class="o">=</span>0 <span class="nb">time</span><span class="o">=</span>48.633 ms <span class="nv">result</span><span class="o">=</span>0
0 bytes from 0:80:37:29:19:a4 <span class="nv">seq_no</span><span class="o">=</span>1 <span class="nb">time</span><span class="o">=</span>37.551 ms <span class="nv">result</span><span class="o">=</span>0
0 bytes from 0:80:37:29:19:a4 <span class="nv">seq_no</span><span class="o">=</span>2 <span class="nb">time</span><span class="o">=</span>28.324 ms <span class="nv">result</span><span class="o">=</span>0
0 bytes from 0:80:37:29:19:a4 <span class="nv">seq_no</span><span class="o">=</span>3 <span class="nb">time</span><span class="o">=</span>46.150 ms <span class="nv">result</span><span class="o">=</span>0</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <a href="https://man.freebsd.org/cgi/man.cgi?query=l2control&amp;sektion=8&amp;format=html">l2control(8)</a> utility is used to perform various operations on L2CAP nodes. This example shows how to obtain the list of logical connections (channels) and the list of baseband connections for the local device:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>l2control -a 00:02:72:00:d4:1a read_channel_list
L2CAP channels:
Remote BD_ADDR     SCID/ DCID   PSM  IMTU/ OMTU State
00:07:e0:00:0b:ca    66/   64     3   132/  672 OPEN
<span class="gp">% </span>l2control -a 00:02:72:00:d4:1a read_connection_list
L2CAP connections:
Remote BD_ADDR    Handle Flags Pending State
00:07:e0:00:0b:ca     41 O           0 OPEN</code></pre>
</div>
</div>
<div class="paragraph">
<p>Another diagnostic tool is <a href="https://man.freebsd.org/cgi/man.cgi?query=btsockstat&amp;sektion=1&amp;format=html">btsockstat(1)</a>. It is similar to <a href="https://man.freebsd.org/cgi/man.cgi?query=netstat&amp;sektion=1&amp;format=html">netstat(1)</a>, but for Bluetooth network-related data structures. The example below shows the same logical connection as <a href="https://man.freebsd.org/cgi/man.cgi?query=l2control&amp;sektion=8&amp;format=html">l2control(8)</a> above.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>btsockstat
Active L2CAP sockets
PCB      Recv-Q Send-Q Local address/PSM       Foreign address   CID   State
c2afe900      0      0 00:02:72:00:d4:1a/3     00:07:e0:00:0b:ca 66    OPEN
Active RFCOMM sessions
L2PCB    PCB      Flag MTU   Out-Q DLCs State
c2afe900 c2b53380 1    127   0     Yes  OPEN
Active RFCOMM sockets
PCB      Recv-Q Send-Q Local address     Foreign address   Chan DLCI State
c2e8bc80      0    250 00:02:72:00:d4:1a 00:07:e0:00:0b:ca 3    6    OPEN</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_radio_frequency_communication_rfcomm">34.7.5.2. Radio Frequency Communication (RFCOMM)<a class="anchor" href="#_radio_frequency_communication_rfcomm"></a></h5>
<div class="paragraph">
<p>The RFCOMM protocol provides emulation of serial ports over the L2CAP protocol. RFCOMM is a simple transport protocol, with additional provisions for emulating the 9 circuits of RS-232 (EIATIA-232-E) serial ports. It supports up to 60 simultaneous connections (RFCOMM channels) between two Bluetooth devices.</p>
</div>
<div class="paragraph">
<p>For the purposes of RFCOMM, a complete communication path involves two applications running on the communication endpoints with a communication segment between them. RFCOMM is intended to cover applications that make use of the serial ports of the devices in which they reside. The communication segment is a direct connect Bluetooth link from one device to another.</p>
</div>
<div class="paragraph">
<p>RFCOMM is only concerned with the connection between the devices in the direct connect case, or between the device and a modem in the network case. RFCOMM can support other configurations, such as modules that communicate via Bluetooth wireless technology on one side and provide a wired interface on the other side.</p>
</div>
<div class="paragraph">
<p>In FreeBSD, RFCOMM is implemented at the Bluetooth sockets layer.</p>
</div>
</div>
<div class="sect4">
<h5 id="_service_discovery_protocol_sdp">34.7.5.3. Service Discovery Protocol (SDP)<a class="anchor" href="#_service_discovery_protocol_sdp"></a></h5>
<div class="paragraph">
<p>The Service Discovery Protocol (SDP) provides the means for client applications to discover the existence of services provided by server applications as well as the attributes of those services. The attributes of a service include the type or class of service offered and the mechanism or protocol information needed to utilize the service.</p>
</div>
<div class="paragraph">
<p>SDP involves communication between a SDP server and a SDP client. The server maintains a list of service records that describe the characteristics of services associated with the server. Each service record contains information about a single service. A client may retrieve information from a service record maintained by the SDP server by issuing a SDP request. If the client, or an application associated with the client, decides to use a service, it must open a separate connection to the service provider in order to utilize the service. SDP provides a mechanism for discovering services and their attributes, but it does not provide a mechanism for utilizing those services.</p>
</div>
<div class="paragraph">
<p>Normally, a SDP client searches for services based on some desired characteristics of the services. However, there are times when it is desirable to discover which types of services are described by an SDP server’s service records without any prior information about the services. This process of looking for any offered services is called <em>browsing</em>.</p>
</div>
<div class="paragraph">
<p>The Bluetooth SDP server, <a href="https://man.freebsd.org/cgi/man.cgi?query=sdpd&amp;sektion=8&amp;format=html">sdpd(8)</a>, and command line client, <a href="https://man.freebsd.org/cgi/man.cgi?query=sdpcontrol&amp;sektion=8&amp;format=html">sdpcontrol(8)</a>, are included in the standard FreeBSD installation. The following example shows how to perform a SDP browse query.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>sdpcontrol -a 00:01:03:fc:6e:ec browse
Record Handle: 00000000
Service Class ID List:
        Service Discovery Server <span class="o">(</span>0x1000<span class="o">)</span>
Protocol Descriptor List:
        L2CAP <span class="o">(</span>0x0100<span class="o">)</span>
                Protocol specific parameter <span class="c">#1: u/int/uuid16 1</span>
                Protocol specific parameter <span class="c">#2: u/int/uuid16 1</span>

Record Handle: 0x00000001
Service Class ID List:
        Browse Group Descriptor <span class="o">(</span>0x1001<span class="o">)</span>

Record Handle: 0x00000002
Service Class ID List:
        LAN Access Using PPP <span class="o">(</span>0x1102<span class="o">)</span>
Protocol Descriptor List:
        L2CAP <span class="o">(</span>0x0100<span class="o">)</span>
        RFCOMM <span class="o">(</span>0x0003<span class="o">)</span>
                Protocol specific parameter <span class="c">#1: u/int8/bool 1</span>
Bluetooth Profile Descriptor List:
        LAN Access Using PPP <span class="o">(</span>0x1102<span class="o">)</span> ver. 1.0</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that each service has a list of attributes, such as the RFCOMM channel. Depending on the service, the user might need to make note of some of the attributes. Some Bluetooth implementations do not support service browsing and may return an empty list. In this case, it is possible to search for the specific service. The example below shows how to search for the OBEX Object Push (OPUSH) service:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>sdpcontrol -a 00:01:03:fc:6e:ec search OPUSH</code></pre>
</div>
</div>
<div class="paragraph">
<p>Offering services on FreeBSD to Bluetooth clients is done with the <a href="https://man.freebsd.org/cgi/man.cgi?query=sdpd&amp;sektion=8&amp;format=html">sdpd(8)</a> server. The following line can be added to <span class="filename">/etc/rc.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>sdpd_enable=&#34;YES&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>Then the <a href="https://man.freebsd.org/cgi/man.cgi?query=sdpd&amp;sektion=8&amp;format=html">sdpd(8)</a> daemon can be started with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># service sdpd start</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The local server application that wants to provide a Bluetooth service to remote clients will register the service with the local SDP daemon. An example of such an application is <a href="https://man.freebsd.org/cgi/man.cgi?query=rfcomm_pppd&amp;sektion=8&amp;format=html">rfcomm_pppd(8)</a>. Once started, it will register the Bluetooth LAN service with the local SDP daemon.</p>
</div>
<div class="paragraph">
<p>The list of services registered with the local SDP server can be obtained by issuing a SDP browse query via the local control channel:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># sdpcontrol -l browse</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_obex_object_push_opush">34.7.5.4. OBEX Object Push (OPUSH)<a class="anchor" href="#_obex_object_push_opush"></a></h5>
<div class="paragraph">
<p>Object Exchange (OBEX) is a widely used protocol for simple file transfers between mobile devices. Its main use is in infrared communication, where it is used for generic file transfers between notebooks or PDAs, and for sending business cards or calendar entries between cellular phones and other devices with Personal Information Manager (PIM) applications.</p>
</div>
<div class="paragraph">
<p>The OBEX server and client are implemented by obexapp, which can be installed using the <a class="package" href="https://cgit.freebsd.org/ports/tree/comms/obexapp/">comms/obexapp</a> package or port.</p>
</div>
<div class="paragraph">
<p>The OBEX client is used to push and/or pull objects from the OBEX server. An example object is a business card or an appointment. The OBEX client can obtain the RFCOMM channel number from the remote device via SDP. This can be done by specifying the service name instead of the RFCOMM channel number. Supported service names are: <code>IrMC</code>, <code>FTRN</code>, and <code>OPUSH</code>. It is also possible to specify the RFCOMM channel as a number. Below is an example of an OBEX session where the device information object is pulled from the cellular phone, and a new object, the business card, is pushed into the phone’s directory.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>obexapp -a 00:80:37:29:19:a4 -C IrMC
<span class="gp">obex&gt; </span>get telecom/devinfo.txt devinfo-t39.txt
Success, response: OK, Success <span class="o">(</span>0x20<span class="o">)</span>
<span class="gp">obex&gt; </span>put new.vcf
Success, response: OK, Success <span class="o">(</span>0x20<span class="o">)</span>
<span class="gp">obex&gt; </span>di
Success, response: OK, Success <span class="o">(</span>0x20<span class="o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In order to provide the OPUSH service, <a href="https://man.freebsd.org/cgi/man.cgi?query=sdpd&amp;sektion=8&amp;format=html">sdpd(8)</a> must be running and a root folder, where all incoming objects will be stored, must be created. The default path to the root folder is <span class="filename">/var/spool/obex</span>. Finally, start the OBEX server on a valid RFCOMM channel number. The OBEX server will automatically register the OPUSH service with the local SDP daemon. The example below shows how to start the OBEX server.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># obexapp -s -C 10</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_serial_port_profile_spp">34.7.5.5. Serial Port Profile (SPP)<a class="anchor" href="#_serial_port_profile_spp"></a></h5>
<div class="paragraph">
<p>The Serial Port Profile (SPP) allows Bluetooth devices to perform serial cable emulation. This profile allows legacy applications to use Bluetooth as a cable replacement, through a virtual serial port abstraction.</p>
</div>
<div class="paragraph">
<p>In FreeBSD, <a href="https://man.freebsd.org/cgi/man.cgi?query=rfcomm_sppd&amp;sektion=1&amp;format=html">rfcomm_sppd(1)</a> implements SPP and a pseudo tty is used as a virtual serial port abstraction. The example below shows how to connect to a remote device’s serial port service. A RFCOMM channel does not have to be specified as <a href="https://man.freebsd.org/cgi/man.cgi?query=rfcomm_sppd&amp;sektion=1&amp;format=html">rfcomm_sppd(1)</a> can obtain it from the remote device via SDP. To override this, specify a RFCOMM channel on the command line.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># rfcomm_sppd -a 00:07:E0:00:0B:CA -t</span>
rfcomm_sppd[94692]: Starting on /dev/pts/6...
/dev/pts/6</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once connected, the pseudo tty can be used as serial port:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># cu -l /dev/pts/6</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The pseudo tty is printed on stdout and can be read by wrapper scripts:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>PTS=`rfcomm_sppd -a 00:07:E0:00:0B:CA -t`
cu -l $PTS</pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_troubleshooting_3">34.7.6. Troubleshooting<a class="anchor" href="#_troubleshooting_3"></a></h4>
<div class="paragraph">
<p>By default, when FreeBSD is accepting a new connection, it tries to perform a role switch and become master. Some older Bluetooth devices which do not support role switching will not be able to connect. Since role switching is performed when a new connection is being established, it is not possible to ask the remote device if it supports role switching. However, there is a HCI option to disable role switching on the local side:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># hccontrol -n ubt0hci write_node_role_switch 0</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To display Bluetooth packets, use the third-party package hcidump, which can be installed using the <a class="package" href="https://cgit.freebsd.org/ports/tree/comms/hcidump/">comms/hcidump</a> package or port. This utility is similar to <a href="https://man.freebsd.org/cgi/man.cgi?query=tcpdump&amp;sektion=1&amp;format=html">tcpdump(1)</a> and can be used to display the contents of Bluetooth packets on the terminal and to dump the Bluetooth packets to a file.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="network-bridging">34.8. Bridging<a class="anchor" href="#network-bridging"></a></h3>
<div class="paragraph">
<p>It is sometimes useful to divide a network, such as an Ethernet segment, into network segments without having to create IP subnets and use a router to connect the segments together. A device that connects two networks together in this fashion is called a &#34;bridge&#34;.</p>
</div>
<div class="paragraph">
<p>A bridge works by learning the MAC addresses of the devices on each of its network interfaces. It forwards traffic between networks only when the source and destination MAC addresses are on different networks. In many respects, a bridge is like an Ethernet switch with very few ports. A FreeBSD system with multiple network interfaces can be configured to act as a bridge.</p>
</div>
<div class="paragraph">
<p>Bridging can be useful in the following situations:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Connecting Networks</dt>
<dd>
<p>The basic operation of a bridge is to join two or more network segments. There are many reasons to use a host-based bridge instead of networking equipment, such as cabling constraints or firewalling. A bridge can also connect a wireless interface running in hostap mode to a wired network and act as an access point.</p>
</dd>
<dt class="hdlist1">Filtering/Traffic Shaping Firewall</dt>
<dd>
<p>A bridge can be used when firewall functionality is needed without routing or Network Address Translation (NAT).</p>
<div class="paragraph">
<p>An example is a small company that is connected via DSL or ISDN to an ISP. There are thirteen public IP addresses from the ISP and ten computers on the network. In this situation, using a router-based firewall is difficult because of subnetting issues. A bridge-based firewall can be configured without any IP addressing issues.</p>
</div>
</dd>
<dt class="hdlist1">Network Tap</dt>
<dd>
<p>A bridge can join two network segments in order to inspect all Ethernet frames that pass between them using <a href="https://man.freebsd.org/cgi/man.cgi?query=bpf&amp;sektion=4&amp;format=html">bpf(4)</a> and <a href="https://man.freebsd.org/cgi/man.cgi?query=tcpdump&amp;sektion=1&amp;format=html">tcpdump(1)</a> on the bridge interface, or by sending a copy of all frames out on an additional interface known as a span port.</p>
</dd>
<dt class="hdlist1">Layer 2 VPN</dt>
<dd>
<p>Two Ethernet networks can be joined across an IP link by bridging the networks to an EtherIP tunnel or a <a href="https://man.freebsd.org/cgi/man.cgi?query=tap&amp;sektion=4&amp;format=html">tap(4)</a> based solution such as OpenVPN.</p>
</dd>
<dt class="hdlist1">Layer 2 Redundancy</dt>
<dd>
<p>A network can be connected together with multiple links and use the Spanning Tree Protocol (STP) to block redundant paths.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>This section describes how to configure a FreeBSD system as a bridge using <a href="https://man.freebsd.org/cgi/man.cgi?query=if_bridge&amp;sektion=4&amp;format=html">if_bridge(4)</a>. A netgraph bridging driver is also available, and is described in <a href="https://man.freebsd.org/cgi/man.cgi?query=ng_bridge&amp;sektion=4&amp;format=html">ng_bridge(4)</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Packet filtering can be used with any firewall package that hooks into the <a href="https://man.freebsd.org/cgi/man.cgi?query=pfil&amp;sektion=9&amp;format=html">pfil(9)</a> framework. The bridge can be used as a traffic shaper with <a href="https://man.freebsd.org/cgi/man.cgi?query=altq&amp;sektion=4&amp;format=html">altq(4)</a> or <a href="https://man.freebsd.org/cgi/man.cgi?query=dummynet&amp;sektion=4&amp;format=html">dummynet(4)</a>.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="sect3">
<h4 id="_enabling_the_bridge">34.8.1. Enabling the Bridge<a class="anchor" href="#_enabling_the_bridge"></a></h4>
<div class="paragraph">
<p>In FreeBSD, <a href="https://man.freebsd.org/cgi/man.cgi?query=if_bridge&amp;sektion=4&amp;format=html">if_bridge(4)</a> is a kernel module which is automatically loaded by <a href="https://man.freebsd.org/cgi/man.cgi?query=ifconfig&amp;sektion=8&amp;format=html">ifconfig(8)</a> when creating a bridge interface. It is also possible to compile bridge support into a custom kernel by adding <code>device if_bridge</code> to the custom kernel configuration file.</p>
</div>
<div class="paragraph">
<p>The bridge is created using interface cloning. To create the bridge interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ifconfig bridge create</span>
bridge0
<span class="c"># ifconfig bridge0</span>
bridge0: <span class="nv">flags</span><span class="o">=</span>8802&lt;BROADCAST,SIMPLEX,MULTICAST&gt; metric 0 mtu 1500
        ether 96:3d:4b:f1:79:7a
        id 00:00:00:00:00:00 priority 32768 hellotime 2 fwddelay 15
        maxage 20 holdcnt 6 proto rstp maxaddr 100 timeout 1200
        root id 00:00:00:00:00:00 priority 0 ifcost 0 port 0</code></pre>
</div>
</div>
<div class="paragraph">
<p>When a bridge interface is created, it is automatically assigned a randomly generated Ethernet address. The <code>maxaddr</code> and <code>timeout</code> parameters control how many MAC addresses the bridge will keep in its forwarding table and how many seconds before each entry is removed after it is last seen. The other parameters control how STP operates.</p>
</div>
<div class="paragraph">
<p>Next, specify which network interfaces to add as members of the bridge. For the bridge to forward packets, all member interfaces and the bridge need to be up:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ifconfig bridge0 addm fxp0 addm fxp1 up</span>
<span class="c"># ifconfig fxp0 up</span>
<span class="c"># ifconfig fxp1 up</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The bridge can now forward Ethernet frames between <span class="filename">fxp0</span> and <span class="filename">fxp1</span>. Add the following lines to <span class="filename">/etc/rc.conf</span> so the bridge is created at startup:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>cloned_interfaces=&#34;bridge0&#34;
ifconfig_bridge0=&#34;addm fxp0 addm fxp1 up&#34;
ifconfig_fxp0=&#34;up&#34;
ifconfig_fxp1=&#34;up&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>If the bridge host needs an IP address, set it on the bridge interface, not on the member interfaces. The address can be set statically or via DHCP. This example sets a static IP address:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ifconfig bridge0 inet 192.168.0.1/24</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>It is also possible to assign an IPv6 address to a bridge interface. To make the changes permanent, add the addressing information to <span class="filename">/etc/rc.conf</span>.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When packet filtering is enabled, bridged packets will pass through the filter inbound on the originating interface on the bridge interface, and outbound on the appropriate interfaces. Either stage can be disabled. When direction of the packet flow is important, it is best to firewall on the member interfaces rather than the bridge itself.</p>
</div>
<div class="paragraph">
<p>The bridge has several configurable settings for passing non-IP and IP packets, and layer2 firewalling with <a href="https://man.freebsd.org/cgi/man.cgi?query=ipfw&amp;sektion=8&amp;format=html">ipfw(8)</a>. See <a href="https://man.freebsd.org/cgi/man.cgi?query=if_bridge&amp;sektion=4&amp;format=html">if_bridge(4)</a> for more information.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect3">
<h4 id="_enabling_spanning_tree">34.8.2. Enabling Spanning Tree<a class="anchor" href="#_enabling_spanning_tree"></a></h4>
<div class="paragraph">
<p>For an Ethernet network to function properly, only one active path can exist between two devices. The STP protocol detects loops and puts redundant links into a blocked state. Should one of the active links fail, STP calculates a different tree and enables one of the blocked paths to restore connectivity to all points in the network.</p>
</div>
<div class="paragraph">
<p>The Rapid Spanning Tree Protocol (RSTP or 802.1w) provides backwards compatibility with legacy STP. RSTP provides faster convergence and exchanges information with neighboring switches to quickly transition to forwarding mode without creating loops. FreeBSD supports RSTP and STP as operating modes, with RSTP being the default mode.</p>
</div>
<div class="paragraph">
<p>STP can be enabled on member interfaces using <a href="https://man.freebsd.org/cgi/man.cgi?query=ifconfig&amp;sektion=8&amp;format=html">ifconfig(8)</a>. For a bridge with <span class="filename">fxp0</span> and <span class="filename">fxp1</span> as the current interfaces, enable STP with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ifconfig bridge0 stp fxp0 stp fxp1</span>
bridge0: <span class="nv">flags</span><span class="o">=</span>8843&lt;UP,BROADCAST,RUNNING,SIMPLEX,MULTICAST&gt; metric 0 mtu 1500
        ether d6:cf:d5:a0:94:6d
        id 00:01:02:4b:d4:50 priority 32768 hellotime 2 fwddelay 15
        maxage 20 holdcnt 6 proto rstp maxaddr 100 timeout 1200
        root id 00:01:02:4b:d4:50 priority 32768 ifcost 0 port 0
        member: fxp0 <span class="nv">flags</span><span class="o">=</span>1c7&lt;LEARNING,DISCOVER,STP,AUTOEDGE,PTP,AUTOPTP&gt;
                port 3 priority 128 path cost 200000 proto rstp
                role designated state forwarding
        member: fxp1 <span class="nv">flags</span><span class="o">=</span>1c7&lt;LEARNING,DISCOVER,STP,AUTOEDGE,PTP,AUTOPTP&gt;
                port 4 priority 128 path cost 200000 proto rstp
                role designated state forwarding</code></pre>
</div>
</div>
<div class="paragraph">
<p>This bridge has a spanning tree ID of <code>00:01:02:4b:d4:50</code> and a priority of <code>32768</code>. As the <code>root id</code> is the same, it indicates that this is the root bridge for the tree.</p>
</div>
<div class="paragraph">
<p>Another bridge on the network also has STP enabled:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">bridge0: <span class="nv">flags</span><span class="o">=</span>8843&lt;UP,BROADCAST,RUNNING,SIMPLEX,MULTICAST&gt; metric 0 mtu 1500
        ether 96:3d:4b:f1:79:7a
        id 00:13:d4:9a:06:7a priority 32768 hellotime 2 fwddelay 15
        maxage 20 holdcnt 6 proto rstp maxaddr 100 timeout 1200
        root id 00:01:02:4b:d4:50 priority 32768 ifcost 400000 port 4
        member: fxp0 <span class="nv">flags</span><span class="o">=</span>1c7&lt;LEARNING,DISCOVER,STP,AUTOEDGE,PTP,AUTOPTP&gt;
                port 4 priority 128 path cost 200000 proto rstp
                role root state forwarding
        member: fxp1 <span class="nv">flags</span><span class="o">=</span>1c7&lt;LEARNING,DISCOVER,STP,AUTOEDGE,PTP,AUTOPTP&gt;
                port 5 priority 128 path cost 200000 proto rstp
                role designated state forwarding</code></pre>
</div>
</div>
<div class="paragraph">
<p>The line <code>root id 00:01:02:4b:d4:50 priority 32768 ifcost 400000 port 4</code> shows that the root bridge is <code>00:01:02:4b:d4:50</code> and has a path cost of <code>400000</code> from this bridge. The path to the root bridge is via <code>port 4</code> which is <span class="filename">fxp0</span>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_bridge_interface_parameters">34.8.3. Bridge Interface Parameters<a class="anchor" href="#_bridge_interface_parameters"></a></h4>
<div class="paragraph">
<p>Several <code>ifconfig</code> parameters are unique to bridge interfaces. This section summarizes some common uses for these parameters. The complete list of available parameters is described in <a href="https://man.freebsd.org/cgi/man.cgi?query=ifconfig&amp;sektion=8&amp;format=html">ifconfig(8)</a>.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">private</dt>
<dd>
<p>A private interface does not forward any traffic to any other port that is also designated as a private interface. The traffic is blocked unconditionally so no Ethernet frames will be forwarded, including ARP packets. If traffic needs to be selectively blocked, a firewall should be used instead.</p>
</dd>
<dt class="hdlist1">span</dt>
<dd>
<p>A span port transmits a copy of every Ethernet frame received by the bridge. The number of span ports configured on a bridge is unlimited, but if an interface is designated as a span port, it cannot also be used as a regular bridge port. This is most useful for snooping a bridged network passively on another host connected to one of the span ports of the bridge. For example, to send a copy of all frames out the interface named <span class="filename">fxp4</span>:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ifconfig bridge0 span fxp4</span></code></pre>
</div>
</div>
</dd>
<dt class="hdlist1">sticky</dt>
<dd>
<p>If a bridge member interface is marked as sticky, dynamically learned address entries are treated as static entries in the forwarding cache. Sticky entries are never aged out of the cache or replaced, even if the address is seen on a different interface. This gives the benefit of static address entries without the need to pre-populate the forwarding table. Clients learned on a particular segment of the bridge cannot roam to another segment.</p>
<div class="paragraph">
<p>An example of using sticky addresses is to combine the bridge with VLANs in order to isolate customer networks without wasting IP address space. Consider that <code>CustomerA</code> is on <code>vlan100</code>, <code>CustomerB</code> is on <code>vlan101</code>, and the bridge has the address <code>192.168.0.1</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ifconfig bridge0 addm vlan100 sticky vlan100 addm vlan101 sticky vlan101</span>
<span class="c"># ifconfig bridge0 inet 192.168.0.1/24</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example, both clients see <code>192.168.0.1</code> as their default gateway. Since the bridge cache is sticky, one host cannot spoof the MAC address of the other customer in order to intercept their traffic.</p>
</div>
<div class="paragraph">
<p>Any communication between the VLANs can be blocked using a firewall or, as seen in this example, private interfaces:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ifconfig bridge0 private vlan100 private vlan101</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The customers are completely isolated from each other and the full <code>/24</code> address range can be allocated without subnetting.</p>
</div>
<div class="paragraph">
<p>The number of unique source MAC addresses behind an interface can be limited. Once the limit is reached, packets with unknown source addresses are dropped until an existing host cache entry expires or is removed.</p>
</div>
<div class="paragraph">
<p>The following example sets the maximum number of Ethernet devices for <code>CustomerA</code> on <code>vlan100</code> to 10:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ifconfig bridge0 ifmaxaddr vlan100 10</span></code></pre>
</div>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Bridge interfaces also support monitor mode, where the packets are discarded after <a href="https://man.freebsd.org/cgi/man.cgi?query=bpf&amp;sektion=4&amp;format=html">bpf(4)</a> processing and are not processed or forwarded further. This can be used to multiplex the input of two or more interfaces into a single <a href="https://man.freebsd.org/cgi/man.cgi?query=bpf&amp;sektion=4&amp;format=html">bpf(4)</a> stream. This is useful for reconstructing the traffic for network taps that transmit the RX/TX signals out through two separate interfaces. For example, to read the input from four network interfaces as one stream:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ifconfig bridge0 addm fxp0 addm fxp1 addm fxp2 addm fxp3 monitor up</span>
<span class="c"># tcpdump -i bridge0</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_snmp_monitoring">34.8.4. SNMP Monitoring<a class="anchor" href="#_snmp_monitoring"></a></h4>
<div class="paragraph">
<p>The bridge interface and STP parameters can be monitored via <a href="https://man.freebsd.org/cgi/man.cgi?query=bsnmpd&amp;sektion=1&amp;format=html">bsnmpd(1)</a> which is included in the FreeBSD base system. The exported bridge MIBs conform to IETF standards so any SNMP client or monitoring package can be used to retrieve the data.</p>
</div>
<div class="paragraph">
<p>To enable monitoring on the bridge, uncomment this line in <span class="filename">/etc/snmpd.config</span> by removing the beginning <code>#</code> symbol:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>begemotSnmpdModulePath.&#34;bridge&#34; = &#34;/usr/lib/snmp_bridge.so&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>Other configuration settings, such as community names and access lists, may need to be modified in this file. See <a href="https://man.freebsd.org/cgi/man.cgi?query=bsnmpd&amp;sektion=1&amp;format=html">bsnmpd(1)</a> and <a href="https://man.freebsd.org/cgi/man.cgi?query=snmp_bridge&amp;sektion=3&amp;format=html">snmp_bridge(3)</a> for more information. Once these edits are saved, add this line to <span class="filename">/etc/rc.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>bsnmpd_enable=&#34;YES&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>Then, start <a href="https://man.freebsd.org/cgi/man.cgi?query=bsnmpd&amp;sektion=1&amp;format=html">bsnmpd(1)</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># service bsnmpd start</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The following examples use the Net-SNMP software (<a class="package" href="https://cgit.freebsd.org/ports/tree/net-mgmt/net-snmp/">net-mgmt/net-snmp</a>) to query a bridge from a client system. The <a class="package" href="https://cgit.freebsd.org/ports/tree/net-mgmt/bsnmptools/">net-mgmt/bsnmptools</a> port can also be used. From the SNMP client which is running Net-SNMP, add the following lines to <span class="filename">$HOME/.snmp/snmp.conf</span> in order to import the bridge MIB definitions:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>mibdirs +/usr/share/snmp/mibs
mibs +BRIDGE-MIB:RSTP-MIB:BEGEMOT-MIB:BEGEMOT-BRIDGE-MIB</pre>
</div>
</div>
<div class="paragraph">
<p>To monitor a single bridge using the IETF BRIDGE-MIB (RFC4188):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>snmpwalk -v 2c -c public bridge1.example.com mib-2.dot1dBridge
BRIDGE-MIB::dot1dBaseBridgeAddress.0 <span class="o">=</span> STRING: 66:fb:9b:6e:5c:44
BRIDGE-MIB::dot1dBaseNumPorts.0 <span class="o">=</span> INTEGER: 1 ports
BRIDGE-MIB::dot1dStpTimeSinceTopologyChange.0 <span class="o">=</span> Timeticks: <span class="o">(</span>189959<span class="o">)</span> 0:31:39.59 centi-seconds
BRIDGE-MIB::dot1dStpTopChanges.0 <span class="o">=</span> Counter32: 2
BRIDGE-MIB::dot1dStpDesignatedRoot.0 <span class="o">=</span> Hex-STRING: 80 00 00 01 02 4B D4 50
...
BRIDGE-MIB::dot1dStpPortState.3 <span class="o">=</span> INTEGER: forwarding<span class="o">(</span>5<span class="o">)</span>
BRIDGE-MIB::dot1dStpPortEnable.3 <span class="o">=</span> INTEGER: enabled<span class="o">(</span>1<span class="o">)</span>
BRIDGE-MIB::dot1dStpPortPathCost.3 <span class="o">=</span> INTEGER: 200000
BRIDGE-MIB::dot1dStpPortDesignatedRoot.3 <span class="o">=</span> Hex-STRING: 80 00 00 01 02 4B D4 50
BRIDGE-MIB::dot1dStpPortDesignatedCost.3 <span class="o">=</span> INTEGER: 0
BRIDGE-MIB::dot1dStpPortDesignatedBridge.3 <span class="o">=</span> Hex-STRING: 80 00 00 01 02 4B D4 50
BRIDGE-MIB::dot1dStpPortDesignatedPort.3 <span class="o">=</span> Hex-STRING: 03 80
BRIDGE-MIB::dot1dStpPortForwardTransitions.3 <span class="o">=</span> Counter32: 1
RSTP-MIB::dot1dStpVersion.0 <span class="o">=</span> INTEGER: rstp<span class="o">(</span>2<span class="o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>dot1dStpTopChanges.0</code> value is two, indicating that the STP bridge topology has changed twice. A topology change means that one or more links in the network have changed or failed and a new tree has been calculated. The <code>dot1dStpTimeSinceTopologyChange.0</code> value will show when this happened.</p>
</div>
<div class="paragraph">
<p>To monitor multiple bridge interfaces, the private BEGEMOT-BRIDGE-MIB can be used:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>snmpwalk -v 2c -c public bridge1.example.com
enterprises.fokus.begemot.begemotBridge
BEGEMOT-BRIDGE-MIB::begemotBridgeBaseName.<span class="s2">&#34;bridge0&#34;</span> <span class="o">=</span> STRING: bridge0
BEGEMOT-BRIDGE-MIB::begemotBridgeBaseName.<span class="s2">&#34;bridge2&#34;</span> <span class="o">=</span> STRING: bridge2
BEGEMOT-BRIDGE-MIB::begemotBridgeBaseAddress.<span class="s2">&#34;bridge0&#34;</span> <span class="o">=</span> STRING: e:ce:3b:5a:9e:13
BEGEMOT-BRIDGE-MIB::begemotBridgeBaseAddress.<span class="s2">&#34;bridge2&#34;</span> <span class="o">=</span> STRING: 12:5e:4d:74:d:fc
BEGEMOT-BRIDGE-MIB::begemotBridgeBaseNumPorts.<span class="s2">&#34;bridge0&#34;</span> <span class="o">=</span> INTEGER: 1
BEGEMOT-BRIDGE-MIB::begemotBridgeBaseNumPorts.<span class="s2">&#34;bridge2&#34;</span> <span class="o">=</span> INTEGER: 1
...
BEGEMOT-BRIDGE-MIB::begemotBridgeStpTimeSinceTopologyChange.<span class="s2">&#34;bridge0&#34;</span> <span class="o">=</span> Timeticks: <span class="o">(</span>116927<span class="o">)</span> 0:19:29.27 centi-seconds
BEGEMOT-BRIDGE-MIB::begemotBridgeStpTimeSinceTopologyChange.<span class="s2">&#34;bridge2&#34;</span> <span class="o">=</span> Timeticks: <span class="o">(</span>82773<span class="o">)</span> 0:13:47.73 centi-seconds
BEGEMOT-BRIDGE-MIB::begemotBridgeStpTopChanges.<span class="s2">&#34;bridge0&#34;</span> <span class="o">=</span> Counter32: 1
BEGEMOT-BRIDGE-MIB::begemotBridgeStpTopChanges.<span class="s2">&#34;bridge2&#34;</span> <span class="o">=</span> Counter32: 1
BEGEMOT-BRIDGE-MIB::begemotBridgeStpDesignatedRoot.<span class="s2">&#34;bridge0&#34;</span> <span class="o">=</span> Hex-STRING: 80 00 00 40 95 30 5E 31
BEGEMOT-BRIDGE-MIB::begemotBridgeStpDesignatedRoot.<span class="s2">&#34;bridge2&#34;</span> <span class="o">=</span> Hex-STRING: 80 00 00 50 8B B8 C6 A9</code></pre>
</div>
</div>
<div class="paragraph">
<p>To change the bridge interface being monitored via the <code>mib-2.dot1dBridge</code> subtree:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">% </span>snmpset -v 2c -c private bridge1.example.com
BEGEMOT-BRIDGE-MIB::begemotBridgeDefaultBridgeIf.0 s bridge2</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="network-aggregation">34.9. Link Aggregation and Failover<a class="anchor" href="#network-aggregation"></a></h3>
<div class="paragraph">
<p>FreeBSD provides the <a href="https://man.freebsd.org/cgi/man.cgi?query=lagg&amp;sektion=4&amp;format=html">lagg(4)</a> interface which can be used to aggregate multiple network interfaces into one virtual interface in order to provide failover and link aggregation. Failover allows traffic to continue to flow as long as at least one aggregated network interface has an established link. Link aggregation works best on switches which support LACP, as this protocol distributes traffic bi-directionally while responding to the failure of individual links.</p>
</div>
<div class="paragraph">
<p>The aggregation protocols supported by the lagg interface determine which ports are used for outgoing traffic and whether or not a specific port accepts incoming traffic. The following protocols are supported by <a href="https://man.freebsd.org/cgi/man.cgi?query=lagg&amp;sektion=4&amp;format=html">lagg(4)</a>:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">failover</dt>
<dd>
<p>This mode sends and receives traffic only through the master port. If the master port becomes unavailable, the next active port is used. The first interface added to the virtual interface is the master port and all subsequently added interfaces are used as failover devices. If failover to a non-master port occurs, the original port becomes master once it becomes available again.</p>
</dd>
<dt class="hdlist1">loadbalance</dt>
<dd>
<p>This provides a static setup and does not negotiate aggregation with the peer or exchange frames to monitor the link. If the switch supports LACP, that should be used instead.</p>
</dd>
<dt class="hdlist1">lacp</dt>
<dd>
<p>The IEEE® 802.3ad Link Aggregation Control Protocol (LACP) negotiates a set of aggregable links with the peer into one or more Link Aggregated Groups (LAGs). Each LAG is composed of ports of the same speed, set to full-duplex operation, and traffic is balanced across the ports in the LAG with the greatest total speed. Typically, there is only one LAG which contains all the ports. In the event of changes in physical connectivity, LACP will quickly converge to a new configuration.</p>
<div class="paragraph">
<p>LACP balances outgoing traffic across the active ports based on hashed protocol header information and accepts incoming traffic from any active port. The hash includes the Ethernet source and destination address and, if available, the VLAN tag, and the IPv4 or IPv6 source and destination address.</p>
</div>
</dd>
<dt class="hdlist1">roundrobin</dt>
<dd>
<p>This mode distributes outgoing traffic using a round-robin scheduler through all active ports and accepts incoming traffic from any active port. Since this mode violates Ethernet frame ordering, it should be used with caution.</p>
</dd>
<dt class="hdlist1">broadcast</dt>
<dd>
<p>This mode sends outgoing traffic to all ports configured on the lagg interface, and receives frames on any port.</p>
</dd>
</dl>
</div>
<div class="sect3">
<h4 id="_configuration_examples">34.9.1. Configuration Examples<a class="anchor" href="#_configuration_examples"></a></h4>
<div class="paragraph">
<p>This section demonstrates how to configure a Cisco® switch and a FreeBSD system for LACP load balancing. It then shows how to configure two Ethernet interfaces in failover mode as well as how to configure failover mode between an Ethernet and a wireless interface.</p>
</div>
<div id="networking-lacp-aggregation-cisco" class="exampleblock">
<div class="title">例 38. LACP Aggregation with a Cisco® Switch</div>
<div class="content">
<div class="paragraph">
<p>This example connects two <a href="https://man.freebsd.org/cgi/man.cgi?query=fxp&amp;sektion=4&amp;format=html">fxp(4)</a> Ethernet interfaces on a FreeBSD machine to the first two Ethernet ports on a Cisco® switch as a single load balanced and fault tolerant link. More interfaces can be added to increase throughput and fault tolerance. Replace the names of the Cisco® ports, Ethernet devices, channel group number, and IP address shown in the example to match the local configuration.</p>
</div>
<div class="paragraph">
<p>Frame ordering is mandatory on Ethernet links and any traffic between two stations always flows over the same physical link, limiting the maximum speed to that of one interface. The transmit algorithm attempts to use as much information as it can to distinguish different traffic flows and balance the flows across the available interfaces.</p>
</div>
<div class="paragraph">
<p>On the Cisco® switch, add the <em>FastEthernet0/1</em> and <em>FastEthernet0/2</em> interfaces to channel group <em>1</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell">interface FastEthernet0/1
 channel-group 1 mode active
 channel-protocol lacp
!
interface FastEthernet0/2
 channel-group 1 mode active
 channel-protocol lacp</code></pre>
</div>
</div>
<div class="paragraph">
<p>On the FreeBSD system, create the <a href="https://man.freebsd.org/cgi/man.cgi?query=lagg&amp;sektion=4&amp;format=html">lagg(4)</a> interface using the physical interfaces <em>fxp0</em> and <em>fxp1</em> and bring the interfaces up with an IP address of <em>10.0.0.3/24</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ifconfig fxp0 up</span>
<span class="c"># ifconfig fxp1 up</span>
<span class="c"># ifconfig lagg0 create</span>
<span class="c"># ifconfig lagg0 up laggproto lacp laggport fxp0 laggport fxp1 10.0.0.3/24</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Next, verify the status of the virtual interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ifconfig lagg0</span>
lagg0: <span class="nv">flags</span><span class="o">=</span>8843&lt;UP,BROADCAST,RUNNING,SIMPLEX,MULTICAST&gt; metric 0 mtu 1500
        <span class="nv">options</span><span class="o">=</span>8&lt;VLAN_MTU&gt;
        ether 00:05:5d:71:8d:b8
        inet 10.0.0.3 netmask 0xffffff00 broadcast 10.0.0.255
        media: Ethernet autoselect
        status: active
        laggproto lacp
        laggport: fxp1 <span class="nv">flags</span><span class="o">=</span>1c&lt;ACTIVE,COLLECTING,DISTRIBUTING&gt;
        laggport: fxp0 <span class="nv">flags</span><span class="o">=</span>1c&lt;ACTIVE,COLLECTING,DISTRIBUTING&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Ports marked as <code>ACTIVE</code> are part of the LAG that has been negotiated with the remote switch. Traffic will be transmitted and received through these active ports. Add <code>-v</code> to the above command to view the LAG identifiers.</p>
</div>
<div class="paragraph">
<p>To see the port status on the Cisco® switch:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="gp">switch# </span>show lacp neighbor
Flags:  S - Device is requesting Slow LACPDUs
        F - Device is requesting Fast LACPDUs
        A - Device is <span class="k">in </span>Active mode       P - Device is <span class="k">in </span>Passive mode

Channel group 1 neighbors

Partner<span class="s1">&#39;s information:

                  LACP port                        Oper    Port     Port
Port      Flags   Priority  Dev ID         Age     Key     Number   State
Fa0/1     SA      32768     0005.5d71.8db8  29s    0x146   0x3      0x3D
Fa0/2     SA      32768     0005.5d71.8db8  29s    0x146   0x4      0x3D</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For more detail, type <code>show lacp neighbor detail</code>.</p>
</div>
<div class="paragraph">
<p>To retain this configuration across reboots, add the following entries to <span class="filename">/etc/rc.conf</span> on the FreeBSD system:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>ifconfig_fxp0=&#34;up&#34;
ifconfig_fxp1=&#34;up&#34;
cloned_interfaces=&#34;lagg0&#34;
ifconfig_lagg0=&#34;laggproto lacp laggport fxp0 laggport fxp1 10.0.0.3/24&#34;</pre>
</div>
</div>
</div>
</div>
<div id="networking-lagg-failover" class="exampleblock">
<div class="title">例 39. Failover Mode</div>
<div class="content">
<div class="paragraph">
<p>Failover mode can be used to switch over to a secondary interface if the link is lost on the master interface. To configure failover, make sure that the underlying physical interfaces are up, then create the <a href="https://man.freebsd.org/cgi/man.cgi?query=lagg&amp;sektion=4&amp;format=html">lagg(4)</a> interface. In this example, <em>fxp0</em> is the master interface, <em>fxp1</em> is the secondary interface, and the virtual interface is assigned an IP address of <em>10.0.0.15/24</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ifconfig fxp0 up</span>
<span class="c"># ifconfig fxp1 up</span>
<span class="c"># ifconfig lagg0 create</span>
<span class="c"># ifconfig lagg0 up laggproto failover laggport fxp0 laggport fxp1 10.0.0.15/24</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The virtual interface should look something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ifconfig lagg0</span>
lagg0: <span class="nv">flags</span><span class="o">=</span>8843&lt;UP,BROADCAST,RUNNING,SIMPLEX,MULTICAST&gt; metric 0 mtu 1500
        <span class="nv">options</span><span class="o">=</span>8&lt;VLAN_MTU&gt;
        ether 00:05:5d:71:8d:b8
        inet 10.0.0.15 netmask 0xffffff00 broadcast 10.0.0.255
        media: Ethernet autoselect
        status: active
        laggproto failover
        laggport: fxp1 <span class="nv">flags</span><span class="o">=</span>0&lt;&gt;
        laggport: fxp0 <span class="nv">flags</span><span class="o">=</span>5&lt;MASTER,ACTIVE&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Traffic will be transmitted and received on <em>fxp0</em>. If the link is lost on <em>fxp0</em>, <em>fxp1</em> will become the active link. If the link is restored on the master interface, it will once again become the active link.</p>
</div>
<div class="paragraph">
<p>To retain this configuration across reboots, add the following entries to <span class="filename">/etc/rc.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>ifconfig_fxp0=&#34;up&#34;
ifconfig_fxp1=&#34;up&#34;
cloned_interfaces=&#34;lagg0&#34;
ifconfig_lagg0=&#34;laggproto failover laggport fxp0 laggport fxp1 10.0.0.15/24&#34;</pre>
</div>
</div>
</div>
</div>
<div id="networking-lagg-wired-and-wireless" class="exampleblock">
<div class="title">例 40. Failover Mode Between Ethernet and Wireless Interfaces</div>
<div class="content">
<div class="paragraph">
<p>For laptop users, it is usually desirable to configure the wireless device as a secondary which is only used when the Ethernet connection is not available. With <a href="https://man.freebsd.org/cgi/man.cgi?query=lagg&amp;sektion=4&amp;format=html">lagg(4)</a>, it is possible to configure a failover which prefers the Ethernet connection for both performance and security reasons, while maintaining the ability to transfer data over the wireless connection.</p>
</div>
<div class="paragraph">
<p>This is achieved by overriding the Ethernet interface’s MAC address with that of the wireless interface.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>In theory, either the Ethernet or wireless MAC address can be changed to match the other. However, some popular wireless interfaces lack support for overriding the MAC address. We therefore recommend overriding the Ethernet MAC address for this purpose.</p>
</div>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>If the driver for the wireless interface is not loaded in the <code>GENERIC</code> or custom kernel, and the computer is running FreeBSD 12.1, load the corresponding <span class="filename">.ko</span> in <span class="filename">/boot/loader.conf</span> by adding <code><strong>driver_load=&#34;YES&#34;</strong></code> to that file and rebooting. Another, better way is to load the driver in <span class="filename">/etc/rc.conf</span> by adding it to <code>kld_list</code> (see <a href="https://man.freebsd.org/cgi/man.cgi?query=rc.conf&amp;sektion=5&amp;format=html">rc.conf(5)</a> for details) in that file and rebooting. This is needed because otherwise the driver is not loaded yet at the time the <a href="https://man.freebsd.org/cgi/man.cgi?query=lagg&amp;sektion=4&amp;format=html">lagg(4)</a> interface is set up.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>In this example, the Ethernet interface, <em>re0</em>, is the master and the wireless interface, <em>wlan0</em>, is the failover. The <em>wlan0</em> interface was created from the <em>ath0</em> physical wireless interface, and the Ethernet interface will be configured with the MAC address of the wireless interface. First, bring the wireless interface up (replacing <em>FR</em> with your own 2-letter country code), but do not set an IP address. Replace <em>wlan0</em> to match the system’s wireless interface name:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ifconfig wlan0 create wlandev ath0 country FR ssid my_router up</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now you can determine the MAC address of the wireless interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ifconfig wlan0</span>
wlan0: <span class="nv">flags</span><span class="o">=</span>8843&lt;UP,BROADCAST,RUNNING,SIMPLEX,MULTICAST&gt; metric 0 mtu 1500
	ether b8:ee:65:5b:32:59
	groups: wlan
	ssid Bbox-A3BD2403 channel 6 <span class="o">(</span>2437 MHz 11g ht/20<span class="o">)</span> bssid 00:37:b7:56:4b:60
	regdomain ETSI country FR indoor ecm authmode WPA2/802.11i privacy ON
	deftxkey UNDEF AES-CCM 2:128-bit txpower 30 bmiss 7 scanvalid 60
	protmode CTS ampdulimit 64k ampdudensity 8 shortgi -stbctx stbcrx
	-ldpc wme burst roaming MANUAL
	media: IEEE 802.11 Wireless Ethernet MCS mode 11ng
	status: associated
	nd6 <span class="nv">options</span><span class="o">=</span>29&lt;PERFORMNUD,IFDISABLED,AUTO_LINKLOCAL&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>ether</code> line will contain the MAC address of the specified interface. Now, change the MAC address of the Ethernet interface to match:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ifconfig re0 ether b8:ee:65:5b:32:59</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Make sure the <em>re0</em> interface is up, then create the <a href="https://man.freebsd.org/cgi/man.cgi?query=lagg&amp;sektion=4&amp;format=html">lagg(4)</a> interface with <em>re0</em> as master with failover to <em>wlan0</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ifconfig re0 up</span>
<span class="c"># ifconfig lagg0 create</span>
<span class="c"># ifconfig lagg0 up laggproto failover laggport re0 laggport wlan0</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The virtual interface should look something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ifconfig lagg0</span>
lagg0: <span class="nv">flags</span><span class="o">=</span>8843&lt;UP,BROADCAST,RUNNING,SIMPLEX,MULTICAST&gt; metric 0 mtu 1500
        <span class="nv">options</span><span class="o">=</span>8&lt;VLAN_MTU&gt;
        ether b8:ee:65:5b:32:59
        laggproto failover lagghash l2,l3,l4
        laggport: re0 <span class="nv">flags</span><span class="o">=</span>5&lt;MASTER,ACTIVE&gt;
        laggport: wlan0 <span class="nv">flags</span><span class="o">=</span>0&lt;&gt;
        groups: lagg
        media: Ethernet autoselect
        status: active</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, start the DHCP client to obtain an IP address:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># dhclient lagg0</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To retain this configuration across reboots, add the following entries to <span class="filename">/etc/rc.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>ifconfig_re0=&#34;ether b8:ee:65:5b:32:59&#34;
wlans_ath0=&#34;wlan0&#34;
ifconfig_wlan0=&#34;WPA&#34;
create_args_wlan0=&#34;country FR&#34;
cloned_interfaces=&#34;lagg0&#34;
ifconfig_lagg0=&#34;up laggproto failover laggport re0 laggport wlan0 DHCP&#34;</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="network-diskless">34.10. Diskless Operation with PXE<a class="anchor" href="#network-diskless"></a></h3>
<div class="paragraph">
<p>The Intel® Preboot eXecution Environment (PXE) allows an operating system to boot over the network. For example, a FreeBSD system can boot over the network and operate without a local disk, using file systems mounted from an NFS server. PXE support is usually available in the BIOS. To use PXE when the machine starts, select the <code>Boot from network</code> option in the BIOS setup or type a function key during system initialization.</p>
</div>
<div class="paragraph">
<p>In order to provide the files needed for an operating system to boot over the network, a PXE setup also requires properly configured DHCP, TFTP, and NFS servers, where:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Initial parameters, such as an IP address, executable boot filename and location, server name, and root path are obtained from the DHCP server.</p>
</li>
<li>
<p>The operating system loader file is booted using TFTP.</p>
</li>
<li>
<p>The file systems are loaded using NFS.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When a computer PXE boots, it receives information over DHCP about where to obtain the initial boot loader file. After the host computer receives this information, it downloads the boot loader via TFTP and then executes the boot loader. In FreeBSD, the boot loader file is <span class="filename">/boot/pxeboot</span>. After <span class="filename">/boot/pxeboot</span> executes, the FreeBSD kernel is loaded and the rest of the FreeBSD bootup sequence proceeds, as described in <a href="./#boot">The FreeBSD Booting Process</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>For UEFI PXE based boot, the actual boot loader file to use is <span class="filename">/boot/loader.efi</span>. See the below section <a href="./#_debugging_pxe_problems">Debugging PXE Problems</a> on how to use <span class="filename">/boot/loader.efi</span>.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>This section describes how to configure these services on a FreeBSD system so that other systems can PXE boot into FreeBSD. Refer to <a href="https://man.freebsd.org/cgi/man.cgi?query=diskless&amp;sektion=8&amp;format=html">diskless(8)</a> for more information.</p>
</div>
<div class="admonitionblock caution">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>As described, the system providing these services is insecure. It should live in a protected area of a network and be untrusted by other hosts.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="sect3">
<h4 id="network-pxe-nfs">34.10.1. Setting Up the PXE Environment<a class="anchor" href="#network-pxe-nfs"></a></h4>
<div class="paragraph">
<p>The steps shown in this section configure the built-in NFS and TFTP servers. The next section demonstrates how to install and configure the DHCP server. In this example, the directory which will contain the files used by PXE users is <span class="filename">/b/tftpboot/FreeBSD/install</span>. It is important that this directory exists and that the same directory name is set in both <span class="filename">/etc/inetd.conf</span> and <span class="filename">/usr/local/etc/dhcpd.conf</span>.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The command examples below assume use of the <a href="https://man.freebsd.org/cgi/man.cgi?query=sh&amp;sektion=1&amp;format=html">sh(1)</a> shell. <a href="https://man.freebsd.org/cgi/man.cgi?query=csh&amp;sektion=1&amp;format=html">csh(1)</a> and <a href="https://man.freebsd.org/cgi/man.cgi?query=tcsh&amp;sektion=1&amp;format=html">tcsh(1)</a> users will need to start a <a href="https://man.freebsd.org/cgi/man.cgi?query=sh&amp;sektion=1&amp;format=html">sh(1)</a> shell or adapt the commands to <a href="https://man.freebsd.org/cgi/man.cgi?query=csh&amp;sektion=1&amp;format=html">csh(1)</a> syntax.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="olist arabic procedure">
<ol class="arabic">
<li>
<p>Create the root directory which will contain a FreeBSD installation to be NFS mounted:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># export NFSROOTDIR=/b/tftpboot/FreeBSD/install</span>
<span class="c"># mkdir -p ${NFSROOTDIR}</span></code></pre>
</div>
</div>
</li>
<li>
<p>Enable the NFS server by adding this line to <span class="filename">/etc/rc.conf</span>:</p>
<div class="literalblock programlisting">
<div class="content">
<pre>nfs_server_enable=&#34;YES&#34;</pre>
</div>
</div>
</li>
<li>
<p>Export the diskless root directory via NFS by adding the following to <span class="filename">/etc/exports</span>:</p>
<div class="literalblock programlisting">
<div class="content">
<pre>/b -ro -alldirs -maproot=root</pre>
</div>
</div>
</li>
<li>
<p>Start the NFS server:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># service nfsd start</span></code></pre>
</div>
</div>
</li>
<li>
<p>Enable <a href="https://man.freebsd.org/cgi/man.cgi?query=inetd&amp;sektion=8&amp;format=html">inetd(8)</a> by adding the following line to <span class="filename">/etc/rc.conf</span>:</p>
<div class="literalblock programlisting">
<div class="content">
<pre>inetd_enable=&#34;YES&#34;</pre>
</div>
</div>
</li>
<li>
<p>Uncomment the following line in <span class="filename">/etc/inetd.conf</span> by making sure it does not start with a <code>#</code> symbol:</p>
<div class="literalblock programlisting">
<div class="content">
<pre>tftp dgram udp wait root /usr/libexec/tftpd tftpd blocksize 1468 -l -s /b/tftpboot</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The specified tftp blocksize, e.g. 1468 bytes, replaces the default size 512 bytes. Some PXE versions require the TCP version of TFTP. In this case, uncomment the second <code>tftp</code> line which contains <code>stream tcp</code>.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
</li>
<li>
<p>Start <a href="https://man.freebsd.org/cgi/man.cgi?query=inetd&amp;sektion=8&amp;format=html">inetd(8)</a>:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># service inetd start</span></code></pre>
</div>
</div>
</li>
<li>
<p>Install the base system into <span class="filename">${NFSROOTDIR}</span>, either by decompressing the official archives or by rebuilding the FreeBSD kernel and userland (refer to <a href="./#makeworld">“Updating FreeBSD from Source”</a> for more detailed instructions, but do not forget to add <code>DESTDIR=<em>${NFSROOTDIR}</em></code> when running the <code>make installkernel</code> and <code>make installworld</code> commands.</p>
</li>
<li>
<p>Test that the TFTP server works and can download the boot loader which will be obtained via PXE:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># tftp localhost</span>
<span class="gp">tftp&gt; </span>get FreeBSD/install/boot/pxeboot
Received 264951 bytes <span class="k">in </span>0.1 seconds</code></pre>
</div>
</div>
</li>
<li>
<p>Edit <span class="filename">${NFSROOTDIR}/etc/fstab</span> and create an entry to mount the root file system over NFS:</p>
<div class="literalblock programlisting">
<div class="content">
<pre># Device                                         Mountpoint    FSType   Options  Dump Pass
myhost.example.com:/b/tftpboot/FreeBSD/install       /         nfs      ro        0    0</pre>
</div>
</div>
<div class="paragraph">
<p>Replace <em>myhost.example.com</em> with the hostname or IP address of the NFS server. In this example, the root file system is mounted read-only in order to prevent NFS clients from potentially deleting the contents of the root file system.</p>
</div>
</li>
<li>
<p>Set the root password in the PXE environment for client machines which are PXE booting :</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># chroot ${NFSROOTDIR}</span>
<span class="c"># passwd</span></code></pre>
</div>
</div>
</li>
<li>
<p>If needed, enable <a href="https://man.freebsd.org/cgi/man.cgi?query=ssh&amp;sektion=1&amp;format=html">ssh(1)</a> root logins for client machines which are PXE booting by editing <span class="filename">${NFSROOTDIR}/etc/ssh/sshd_config</span> and enabling <code>PermitRootLogin</code>. This option is documented in <a href="https://man.freebsd.org/cgi/man.cgi?query=sshd_config&amp;sektion=5&amp;format=html">sshd_config(5)</a>.</p>
</li>
<li>
<p>Perform any other needed customizations of the PXE environment in <span class="filename">${NFSROOTDIR}</span>. These customizations could include things like installing packages or editing the password file with <a href="https://man.freebsd.org/cgi/man.cgi?query=vipw&amp;sektion=8&amp;format=html">vipw(8)</a>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>When booting from an NFS root volume, <span class="filename">/etc/rc</span> detects the NFS boot and runs <span class="filename">/etc/rc.initdiskless</span>. In this case, <span class="filename">/etc</span> and <span class="filename">/var</span> need to be memory backed file systems so that these directories are writable but the NFS root directory is read-only:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># chroot ${NFSROOTDIR}</span>
<span class="c"># mkdir -p conf/base</span>
<span class="c"># tar -c -v -f conf/base/etc.cpio.gz --format cpio --gzip etc</span>
<span class="c"># tar -c -v -f conf/base/var.cpio.gz --format cpio --gzip var</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When the system boots, memory file systems for <span class="filename">/etc</span> and <span class="filename">/var</span> will be created and mounted and the contents of the <span class="filename">cpio.gz</span> files will be copied into them. By default, these file systems have a maximum capacity of 5 megabytes. If your archives do not fit, which is usually the case for <span class="filename">/var</span> when binary packages have been installed, request a larger size by putting the number of 512 byte sectors needed (e.g., 5 megabytes is 10240 sectors) in <span class="filename">${NFSROOTDIR}/conf/base/etc/md_size</span> and <span class="filename">${NFSROOTDIR}/conf/base/var/md_size</span> files for <span class="filename">/etc</span> and <span class="filename">/var</span> file systems respectively.</p>
</div>
</div>
<div class="sect3">
<h4 id="network-pxe-setting-up-dhcp">34.10.2. Configuring the DHCP Server<a class="anchor" href="#network-pxe-setting-up-dhcp"></a></h4>
<div class="paragraph">
<p>The DHCP server does not need to be the same machine as the TFTP and NFS server, but it needs to be accessible in the network.</p>
</div>
<div class="paragraph">
<p>DHCP is not part of the FreeBSD base system but can be installed using the <a class="package" href="https://cgit.freebsd.org/ports/tree/net/isc-dhcp44-server/">net/isc-dhcp44-server</a> port or package.</p>
</div>
<div class="paragraph">
<p>Once installed, edit the configuration file, <span class="filename">/usr/local/etc/dhcpd.conf</span>. Configure the <code>next-server</code>, <code>filename</code>, and <code>root-path</code> settings as seen in this example:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>subnet 192.168.0.0 netmask 255.255.255.0 {
   range 192.168.0.2 192.168.0.3 ;
   option subnet-mask 255.255.255.0 ;
   option routers 192.168.0.1 ;
   option broadcast-address 192.168.0.255 ;
   option domain-name-servers 192.168.35.35, 192.168.35.36 ;
   option domain-name &#34;example.com&#34;;

   # IP address of TFTP server
   next-server 192.168.0.1 ;

   # path of boot loader obtained via tftp
   filename &#34;FreeBSD/install/boot/pxeboot&#34; ;

   # pxeboot boot loader will try to NFS mount this directory for root FS
   option root-path &#34;192.168.0.1:/b/tftpboot/FreeBSD/install/&#34; ;

}</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>next-server</code> directive is used to specify the IP address of the TFTP server.</p>
</div>
<div class="paragraph">
<p>The <code>filename</code> directive defines the path to <span class="filename">/boot/pxeboot</span>. A relative filename is used, meaning that <span class="filename">/b/tftpboot</span> is not included in the path.</p>
</div>
<div class="paragraph">
<p>The <code>root-path</code> option defines the path to the NFS root file system.</p>
</div>
<div class="paragraph">
<p>Once the edits are saved, enable DHCP at boot time by adding the following line to <span class="filename">/etc/rc.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>dhcpd_enable=&#34;YES&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>Then start the DHCP service:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># service isc-dhcpd start</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_debugging_pxe_problems">34.10.3. Debugging PXE Problems<a class="anchor" href="#_debugging_pxe_problems"></a></h4>
<div class="paragraph">
<p>Once all of the services are configured and started, PXE clients should be able to automatically load FreeBSD over the network. If a particular client is unable to connect, when that client machine boots up, enter the BIOS configuration menu and confirm that it is set to boot from the network.</p>
</div>
<div class="paragraph">
<p>This section describes some troubleshooting tips for isolating the source of the configuration problem should no clients be able to PXE boot.</p>
</div>
<div class="sidebarblock procedure">
<div class="content">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Use the <a class="package" href="https://cgit.freebsd.org/ports/tree/net/wireshark/">net/wireshark</a> package or port to debug the network traffic involved during the PXE booting process, which is illustrated in the diagram below.</p>
<div class="imageblock">
<div class="content">
<img src="../../../../images/books/handbook/advanced-networking/pxe-nfs.png" alt="pxe nfs"/>
</div>
<div class="title">图 61. PXE Booting Process with NFS Root Mount</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Client broadcasts a DHCPDISCOVER message.</p>
</li>
<li>
<p>The DHCP server responds with the IP address, next-server, filename, and root-path values.</p>
</li>
<li>
<p>The client sends a TFTP request to next-server, asking to retrieve filename.</p>
</li>
<li>
<p>The TFTP server responds and sends filename to client.</p>
</li>
<li>
<p>The client executes filename, which is pxeboot(8), which then loads the kernel. When the kernel executes, the root file system specified by root-path is mounted over NFS.</p>
</li>
</ol>
</div>
</li>
<li>
<p>On the TFTP server, read <span class="filename">/var/log/xferlog</span> to ensure that <span class="filename">pxeboot</span> is being retrieved from the correct location. To test this example configuration:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># tftp 192.168.0.1</span>
<span class="gp">tftp&gt; </span>get FreeBSD/install/boot/pxeboot
Received 264951 bytes <span class="k">in </span>0.1 seconds</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>BUGS</code> sections in <a href="https://man.freebsd.org/cgi/man.cgi?query=tftpd&amp;sektion=8&amp;format=html">tftpd(8)</a> and <a href="https://man.freebsd.org/cgi/man.cgi?query=tftp&amp;sektion=1&amp;format=html">tftp(1)</a> document some limitations with TFTP.</p>
</div>
</li>
<li>
<p>Make sure that the root file system can be mounted via NFS. To test this example configuration:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># mount -t nfs 192.168.0.1:/b/tftpboot/FreeBSD/install /mnt</span></code></pre>
</div>
</div>
</li>
<li>
<p>For UEFI PXE based booting, replace the <span class="filename">boot/pxeboot</span> file with the <span class="filename">boot/loader.efi</span> file:</p>
</li>
</ol>
</div>
<div class="literalblock">
<div class="content">
<pre># chroot ${NFSROOTDIR}
# mv boot/pxeboot boot/pxeboot.original
# cp boot/loader.efi boot/pxeboot</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="carp">34.11. Common Address Redundancy Protocol (CARP)<a class="anchor" href="#carp"></a></h3>
<div class="paragraph">
<p>The Common Address Redundancy Protocol (CARP) allows multiple hosts to share the same IP address and Virtual Host ID (VHID) in order to provide <em>high availability</em> for one or more services. This means that one or more hosts can fail, and the other hosts will transparently take over so that users do not see a service failure.</p>
</div>
<div class="paragraph">
<p>In addition to the shared IP address, each host has its own IP address for management and configuration. All of the machines that share an IP address have the same VHID. The VHID for each virtual IP address must be unique across the broadcast domain of the network interface.</p>
</div>
<div class="paragraph">
<p>High availability using CARP is built into FreeBSD, though the steps to configure it vary slightly depending upon the FreeBSD version. This section provides the same example configuration for versions before and equal to or after FreeBSD 10.</p>
</div>
<div class="paragraph">
<p>This example configures failover support with three hosts, all with unique IP addresses, but providing the same web content. It has two different masters named <code>hosta.example.org</code> and <code>hostb.example.org</code>, with a shared backup named <code>hostc.example.org</code>.</p>
</div>
<div class="paragraph">
<p>These machines are load balanced with a Round Robin DNS configuration. The master and backup machines are configured identically except for their hostnames and management IP addresses. These servers must have the same configuration and run the same services. When the failover occurs, requests to the service on the shared IP address can only be answered correctly if the backup server has access to the same content. The backup machine has two additional CARP interfaces, one for each of the master content server’s IP addresses. When a failure occurs, the backup server will pick up the failed master machine’s IP address.</p>
</div>
<div class="sect3">
<h4 id="carp-10x">34.11.1. Using CARP on FreeBSD 10 and Later<a class="anchor" href="#carp-10x"></a></h4>
<div class="paragraph">
<p>Enable boot-time support for CARP by adding an entry for the <span class="filename">carp.ko</span> kernel module in <span class="filename">/boot/loader.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>carp_load=&#34;YES&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>To load the module now without rebooting:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># kldload carp</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For users who prefer to use a custom kernel, include the following line in the custom kernel configuration file and compile the kernel as described in <a href="./#kernelconfig">Configuring the FreeBSD Kernel</a>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>device	carp</pre>
</div>
</div>
<div class="paragraph">
<p>The hostname, management IP address and subnet mask, shared IP address, and VHID are all set by adding entries to <span class="filename">/etc/rc.conf</span>. This example is for <code>hosta.example.org</code>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>hostname=&#34;hosta.example.org&#34;
ifconfig_em0=&#34;inet 192.168.1.3 netmask 255.255.255.0&#34;
ifconfig_em0_alias0=&#34;inet vhid 1 pass testpass alias 192.168.1.50/32&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>The next set of entries are for <code>hostb.example.org</code>. Since it represents a second master, it uses a different shared IP address and VHID. However, the passwords specified with <code>pass</code> must be identical as CARP will only listen to and accept advertisements from machines with the correct password.</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>hostname=&#34;hostb.example.org&#34;
ifconfig_em0=&#34;inet 192.168.1.4 netmask 255.255.255.0&#34;
ifconfig_em0_alias0=&#34;inet vhid 2 pass testpass alias 192.168.1.51/32&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>The third machine, <code>hostc.example.org</code>, is configured to handle failover from either master. This machine is configured with two CARPVHIDs, one to handle the virtual IP address for each of the master hosts. The CARP advertising skew, <code>advskew</code>, is set to ensure that the backup host advertises later than the master, since <code>advskew</code> controls the order of precedence when there are multiple backup servers.</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>hostname=&#34;hostc.example.org&#34;
ifconfig_em0=&#34;inet 192.168.1.5 netmask 255.255.255.0&#34;
ifconfig_em0_alias0=&#34;inet vhid 1 advskew 100 pass testpass alias 192.168.1.50/32&#34;
ifconfig_em0_alias1=&#34;inet vhid 2 advskew 100 pass testpass alias 192.168.1.51/32&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>Having two CARPVHIDs configured means that <code>hostc.example.org</code> will notice if either of the master servers becomes unavailable. If a master fails to advertise before the backup server, the backup server will pick up the shared IP address until the master becomes available again.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If the original master server becomes available again, <code>hostc.example.org</code> will not release the virtual IP address back to it automatically. For this to happen, preemption has to be enabled. The feature is disabled by default, it is controlled via the <a href="https://man.freebsd.org/cgi/man.cgi?query=sysctl&amp;sektion=8&amp;format=html">sysctl(8)</a> variable <code>net.inet.carp.preempt</code>. The administrator can force the backup server to return the IP address to the master:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ifconfig em0 vhid 1 state backup</span></code></pre>
</div>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Once the configuration is complete, either restart networking or reboot each system. High availability is now enabled.</p>
</div>
<div class="paragraph">
<p>CARP functionality can be controlled via several <a href="https://man.freebsd.org/cgi/man.cgi?query=sysctl&amp;sektion=8&amp;format=html">sysctl(8)</a> variables documented in the <a href="https://man.freebsd.org/cgi/man.cgi?query=carp&amp;sektion=4&amp;format=html">carp(4)</a> manual pages. Other actions can be triggered from CARP events by using <a href="https://man.freebsd.org/cgi/man.cgi?query=devd&amp;sektion=8&amp;format=html">devd(8)</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="carp-9x">34.11.2. Using CARP on FreeBSD 9 and Earlier<a class="anchor" href="#carp-9x"></a></h4>
<div class="paragraph">
<p>The configuration for these versions of FreeBSD is similar to the one described in the previous section, except that a CARP device must first be created and referred to in the configuration.</p>
</div>
<div class="paragraph">
<p>Enable boot-time support for CARP by loading the <span class="filename">if_carp.ko</span> kernel module in <span class="filename">/boot/loader.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>if_carp_load=&#34;YES&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>To load the module now without rebooting:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># kldload carp</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For users who prefer to use a custom kernel, include the following line in the custom kernel configuration file and compile the kernel as described in <a href="./#kernelconfig">Configuring the FreeBSD Kernel</a>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>device	carp</pre>
</div>
</div>
<div class="paragraph">
<p>Next, on each host, create a CARP device:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ifconfig carp0 create</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Set the hostname, management IP address, the shared IP address, and VHID by adding the required lines to <span class="filename">/etc/rc.conf</span>. Since a virtual CARP device is used instead of an alias, the actual subnet mask of <code>/24</code> is used instead of <code>/32</code>. Here are the entries for <code>hosta.example.org</code>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>hostname=&#34;hosta.example.org&#34;
ifconfig_fxp0=&#34;inet 192.168.1.3 netmask 255.255.255.0&#34;
cloned_interfaces=&#34;carp0&#34;
ifconfig_carp0=&#34;vhid 1 pass testpass 192.168.1.50/24&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>On <code>hostb.example.org</code>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>hostname=&#34;hostb.example.org&#34;
ifconfig_fxp0=&#34;inet 192.168.1.4 netmask 255.255.255.0&#34;
cloned_interfaces=&#34;carp0&#34;
ifconfig_carp0=&#34;vhid 2 pass testpass 192.168.1.51/24&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>The third machine, <code>hostc.example.org</code>, is configured to handle failover from either of the master hosts:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>hostname=&#34;hostc.example.org&#34;
ifconfig_fxp0=&#34;inet 192.168.1.5 netmask 255.255.255.0&#34;
cloned_interfaces=&#34;carp0 carp1&#34;
ifconfig_carp0=&#34;vhid 1 advskew 100 pass testpass 192.168.1.50/24&#34;
ifconfig_carp1=&#34;vhid 2 advskew 100 pass testpass 192.168.1.51/24&#34;</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Preemption is disabled in the <span class="filename">GENERIC</span> FreeBSD kernel. If preemption has been enabled with a custom kernel, <code>hostc.example.org</code> may not release the IP address back to the original content server. The administrator can force the backup server to return the IP address to the master with the command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ifconfig carp0 down &amp;&amp; ifconfig carp0 up</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This should be done on the <span class="filename">carp</span> interface which corresponds to the correct host.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Once the configuration is complete, either restart networking or reboot each system. High availability is now enabled.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="network-vlan">34.12. VLANs<a class="anchor" href="#network-vlan"></a></h3>
<div class="paragraph">
<p>VLANs are a way of virtually dividing up a network into many different subnetworks, also referred to as segmenting. Each segment will have its own broadcast domain and be isolated from other VLANs.</p>
</div>
<div class="paragraph">
<p>On FreeBSD, VLANs must be supported by the network card driver. To see which drivers support vlans, refer to the <a href="https://man.freebsd.org/cgi/man.cgi?query=vlan&amp;sektion=4&amp;format=html">vlan(4)</a> manual page.</p>
</div>
<div class="paragraph">
<p>When configuring a VLAN, a couple pieces of information must be known. First, which network interface? Second, what is the VLAN tag?</p>
</div>
<div class="paragraph">
<p>To configure VLANs at run time, with a NIC of <code>em0</code> and a VLAN tag of <code>5</code> the command would look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ifconfig em0.5 create vlan 5 vlandev em0 inet 192.168.20.20/24</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>See how the interface name includes the NIC driver name and the VLAN tag, separated by a period? This is a best practice to make maintaining the VLAN configuration easy when many VLANs are present on a machine.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>To configure VLANs at boot time, <span class="filename">/etc/rc.conf</span> must be updated. To duplicate the configuration above, the following will need to be added:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>vlans_em0=&#34;5&#34;
ifconfig_em0_5=&#34;inet 192.168.20.20/24&#34;</pre>
</div>
</div>
<div class="paragraph">
<p>Additional VLANs may be added, by simply adding the tag to the <code>vlans_em0</code> field and adding an additional line configuring the network on that VLAN tag’s interface.</p>
</div>
<div class="paragraph">
<p>It is useful to assign a symbolic name to an interface so that when the associated hardware is changed, only a few configuration variables need to be updated. For example, security cameras need to be run over VLAN 1 on <code>em0</code>. Later, if the <code>em0</code> card is replaced with a card that uses the <a href="https://man.freebsd.org/cgi/man.cgi?query=ixgb&amp;sektion=4&amp;format=html">ixgb(4)</a> driver, all references to <code>em0.1</code> will not have to change to <code>ixgb0.1</code>.</p>
</div>
<div class="paragraph">
<p>To configure VLAN <code>5</code>, on the NIC <code>em0</code>, assign the interface name <code>cameras</code>, and assign the interface an IP address of <code><em>192.168.20.20</em></code> with a <code>24</code>-bit prefix, use this command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ifconfig em0.5 create vlan 5 vlandev em0 name cameras inet 192.168.20.20/24</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For an interface named <code>video</code>, use the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># ifconfig video.5 create vlan 5 vlandev video name cameras inet 192.168.20.20/24</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To apply the changes at boot time, add the following lines to <span class="filename">/etc/rc.conf</span>:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>vlans_video=&#34;cameras&#34;
create_args_cameras=&#34;vlan 5&#34;
ifconfig_cameras=&#34;inet 192.168.20.20/24&#34;</pre>
</div>
</div>
</div>
</div>
</div>
<h1 id="appendices" class="sect0">Part V: 附录<a class="anchor" href="#appendices"></a></h1>
<div class="sect1">
<h2 id="_obtaining_freebsd">附录 A: Obtaining FreeBSD<a class="anchor" href="#_obtaining_freebsd"></a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="mirrors">A.1. Mirrors<a class="anchor" href="#mirrors"></a></h3>
<div class="paragraph">
<p>The official mirrors of the FreeBSD project are made up of many machines operated by the project cluster administrators and behind GeoDNS to direct users to the closest available mirror. Current locations are Australia, Brazil, Germany, Japan (two sites), Malaysia, South Africa, Taiwan, United Kingdom, United States of America (California, New Jersey, and Washington).</p>
</div>
<div class="paragraph">
<p>Official mirrors service:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;"/>
<col style="width: 20%;"/>
<col style="width: 60%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Service Name</th>
<th class="tableblock halign-left valign-top">Protocols</th>
<th class="tableblock halign-left valign-top">More information</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>docs.FreeBSD.org</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.FreeBSD.org/">https</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FreeBSD Documentation Portal.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>download.FreeBSD.org</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://download.FreeBSD.org/">https</a> <a href="ftp://download.FreeBSD.org/pub/FreeBSD/">ftp</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Same content as <code>ftp.FreeBSD.org</code>, <code>ftp</code> is a legacy name; <code>download.FreeBSD.org</code> is recommended.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>git.FreeBSD.org</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">git over <code>https</code> and <code>ssh</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">More details on <a href="https://docs.freebsd.org/en/books/handbook/mirrors/#git">using git</a> section.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>pkg.FreeBSD.org</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://man.freebsd.org/cgi/man.cgi?query=pkg&amp;sektion=8&amp;format=html">pkg(8)</a> over <code>http</code> and <code>https</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Official FreeBSD package repositories used by the <a href="https://man.freebsd.org/cgi/man.cgi?query=pkg&amp;sektion=8&amp;format=html">pkg(8)</a> program.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>vuxml.FreeBSD.org</strong> / <strong>www.VuXML.org</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.vuxml.org/">https</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FreeBSD Project VuXML web page. <code>pkg audit</code> fetches the list of vulnerabilities from this service.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>www.FreeBSD.org</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://www.FreeBSD.org/">https</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FreeBSD Website.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>All official mirrors support IPv4 and IPv6.</p>
</div>
<div class="paragraph">
<p><a href="http://ftp-archive.FreeBSD.org" class="bare">http://ftp-archive.FreeBSD.org</a> is not in the GeoDNS Infrastructure, hosted in only one location (US).</p>
</div>
<div class="paragraph">
<p>The project is looking for new locations; those willing to sponsor, please reach out to the Cluster Administrators team for more information.</p>
</div>
<div class="paragraph">
<p>Mirror list maintained by the community and other companies:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;"/>
<col style="width: 20%;"/>
<col style="width: 60%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Country</th>
<th class="tableblock halign-left valign-top">Hostname</th>
<th class="tableblock halign-left valign-top">Protocols</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Australia <span class="icon"><a class="image" href="mailto:hostmaster@au.FreeBSD.org"><i class="fa fa-envelope" title="mirror contact"></i></a></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ftp.au.FreeBSD.org</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://ftp.au.FreeBSD.org/pub/FreeBSD">http</a> <a href="http://ftp.au.FreeBSD.org/pub/FreeBSD">http_v6</a> <a href="rsync://ftp.au.FreeBSD.org">rsync</a> <a href="rsync://ftp.au.FreeBSD.org">rsync_v6</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ftp3.au.FreeBSD.org</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://ftp3.au.FreeBSD.org/pub/FreeBSD">http</a> <a href="ftp://ftp3.au.FreeBSD.org/pub/FreeBSD">ftp</a> <a href="rsync://ftp3.au.FreeBSD.org">rsync</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Austria <span class="icon"><a class="image" href="mailto:hostmaster@at.FreeBSD.org"><i class="fa fa-envelope" title="mirror contact"></i></a></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ftp.at.FreeBSD.org</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://ftp.at.FreeBSD.org/pub/FreeBSD/">http</a> <a href="http://ftp.at.FreeBSD.org/pub/FreeBSD/">http_v6</a> <a href="ftp://ftp.at.FreeBSD.org/pub/FreeBSD/">ftp</a> <a href="ftp://ftp.at.FreeBSD.org/pub/FreeBSD/">ftp_v6</a> <a href="rsync://ftp.at.FreeBSD.org/pub/FreeBSD/">rsync</a> <a href="rsync://ftp.at.FreeBSD.org/pub/FreeBSD/">rsync_v6</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Brazil <span class="icon"><a class="image" href="mailto:hostmaster@br.FreeBSD.org"><i class="fa fa-envelope" title="mirror contact"></i></a></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ftp2.br.FreeBSD.org</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://ftp2.br.FreeBSD.org/FreeBSD">http</a> <a href="rsync://ftp2.br.FreeBSD.org">rsync</a> <a href="rsync://ftp2.br.FreeBSD.org">rsync_v6</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ftp3.br.FreeBSD.org</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://ftp3.br.FreeBSD.org/pub/FreeBSD">http</a> <a href="ftp://ftp3.br.FreeBSD.org/pub/FreeBSD">ftp</a> <a href="rsync://ftp3.br.FreeBSD.org">rsync</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bulgaria <span class="icon"><a class="image" href="mailto:mirror@telepoint.bg"><i class="fa fa-envelope" title="mirror contact"></i></a></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ftp.bg.FreeBSD.org</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="ftp://ftp.bg.FreeBSD.org/pub/FreeBSD">ftp</a> <a href="ftp://ftp.bg.FreeBSD.org/pub/FreeBSD">ftp_v6</a> <a href="rsync://ftp.bg.FreeBSD.org">rsync</a> <a href="rsync://ftp.bg.FreeBSD.org">rsync_v6</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Czech Republic <span class="icon"><a class="image" href="mailto:hostmaster@cz.FreeBSD.org"><i class="fa fa-envelope" title="mirror contact"></i></a></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ftp.cz.FreeBSD.org</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://ftp.cz.FreeBSD.org/pub/FreeBSD">http</a> <a href="http://ftp.cz.FreeBSD.org/pub/FreeBSD">http_v6</a> <a href="rsync://ftp.cz.FreeBSD.org">rsync</a> <a href="rsync://ftp.cz.FreeBSD.org">rsync_v6</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Denmark <span class="icon"><a class="image" href="mailto:staff@dotsrc.org"><i class="fa fa-envelope" title="mirror contact"></i></a></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ftp.dk.FreeBSD.org</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://ftp.dk.FreeBSD.org/FreeBSD/">http</a> <a href="http://ftp.dk.FreeBSD.org/FreeBSD/">http_v6</a> <a href="ftp://ftp.dk.FreeBSD.org/FreeBSD/">ftp</a> <a href="ftp://ftp.dk.FreeBSD.org/FreeBSD/">ftp_v6</a> <a href="rsync://ftp.dk.FreeBSD.org/FreeBSD/">rsync</a> <a href="rsync://ftp.dk.FreeBSD.org/FreeBSD/">rsync_v6</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Finland <span class="icon"><a class="image" href="mailto:hostmaster@fi.FreeBSD.org"><i class="fa fa-envelope" title="mirror contact"></i></a></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ftp.fi.FreeBSD.org</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="ftp://ftp.fi.FreeBSD.org/pub/FreeBSD">ftp</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">France <span class="icon"><a class="image" href="mailto:hostmaster@fr.FreeBSD.org"><i class="fa fa-envelope" title="mirror contact"></i></a></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ftp.fr.FreeBSD.org</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://ftp.fr.FreeBSD.org/pub/FreeBSD">http</a> <a href="http://ftp.fr.FreeBSD.org/pub/FreeBSD">http_v6</a> <a href="ftp://ftp.fr.FreeBSD.org/pub/FreeBSD">ftp</a> <a href="ftp://ftp.fr.FreeBSD.org/pub/FreeBSD">ftp_v6</a> <a href="rsync://ftp.fr.FreeBSD.org">rsync</a> <a href="rsync://ftp.fr.FreeBSD.org">rsync_v6</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ftp3.fr.FreeBSD.org</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="ftp://ftp3.fr.FreeBSD.org/pub/FreeBSD">ftp</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ftp6.fr.FreeBSD.org</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://ftp6.fr.FreeBSD.org/pub/FreeBSD">http</a> <a href="ftp://ftp6.fr.FreeBSD.org/pub/FreeBSD">ftp</a> <a href="rsync://ftp6.fr.FreeBSD.org">rsync</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Germany <span class="icon"><a class="image" href="mailto:de-bsd-hubs@de.FreeBSD.org"><i class="fa fa-envelope" title="mirror contact"></i></a></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ftp.de.FreeBSD.org</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="ftp://ftp.de.FreeBSD.org/pub/FreeBSD">ftp</a> <a href="ftp://ftp.de.FreeBSD.org/pub/FreeBSD">ftp_v6</a> <a href="rsync://ftp.de.FreeBSD.org">rsync</a> <a href="rsync://ftp.de.FreeBSD.org">rsync_v6</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ftp1.de.FreeBSD.org</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://ftp1.de.FreeBSD.org/pub/FreeBSD">http</a> <a href="http://ftp1.de.FreeBSD.org/pub/FreeBSD">http_v6</a> <a href="ftp://ftp1.de.FreeBSD.org/pub/FreeBSD">ftp</a> <a href="ftp://ftp1.de.FreeBSD.org/pub/FreeBSD">ftp_v6</a> <a href="rsync://ftp1.de.FreeBSD.org">rsync</a> <a href="rsync://ftp1.de.FreeBSD.org">rsync_v6</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ftp2.de.FreeBSD.org</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://ftp2.de.FreeBSD.org/pub/FreeBSD">http</a> <a href="http://ftp2.de.FreeBSD.org/pub/FreeBSD">http_v6</a> <a href="ftp://ftp2.de.FreeBSD.org/pub/FreeBSD">ftp</a> <a href="ftp://ftp2.de.FreeBSD.org/pub/FreeBSD">ftp_v6</a> <a href="rsync://ftp2.de.FreeBSD.org">rsync</a> <a href="rsync://ftp2.de.FreeBSD.org">rsync_v6</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ftp5.de.FreeBSD.org</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="ftp://ftp5.de.FreeBSD.org/pub/FreeBSD">ftp</a> <a href="ftp://ftp5.de.FreeBSD.org/pub/FreeBSD">ftp_v6</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ftp7.de.FreeBSD.org</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://ftp7.de.FreeBSD.org/pub/FreeBSD">http</a> <a href="http://ftp7.de.FreeBSD.org/pub/FreeBSD">http_v6</a> <a href="ftp://ftp7.de.FreeBSD.org/pub/FreeBSD">ftp</a> <a href="ftp://ftp7.de.FreeBSD.org/pub/FreeBSD">ftp_v6</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Greece <span class="icon"><a class="image" href="mailto:hostmaster@gr.FreeBSD.org"><i class="fa fa-envelope" title="mirror contact"></i></a></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ftp.gr.FreeBSD.org</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://ftp.gr.FreeBSD.org/pub/FreeBSD">http</a> <a href="http://ftp.gr.FreeBSD.org/pub/FreeBSD">http_v6</a> <a href="ftp://ftp.gr.FreeBSD.org/pub/FreeBSD">ftp</a> <a href="ftp://ftp.gr.FreeBSD.org/pub/FreeBSD">ftp_v6</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ftp2.gr.FreeBSD.org</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://ftp2.gr.FreeBSD.org/pub/FreeBSD">http</a> <a href="http://ftp2.gr.FreeBSD.org/pub/FreeBSD">http_v6</a> <a href="ftp://ftp2.gr.FreeBSD.org/pub/FreeBSD">ftp</a> <a href="ftp://ftp2.gr.FreeBSD.org/pub/FreeBSD">ftp_v6</a> <a href="rsync://ftp2.gr.FreeBSD.org">rsync</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Japan <span class="icon"><a class="image" href="mailto:hostmaster@jp.FreeBSD.org"><i class="fa fa-envelope" title="mirror contact"></i></a></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ftp.jp.FreeBSD.org</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://ftp.jp.FreeBSD.org/pub/FreeBSD">http</a> <a href="http://ftp.jp.FreeBSD.org/pub/FreeBSD">http_v6</a> <a href="ftp://ftp.jp.FreeBSD.org/pub/FreeBSD">ftp</a> <a href="ftp://ftp.jp.FreeBSD.org/pub/FreeBSD">ftp_v6</a> <a href="rsync://ftp.jp.FreeBSD.org">rsync</a> <a href="rsync://ftp.jp.FreeBSD.org">rsync_v6</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ftp2.jp.FreeBSD.org</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="ftp://ftp2.jp.FreeBSD.org/pub/FreeBSD">ftp</a> <a href="rsync://ftp2.jp.FreeBSD.org">rsync</a> <a href="rsync://ftp2.jp.FreeBSD.org">rsync_v6</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ftp3.jp.FreeBSD.org</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://ftp3.jp.FreeBSD.org/pub/FreeBSD">http</a> <a href="rsync://ftp3.jp.FreeBSD.org">rsync</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ftp4.jp.FreeBSD.org</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="ftp://ftp4.jp.FreeBSD.org/pub/FreeBSD">ftp</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ftp6.jp.FreeBSD.org</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://ftp6.jp.FreeBSD.org/pub/FreeBSD">http</a> <a href="http://ftp6.jp.FreeBSD.org/pub/FreeBSD">http_v6</a> <a href="ftp://ftp6.jp.FreeBSD.org/pub/FreeBSD">ftp</a> <a href="ftp://ftp6.jp.FreeBSD.org/pub/FreeBSD">ftp_v6</a> <a href="rsync://ftp6.jp.FreeBSD.org">rsync</a> <a href="rsync://ftp6.jp.FreeBSD.org">rsync_v6</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kazakhstan <span class="icon"><a class="image" href="mailto:support@ps.kz"><i class="fa fa-envelope" title="mirror contact"></i></a></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">mirror.ps.kz</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://mirror.ps.kz/freebsd">http</a> <a href="ftp://mirror.ps.kz/freebsd">ftp</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">mirror.neolabs.kz</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://mirror.neolabs.kz/freebsd">http</a> <a href="ftp://mirror.neolabs.kz/freebsd">ftp</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Korea <span class="icon"><a class="image" href="mailto:hostmaster@kr.FreeBSD.org"><i class="fa fa-envelope" title="mirror contact"></i></a></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ftp.kr.FreeBSD.org</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://ftp.kr.FreeBSD.org/pub/FreeBSD">http</a> <a href="https://ftp.kr.FreeBSD.org/pub/FreeBSD">https</a> <a href="ftp://ftp.kr.FreeBSD.org/pub/FreeBSD">ftp</a> <a href="rsync://ftp.kr.FreeBSD.org">rsync</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ftp2.kr.FreeBSD.org</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="rsync://ftp2.kr.FreeBSD.org">rsync</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Latvia <span class="icon"><a class="image" href="mailto:hostmaster@lv.FreeBSD.org"><i class="fa fa-envelope" title="mirror contact"></i></a></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ftp.lv.FreeBSD.org</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://ftp.lv.FreeBSD.org/freebsd">http</a> <a href="ftp://ftp.lv.FreeBSD.org/freebsd">ftp</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Netherlands <span class="icon"><a class="image" href="mailto:hostmaster@nl.FreeBSD.org"><i class="fa fa-envelope" title="mirror contact"></i></a></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ftp.nl.FreeBSD.org</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://ftp.nl.FreeBSD.org/pub/FreeBSD">http</a> <a href="http://ftp.nl.FreeBSD.org/pub/FreeBSD">http_v6</a> <a href="ftp://ftp.nl.FreeBSD.org/pub/FreeBSD">ftp</a> <a href="ftp://ftp.nl.FreeBSD.org/pub/FreeBSD">ftp_v6</a> <a href="rsync://ftp.nl.FreeBSD.org">rsync</a> <a href="rsync://ftp.nl.FreeBSD.org">rsync_v6</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ftp2.nl.FreeBSD.org</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://ftp2.nl.FreeBSD.org/pub/FreeBSD">http</a> <a href="ftp://ftp2.nl.FreeBSD.org/pub/FreeBSD">ftp</a> <a href="rsync://ftp2.nl.FreeBSD.org">rsync</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">mirror.nl.altushost.com</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://mirror.nl.altushost.com/FreeBSD">https</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">New Zealand <span class="icon"><a class="image" href="mailto:hostmaster@nz.FreeBSD.org"><i class="fa fa-envelope" title="mirror contact"></i></a></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ftp.nz.FreeBSD.org</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://ftp.nz.FreeBSD.org/pub/FreeBSD">http</a> <a href="ftp://ftp.nz.FreeBSD.org/pub/FreeBSD">ftp</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Norway <span class="icon"><a class="image" href="mailto:hostmaster@no.FreeBSD.org"><i class="fa fa-envelope" title="mirror contact"></i></a></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ftp.no.FreeBSD.org</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="ftp://ftp.no.FreeBSD.org/pub/FreeBSD">ftp</a> <a href="ftp://ftp.no.FreeBSD.org/pub/FreeBSD">ftp_v6</a> <a href="rsync://ftp.no.FreeBSD.org">rsync</a> <a href="rsync://ftp.no.FreeBSD.org">rsync_v6</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Poland <span class="icon"><a class="image" href="mailto:hostmaster@pl.FreeBSD.org"><i class="fa fa-envelope" title="mirror contact"></i></a></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ftp.pl.FreeBSD.org</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://ftp.pl.FreeBSD.org/pub/FreeBSD">http</a> <a href="http://ftp.pl.FreeBSD.org/pub/FreeBSD">http_v6</a> <a href="ftp://ftp.pl.FreeBSD.org/pub/FreeBSD">ftp</a> <a href="rsync://ftp.pl.FreeBSD.org">rsync</a> <a href="rsync://ftp.pl.FreeBSD.org">rsync_v6</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Russia <span class="icon"><a class="image" href="mailto:hostmaster@ru.FreeBSD.org"><i class="fa fa-envelope" title="mirror contact"></i></a></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ftp.ru.FreeBSD.org</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://ftp.ru.FreeBSD.org/pub/FreeBSD">http</a> <a href="http://ftp.ru.FreeBSD.org/pub/FreeBSD">http_v6</a> <a href="ftp://ftp.ru.FreeBSD.org/pub/FreeBSD">ftp</a> <a href="ftp://ftp.ru.FreeBSD.org/pub/FreeBSD">ftp_v6</a> <a href="rsync://ftp.ru.FreeBSD.org">rsync</a> <a href="rsync://ftp.ru.FreeBSD.org">rsync_v6</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ftp2.ru.FreeBSD.org</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://ftp2.ru.FreeBSD.org/pub/FreeBSD">https</a> <a href="ftp://ftp2.ru.FreeBSD.org/pub/FreeBSD">ftp</a> <a href="rsync://ftp2.ru.FreeBSD.org">rsync</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Slovenia <span class="icon"><a class="image" href="mailto:hostmaster@si.FreeBSD.org"><i class="fa fa-envelope" title="mirror contact"></i></a></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ftp.si.FreeBSD.org</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://ftp.si.FreeBSD.org/pub/FreeBSD">http</a> <a href="http://ftp.si.FreeBSD.org/pub/FreeBSD">http_v6</a> <a href="ftp://ftp.si.FreeBSD.org/pub/FreeBSD">ftp</a> <a href="ftp://ftp.si.FreeBSD.org/pub/FreeBSD">ftp_v6</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">South Africa <span class="icon"><a class="image" href="mailto:hostmaster@za.FreeBSD.org"><i class="fa fa-envelope" title="mirror contact"></i></a></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ftp.za.FreeBSD.org</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://ftp.za.FreeBSD.org/pub/FreeBSD">https</a> <a href="https://ftp.za.FreeBSD.org/pub/FreeBSD">https_v6</a> <a href="rsync://ftp.za.FreeBSD.org">rsync</a> <a href="rsync://ftp.za.FreeBSD.org">rsync_v6</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ftp2.za.FreeBSD.org</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://ftp2.za.FreeBSD.org/pub/FreeBSD">http</a> <a href="http://ftp2.za.FreeBSD.org/pub/FreeBSD">http_v6</a> <a href="ftp://ftp2.za.FreeBSD.org/pub/FreeBSD">ftp_v6</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ftp4.za.FreeBSD.org</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://ftp4.za.FreeBSD.org/pub/FreeBSD">http</a> <a href="ftp://ftp4.za.FreeBSD.org/pub/FreeBSD">ftp</a> <a href="rsync://ftp4.za.FreeBSD.org">rsync</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sweden <span class="icon"><a class="image" href="mailto:hostmaster@se.FreeBSD.org"><i class="fa fa-envelope" title="mirror contact"></i></a></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ftp.se.FreeBSD.org</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://ftp.se.FreeBSD.org/pub/FreeBSD">http</a> <a href="http://ftp.se.FreeBSD.org/pub/FreeBSD">http_v6</a> <a href="ftp://ftp.se.FreeBSD.org/pub/FreeBSD">ftp</a> <a href="ftp://ftp.se.FreeBSD.org/pub/FreeBSD">ftp_v6</a> <a href="rsync://ftp.se.FreeBSD.org">rsync</a> <a href="rsync://ftp.se.FreeBSD.org">rsync_v6</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">mirror.se.altushost.com</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://mirror.se.altushost.com/FreeBSD">https</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Taiwan <span class="icon"><a class="image" href="mailto:hostmaster@tw.FreeBSD.org"><i class="fa fa-envelope" title="mirror contact"></i></a></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ftp4.tw.FreeBSD.org</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://ftp4.tw.FreeBSD.org/pub/FreeBSD">https</a> <a href="ftp://ftp4.tw.FreeBSD.org/pub/FreeBSD">ftp</a> <a href="rsync://ftp4.tw.FreeBSD.org">rsync</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ftp5.tw.FreeBSD.org</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://ftp5.tw.FreeBSD.org/pub/FreeBSD">http</a> <a href="ftp://ftp5.tw.FreeBSD.org/pub/FreeBSD">ftp</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ukraine <span class="icon"><a class="image" href="mailto:hostmaster@ua.FreeBSD.org"><i class="fa fa-envelope" title="mirror contact"></i></a></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ftp.ua.FreeBSD.org</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://ftp.ua.FreeBSD.org/pub/FreeBSD">http</a> <a href="ftp://ftp.ua.FreeBSD.org/pub/FreeBSD">ftp</a> <a href="ftp://ftp.ua.FreeBSD.org/pub/FreeBSD">ftp_v6</a> <a href="rsync://ftp.ua.FreeBSD.org">rsync</a> <a href="rsync://ftp.ua.FreeBSD.org">rsync_v6</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">United Kingdom <span class="icon"><a class="image" href="mailto:hostmaster@uk.FreeBSD.org"><i class="fa fa-envelope" title="mirror contact"></i></a></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ftp.uk.FreeBSD.org</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://ftp.uk.FreeBSD.org/pub/FreeBSD">http</a> <a href="http://ftp.uk.FreeBSD.org/pub/FreeBSD">http_v6</a> <a href="ftp://ftp.uk.FreeBSD.org/pub/FreeBSD">ftp</a> <a href="ftp://ftp.uk.FreeBSD.org/pub/FreeBSD">ftp_v6</a> <a href="rsync://ftp.uk.FreeBSD.org">rsync</a> <a href="rsync://ftp.uk.FreeBSD.org">rsync_v6</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ftp2.uk.FreeBSD.org</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://ftp2.uk.FreeBSD.org/pub/FreeBSD">http</a> <a href="http://ftp2.uk.FreeBSD.org/pub/FreeBSD">http_v6</a> <a href="https://ftp2.uk.FreeBSD.org/pub/FreeBSD">https</a> <a href="https://ftp2.uk.FreeBSD.org/pub/FreeBSD">https_v6</a> <a href="ftp://ftp2.uk.FreeBSD.org/pub/FreeBSD">ftp</a> <a href="ftp://ftp2.uk.FreeBSD.org/pub/FreeBSD">ftp_v6</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">United States of America <span class="icon"><a class="image" href="mailto:hostmaster@us.FreeBSD.org"><i class="fa fa-envelope" title="mirror contact"></i></a></span></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ftp11.FreeBSD.org</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://ftp11.FreeBSD.org/pub/FreeBSD">http</a> <a href="http://ftp11.FreeBSD.org/pub/FreeBSD">http_v6</a> <a href="ftp://ftp11.FreeBSD.org/pub/FreeBSD">ftp</a> <a href="ftp://ftp11.FreeBSD.org/pub/FreeBSD">ftp_v6</a> <a href="rsync://ftp11.FreeBSD.org">rsync</a> <a href="rsync://ftp11.FreeBSD.org">rsync_v6</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ftp14.FreeBSD.org</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="ftp://ftp14.FreeBSD.org/pub/FreeBSD">ftp</a> <a href="rsync://ftp14.FreeBSD.org">rsync</a> (Former official tier 1)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ftp5.FreeBSD.org</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://ftp5.FreeBSD.org/pub/FreeBSD">http</a> <a href="http://ftp5.FreeBSD.org/pub/FreeBSD">http_v6</a> <a href="ftp://ftp5.FreeBSD.org/pub/FreeBSD">ftp</a> <a href="ftp://ftp5.FreeBSD.org/pub/FreeBSD">ftp_v6</a></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The current list of protocols supported by the community mirrors was last updated on 2022-01-31, and it’s not guaranteed.</p>
</div>
</div>
<div class="sect2">
<h3 id="git">A.2. Using Git<a class="anchor" href="#git"></a></h3>
<div class="sect3">
<h4 id="git-intro">A.2.1. Introduction<a class="anchor" href="#git-intro"></a></h4>
<div class="paragraph">
<p>As of December 2020, FreeBSD uses git as the primary version control system for storing all of FreeBSD’s base source code and documentation. As of April 2021, FreeBSD uses git as the only version control system for storing all of FreeBSD’s Ports Collection.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Git is generally a developer tool. Users may prefer to use <code>freebsd-update</code> (<a href="./#updating-upgrading-freebsdupdate">“FreeBSD Update”</a>) to update the FreeBSD base system, and <code>git</code> (<a href="./#ports-using">“Using the Ports Collection”</a>) to update the FreeBSD Ports Collection.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>This section demonstrates how to install Git on a FreeBSD system and use it to create a local copy of a FreeBSD source code repository.</p>
</div>
</div>
<div class="sect3">
<h4 id="git-install">A.2.2. Installation<a class="anchor" href="#git-install"></a></h4>
<div class="paragraph">
<p>Git can be installed from the Ports Collection, or as a package:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install git</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="git-usage">A.2.3. Running Git<a class="anchor" href="#git-usage"></a></h4>
<div class="paragraph">
<p>To fetch a clean copy of the sources into a local directory, use <code>git clone</code>. This directory of files is called the <em>working tree</em>.</p>
</div>
<div class="paragraph">
<p>Git uses URLs to designate a repository. There are three different repositories, <code>src</code> for the FreeBSD system source code, <code>doc</code> for documentation, and <code>ports</code> for the FreeBSD Ports Collection. All three are reachable over two different protocols: HTTPS and SSH. For example, the URL <code><a href="https://git.FreeBSD.org/src.git" class="bare">https://git.FreeBSD.org/src.git</a></code> specifies the main branch of the <code>src</code> repository, using the <code>https</code> protocol.</p>
</div>
<table id="git-url-table" class="tableblock frame-all grid-all stretch">
<caption class="title">表 48. FreeBSD Git Repository URL Table</caption>
<colgroup>
<col style="width: 50%;"/>
<col style="width: 50%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Item</th>
<th class="tableblock halign-left valign-top">Git URL</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Read-only src repo via HTTPS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><a href="https://git.FreeBSD.org/src.git" class="bare">https://git.FreeBSD.org/src.git</a></code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Read-only src repo via anon-ssh</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ssh://anongit@git.FreeBSD.org/src.git</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Read-only doc repo via HTTPS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><a href="https://git.FreeBSD.org/doc.git" class="bare">https://git.FreeBSD.org/doc.git</a></code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Read-only doc repo via anon-ssh</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ssh://anongit@git.FreeBSD.org/doc.git</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Read-only ports repo via HTTPS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><a href="https://git.FreeBSD.org/ports.git" class="bare">https://git.FreeBSD.org/ports.git</a></code></p></td>
</tr>
</tbody>
<tfoot>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Read-only ports repo via anon-ssh</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ssh://anongit@git.FreeBSD.org/ports.git</code></p></td>
</tr>
</tfoot>
</table>
<div class="paragraph">
<p>External mirrors maintained by project members are also available; please refer to the <a href="#external-mirrors">External mirrors</a> section.</p>
</div>
<div class="paragraph">
<p>To clone a copy of the FreeBSD system source code repository:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># git clone -o freebsd https://git.FreeBSD.org/src.git /usr/src</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>-o freebsd</code> option specifies the origin; by convention in the FreeBSD documentation, the origin is assumed to be <code>freebsd</code>. Because the initial checkout must download the full branch of the remote repository, it can take a while. Please be patient.</p>
</div>
<div class="paragraph">
<p>Initially, the working tree contains source code for the <code>main</code> branch, which corresponds to CURRENT. To switch to 13-STABLE instead:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># cd /usr/src</span>
<span class="c"># git checkout stable/13</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The working tree can be updated with <code>git pull</code>. To update <span class="filename">/usr/src</span> created in the example above, use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># cd /usr/src</span>
<span class="c"># git pull --rebase</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The update is much quicker than a checkout, only transferring files that have changed.</p>
</div>
</div>
<div class="sect3">
<h4 id="_web_based_repository_browser">A.2.4. Web-based repository browser<a class="anchor" href="#_web_based_repository_browser"></a></h4>
<div class="paragraph">
<p>The FreeBSD project uses cgit as the web-based repository browser: <a href="https://cgit.FreeBSD.org/">https://cgit.FreeBSD.org/</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_for_developers">A.2.5. For Developers<a class="anchor" href="#_for_developers"></a></h4>
<div class="paragraph">
<p>For information about write access to repositories see the <a href="{committers-guide}#git-mini-primer">Committer’s Guide</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="external-mirrors">A.2.6. External mirrors<a class="anchor" href="#external-mirrors"></a></h4>
<div class="paragraph">
<p>Those mirrors are not hosted in FreeBSD.org but still maintained by the project members. Users and developers are welcome to pull or browse repositories on those mirrors. Pull requests for the <code>doc</code> and <code>src</code> GitHub repositories are being accepted; otherwise, the project workflow with those mirrors is still under discussion.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Codeberg</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>doc: <a href="https://codeberg.org/FreeBSD/freebsd-doc" class="bare">https://codeberg.org/FreeBSD/freebsd-doc</a></p>
</li>
<li>
<p>ports: <a href="https://codeberg.org/FreeBSD/freebsd-ports" class="bare">https://codeberg.org/FreeBSD/freebsd-ports</a></p>
</li>
<li>
<p>src: <a href="https://codeberg.org/FreeBSD/freebsd-src" class="bare">https://codeberg.org/FreeBSD/freebsd-src</a></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">GitHub</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>doc: <a href="https://github.com/freebsd/freebsd-doc" class="bare">https://github.com/freebsd/freebsd-doc</a></p>
</li>
<li>
<p>ports: <a href="https://github.com/freebsd/freebsd-ports" class="bare">https://github.com/freebsd/freebsd-ports</a></p>
</li>
<li>
<p>src: <a href="https://github.com/freebsd/freebsd-src" class="bare">https://github.com/freebsd/freebsd-src</a></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">GitLab</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>doc: <a href="https://gitlab.com/FreeBSD/freebsd-doc" class="bare">https://gitlab.com/FreeBSD/freebsd-doc</a></p>
</li>
<li>
<p>ports: <a href="https://gitlab.com/FreeBSD/freebsd-ports" class="bare">https://gitlab.com/FreeBSD/freebsd-ports</a></p>
</li>
<li>
<p>src: <a href="https://gitlab.com/FreeBSD/freebsd-src" class="bare">https://gitlab.com/FreeBSD/freebsd-src</a></p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_mailing_lists">A.2.7. Mailing lists<a class="anchor" href="#_mailing_lists"></a></h4>
<div class="paragraph">
<p>The main mailing list for general usage and questions about git in the FreeBSD project is <a href="https://lists.freebsd.org/subscription/freebsd-git">freebsd-git</a>. For more details, including commit messages lists, see the <a href="./#eresources-mail">Mailing Lists</a> chapter.</p>
</div>
</div>
<div class="sect3">
<h4 id="_ssh_host_keys">A.2.8. SSH host keys<a class="anchor" href="#_ssh_host_keys"></a></h4>
<div class="ulist">
<ul>
<li>
<p>gitrepo.FreeBSD.org host key fingerprints:</p>
<div class="ulist">
<ul>
<li>
<p>ECDSA key fingerprint is <code>SHA256:seWO5D27ySURcx4bknTNKlC1mgai0whP443PAKEvvZA</code></p>
</li>
<li>
<p>ED25519 key fingerprint is <code>SHA256:lNR6i4BEOaaUhmDHBA1WJsO7H3KtvjE2r5q4sOxtIWo</code></p>
</li>
<li>
<p>RSA key fingerprint is <code>SHA256:f453CUEFXEJAXlKeEHV+ajJfeEfx9MdKQUD7lIscnQI</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>git.FreeBSD.org host key fingerprints:</p>
<div class="ulist">
<ul>
<li>
<p>ECDSA key fingerprint is <code>SHA256:/UlirUAsGiitupxmtsn7f9b7zCWd0vCs4Yo/tpVWP9w</code></p>
</li>
<li>
<p>ED25519 key fingerprint is <code>SHA256:y1ljKrKMD3lDObRUG3xJ9gXwEIuqnh306tSyFd1tuZE</code></p>
</li>
<li>
<p>RSA key fingerprint is <code>SHA256:jBe6FQGoH4HjvrIVM23dcnLZk9kmpdezR/CvQzm7rJM</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>These are also published as SSHFP records in DNS.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="svn">A.3. Using Subversion<a class="anchor" href="#svn"></a></h3>
<div class="sect3">
<h4 id="svn-intro">A.3.1. Introduction<a class="anchor" href="#svn-intro"></a></h4>
<div class="paragraph">
<p>As of December 2020, FreeBSD uses git as the primary version control system for storing all of FreeBSD’s source code and documentation. Changes from the git repo on the <code>stable/11</code>, <code>stable/12</code> and related releng branches are exported to the Subversion repository. This export will continue through the life of these branches. From July 2012 to March 2021, FreeBSD used Subversion as the only version control system for storing all of FreeBSD’s Ports Collection. As of April 2021, FreeBSD uses git as the only version control system for storing all of FreeBSD’s Ports Collection.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Subversion is generally a developer tool. Users may prefer to use <code>freebsd-update</code> (<a href="./#updating-upgrading-freebsdupdate">“FreeBSD Update”</a>) to update the FreeBSD base system, and <code>git</code> (<a href="./#ports-using">“Using the Ports Collection”</a>) to update the FreeBSD Ports Collection. After March 2021, Subversion use is only for legacy branches (<code>stable/11</code> and <code>stable/12</code>).</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>This section demonstrates how to install Subversion on a FreeBSD system and use it to create a local copy of a FreeBSD repository. Additional information on the use of Subversion is included.</p>
</div>
</div>
<div class="sect3">
<h4 id="svn-svnlite">A.3.2. Svnlite<a class="anchor" href="#svn-svnlite"></a></h4>
<div class="paragraph">
<p>A lightweight version of Subversion is already installed on FreeBSD as <code>svnlite</code>. The port or package version of Subversion is only needed if the Python or Perl API is needed, or if a later version of Subversion is desired.</p>
</div>
<div class="paragraph">
<p>The only difference from normal Subversion use is that the command name is <code>svnlite</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="svn-install">A.3.3. Installation<a class="anchor" href="#svn-install"></a></h4>
<div class="paragraph">
<p>If <code>svnlite</code> is unavailable or the full version of Subversion is needed, then it must be installed.</p>
</div>
<div class="paragraph">
<p>Subversion can be installed from the Ports Collection:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># cd /usr/ports/devel/subversion</span>
<span class="c"># make install clean</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Subversion can also be installed as a package:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># pkg install subversion</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="svn-usage">A.3.4. Running Subversion<a class="anchor" href="#svn-usage"></a></h4>
<div class="paragraph">
<p>To fetch a clean copy of the sources into a local directory, use <code>svn</code>. The files in this directory are called a <em>local working copy</em>.</p>
</div>
<div class="admonitionblock warning">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Move or delete an existing destination directory before using <code>checkout</code> for the first time. Checkout over an existing non-<code>svn</code> directory can cause conflicts between the existing files and those brought in from the repository.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Subversion uses URLs to designate a repository, taking the form of <em>protocol://hostname/path</em>. The first component of the path is the FreeBSD repository to access. There are three different repositories, <code>base</code> for the FreeBSD base system source code, <code>ports</code> for the Ports Collection, and <code>doc</code> for documentation. For example, the URL <code><a href="https://svn.FreeBSD.org/base/head/" class="bare">https://svn.FreeBSD.org/base/head/</a></code> specifies the main branch of the src repository, using the <code>https</code> protocol.</p>
</div>
<div class="paragraph">
<p>A checkout from a given repository is performed with a command like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># svn checkout https://svn.FreeBSD.org/repository/branch lwcdir</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>where:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>repository</em> is one of the Project repositories: <code>base</code>, <code>ports</code>, or <code>doc</code>.</p>
</li>
<li>
<p><em>branch</em> depends on the repository used. <code>ports</code> and <code>doc</code> are mostly updated in the <code>head</code> branch, while <code>base</code> maintains the latest version of -CURRENT under <code>head</code> and the respective latest versions of the -STABLE branches under <code>stable/11</code> (11.<em>x</em>) and <code>stable/12</code> (12.<em>x</em>).</p>
</li>
<li>
<p><em>lwcdir</em> is the target directory where the contents of the specified branch should be placed. This is usually <span class="filename">/usr/ports</span> for <code>ports</code>, <span class="filename">/usr/src</span> for <code>base</code>, and <span class="filename">/usr/doc</span> for <code>doc</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This example checks out the Source Tree from the FreeBSD repository using the HTTPS protocol, placing the local working copy in <span class="filename">/usr/src</span>. If <span class="filename">/usr/src</span> is already present but was not created by <code>svn</code>, remember to rename or delete it before the checkout.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># svn checkout https://svn.FreeBSD.org/base/head /usr/src</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Because the initial checkout must download the full branch of the remote repository, it can take a while. Please be patient.</p>
</div>
<div class="paragraph">
<p>After the initial checkout, the local working copy can be updated by running:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># svn update lwcdir</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To update <span class="filename">/usr/src</span> created in the example above, use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># svn update /usr/src</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The update is much quicker than a checkout, only transferring files that have changed.</p>
</div>
<div class="paragraph">
<p>An alternate way of updating the local working copy after checkout is provided by the <span class="filename">Makefile</span> in the <span class="filename">/usr/ports</span>, <span class="filename">/usr/src</span>, and <span class="filename">/usr/doc</span> directories. Set <code>SVN_UPDATE</code> and use the <code>update</code> target. For example, to update <span class="filename">/usr/src</span>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="c"># cd /usr/src</span>
<span class="c"># make update SVN_UPDATE=yes</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="svn-mirrors">A.3.5. Subversion Mirror Sites<a class="anchor" href="#svn-mirrors"></a></h4>
<div class="paragraph">
<p>The FreeBSD Subversion repository is:</p>
</div>
<div class="literalblock programlisting">
<div class="content">
<pre>svn.FreeBSD.org</pre>
</div>
</div>
<div class="paragraph">
<p>This is a publicly accessible mirror network that uses GeoDNS to select an appropriate back end server. To view the FreeBSD Subversion repositories through a browser, use <a href="https://svnweb.FreeBSD.org/">https://svnweb.FreeBSD.org/</a>.</p>
</div>
<div class="paragraph">
<p>HTTPS is the preferred protocol, but the <span class="filename">security/ca_root_nss</span> package will need to be installed in order to automatically validate certificates.</p>
</div>
</div>
<div class="sect3">
<h4 id="_for_more_information_2">A.3.6. For More Information<a class="anchor" href="#_for_more_information_2"></a></h4>
<div class="paragraph">
<p>For other information about using Subversion, please see the &#34;Subversion Book&#34;, titled <a href="http://svnbook.red-bean.com/">Version Control with Subversion</a>, or the <a href="http://subversion.apache.org/docs/">Subversion Documentation</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mirrors-cdrom">A.4. CD and DVD Sets<a class="anchor" href="#mirrors-cdrom"></a></h3>
<div class="paragraph">
<p>FreeBSD CD and DVD sets are available from several online retailers:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>FreeBSD Mall, Inc. + 1164 Claremont Dr + Brentwood, CA + 94513 + USA + Phone: +1 925 240-6652 + Fax: +1 925 674-0821 + Email: <a href="mailto:info@freebsdmall.com">info@freebsdmall.com</a> + Website: <a href="https://www.freebsdmall.com" class="bare">https://www.freebsdmall.com</a></p>
</li>
<li>
<p>Getlinux + Website: <a href="https://www.getlinux.fr/" class="bare">https://www.getlinux.fr/</a></p>
</li>
<li>
<p>Dr. Hinner EDV + Schäftlarnstr. 10 // 4. Stock + D-81371 München + Germany + Phone: +49 171 417 544 6 + Email: <a href="mailto:infow@hinner.de">infow@hinner.de</a> + Website: <a href="http://www.hinner.de/linux/freebsd.html" class="bare">http://www.hinner.de/linux/freebsd.html</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="bibliography">附录 B: Bibliography<a class="anchor" href="#bibliography"></a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>While manual pages provide a definitive reference for individual pieces of the FreeBSD operating system, they seldom illustrate how to put the pieces together to make the whole operating system run smoothly. For this, there is no substitute for a good book or users&#39; manual on UNIX® system administration.</p>
</div>
<div class="sect2">
<h3 id="bibliography-freebsd">B.1. FreeBSD Bibliography<a class="anchor" href="#bibliography-freebsd"></a></h3>
<div class="ulist">
<ul>
<li>
<p><strong>Absolute FreeBSD: The Complete Guide To FreeBSD</strong>, Third Edition, published by <a href="https://nostarch.com/absfreebsd3">No Starch Press</a>, 2018. ISBN: 978-1593278922</p>
</li>
<li>
<p><strong>FreeBSD Mastery: Storage Essentials</strong>, published by <a href="https://www.tiltedwindmillpress.com/product/freebsd-mastery-storage-essentials/">Tilted Windmill Press</a>, 2014. ISBN: 978-1642350098</p>
</li>
<li>
<p><strong>FreeBSD Mastery: Specialty Filesystems</strong>, published by <a href="https://www.tiltedwindmillpress.com/product/fmspf/">Tilted Windmill Press</a>, 2015. ISBN: 978-1642350111</p>
</li>
<li>
<p><strong>FreeBSD Mastery: ZFS</strong>, published by <a href="https://www.tiltedwindmillpress.com/product/fmzfs/">Tilted Windmill Press</a>, 2015. ISBN: 978-1642350005</p>
</li>
<li>
<p><strong>FreeBSD Mastery: Advanced ZFS</strong>, published by <a href="https://www.tiltedwindmillpress.com/product/fmaz/">Tilted Windmill Press</a>, 2016. ISBN: 978-0692688687</p>
</li>
<li>
<p><strong>FreeBSD Mastery: Jails</strong>, published by <a href="https://www.tiltedwindmillpress.com/product/fmjail/">Tilted Windmill Press</a>, 2019. ISBN: 978-1642350241</p>
</li>
<li>
<p><strong>FreeBSD Device Drivers: A Guide for the Intrepid</strong>, published by <a href="https://nostarch.com/bsddrivers.htm">No Starch Press</a>, 2012. ISBN: 978-1593272043</p>
</li>
<li>
<p><strong>The Design And Implementation Of The Freebsd Operating System</strong>, Second Edition, published by <a href="https://www.pearson.com/store/p/design-and-implementation-of-the-freebsd-operating-system-the/P200000000463/9780321968975">Pearson Education, Inc.</a>, 2014. ISBN: 978-0321968975</p>
</li>
<li>
<p><strong>UNIX and Linux System Administration Handbook</strong>, Fifth Edition, published by <a href="https://www.pearson.com/en-us/subject-catalog/p/unix-and-linux-system-administration-handbook/P200000000513/9780137460359">Pearson Education, Inc.</a>, 2017. ISBN: 978-0134277554</p>
</li>
<li>
<p><strong>Designing BSD Rootkits</strong>, published by <a href="https://nostarch.com/rootkits.htm">No Starch Press</a>, 2007. ISBN: 978-1593271428</p>
</li>
<li>
<p><strong>FreeBSD Jails using VNETs</strong>, published in <a href="https://rderik.gumroad.com/l/uwOLZ">gumroad</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="bibliography-security">B.2. Security Reference<a class="anchor" href="#bibliography-security"></a></h3>
<div class="ulist">
<ul>
<li>
<p><strong>The Book of PF: A No-Nonsense Guide to the OpenBSD Firewall</strong>, Third Edition, published by <a href="https://nostarch.com/pf3">No Starch Press</a>, 2014. ISBN: 978-1593275891</p>
</li>
<li>
<p><strong>SSH Mastery: OpenSSH, PuTTY, Tunnels, and Keys</strong>, Second Edition, 2018. ISBN: 978-1642350029</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="bibliography-history">B.3. UNIX® History<a class="anchor" href="#bibliography-history"></a></h3>
<div class="ulist">
<ul>
<li>
<p>Lion, John <em>Lion’s Commentary on UNIX, 6th Ed. With Source Code</em>. ITP Media Group, 1996. ISBN 1573980137</p>
</li>
<li>
<p>Raymond, Eric S. <em>The New Hacker’s Dictionary, 3rd edition</em>. MIT Press, 1996. ISBN 0-262-68092-0. Also known as the <a href="http://www.catb.org/~esr/jargon/html/index.html">Jargon File</a></p>
</li>
<li>
<p>Salus, Peter H. <em>A quarter century of UNIX</em>. Addison-Wesley Publishing Company, Inc., 1994. ISBN 0-201-54777-5</p>
</li>
<li>
<p>Simon Garfinkel, Daniel Weise, Steven Strassmann. <em>The UNIX-HATERS Handbook</em>. IDG Books Worldwide, Inc., 1994. ISBN 1-56884-203-1. Out of print, but available <a href="http://www.simson.net/ref/ugh.pdf">online</a>.</p>
</li>
<li>
<p>Don Libes, Sandy Ressler <em>Life with UNIX</em> - special edition. Prentice-Hall, Inc., 1989. ISBN 0-13-536657-7</p>
</li>
<li>
<p><em>The BSD family tree</em>. <a href="https://cgit.freebsd.org/src/tree/share/misc/bsd-family-tree">https://cgit.freebsd.org/src/tree/share/misc/bsd-family-tree</a> or <a href="file://localhost/usr/share/misc/bsd-family-tree">/usr/share/misc/bsd-family-tree</a> on a FreeBSD machine.</p>
</li>
<li>
<p><em>Networked Computer Science Technical Reports Library</em>.</p>
</li>
<li>
<p><em>Old BSD releases from the Computer Systems Research group (CSRG)</em>. <a href="http://www.mckusick.com/csrg/">http://www.mckusick.com/csrg/</a>: The 4CD set covers all BSD versions from 1BSD to 4.4BSD and 4.4BSD-Lite2 (but not 2.11BSD, unfortunately). The last disk also holds the final sources plus the SCCS files.</p>
</li>
<li>
<p>Kernighan, Brian <em>Unix: A History and a Memoir</em>. Kindle Direct Publishing, 2020. ISBN 978-169597855-3</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="bibliography-journals">B.4. Periodicals, Journals, and Magazines<a class="anchor" href="#bibliography-journals"></a></h3>
<div class="ulist">
<ul>
<li>
<p><a href="https://www.admin-magazin.de/">Admin Magazin</a> (in German), published by Medialinx AG. ISSN: 2190-1066</p>
</li>
<li>
<p><a href="https://www.bsdnow.tv/">BSD Now - Video Podcast</a>, published by Jupiter Broadcasting LLC</p>
</li>
<li>
<p><a href="https://freebsdfoundation.org/our-work/journal/">FreeBSD Journal</a>, published by S&amp;W Publishing, sponsored by The FreeBSD Foundation. ISBN: 978-0-615-88479-0</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="eresources">附录 C: Resources on the Internet<a class="anchor" href="#eresources"></a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Development of FreeBSD is too rapid for print media to be practical for keeping people informed. For awareness of developments: electronic alternatives to print are best.</p>
</div>
<div class="paragraph">
<p>The FreeBSD user community provides much technical support — with forums, chat and email amongst the most popular and effective means of communication.</p>
</div>
<div class="paragraph">
<p>The most important points of contact are outlined below. The <a href="https://wiki.freebsd.org/Community">Community wiki area</a> may be more up-to-date.</p>
</div>
<div class="paragraph">
<p>Please make the {freebsd-doc} aware of any resource that is either redundant, or not yet listed below.</p>
</div>
<div class="sect2">
<h3 id="eresources-www">C.1. Websites<a class="anchor" href="#eresources-www"></a></h3>
<div class="ulist">
<ul>
<li>
<p>The <a href="https://forums.FreeBSD.org/">FreeBSD Forums</a> provide a web based discussion forum for FreeBSD questions and technical discussion.</p>
</li>
<li>
<p>The <a href="https://wiki.FreeBSD.org/">FreeBSD Wiki</a> provides various bits of information that hadn’t yet made it into the Handbook.</p>
</li>
<li>
<p>The <a href="https://docs.FreeBSD.org/">Documentation Portal</a> offers much more than the FreeBSD Handbook alone; there are more than forty books and articles.</p>
</li>
<li>
<p>The <a href="https://freebsdfoundation.org/our-work/journal/browser-based-edition/">FreeBSD Journal</a> is a free, professionally-edited, bi-monthly technical magazine released by <a href="https://freebsdfoundation.org">The FreeBSD Foundation</a>.</p>
</li>
<li>
<p>The <a href="http://www.youtube.com/bsdconferences">BSDConferences YouTube Channel</a> provides a collection of high quality videos from BSD conferences around the world. This is a great way to watch key developers give presentations about new work in FreeBSD.</p>
</li>
<li>
<p><a href="https://www.freebsd.org/status/">FreeBSD Status Reports</a> are released every three months and track progress of FreeBSD development.</p>
</li>
<li>
<p>There’s a <a href="https://www.reddit.com/r/freebsd/">FreeBSD-focused Reddit group</a> at r/freebsd.</p>
</li>
<li>
<p><a href="https://superuser.com/questions/tagged/freebsd">Super User</a> and <a href="https://serverfault.com/questions/tagged/freebsd">Server Fault</a>, the Stack Exchange services for system administrators.</p>
</li>
<li>
<p><a href="https://wiki.freebsd.org/Discord">FreeBSD Discord server</a>, a communications and community-building service, where FreeBSD community members can socialise, obtain support or support others, learn, contribute, collaborate, and stay up to date with all things FreeBSD-related.</p>
</li>
<li>
<p><a href="https://wiki.freebsd.org/IRC/Channels">IRC channels</a>, a widely implemented, technically mature, open standard text chat.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="eresources-mail">C.2. Mailing Lists<a class="anchor" href="#eresources-mail"></a></h3>
<div class="paragraph">
<p>The mailing lists are the most direct way of addressing questions or opening a technical discussion to a concentrated FreeBSD audience. There are a wide variety of lists on a number of different FreeBSD topics. Sending questions to the most appropriate mailing list will invariably assure a faster and more accurate response.</p>
</div>
<div class="paragraph">
<p>Technical list threads should remain technical.</p>
</div>
<div class="paragraph">
<p>All users and developers of FreeBSD should subscribe to the {freebsd-announce}.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>To test FreeBSD mailing list capabilities, aim for the {freebsd-test}. Please do not send test messages to any other list.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>When in doubt about what list to post a question to, see <a href="{freebsd-questions-article}">How to get best results from the FreeBSD-questions mailing list</a>.</p>
</div>
<div class="paragraph">
<p>Before posting to any list, please:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>learn about how to best use the mailing lists, such as how to help avoid frequently-repeated discussions, by reading the <a href="{mailing-list-faq}">Mailing List Frequently Asked Questions</a> (FAQ) document</p>
</li>
<li>
<p>search the archives, to tell whether someone else has already posted what you intend to post.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Archive search interfaces include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://lists.freebsd.org/search" class="bare">https://lists.freebsd.org/search</a> (FreeBSD, experimental)</p>
</li>
<li>
<p><a href="https://www.freebsd.org/search/" class="bare">https://www.freebsd.org/search/</a> (DuckDuckGo)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Note that this also means that messages sent to FreeBSD mailing lists are archived in perpetuity. When protecting privacy is a concern, consider using a disposable secondary email address and posting only public information.</p>
</div>
<div class="paragraph">
<p>FreeBSD-provided archives:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>do not present links as links</p>
</li>
<li>
<p>do not present inline images</p>
</li>
<li>
<p>do not present HTML content of HTML messages.</p>
</li>
</ul>
</div>
<div id="eresources-summary" class="paragraph">
<p>The FreeBSD public mailing lists can be consulted <a href="{mailing-lists-url}">here</a>.</p>
</div>
<div class="sect3">
<h4 id="eresources-subscribe">C.2.1. How to Subscribe or Unsubscribe<a class="anchor" href="#eresources-subscribe"></a></h4>
<div class="paragraph">
<p>At {mailing-lists-url}, click the name of a list to reveal its options.</p>
</div>
<div class="paragraph">
<p>To post, after subscribing, send mail to <code>listname@FreeBSD.org</code>. The message will be redistributed to list members.</p>
</div>
</div>
<div class="sect3">
<h4 id="eresources-charters">C.2.2. 列表基本规则<a class="anchor" href="#eresources-charters"></a></h4>
<div class="paragraph">
<p><em>All</em> FreeBSD mailing lists have certain basic rules which must be adhered to by anyone using them. Failure to comply with these guidelines will result in two (2) written warnings from the FreeBSD Postmaster <a href="mailto:postmaster@FreeBSD.org">postmaster@FreeBSD.org</a>, after which, on a third offense, the poster will removed from all FreeBSD mailing lists and filtered from further posting to them. We regret that such rules and measures are necessary at all, but today’s Internet is a pretty harsh environment, it would seem, and many fail to appreciate just how fragile some of its mechanisms are.</p>
</div>
<div class="paragraph">
<p>Rules of the road:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The topic of any posting should adhere to the basic description of the list it is posted to. If the list is about technical issues, the posting should contain technical discussion. Ongoing irrelevant chatter or flaming only detracts from the value of the mailing list for everyone on it and will not be tolerated. For free-form discussion on no particular topic, the {freebsd-chat} is freely available and should be used instead.</p>
</li>
<li>
<p>No posting should be made to more than 2 mailing lists, and only to 2 when a clear and obvious need to post to both lists exists. For most lists, there is already a great deal of subscriber overlap and except for the most esoteric mixes (say &#34;-stable &amp; -scsi&#34;), there really is no reason to post to more than one list at a time. If a message is received with multiple mailing lists on the <code>Cc</code> line, trim the <code>Cc</code> line before replying. <em>The person who replies is still responsible for cross-posting, no matter who the originator might have been.</em></p>
</li>
<li>
<p>Personal attacks and profanity (in the context of an argument) are not allowed, and that includes users and developers alike. Gross breaches of netiquette, like excerpting or reposting private mail when permission to do so was not and would not be forthcoming, are frowned upon but not specifically enforced.</p>
</li>
<li>
<p>Advertising of non-FreeBSD related products or services is strictly prohibited and will result in an immediate ban if it is clear that the offender is advertising by spam.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="eresources-mailfiltering">C.2.3. Filtering on the Mailing Lists<a class="anchor" href="#eresources-mailfiltering"></a></h4>
<div class="paragraph">
<p>The FreeBSD mailing lists are filtered in multiple ways to avoid the distribution of spam, viruses, and other unwanted emails. The filtering actions described in this section do not include all those used to protect the mailing lists.</p>
</div>
<div class="paragraph">
<p>Only certain types of attachments are allowed on the mailing lists. All attachments with a MIME content type not found in the list below will be stripped before an email is distributed on the mailing lists.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>application/octet-stream</p>
</li>
<li>
<p>application/pdf</p>
</li>
<li>
<p>application/pgp-signature</p>
</li>
<li>
<p>application/x-pkcs7-signature</p>
</li>
<li>
<p>message/rfc822</p>
</li>
<li>
<p>multipart/alternative</p>
</li>
<li>
<p>multipart/related</p>
</li>
<li>
<p>multipart/signed</p>
</li>
<li>
<p>text/html</p>
</li>
<li>
<p>text/plain</p>
</li>
<li>
<p>text/x-diff</p>
</li>
<li>
<p>text/x-patch</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Some of the mailing lists might allow attachments of other MIME content types, but the above list should be applicable for most of the mailing lists.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>If a multi-part message includes text/plain and text/html parts:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>addressees will receive both parts</p>
</li>
<li>
<p>lists.freebsd.org will present text/plain with an option to view original text (source, with raw HTML amongst the parts).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>如果 text/plain 不附带 text/html：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>there will be conversion from HTML to plain text.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="eresources-news">C.3. Usenet Newsgroups<a class="anchor" href="#eresources-news"></a></h3>
<div class="paragraph">
<p>In addition to two FreeBSD specific newsgroups, there are many others in which FreeBSD is discussed or are otherwise relevant to FreeBSD users.</p>
</div>
<div class="sect3">
<h4 id="_bsd_specific_newsgroups">C.3.1. BSD Specific Newsgroups<a class="anchor" href="#_bsd_specific_newsgroups"></a></h4>
<div class="ulist">
<ul>
<li>
<p><a href="news:comp.unix.bsd.freebsd.announce">comp.unix.bsd.freebsd.announce</a></p>
</li>
<li>
<p><a href="news:comp.unix.bsd.freebsd.misc">comp.unix.bsd.freebsd.misc</a></p>
</li>
<li>
<p><a href="news:de.comp.os.unix.bsd">de.comp.os.unix.bsd</a> (German)</p>
</li>
<li>
<p><a href="news:fr.comp.os.bsd">fr.comp.os.bsd</a> (French)</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_other_unix_newsgroups_of_interest">C.3.2. Other UNIX® Newsgroups of Interest<a class="anchor" href="#_other_unix_newsgroups_of_interest"></a></h4>
<div class="ulist">
<ul>
<li>
<p><a href="news:comp.unix">comp.unix</a></p>
</li>
<li>
<p><a href="news:comp.unix.questions">comp.unix.questions</a></p>
</li>
<li>
<p><a href="news:comp.unix.admin">comp.unix.admin</a></p>
</li>
<li>
<p><a href="news:comp.unix.programmer">comp.unix.programmer</a></p>
</li>
<li>
<p><a href="news:comp.unix.shell">comp.unix.shell</a></p>
</li>
<li>
<p><a href="news:comp.unix.misc">comp.unix.misc</a></p>
</li>
<li>
<p><a href="news:comp.unix.bsd">comp.unix.bsd</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_x_window_system">C.3.3. X Window System<a class="anchor" href="#_x_window_system"></a></h4>
<div class="ulist">
<ul>
<li>
<p><a href="news:comp.windows.x">comp.windows.x</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="pgpkeys">附录 D: OpenPGP Keys<a class="anchor" href="#pgpkeys"></a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>The OpenPGP keys of the <code>FreeBSD.org</code> officers are shown here. These keys can be used to verify a signature or send encrypted email to one of the officers. A full list of FreeBSD OpenPGP keys is available in the <a href="{pgpkeys}">PGP Keys</a> article. The complete keyring can be downloaded at <a href="https://docs.FreeBSD.org/pgpkeys/pgpkeys.txt">pgpkeyring.txt</a>.</p>
</div>
<div class="sect2">
<h3 id="pgpkeys-officers">D.1. Officers<a class="anchor" href="#pgpkeys-officers"></a></h3>
<div class="sect3">
<h4 id="_security_officer_name_security_officer_email">D.1.1. {security-officer-name} <code>&lt;{security-officer-email}&gt;</code><a class="anchor" href="#_security_officer_name_security_officer_email"></a></h4>
<div class="literalblock literal-block-margin">
<div class="content">
<pre>pub   rsa4096/D9AD2A18057474CB 2022-12-11 [C] [expires: 2026-01-24]
      Key fingerprint = 0BE3 3275 D74C 953C 79F8  1107 D9AD 2A18 0574 74CB
uid                            FreeBSD Security Officer &lt;security-officer@freebsd.org&gt;
sub   rsa4096/6E58DE901F001AEF 2022-12-11 [S] [expires: 2024-01-05]
sub   rsa4096/46DB26D62F6039B7 2022-12-11 [E] [expires: 2024-01-05]</pre>
</div>
</div>
<div class="literalblock literal-block-margin">
<div class="content">
<pre>-----BEGIN PGP PUBLIC KEY BLOCK-----

mQINBGOVdeUBEADHF5VGg1iPbACB+7lomX6aDytUf0k2k2Yc/Kp6lfYv7JKU+1nr
TcNF7Gt1YkajPSeWRKNZw/X94g4w5TEOHbJ6QQWx9g+N7RjEq75actQ/r2N5zY4S
ujfFTepbvgR55mLTxlxGKFBmNrfNbpHRyh4GwFRgPlxf5Jy9SB+0m54yFS4QlSd0
pIzO0CLkjHUFy/8S93oSK2zUkgok5gLWruBXom+8VC3OtBElkWswPkE1pKZvMQCv
VyM+7BS+MCFXSdZczDZZoEzpQJGhUYFsdg0KqlLv6z1rP+HsgUYKTkRpcrumDQV0
MMuCE4ECU6nFDDTnbR8Wn3LF5oTt0GtwS0nWf+nZ1SFTDURcSPR4Lp/PKjuDAkOS
P8BaruCNx1ItHSwcnXw0gS4+h8FjtWNZpsawtzjjgApcl+m9KP6dkBcbN+i1DHm6
NG6YQVtVWyN8aOKmoC/FEm1CWh1bv+ri9XOkF2EqT/ktbjbT1hFoFGBkS9/35y1G
3KKyWtwKcyF4OXcArl6sQwGgiYnZEG3sUMaGrwQovRtMf7le3cAYsMkXyiAnEufa
deuabYLD8qp9L/eNo+9aZmhJqQg4EQb+ePH7bGPNDZ+M5oGUwReX857FoWaPhs4L
dAKQ1YwASxdKKh8wnaamjIeZSGP5TCjurH7pADAIaB3/D+ZNl2a7od+C1wARAQAB
tDdGcmVlQlNEIFNlY3VyaXR5IE9mZmljZXIgPHNlY3VyaXR5LW9mZmljZXJAZnJl
ZWJzZC5vcmc+iQJSBBMBCgA8AhsBBAsJCAcEFQoJCAUWAgMBAAIeBQIXgBYhBAvj
MnXXTJU8efgRB9mtKhgFdHTLBQJjlXeQBQkF3u+rAAoJENmtKhgFdHTLOVoQALS3
cj7rqYkHiV4zDYrgPEp9O1kAyGI8VdfGAMkDVTqr+wP4v/o7LIUrgwZl5qxesVFB
VknFr0Wp5g9h0iAjasoI5sDd6tH2SmumhBHXFVdftzDQhrugxH6fWRhHs0SaFYCk
Qt5nFbcpUfWgtQ35XTbsL8iENdYpjKXsSFQrJneGSwxIjWYTFn6ps/AI3gwR8+Bn
OffEFdYugJ049O6Vu6YBFJHrnMO7NbF4v95dVYuLtpMIaXWM+V9KITmhaBzFz5fM
Q7UOzcLlbxOYKNIWcp8QQk429mayKW5VUeUExUD1ZzBHn+P6ZG7QTMDu/RmBqiHo
ewCMVz4n9uXT5BiOngE4CvS0WQwHzK+k9MLpG2u/Bo9+LT0Ceh9Ou1rfU5+0tRwl
GyOFFjf3INS7I7gkcAwxQ7dzDItN/UQPZpg8y9mABU2x4enz0AvTnb61d/1dnTEr
tdNgU433he0ZnD1HurZCjBEWC656wv6iMdWcD8gjhMbmEpPmjvXcYlTO6zhEygSM
DiwdQCWK2W4++YJerA6ULBi3niNWBpofOFH8XylV56ruhjtHCo7+/3carcMoPOJv
lVZ1zCKxLro3TRBT15JTFBGqblRyTopFK3PuxW//GTnZOtpQEOV6yL4RAXcWeC1d
1hb5k/YxUmRF6XsDNEH4b08T8ZO8dV3dAV43Wh1oiQEzBBABCAAdFiEEuyjUCzYO
7pNq7RVv5fe8y6O93fgFAmObXVYACgkQ5fe8y6O93fiBlwf/W8y1XXJIx1ZA3n6u
f7aS70rbP9KFPr4U0dixwKE/gbtIQ9ckeNXrDDWz0v0NCz4qS+33IPiJg1WcY3vR
W90e7QgAueCo5TdZPImPbCs42vadpa5byMXS4Pw+xyT+d/yp2oLKYbj3En4bg1GM
w71DezIjvV+e01UR++u1t9yZ8LOWM5Kumz1zyQLZDZ8qIKt1bBfpa+E0cEqtNQWu
iGhQE3AHI8eWV+jBkg5y2zHRIevbWb1UPsj43lgkFtAGHk9rrM8Rmgr4AXr531iD
srBwauKZ/MElcF3MINuLH+gkPPaFHw/YIpLRLaZXZVsw3Xi1RNXI2n2ea29dvs/C
Lcf1vYkCMwQQAQgAHRYhBPwOh4rlr+eIAo1jVdOXkvSep+XCBQJjm14FAAoJENOX
kvSep+XC0DcP/1ZB7k9p1T+9QbbZZE1PJiHby3815ccH3XKexbNmmakHIn3L6Cet
F891Kqt9ssbhFRMNtyZ/k/8y8Hv5bKxVep5/HMyK+8aqfDFN0WMrqZh0/CiR6DJh
gnAmPNw/hAVHMHaYGII9kCrFfPFJ02FKoc81g9F08odb7TV+UlvRjkErhRxF+dGS
wQoO0RCbf0Z1cs7nd0Vb2z4IJh4XMxBjWc/uQ2Q9dH/0uRzwpAnR4YX+MG5YrX7Z
zBvDyR0r76iQwRSDKgioNgkr6R3rq1NZGdaj+8b0LzdOqtzKJ/eupDe3+H67e/EN
qymtreGjrubpiU9bKvYArisUqhE5KtguryvR6Qz9bj87nPg33DT3WWGVrwFRxBox
dbWzjQFv0wug8m4GAwVF7fPR5/eW7IHw8zvgn0vSPcZz7MZ4e6Y5jN4kA5/xWJYZ
Sps54qQWB+FA30unIXN68KqdIzONIbtaY3W4/JjJUCm4T+wEjKaH+wJX8w1DMjlg
mkTmGh/UrTyC1vXbPgk9Sy3cRTICR1T9z7W8UlmTtnKrUklrjlFR7SXzrEXzLGOX
Fm+NEHpHNXqzcm6c3QfzY/yQ9HSAQ/t7SUQ9caRePbDz3/msyPxtGFor9roQv6VN
wRXCyRgkH4Y5tPhJAQ8G/FxX+VXFb93QL0lfelb23/BBu6cUwW63SRn5uQINBGOV
dskBEADqo8z6TFAhrvHhJV5wHdj67guoYvpXP8gvdCqos8SLluqi0AWgJEwlqu7L
mKQ6qMoJ+2DN6y+dEtvOVgBAgF63LLf3FQKq9FB/3uqeIiQlCIl3H43f8KttEZzf
/lbry4Y6QhS2OXM31Ut9Q+1IfTGwvs1E8/J1U4jQrAGqNKknXyQyMweJ0jvvcSLJ
nv3S7COUJVOT3cTgVeh3RIQlFzqK2rSQmygDpS8bT8MjCsZr+KGezKpbddKXio4a
QW/e6nCMyYR8bo0GQ9DpsyAOsaENnkghncQhA7GdPZK9xLMNQMCp0OdcZlqRVjRZ
OutuzNW6PPoczs/NQq02YWK4BPtSV7+ldS9gPZTLIpnRNQRzcnA0vnQTqSAfasVw
sAGm+MpH7zcaMf2Tw1K08u7+5gyObgzUzQmGLCgo9VIncnDis0s4gfTmtrr5jCeV
7LYDQX+2fApMtXbVXeKJem1PS+Z6LPbW2HklxYuG5nFgewCYlQjKujfiwW1Clhi4
JQeE1Naobbaar99V/VeoHrOYAEWP0bkUyrFcocLJ+0g3KpjSkctIptgGGpMBKe4U
9O7pWoTki8Yz/uYQn/p0iZcG8SfKM8I4283jdsi5SUiNNJJZCBQTVA7d8MxUVv5+
qpX/v5XqYM3pHza2DLXzwfAE9O2dgN1OMZYIld+OnWcpm2PxIwARAQABiQRyBBgB
CgAmFiEEC+MydddMlTx5+BEH2a0qGAV0dMsFAmOVdskCGwIFCQICKQACQAkQ2a0q
GAV0dMvBdCAEGQEKAB0WIQS2FSd+gQh991yBgztuWN6QHwAa7wUCY5V2yQAKCRBu
WN6QHwAa77gbEADpUBT14cesITuMsOWYsyEtNmB4UlTFWCktk/YzyCotasZxIhMP
Xih9G1tDo9ExIWT8jNjSSA+w0Viua/PirDLvI8JtX1JiK3nwMenwlXwlkRAk9TJW
y944YegHF/5ytntwZ/L4BMYc3MztyZbw+sDwnNBZKYmO8gwfYobtfoGxOR4Onb37
bbUVw62xHQIn2zafSmMQ4oMXZTm9EteIYwgcrC1h+Urv5IXCJZHrqmXCPE5g5XZ1
G9jqkwlaRYWjcLD0qxwc5m9LNrF6OBS9N6S7DncIYt9VupI5OCr1uRSqzqaBMFDC
lTTH+dAx3b6J1KFB0UiHP3FeTalFh8L3NE+dN9apNAgkUWv/v4oo/6dkRu3NZse2
RAo/o2X5r40qk/lhydQRZTSTFsiuH3VUWVsgmqAHnHW7pMMw8FAlKhyRSFnhbW7r
e0jj8XMIO7G5yjQKQCnYuPdXbx++bP1PzsEWDv9j/sph5arcosdo6tEXklWHED17
MEPIton1+NRfsU0peEVggQXlwdTcZN/h7FeCZ56dcwCWdCpSlv6CcWzRXSNUyJpK
a9qfIqBX/monjy7w5IHmhvLwAYI6IoT11h1QDEfGfhrwWPwOjnXsaYm5E7wv8w69
PxMbOJbMpWSg8L7xW3LXKR1VwXggUC1+b3y67E5Ggi1hf0lfTnTMpL2ClO2QD/oC
hMIafhzxbjh2WzgYahVHZH3gpHc1/0Bnc07s9+Pa6EYYM9r0XzezLW7bswOjVloR
FreQ3FIF/2OSN0OGdm7dyYl0OliTIDDDlwK/l8bcckUcpHNR1dw0P3KvDlmLmzZy
G4HmzzSBa9jiFirEfcg2rnGc6Zi382jGVALuYVplPXyMOUiChp0AAQZzTIYpXw/g
pBE6em2k740yuK6WqG4yXXgk67FoH10TQvMd4Q73K4zw+9DMpThlUHcfBmAoViZw
il7C0xl+ysHX8ZI3JU8s1r3XAnpqdHi4Wpixm/ctXbVnTSA3FQr2SctJYqR1VHRW
GMW+Ii2SQDS+t9bZTzOgAPLDtfy+JqhBpwCB1a1EHftkJEojpfZipaYGkf3yc+vN
wUeUHp/csF9CT7Qbqaj1t7fVWzv7jcVKpRwngIT4vTSzqbo6WC34FuUAH0t7tJ5K
eZ625AqEFLmtqtDo+ydJhZrVrXBNXPfkx5hSVW/I9hvckMNwA3t0KfQC2sz+Z1Q1
a4vDWQYRytfyrgZkWGbXMn6l1JyqIolgJZuax2kYs7Vu3t8KptqCbv0ZBAGoMm7r
RLgVodhI9voA8YxCirSChrueJYn+JKk8MIyk3DdXpBoocMIAjFJAUgXjV5NQpZMy
xR8BEiQnBcHRIKVWEEyhbLtHpmCEsnKNyKVGoxs31LkCDQRjlXcHARAAykVVzNmj
1k82yBbv3VRbmjrCeud3Wcg75LitzfurZMTPwoYcK7Gjk3B99na3oufTgEjniltq
mDXtvtrSE+RrfscWQvbyfhXIx3HQKwCbdAR9Sx0rrHApXZK5xh5VytXW6lw3g91c
Puy7Ujv8DgJZcUkbTjvMnRnz2UlmJASICruCG8SiKcLSyb7Rrpqj+hyoKBYIozXI
I87LMleV5Gu/b1JGdjOIxH6rZTTH3GD1eXoYzBSYXBslz2c5FW8sft9tTr927wSC
gBiuCUU4Vkb9NKiVIZZFIyJq/PQlIP+L6sQ3hohPhZ8F74v1bLUCas3GIA77MqbM
dC7clLEOdyv7L6Fx35bSCrDXQWgj2NYtwvuRH7prSI6O4lJdKimraXcNp+I/G0IW
avgIZCHMEczp7j+/8013cXRelVsnpFCmHuWR+9/PyraW9SUeF7MnSnXFeaF9/0Ie
N1UyGYCbPn6KYEBeTaai2018pvSkUR6fXFjcr9Q8DiD6g+xKPj3kyy8iD14gwJwL
f/PRIRQxYf+y3LInM+p+nJ8bBl5NwiP2+Daj5Gca+ZwtVgD8QZOg+T3TmS/9wrve
jLxtnI4HTMyDtP09paAtQ7SyqOqjQzDeScXJKDehFeVyKU9C9891fQm/Aulz0NaW
vX7UaQJcnTyVa6Alz3oIlC6kpFvUhsLShRcAEQEAAYkCPAQYAQoAJhYhBAvjMnXX
TJU8efgRB9mtKhgFdHTLBQJjlXcHAhsMBQkCAikAAAoJENmtKhgFdHTLDC0P/AgO
YRwd0WXIVFOiZQGNt4ra7NxkiGSSAvnyVzrdQ+V7mInYUG+ZhL7StBLnexUSxxyf
kp+Q7BOvIqWW9ZuXQjO6Kp9rDEAtx9al9kkfNMxKcMd+Be847IUxCu6pEMAcCvs8
0LQKdtPSwQXZkXNp3wz18uq2RdTHiaAQI0YngJWqDvkpjy5TO/8GZHAR/nzsVPn+
IAh53kyMUHZUUNf0YAFy9NNsfEJkjGfGXdyzXlLFPSUCh9na55TqRZhZlJcV5oQz
/jKY8nCzaaZXQCRsmCEtcKf0zHedfo1Nln0dqtuu75HNbf8eDcNl3Qn2+Sjw9p8/
SXU1a2DJfvgKq9OCPNPFdOeqtFfNxzMrt+FwLa7iLSms+1ddzLKLtLCmguKRpkIs
UWFSY7H6ZLlOO2AXIVkE3Gc7uIDCTN9xNwL2w+hZoWaJB/qrkQhjMb5ZCmdyPzSb
GXcdY4/qgWP+FklFix4p4yS8nMtOjzusV0zoKwysvARNHp75pYzRu08WKXWtdUAI
06OzLRvFNXw4kR/LGdibKO+cG8HSR2JpUQN1WHGBKrMsBfiaBdrj39Xoz+7Myv6f
f8DUl2ThXp9WbxLlwUhfGhRq3dwHjEZpP05YPejU0+vp5L1WjQSwmVGXzVIbrx9L
5C2TZ9fbtPrxgbgBrfMx9nFSxW4Uu1O5BtEL58mk
=tw96
-----END PGP PUBLIC KEY BLOCK-----</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_core_secretary_name_core_secretaryfreebsd_org">D.1.2. {core-secretary-name} <code>&lt;<a href="mailto:core-secretary@FreeBSD.org">core-secretary@FreeBSD.org</a>&gt;</code><a class="anchor" href="#_core_secretary_name_core_secretaryfreebsd_org"></a></h4>
<div class="literalblock literal-block-margin">
<div class="content">
<pre>pub   rsa4096/BE3DF7A86914D607 2022-07-29 [SC] [expires: 2024-07-28]
      Key fingerprint = E0C0 73CF 01A2 A902 800C  3680 BE3D F7A8 6914 D607
uid                            FreeBSD Core Team Secretary &lt;core-secretary@freebsd.org&gt;
sub   rsa4096/7882C7A2CA320B52 2022-07-29 [E] [expires: 2024-07-28]
      Key fingerprint = 7828 1422 F522 802B 00AE  0410 7882 C7A2 CA32 0B52</pre>
</div>
</div>
<div class="literalblock literal-block-margin">
<div class="content">
<pre>-----BEGIN PGP PUBLIC KEY BLOCK-----

mQINBGLkULYBEACsS9RbAv8gIyZWtIWgBeK6+ircHRW0LsetvHqQYlY6gfRWDLN+
467o0dHwAz4c1jyq7Or+1gy2Kr2VpcPZr1kjNTx5NbvoybQJMIMs77o9LS3Q2pA0
3Dpi8LSaM77rCmIXFmKEspbuPyjjTjKUtpOmzvwMDq8ke7ZHrqkJOessKQVGUSJc
o+4hcN6S4gGRgzRHLOuPtDqIfxFuHjr+4ZEGeispJHZqtl+HwBOEdoG966hKo/Ae
eyIRMB1vioqf8GHuiVHZ3YJbbcLN/4oMMtN/aIgucfspKo2O95zUETkimGTBlEl0
RVFXF5kq3gq2p7+7Sl3OQ3Kw8LQ9ueinWNJ5/3X06UowsRbOxtx7Jtp4DFwhpHj/
LTdEUSjiVzeZKiqDOqvgjq2ZN4hLHEZYan3mv55AUnwzwzMD04P42mNHetCJnuNP
ZGGL/wmABc8X4tx/fGddECKBzCM8hHBG7WQkDUnMTpODhBXCcC+rm6Vz7FS1zv67
CftMneqWnDDZtf/XclnHI6iOJZPcY/ljV+QxGs+oLvn2mlR6xzHu9osYfGuozA6x
PIxrSgB7PWFSuSvqtN7fSwAiXOAI5zFpZ4HP8wjFt7SWfMaovc/FR8rzYaZSZYAk
0l+FmsMbBGvkHNdPyk/4CWqj3dg4HCFAeqUWVLo3qKHdTOQaTqavyYYBCwARAQAB
tDhGcmVlQlNEIENvcmUgVGVhbSBTZWNyZXRhcnkgPGNvcmUtc2VjcmV0YXJ5QGZy
ZWVic2Qub3JnPokCVAQTAQoAPhYhBODAc88BoqkCgAw2gL4996hpFNYHBQJi5FC2
AhsDBQkDwmcABQsJCAcDBRUKCQgLBRYDAgEAAh4FAheAAAoJEL4996hpFNYHPRwP
/R5lWY8RcsAxAwXqzCRww1N2D6aRVUK+wJfxlMYRFjT9o0phmlSQxhORJATbjLm3
prLkpFBsMOScDmG7kWttPSHoQFKBiA7IznVeT4hka9c3Id21EL54GEjjDyp6AFev
G5kNCu8vS6SxmyUD9U2Q7PiEiEq7907tfydJfJ5BEzS5Az6KTOITaZ716qxQVQFR
6i6ChMCBABT059QngTiRp0sY2TPzTepHxEyrE//8M0mgyBsaRWPQP712sVujjx82
/3fXMxKwnJTGRhy0qR+DbIeSK/OiU4OJISG1XG/IkAQEqPwG6UilXy60l5PectJD
FAGRgky/Jmh9QTL4lhFLmpEyQhjVOZANZ1lqfD6lEjsf/Adr3stcKLNMLT8xewKo
LrFzSWMXh35HsSM/ZJng9CiJlAckGNBwuYp+5z49vBWaUXj9/KzK+0uKO6OspDIG
sF7M33BOqOP48ssIZWdJihwMA8qSX+ZFq+yMn8YdPmszXcEe4H4U1curdGWMm7IF
DwUl9cMEfYiPhvuO5taJBDerEbynyMI6oYbFnfl3Bb4rknlatiCzKXrzR1OuRtho
RkAPVSnEru0FTgCHToRdj81qyAwa6VMsEtVvqhNtsWBvr8W9Bdj1zZUV0hCJOzZN
UfAmlRXkud8lK4UyxBHUrNSy4ufGRjMNOhuUmBZVwrTSiQIzBBABCgAdFiEES2Tp
4L3ps+zAa1xm2MjIO0nybxcFAmLkVMoACgkQ2MjIO0nybxdeBBAAhCqcnsVVUpL6
w9CQV71kkSoT0649GkbWeG+ob1XgXvjxCSRb7mxSx7KCiUkLtnzVUOe+qp15pbAm
o9zlHZ/yQQxA3pUX5npIIiWXSWknA3DGNKE52RJ1tbpIVhFjrseXa4gsrxrUVtCF
dHsCFl/G6Zr1h+OutL6DHxQH0ZI2OmxRQFxE0Bwjyx3HdLmtKCEZVYUuhMoCya9m
5Uu98nQOMH7jDMbj8za7JJiwZwjKNZfiNck8Ekq0DEXr3CKSueobHr3JqSLt9VKV
WzaGKDQ/sVQz4L7GZfR1yMAJQlWulsTvxGG4SWxnFsus9GNydQIEmkTfDLmBXkl4
PNNsTirNir3ld7KEIY07jffqK88uV3nZ+Cc2VUdM4GRddH4LdJnKyY+O8AXrEAse
9aUmWGmesbOSAV0ATLGfFM96eFuGMdgwxl25W3RxKlLABAdLRd5smW5RCDOSyrqZ
0F3mpqCGMG84Us93/G5hdYsULuJxlufMur4SO5kRp6h/+tuDR1TAzkAoHut16ODD
fnto8OhmLk1W3yfddh8i5e5jBU1NZkmHSYOKhs0iBcSBR0t594E3xNCUQYNZswlZ
rVNCL7o1HEuln0p+qrcOVWqQ9ovb4mE5qupRydr4+moxmJy6y5bQp3QaIxentHnY
1aq8A8o2OV8sFNbH70p7+fB+W1HeviS5Ag0EYuRQtgEQAMT6Pik/xPzARb/UjjVS
Wvo7AQjtLC3yKNg1yAey3T0gp6YKYs5vlMJckS48LDZagiqgcDucly52nk2sMWqu
+yllgBLrwm+SY4g7hqrDgXrOspZUyLysKB5fyF60qOGcjfmZgAFPh8MN4Zym/tD1
3dThrSsBJJ9jrX8OCBLlV5sXbbpx6jwtLe4wzeJOfMctW+U3U6zmJw8ZOYU7cG/M
5xSh1s9W1iju4DXo63gOtnyYad27BexHu19e/nAwxQwLaofDX9R9Y0pORFHI1SuO
IrQIHXhwgZHVRBNulPtM2zVVN1jWC5X9YLu4rc/F01BO0B4GQosYtlmcK7Rm7obx
Dm+o0pPw3xyFnl1vOXWsmRDUP6qATk3YKuHdYRe33SxFPm7iWEB+rVL41dqquMRO
L7HIt9ho9MWTac2a9jHIX17xK9Q/P/zy6ZLjwtcyirPezct4GWvIPJ+mdrmI39nn
Y/TFcBZ3G0BtwasFnuFjHbkjcBlqvtHc1Zg/hISaEDTbSDr0TMLpxG2OpT5xqMkq
PO8S04IpMtKWd1aRliv9vE65UHAGHVe8EOVmGT7Tk9cCqFxrxpwE8n+KU5JGUGTc
BnpuCedT3txnZZc90d/+yMotJPpLUmOdndj782Y4B5y5JXpTefvxN2lBOorVN1xu
zH43SkAA7lvuN0x4QpmzWJoLABEBAAGJAjwEGAEKACYWIQTgwHPPAaKpAoAMNoC+
PfeoaRTWBwUCYuRQtgIbDAUJA8JnAAAKCRC+PfeoaRTWB/RdD/94yvoMl/VtJqTR
Lc7Qu41y/SdczDAfCGPts49uu56xRqCfcLZOLr4PNXh49x0UWFroTcpcFlcsS++D
EOoR2DoyxB1+KKRhceBo1CmQ8Y7RQ0LpQzYPkqBmzVEZK/I5dKf+RX83E7sa5L28
UpCrsDSsp7dVrxmwdiiOsJBD1vA5vIGgtgTGewMNmPO4wbhmjFTIxPnSND6wRYyW
SBgKkEz5lnA6zHOMYiXabKI/oY23xq4YRu2UOVoZMUkXoqR09McwrqMI4+XJBSwC
c2G6FI4uEO6YIDGXlUZhCGDGwE+HVcP6/jshyi1HOtUpcemle//YSvyrp6N/8XkZ
RX/dvUNIBl+ykIE/wb75PWI7QTNLWkJmCU/ft9m1KEHAwccyxHJxXWurnBbMgMan
VfLYH4uJ0eH/O65zTIzRdZcMO4kY1vVllAKXY9Httxpdua0n+4rHplxL4ZfRL7Y4
5h7/Xiz5xfGcYxPd5/ezfYzcvfDr4danX8fBe7U9F2VaO/QOhcgCLV8TevR1Ku/0
GUOfPAH6rhZaLqqz92Y2hOX1QQ6MabB92DUFZh+5SUxCzqI6cAiH60Rbf9ZI579s
L32GpxZ6BPISnsy69SNAVBiczw8EthEY1KhdN9QOuHppqcGsOlIz8cKVojqzILwj
GT6wtOZXl/ri7I8x3Fr89V3sUvmg1w==
=2Il1
-----END PGP PUBLIC KEY BLOCK-----</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_portmgr_secretary_name_portmgr_secretary_email">D.1.3. {portmgr-secretary-name} <code>&lt;{portmgr-secretary-email}&gt;</code><a class="anchor" href="#_portmgr_secretary_name_portmgr_secretary_email"></a></h4>
<div class="literalblock literal-block-margin">
<div class="content">
<pre>pub   ed25519/E3C401F60D709D59 2023-03-06 [SC] [expires: 2027-03-05]
      Key fingerprint = BED4 A1D3 6555 B681 2E9F  ABDA E3C4 01F6 0D70 9D59
uid                            FreeBSD Ports Management Team Secretary &lt;portmgr-secretary@FreeBSD.org&gt;
sub   cv25519/2C92B55E27A641C3 2023-03-06 [E] [expires: 2027-03-05]</pre>
</div>
</div>
<div class="literalblock literal-block-margin">
<div class="content">
<pre>-----BEGIN PGP PUBLIC KEY BLOCK-----

mDMEZAXJvxYJKwYBBAHaRw8BAQdASFAC20WL3R1T6uNyGMZbfJCxDkcP4C5vi3Op
tcZ2fbq0R0ZyZWVCU0QgUG9ydHMgTWFuYWdlbWVudCBUZWFtIFNlY3JldGFyeSA8
cG9ydG1nci1zZWNyZXRhcnlARnJlZUJTRC5vcmc+iJYEExYKAD4WIQS+1KHTZVW2
gS6fq9rjxAH2DXCdWQUCZAXJvwIbAwUJB4TOAAULCQgHAwUVCgkICwUWAwIBAAIe
BQIXgAAKCRDjxAH2DXCdWYN1AP43TjyfZtZ3DLYT++g0+SuPsoO/3yWVybA+UmFL
zb8MngEA+LLNUfvEwCuXS/soh+ww5bpfmi3UUmeGiQEAXug3iA+JATMEEAEKAB0W
IQT7N0XIbxXo7ayBMvzYKU7Du8TX1QUCZAXLkwAKCRDYKU7Du8TX1XHMB/9R1MX4
6zMgpKqPPt76GOI+eGEdBK6bY8aJZjQGdqTh9f6VtXVoTGIG7cvhc9X8tDBoB0PT
2KZWheF51AV1+NHU4HwLAQ1BMebrFvWSfkw4xg4fBGwDhz9/GN85No+Js772V5ey
8lRiL6meRVWxMlLyWcxGd8JjcC5yX/iAUQ3SBGCLqW7unWjjg7CTd+AMBwcqPGrv
ax8q6eFVguJcHJAjMnKf6HAy4cpK3s+uMoUBCGnszSN12B3ysKfyC4pNO/pix5tA
Q5v8aRqTeFPh5zmNhWo0KGPzplTPqRQSHDl7GDQC8Ru3MhzFkeWzHsexjZVwS6W2
DPcYpuuAsA0XOZIZiQIzBBABCgAdFiEEEBpxaxYrAOVb7eoFrbv4YQo3ibcFAmQF
0u0ACgkQrbv4YQo3ibccwg/9F2Xuic3nhKxRbB3mJeDo6SYQETa/Gh1qQ34+8zlt
8UMazOx67gnYQfy+pXjro6eQ2up0a4eUYezcNOudqAQD21nRz3HA6EQVNcE/TzEA
xl5CJntTaLOt7S+EDXFW5BuQIvhhoMGgm8+WNVgA0EJ7tfL0OcYBSvr19fqwChEn
9c14cSk6mgHSsleP5NvskYN053pxHwy0LTSb8YBBv52th37t/CRFC1363rS5q+D7
JixFopd1O5pKpA5ipvE4gGgRjPtwjx0SjjepwK/3fuhEJQQyKzTIKlMfu2Dj/iR2
Li1Sfccau5LQXOj9fUITU3u1YG7yrm8VGzT7ao4d+KRwgMLjd2pLqiGIbbJwGBiP
FRmtilWQoeIlmSlFX4obAA517DOK0pW1mH8+eEn4EJd3SekT3yzFyKTASv0J48Z8
3F928xg+eZvHxVC0t1J+J5IG0gt3EEncuWKIPQGR7PiQbti6R3FQVTz6WfMWOebP
Qi0E9F/Aqakr6Vj2sKGrDq+ebpaF5G8Yw1YrUl2IDiPzkCegp3ZbI0wh11Xvzhi8
LXPQGK4jBQas4G8cegfitzmtdGRHYrbMv0R9I4mvaL+WlOuD2AvyVG28lguqVhnN
AZP+ohdquYyX2CNCVvbKWAtXo6Ur0vWG8BL8m6defAtEkIwVBALaOHQOSI3aNUz4
lwy4OARkBcm/EgorBgEEAZdVAQUBAQdAsefmSfxEOdOr02+K/6noYCuJ1FeAWVz6
jFYQ+9w6jggDAQgHiH4EGBYKACYWIQS+1KHTZVW2gS6fq9rjxAH2DXCdWQUCZAXJ
vwIbDAUJB4TOAAAKCRDjxAH2DXCdWRl4AP9h5ot212BK29S6ZcMBhHvmtF5PG1oD
c7LnZycSRmbFiwEAndCMpAGOhDW8iVgDd0wLQq/ZMPe+xccfG1b3zFH2EgE=
=iiAT
-----END PGP PUBLIC KEY BLOCK-----</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_doceng_secretaryfreebsd_org">D.1.4. <code>&lt;<a href="mailto:doceng-secretary@FreeBSD.org">doceng-secretary@FreeBSD.org</a>&gt;</code><a class="anchor" href="#_doceng_secretaryfreebsd_org"></a></h4>
<div class="literalblock literal-block-margin">
<div class="content">
<pre>pub   rsa2048/E1C03580AEB45E58 2019-10-31 [SC] [expires: 2022-10-30]
      Key fingerprint = F24D 7B32 B864 625E 5541  A0E4 E1C0 3580 AEB4 5E58
uid                            FreeBSD Doceng Team Secretary &lt;doceng-secretary@freebsd.org&gt;
sub   rsa2048/9EA8D713509472FC 2019-10-31 [E] [expires: 2022-10-30]</pre>
</div>
</div>
<div class="literalblock literal-block-margin">
<div class="content">
<pre>-----BEGIN PGP PUBLIC KEY BLOCK-----

mQENBF27FFcBCADeoSsIgyQUY8vREwkTikwFFlNg31MVy5s/Nq1cNK1PRfRMnprS
yfB62KqbYuz16bmQKaA9zHN4FGfiTvR6tl66LVHm1s/5HPiLv8sP14GsruLro9zN
v72dO7a9i68bMw+jarPOnu9dGiDFEI0dACOkdCGEYKEUapQeNpmWRrQ46BeXyFwF
JcNx76bJJUkwk6fWC0W63D762e6lCEX6ndoaPjjLBnFvtx13heNGUc8RukBwe2mA
U5pSGHj47J05bdWiRSwZaXa8PcW+20zTWaP755w7zWe4h60GANY7OsT9nuOqsioJ
QonxTrJuZweKRV8fNQ1EfDws3HZr7/7iXvO3ABEBAAG0PEZyZWVCU0QgRG9jZW5n
IFRlYW0gU2VjcmV0YXJ5IDxkb2Nlbmctc2VjcmV0YXJ5QGZyZWVic2Qub3JnPokB
VAQTAQoAPhYhBPJNezK4ZGJeVUGg5OHANYCutF5YBQJduxRXAhsDBQkFo5qABQsJ
CAcDBRUKCQgLBRYDAgEAAh4BAheAAAoJEOHANYCutF5YB2IIALw+EPYmOz9qlqIn
oTFmk/5MrcdzC5iLEfxubbF6TopDWsWPiOh5mAuvfEmROSGf6ctvdYe9UtQV3VNY
KeeyskeFrIBOFo2KG/dFqKPAWef6IfhbW3HWDWo5uOBg01jHzQ/pB1n6SMKiXfsM
idL9wN+UQKxF3Y7S/bVrZTV0isRUolO9+8kQeSYT/NMojVM0H2fWrTP/TaNEW4fY
JBDAl5hsktzdl8sdbNqdC0GiX3xb4GvgVzGGQELagsxjfuXk6PfOyn6Wx2d+yRcI
FrKojmhihBp5VGFQkntBIXQkaW0xhW+WBGxwXdaAl0drQlZ3W+edgdOl705x73kf
Uw3Fh2a5AQ0EXbsUVwEIANEPAsltM4vFj2pi5xEuHEcZIrIX/ZJhoaBtZkqvkB+H
4pu3/eQHK5hg0Dw12ugffPMz8mi57iGNI9TXd8ZYMJxAdvEZSDHCKZTX9G+FcxWa
/AzKNiG25uSISzz7rMB/lV1gofCdGtpHFRFTiNxFcoacugTdlYDiscgJZMJSg/hC
GXBdEKXR5WRAgAGandcL8llCToOt1lZEOkd5vJM861w6evgDhAZ2HGhRuG8/NDxG
r4UtlnYGUCFof/Q4oPNbDJzmZXF+8OQyTNcEpVD3leEOWG1Uv5XWS2XKVHcHZZ++
ISo/B5Q6Oi3SJFCVV9f+g09YF+PgfP/mVMBgif2fT20AEQEAAYkBPAQYAQoAJhYh
BPJNezK4ZGJeVUGg5OHANYCutF5YBQJduxRXAhsMBQkFo5qAAAoJEOHANYCutF5Y
kecIAMTh2VHQqjXHTszQMsy3NjiTVVITI3z+pzY0u2EYmLytXQ2pZMzLHMcklmub
5po0X4EvL6bZiJcLMI2mSrOs0Gp8P3hyMI40IkqoLMp7VA2LFlPgIJ7K5W4oVwf8
khY6lw7qg2l69APm/MM3xAyiL4p6MU8tpvWg5AncZ6lxyy27rxVflzEtCrKQuG/a
oVaOlMjH3uxvOK6IIxlhvWD0nKs/e2h2HIAZ+ILE6ytS5ZEg2GXuigoQZdEnv71L
xyvE9JANwGZLkDxnS5pgN2ikfkQYlFpJEkrNTQleCOHIIIp8vgJngEaP51xOIbQM
CiG/y3cmKQ/ZfH7BBvlZVtZKQsI=
=MQKT
-----END PGP PUBLIC KEY BLOCK-----</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="freebsd-glossary">FreeBSD Glossary<a class="anchor" href="#freebsd-glossary"></a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>This glossary contains terms and acronyms used within the FreeBSD community and documentation.</p>
</div>
<h3 id="_a" class="discrete">A</h3>
<div class="dlist">
<dl>
<dt class="hdlist1">ACL</dt>
<dd>
<p>See <a href="#acl-glossary">Access Control List</a>.</p>
</dd>
<dt class="hdlist1">ACPI</dt>
<dd>
<p>See <a href="#acpi-glossary">Advanced Configuration and Power Interface</a>.</p>
</dd>
<dt class="hdlist1">AMD</dt>
<dd>
<p>See <a href="#amd-glossary">Automatic Mount Daemon</a>.</p>
</dd>
<dt class="hdlist1">AML</dt>
<dd>
<p>See <a href="#aml-glossary">ACPI Machine Language</a>.</p>
</dd>
<dt class="hdlist1">API</dt>
<dd>
<p>See <a href="#api-glossary">Application Programming Interface</a>.</p>
</dd>
<dt class="hdlist1">APIC</dt>
<dd>
<p>See <a href="#apic-glossary">Advanced Programmable Interrupt Controller</a>.</p>
</dd>
<dt class="hdlist1">APM</dt>
<dd>
<p>See <a href="#apm-glossary">Advanced Power Management</a>.</p>
</dd>
<dt class="hdlist1">APOP</dt>
<dd>
<p>See <a href="#apop-glossary">Authenticated Post Office Protocol</a>.</p>
</dd>
<dt class="hdlist1">ASL</dt>
<dd>
<p>See <a href="#asl-glossary">ACPI Source Language</a>.</p>
</dd>
<dt class="hdlist1">ATA</dt>
<dd>
<p>See <a href="#ata-glossary">Advanced Technology Attachment</a>.</p>
</dd>
<dt class="hdlist1">ATM</dt>
<dd>
<p>See <a href="#atm-glossary">Asynchronous Transfer Mode</a>.</p>
</dd>
</dl>
</div>
<div id="aml-glossary" class="dlist">
<dl>
<dt class="hdlist1">ACPI Machine Language</dt>
<dd>
<p>Pseudocode, interpreted by a virtual machine within an ACPI-compliant operating system, providing a layer between the underlying hardware and the documented interface presented to the OS.</p>
</dd>
</dl>
</div>
<div id="asl-glossary" class="dlist">
<dl>
<dt class="hdlist1">ACPI Source Language</dt>
<dd>
<p>The programming language AML is written in.</p>
</dd>
</dl>
</div>
<div id="acl-glossary" class="dlist">
<dl>
<dt class="hdlist1">Access Control List</dt>
<dd>
<p>A list of permissions attached to an object, usually either a file or a network device.</p>
</dd>
</dl>
</div>
<div id="acpi-glossary" class="dlist">
<dl>
<dt class="hdlist1">Advanced Configuration and Power Interface</dt>
<dd>
<p>A specification which provides an abstraction of the interface the hardware presents to the operating system, so that the operating system should need to know nothing about the underlying hardware to make the most of it. ACPI evolves and supersedes the functionality provided previously by APM, PNPBIOS and other technologies, and provides facilities for controlling power consumption, machine suspension, device enabling and disabling, etc.</p>
</dd>
</dl>
</div>
<div id="api-glossary" class="dlist">
<dl>
<dt class="hdlist1">Application Programming Interface</dt>
<dd>
<p>A set of procedures, protocols and tools that specify the canonical interaction of one or more program parts; how, when and why they do work together, and what data they share or operate on.</p>
</dd>
</dl>
</div>
<div id="apm-glossary" class="dlist">
<dl>
<dt class="hdlist1">Advanced Power Management</dt>
<dd>
<p>An API enabling the operating system to work in conjunction with the BIOS in order to achieve power management. APM has been superseded by the much more generic and powerful ACPI specification for most applications.</p>
</dd>
</dl>
</div>
<div id="apic-glossary" class="dlist">
<dl>
<dt class="hdlist1">Advanced Programmable Interrupt Controller</dt>
<dd>
<p></p>
</dd>
</dl>
</div>
<div id="ata-glossary" class="dlist">
<dl>
<dt class="hdlist1">Advanced Technology Attachment</dt>
<dd>
<p></p>
</dd>
</dl>
</div>
<div id="atm-glossary" class="dlist">
<dl>
<dt class="hdlist1">Asynchronous Transfer Mode</dt>
<dd>
<p></p>
</dd>
</dl>
</div>
<div id="apop-glossary" class="dlist">
<dl>
<dt class="hdlist1">Authenticated Post Office Protocol</dt>
<dd>
<p></p>
</dd>
</dl>
</div>
<div id="amd-glossary" class="dlist">
<dl>
<dt class="hdlist1">Automatic Mount Daemon</dt>
<dd>
<p>A daemon that automatically mounts a filesystem when a file or directory within that filesystem is accessed.</p>
</dd>
</dl>
</div>
<h3 id="_b" class="discrete">B</h3>
<div class="dlist">
<dl>
<dt class="hdlist1">BAR</dt>
<dd>
<p>See <a href="#bar-glossary">Base Address Register</a>.</p>
</dd>
<dt class="hdlist1">BIND</dt>
<dd>
<p>See <a href="#bind-glossary">Berkeley Internet Name Domain</a>.</p>
</dd>
<dt class="hdlist1">BIOS</dt>
<dd>
<p>See <a href="#bios-glossary">Basic Input/Output System</a>.</p>
</dd>
<dt class="hdlist1">BSD</dt>
<dd>
<p>See <a href="#bsd-glossary">Berkeley Software Distribution</a>.</p>
</dd>
</dl>
</div>
<div id="bar-glossary" class="dlist">
<dl>
<dt class="hdlist1">Base Address Register</dt>
<dd>
<p>The registers that determine which address range a PCI device will respond to.</p>
</dd>
</dl>
</div>
<div id="bios-glossary" class="dlist">
<dl>
<dt class="hdlist1">Basic Input/Output System</dt>
<dd>
<p>The definition of BIOS depends a bit on the context. Some people refer to it as the ROM chip with a basic set of routines to provide an interface between software and hardware. Others refer to it as the set of routines contained in the chip that help in bootstrapping the system. Some might also refer to it as the screen used to configure the bootstrapping process. The BIOS is PC-specific but other systems have something similar.</p>
</dd>
</dl>
</div>
<div id="bind-glossary" class="dlist">
<dl>
<dt class="hdlist1">Berkeley Internet Name Domain</dt>
<dd>
<p>An implementation of the DNS protocols.</p>
</dd>
</dl>
</div>
<div id="bsd-glossary" class="dlist">
<dl>
<dt class="hdlist1">Berkeley Software Distribution</dt>
<dd>
<p>This is the name that the Computer Systems Research Group (CSRG) at <a href="http://www.berkeley.edu">The University of California at Berkeley</a> gave to their improvements and modifications to AT&amp;T’s 32V UNIX®. FreeBSD is a descendant of the CSRG work.</p>
</dd>
</dl>
</div>
<div id="bikeshed-glossary" class="dlist">
<dl>
<dt class="hdlist1">Bikeshed Building</dt>
<dd>
<p>A phenomenon whereby many people will give an opinion on an uncomplicated topic, whilst a complex topic receives little or no discussion. See the <a href="{faq}#bikeshed-painting">FAQ</a> for the origin of the term.</p>
</dd>
</dl>
</div>
<h3 id="_c" class="discrete">C</h3>
<div class="dlist">
<dl>
<dt class="hdlist1">CD</dt>
<dd>
<p>See <a href="#cd-glossary">Carrier Detect</a>.</p>
</dd>
<dt class="hdlist1">CHAP</dt>
<dd>
<p>See <a href="#chap-glossary">Challenge Handshake Authentication Protocol</a>.</p>
</dd>
<dt class="hdlist1">CLIP</dt>
<dd>
<p>See <a href="#clip-glossary">Classical IP over ATM</a>.</p>
</dd>
<dt class="hdlist1">COFF</dt>
<dd>
<p>See <a href="#coff-glossary">Common Object File Format</a>.</p>
</dd>
<dt class="hdlist1">CPU</dt>
<dd>
<p>See <a href="#cpu-glossary">Central Processing Unit</a>.</p>
</dd>
<dt class="hdlist1">CTS</dt>
<dd>
<p>See <a href="#cts-glossary">Clear To Send</a>.</p>
</dd>
</dl>
</div>
<div id="cd-glossary" class="dlist">
<dl>
<dt class="hdlist1">Carrier Detect</dt>
<dd>
<p>An RS232C signal indicating that a carrier has been detected.</p>
</dd>
</dl>
</div>
<div id="cpu-glossary" class="dlist">
<dl>
<dt class="hdlist1">Central Processing Unit</dt>
<dd>
<p>Also known as the processor. This is the brain of the computer where all calculations take place. There are a number of different architectures with different instruction sets. Among the more well-known are the Intel-x86 and derivatives, Arm, and PowerPC.</p>
</dd>
</dl>
</div>
<div id="chap-glossary" class="dlist">
<dl>
<dt class="hdlist1">Challenge Handshake Authentication Protocol</dt>
<dd>
<p>A method of authenticating a user, based on a secret shared between client and server.</p>
</dd>
</dl>
</div>
<div id="clip-glossary" class="dlist">
<dl>
<dt class="hdlist1">Classical IP over ATM</dt>
<dd>
<p></p>
</dd>
</dl>
</div>
<div id="cts-glossary" class="dlist">
<dl>
<dt class="hdlist1">Clear To Send</dt>
<dd>
<p>An RS232C signal giving the remote system permission to send data.</p>
<div class="paragraph">
<p>See <a href="#rts-glossary">Also Request To Send</a>.</p>
</div>
</dd>
</dl>
</div>
<div id="coff-glossary" class="dlist">
<dl>
<dt class="hdlist1">Common Object File Format</dt>
<dd>
<p></p>
</dd>
</dl>
</div>
<h3 id="_d" class="discrete">D</h3>
<div class="dlist">
<dl>
<dt class="hdlist1">DAC</dt>
<dd>
<p>See <a href="#dac-glossary">Discretionary Access Control</a>.</p>
</dd>
<dt class="hdlist1">DDB</dt>
<dd>
<p>See <a href="#ddb-glossary">Debugger</a>.</p>
</dd>
<dt class="hdlist1">DES</dt>
<dd>
<p>See <a href="#des-glossary">Data Encryption Standard</a>.</p>
</dd>
<dt class="hdlist1">DHCP</dt>
<dd>
<p>See <a href="#dhcp-glossary">Dynamic Host Configuration Protocol</a>.</p>
</dd>
<dt class="hdlist1">DNS</dt>
<dd>
<p>See <a href="#dns-glossary">Domain Name System</a>.</p>
</dd>
<dt class="hdlist1">DSDT</dt>
<dd>
<p>See <a href="#dsdt-glossary">Differentiated System Description Table</a>.</p>
</dd>
<dt class="hdlist1">DSR</dt>
<dd>
<p>See <a href="#dsr-glossary">Data Set Ready</a>.</p>
</dd>
<dt class="hdlist1">DTR</dt>
<dd>
<p>See <a href="#dtr-glossary">Data Terminal Ready</a>.</p>
</dd>
<dt class="hdlist1">DVMRP</dt>
<dd>
<p>See <a href="#dvmrp-glossary">Distance-Vector Multicast Routing Protocol</a>.</p>
</dd>
</dl>
</div>
<div id="dac-glossary" class="dlist">
<dl>
<dt class="hdlist1">Discretionary Access Control</dt>
<dd>
<p></p>
</dd>
</dl>
</div>
<div id="des-glossary" class="dlist">
<dl>
<dt class="hdlist1">Data Encryption Standard</dt>
<dd>
<p>A method of encrypting information, traditionally used as the method of encryption for UNIX® passwords and the <a href="https://man.freebsd.org/cgi/man.cgi?query=crypt&amp;sektion=3&amp;format=html">crypt(3)</a> function.</p>
</dd>
</dl>
</div>
<div id="dsr-glossary" class="dlist">
<dl>
<dt class="hdlist1">Data Set Ready</dt>
<dd>
<p>An RS232C signal sent from the modem to the computer or terminal indicating a readiness to send and receive data.</p>
<div class="paragraph">
<p>See <a href="#dtr-glossary">Also Data Terminal Ready</a>.</p>
</div>
</dd>
</dl>
</div>
<div id="dtr-glossary" class="dlist">
<dl>
<dt class="hdlist1">Data Terminal Ready</dt>
<dd>
<p>An RS232C signal sent from the computer or terminal to the modem indicating a readiness to send and receive data.</p>
</dd>
</dl>
</div>
<div id="ddb-glossary" class="dlist">
<dl>
<dt class="hdlist1">Debugger</dt>
<dd>
<p>An interactive in-kernel facility for examining the status of a system, often used after a system has crashed to establish the events surrounding the failure.</p>
</dd>
</dl>
</div>
<div id="dsdt-glossary" class="dlist">
<dl>
<dt class="hdlist1">Differentiated System Description Table</dt>
<dd>
<p>An ACPI table, supplying basic configuration information about the base system.</p>
</dd>
</dl>
</div>
<div id="dvmrp-glossary" class="dlist">
<dl>
<dt class="hdlist1">Distance-Vector Multicast Routing Protocol</dt>
<dd>
<p></p>
</dd>
</dl>
</div>
<div id="dns-glossary" class="dlist">
<dl>
<dt class="hdlist1">Domain Name System</dt>
<dd>
<p>The system that converts humanly readable hostnames (i.e., mail.example.net) to Internet addresses and vice versa.</p>
</dd>
</dl>
</div>
<div id="dhcp-glossary" class="dlist">
<dl>
<dt class="hdlist1">Dynamic Host Configuration Protocol</dt>
<dd>
<p>A protocol that dynamically assigns IP addresses to a computer (host) when it requests one from the server. The address assignment is called a “lease”.</p>
</dd>
</dl>
</div>
<h3 id="_e" class="discrete">E</h3>
<div class="dlist">
<dl>
<dt class="hdlist1">ECOFF</dt>
<dd>
<p>See <a href="#ecoff-glossary">Extended COFF</a>.</p>
</dd>
<dt class="hdlist1">ELF</dt>
<dd>
<p>See <a href="#elf-glossary">Executable and Linking Format</a>.</p>
</dd>
<dt class="hdlist1">ESP</dt>
<dd>
<p>See <a href="#esp-glossary">Encapsulated Security Payload</a>.</p>
</dd>
<dt class="hdlist1">Encapsulated Security Payload</dt>
<dd>
<p></p>
</dd>
</dl>
</div>
<div id="elf-glossary" class="dlist">
<dl>
<dt class="hdlist1">Executable and Linking Format</dt>
<dd>
<p></p>
</dd>
</dl>
</div>
<div id="ecoff-glossary" class="dlist">
<dl>
<dt class="hdlist1">Extended COFF</dt>
<dd>
<p></p>
</dd>
</dl>
</div>
<h3 id="_f" class="discrete">F</h3>
<div class="dlist">
<dl>
<dt class="hdlist1">FADT</dt>
<dd>
<p>See <a href="#fadt-glossary">Fixed ACPI Description Table</a>.</p>
</dd>
<dt class="hdlist1">FAT</dt>
<dd>
<p>See <a href="#fat-glossary">File Allocation Table</a>.</p>
</dd>
<dt class="hdlist1">FAT16</dt>
<dd>
<p>See <a href="#fat16-glossary">File Allocation Table (16-bit)</a>.</p>
</dd>
<dt class="hdlist1">FTP</dt>
<dd>
<p>See <a href="#ftp-glossary">File Transfer Protocol</a>.</p>
</dd>
</dl>
</div>
<div id="fat-glossary" class="dlist">
<dl>
<dt class="hdlist1">File Allocation Table</dt>
<dd>
<p></p>
</dd>
</dl>
</div>
<div id="fat16-glossary" class="dlist">
<dl>
<dt class="hdlist1">File Allocation Table (16-bit)</dt>
<dd>
<p></p>
</dd>
</dl>
</div>
<div id="ftp-glossary" class="dlist">
<dl>
<dt class="hdlist1">File Transfer Protocol</dt>
<dd>
<p>A member of the family of high-level protocols implemented on top of TCP which can be used to transfer files over a TCP/IP network.</p>
</dd>
</dl>
</div>
<div id="fadt-glossary" class="dlist">
<dl>
<dt class="hdlist1">Fixed ACPI Description Table</dt>
<dd>
<p></p>
</dd>
</dl>
</div>
<h3 id="_g" class="discrete">G</h3>
<div class="dlist">
<dl>
<dt class="hdlist1">GUI</dt>
<dd>
<p>See <a href="#gui-glossary">Graphical User Interface</a>.</p>
</dd>
</dl>
</div>
<div id="giant-glossary" class="dlist">
<dl>
<dt class="hdlist1">Giant</dt>
<dd>
<p>The name of a mutual exclusion mechanism (a sleep <code>mutex</code>) that protects a large set of kernel resources. Although a simple locking mechanism was adequate in the days where a machine might have only a few dozen processes, one networking card, and certainly only one processor, in current times it is an unacceptable performance bottleneck. FreeBSD developers are actively working to replace it with locks that protect individual resources, which will allow a much greater degree of parallelism for both single-processor and multi-processor machines.</p>
</dd>
</dl>
</div>
<div id="gui-glossary" class="dlist">
<dl>
<dt class="hdlist1">Graphical User Interface</dt>
<dd>
<p>A system where the user and computer interact with graphics.</p>
</dd>
</dl>
</div>
<h3 id="_h" class="discrete">H</h3>
<div class="dlist">
<dl>
<dt class="hdlist1">HTML</dt>
<dd>
<p>See <a href="#html-glossary">HyperText Markup Language</a>.</p>
</dd>
<dt class="hdlist1">HUP</dt>
<dd>
<p>See <a href="#hup-glossary">HangUp</a>.</p>
</dd>
</dl>
</div>
<div id="hup-glossary" class="dlist">
<dl>
<dt class="hdlist1">HangUp</dt>
<dd>
<p></p>
</dd>
</dl>
</div>
<div id="html-glossary" class="dlist">
<dl>
<dt class="hdlist1">HyperText Markup Language</dt>
<dd>
<p>The markup language used to create web pages.</p>
</dd>
</dl>
</div>
<h3 id="_i" class="discrete">I</h3>
<div class="dlist">
<dl>
<dt class="hdlist1">I/O</dt>
<dd>
<p>See <a href="#io-glossary">Input/Output</a>.</p>
</dd>
<dt class="hdlist1">IASL</dt>
<dd>
<p>See <a href="#iasl-glossary">Intel’s ASL compiler</a>.</p>
</dd>
<dt class="hdlist1">IMAP</dt>
<dd>
<p>See <a href="#imap-glossary">Internet Message Access Protocol</a>.</p>
</dd>
<dt class="hdlist1">IP</dt>
<dd>
<p>See <a href="#ip-glossary">Internet Protocol</a>.</p>
</dd>
<dt class="hdlist1">IPFW</dt>
<dd>
<p>See <a href="#ipfw-glossary">IP Firewall</a>.</p>
</dd>
<dt class="hdlist1">IPP</dt>
<dd>
<p>See <a href="#ipp-glossary">Internet Printing Protocol</a>.</p>
</dd>
<dt class="hdlist1">IPv4</dt>
<dd>
<p>See <a href="#ipv4-glossary">IP Version 4</a>.</p>
</dd>
<dt class="hdlist1">IPv6</dt>
<dd>
<p>See <a href="#ipv6-glossary">IP Version 6</a>.</p>
</dd>
<dt class="hdlist1">ISP</dt>
<dd>
<p>See <a href="#isp-glossary">Internet Service Provider</a>.</p>
</dd>
</dl>
</div>
<div id="ipfw-glossary" class="dlist">
<dl>
<dt class="hdlist1">IP Firewall</dt>
<dd>
<p></p>
</dd>
</dl>
</div>
<div id="ipv4-glossary" class="dlist">
<dl>
<dt class="hdlist1">IP Version 4</dt>
<dd>
<p>The IP protocol version 4, which uses 32 bits for addressing. This version is still the most widely used, but it is slowly being replaced with IPv6.</p>
<div class="paragraph">
<p>See <a href="#ipv6-glossary">Also IP Version 6</a>.</p>
</div>
</dd>
</dl>
</div>
<div id="ipv6-glossary" class="dlist">
<dl>
<dt class="hdlist1">IP Version 6</dt>
<dd>
<p>The new IP protocol. Invented because the address space in IPv4 is running out. Uses 128 bits for addressing.</p>
</dd>
</dl>
</div>
<div id="io-glossary" class="dlist">
<dl>
<dt class="hdlist1">Input/Output</dt>
<dd>
<p></p>
</dd>
</dl>
</div>
<div id="iasl-glossary" class="dlist">
<dl>
<dt class="hdlist1">Intel’s ASL compiler</dt>
<dd>
<p>Intel’s compiler for converting ASL into AML.</p>
</dd>
</dl>
</div>
<div id="imap-glossary" class="dlist">
<dl>
<dt class="hdlist1">Internet Message Access Protocol</dt>
<dd>
<p>A protocol for accessing email messages on a mail server, characterised by the messages usually being kept on the server as opposed to being downloaded to the mail reader client.</p>
<div class="paragraph">
<p>See Also Post Office Protocol Version 3.</p>
</div>
</dd>
</dl>
</div>
<div id="ipp-glossary" class="dlist">
<dl>
<dt class="hdlist1">Internet Printing Protocol</dt>
<dd>
<p></p>
</dd>
</dl>
</div>
<div id="ip-glossary" class="dlist">
<dl>
<dt class="hdlist1">Internet Protocol</dt>
<dd>
<p>The packet transmitting protocol that is the basic protocol on the Internet. Originally developed at the U.S. Department of Defense and an extremely important part of the TCP/IP stack. Without the Internet Protocol, the Internet would not have become what it is today. For more information, see <a href="ftp://ftp.rfc-editor.org/in-notes/rfc791.txt">RFC 791</a>.</p>
</dd>
</dl>
</div>
<div id="isp-glossary" class="dlist">
<dl>
<dt class="hdlist1">Internet Service Provider</dt>
<dd>
<p>A company that provides access to the Internet.</p>
</dd>
</dl>
</div>
<h3 id="_k" class="discrete">K</h3>
<div id="kame-glossary" class="dlist">
<dl>
<dt class="hdlist1">KAME</dt>
<dd>
<p>Japanese for “turtle”, the term KAME is used in computing circles to refer to the <a href="http://www.kame.net/">KAME Project</a>, who work on an implementation of IPv6.</p>
</dd>
<dt class="hdlist1">KDC</dt>
<dd>
<p>See <a href="#kdc-glossary">Key Distribution Center</a>.</p>
</dd>
<dt class="hdlist1">KLD</dt>
<dd>
<p>See <a href="#kld-glossary">Kernel ld(1)</a>.</p>
</dd>
<dt class="hdlist1">KSE</dt>
<dd>
<p>See <a href="#kse-glossary">Kernel Scheduler Entities</a>.</p>
</dd>
<dt class="hdlist1">KVA</dt>
<dd>
<p>See <a href="#kva-glossary">Kernel Virtual Address</a>.</p>
</dd>
<dt class="hdlist1">Kbps</dt>
<dd>
<p>See <a href="#kbps-glossary">Kilo Bits Per Second</a>.</p>
</dd>
</dl>
</div>
<div id="kld-glossary" class="dlist">
<dl>
<dt class="hdlist1">Kernel <a href="https://man.freebsd.org/cgi/man.cgi?query=ld&amp;sektion=1&amp;format=html">ld(1)</a></dt>
<dd>
<p>A method of dynamically loading functionality into a FreeBSD kernel without rebooting the system.</p>
</dd>
</dl>
</div>
<div id="kse-glossary" class="dlist">
<dl>
<dt class="hdlist1">Kernel Scheduler Entities</dt>
<dd>
<p>A kernel-supported threading system. See the <a href="http://www.freebsd.org/kse">project home page</a> for further details.</p>
</dd>
</dl>
</div>
<div id="kva-glossary" class="dlist">
<dl>
<dt class="hdlist1">Kernel Virtual Address</dt>
<dd>
<p></p>
</dd>
</dl>
</div>
<div id="kdc-glossary" class="dlist">
<dl>
<dt class="hdlist1">Key Distribution Center</dt>
<dd>
<p></p>
</dd>
</dl>
</div>
<div id="kbps-glossary" class="dlist">
<dl>
<dt class="hdlist1">Kilo Bits Per Second</dt>
<dd>
<p>Used to measure bandwidth (how much data can pass a given point at a specified amount of time). Alternates to the Kilo prefix include Mega, Giga, Tera, and so forth.</p>
</dd>
</dl>
</div>
<h3 id="_l" class="discrete">L</h3>
<div class="dlist">
<dl>
<dt class="hdlist1">LAN</dt>
<dd>
<p>See <a href="#lan-glossary">Local Area Network</a>.</p>
</dd>
<dt class="hdlist1">LOR</dt>
<dd>
<p>See <a href="#lor-glossary">Lock Order Reversal</a>.</p>
</dd>
<dt class="hdlist1">LPD</dt>
<dd>
<p>See <a href="#lpd-glossary">Line Printer Daemon</a>.</p>
</dd>
</dl>
</div>
<div id="lpd-glossary" class="dlist">
<dl>
<dt class="hdlist1">Line Printer Daemon</dt>
<dd>
<p></p>
</dd>
</dl>
</div>
<div id="lan-glossary" class="dlist">
<dl>
<dt class="hdlist1">Local Area Network</dt>
<dd>
<p>A network used on a local area, e.g. office, home, or so forth.</p>
</dd>
</dl>
</div>
<div id="lor-glossary" class="dlist">
<dl>
<dt class="hdlist1">Lock Order Reversal</dt>
<dd>
<p>The FreeBSD kernel uses a number of resource locks to arbitrate contention for those resources. A run-time lock diagnostic system found in FreeBSD-CURRENT kernels (but removed for releases), called <a href="https://man.freebsd.org/cgi/man.cgi?query=witness&amp;sektion=4&amp;format=html">witness(4)</a>, detects the potential for deadlocks due to locking errors. (<a href="https://man.freebsd.org/cgi/man.cgi?query=witness&amp;sektion=4&amp;format=html">witness(4)</a> is actually slightly conservative, so it is possible to get false positives.) A true positive report indicates that “if you were unlucky, a deadlock would have happened here”.</p>
<div class="paragraph">
<p>True positive LORs tend to get fixed quickly, so check <a href="https://lists.FreeBSD.org/subscription/freebsd-current" class="bare">https://lists.FreeBSD.org/subscription/freebsd-current</a> and the <a href="http://sources.zabbadoz.net/freebsd/lor.html">LORs Seen</a> page before posting to the mailing lists.</p>
</div>
</dd>
</dl>
</div>
<h3 id="_m" class="discrete">M</h3>
<div class="dlist">
<dl>
<dt class="hdlist1">MAC</dt>
<dd>
<p>See <a href="#mac-glossary">Mandatory Access Control</a>.</p>
</dd>
<dt class="hdlist1">MADT</dt>
<dd>
<p>See <a href="#madt-glossary">Multiple APIC Description Table</a>.</p>
</dd>
<dt class="hdlist1">MFC</dt>
<dd>
<p>See <a href="#mfc-glossary">Merge From Current</a>.</p>
</dd>
<dt class="hdlist1">MFH</dt>
<dd>
<p>See <a href="#mfh-glossary">Merge From Head</a>.</p>
</dd>
<dt class="hdlist1">MFS</dt>
<dd>
<p>See <a href="#mfs-glossary">Merge From Stable</a>.</p>
</dd>
<dt class="hdlist1">MFV</dt>
<dd>
<p>See <a href="#mfv-glossary">Merge From Vendor</a>.</p>
</dd>
<dt class="hdlist1">MIT</dt>
<dd>
<p>See <a href="#mit-glossary">Massachusetts Institute of Technology</a>.</p>
</dd>
<dt class="hdlist1">MLS</dt>
<dd>
<p>See <a href="#mls-glossary">Multi-Level Security</a>.</p>
</dd>
<dt class="hdlist1">MOTD</dt>
<dd>
<p>See <a href="#motd-glossary">Message Of The Day</a>.</p>
</dd>
<dt class="hdlist1">MTA</dt>
<dd>
<p>See <a href="#mta-glossary">Mail Transfer Agent</a>.</p>
</dd>
<dt class="hdlist1">MUA</dt>
<dd>
<p>See <a href="#mua-glossary">Mail User Agent</a>.</p>
</dd>
</dl>
</div>
<div id="mta-glossary" class="dlist">
<dl>
<dt class="hdlist1">Mail Transfer Agent</dt>
<dd>
<p>An application used to transfer email. An MTA has traditionally been part of the BSD base system. Today Sendmail is included in the base system, but there are many other MTAs, such as postfix, qmail and Exim.</p>
</dd>
</dl>
</div>
<div id="mua-glossary" class="dlist">
<dl>
<dt class="hdlist1">Mail User Agent</dt>
<dd>
<p>An application used by users to display and write email.</p>
</dd>
</dl>
</div>
<div id="mac-glossary" class="dlist">
<dl>
<dt class="hdlist1">Mandatory Access Control</dt>
<dd>
<p></p>
</dd>
</dl>
</div>
<div id="mit-glossary" class="dlist">
<dl>
<dt class="hdlist1">Massachusetts Institute of Technology</dt>
<dd>
<p></p>
</dd>
</dl>
</div>
<div id="mfc-glossary" class="dlist">
<dl>
<dt class="hdlist1">Merge From Current</dt>
<dd>
<p>To merge functionality or a patch from the -CURRENT branch to another, most often -STABLE.</p>
</dd>
</dl>
</div>
<div id="mfh-glossary" class="dlist">
<dl>
<dt class="hdlist1">Merge From Head</dt>
<dd>
<p>To merge functionality or a patch from a repository HEAD to an earlier branch.</p>
</dd>
</dl>
</div>
<div id="mfs-glossary" class="dlist">
<dl>
<dt class="hdlist1">Merge From Stable</dt>
<dd>
<p>In the normal course of FreeBSD development, a change will be committed to the -CURRENT branch for testing before being merged to -STABLE. On rare occasions, a change will go into -STABLE first and then be merged to -CURRENT.</p>
<div class="paragraph">
<p>This term is also used when a patch is merged from -STABLE to a security branch.</p>
</div>
<div class="paragraph">
<p>See <a href="#mfc-glossary">Also Merge From Current</a>.</p>
</div>
</dd>
</dl>
</div>
<div id="mfv-glossary" class="dlist">
<dl>
<dt class="hdlist1">Merge From Vendor</dt>
<dd>
<p></p>
</dd>
</dl>
</div>
<div id="motd-glossary" class="dlist">
<dl>
<dt class="hdlist1">Message Of The Day</dt>
<dd>
<p>A message, usually shown on login, often used to distribute information to users of the system.</p>
</dd>
</dl>
</div>
<div id="mls-glossary" class="dlist">
<dl>
<dt class="hdlist1">Multi-Level Security</dt>
<dd>
<p></p>
</dd>
</dl>
</div>
<div id="madt-glossary" class="dlist">
<dl>
<dt class="hdlist1">Multiple APIC Description Table</dt>
<dd>
<p></p>
</dd>
</dl>
</div>
<h3 id="_n" class="discrete">N</h3>
<div class="dlist">
<dl>
<dt class="hdlist1">NAT</dt>
<dd>
<p>See <a href="#nat-glossary">Network Address Translation</a>.</p>
</dd>
<dt class="hdlist1">NDISulator</dt>
<dd>
<p>See <a href="#projectevil-glossary">Project Evil</a>.</p>
</dd>
<dt class="hdlist1">NFS</dt>
<dd>
<p>See <a href="#nfs-glossary">Network File System</a>.</p>
</dd>
<dt class="hdlist1">NTFS</dt>
<dd>
<p>See <a href="#ntfs-glossary">New Technology File System</a>.</p>
</dd>
<dt class="hdlist1">NTP</dt>
<dd>
<p>See <a href="#ntp-glossary">Network Time Protocol</a>.</p>
</dd>
</dl>
</div>
<div id="nat-glossary" class="dlist">
<dl>
<dt class="hdlist1">Network Address Translation</dt>
<dd>
<p>A technique where IP packets are rewritten on the way through a gateway, enabling many machines behind the gateway to effectively share a single IP address.</p>
</dd>
</dl>
</div>
<div id="nfs-glossary" class="dlist">
<dl>
<dt class="hdlist1">Network File System</dt>
<dd>
<p></p>
</dd>
</dl>
</div>
<div id="ntfs-glossary" class="dlist">
<dl>
<dt class="hdlist1">New Technology File System</dt>
<dd>
<p>A filesystem developed by Microsoft and available in its “New Technology” operating systems, such as Windows® 2000, Windows NT® and Windows® XP.</p>
</dd>
</dl>
</div>
<div id="ntp-glossary" class="dlist">
<dl>
<dt class="hdlist1">Network Time Protocol</dt>
<dd>
<p>A means of synchronizing clocks over a network.</p>
</dd>
</dl>
</div>
<h3 id="_o" class="discrete">O</h3>
<div class="dlist">
<dl>
<dt class="hdlist1">OBE</dt>
<dd>
<p>See <a href="#obe-glossary">Overtaken By Events</a>.</p>
</dd>
<dt class="hdlist1">ODMR</dt>
<dd>
<p>See <a href="#odmr-glossary">On-Demand Mail Relay</a>.</p>
</dd>
<dt class="hdlist1">OS</dt>
<dd>
<p>See <a href="#os-glossary">Operating System</a>.</p>
</dd>
</dl>
</div>
<div id="odmr-glossary" class="dlist">
<dl>
<dt class="hdlist1">On-Demand Mail Relay</dt>
<dd>
<p></p>
</dd>
</dl>
</div>
<div id="os-glossary" class="dlist">
<dl>
<dt class="hdlist1">Operating System</dt>
<dd>
<p>A set of programs, libraries and tools that provide access to the hardware resources of a computer. Operating systems range today from simplistic designs that support only one program running at a time, accessing only one device to fully multi-user, multi-tasking and multi-process systems that can serve thousands of users simultaneously, each of them running dozens of different applications.</p>
</dd>
</dl>
</div>
<div id="obe-glossary" class="dlist">
<dl>
<dt class="hdlist1">Overtaken By Events</dt>
<dd>
<p>Indicates a suggested change (such as a Problem Report or a feature request) which is no longer relevant or applicable due to such things as later changes to FreeBSD, changes in networking standards, the affected hardware having since become obsolete, and so forth.</p>
</dd>
</dl>
</div>
<h3 id="_p" class="discrete">P</h3>
<div class="dlist">
<dl>
<dt class="hdlist1">PAE</dt>
<dd>
<p>See <a href="#pae-glossary">Physical Address Extensions</a>.</p>
</dd>
<dt class="hdlist1">PAM</dt>
<dd>
<p>See <a href="#pam-glossary">Pluggable Authentication Modules</a>.</p>
</dd>
<dt class="hdlist1">PAP</dt>
<dd>
<p>See <a href="#pap-glossary">Password Authentication Protocol</a>.</p>
</dd>
<dt class="hdlist1">PC</dt>
<dd>
<p>See <a href="#pc-glossary">Personal Computer</a>.</p>
</dd>
<dt class="hdlist1">PCNSFD</dt>
<dd>
<p>See <a href="#pcnfsd-glossary">Personal Computer Network File System Daemon</a>.</p>
</dd>
<dt class="hdlist1">PDF</dt>
<dd>
<p>See <a href="#pdf-glossary">Portable Document Format</a>.</p>
</dd>
<dt class="hdlist1">PID</dt>
<dd>
<p>See <a href="#pid-glossary">Process ID</a>.</p>
</dd>
<dt class="hdlist1">POLA</dt>
<dd>
<p>See <a href="#pola-glossary">Principle Of Least Astonishment</a>.</p>
</dd>
<dt class="hdlist1">POP</dt>
<dd>
<p>See <a href="#pop-glossary">Post Office Protocol</a>.</p>
</dd>
<dt class="hdlist1">POP3</dt>
<dd>
<p>See <a href="#pop3-glossary">Post Office Protocol Version 3</a>.</p>
</dd>
<dt class="hdlist1">PPD</dt>
<dd>
<p>See <a href="#ppd-glossary">PostScript Printer Description</a>.</p>
</dd>
<dt class="hdlist1">PPP</dt>
<dd>
<p>See <a href="#ppp-glossary">Point-to-Point Protocol</a>.</p>
</dd>
<dt class="hdlist1">PPPoA</dt>
<dd>
<p>See <a href="#pppoa-glossary">PPP over ATM</a>.</p>
</dd>
<dt class="hdlist1">PPPoE</dt>
<dd>
<p>See <a href="#pppoe-glossary">PPP over Ethernet</a>.</p>
</dd>
</dl>
</div>
<div id="pppoa-glossary" class="dlist">
<dl>
<dt class="hdlist1">PPP over ATM</dt>
<dd>
<p></p>
</dd>
</dl>
</div>
<div id="pppoe-glossary" class="dlist">
<dl>
<dt class="hdlist1">PPP over Ethernet</dt>
<dd>
<p></p>
</dd>
<dt class="hdlist1">PR</dt>
<dd>
<p>See <a href="#pr-glossary">Problem Report</a>.</p>
</dd>
<dt class="hdlist1">PXE</dt>
<dd>
<p>See <a href="#pxe-glossary">Preboot eXecution Environment</a>.</p>
</dd>
</dl>
</div>
<div id="pap-glossary" class="dlist">
<dl>
<dt class="hdlist1">Password Authentication Protocol</dt>
<dd>
<p></p>
</dd>
</dl>
</div>
<div id="pc-glossary" class="dlist">
<dl>
<dt class="hdlist1">Personal Computer</dt>
<dd>
<p></p>
</dd>
</dl>
</div>
<div id="pcnfsd-glossary" class="dlist">
<dl>
<dt class="hdlist1">Personal Computer Network File System Daemon</dt>
<dd>
<p></p>
</dd>
</dl>
</div>
<div id="pae-glossary" class="dlist">
<dl>
<dt class="hdlist1">Physical Address Extensions</dt>
<dd>
<p>A method of enabling access to up to 64 GB of RAM on systems which only physically have a 32-bit wide address space (and would therefore be limited to 4 GB without PAE).</p>
</dd>
</dl>
</div>
<div id="pam-glossary" class="dlist">
<dl>
<dt class="hdlist1">Pluggable Authentication Modules</dt>
<dd>
<p></p>
</dd>
</dl>
</div>
<div id="ppp-glossary" class="dlist">
<dl>
<dt class="hdlist1">Point-to-Point Protocol</dt>
<dd>
<p></p>
</dd>
</dl>
</div>
<div id="pointyhat" class="dlist">
<dl>
<dt class="hdlist1">Pointy Hat</dt>
<dd>
<p>A mythical piece of headgear, much like a dunce cap, awarded to any FreeBSD committer who breaks the build, makes revision numbers go backwards, or creates any other kind of havoc in the source base. Any committer worth his or her salt will soon accumulate a large collection. The usage is (almost always?) humorous.</p>
</dd>
</dl>
</div>
<div id="pdf-glossary" class="dlist">
<dl>
<dt class="hdlist1">Portable Document Format</dt>
<dd>
<p></p>
</dd>
</dl>
</div>
<div id="pop-glossary" class="dlist">
<dl>
<dt class="hdlist1">Post Office Protocol</dt>
<dd>
<p>See Also Post Office Protocol Version 3.</p>
</dd>
</dl>
</div>
<div id="pop3-glossary" class="dlist">
<dl>
<dt class="hdlist1">Post Office Protocol Version 3</dt>
<dd>
<p>A protocol for accessing email messages on a mail server, characterised by the messages usually being downloaded from the server to the client, as opposed to remaining on the server.</p>
<div class="paragraph">
<p>See <a href="#imap-glossary">Also Internet Message Access Protocol</a>.</p>
</div>
</dd>
</dl>
</div>
<div id="ppd-glossary" class="dlist">
<dl>
<dt class="hdlist1">PostScript Printer Description</dt>
<dd>
<p></p>
</dd>
</dl>
</div>
<div id="pxe-glossary" class="dlist">
<dl>
<dt class="hdlist1">Preboot eXecution Environment</dt>
<dd>
<p></p>
</dd>
</dl>
</div>
<div id="pola-glossary" class="dlist">
<dl>
<dt class="hdlist1">Principle Of Least Astonishment</dt>
<dd>
<p>As FreeBSD evolves, changes visible to the user should be kept as unsurprising as possible. For example, arbitrarily rearranging system startup variables in <span class="filename">/etc/defaults/rc.conf</span> violates POLA. Developers consider POLA when contemplating user-visible system changes.</p>
</dd>
</dl>
</div>
<div id="pr-glossary" class="dlist">
<dl>
<dt class="hdlist1">Problem Report</dt>
<dd>
<p>A description of some kind of problem that has been found in either the FreeBSD source or documentation. See <a href="{problem-reports}">Writing FreeBSD Problem Reports</a>.</p>
</dd>
</dl>
</div>
<div id="pid-glossary" class="dlist">
<dl>
<dt class="hdlist1">Process ID</dt>
<dd>
<p>A number, unique to a particular process on a system, which identifies it and allows actions to be taken against it.</p>
</dd>
</dl>
</div>
<div id="projectevil-glossary" class="dlist">
<dl>
<dt class="hdlist1">Project Evil</dt>
<dd>
<p>The working title for the NDISulator, written by Bill Paul, who named it referring to how awful it is (from a philosophical standpoint) to need to have something like this in the first place. The NDISulator is a special compatibility module to allow Microsoft Windows™ NDIS miniport network drivers to be used with FreeBSD/i386. This is usually the only way to use cards where the driver is closed-source. See <span class="filename">src/sys/compat/ndis/subr_ndis.c</span>.</p>
</dd>
</dl>
</div>
<h3 id="_r" class="discrete">R</h3>
<div class="dlist">
<dl>
<dt class="hdlist1">RA</dt>
<dd>
<p>See <a href="#ra-glossary">Router Advertisement</a>.</p>
</dd>
<dt class="hdlist1">RAID</dt>
<dd>
<p>See <a href="#raid-glossary">Redundant Array of Inexpensive Disks</a>.</p>
</dd>
<dt class="hdlist1">RAM</dt>
<dd>
<p>See <a href="#ram-glossary">Random Access Memory</a>.</p>
</dd>
<dt class="hdlist1">RD</dt>
<dd>
<p>See <a href="#rd-glossary">Received Data</a>.</p>
</dd>
<dt class="hdlist1">RFC</dt>
<dd>
<p>See <a href="#rfc-glossary">Request For Comments</a>.</p>
</dd>
<dt class="hdlist1">RISC</dt>
<dd>
<p>See <a href="#risc-glossary">Reduced Instruction Set Computer</a>.</p>
</dd>
<dt class="hdlist1">RPC</dt>
<dd>
<p>See <a href="#rpc-glossary">Remote Procedure Call</a>.</p>
</dd>
<dt class="hdlist1">RS232C</dt>
<dd>
<p>See <a href="#rs232c-glossary">Recommended Standard 232C</a>.</p>
</dd>
<dt class="hdlist1">RTS</dt>
<dd>
<p>See <a href="#rts-glossary">Request To Send</a>.</p>
</dd>
</dl>
</div>
<div id="ram-glossary" class="dlist">
<dl>
<dt class="hdlist1">Random Access Memory</dt>
<dd>
<p></p>
</dd>
</dl>
</div>
<div id="rcs-glossary" class="dlist">
<dl>
<dt class="hdlist1">Revision Control System</dt>
<dd>
<p>The <em>Revision Control System (RCS)</em> is one of the oldest software suites that implement “revision control” for plain files. It allows the storage, retrieval, archival, logging, identification and merging of multiple revisions for each file. RCS consists of many small tools that work together. It lacks some of the features found in more modern revision control systems, like Git, but it is very simple to install, configure, and start using for a small set of files.</p>
<div class="paragraph">
<p>See <a href="#svn-glossary">Also Subversion</a>.</p>
</div>
</dd>
</dl>
</div>
<div id="rd-glossary" class="dlist">
<dl>
<dt class="hdlist1">Received Data</dt>
<dd>
<p>An RS232C pin or wire that data is received on.</p>
<div class="paragraph">
<p>See <a href="#td-glossary">Also Transmitted Data</a>.</p>
</div>
</dd>
</dl>
</div>
<div id="rs232c-glossary" class="dlist">
<dl>
<dt class="hdlist1">Recommended Standard 232C</dt>
<dd>
<p>A standard for communications between serial devices.</p>
</dd>
</dl>
</div>
<div id="risc-glossary" class="dlist">
<dl>
<dt class="hdlist1">Reduced Instruction Set Computer</dt>
<dd>
<p>An approach to processor design where the operations the hardware can perform are simplified but made as general purpose as possible. This can lead to lower power consumption, fewer transistors and in some cases, better performance and increased code density. Examples of RISC processors include the Alpha, SPARC®, ARM® and PowerPC®.</p>
</dd>
</dl>
</div>
<div id="raid-glossary" class="dlist">
<dl>
<dt class="hdlist1">Redundant Array of Inexpensive Disks</dt>
<dd>
<p></p>
</dd>
</dl>
</div>
<div id="rpc-glossary" class="dlist">
<dl>
<dt class="hdlist1">Remote Procedure Call</dt>
<dd>
<p></p>
</dd>
</dl>
</div>
<div id="rfc-glossary" class="dlist">
<dl>
<dt class="hdlist1">Request For Comments</dt>
<dd>
<p>A set of documents defining Internet standards, protocols, and so forth. See www.rfc-editor.org.</p>
<div class="paragraph">
<p>Also used as a general term when someone has a suggested change and wants feedback.</p>
</div>
</dd>
</dl>
</div>
<div id="rts-glossary" class="dlist">
<dl>
<dt class="hdlist1">Request To Send</dt>
<dd>
<p>An RS232C signal requesting that the remote system commences transmission of data.</p>
<div class="paragraph">
<p>See <a href="#cts-glossary">Also Clear To Send</a>.</p>
</div>
</dd>
</dl>
</div>
<div id="ra-glossary" class="dlist">
<dl>
<dt class="hdlist1">Router Advertisement</dt>
<dd>
<p></p>
</dd>
</dl>
</div>
<h3 id="_s" class="discrete">S</h3>
<div class="dlist">
<dl>
<dt class="hdlist1">SCI</dt>
<dd>
<p>See <a href="#sci-glossary">System Control Interrupt</a>.</p>
</dd>
<dt class="hdlist1">SCSI</dt>
<dd>
<p>See <a href="#scsi-glossary">Small Computer System Interface</a>.</p>
</dd>
<dt class="hdlist1">SG</dt>
<dd>
<p>See <a href="#sg-glossary">Signal Ground</a>.</p>
</dd>
<dt class="hdlist1">SMB</dt>
<dd>
<p>See <a href="#smb-glossary">Server Message Block</a>.</p>
</dd>
<dt class="hdlist1">SMP</dt>
<dd>
<p>See <a href="#smp-glossary">Symmetric MultiProcessor</a>.</p>
</dd>
<dt class="hdlist1">SMTP</dt>
<dd>
<p>See <a href="#smtp-glossary">Simple Mail Transfer Protocol</a>.</p>
</dd>
<dt class="hdlist1">SMTP AUTH</dt>
<dd>
<p>See <a href="#smtpauth-glossary">SMTP Authentication</a>.</p>
</dd>
<dt class="hdlist1">SSH</dt>
<dd>
<p>See <a href="#ssh-glossary">Secure Shell</a>.</p>
</dd>
<dt class="hdlist1">STR</dt>
<dd>
<p>See <a href="#str-glossary">Suspend To RAM</a>.</p>
</dd>
<dt class="hdlist1">SVN</dt>
<dd>
<p>See <a href="#svn-glossary">Subversion</a>.</p>
</dd>
</dl>
</div>
<div id="smtpauth-glossary" class="dlist">
<dl>
<dt class="hdlist1">SMTP Authentication</dt>
<dd>
<p></p>
</dd>
</dl>
</div>
<div id="smb-glossary" class="dlist">
<dl>
<dt class="hdlist1">Server Message Block</dt>
<dd>
<p></p>
</dd>
</dl>
</div>
<div id="sg-glossary" class="dlist">
<dl>
<dt class="hdlist1">Signal Ground</dt>
<dd>
<p>An RS232 pin or wire that is the ground reference for the signal.</p>
</dd>
</dl>
</div>
<div id="smtp-glossary" class="dlist">
<dl>
<dt class="hdlist1">Simple Mail Transfer Protocol</dt>
<dd>
<p></p>
</dd>
</dl>
</div>
<div id="ssh-glossary" class="dlist">
<dl>
<dt class="hdlist1">Secure Shell</dt>
<dd>
<p></p>
</dd>
</dl>
</div>
<div id="scsi-glossary" class="dlist">
<dl>
<dt class="hdlist1">Small Computer System Interface</dt>
<dd>
<p></p>
</dd>
</dl>
</div>
<div id="svn-glossary" class="dlist">
<dl>
<dt class="hdlist1">Subversion</dt>
<dd>
<p>Subversion is a version control system currently used by the FreeBSD project.</p>
</dd>
</dl>
</div>
<div id="str-glossary" class="dlist">
<dl>
<dt class="hdlist1">Suspend To RAM</dt>
<dd>
<p></p>
</dd>
</dl>
</div>
<div id="smp-glossary" class="dlist">
<dl>
<dt class="hdlist1">Symmetric MultiProcessor</dt>
<dd>
<p></p>
</dd>
</dl>
</div>
<div id="sci-glossary" class="dlist">
<dl>
<dt class="hdlist1">System Control Interrupt</dt>
<dd>
<p></p>
</dd>
</dl>
</div>
<h3 id="_t" class="discrete">T</h3>
<div class="dlist">
<dl>
<dt class="hdlist1">TCP</dt>
<dd>
<p>See <a href="#tcp-glossary">Transmission Control Protocol</a>.</p>
</dd>
<dt class="hdlist1">TCP/IP</dt>
<dd>
<p>See <a href="#tcpip-glossary">Transmission Control Protocol/Internet Protocol</a>.</p>
</dd>
<dt class="hdlist1">TD</dt>
<dd>
<p>See <a href="#td-glossary">Transmitted Data</a>.</p>
</dd>
<dt class="hdlist1">TFTP</dt>
<dd>
<p>See <a href="#tftp-glossary">Trivial FTP</a>.</p>
</dd>
<dt class="hdlist1">TGT</dt>
<dd>
<p>See <a href="#tgt-glossary">Ticket-Granting Ticket</a>.</p>
</dd>
<dt class="hdlist1">TSC</dt>
<dd>
<p>See <a href="#tsc-glossary">Time Stamp Counter</a>.</p>
</dd>
</dl>
</div>
<div id="tgt-glossary" class="dlist">
<dl>
<dt class="hdlist1">Ticket-Granting Ticket</dt>
<dd>
<p></p>
</dd>
</dl>
</div>
<div id="tsc-glossary" class="dlist">
<dl>
<dt class="hdlist1">Time Stamp Counter</dt>
<dd>
<p>A profiling counter internal to modern Pentium® processors that counts core frequency clock ticks.</p>
</dd>
</dl>
</div>
<div id="tcp-glossary" class="dlist">
<dl>
<dt class="hdlist1">Transmission Control Protocol</dt>
<dd>
<p>A protocol that sits on top of (e.g.) the IP protocol and guarantees that packets are delivered in a reliable, ordered, fashion.</p>
</dd>
</dl>
</div>
<div id="tcpip-glossary" class="dlist">
<dl>
<dt class="hdlist1">Transmission Control Protocol/Internet Protocol</dt>
<dd>
<p>The term for the combination of the TCP protocol running over the IP protocol. Much of the Internet runs over TCP/IP.</p>
</dd>
</dl>
</div>
<div id="td-glossary" class="dlist">
<dl>
<dt class="hdlist1">Transmitted Data</dt>
<dd>
<p>An RS232C pin or wire that data is transmitted on.</p>
<div class="paragraph">
<p>See <a href="#rd-glossary">Also Received Data</a>.</p>
</div>
</dd>
</dl>
</div>
<div id="tftp-glossary" class="dlist">
<dl>
<dt class="hdlist1">Trivial FTP</dt>
<dd>
<p></p>
</dd>
</dl>
</div>
<h3 id="_u" class="discrete">U</h3>
<div class="dlist">
<dl>
<dt class="hdlist1">UDP</dt>
<dd>
<p>See <a href="#udp-glossary">User Datagram Protocol</a>.</p>
</dd>
<dt class="hdlist1">UFS1</dt>
<dd>
<p>See <a href="#ufs1-glossary">Unix File System Version 1</a>.</p>
</dd>
<dt class="hdlist1">UFS2</dt>
<dd>
<p>See <a href="#ufs2-glossary">Unix File System Version 2</a>.</p>
</dd>
<dt class="hdlist1">UID</dt>
<dd>
<p>See <a href="#uid-glossary">User ID</a>.</p>
</dd>
<dt class="hdlist1">URL</dt>
<dd>
<p>See <a href="#url-glossary">Uniform Resource Locator</a>.</p>
</dd>
<dt class="hdlist1">USB</dt>
<dd>
<p>See <a href="#usb-glossary">Universal Serial Bus</a>.</p>
</dd>
</dl>
</div>
<div id="url-glossary" class="dlist">
<dl>
<dt class="hdlist1">Uniform Resource Locator</dt>
<dd>
<p>A method of locating a resource, such as a document on the Internet and a means to identify that resource.</p>
</dd>
</dl>
</div>
<div id="ufs1-glossary" class="dlist">
<dl>
<dt class="hdlist1">Unix File System Version 1</dt>
<dd>
<p>The original UNIX® file system, sometimes called the Berkeley Fast File System.</p>
</dd>
</dl>
</div>
<div id="ufs2-glossary" class="dlist">
<dl>
<dt class="hdlist1">Unix File System Version 2</dt>
<dd>
<p>An extension to UFS1, introduced in FreeBSD 5-CURRENT. UFS2 adds 64 bit block pointers (breaking the 1T barrier), support for extended file storage and other features.</p>
</dd>
</dl>
</div>
<div id="usb-glossary" class="dlist">
<dl>
<dt class="hdlist1">Universal Serial Bus</dt>
<dd>
<p>A hardware standard used to connect a wide variety of computer peripherals to a universal interface.</p>
</dd>
</dl>
</div>
<div id="uid-glossary" class="dlist">
<dl>
<dt class="hdlist1">User ID</dt>
<dd>
<p>A unique number assigned to each user of a computer, by which the resources and permissions assigned to that user can be identified.</p>
</dd>
</dl>
</div>
<div id="udp-glossary" class="dlist">
<dl>
<dt class="hdlist1">User Datagram Protocol</dt>
<dd>
<p>A simple, unreliable datagram protocol which is used for exchanging data on a TCP/IP network. UDP does not provide error checking and correction like TCP.</p>
</dd>
</dl>
</div>
<h3 id="_v" class="discrete">V</h3>
<div class="dlist">
<dl>
<dt class="hdlist1">VPN</dt>
<dd>
<p>See <a href="#vpn-glossary">Virtual Private Network</a>.</p>
</dd>
</dl>
</div>
<div id="vpn-glossary" class="dlist">
<dl>
<dt class="hdlist1">Virtual Private Network</dt>
<dd>
<p>A method of using a public telecommunication such as the Internet, to provide remote access to a localized network, such as a corporate LAN.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect1">
<h2 id="colophon">Colophon<a class="anchor" href="#colophon"></a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>This book is the combined work of hundreds of contributors to &#34;The FreeBSD Documentation Project&#34;. The text is authored in AsciiDoc.</p>
</div>
</div>
</div>
<div id="footnotes">
<hr/>
<div class="footnote" id="_footnotedef_1">
<a href="#_footnoteref_1">1</a>. 有一些任务是无法中断的。例如，如果进程正在尝试从网络上的另一台计算机上读取文件，而该计算机不可用，那么该进程被称为不可中断。最终，该进程将超时，通常在两分钟后。一旦超时发生，该进程将被终止。
</div>
</div>

    </div>
    
    <hr />
    <div class="last-modified">
      <p><strong>Last modified on</strong>: December 22, 2023 by <a href="https://cgit.freebsd.org/doc/commit/?id=7852314" target="_blank">fiercex</a></p>
    </div>
    
    <div class="buttons">
      
      <div class="home">
        <i class="fa fa-home" aria-hidden="true" title="Home"></i>
        <div class="container">
          
            <a href="../" class="direction">Home</a>
          
        </div>
      </div>
      
    </div>
    <label class="hidden book-menu-overlay" for="menu-control"></label>
  </div>
  <aside class="toc">
    <div class="toc-content">
      <h3>Table of Contents</h3>
      <nav id="TableOfContents">
  <ul>
    <li><a href="#book-preface">Preface</a>
      <ul>
        <li><a href="#preface-audience">Intended Audience</a></li>
        <li><a href="#preface-changes-from4">Fourth Edition</a></li>
        <li><a href="#preface-changes-from3">Third Edition</a></li>
        <li><a href="#preface-changes-from2">Second Edition (2004)</a></li>
        <li><a href="#preface-changes">First Edition (2001)</a></li>
        <li><a href="#preface-overview">Organization of This Book</a></li>
        <li><a href="#preface-conv">Conventions used in this book</a></li>
        <li><a href="#preface-acknowledgements">Acknowledgments</a></li>
      </ul>
    </li>
    <li><a href="#getting-started">Part I: 入门指南</a>
      <ul>
        <li><a href="#introduction">Chapter 1. 介绍</a></li>
        <li><a href="#bsdinstall">Chapter 2. 安装 FreeBSD</a></li>
        <li><a href="#basics">Chapter 3. FreeBSD 基础知识</a></li>
        <li><a href="#ports">Chapter 4. 安装应用程序：软件包和 Ports</a></li>
        <li><a href="#x11">Chapter 5. The X Window System</a></li>
        <li><a href="#wayland">Chapter 6. Wayland on FreeBSD</a></li>
        <li><a href="#network">Chapter 7. Network</a></li>
      </ul>
    </li>
    <li><a href="#common-tasks">Part II: 常见任务</a>
      <ul>
        <li><a href="#desktop">Chapter 8. Desktop Environments</a></li>
        <li><a href="#multimedia">Chapter 9. Multimedia</a></li>
        <li><a href="#kernelconfig">Chapter 10. Configuring the FreeBSD Kernel</a></li>
        <li><a href="#printing">Chapter 11. Printing</a></li>
        <li><a href="#linuxemu">Chapter 12. Linux Binary Compatibility</a></li>
        <li><a href="#wine">Chapter 13. WINE</a></li>
      </ul>
    </li>
    <li><a href="#system-administration">Part III: 系统管理</a>
      <ul>
        <li><a href="#config-tuning">Chapter 14. Configuration, Services, Logging and Power Management</a></li>
        <li><a href="#boot">Chapter 15. The FreeBSD Booting Process</a></li>
        <li><a href="#security">Chapter 16. Security</a></li>
        <li><a href="#jails">Chapter 17. Jails and Containers</a></li>
        <li><a href="#mac">Chapter 18. Mandatory Access Control</a></li>
        <li><a href="#audit">Chapter 19. Security Event Auditing</a></li>
        <li><a href="#disks">Chapter 20. Storage</a></li>
        <li><a href="#geom">Chapter 21. GEOM: Modular Disk Transformation Framework</a></li>
        <li><a href="#zfs">Chapter 22. The Z File System (ZFS)</a></li>
        <li><a href="#filesystems">Chapter 23. Other File Systems</a></li>
        <li><a href="#virtualization">Chapter 24. Virtualization</a></li>
        <li><a href="#l10n">Chapter 25. Localization - i18n/L10n Usage and Setup</a></li>
        <li><a href="#updating-upgrading">Chapter 26. Updating and Upgrading FreeBSD</a></li>
        <li><a href="#dtrace">Chapter 27. DTrace</a></li>
        <li><a href="#usb-device-mode">Chapter 28. USB Device Mode / USB OTG</a></li>
      </ul>
    </li>
    <li><a href="#network-communication">Part IV: 网络通信</a>
      <ul>
        <li><a href="#serialcomms">Chapter 29. Serial Communications</a></li>
        <li><a href="#ppp-and-slip">Chapter 30. PPP</a></li>
        <li><a href="#mail">Chapter 31. Electronic Mail</a></li>
        <li><a href="#network-servers">Chapter 32. Network Servers</a></li>
        <li><a href="#firewalls">Chapter 33. Firewalls</a></li>
        <li><a href="#advanced-networking">Chapter 34. Advanced Networking</a></li>
      </ul>
    </li>
    <li><a href="#appendices">Part V: 附录</a>
      <ul>
        <li><a href="#_obtaining_freebsd">附录 A: Obtaining FreeBSD</a></li>
        <li><a href="#bibliography">附录 B: Bibliography</a></li>
        <li><a href="#eresources">附录 C: Resources on the Internet</a></li>
        <li><a href="#pgpkeys">附录 D: OpenPGP Keys</a></li>
        <li><a href="#freebsd-glossary">FreeBSD Glossary</a></li>
        <li><a href="#colophon">Colophon</a></li>
      </ul>
    </li>
  </ul>
</nav>
      <hr />
      
    </div>
  </aside>
  <a class="to-top" href="#top">
    <i class="fa fa-arrow-circle-up" aria-hidden="true"></i>
  </a>
</main>

    <footer>
  <div class="footer-container">
    <section class="logo-column">
          <img src="https://free.bsd-doc.org/images/FreeBSD-colors.svg" width="160" height="50" alt="FreeBSD logo" />
        <div class="options-container">
          
            <div class="language-container">
              <a id="languages" href="https://free.bsd-doc.org/zh-cn/languages">
                
                <img src="https://free.bsd-doc.org/images/language.png" class="language-image" alt="Choose language">
                <span>简体中文</span>
              </a>
            </div>
          
          <div class="theme-container">
            <select id="theme-chooser">
	      <option value="theme-system">System</option>
              <option value="theme-light">Light</option>
              <option value="theme-dark">Dark</option>
              <option value="theme-high-contrast">High contrast</option>
            </select>
          </div>
        </div>
      </section>
      
      <section class="copyright-column">
        <p>&copy; 1994-2023 The FreeBSD Project. All rights reserved</p>
        <span>Made with <span class="heart">♥</span> by the FreeBSD Community</span>
      </section>
  </div>
</footer>

  </body>
</html>
